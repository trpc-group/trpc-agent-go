
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://trpc-group.github.io/trpc-agent-go/graph/">
      
      
        <link rel="prev" href="../team/">
      
      
        <link rel="next" href="../custom-agent/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.17">
    
    
      
        <title>Graph Agent - tRPC-Agent-Go</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.7e37652d.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/extra.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config",""),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#graph-package-guide" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="tRPC-Agent-Go" class="md-header__button md-logo" aria-label="tRPC-Agent-Go" data-md-component="logo">
      
  <img src="../assets/img/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            tRPC-Agent-Go
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Graph Agent
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
      <div class="md-header__option">
  <div class="md-select">
    
    <button class="md-header__button md-icon" aria-label="Select language">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m12.87 15.07-2.54-2.51.03-.03A17.5 17.5 0 0 0 14.07 6H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2zm-2.62 7 1.62-4.33L19.12 17z"/></svg>
    </button>
    <div class="md-select__inner">
      <ul class="md-select__list">
        
          <li class="md-select__item">
            <a href="./" hreflang="en" class="md-select__link">
              English
            </a>
          </li>
        
          <li class="md-select__item">
            <a href="../zh/graph/" hreflang="zh" class="md-select__link">
              中文
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</div>
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/trpc-group/trpc-agent-go" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    trpc-group/trpc-agent-go
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href=".." class="md-tabs__link">
        
  
  
    
  
  Overview

      </a>
    </li>
  

      
        
  
  
  
    
  
  
    
    
      
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../agent/" class="md-tabs__link">
          
  
  
  Components

        </a>
      </li>
    
  

    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../agui/" class="md-tabs__link">
          
  
  
  Server

        </a>
      </li>
    
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../observability/" class="md-tabs__link">
        
  
  
    
  
  Observability

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../ecosystem/" class="md-tabs__link">
        
  
  
    
  
  Ecosystem

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="tRPC-Agent-Go" class="md-nav__button md-logo" aria-label="tRPC-Agent-Go" data-md-component="logo">
      
  <img src="../assets/img/logo.png" alt="logo">

    </a>
    tRPC-Agent-Go
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/trpc-group/trpc-agent-go" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    trpc-group/trpc-agent-go
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Components
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Components
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1" checked>
        
          
          <label class="md-nav__link" for="__nav_2_1" id="__nav_2_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Agent
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_1">
            <span class="md-nav__icon md-icon"></span>
            Agent
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Agent
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../multiagent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Multi Agent
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../team/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Team
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Graph Agent
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Graph Agent
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    <span class="md-ellipsis">
      Overview
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#quick-start" class="md-nav__link">
    <span class="md-ellipsis">
      Quick Start
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Quick Start">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#minimal-workflow" class="md-nav__link">
    <span class="md-ellipsis">
      Minimal Workflow
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#usage-pattern" class="md-nav__link">
    <span class="md-ellipsis">
      Usage Pattern
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agent-integration" class="md-nav__link">
    <span class="md-ellipsis">
      Agent Integration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#key-features" class="md-nav__link">
    <span class="md-ellipsis">
      Key Features
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#core-concepts" class="md-nav__link">
    <span class="md-ellipsis">
      Core Concepts
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Core Concepts">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-graph" class="md-nav__link">
    <span class="md-ellipsis">
      1. Graph
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-node" class="md-nav__link">
    <span class="md-ellipsis">
      2. Node
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-state" class="md-nav__link">
    <span class="md-ellipsis">
      3. State
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-state-schema" class="md-nav__link">
    <span class="md-ellipsis">
      4. State Schema
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#usage-guide" class="md-nav__link">
    <span class="md-ellipsis">
      Usage Guide
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Usage Guide">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#node-io-conventions" class="md-nav__link">
    <span class="md-ellipsis">
      Node I/O Conventions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Node I/O Conventions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#constant-references-import-and-keys" class="md-nav__link">
    <span class="md-ellipsis">
      Constant references (import and keys)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#event-metadata-keys-statedelta" class="md-nav__link">
    <span class="md-ellipsis">
      Event metadata keys (StateDelta)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#node-event-emitter-eventemitter" class="md-nav__link">
    <span class="md-ellipsis">
      Node Event Emitter (EventEmitter)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1-creating-graphagent-and-runner" class="md-nav__link">
    <span class="md-ellipsis">
      1. Creating GraphAgent and Runner
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-using-llm-nodes" class="md-nav__link">
    <span class="md-ellipsis">
      2. Using LLM Nodes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. Using LLM Nodes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#event-emission-streaming-vs-final" class="md-nav__link">
    <span class="md-ellipsis">
      Event emission (streaming vs final)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#three-input-paradigms" class="md-nav__link">
    <span class="md-ellipsis">
      Three input paradigms
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#atomic-updates-with-reducer-and-messageop" class="md-nav__link">
    <span class="md-ellipsis">
      Atomic updates with Reducer and MessageOp
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-removeallmessages-to-clear-message-history" class="md-nav__link">
    <span class="md-ellipsis">
      Using RemoveAllMessages to Clear Message History
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-graphagent-configuration-options" class="md-nav__link">
    <span class="md-ellipsis">
      3. GraphAgent Configuration Options
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. GraphAgent Configuration Options">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#summary-format-customization" class="md-nav__link">
    <span class="md-ellipsis">
      Summary Format Customization
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#executor-advanced-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Executor Advanced Configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#concurrency-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      Concurrency considerations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agent-nodes-passing-data-to-the-next-agent" class="md-nav__link">
    <span class="md-ellipsis">
      Agent nodes: passing data to the next agent
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agent-nodes-combining-original-input-with-upstream-output" class="md-nav__link">
    <span class="md-ellipsis">
      Agent nodes: combining original input with upstream output
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agent-nodes-state-mappers-advanced" class="md-nav__link">
    <span class="md-ellipsis">
      Agent nodes: state mappers (advanced)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agent-nodes-isolation-vs-multiturn-tool-calls" class="md-nav__link">
    <span class="md-ellipsis">
      Agent nodes: isolation vs multi‑turn tool calls
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agent-nodes-checkpoints-and-nested-interrupts" class="md-nav__link">
    <span class="md-ellipsis">
      Agent nodes: checkpoints and nested interrupts
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-conditional-routing" class="md-nav__link">
    <span class="md-ellipsis">
      4. Conditional Routing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#41-named-ends-pernode-ends" class="md-nav__link">
    <span class="md-ellipsis">
      4.1 Named Ends (Per‑node Ends)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42-multiconditional-fanout" class="md-nav__link">
    <span class="md-ellipsis">
      4.2 Multi‑conditional Fan‑out
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-tool-node-integration" class="md-nav__link">
    <span class="md-ellipsis">
      5. Tool Node Integration
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5. Tool Node Integration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#placeholder-variables-in-llm-instructions" class="md-nav__link">
    <span class="md-ellipsis">
      Placeholder Variables in LLM Instructions
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6-node-retry-backoff" class="md-nav__link">
    <span class="md-ellipsis">
      6. Node Retry &amp; Backoff
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#7-runner-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      7. Runner Configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#8-message-state-schema" class="md-nav__link">
    <span class="md-ellipsis">
      8. Message State Schema
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#9-state-key-usage-scenarios" class="md-nav__link">
    <span class="md-ellipsis">
      9. State Key Usage Scenarios
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#advanced-features" class="md-nav__link">
    <span class="md-ellipsis">
      Advanced Features
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Advanced Features">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-interrupt-and-resume-human-in-the-loop" class="md-nav__link">
    <span class="md-ellipsis">
      1. Interrupt and Resume (Human-in-the-Loop)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1. Interrupt and Resume (Human-in-the-Loop)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#basic-usage" class="md-nav__link">
    <span class="md-ellipsis">
      Basic Usage
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-static-interrupts-debug-breakpoints" class="md-nav__link">
    <span class="md-ellipsis">
      2. Static Interrupts (Debug Breakpoints)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution" class="md-nav__link">
    <span class="md-ellipsis">
      Execution
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#graphagent-options" class="md-nav__link">
    <span class="md-ellipsis">
      GraphAgent Options
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#core-concepts_1" class="md-nav__link">
    <span class="md-ellipsis">
      Core Concepts
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Core Concepts">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#state-management" class="md-nav__link">
    <span class="md-ellipsis">
      State Management
    </span>
  </a>
  
    <nav class="md-nav" aria-label="State Management">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#builtin-schema" class="md-nav__link">
    <span class="md-ellipsis">
      Built‑in Schema
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#custom-schema" class="md-nav__link">
    <span class="md-ellipsis">
      Custom Schema
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#node-types" class="md-nav__link">
    <span class="md-ellipsis">
      Node Types
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Node Types">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#function-node" class="md-nav__link">
    <span class="md-ellipsis">
      Function Node
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llm-node" class="md-nav__link">
    <span class="md-ellipsis">
      LLM Node
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#node-cache" class="md-nav__link">
    <span class="md-ellipsis">
      Node Cache
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Node Cache">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tools-node" class="md-nav__link">
    <span class="md-ellipsis">
      Tools Node
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reading-tool-results-into-state" class="md-nav__link">
    <span class="md-ellipsis">
      Reading Tool Results into State
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#edges-and-routing" class="md-nav__link">
    <span class="md-ellipsis">
      Edges and Routing
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Edges and Routing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#join-edges-wait-all-fan-in" class="md-nav__link">
    <span class="md-ellipsis">
      Join edges (wait-all fan-in)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bsp-superstep-barrier-why-downstream-waits" class="md-nav__link">
    <span class="md-ellipsis">
      BSP superstep barrier (why downstream waits)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#message-visibility-options" class="md-nav__link">
    <span class="md-ellipsis">
      Message Visibility Options
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#command-mode-dynamic-routing-fanout" class="md-nav__link">
    <span class="md-ellipsis">
      Command Mode (Dynamic Routing / Fan‑out)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#architecture" class="md-nav__link">
    <span class="md-ellipsis">
      Architecture
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Architecture">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overall-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      Overall Architecture
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#core-modules" class="md-nav__link">
    <span class="md-ellipsis">
      Core Modules
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution-model" class="md-nav__link">
    <span class="md-ellipsis">
      Execution Model
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Execution Model">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#runtime-isolation-and-event-snapshots" class="md-nav__link">
    <span class="md-ellipsis">
      Runtime Isolation and Event Snapshots
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#executor-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Executor Configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#defaults-and-notes" class="md-nav__link">
    <span class="md-ellipsis">
      Defaults and Notes
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#integrating-with-multiagent-systems" class="md-nav__link">
    <span class="md-ellipsis">
      Integrating with Multi‑Agent Systems
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Integrating with Multi‑Agent Systems">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#graphagent-as-an-agent" class="md-nav__link">
    <span class="md-ellipsis">
      GraphAgent as an Agent
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#advanced-orchestration" class="md-nav__link">
    <span class="md-ellipsis">
      Advanced Orchestration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#embedding-agents-in-a-graph" class="md-nav__link">
    <span class="md-ellipsis">
      Embedding Agents in a Graph
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Embedding Agents in a Graph">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#passing-only-results-map-last_response-to-downstream-user_input" class="md-nav__link">
    <span class="md-ellipsis">
      Passing only results: map last_response to downstream user_input
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hybrid-pattern-example" class="md-nav__link">
    <span class="md-ellipsis">
      Hybrid Pattern Example
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#core-mechanics-in-depth" class="md-nav__link">
    <span class="md-ellipsis">
      Core Mechanics in Depth
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Core Mechanics in Depth">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#state-management-schema-reducer" class="md-nav__link">
    <span class="md-ellipsis">
      State Management: Schema + Reducer
    </span>
  </a>
  
    <nav class="md-nav" aria-label="State Management: Schema + Reducer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#common-state-keys" class="md-nav__link">
    <span class="md-ellipsis">
      Common State Keys
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nodelevel-callbacks-tools-generation-parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Node‑level Callbacks, Tools &amp; Generation Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#invocationlevel-call-options-perrun-overrides" class="md-nav__link">
    <span class="md-ellipsis">
      Invocation‑level Call Options (per‑run overrides)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#toolsets-in-graphs-vs-agents" class="md-nav__link">
    <span class="md-ellipsis">
      ToolSets in Graphs vs Agents
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llm-input-rules-threestage-design" class="md-nav__link">
    <span class="md-ellipsis">
      LLM Input Rules: Three‑Stage Design
    </span>
  </a>
  
    <nav class="md-nav" aria-label="LLM Input Rules: Three‑Stage Design">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#instruction-placeholder-injection" class="md-nav__link">
    <span class="md-ellipsis">
      Instruction Placeholder Injection
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#concurrency-and-state-safety" class="md-nav__link">
    <span class="md-ellipsis">
      Concurrency and State Safety
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#node-io-conventions_1" class="md-nav__link">
    <span class="md-ellipsis">
      Node I/O Conventions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#api-cheat-sheet" class="md-nav__link">
    <span class="md-ellipsis">
      API Cheat Sheet
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#visualization-dotimage" class="md-nav__link">
    <span class="md-ellipsis">
      Visualization (DOT/Image)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#advanced-features_1" class="md-nav__link">
    <span class="md-ellipsis">
      Advanced Features
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Advanced Features">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#checkpoints-and-recovery" class="md-nav__link">
    <span class="md-ellipsis">
      Checkpoints and Recovery
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Checkpoints and Recovery">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#checkpoint-management" class="md-nav__link">
    <span class="md-ellipsis">
      Checkpoint Management
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#time-travel-read-edit-state" class="md-nav__link">
    <span class="md-ellipsis">
      Time Travel: Read / Edit State
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#events-at-a-glance" class="md-nav__link">
    <span class="md-ellipsis">
      Events at a Glance
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#humanintheloop" class="md-nav__link">
    <span class="md-ellipsis">
      Human‑in‑the‑Loop
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Human‑in‑the‑Loop">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#nested-graphs-child-graphagent-interrupts" class="md-nav__link">
    <span class="md-ellipsis">
      Nested graphs (child GraphAgent interrupts)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#event-monitoring" class="md-nav__link">
    <span class="md-ellipsis">
      Event Monitoring
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Event Monitoring">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#streammode" class="md-nav__link">
    <span class="md-ellipsis">
      StreamMode
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#event-metadata-statedelta" class="md-nav__link">
    <span class="md-ellipsis">
      Event Metadata (StateDelta)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#emit-selected-values-from-node-callbacks" class="md-nav__link">
    <span class="md-ellipsis">
      Emit selected values from node callbacks
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#troubleshooting" class="md-nav__link">
    <span class="md-ellipsis">
      Troubleshooting
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#realworld-example" class="md-nav__link">
    <span class="md-ellipsis">
      Real‑World Example
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Real‑World Example">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#approval-workflow" class="md-nav__link">
    <span class="md-ellipsis">
      Approval Workflow
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    <span class="md-ellipsis">
      Summary
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references-examples" class="md-nav__link">
    <span class="md-ellipsis">
      References &amp; Examples
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../custom-agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Custom Agent
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../dify/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Dify Agent
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../runner/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Runner
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../model/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Model
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../callbacks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Callbacks
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../plugin/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Plugins
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../memory/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Memory
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../artifact/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Artifact
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../skill/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Skill
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tool/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Tool
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../session/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Session
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_11" >
        
          
          <label class="md-nav__link" for="__nav_2_11" id="__nav_2_11_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Knowledge
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_11">
            <span class="md-nav__icon md-icon"></span>
            Knowledge
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../knowledge/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../knowledge/embedder/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Embedder
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../knowledge/reranker/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Reranker
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../knowledge/source/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Source
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../knowledge/filter/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Filter
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../knowledge/management/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Management
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../knowledge/ocr/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    OCR
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_11_8" >
        
          
          <label class="md-nav__link" for="__nav_2_11_8" id="__nav_2_11_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    VectorStore
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_11_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_11_8">
            <span class="md-nav__icon md-icon"></span>
            VectorStore
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../knowledge/vectorstore/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../knowledge/vectorstore/inmemory/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Memory
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../knowledge/vectorstore/pgvector/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    PGVector
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../knowledge/vectorstore/tcvector/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    TcVector
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../knowledge/vectorstore/elasticsearch/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Elasticsearch
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../knowledge/vectorstore/qdrant/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Qdrant
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../knowledge/vectorstore/milvus/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Milvus
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../knowledge/troubleshooting/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Troubleshooting
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../planner/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Planner
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../event/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Event
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../evaluation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Evaluation
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Server
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Server
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../agui/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    AG-UI
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../a2a/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    A2A
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../observability/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Observability
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../ecosystem/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Ecosystem
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    <span class="md-ellipsis">
      Overview
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#quick-start" class="md-nav__link">
    <span class="md-ellipsis">
      Quick Start
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Quick Start">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#minimal-workflow" class="md-nav__link">
    <span class="md-ellipsis">
      Minimal Workflow
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#usage-pattern" class="md-nav__link">
    <span class="md-ellipsis">
      Usage Pattern
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agent-integration" class="md-nav__link">
    <span class="md-ellipsis">
      Agent Integration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#key-features" class="md-nav__link">
    <span class="md-ellipsis">
      Key Features
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#core-concepts" class="md-nav__link">
    <span class="md-ellipsis">
      Core Concepts
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Core Concepts">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-graph" class="md-nav__link">
    <span class="md-ellipsis">
      1. Graph
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-node" class="md-nav__link">
    <span class="md-ellipsis">
      2. Node
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-state" class="md-nav__link">
    <span class="md-ellipsis">
      3. State
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-state-schema" class="md-nav__link">
    <span class="md-ellipsis">
      4. State Schema
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#usage-guide" class="md-nav__link">
    <span class="md-ellipsis">
      Usage Guide
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Usage Guide">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#node-io-conventions" class="md-nav__link">
    <span class="md-ellipsis">
      Node I/O Conventions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Node I/O Conventions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#constant-references-import-and-keys" class="md-nav__link">
    <span class="md-ellipsis">
      Constant references (import and keys)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#event-metadata-keys-statedelta" class="md-nav__link">
    <span class="md-ellipsis">
      Event metadata keys (StateDelta)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#node-event-emitter-eventemitter" class="md-nav__link">
    <span class="md-ellipsis">
      Node Event Emitter (EventEmitter)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1-creating-graphagent-and-runner" class="md-nav__link">
    <span class="md-ellipsis">
      1. Creating GraphAgent and Runner
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-using-llm-nodes" class="md-nav__link">
    <span class="md-ellipsis">
      2. Using LLM Nodes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. Using LLM Nodes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#event-emission-streaming-vs-final" class="md-nav__link">
    <span class="md-ellipsis">
      Event emission (streaming vs final)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#three-input-paradigms" class="md-nav__link">
    <span class="md-ellipsis">
      Three input paradigms
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#atomic-updates-with-reducer-and-messageop" class="md-nav__link">
    <span class="md-ellipsis">
      Atomic updates with Reducer and MessageOp
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-removeallmessages-to-clear-message-history" class="md-nav__link">
    <span class="md-ellipsis">
      Using RemoveAllMessages to Clear Message History
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-graphagent-configuration-options" class="md-nav__link">
    <span class="md-ellipsis">
      3. GraphAgent Configuration Options
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. GraphAgent Configuration Options">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#summary-format-customization" class="md-nav__link">
    <span class="md-ellipsis">
      Summary Format Customization
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#executor-advanced-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Executor Advanced Configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#concurrency-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      Concurrency considerations
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agent-nodes-passing-data-to-the-next-agent" class="md-nav__link">
    <span class="md-ellipsis">
      Agent nodes: passing data to the next agent
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agent-nodes-combining-original-input-with-upstream-output" class="md-nav__link">
    <span class="md-ellipsis">
      Agent nodes: combining original input with upstream output
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agent-nodes-state-mappers-advanced" class="md-nav__link">
    <span class="md-ellipsis">
      Agent nodes: state mappers (advanced)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agent-nodes-isolation-vs-multiturn-tool-calls" class="md-nav__link">
    <span class="md-ellipsis">
      Agent nodes: isolation vs multi‑turn tool calls
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agent-nodes-checkpoints-and-nested-interrupts" class="md-nav__link">
    <span class="md-ellipsis">
      Agent nodes: checkpoints and nested interrupts
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-conditional-routing" class="md-nav__link">
    <span class="md-ellipsis">
      4. Conditional Routing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#41-named-ends-pernode-ends" class="md-nav__link">
    <span class="md-ellipsis">
      4.1 Named Ends (Per‑node Ends)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42-multiconditional-fanout" class="md-nav__link">
    <span class="md-ellipsis">
      4.2 Multi‑conditional Fan‑out
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-tool-node-integration" class="md-nav__link">
    <span class="md-ellipsis">
      5. Tool Node Integration
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5. Tool Node Integration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#placeholder-variables-in-llm-instructions" class="md-nav__link">
    <span class="md-ellipsis">
      Placeholder Variables in LLM Instructions
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6-node-retry-backoff" class="md-nav__link">
    <span class="md-ellipsis">
      6. Node Retry &amp; Backoff
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#7-runner-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      7. Runner Configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#8-message-state-schema" class="md-nav__link">
    <span class="md-ellipsis">
      8. Message State Schema
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#9-state-key-usage-scenarios" class="md-nav__link">
    <span class="md-ellipsis">
      9. State Key Usage Scenarios
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#advanced-features" class="md-nav__link">
    <span class="md-ellipsis">
      Advanced Features
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Advanced Features">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-interrupt-and-resume-human-in-the-loop" class="md-nav__link">
    <span class="md-ellipsis">
      1. Interrupt and Resume (Human-in-the-Loop)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1. Interrupt and Resume (Human-in-the-Loop)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#basic-usage" class="md-nav__link">
    <span class="md-ellipsis">
      Basic Usage
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-static-interrupts-debug-breakpoints" class="md-nav__link">
    <span class="md-ellipsis">
      2. Static Interrupts (Debug Breakpoints)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution" class="md-nav__link">
    <span class="md-ellipsis">
      Execution
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#graphagent-options" class="md-nav__link">
    <span class="md-ellipsis">
      GraphAgent Options
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#core-concepts_1" class="md-nav__link">
    <span class="md-ellipsis">
      Core Concepts
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Core Concepts">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#state-management" class="md-nav__link">
    <span class="md-ellipsis">
      State Management
    </span>
  </a>
  
    <nav class="md-nav" aria-label="State Management">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#builtin-schema" class="md-nav__link">
    <span class="md-ellipsis">
      Built‑in Schema
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#custom-schema" class="md-nav__link">
    <span class="md-ellipsis">
      Custom Schema
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#node-types" class="md-nav__link">
    <span class="md-ellipsis">
      Node Types
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Node Types">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#function-node" class="md-nav__link">
    <span class="md-ellipsis">
      Function Node
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llm-node" class="md-nav__link">
    <span class="md-ellipsis">
      LLM Node
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#node-cache" class="md-nav__link">
    <span class="md-ellipsis">
      Node Cache
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Node Cache">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tools-node" class="md-nav__link">
    <span class="md-ellipsis">
      Tools Node
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reading-tool-results-into-state" class="md-nav__link">
    <span class="md-ellipsis">
      Reading Tool Results into State
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#edges-and-routing" class="md-nav__link">
    <span class="md-ellipsis">
      Edges and Routing
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Edges and Routing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#join-edges-wait-all-fan-in" class="md-nav__link">
    <span class="md-ellipsis">
      Join edges (wait-all fan-in)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bsp-superstep-barrier-why-downstream-waits" class="md-nav__link">
    <span class="md-ellipsis">
      BSP superstep barrier (why downstream waits)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#message-visibility-options" class="md-nav__link">
    <span class="md-ellipsis">
      Message Visibility Options
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#command-mode-dynamic-routing-fanout" class="md-nav__link">
    <span class="md-ellipsis">
      Command Mode (Dynamic Routing / Fan‑out)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#architecture" class="md-nav__link">
    <span class="md-ellipsis">
      Architecture
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Architecture">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overall-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      Overall Architecture
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#core-modules" class="md-nav__link">
    <span class="md-ellipsis">
      Core Modules
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution-model" class="md-nav__link">
    <span class="md-ellipsis">
      Execution Model
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Execution Model">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#runtime-isolation-and-event-snapshots" class="md-nav__link">
    <span class="md-ellipsis">
      Runtime Isolation and Event Snapshots
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#executor-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Executor Configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#defaults-and-notes" class="md-nav__link">
    <span class="md-ellipsis">
      Defaults and Notes
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#integrating-with-multiagent-systems" class="md-nav__link">
    <span class="md-ellipsis">
      Integrating with Multi‑Agent Systems
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Integrating with Multi‑Agent Systems">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#graphagent-as-an-agent" class="md-nav__link">
    <span class="md-ellipsis">
      GraphAgent as an Agent
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#advanced-orchestration" class="md-nav__link">
    <span class="md-ellipsis">
      Advanced Orchestration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#embedding-agents-in-a-graph" class="md-nav__link">
    <span class="md-ellipsis">
      Embedding Agents in a Graph
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Embedding Agents in a Graph">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#passing-only-results-map-last_response-to-downstream-user_input" class="md-nav__link">
    <span class="md-ellipsis">
      Passing only results: map last_response to downstream user_input
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hybrid-pattern-example" class="md-nav__link">
    <span class="md-ellipsis">
      Hybrid Pattern Example
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#core-mechanics-in-depth" class="md-nav__link">
    <span class="md-ellipsis">
      Core Mechanics in Depth
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Core Mechanics in Depth">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#state-management-schema-reducer" class="md-nav__link">
    <span class="md-ellipsis">
      State Management: Schema + Reducer
    </span>
  </a>
  
    <nav class="md-nav" aria-label="State Management: Schema + Reducer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#common-state-keys" class="md-nav__link">
    <span class="md-ellipsis">
      Common State Keys
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nodelevel-callbacks-tools-generation-parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Node‑level Callbacks, Tools &amp; Generation Parameters
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#invocationlevel-call-options-perrun-overrides" class="md-nav__link">
    <span class="md-ellipsis">
      Invocation‑level Call Options (per‑run overrides)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#toolsets-in-graphs-vs-agents" class="md-nav__link">
    <span class="md-ellipsis">
      ToolSets in Graphs vs Agents
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llm-input-rules-threestage-design" class="md-nav__link">
    <span class="md-ellipsis">
      LLM Input Rules: Three‑Stage Design
    </span>
  </a>
  
    <nav class="md-nav" aria-label="LLM Input Rules: Three‑Stage Design">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#instruction-placeholder-injection" class="md-nav__link">
    <span class="md-ellipsis">
      Instruction Placeholder Injection
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#concurrency-and-state-safety" class="md-nav__link">
    <span class="md-ellipsis">
      Concurrency and State Safety
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#node-io-conventions_1" class="md-nav__link">
    <span class="md-ellipsis">
      Node I/O Conventions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#api-cheat-sheet" class="md-nav__link">
    <span class="md-ellipsis">
      API Cheat Sheet
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#visualization-dotimage" class="md-nav__link">
    <span class="md-ellipsis">
      Visualization (DOT/Image)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#advanced-features_1" class="md-nav__link">
    <span class="md-ellipsis">
      Advanced Features
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Advanced Features">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#checkpoints-and-recovery" class="md-nav__link">
    <span class="md-ellipsis">
      Checkpoints and Recovery
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Checkpoints and Recovery">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#checkpoint-management" class="md-nav__link">
    <span class="md-ellipsis">
      Checkpoint Management
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#time-travel-read-edit-state" class="md-nav__link">
    <span class="md-ellipsis">
      Time Travel: Read / Edit State
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#events-at-a-glance" class="md-nav__link">
    <span class="md-ellipsis">
      Events at a Glance
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#humanintheloop" class="md-nav__link">
    <span class="md-ellipsis">
      Human‑in‑the‑Loop
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Human‑in‑the‑Loop">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#nested-graphs-child-graphagent-interrupts" class="md-nav__link">
    <span class="md-ellipsis">
      Nested graphs (child GraphAgent interrupts)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#event-monitoring" class="md-nav__link">
    <span class="md-ellipsis">
      Event Monitoring
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Event Monitoring">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#streammode" class="md-nav__link">
    <span class="md-ellipsis">
      StreamMode
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#event-metadata-statedelta" class="md-nav__link">
    <span class="md-ellipsis">
      Event Metadata (StateDelta)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#emit-selected-values-from-node-callbacks" class="md-nav__link">
    <span class="md-ellipsis">
      Emit selected values from node callbacks
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#troubleshooting" class="md-nav__link">
    <span class="md-ellipsis">
      Troubleshooting
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#realworld-example" class="md-nav__link">
    <span class="md-ellipsis">
      Real‑World Example
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Real‑World Example">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#approval-workflow" class="md-nav__link">
    <span class="md-ellipsis">
      Approval Workflow
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    <span class="md-ellipsis">
      Summary
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references-examples" class="md-nav__link">
    <span class="md-ellipsis">
      References &amp; Examples
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
    <a href="https://github.com/trpc-group/trpc-agent-go/edit/main/docs/mkdocs/en/graph.md" title="Edit this page" class="md-content__button md-icon" rel="edit">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg>
    </a>
  
  
    
      
    
    <a href="https://github.com/trpc-group/trpc-agent-go/raw/main/docs/mkdocs/en/graph.md" title="View source of this page" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 18c.56 0 1 .44 1 1s-.44 1-1 1-1-.44-1-1 .44-1 1-1m0-3c-2.73 0-5.06 1.66-6 4 .94 2.34 3.27 4 6 4s5.06-1.66 6-4c-.94-2.34-3.27-4-6-4m0 6.5a2.5 2.5 0 0 1-2.5-2.5 2.5 2.5 0 0 1 2.5-2.5 2.5 2.5 0 0 1 2.5 2.5 2.5 2.5 0 0 1-2.5 2.5M9.27 20H6V4h7v5h5v4.07c.7.08 1.36.25 2 .49V8l-6-6H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h4.5a8.2 8.2 0 0 1-1.23-2"/></svg>
    </a>
  


<h1 id="graph-package-guide">Graph Package Guide</h1>
<h2 id="overview">Overview</h2>
<p>Graph combines controllable workflow orchestration with extensible agent capabilities. It is suitable for:</p>
<ul>
<li>Type-safe state management and predictable routing.</li>
<li>LLM decision making, tool-calling loops, and optional Human in the Loop (HITL).</li>
<li>Reusable components that can run standalone or be composed as sub‑agents.</li>
</ul>
<p>Highlights:</p>
<ul>
<li>Schema‑driven State and Reducers to avoid data races when concurrent branches write the same field.</li>
<li>Deterministic parallelism with BSP style (Plan / Execute / Update).</li>
<li>Built‑in node types wrap LLM, Tools, and Agent to reduce boilerplate.</li>
<li>Streaming events, checkpoints, and interrupts for observability and recovery.</li>
<li>Node‑level retry/backoff with exponential delay and jitter, plus executor‑level defaults and rich retry metadata in events.</li>
<li>Node event emitter (EventEmitter) for emitting custom events, progress updates, and streaming text from within NodeFunc.</li>
</ul>
<h2 id="quick-start">Quick Start</h2>
<h3 id="minimal-workflow">Minimal Workflow</h3>
<p>Below is a classic "prepare → ask LLM → optionally call tools" loop using <code>graph.MessagesStateSchema()</code> (predefines <code>graph.StateKeyMessages</code>, <code>graph.StateKeyUserInput</code>, <code>graph.StateKeyLastResponse</code>, etc.).</p>
<pre class="mermaid"><code>flowchart LR
    START([start]):::startNode --&gt; P[prepare]:::processNode
    P --&gt; A[ask LLM]:::llmNode
    A -. tool_calls .-&gt; T[tools]:::toolNode
    A -- no tool_calls --&gt; F[fallback]:::processNode
    T --&gt; A
    F --&gt; END([finish]):::endNode

    classDef startNode fill:#e1f5e1,stroke:#4caf50,stroke-width:2px
    classDef endNode fill:#ffe1e1,stroke:#f44336,stroke-width:2px
    classDef llmNode fill:#e3f2fd,stroke:#2196f3,stroke-width:2px
    classDef toolNode fill:#fff3e0,stroke:#ff9800,stroke-width:2px
    classDef processNode fill:#f3e5f5,stroke:#9c27b0,stroke-width:2px</code></pre>
<p>The Graph package allows you to model complex AI workflows as directed graphs, where nodes represent processing steps and edges represent data flow and control flow. It is particularly suitable for building AI applications that require conditional routing, state management, and multi-step processing.</p>
<h3 id="usage-pattern">Usage Pattern</h3>
<p>The usage of the Graph package follows this pattern:</p>
<ol>
<li><strong>Create Graph</strong>: Use <code>StateGraph</code> builder to define workflow structure</li>
<li><strong>Create GraphAgent</strong>: Wrap the compiled Graph as an Agent</li>
<li><strong>Create Runner</strong>: Use Runner to manage sessions and execution environment</li>
<li><strong>Execute Workflow</strong>: Execute workflow through Runner and handle results</li>
</ol>
<p>This pattern provides:</p>
<ul>
<li><strong>Type Safety</strong>: Ensures data consistency through state schema</li>
<li><strong>Session Management</strong>: Supports concurrent execution for multiple users and sessions</li>
<li><strong>Event Stream</strong>: Real-time monitoring of workflow execution progress</li>
<li><strong>Error Handling</strong>: Unified error handling and recovery mechanisms</li>
</ul>
<h3 id="agent-integration">Agent Integration</h3>
<p>GraphAgent implements the <code>agent.Agent</code> interface and can:</p>
<ul>
<li><strong>Act as Independent Agent</strong>: Execute directly through Runner</li>
<li><strong>Act as SubAgent</strong>: Be used as a sub-agent by other Agents (such as LLMAgent)</li>
<li><strong>Host SubAgents</strong>: Register child agents via <code>graphagent.WithSubAgents</code> and invoke them through <code>AddAgentNode</code></li>
</ul>
<p>This design lets GraphAgent plug into other agents while orchestrating its own specialized sub-agents.</p>
<h3 id="key-features">Key Features</h3>
<ul>
<li><strong>Type-safe state management</strong>: Use Schema to define state structure, support custom Reducers</li>
<li><strong>Conditional routing</strong>: Dynamically select execution paths based on state</li>
<li><strong>LLM node integration</strong>: Built-in support for large language models</li>
<li><strong>Tool nodes</strong>: Support function calls and external tool integration</li>
<li><strong>Agent nodes</strong>: Delegate parts of the workflow to registered sub-agents</li>
<li><strong>Streaming execution</strong>: Support real-time event streams and progress tracking</li>
<li><strong>Concurrency safety</strong>: Thread-safe graph execution</li>
<li><strong>Checkpoint-based Time Travel</strong>: Navigate through execution history and restore previous states</li>
<li><strong>Human-in-the-Loop (HITL)</strong>: Support for interactive workflows with interrupt and resume capabilities</li>
<li><strong>Atomic checkpointing</strong>: Atomic storage of checkpoints with pending writes for reliable recovery</li>
<li><strong>Checkpoint Lineage</strong>: Track related checkpoints forming execution threads with parent-child relationships</li>
</ul>
<h2 id="core-concepts">Core Concepts</h2>
<h3 id="1-graph">1. Graph</h3>
<p>A graph is the core structure of a workflow, consisting of nodes and edges:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span>
<span class="normal"><a href="#__codelineno-0-2">2</a></span>
<span class="normal"><a href="#__codelineno-0-3">3</a></span>
<span class="normal"><a href="#__codelineno-0-4">4</a></span>
<span class="normal"><a href="#__codelineno-0-5">5</a></span>
<span class="normal"><a href="#__codelineno-0-6">6</a></span>
<span class="normal"><a href="#__codelineno-0-7">7</a></span>
<span class="normal"><a href="#__codelineno-0-8">8</a></span>
<span class="normal"><a href="#__codelineno-0-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="p">)</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4"></a>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="c1">// Create state schema.</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="nx">schema</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateSchema</span><span class="p">()</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7"></a>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="c1">// Create graph.</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="nx">graph</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="nx">schema</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p><strong>Virtual Nodes</strong>:</p>
<ul>
<li><code>Start</code>: Virtual start node, automatically connected through <code>SetEntryPoint()</code></li>
<li><code>End</code>: Virtual end node, automatically connected through <code>SetFinishPoint()</code></li>
<li>These nodes don't need to be explicitly created, the system automatically handles connections</li>
</ul>
<h3 id="2-node">2. Node</h3>
<p>A node represents a processing step in the workflow:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-1-10">10</a></span>
<span class="normal"><a href="#__codelineno-1-11">11</a></span>
<span class="normal"><a href="#__codelineno-1-12">12</a></span>
<span class="normal"><a href="#__codelineno-1-13">13</a></span>
<span class="normal"><a href="#__codelineno-1-14">14</a></span>
<span class="normal"><a href="#__codelineno-1-15">15</a></span>
<span class="normal"><a href="#__codelineno-1-16">16</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="w">    </span><span class="s">&quot;context&quot;</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3"></a>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="p">)</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6"></a>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="c1">// Node function signature.</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="kd">type</span><span class="w"> </span><span class="nx">NodeFunc</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9"></a>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="c1">// Create node.</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="nx">node</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">graph</span><span class="p">.</span><span class="nx">Node</span><span class="p">{</span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="w">    </span><span class="nx">ID</span><span class="p">:</span><span class="w">          </span><span class="s">&quot;process_data&quot;</span><span class="p">,</span>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="w">    </span><span class="nx">Name</span><span class="p">:</span><span class="w">        </span><span class="s">&quot;Data Processing&quot;</span><span class="p">,</span>
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14"></a><span class="w">    </span><span class="nx">Description</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Process input data&quot;</span><span class="p">,</span>
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="w">    </span><span class="nx">Function</span><span class="p">:</span><span class="w">    </span><span class="nx">processDataFunc</span><span class="p">,</span>
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="3-state">3. State</h3>
<p>State is a data container passed between nodes:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-2-10">10</a></span>
<span class="normal"><a href="#__codelineno-2-11">11</a></span>
<span class="normal"><a href="#__codelineno-2-12">12</a></span>
<span class="normal"><a href="#__codelineno-2-13">13</a></span>
<span class="normal"><a href="#__codelineno-2-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="p">)</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4"></a>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="c1">// State is a key-value pair mapping.</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="kd">type</span><span class="w"> </span><span class="nx">State</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">any</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7"></a>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="c1">// User-defined state keys.</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10"></a><span class="w">    </span><span class="nx">StateKeyInput</span><span class="w">         </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;input&quot;</span><span class="w">          </span><span class="c1">// Input data.</span>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11"></a><span class="w">    </span><span class="nx">StateKeyResult</span><span class="w">        </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;result&quot;</span><span class="w">         </span><span class="c1">// Processing result.</span>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12"></a><span class="w">    </span><span class="nx">StateKeyProcessedData</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;processed_data&quot;</span><span class="w"> </span><span class="c1">// Processed data.</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13"></a><span class="w">    </span><span class="nx">StateKeyStatus</span><span class="w">        </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;status&quot;</span><span class="w">         </span><span class="c1">// Processing status.</span>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14"></a><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p><strong>Built-in State Keys</strong>:</p>
<p>The Graph package provides some built-in state keys, mainly for internal system communication:</p>
<p><strong>User-accessible Built-in Keys</strong>:</p>
<ul>
<li><code>StateKeyUserInput</code>: User input (one-shot, cleared after consumption, persisted by LLM nodes)</li>
<li><code>StateKeyOneShotMessages</code>: One-shot messages (complete override for current round, cleared after consumption)</li>
<li><code>StateKeyLastResponse</code>: Last response (used to set final output, Executor reads this value as result)</li>
<li><code>StateKeyLastToolResponse</code>: Last tool output (JSON string, set by Tools nodes)</li>
<li><code>StateKeyLastResponseID</code>: Last response identifier (ID) (set by LLM nodes; may
  be empty when <code>StateKeyLastResponse</code> is produced by a non-model node)</li>
<li><code>StateKeyMessages</code>: Message history (durable, supports append + MessageOp patch operations)</li>
<li><code>StateKeyNodeResponses</code>: Per-node outputs map. Key is node ID, value is the
  node's final output. For LLM and Agent nodes this is the final textual
  response; for Tools nodes this is a JSON array string of tool outputs (each
  item contains <code>tool_id</code>, <code>tool_name</code>, and <code>output</code>).</li>
<li><code>StateKeyMetadata</code>: Metadata (general metadata storage available to users)</li>
</ul>
<p><strong>System Internal Keys</strong> (users should not use directly):</p>
<ul>
<li><code>StateKeySession</code>: Session information (automatically set by GraphAgent)</li>
<li><code>StateKeyExecContext</code>: Execution context (automatically set by Executor)</li>
<li><code>StateKeyToolCallbacks</code>: Tool callbacks (automatically set by Executor)</li>
<li><code>StateKeyModelCallbacks</code>: Model callbacks (automatically set by Executor)</li>
</ul>
<p>Users should use custom state keys to store business data, and only use user-accessible built-in state keys when necessary.</p>
<h3 id="4-state-schema">4. State Schema</h3>
<p>State schema defines the structure and behavior of state:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-3-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-3-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-3-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-3-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-3-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-3-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-3-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-3-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-3-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-3-10">10</a></span>
<span class="normal"><a href="#__codelineno-3-11">11</a></span>
<span class="normal"><a href="#__codelineno-3-12">12</a></span>
<span class="normal"><a href="#__codelineno-3-13">13</a></span>
<span class="normal"><a href="#__codelineno-3-14">14</a></span>
<span class="normal"><a href="#__codelineno-3-15">15</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="w">    </span><span class="s">&quot;reflect&quot;</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3"></a>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="p">)</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6"></a>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="c1">// Create state schema.</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8"></a><span class="nx">schema</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateSchema</span><span class="p">()</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9"></a>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10"></a><span class="c1">// Add field definitions.</span>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11"></a><span class="nx">schema</span><span class="p">.</span><span class="nx">AddField</span><span class="p">(</span><span class="s">&quot;counter&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateField</span><span class="p">{</span>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12"></a><span class="w">    </span><span class="nx">Type</span><span class="p">:</span><span class="w">    </span><span class="nx">reflect</span><span class="p">.</span><span class="nx">TypeOf</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13"></a><span class="w">    </span><span class="nx">Reducer</span><span class="p">:</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">DefaultReducer</span><span class="p">,</span>
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14"></a><span class="w">    </span><span class="nx">Default</span><span class="p">:</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="kt">any</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">},</span>
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15"></a><span class="p">})</span>
</span></code></pre></div></td></tr></table></div>
<h2 id="usage-guide">Usage Guide</h2>
<h3 id="node-io-conventions">Node I/O Conventions</h3>
<p>Nodes communicate exclusively through the shared state. Each node returns a state delta which is merged into the graph state using the schema's reducers. Downstream nodes read whatever upstream nodes wrote.</p>
<ul>
<li>
<p>Common built‑in keys (user‑facing)</p>
<ul>
<li><code>user_input</code>: One‑shot input for the next LLM/Agent node. Cleared after consumption.</li>
<li><code>one_shot_messages</code>: Full message override for the next LLM call. Cleared after consumption.</li>
<li><code>one_shot_messages_by_node</code>: Targeted one‑shot override for a specific
  node ID (map[nodeID][]Message). Cleared per entry after consumption.</li>
<li><code>messages</code>: Durable conversation history (LLM/Tools append here). Supports MessageOp patches.</li>
<li><code>last_response</code>: The last textual assistant response.</li>
<li><code>last_response_id</code>: The identifier (ID) of the last model response that
  produced <code>last_response</code> (may be empty when <code>last_response</code> is set by a
  non-model node).</li>
<li><code>node_responses</code>: Map[nodeID]any — per‑node final textual response. Use <code>last_response</code> for the most recent.</li>
</ul>
</li>
</ul>
<ul>
<li>
<p>Function node</p>
<ul>
<li>Input: the entire state</li>
<li>Output: return a <code>graph.State</code> delta with custom keys (declare them in the schema), e.g. <code>{"parsed_time": "..."}</code></li>
</ul>
</li>
</ul>
<ul>
<li>
<p>LLM node</p>
<ul>
<li>Input priority: <code>one_shot_messages_by_node[&lt;node_id&gt;]</code> →
  <code>one_shot_messages</code> → <code>user_input</code> → <code>messages</code></li>
<li>Output:<ul>
<li>Appends assistant message to <code>messages</code></li>
<li>Sets <code>last_response</code></li>
<li>Sets <code>last_response_id</code></li>
<li>Sets <code>node_responses[&lt;llm_node_id&gt;]</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li>
<p>Tools node</p>
<ul>
<li>Input: scans <code>messages</code> for the latest assistant message with <code>tool_calls</code></li>
<li>Output: appends tool responses to <code>messages</code></li>
</ul>
</li>
</ul>
<ul>
<li>Agent node (sub‑agent)<ul>
<li>Input: state is injected into the sub‑agent's <code>Invocation.RunOptions.RuntimeState</code>.<ul>
<li>Model/Tool callbacks can access it via <code>agent.InvocationFromContext(ctx)</code>.</li>
</ul>
</li>
<li>Output on finish:<ul>
<li>Sets <code>last_response</code></li>
<li>Sets <code>node_responses[&lt;agent_node_id&gt;]</code></li>
<li>Clears <code>user_input</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>Recommended patterns</p>
<ul>
<li>Add your own keys in the schema (e.g., <code>parsed_time</code>, <code>final_payload</code>) and write/read them in function nodes.</li>
<li>To feed structured hints into an LLM node, write <code>one_shot_messages</code> in the
  previous node (e.g., prepend a system message with parsed context).</li>
<li>Parallel branches: avoid writing <code>one_shot_messages</code> from multiple branches.
  Prefer <code>one_shot_messages_by_node</code> so each LLM node consumes only its own
  one‑shot input.</li>
<li>To consume an upstream node's text, read <code>last_response</code> immediately
  downstream or fetch from <code>node_responses[that_node_id]</code> later.</li>
<li>If the downstream node is an Agent node and you want it to consume an
  upstream node's output as its input message, you must write it back into
  <code>user_input</code> (for example, use <code>WithSubgraphInputFromLastResponse()</code> or a
  pre‑node callback).</li>
</ul>
<p>One-shot messages scoped by node ID:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-4-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-4-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-4-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-4-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-4-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-4-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-4-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-4-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-4-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-4-10">10</a></span>
<span class="normal"><a href="#__codelineno-4-11">11</a></span>
<span class="normal"><a href="#__codelineno-4-12">12</a></span>
<span class="normal"><a href="#__codelineno-4-13">13</a></span>
<span class="normal"><a href="#__codelineno-4-14">14</a></span>
<span class="normal"><a href="#__codelineno-4-15">15</a></span>
<span class="normal"><a href="#__codelineno-4-16">16</a></span>
<span class="normal"><a href="#__codelineno-4-17">17</a></span>
<span class="normal"><a href="#__codelineno-4-18">18</a></span>
<span class="normal"><a href="#__codelineno-4-19">19</a></span>
<span class="normal"><a href="#__codelineno-4-20">20</a></span>
<span class="normal"><a href="#__codelineno-4-21">21</a></span>
<span class="normal"><a href="#__codelineno-4-22">22</a></span>
<span class="normal"><a href="#__codelineno-4-23">23</a></span>
<span class="normal"><a href="#__codelineno-4-24">24</a></span>
<span class="normal"><a href="#__codelineno-4-25">25</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="w">    </span><span class="s">&quot;context&quot;</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3"></a>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/model&quot;</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="p">)</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7"></a>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9"></a><span class="w">    </span><span class="nx">llm1NodeID</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;llm1&quot;</span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10"></a><span class="w">    </span><span class="nx">llm2NodeID</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;llm2&quot;</span>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11"></a><span class="p">)</span>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12"></a>
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13"></a><span class="kd">func</span><span class="w"> </span><span class="nx">prepForLLM1</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14"></a><span class="w">    </span><span class="nx">msgs</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">[]</span><span class="nx">model</span><span class="p">.</span><span class="nx">Message</span><span class="p">{</span>
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15"></a><span class="w">        </span><span class="nx">model</span><span class="p">.</span><span class="nx">NewUserMessage</span><span class="p">(</span><span class="s">&quot;question for llm1&quot;</span><span class="p">),</span>
</span><span id="__span-4-16"><a id="__codelineno-4-16" name="__codelineno-4-16"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-4-17"><a id="__codelineno-4-17" name="__codelineno-4-17"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">SetOneShotMessagesForNode</span><span class="p">(</span><span class="nx">llm1NodeID</span><span class="p">,</span><span class="w"> </span><span class="nx">msgs</span><span class="p">),</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-4-18"><a id="__codelineno-4-18" name="__codelineno-4-18"></a><span class="p">}</span>
</span><span id="__span-4-19"><a id="__codelineno-4-19" name="__codelineno-4-19"></a>
</span><span id="__span-4-20"><a id="__codelineno-4-20" name="__codelineno-4-20"></a><span class="kd">func</span><span class="w"> </span><span class="nx">prepForLLM2</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-21"><a id="__codelineno-4-21" name="__codelineno-4-21"></a><span class="w">    </span><span class="nx">msgs</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">[]</span><span class="nx">model</span><span class="p">.</span><span class="nx">Message</span><span class="p">{</span>
</span><span id="__span-4-22"><a id="__codelineno-4-22" name="__codelineno-4-22"></a><span class="w">        </span><span class="nx">model</span><span class="p">.</span><span class="nx">NewUserMessage</span><span class="p">(</span><span class="s">&quot;question for llm2&quot;</span><span class="p">),</span>
</span><span id="__span-4-23"><a id="__codelineno-4-23" name="__codelineno-4-23"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-4-24"><a id="__codelineno-4-24" name="__codelineno-4-24"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">SetOneShotMessagesForNode</span><span class="p">(</span><span class="nx">llm2NodeID</span><span class="p">,</span><span class="w"> </span><span class="nx">msgs</span><span class="p">),</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-4-25"><a id="__codelineno-4-25" name="__codelineno-4-25"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>Preparing one-shot inputs for multiple nodes in a single upstream node:</p>
<p>In Go, a <code>map</code> assignment overwrites by key. Since
<code>SetOneShotMessagesForNode(...)</code> writes the same top-level key
(<code>one_shot_messages_by_node</code>) every time, you should avoid calling it multiple
times and then “merging” the returned <code>graph.State</code> values with plain
<code>result[k] = v</code> assignments (the last write wins).</p>
<p>Instead, build one <code>map[nodeID][]model.Message</code> and write it once:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-5-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-5-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-5-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-5-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-5-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-5-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-5-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-5-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-5-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-5-10">10</a></span>
<span class="normal"><a href="#__codelineno-5-11">11</a></span>
<span class="normal"><a href="#__codelineno-5-12">12</a></span>
<span class="normal"><a href="#__codelineno-5-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="kd">func</span><span class="w"> </span><span class="nx">preprocess</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="w">    </span><span class="nx">byNode</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">][]</span><span class="nx">model</span><span class="p">.</span><span class="nx">Message</span><span class="p">{</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="w">        </span><span class="nx">llm1NodeID</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="w">            </span><span class="nx">model</span><span class="p">.</span><span class="nx">NewSystemMessage</span><span class="p">(</span><span class="s">&quot;You are llm1.&quot;</span><span class="p">),</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="w">            </span><span class="nx">model</span><span class="p">.</span><span class="nx">NewUserMessage</span><span class="p">(</span><span class="s">&quot;question for llm1&quot;</span><span class="p">),</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6"></a><span class="w">        </span><span class="p">},</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7"></a><span class="w">        </span><span class="nx">llm2NodeID</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8"></a><span class="w">            </span><span class="nx">model</span><span class="p">.</span><span class="nx">NewSystemMessage</span><span class="p">(</span><span class="s">&quot;You are llm2.&quot;</span><span class="p">),</span>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9"></a><span class="w">            </span><span class="nx">model</span><span class="p">.</span><span class="nx">NewUserMessage</span><span class="p">(</span><span class="s">&quot;question for llm2&quot;</span><span class="p">),</span>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10"></a><span class="w">        </span><span class="p">},</span>
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">SetOneShotMessagesByNode</span><span class="p">(</span><span class="nx">byNode</span><span class="p">),</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>Alternative (no helpers): write a raw state delta map (handy if you also need
to update other keys in the same node):</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-6-1">1</a></span>
<span class="normal"><a href="#__codelineno-6-2">2</a></span>
<span class="normal"><a href="#__codelineno-6-3">3</a></span>
<span class="normal"><a href="#__codelineno-6-4">4</a></span>
<span class="normal"><a href="#__codelineno-6-5">5</a></span>
<span class="normal"><a href="#__codelineno-6-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="kd">func</span><span class="w"> </span><span class="nx">preprocess</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="w">    </span><span class="c1">// byNode := ...</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyOneShotMessagesByNode</span><span class="p">:</span><span class="w"> </span><span class="nx">byNode</span><span class="p">,</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5"></a><span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>Notes:</p>
<ul>
<li><code>llm1NodeID</code> / <code>llm2NodeID</code> must match the IDs you pass to <code>AddLLMNode</code>.</li>
<li>Each LLM node consumes <code>one_shot_messages_by_node[its_id]</code> once, and clears
  only its own entry.</li>
</ul>
<p>See examples:</p>
<ul>
<li><code>examples/graph/io_conventions</code> — Function + LLM + Agent I/O</li>
<li><code>examples/graph/io_conventions_tools</code> — Adds a Tools node path and shows how to capture tool JSON</li>
<li><code>examples/graph/oneshot_by_node</code> — One-shot inputs scoped by LLM node ID</li>
<li><code>examples/graph/oneshot_by_node_preprocess</code> — One upstream node prepares one-shot inputs for multiple LLM nodes</li>
<li><code>examples/graph/retry</code> — Node-level retry/backoff demonstration</li>
</ul>
<h4 id="constant-references-import-and-keys">Constant references (import and keys)</h4>
<ul>
<li>Import: <code>import "trpc.group/trpc-go/trpc-agent-go/graph"</code></li>
<li>Defined in: <code>graph/state.go</code></li>
</ul>
<ul>
<li>
<p>User‑facing keys</p>
<ul>
<li><code>user_input</code> → <code>graph.StateKeyUserInput</code></li>
<li><code>one_shot_messages</code> → <code>graph.StateKeyOneShotMessages</code></li>
<li><code>one_shot_messages_by_node</code> → <code>graph.StateKeyOneShotMessagesByNode</code></li>
<li><code>messages</code> → <code>graph.StateKeyMessages</code></li>
<li><code>last_response</code> → <code>graph.StateKeyLastResponse</code></li>
<li><code>last_response_id</code> → <code>graph.StateKeyLastResponseID</code></li>
<li><code>node_responses</code> → <code>graph.StateKeyNodeResponses</code></li>
</ul>
</li>
</ul>
<ul>
<li>
<p>One-shot helpers</p>
<ul>
<li><code>SetOneShotMessagesForNode(nodeID, msgs)</code> → per-node one-shot update</li>
<li><code>SetOneShotMessagesByNode(byNode)</code> → multi-node one-shot update</li>
<li><code>ClearOneShotMessagesForNode(nodeID)</code> → clear one node entry</li>
<li><code>ClearOneShotMessagesByNode()</code> → clear the entire map</li>
<li><code>GetOneShotMessagesForNode(state, nodeID)</code> → read one node entry</li>
</ul>
</li>
</ul>
<ul>
<li>Other useful keys<ul>
<li><code>session</code> → <code>graph.StateKeySession</code></li>
<li><code>metadata</code> → <code>graph.StateKeyMetadata</code></li>
<li><code>current_node_id</code> → <code>graph.StateKeyCurrentNodeID</code></li>
<li><code>exec_context</code> → <code>graph.StateKeyExecContext</code></li>
<li><code>tool_callbacks</code> → <code>graph.StateKeyToolCallbacks</code></li>
<li><code>model_callbacks</code> → <code>graph.StateKeyModelCallbacks</code></li>
<li><code>agent_callbacks</code> → <code>graph.StateKeyAgentCallbacks</code></li>
<li><code>parent_agent</code> → <code>graph.StateKeyParentAgent</code></li>
</ul>
</li>
</ul>
<p>Snippet:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-7-1">1</a></span>
<span class="normal"><a href="#__codelineno-7-2">2</a></span>
<span class="normal"><a href="#__codelineno-7-3">3</a></span>
<span class="normal"><a href="#__codelineno-7-4">4</a></span>
<span class="normal"><a href="#__codelineno-7-5">5</a></span>
<span class="normal"><a href="#__codelineno-7-6">6</a></span>
<span class="normal"><a href="#__codelineno-7-7">7</a></span>
<span class="normal"><a href="#__codelineno-7-8">8</a></span>
<span class="normal"><a href="#__codelineno-7-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="w">    </span><span class="s">&quot;context&quot;</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4"></a><span class="p">)</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5"></a>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6"></a><span class="kd">func</span><span class="w"> </span><span class="nx">myNode</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7"></a><span class="w">    </span><span class="nx">last</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">state</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyLastResponse</span><span class="p">].(</span><span class="kt">string</span><span class="p">)</span>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="s">&quot;my_key&quot;</span><span class="p">:</span><span class="w"> </span><span class="nx">last</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<h4 id="event-metadata-keys-statedelta">Event metadata keys (StateDelta)</h4>
<ul>
<li>Import: <code>import "trpc.group/trpc-go/trpc-agent-go/graph"</code></li>
<li>Defined in: <code>graph/events.go</code></li>
</ul>
<ul>
<li>Model metadata: <code>_model_metadata</code> → <code>graph.MetadataKeyModel</code> (struct <code>graph.ModelExecutionMetadata</code>)</li>
<li>Tool metadata: <code>_tool_metadata</code> → <code>graph.MetadataKeyTool</code> (struct <code>graph.ToolExecutionMetadata</code>)</li>
<li>Node metadata: <code>_node_metadata</code> → <code>graph.MetadataKeyNode</code> (struct <code>graph.NodeExecutionMetadata</code>). Includes retry info: <code>Attempt</code>, <code>MaxAttempts</code>, <code>NextDelay</code>, <code>Retrying</code> and timing fields.</li>
</ul>
<p>Snippet:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-8-1">1</a></span>
<span class="normal"><a href="#__codelineno-8-2">2</a></span>
<span class="normal"><a href="#__codelineno-8-3">3</a></span>
<span class="normal"><a href="#__codelineno-8-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="k">if</span><span class="w"> </span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">event</span><span class="p">.</span><span class="nx">StateDelta</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">MetadataKeyModel</span><span class="p">];</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">md</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">ModelExecutionMetadata</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="w">    </span><span class="nx">_</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">json</span><span class="p">.</span><span class="nx">Unmarshal</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">md</span><span class="p">)</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<h4 id="node-event-emitter-eventemitter">Node Event Emitter (EventEmitter)</h4>
<p>During NodeFunc execution, nodes can proactively emit custom events to the outside through <code>EventEmitter</code>, for real-time delivery of progress, intermediate results, or custom business data.</p>
<p><strong>Getting EventEmitter</strong></p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-9-1">1</a></span>
<span class="normal"><a href="#__codelineno-9-2">2</a></span>
<span class="normal"><a href="#__codelineno-9-3">3</a></span>
<span class="normal"><a href="#__codelineno-9-4">4</a></span>
<span class="normal"><a href="#__codelineno-9-5">5</a></span>
<span class="normal"><a href="#__codelineno-9-6">6</a></span>
<span class="normal"><a href="#__codelineno-9-7">7</a></span>
<span class="normal"><a href="#__codelineno-9-8">8</a></span>
<span class="normal"><a href="#__codelineno-9-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="kd">func</span><span class="w"> </span><span class="nx">myNode</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2"></a><span class="w">    </span><span class="c1">// Get EventEmitter from State</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3"></a><span class="w">    </span><span class="nx">emitter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">GetEventEmitterWithContext</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="p">)</span>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4"></a><span class="w">    </span><span class="c1">// Or use a custom context</span>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5"></a><span class="w">    </span><span class="c1">// emitter := graph.GetEventEmitter(state)</span>
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6"></a>
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7"></a><span class="w">    </span><span class="c1">// Use emitter to emit events...</span>
</span><span id="__span-9-8"><a id="__codelineno-9-8" name="__codelineno-9-8"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">state</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-9-9"><a id="__codelineno-9-9" name="__codelineno-9-9"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p><strong>EventEmitter Interface</strong></p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-10-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-10-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-10-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-10-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-10-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-10-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-10-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-10-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-10-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-10-10">10</a></span>
<span class="normal"><a href="#__codelineno-10-11">11</a></span>
<span class="normal"><a href="#__codelineno-10-12">12</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="kd">type</span><span class="w"> </span><span class="nx">EventEmitter</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2"></a><span class="w">    </span><span class="c1">// Emit sends any event</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3"></a><span class="w">    </span><span class="nx">Emit</span><span class="p">(</span><span class="nx">evt</span><span class="w"> </span><span class="o">*</span><span class="nx">event</span><span class="p">.</span><span class="nx">Event</span><span class="p">)</span><span class="w"> </span><span class="kt">error</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4"></a><span class="w">    </span><span class="c1">// EmitCustom emits a custom event</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5"></a><span class="w">    </span><span class="nx">EmitCustom</span><span class="p">(</span><span class="nx">eventType</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">payload</span><span class="w"> </span><span class="kt">any</span><span class="p">)</span><span class="w"> </span><span class="kt">error</span>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6"></a><span class="w">    </span><span class="c1">// EmitProgress emits a progress event (progress: 0-100)</span>
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7"></a><span class="w">    </span><span class="nx">EmitProgress</span><span class="p">(</span><span class="nx">progress</span><span class="w"> </span><span class="kt">float64</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="kt">error</span>
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8"></a><span class="w">    </span><span class="c1">// EmitText emits a streaming text event</span>
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9"></a><span class="w">    </span><span class="nx">EmitText</span><span class="p">(</span><span class="nx">text</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="kt">error</span>
</span><span id="__span-10-10"><a id="__codelineno-10-10" name="__codelineno-10-10"></a><span class="w">    </span><span class="c1">// Context returns the associated context</span>
</span><span id="__span-10-11"><a id="__codelineno-10-11" name="__codelineno-10-11"></a><span class="w">    </span><span class="nx">Context</span><span class="p">()</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span>
</span><span id="__span-10-12"><a id="__codelineno-10-12" name="__codelineno-10-12"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p><strong>Usage Examples</strong></p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-11-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-11-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-11-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-11-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-11-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-11-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-11-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-11-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-11-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-11-10">10</a></span>
<span class="normal"><a href="#__codelineno-11-11">11</a></span>
<span class="normal"><a href="#__codelineno-11-12">12</a></span>
<span class="normal"><a href="#__codelineno-11-13">13</a></span>
<span class="normal"><a href="#__codelineno-11-14">14</a></span>
<span class="normal"><a href="#__codelineno-11-15">15</a></span>
<span class="normal"><a href="#__codelineno-11-16">16</a></span>
<span class="normal"><a href="#__codelineno-11-17">17</a></span>
<span class="normal"><a href="#__codelineno-11-18">18</a></span>
<span class="normal"><a href="#__codelineno-11-19">19</a></span>
<span class="normal"><a href="#__codelineno-11-20">20</a></span>
<span class="normal"><a href="#__codelineno-11-21">21</a></span>
<span class="normal"><a href="#__codelineno-11-22">22</a></span>
<span class="normal"><a href="#__codelineno-11-23">23</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="kd">func</span><span class="w"> </span><span class="nx">dataProcessNode</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2"></a><span class="w">    </span><span class="nx">emitter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">GetEventEmitter</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3"></a>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4"></a><span class="w">    </span><span class="c1">// 1. Emit custom event</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5"></a><span class="w">    </span><span class="nx">emitter</span><span class="p">.</span><span class="nx">EmitCustom</span><span class="p">(</span><span class="s">&quot;data.loaded&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">any</span><span class="p">{</span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6"></a><span class="w">        </span><span class="s">&quot;recordCount&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1000</span><span class="p">,</span>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7"></a><span class="w">        </span><span class="s">&quot;source&quot;</span><span class="p">:</span><span class="w">      </span><span class="s">&quot;database&quot;</span><span class="p">,</span>
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8"></a><span class="w">    </span><span class="p">})</span>
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9"></a>
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10"></a><span class="w">    </span><span class="c1">// 2. Emit progress events</span>
</span><span id="__span-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11"></a><span class="w">    </span><span class="nx">total</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">100</span>
</span><span id="__span-11-12"><a id="__codelineno-11-12" name="__codelineno-11-12"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">total</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-13"><a id="__codelineno-11-13" name="__codelineno-11-13"></a><span class="w">        </span><span class="nx">processItem</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span>
</span><span id="__span-11-14"><a id="__codelineno-11-14" name="__codelineno-11-14"></a><span class="w">        </span><span class="nx">progress</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">float64</span><span class="p">(</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nb">float64</span><span class="p">(</span><span class="nx">total</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span>
</span><span id="__span-11-15"><a id="__codelineno-11-15" name="__codelineno-11-15"></a><span class="w">        </span><span class="nx">emitter</span><span class="p">.</span><span class="nx">EmitProgress</span><span class="p">(</span><span class="nx">progress</span><span class="p">,</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;Processing %d/%d&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nx">total</span><span class="p">))</span>
</span><span id="__span-11-16"><a id="__codelineno-11-16" name="__codelineno-11-16"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-11-17"><a id="__codelineno-11-17" name="__codelineno-11-17"></a>
</span><span id="__span-11-18"><a id="__codelineno-11-18" name="__codelineno-11-18"></a><span class="w">    </span><span class="c1">// 3. Emit streaming text</span>
</span><span id="__span-11-19"><a id="__codelineno-11-19" name="__codelineno-11-19"></a><span class="w">    </span><span class="nx">emitter</span><span class="p">.</span><span class="nx">EmitText</span><span class="p">(</span><span class="s">&quot;Processing complete.\n&quot;</span><span class="p">)</span>
</span><span id="__span-11-20"><a id="__codelineno-11-20" name="__codelineno-11-20"></a><span class="w">    </span><span class="nx">emitter</span><span class="p">.</span><span class="nx">EmitText</span><span class="p">(</span><span class="s">&quot;Results: 100 items processed successfully.&quot;</span><span class="p">)</span>
</span><span id="__span-11-21"><a id="__codelineno-11-21" name="__codelineno-11-21"></a>
</span><span id="__span-11-22"><a id="__codelineno-11-22" name="__codelineno-11-22"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">state</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-11-23"><a id="__codelineno-11-23" name="__codelineno-11-23"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p><strong>Event Flow Diagram</strong></p>
<pre class="mermaid"><code>sequenceDiagram
    autonumber
    participant NF as NodeFunc
    participant EE as EventEmitter
    participant EC as EventChan
    participant EX as Executor
    participant TR as AGUI Translator
    participant FE as Frontend Client

    Note over NF,FE: Event Emission Phase
    NF-&gt;&gt;EE: GetEventEmitter(state)
    EE--&gt;&gt;NF: Return EventEmitter instance

    alt Emit Custom Event
        NF-&gt;&gt;EE: EmitCustom(eventType, payload)
    else Emit Progress Event
        NF-&gt;&gt;EE: EmitProgress(progress, message)
    else Emit Text Event
        NF-&gt;&gt;EE: EmitText(text)
    end

    Note over EE: Build NodeCustomEventMetadata
    EE-&gt;&gt;EE: Inject NodeID, InvocationID, Timestamp
    EE-&gt;&gt;EC: Send Event to channel

    Note over EC,FE: Event Consumption Phase
    EC-&gt;&gt;EX: Executor receives event
    EX-&gt;&gt;TR: Pass event to Translator

    alt Custom Event
        TR-&gt;&gt;TR: Convert to AG-UI CustomEvent
    else Progress Event
        TR-&gt;&gt;TR: Convert to AG-UI CustomEvent (with progress info)
    else Text Event (in message context)
        TR-&gt;&gt;TR: Convert to TextMessageContentEvent
    else Text Event (not in message context)
        TR-&gt;&gt;TR: Convert to AG-UI CustomEvent
    end

    TR-&gt;&gt;FE: SSE push AG-UI event
    FE-&gt;&gt;FE: Process and update UI</code></pre>
<p><strong>AGUI Event Conversion</strong></p>
<p>When using AGUI Server, events emitted by nodes are automatically converted to AG-UI protocol events:</p>
<table>
<thead>
<tr>
<th>Node Event Type</th>
<th>AG-UI Event Type</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Custom</td>
<td>CustomEvent</td>
<td>Custom event, payload in <code>value</code> field</td>
</tr>
<tr>
<td>Progress</td>
<td>CustomEvent</td>
<td>Progress event with <code>progress</code> and <code>message</code></td>
</tr>
<tr>
<td>Text (in message context)</td>
<td>TextMessageContentEvent</td>
<td>Streaming text appended to current message</td>
</tr>
<tr>
<td>Text (not in message context)</td>
<td>CustomEvent</td>
<td>Contains <code>nodeId</code> and <code>content</code> fields</td>
</tr>
</tbody>
</table>
<p><strong>Notes</strong></p>
<ul>
<li><strong>Thread Safety</strong>: EventEmitter is thread-safe and can be used in concurrent environments</li>
<li><strong>Graceful Degradation</strong>: If State has no valid ExecutionContext or EventChan, <code>GetEventEmitter</code> returns a no-op emitter that silently succeeds for all operations</li>
<li><strong>Error Handling</strong>: Event emission failures do not interrupt node execution; it's recommended to only log warnings</li>
<li><strong>Custom Event Metadata</strong>: <code>_node_custom_metadata</code> → <code>graph.MetadataKeyNodeCustom</code> (struct <code>graph.NodeCustomEventMetadata</code>)</li>
</ul>
<h3 id="1-creating-graphagent-and-runner">1. Creating GraphAgent and Runner</h3>
<p>Users mainly use the Graph package by creating GraphAgent and then using it through Runner. This is the recommended usage pattern:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-12-1">  1</a></span>
<span class="normal"><a href="#__codelineno-12-2">  2</a></span>
<span class="normal"><a href="#__codelineno-12-3">  3</a></span>
<span class="normal"><a href="#__codelineno-12-4">  4</a></span>
<span class="normal"><a href="#__codelineno-12-5">  5</a></span>
<span class="normal"><a href="#__codelineno-12-6">  6</a></span>
<span class="normal"><a href="#__codelineno-12-7">  7</a></span>
<span class="normal"><a href="#__codelineno-12-8">  8</a></span>
<span class="normal"><a href="#__codelineno-12-9">  9</a></span>
<span class="normal"><a href="#__codelineno-12-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-12-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-12-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-12-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-12-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-12-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-12-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-12-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-12-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-12-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-12-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-12-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-12-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-12-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-12-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-12-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-12-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-12-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-12-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-12-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-12-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-12-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-12-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-12-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-12-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-12-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-12-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-12-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-12-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-12-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-12-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-12-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-12-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-12-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-12-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-12-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-12-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-12-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-12-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-12-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-12-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-12-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-12-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-12-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-12-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-12-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-12-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-12-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-12-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-12-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-12-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-12-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-12-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-12-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-12-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-12-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-12-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-12-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-12-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-12-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-12-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-12-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-12-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-12-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-12-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-12-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-12-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-12-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-12-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-12-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-12-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-12-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-12-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-12-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-12-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-12-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-12-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-12-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-12-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-12-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-12-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-12-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-12-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-12-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-12-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-12-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-12-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-12-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-12-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-12-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-12-100">100</a></span>
<span class="normal"><a href="#__codelineno-12-101">101</a></span>
<span class="normal"><a href="#__codelineno-12-102">102</a></span>
<span class="normal"><a href="#__codelineno-12-103">103</a></span>
<span class="normal"><a href="#__codelineno-12-104">104</a></span>
<span class="normal"><a href="#__codelineno-12-105">105</a></span>
<span class="normal"><a href="#__codelineno-12-106">106</a></span>
<span class="normal"><a href="#__codelineno-12-107">107</a></span>
<span class="normal"><a href="#__codelineno-12-108">108</a></span>
<span class="normal"><a href="#__codelineno-12-109">109</a></span>
<span class="normal"><a href="#__codelineno-12-110">110</a></span>
<span class="normal"><a href="#__codelineno-12-111">111</a></span>
<span class="normal"><a href="#__codelineno-12-112">112</a></span>
<span class="normal"><a href="#__codelineno-12-113">113</a></span>
<span class="normal"><a href="#__codelineno-12-114">114</a></span>
<span class="normal"><a href="#__codelineno-12-115">115</a></span>
<span class="normal"><a href="#__codelineno-12-116">116</a></span>
<span class="normal"><a href="#__codelineno-12-117">117</a></span>
<span class="normal"><a href="#__codelineno-12-118">118</a></span>
<span class="normal"><a href="#__codelineno-12-119">119</a></span>
<span class="normal"><a href="#__codelineno-12-120">120</a></span>
<span class="normal"><a href="#__codelineno-12-121">121</a></span>
<span class="normal"><a href="#__codelineno-12-122">122</a></span>
<span class="normal"><a href="#__codelineno-12-123">123</a></span>
<span class="normal"><a href="#__codelineno-12-124">124</a></span>
<span class="normal"><a href="#__codelineno-12-125">125</a></span>
<span class="normal"><a href="#__codelineno-12-126">126</a></span>
<span class="normal"><a href="#__codelineno-12-127">127</a></span>
<span class="normal"><a href="#__codelineno-12-128">128</a></span>
<span class="normal"><a href="#__codelineno-12-129">129</a></span>
<span class="normal"><a href="#__codelineno-12-130">130</a></span>
<span class="normal"><a href="#__codelineno-12-131">131</a></span>
<span class="normal"><a href="#__codelineno-12-132">132</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="kn">package</span><span class="w"> </span><span class="nx">main</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2"></a>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4"></a><span class="w">    </span><span class="s">&quot;context&quot;</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5"></a><span class="w">    </span><span class="s">&quot;fmt&quot;</span>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6"></a><span class="w">    </span><span class="s">&quot;time&quot;</span>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7"></a>
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/agent/graphagent&quot;</span>
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/model&quot;</span>
</span><span id="__span-12-11"><a id="__codelineno-12-11" name="__codelineno-12-11"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/runner&quot;</span>
</span><span id="__span-12-12"><a id="__codelineno-12-12" name="__codelineno-12-12"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/session/inmemory&quot;</span>
</span><span id="__span-12-13"><a id="__codelineno-12-13" name="__codelineno-12-13"></a><span class="p">)</span>
</span><span id="__span-12-14"><a id="__codelineno-12-14" name="__codelineno-12-14"></a>
</span><span id="__span-12-15"><a id="__codelineno-12-15" name="__codelineno-12-15"></a><span class="kd">func</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-16"><a id="__codelineno-12-16" name="__codelineno-12-16"></a><span class="w">    </span><span class="c1">// 1. Create state schema</span>
</span><span id="__span-12-17"><a id="__codelineno-12-17" name="__codelineno-12-17"></a><span class="w">    </span><span class="nx">schema</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">MessagesStateSchema</span><span class="p">()</span>
</span><span id="__span-12-18"><a id="__codelineno-12-18" name="__codelineno-12-18"></a>
</span><span id="__span-12-19"><a id="__codelineno-12-19" name="__codelineno-12-19"></a><span class="w">    </span><span class="c1">// 2. Create state graph builder</span>
</span><span id="__span-12-20"><a id="__codelineno-12-20" name="__codelineno-12-20"></a><span class="w">    </span><span class="nx">stateGraph</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateGraph</span><span class="p">(</span><span class="nx">schema</span><span class="p">)</span>
</span><span id="__span-12-21"><a id="__codelineno-12-21" name="__codelineno-12-21"></a>
</span><span id="__span-12-22"><a id="__codelineno-12-22" name="__codelineno-12-22"></a><span class="w">    </span><span class="c1">// 3. Add nodes</span>
</span><span id="__span-12-23"><a id="__codelineno-12-23" name="__codelineno-12-23"></a><span class="w">    </span><span class="nx">stateGraph</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;start&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">startNodeFunc</span><span class="p">).</span>
</span><span id="__span-12-24"><a id="__codelineno-12-24" name="__codelineno-12-24"></a><span class="w">        </span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;process&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">processNodeFunc</span><span class="p">)</span>
</span><span id="__span-12-25"><a id="__codelineno-12-25" name="__codelineno-12-25"></a>
</span><span id="__span-12-26"><a id="__codelineno-12-26" name="__codelineno-12-26"></a><span class="w">    </span><span class="c1">// 4. Set edges</span>
</span><span id="__span-12-27"><a id="__codelineno-12-27" name="__codelineno-12-27"></a><span class="w">    </span><span class="nx">stateGraph</span><span class="p">.</span><span class="nx">AddEdge</span><span class="p">(</span><span class="s">&quot;start&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;process&quot;</span><span class="p">)</span>
</span><span id="__span-12-28"><a id="__codelineno-12-28" name="__codelineno-12-28"></a>
</span><span id="__span-12-29"><a id="__codelineno-12-29" name="__codelineno-12-29"></a><span class="w">    </span><span class="c1">// 5. Set entry point and finish point</span>
</span><span id="__span-12-30"><a id="__codelineno-12-30" name="__codelineno-12-30"></a><span class="w">    </span><span class="c1">// SetEntryPoint automatically creates an edge from the virtual Start node to the &quot;start&quot; node</span>
</span><span id="__span-12-31"><a id="__codelineno-12-31" name="__codelineno-12-31"></a><span class="w">    </span><span class="c1">// SetFinishPoint automatically creates an edge from the &quot;process&quot; node to the virtual End node</span>
</span><span id="__span-12-32"><a id="__codelineno-12-32" name="__codelineno-12-32"></a><span class="w">    </span><span class="nx">stateGraph</span><span class="p">.</span><span class="nx">SetEntryPoint</span><span class="p">(</span><span class="s">&quot;start&quot;</span><span class="p">).</span>
</span><span id="__span-12-33"><a id="__codelineno-12-33" name="__codelineno-12-33"></a><span class="w">        </span><span class="nx">SetFinishPoint</span><span class="p">(</span><span class="s">&quot;process&quot;</span><span class="p">)</span>
</span><span id="__span-12-34"><a id="__codelineno-12-34" name="__codelineno-12-34"></a>
</span><span id="__span-12-35"><a id="__codelineno-12-35" name="__codelineno-12-35"></a><span class="w">    </span><span class="c1">// 6. Compile the graph</span>
</span><span id="__span-12-36"><a id="__codelineno-12-36" name="__codelineno-12-36"></a><span class="w">    </span><span class="nx">compiledGraph</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">stateGraph</span><span class="p">.</span><span class="nx">Compile</span><span class="p">()</span>
</span><span id="__span-12-37"><a id="__codelineno-12-37" name="__codelineno-12-37"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-38"><a id="__codelineno-12-38" name="__codelineno-12-38"></a><span class="w">        </span><span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span id="__span-12-39"><a id="__codelineno-12-39" name="__codelineno-12-39"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-12-40"><a id="__codelineno-12-40" name="__codelineno-12-40"></a>
</span><span id="__span-12-41"><a id="__codelineno-12-41" name="__codelineno-12-41"></a><span class="w">    </span><span class="c1">// 7. Create GraphAgent</span>
</span><span id="__span-12-42"><a id="__codelineno-12-42" name="__codelineno-12-42"></a><span class="w">    </span><span class="nx">graphAgent</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;simple-workflow&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">compiledGraph</span><span class="p">,</span>
</span><span id="__span-12-43"><a id="__codelineno-12-43" name="__codelineno-12-43"></a><span class="w">        </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithDescription</span><span class="p">(</span><span class="s">&quot;Simple workflow example&quot;</span><span class="p">),</span>
</span><span id="__span-12-44"><a id="__codelineno-12-44" name="__codelineno-12-44"></a><span class="w">        </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithInitialState</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{}),</span>
</span><span id="__span-12-45"><a id="__codelineno-12-45" name="__codelineno-12-45"></a><span class="w">        </span><span class="c1">// Set message filter modes for the model. Messages passed to the model must satisfy both WithMessageTimelineFilterMode and WithMessageBranchFilterMode conditions</span>
</span><span id="__span-12-46"><a id="__codelineno-12-46" name="__codelineno-12-46"></a><span class="w">        </span><span class="c1">// Timeline filter mode</span>
</span><span id="__span-12-47"><a id="__codelineno-12-47" name="__codelineno-12-47"></a><span class="w">        </span><span class="c1">// Default value: graphagent.TimelineFilterAll</span>
</span><span id="__span-12-48"><a id="__codelineno-12-48" name="__codelineno-12-48"></a><span class="w">        </span><span class="c1">// Options:</span>
</span><span id="__span-12-49"><a id="__codelineno-12-49" name="__codelineno-12-49"></a><span class="w">        </span><span class="c1">//  - graphagent.TimelineFilterAll: Include historical messages and messages generated in the current request</span>
</span><span id="__span-12-50"><a id="__codelineno-12-50" name="__codelineno-12-50"></a><span class="w">        </span><span class="c1">//  - graphagent.TimelineFilterCurrentRequest: Only include messages generated in the current request</span>
</span><span id="__span-12-51"><a id="__codelineno-12-51" name="__codelineno-12-51"></a><span class="w">        </span><span class="c1">//  - graphagent.TimelineFilterCurrentInvocation: Only include messages generated in the current invocation context</span>
</span><span id="__span-12-52"><a id="__codelineno-12-52" name="__codelineno-12-52"></a><span class="w">        </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithMessageTimelineFilterMode</span><span class="p">(</span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">TimelineFilterAll</span><span class="p">),</span>
</span><span id="__span-12-53"><a id="__codelineno-12-53" name="__codelineno-12-53"></a><span class="w">        </span><span class="c1">// Branch filter mode</span>
</span><span id="__span-12-54"><a id="__codelineno-12-54" name="__codelineno-12-54"></a><span class="w">        </span><span class="c1">// Default value: graphagent.BranchFilterModePrefix</span>
</span><span id="__span-12-55"><a id="__codelineno-12-55" name="__codelineno-12-55"></a><span class="w">        </span><span class="c1">// Options:</span>
</span><span id="__span-12-56"><a id="__codelineno-12-56" name="__codelineno-12-56"></a><span class="w">        </span><span class="c1">//  - graphagent.BranchFilterModeAll: Include messages from all agents. Set this value when the current agent needs to synchronize all valid content messages generated by all agents to the model during interaction</span>
</span><span id="__span-12-57"><a id="__codelineno-12-57" name="__codelineno-12-57"></a><span class="w">        </span><span class="c1">//  - graphagent.BranchFilterModePrefix: Filter messages by prefix matching Event.FilterKey with Invocation.eventFilterKey. Set this value when you want to pass messages generated by the current agent and related upstream/downstream agents to the model</span>
</span><span id="__span-12-58"><a id="__codelineno-12-58" name="__codelineno-12-58"></a><span class="w">        </span><span class="c1">//  - graphagent.BranchFilterModeExact: Filter messages by Event.FilterKey == Invocation.eventFilterKey. Set this value when the current agent only needs to use messages generated by itself during model interaction</span>
</span><span id="__span-12-59"><a id="__codelineno-12-59" name="__codelineno-12-59"></a><span class="w">        </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithMessageBranchFilterMode</span><span class="p">(</span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">BranchFilterModeAll</span><span class="p">),</span>
</span><span id="__span-12-60"><a id="__codelineno-12-60" name="__codelineno-12-60"></a><span class="w">    </span><span class="p">)</span>
</span><span id="__span-12-61"><a id="__codelineno-12-61" name="__codelineno-12-61"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-62"><a id="__codelineno-12-62" name="__codelineno-12-62"></a><span class="w">        </span><span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span id="__span-12-63"><a id="__codelineno-12-63" name="__codelineno-12-63"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-12-64"><a id="__codelineno-12-64" name="__codelineno-12-64"></a>
</span><span id="__span-12-65"><a id="__codelineno-12-65" name="__codelineno-12-65"></a><span class="w">    </span><span class="c1">// 8. Create session service</span>
</span><span id="__span-12-66"><a id="__codelineno-12-66" name="__codelineno-12-66"></a><span class="w">    </span><span class="nx">sessionService</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">inmemory</span><span class="p">.</span><span class="nx">NewSessionService</span><span class="p">()</span>
</span><span id="__span-12-67"><a id="__codelineno-12-67" name="__codelineno-12-67"></a>
</span><span id="__span-12-68"><a id="__codelineno-12-68" name="__codelineno-12-68"></a><span class="w">    </span><span class="c1">// 9. Create Runner</span>
</span><span id="__span-12-69"><a id="__codelineno-12-69" name="__codelineno-12-69"></a><span class="w">    </span><span class="nx">appRunner</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">runner</span><span class="p">.</span><span class="nx">NewRunner</span><span class="p">(</span>
</span><span id="__span-12-70"><a id="__codelineno-12-70" name="__codelineno-12-70"></a><span class="w">        </span><span class="s">&quot;simple-app&quot;</span><span class="p">,</span>
</span><span id="__span-12-71"><a id="__codelineno-12-71" name="__codelineno-12-71"></a><span class="w">        </span><span class="nx">graphAgent</span><span class="p">,</span>
</span><span id="__span-12-72"><a id="__codelineno-12-72" name="__codelineno-12-72"></a><span class="w">        </span><span class="nx">runner</span><span class="p">.</span><span class="nx">WithSessionService</span><span class="p">(</span><span class="nx">sessionService</span><span class="p">),</span>
</span><span id="__span-12-73"><a id="__codelineno-12-73" name="__codelineno-12-73"></a><span class="w">    </span><span class="p">)</span>
</span><span id="__span-12-74"><a id="__codelineno-12-74" name="__codelineno-12-74"></a>
</span><span id="__span-12-75"><a id="__codelineno-12-75" name="__codelineno-12-75"></a><span class="w">    </span><span class="c1">// 10. Execute workflow</span>
</span><span id="__span-12-76"><a id="__codelineno-12-76" name="__codelineno-12-76"></a><span class="w">    </span><span class="nx">ctx</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Background</span><span class="p">()</span>
</span><span id="__span-12-77"><a id="__codelineno-12-77" name="__codelineno-12-77"></a><span class="w">    </span><span class="nx">userID</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;user&quot;</span>
</span><span id="__span-12-78"><a id="__codelineno-12-78" name="__codelineno-12-78"></a><span class="w">    </span><span class="nx">sessionID</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;session-%d&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">().</span><span class="nx">Unix</span><span class="p">())</span>
</span><span id="__span-12-79"><a id="__codelineno-12-79" name="__codelineno-12-79"></a>
</span><span id="__span-12-80"><a id="__codelineno-12-80" name="__codelineno-12-80"></a><span class="w">    </span><span class="c1">// Create user message (Runner will automatically put the message content into StateKeyUserInput)</span>
</span><span id="__span-12-81"><a id="__codelineno-12-81" name="__codelineno-12-81"></a><span class="w">    </span><span class="nx">message</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">model</span><span class="p">.</span><span class="nx">NewUserMessage</span><span class="p">(</span><span class="s">&quot;Hello World&quot;</span><span class="p">)</span>
</span><span id="__span-12-82"><a id="__codelineno-12-82" name="__codelineno-12-82"></a>
</span><span id="__span-12-83"><a id="__codelineno-12-83" name="__codelineno-12-83"></a><span class="w">    </span><span class="c1">// Execute through Runner</span>
</span><span id="__span-12-84"><a id="__codelineno-12-84" name="__codelineno-12-84"></a><span class="w">    </span><span class="nx">eventChan</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">appRunner</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">userID</span><span class="p">,</span><span class="w"> </span><span class="nx">sessionID</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="p">)</span>
</span><span id="__span-12-85"><a id="__codelineno-12-85" name="__codelineno-12-85"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-86"><a id="__codelineno-12-86" name="__codelineno-12-86"></a><span class="w">        </span><span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span id="__span-12-87"><a id="__codelineno-12-87" name="__codelineno-12-87"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-12-88"><a id="__codelineno-12-88" name="__codelineno-12-88"></a>
</span><span id="__span-12-89"><a id="__codelineno-12-89" name="__codelineno-12-89"></a><span class="w">    </span><span class="c1">// Handle event stream</span>
</span><span id="__span-12-90"><a id="__codelineno-12-90" name="__codelineno-12-90"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">event</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">eventChan</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-91"><a id="__codelineno-12-91" name="__codelineno-12-91"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">event</span><span class="p">.</span><span class="nx">Error</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-92"><a id="__codelineno-12-92" name="__codelineno-12-92"></a><span class="w">            </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Error: %s\n&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">event</span><span class="p">.</span><span class="nx">Error</span><span class="p">.</span><span class="nx">Message</span><span class="p">)</span>
</span><span id="__span-12-93"><a id="__codelineno-12-93" name="__codelineno-12-93"></a><span class="w">            </span><span class="k">continue</span>
</span><span id="__span-12-94"><a id="__codelineno-12-94" name="__codelineno-12-94"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-12-95"><a id="__codelineno-12-95" name="__codelineno-12-95"></a>
</span><span id="__span-12-96"><a id="__codelineno-12-96" name="__codelineno-12-96"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">Response</span><span class="p">.</span><span class="nx">Choices</span><span class="p">)</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-97"><a id="__codelineno-12-97" name="__codelineno-12-97"></a><span class="w">            </span><span class="nx">choice</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">event</span><span class="p">.</span><span class="nx">Response</span><span class="p">.</span><span class="nx">Choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="__span-12-98"><a id="__codelineno-12-98" name="__codelineno-12-98"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">choice</span><span class="p">.</span><span class="nx">Delta</span><span class="p">.</span><span class="nx">Content</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-99"><a id="__codelineno-12-99" name="__codelineno-12-99"></a><span class="w">                </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Print</span><span class="p">(</span><span class="nx">choice</span><span class="p">.</span><span class="nx">Delta</span><span class="p">.</span><span class="nx">Content</span><span class="p">)</span>
</span><span id="__span-12-100"><a id="__codelineno-12-100" name="__codelineno-12-100"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-12-101"><a id="__codelineno-12-101" name="__codelineno-12-101"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-12-102"><a id="__codelineno-12-102" name="__codelineno-12-102"></a>
</span><span id="__span-12-103"><a id="__codelineno-12-103" name="__codelineno-12-103"></a><span class="w">        </span><span class="c1">// Recommended: Use Runner completion event as a signal for &quot;workflow end&quot;</span>
</span><span id="__span-12-104"><a id="__codelineno-12-104" name="__codelineno-12-104"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">event</span><span class="p">.</span><span class="nx">IsRunnerCompletion</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-105"><a id="__codelineno-12-105" name="__codelineno-12-105"></a><span class="w">            </span><span class="k">break</span>
</span><span id="__span-12-106"><a id="__codelineno-12-106" name="__codelineno-12-106"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-12-107"><a id="__codelineno-12-107" name="__codelineno-12-107"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-12-108"><a id="__codelineno-12-108" name="__codelineno-12-108"></a><span class="p">}</span>
</span><span id="__span-12-109"><a id="__codelineno-12-109" name="__codelineno-12-109"></a>
</span><span id="__span-12-110"><a id="__codelineno-12-110" name="__codelineno-12-110"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-12-111"><a id="__codelineno-12-111" name="__codelineno-12-111"></a><span class="w">    </span><span class="nx">stateKeyProcessedData</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;processed_data&quot;</span>
</span><span id="__span-12-112"><a id="__codelineno-12-112" name="__codelineno-12-112"></a><span class="w">    </span><span class="nx">stateKeyResult</span><span class="w">        </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;result&quot;</span>
</span><span id="__span-12-113"><a id="__codelineno-12-113" name="__codelineno-12-113"></a><span class="p">)</span>
</span><span id="__span-12-114"><a id="__codelineno-12-114" name="__codelineno-12-114"></a>
</span><span id="__span-12-115"><a id="__codelineno-12-115" name="__codelineno-12-115"></a><span class="c1">// Start node function implementation</span>
</span><span id="__span-12-116"><a id="__codelineno-12-116" name="__codelineno-12-116"></a><span class="kd">func</span><span class="w"> </span><span class="nx">startNodeFunc</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-117"><a id="__codelineno-12-117" name="__codelineno-12-117"></a><span class="w">    </span><span class="c1">// Get user input from built-in StateKeyUserInput (automatically set by Runner)</span>
</span><span id="__span-12-118"><a id="__codelineno-12-118" name="__codelineno-12-118"></a><span class="w">    </span><span class="nx">input</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">state</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyUserInput</span><span class="p">].(</span><span class="kt">string</span><span class="p">)</span>
</span><span id="__span-12-119"><a id="__codelineno-12-119" name="__codelineno-12-119"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span>
</span><span id="__span-12-120"><a id="__codelineno-12-120" name="__codelineno-12-120"></a><span class="w">        </span><span class="nx">stateKeyProcessedData</span><span class="p">:</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;Processed: %s&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">input</span><span class="p">),</span>
</span><span id="__span-12-121"><a id="__codelineno-12-121" name="__codelineno-12-121"></a><span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-12-122"><a id="__codelineno-12-122" name="__codelineno-12-122"></a><span class="p">}</span>
</span><span id="__span-12-123"><a id="__codelineno-12-123" name="__codelineno-12-123"></a>
</span><span id="__span-12-124"><a id="__codelineno-12-124" name="__codelineno-12-124"></a><span class="c1">// Process node function implementation</span>
</span><span id="__span-12-125"><a id="__codelineno-12-125" name="__codelineno-12-125"></a><span class="kd">func</span><span class="w"> </span><span class="nx">processNodeFunc</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-126"><a id="__codelineno-12-126" name="__codelineno-12-126"></a><span class="w">    </span><span class="nx">processed</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">state</span><span class="p">[</span><span class="nx">stateKeyProcessedData</span><span class="p">].(</span><span class="kt">string</span><span class="p">)</span>
</span><span id="__span-12-127"><a id="__codelineno-12-127" name="__codelineno-12-127"></a><span class="w">    </span><span class="nx">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;Result: %s&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">processed</span><span class="p">)</span>
</span><span id="__span-12-128"><a id="__codelineno-12-128" name="__codelineno-12-128"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span>
</span><span id="__span-12-129"><a id="__codelineno-12-129" name="__codelineno-12-129"></a><span class="w">        </span><span class="nx">stateKeyResult</span><span class="p">:</span><span class="w">             </span><span class="nx">result</span><span class="p">,</span>
</span><span id="__span-12-130"><a id="__codelineno-12-130" name="__codelineno-12-130"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyLastResponse</span><span class="p">:</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;Final result: %s&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">result</span><span class="p">),</span>
</span><span id="__span-12-131"><a id="__codelineno-12-131" name="__codelineno-12-131"></a><span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-12-132"><a id="__codelineno-12-132" name="__codelineno-12-132"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="2-using-llm-nodes">2. Using LLM Nodes</h3>
<p>LLM nodes implement a fixed three-stage input rule without extra configuration:</p>
<ol>
<li>OneShot first:<ul>
<li>If <code>one_shot_messages_by_node[&lt;node_id&gt;]</code> exists, use it as the input for
   this round.</li>
<li>Otherwise, if <code>one_shot_messages</code> exists, use it as the input for this
   round.</li>
</ul>
</li>
<li>UserInput next: Otherwise, if <code>user_input</code> exists, persist once to history.</li>
<li>History default: Otherwise, use durable <code>messages</code> as input.</li>
</ol>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-13-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-13-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-13-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-13-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-13-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-13-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-13-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-13-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-13-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-13-10">10</a></span>
<span class="normal"><a href="#__codelineno-13-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="c1">// Create LLM model.</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2"></a><span class="nx">model</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">openai</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;gpt-4&quot;</span><span class="p">)</span>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3"></a>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4"></a><span class="c1">// Add LLM node.</span>
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5"></a><span class="nx">stateGraph</span><span class="p">.</span><span class="nx">AddLLMNode</span><span class="p">(</span><span class="s">&quot;analyze&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">model</span><span class="p">,</span>
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6"></a><span class="w">    </span><span class="s">`You are a document analysis expert. Analyze the provided document and:</span>
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7"></a><span class="s">1. Classify document type and complexity</span>
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8"></a><span class="s">2. Extract key themes</span>
</span><span id="__span-13-9"><a id="__codelineno-13-9" name="__codelineno-13-9"></a><span class="s">3. Evaluate content quality</span>
</span><span id="__span-13-10"><a id="__codelineno-13-10" name="__codelineno-13-10"></a><span class="s">Please provide structured analysis results.`</span><span class="p">,</span>
</span><span id="__span-13-11"><a id="__codelineno-13-11" name="__codelineno-13-11"></a><span class="w">    </span><span class="kc">nil</span><span class="p">)</span><span class="w"> </span><span class="c1">// Tool mapping.</span>
</span></code></pre></div></td></tr></table></div>
<p>Important notes:</p>
<ul>
<li>System prompt is only used for this round and is not persisted to state.</li>
<li>One-shot keys (<code>user_input</code> / <code>one_shot_messages</code> / <code>one_shot_messages_by_node</code>)
  are automatically cleared after successful execution.</li>
<li>Parallel branches: if multiple branches need different one-shot inputs for
  different LLM nodes in the same step, write <code>one_shot_messages_by_node</code>
  instead of <code>one_shot_messages</code>. If one upstream node prepares inputs for
  multiple LLM nodes, prefer <code>graph.SetOneShotMessagesByNode(...)</code> to write all
  entries at once.</li>
<li>All state updates are atomic.</li>
<li>GraphAgent/Runner only sets <code>user_input</code> and no longer pre-populates <code>messages</code> with a user message. This allows any pre-LLM node to modify <code>user_input</code> and have it take effect in the same round.</li>
<li>When Graph runs sub-agents, it preserves the parent run's <code>RequestID</code>
  (request identifier) so the current user input is included exactly once,
  even when it already exists in session history.</li>
</ul>
<h4 id="event-emission-streaming-vs-final">Event emission (streaming vs final)</h4>
<p>When the Large Language Model (LLM) is called with streaming enabled, a single
model call can produce multiple events:</p>
<ul>
<li>Streaming chunks: incremental text in <code>choice.Delta.Content</code></li>
<li>A final message: full text in <code>choice.Message.Content</code></li>
</ul>
<p>In graph workflows there are also two different "done" concepts:</p>
<ul>
<li>Model done: a single model call finishes (typically <code>Response.Done=true</code>)</li>
<li>Workflow done: the whole graph run ends (use <code>event.IsRunnerCompletion()</code>)</li>
</ul>
<p>By default, graph LLM nodes only emit the streaming chunks. They do not emit
the final <code>Done=true</code> assistant message event. This keeps intermediate node
outputs from being treated as normal assistant replies (for example, being
persisted into the Session by Runner).</p>
<p>If you want graph LLM nodes to also emit the final <code>Done=true</code> assistant
message events, enable <code>agent.WithGraphEmitFinalModelResponses(true)</code> when
running via Runner. See <code>runner.md</code> for details and examples.</p>
<p>Tip: if you are using Runner and you mainly care about streaming Large Language
Model (LLM) messages, you can enable <code>agent.WithStreamMode(...)</code> (see
"Event Monitoring"). When <code>agent.StreamModeMessages</code> is selected, graph LLM
nodes enable final model responses automatically for that run.</p>
<p>Tip: parsing JSON / structured output from streaming</p>
<ul>
<li>Streaming chunks (<code>choice.Delta.Content</code>) are incremental and are not
  guaranteed to form valid JSON until the end of the model call.</li>
<li>If you need to parse JSON (or any structured text), do not <code>json.Unmarshal</code>
  per chunk. Buffer and parse once you have the full string.</li>
</ul>
<p>Common approaches:</p>
<ul>
<li><strong>Inside the graph</strong>: parse in a downstream node from
  <code>node_responses[nodeID]</code> (or <code>last_response</code> in strictly serial flows),
  because those values are only set after the node finishes.</li>
<li><strong>Outside the graph</strong> (event consumer): accumulate <code>Delta.Content</code> and parse
  when you see a non-partial response that carries <code>choice.Message.Content</code>
  (or when the workflow finishes).</li>
</ul>
<h4 id="three-input-paradigms">Three input paradigms</h4>
<ul>
<li>
<p>OneShot (<code>StateKeyOneShotMessages</code>):</p>
<ul>
<li>When present, only the provided <code>[]model.Message</code> is used for this round, typically including a full system prompt and user prompt. Automatically cleared afterwards.</li>
<li>Use case: a dedicated pre-node constructs the full prompt and must fully override input.</li>
<li>Parallel branches: when multiple branches prepare one-shot inputs for
  different LLM nodes, prefer <code>StateKeyOneShotMessagesByNode</code> to avoid
  clobbering a shared global key.</li>
<li>If a single node prepares one-shot inputs for multiple LLM nodes, use
  <code>graph.SetOneShotMessagesByNode(...)</code> to write them in one return value.</li>
</ul>
</li>
</ul>
<ul>
<li>
<p>UserInput (<code>StateKeyUserInput</code>):</p>
<ul>
<li>When non-empty, the LLM node uses durable <code>messages</code> plus this round's user input to call the model. After the call, it writes the user input and assistant reply to <code>messages</code> using <code>MessageOp</code> (e.g., <code>AppendMessages</code>, <code>ReplaceLastUser</code>) atomically, and clears <code>user_input</code> to avoid repeated appends.</li>
<li>Use case: conversational flows where pre-nodes may adjust user input.</li>
</ul>
</li>
</ul>
<ul>
<li>Messages only (just <code>StateKeyMessages</code>):<ul>
<li>Common in tool-call loops. After the first round via <code>user_input</code>, routing to tools and back to LLM, since <code>user_input</code> is cleared, the LLM uses only <code>messages</code> (history). The tail is often a <code>tool</code> response, enabling the model to continue reasoning based on tool outputs.</li>
</ul>
</li>
</ul>
<h4 id="atomic-updates-with-reducer-and-messageop">Atomic updates with Reducer and MessageOp</h4>
<p>The Graph package supports <code>MessageOp</code> patch operations (e.g., <code>ReplaceLastUser</code>,
<code>AppendMessages</code>) on message state via <code>MessageReducer</code> to achieve atomic merges. Benefits:</p>
<ul>
<li>Pre-LLM nodes can modify <code>user_input</code>. The LLM node returns a single state delta with the needed patch operations (replace last user message, append assistant message) for one-shot, race-free persistence.</li>
<li>Backwards compatible with appending <code>[]Message</code>, while providing more expressive updates for complex cases.</li>
</ul>
<p>Example: modify <code>user_input</code> in a pre-node before entering the LLM node.</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-14-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-14-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-14-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-14-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-14-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-14-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-14-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-14-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-14-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-14-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="nx">stateGraph</span><span class="p">.</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2"></a><span class="w">    </span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;prepare_input&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3"></a><span class="w">        </span><span class="nx">cleaned</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">strings</span><span class="p">.</span><span class="nx">TrimSpace</span><span class="p">(</span><span class="nx">s</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyUserInput</span><span class="p">].(</span><span class="kt">string</span><span class="p">))</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyUserInput</span><span class="p">:</span><span class="w"> </span><span class="nx">cleaned</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5"></a><span class="w">    </span><span class="p">}).</span>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6"></a><span class="w">    </span><span class="nx">AddLLMNode</span><span class="p">(</span><span class="s">&quot;ask&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">modelInstance</span><span class="p">,</span>
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7"></a><span class="w">        </span><span class="s">&quot;You are a helpful assistant. Answer concisely.&quot;</span><span class="p">,</span>
</span><span id="__span-14-8"><a id="__codelineno-14-8" name="__codelineno-14-8"></a><span class="w">        </span><span class="kc">nil</span><span class="p">).</span>
</span><span id="__span-14-9"><a id="__codelineno-14-9" name="__codelineno-14-9"></a><span class="w">    </span><span class="nx">SetEntryPoint</span><span class="p">(</span><span class="s">&quot;prepare_input&quot;</span><span class="p">).</span>
</span><span id="__span-14-10"><a id="__codelineno-14-10" name="__codelineno-14-10"></a><span class="w">    </span><span class="nx">SetFinishPoint</span><span class="p">(</span><span class="s">&quot;ask&quot;</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<h4 id="using-removeallmessages-to-clear-message-history">Using RemoveAllMessages to Clear Message History</h4>
<p>When chaining multiple LLM nodes, <code>MessageReducer</code> accumulates messages. If each
LLM node requires an isolated message context (without inheriting the previous
node's conversation history), use <code>RemoveAllMessages</code> to clear previous messages:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-15-1">1</a></span>
<span class="normal"><a href="#__codelineno-15-2">2</a></span>
<span class="normal"><a href="#__codelineno-15-3">3</a></span>
<span class="normal"><a href="#__codelineno-15-4">4</a></span>
<span class="normal"><a href="#__codelineno-15-5">5</a></span>
<span class="normal"><a href="#__codelineno-15-6">6</a></span>
<span class="normal"><a href="#__codelineno-15-7">7</a></span>
<span class="normal"><a href="#__codelineno-15-8">8</a></span>
<span class="normal"><a href="#__codelineno-15-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1"></a><span class="c1">// In the prompt preparation node, clear messages before setting new UserInput.</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2"></a><span class="kd">func</span><span class="w"> </span><span class="nx">preparePromptNode</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3"></a><span class="w">    </span><span class="nx">userMessage</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">buildUserMessage</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span>
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5"></a><span class="w">        </span><span class="c1">// Key: Clear previous messages first to avoid accumulation.</span>
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyMessages</span><span class="p">:</span><span class="w">  </span><span class="nx">graph</span><span class="p">.</span><span class="nx">RemoveAllMessages</span><span class="p">{},</span>
</span><span id="__span-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyUserInput</span><span class="p">:</span><span class="w"> </span><span class="nx">userMessage</span><span class="p">,</span>
</span><span id="__span-15-8"><a id="__codelineno-15-8" name="__codelineno-15-8"></a><span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-15-9"><a id="__codelineno-15-9" name="__codelineno-15-9"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p><strong>Use cases</strong>:</p>
<ul>
<li>Multiple independent LLM nodes within the same Graph, where each node doesn't
  need the previous node's conversation history</li>
<li>Loop structures where each iteration requires a fresh message context</li>
<li>Scenarios requiring complete message list reconstruction</li>
</ul>
<p><strong>Notes</strong>:</p>
<ul>
<li><code>RemoveAllMessages{}</code> is a special <code>MessageOp</code> that <code>MessageReducer</code> recognizes
  and uses to clear the message list</li>
<li>Must set <code>RemoveAllMessages{}</code> <strong>before</strong> setting <code>StateKeyUserInput</code></li>
<li><code>WithSubgraphIsolatedMessages(true)</code> only works for <code>AddSubgraphNode</code> (agent
  nodes), not for <code>AddLLMNode</code>; use <code>RemoveAllMessages</code> to isolate messages
  between LLM nodes</li>
<li>For agent nodes, <code>WithSubgraphIsolatedMessages(true)</code> disables seeding
  session history into the sub‑agent’s request. This also hides tool call
  results, so it breaks multi‑turn tool calling. Use it only for single‑turn
  sub‑agents; otherwise, isolate via sub‑agent message filtering (see “Agent
  nodes: isolation vs multi‑turn tool calls”).</li>
</ul>
<h3 id="3-graphagent-configuration-options">3. GraphAgent Configuration Options</h3>
<p>GraphAgent supports various configuration options:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-16-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-16-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-16-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-16-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-16-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-16-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-16-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-16-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-16-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-16-10">10</a></span>
<span class="normal"><a href="#__codelineno-16-11">11</a></span>
<span class="normal"><a href="#__codelineno-16-12">12</a></span>
<span class="normal"><a href="#__codelineno-16-13">13</a></span>
<span class="normal"><a href="#__codelineno-16-14">14</a></span>
<span class="normal"><a href="#__codelineno-16-15">15</a></span>
<span class="normal"><a href="#__codelineno-16-16">16</a></span>
<span class="normal"><a href="#__codelineno-16-17">17</a></span>
<span class="normal"><a href="#__codelineno-16-18">18</a></span>
<span class="normal"><a href="#__codelineno-16-19">19</a></span>
<span class="normal"><a href="#__codelineno-16-20">20</a></span>
<span class="normal"><a href="#__codelineno-16-21">21</a></span>
<span class="normal"><a href="#__codelineno-16-22">22</a></span>
<span class="normal"><a href="#__codelineno-16-23">23</a></span>
<span class="normal"><a href="#__codelineno-16-24">24</a></span>
<span class="normal"><a href="#__codelineno-16-25">25</a></span>
<span class="normal"><a href="#__codelineno-16-26">26</a></span>
<span class="normal"><a href="#__codelineno-16-27">27</a></span>
<span class="normal"><a href="#__codelineno-16-28">28</a></span>
<span class="normal"><a href="#__codelineno-16-29">29</a></span>
<span class="normal"><a href="#__codelineno-16-30">30</a></span>
<span class="normal"><a href="#__codelineno-16-31">31</a></span>
<span class="normal"><a href="#__codelineno-16-32">32</a></span>
<span class="normal"><a href="#__codelineno-16-33">33</a></span>
<span class="normal"><a href="#__codelineno-16-34">34</a></span>
<span class="normal"><a href="#__codelineno-16-35">35</a></span>
<span class="normal"><a href="#__codelineno-16-36">36</a></span>
<span class="normal"><a href="#__codelineno-16-37">37</a></span>
<span class="normal"><a href="#__codelineno-16-38">38</a></span>
<span class="normal"><a href="#__codelineno-16-39">39</a></span>
<span class="normal"><a href="#__codelineno-16-40">40</a></span>
<span class="normal"><a href="#__codelineno-16-41">41</a></span>
<span class="normal"><a href="#__codelineno-16-42">42</a></span>
<span class="normal"><a href="#__codelineno-16-43">43</a></span>
<span class="normal"><a href="#__codelineno-16-44">44</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1"></a><span class="c1">// Multiple options can be used when creating GraphAgent.</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2"></a><span class="nx">graphAgent</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3"></a><span class="w">    </span><span class="s">&quot;workflow-name&quot;</span><span class="p">,</span>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4"></a><span class="w">    </span><span class="nx">compiledGraph</span><span class="p">,</span>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithDescription</span><span class="p">(</span><span class="s">&quot;Workflow description&quot;</span><span class="p">),</span>
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithInitialState</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span>
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7"></a><span class="w">        </span><span class="s">&quot;initial_data&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Initial data&quot;</span><span class="p">,</span>
</span><span id="__span-16-8"><a id="__codelineno-16-8" name="__codelineno-16-8"></a><span class="w">    </span><span class="p">}),</span>
</span><span id="__span-16-9"><a id="__codelineno-16-9" name="__codelineno-16-9"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithChannelBufferSize</span><span class="p">(</span><span class="mi">1024</span><span class="p">),</span><span class="w">            </span><span class="c1">// Tune event buffer size</span>
</span><span id="__span-16-10"><a id="__codelineno-16-10" name="__codelineno-16-10"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithMaxConcurrency</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w">                 </span><span class="c1">// Cap parallel tasks</span>
</span><span id="__span-16-11"><a id="__codelineno-16-11" name="__codelineno-16-11"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithCheckpointSaver</span><span class="p">(</span><span class="nx">memorySaver</span><span class="p">),</span><span class="w">       </span><span class="c1">// Persist checkpoints if needed</span>
</span><span id="__span-16-12"><a id="__codelineno-16-12" name="__codelineno-16-12"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithSubAgents</span><span class="p">([]</span><span class="nx">agent</span><span class="p">.</span><span class="nx">Agent</span><span class="p">{</span><span class="nx">subAgent</span><span class="p">}),</span><span class="w"> </span><span class="c1">// Register sub-agents by name</span>
</span><span id="__span-16-13"><a id="__codelineno-16-13" name="__codelineno-16-13"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithAddSessionSummary</span><span class="p">(</span><span class="kc">true</span><span class="p">),</span><span class="w">            </span><span class="c1">// Inject session summary as system message</span>
</span><span id="__span-16-14"><a id="__codelineno-16-14" name="__codelineno-16-14"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithMaxHistoryRuns</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span><span class="w">                  </span><span class="c1">// Truncate history when summaries are off</span>
</span><span id="__span-16-15"><a id="__codelineno-16-15" name="__codelineno-16-15"></a><span class="w">    </span><span class="c1">// Set the filter mode for messages passed to the model. The final messages passed to the model must satisfy both WithMessageTimelineFilterMode and WithMessageBranchFilterMode conditions.</span>
</span><span id="__span-16-16"><a id="__codelineno-16-16" name="__codelineno-16-16"></a><span class="w">    </span><span class="c1">// Timeline dimension filter conditions</span>
</span><span id="__span-16-17"><a id="__codelineno-16-17" name="__codelineno-16-17"></a><span class="w">    </span><span class="c1">// Default: graphagent.TimelineFilterAll</span>
</span><span id="__span-16-18"><a id="__codelineno-16-18" name="__codelineno-16-18"></a><span class="w">    </span><span class="c1">// Optional values:</span>
</span><span id="__span-16-19"><a id="__codelineno-16-19" name="__codelineno-16-19"></a><span class="w">    </span><span class="c1">//  - graphagent.TimelineFilterAll: Includes historical messages as well as messages generated in the current request</span>
</span><span id="__span-16-20"><a id="__codelineno-16-20" name="__codelineno-16-20"></a><span class="w">    </span><span class="c1">//  - graphagent.TimelineFilterCurrentRequest: Only includes messages generated in the current request</span>
</span><span id="__span-16-21"><a id="__codelineno-16-21" name="__codelineno-16-21"></a><span class="w">    </span><span class="c1">//  - graphagent.TimelineFilterCurrentInvocation: Only includes messages generated in the current invocation context</span>
</span><span id="__span-16-22"><a id="__codelineno-16-22" name="__codelineno-16-22"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithMessageTimelineFilterMode</span><span class="p">(</span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">TimelineFilterAll</span><span class="p">),</span>
</span><span id="__span-16-23"><a id="__codelineno-16-23" name="__codelineno-16-23"></a>
</span><span id="__span-16-24"><a id="__codelineno-16-24" name="__codelineno-16-24"></a><span class="w">    </span><span class="c1">// Branch dimension filter conditions</span>
</span><span id="__span-16-25"><a id="__codelineno-16-25" name="__codelineno-16-25"></a><span class="w">    </span><span class="c1">// Default: graphagent.BranchFilterModePrefix</span>
</span><span id="__span-16-26"><a id="__codelineno-16-26" name="__codelineno-16-26"></a><span class="w">    </span><span class="c1">// Optional values:</span>
</span><span id="__span-16-27"><a id="__codelineno-16-27" name="__codelineno-16-27"></a><span class="w">    </span><span class="c1">//  - graphagent.BranchFilterModeAll: Includes messages from all agents. Use this when the current agent interacts with the model and needs to synchronize all valid content messages generated by all agents to the model.</span>
</span><span id="__span-16-28"><a id="__codelineno-16-28" name="__codelineno-16-28"></a><span class="w">    </span><span class="c1">//  - graphagent.BranchFilterModePrefix: Filters messages by prefix matching Event.FilterKey with Invocation.eventFilterKey. Use this when you want to pass messages generated by the current agent and related upstream/downstream agents to the model.</span>
</span><span id="__span-16-29"><a id="__codelineno-16-29" name="__codelineno-16-29"></a><span class="w">    </span><span class="c1">//  - graphagent.BranchFilterModeExact: Filters messages where Event.FilterKey == Invocation.eventFilterKey. Use this when the current agent interacts with the model and only needs to use messages generated by the current agent.</span>
</span><span id="__span-16-30"><a id="__codelineno-16-30" name="__codelineno-16-30"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithMessageBranchFilterMode</span><span class="p">(</span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">BranchFilterModeAll</span><span class="p">),</span>
</span><span id="__span-16-31"><a id="__codelineno-16-31" name="__codelineno-16-31"></a><span class="w">    </span><span class="c1">// Reasoning content mode (for DeepSeek thinking mode)</span>
</span><span id="__span-16-32"><a id="__codelineno-16-32" name="__codelineno-16-32"></a><span class="w">    </span><span class="c1">// Default: graphagent.ReasoningContentModeDiscardPreviousTurns</span>
</span><span id="__span-16-33"><a id="__codelineno-16-33" name="__codelineno-16-33"></a><span class="w">    </span><span class="c1">// Options:</span>
</span><span id="__span-16-34"><a id="__codelineno-16-34" name="__codelineno-16-34"></a><span class="w">    </span><span class="c1">//  - graphagent.ReasoningContentModeDiscardPreviousTurns: Discard reasoning_content</span>
</span><span id="__span-16-35"><a id="__codelineno-16-35" name="__codelineno-16-35"></a><span class="w">    </span><span class="c1">//    from previous request turns (default, recommended).</span>
</span><span id="__span-16-36"><a id="__codelineno-16-36" name="__codelineno-16-36"></a><span class="w">    </span><span class="c1">//  - graphagent.ReasoningContentModeKeepAll: Keep all reasoning_content in history.</span>
</span><span id="__span-16-37"><a id="__codelineno-16-37" name="__codelineno-16-37"></a><span class="w">    </span><span class="c1">//  - graphagent.ReasoningContentModeDiscardAll: Discard all reasoning_content.</span>
</span><span id="__span-16-38"><a id="__codelineno-16-38" name="__codelineno-16-38"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithReasoningContentMode</span><span class="p">(</span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">ReasoningContentModeDiscardPreviousTurns</span><span class="p">),</span>
</span><span id="__span-16-39"><a id="__codelineno-16-39" name="__codelineno-16-39"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithAgentCallbacks</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">agent</span><span class="p">.</span><span class="nx">Callbacks</span><span class="p">{</span>
</span><span id="__span-16-40"><a id="__codelineno-16-40" name="__codelineno-16-40"></a><span class="w">        </span><span class="c1">// Agent-level callbacks.</span>
</span><span id="__span-16-41"><a id="__codelineno-16-41" name="__codelineno-16-41"></a><span class="w">    </span><span class="p">}),</span>
</span><span id="__span-16-42"><a id="__codelineno-16-42" name="__codelineno-16-42"></a><span class="w">    </span><span class="c1">// Executor advanced configuration options, see &quot;Executor Advanced Configuration&quot; section below</span>
</span><span id="__span-16-43"><a id="__codelineno-16-43" name="__codelineno-16-43"></a><span class="w">    </span><span class="c1">// graphagent.WithExecutorOptions(...),</span>
</span><span id="__span-16-44"><a id="__codelineno-16-44" name="__codelineno-16-44"></a><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<blockquote>
<p>Model/tool callbacks are configured per node, e.g. <code>AddLLMNode(..., graph.WithModelCallbacks(...))</code>
or <code>AddToolsNode(..., graph.WithToolCallbacks(...))</code>.</p>
<p><strong>Callback Precedence</strong>: When both node-level and state-level callbacks are present:
- Node-configured callbacks (via <code>WithModelCallbacks</code>/<code>WithToolCallbacks</code>) take precedence.
- State-level callbacks (via <code>StateKeyModelCallbacks</code>/<code>StateKeyToolCallbacks</code>) are used as a fallback.
This allows graph-level configuration to override runtime state when needed.</p>
</blockquote>
<p>Session summary notes:</p>
<ul>
<li><code>WithAddSessionSummary(true)</code> takes effect only when <code>Session.Summaries</code> contains a summary for the invocation’s filter key. Summaries are typically produced by SessionService + SessionSummarizer, and Runner will auto‑enqueue summarization after persisting events.</li>
<li>GraphAgent reads summaries only; it does not generate them. If you bypass Runner, call <code>sessionService.CreateSessionSummary</code> or <code>EnqueueSummaryJob</code> after appending events.</li>
<li>Summary injection works only when <code>TimelineFilterMode</code> is <code>TimelineFilterAll</code>.</li>
</ul>
<h4 id="summary-format-customization">Summary Format Customization</h4>
<p>By default, session summaries are formatted with context tags and a note about preferring current conversation information. You can customize the summary format using <code>WithSummaryFormatter</code> to better match your specific use cases or model requirements.</p>
<p><strong>Default Format:</strong></p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-17-1">1</a></span>
<span class="normal"><a href="#__codelineno-17-2">2</a></span>
<span class="normal"><a href="#__codelineno-17-3">3</a></span>
<span class="normal"><a href="#__codelineno-17-4">4</a></span>
<span class="normal"><a href="#__codelineno-17-5">5</a></span>
<span class="normal"><a href="#__codelineno-17-6">6</a></span>
<span class="normal"><a href="#__codelineno-17-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1"></a>Here is a brief summary of your previous interactions:
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2"></a>
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3"></a>&lt;summary_of_previous_interactions&gt;
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4"></a>[summary content]
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5"></a>&lt;/summary_of_previous_interactions&gt;
</span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6"></a>
</span><span id="__span-17-7"><a id="__codelineno-17-7" name="__codelineno-17-7"></a>Note: this information is from previous interactions and may be outdated. You should ALWAYS prefer information from this conversation over the past summary.
</span></code></pre></div></td></tr></table></div>
<p><strong>Custom Format Example:</strong></p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-18-1">1</a></span>
<span class="normal"><a href="#__codelineno-18-2">2</a></span>
<span class="normal"><a href="#__codelineno-18-3">3</a></span>
<span class="normal"><a href="#__codelineno-18-4">4</a></span>
<span class="normal"><a href="#__codelineno-18-5">5</a></span>
<span class="normal"><a href="#__codelineno-18-6">6</a></span>
<span class="normal"><a href="#__codelineno-18-7">7</a></span>
<span class="normal"><a href="#__codelineno-18-8">8</a></span>
<span class="normal"><a href="#__codelineno-18-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1"></a><span class="c1">// Custom formatter with simplified format</span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2"></a><span class="nx">ga</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span>
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3"></a><span class="w">    </span><span class="s">&quot;my-graph&quot;</span><span class="p">,</span>
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithInitialState</span><span class="p">(</span><span class="nx">initialState</span><span class="p">),</span>
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithAddSessionSummary</span><span class="p">(</span><span class="kc">true</span><span class="p">),</span>
</span><span id="__span-18-6"><a id="__codelineno-18-6" name="__codelineno-18-6"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithSummaryFormatter</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">summary</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-18-7"><a id="__codelineno-18-7" name="__codelineno-18-7"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;## Previous Context\n\n%s&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">summary</span><span class="p">)</span>
</span><span id="__span-18-8"><a id="__codelineno-18-8" name="__codelineno-18-8"></a><span class="w">    </span><span class="p">}),</span>
</span><span id="__span-18-9"><a id="__codelineno-18-9" name="__codelineno-18-9"></a><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p><strong>Use Cases:</strong></p>
<ul>
<li><strong>Simplified Format</strong>: Reduce token usage by using concise headings and minimal context notes</li>
<li><strong>Language Localization</strong>: Translate context notes to target language (e.g., Chinese, Japanese)</li>
<li><strong>Role-Specific Formatting</strong>: Different formats for different agent roles</li>
<li><strong>Model Optimization</strong>: Tailor format for specific model preferences</li>
</ul>
<p><strong>Important Notes:</strong></p>
<ul>
<li>The formatter function receives raw summary text from the session and returns the formatted string</li>
<li>Custom formatters should ensure that the summary is clearly distinguishable from other messages</li>
<li>The default format is designed to be compatible with most models and use cases</li>
<li>When <code>WithAddSessionSummary(false)</code> is used, the formatter is never invoked</li>
</ul>
<h4 id="executor-advanced-configuration">Executor Advanced Configuration</h4>
<p><code>WithExecutorOptions</code> allows you to pass executor options directly to configure the behavior of the underlying executor. This is useful for scenarios that require fine-grained control over executor behavior, such as:</p>
<ul>
<li><strong>Timeout Control</strong>: Set appropriate timeout durations for long-running nodes (e.g., agent tool nodes)</li>
<li><strong>Step Limits</strong>: Limit the maximum number of steps in graph execution to prevent infinite loops</li>
<li><strong>Retry Policies</strong>: Configure default retry policies</li>
</ul>
<p><strong>Usage Example:</strong></p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-19-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-19-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-19-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-19-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-19-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-19-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-19-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-19-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-19-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-19-10">10</a></span>
<span class="normal"><a href="#__codelineno-19-11">11</a></span>
<span class="normal"><a href="#__codelineno-19-12">12</a></span>
<span class="normal"><a href="#__codelineno-19-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1"></a><span class="nx">graphAgent</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;my-agent&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">compiledGraph</span><span class="p">,</span>
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithDescription</span><span class="p">(</span><span class="s">&quot;Workflow description&quot;</span><span class="p">),</span>
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3"></a><span class="w">    </span><span class="c1">// Pass executor options directly</span>
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithExecutorOptions</span><span class="p">(</span>
</span><span id="__span-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithMaxSteps</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span><span class="w">                          </span><span class="c1">// max steps limit</span>
</span><span id="__span-19-6"><a id="__codelineno-19-6" name="__codelineno-19-6"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithStepTimeout</span><span class="p">(</span><span class="mi">5</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span><span class="p">),</span><span class="w">            </span><span class="c1">// timeout per step</span>
</span><span id="__span-19-7"><a id="__codelineno-19-7" name="__codelineno-19-7"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithNodeTimeout</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span><span class="p">),</span><span class="w">            </span><span class="c1">// timeout per node</span>
</span><span id="__span-19-8"><a id="__codelineno-19-8" name="__codelineno-19-8"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithCheckpointSaveTimeout</span><span class="p">(</span><span class="mi">30</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">),</span><span class="w"> </span><span class="c1">// checkpoint save timeout</span>
</span><span id="__span-19-9"><a id="__codelineno-19-9" name="__codelineno-19-9"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithDefaultRetryPolicy</span><span class="p">(</span><span class="w">                    </span><span class="c1">// default retry policy</span>
</span><span id="__span-19-10"><a id="__codelineno-19-10" name="__codelineno-19-10"></a><span class="w">            </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithSimpleRetry</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
</span><span id="__span-19-11"><a id="__codelineno-19-11" name="__codelineno-19-11"></a><span class="w">        </span><span class="p">),</span>
</span><span id="__span-19-12"><a id="__codelineno-19-12" name="__codelineno-19-12"></a><span class="w">    </span><span class="p">),</span>
</span><span id="__span-19-13"><a id="__codelineno-19-13" name="__codelineno-19-13"></a><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p><strong>Notes:</strong></p>
<ul>
<li>Options passed via <code>WithExecutorOptions</code> are applied after mapped options (<code>ChannelBufferSize</code>, <code>MaxConcurrency</code>, <code>CheckpointSaver</code>), so they can override those settings if needed</li>
<li>If <code>WithStepTimeout</code> is not set, <code>WithNodeTimeout</code> will not be automatically derived (defaults to no timeout)</li>
</ul>
<h4 id="concurrency-considerations">Concurrency considerations</h4>
<p>When using Graph + GraphAgent in a concurrent environment (for example, serving many requests from a single long‑lived process), keep the following in mind:</p>
<ul>
<li>CheckpointSaver and Cache implementations must be concurrency‑safe<br />
  The <code>CheckpointSaver</code> and <code>Cache</code> interfaces are intentionally storage‑agnostic. A single <code>Executor</code>/<code>GraphAgent</code> instance may call their methods from multiple goroutines when several invocations run in parallel. If you provide your own implementations, ensure:<ul>
<li>All exported methods (<code>Get</code>/<code>GetTuple</code>/<code>List</code>/<code>Put</code>/<code>PutWrites</code>/<code>PutFull</code>/<code>DeleteLineage</code> for <code>CheckpointSaver</code>, and <code>Get</code>/<code>Set</code>/<code>Clear</code> for <code>Cache</code>) are safe for concurrent use.</li>
<li>Internal maps, connection pools, or in‑memory buffers are properly synchronized.</li>
</ul>
</li>
</ul>
<ul>
<li>NodeFunc, tools, and callbacks should treat state as per‑invocation, not global<br />
  Each node receives an isolated copy of graph state for the current task. This copy is safe to mutate inside the node, but it is not safe to:<ul>
<li>Store references to that state (or its internal maps/slices) in global variables and modify them from other goroutines later.</li>
<li>Access <code>StateKeyExecContext</code> (<code>*graph.ExecutionContext</code>) and bypass its internal locks when reading/writing <code>execCtx.State</code> or <code>execCtx.pendingTasks</code>.
If you need shared mutable state across nodes or invocations, protect it with your own synchronization (for example, <code>sync.Mutex</code> or <code>sync.RWMutex</code>) or use external services (such as databases or caches).</li>
</ul>
</li>
</ul>
<ul>
<li>Do not share a single *agent.Invocation across goroutines<br />
  The framework expects each <code>Run</code> call (GraphAgent, Runner, or other Agent types) to operate on its own <code>*agent.Invocation</code>. Reusing the same <code>*agent.Invocation</code> instance in multiple goroutines and calling <code>Run</code> concurrently can cause data races on fields like <code>Branch</code>, <code>RunOptions</code>, or callback state. Prefer:<ul>
<li>Creating a fresh <code>*agent.Invocation</code> per request, or</li>
<li>Cloning from a parent invocation using <code>invocation.Clone(...)</code> when you need linkage.</li>
</ul>
</li>
</ul>
<ul>
<li>Parallel tools require tool implementations to be safe for concurrent use<br />
  Tools in a <code>Tools</code> node can be executed in parallel when <code>WithEnableParallelTools(true)</code> is used on that node:<ul>
<li>The framework guarantees that the <code>tools</code> map is only read during execution.</li>
<li>It also guarantees that the shared graph state passed to tools is only read; updates are written back by nodes, not by tools.
However, each <code>tool.Tool</code> implementation and its <code>tool.Callbacks</code> may be invoked from multiple goroutines at the same time. Make sure:</li>
<li>Tool implementations do not mutate shared global state without proper locking.</li>
<li>Any internal caches, HTTP clients, or client pools inside tools are safe for concurrent use.</li>
</ul>
</li>
</ul>
<p>These constraints are especially important in long‑running services where a single <code>Graph</code>/<code>Executor</code>/<code>GraphAgent</code> instance is reused for many invocations.</p>
<p>Once sub-agents are registered you can delegate within the graph via agent nodes:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-20-1">1</a></span>
<span class="normal"><a href="#__codelineno-20-2">2</a></span>
<span class="normal"><a href="#__codelineno-20-3">3</a></span>
<span class="normal"><a href="#__codelineno-20-4">4</a></span>
<span class="normal"><a href="#__codelineno-20-5">5</a></span>
<span class="normal"><a href="#__codelineno-20-6">6</a></span>
<span class="normal"><a href="#__codelineno-20-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1"></a><span class="c1">// Assume subAgent.Info().Name == &quot;assistant&quot;</span>
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2"></a><span class="nx">stateGraph</span><span class="p">.</span><span class="nx">AddAgentNode</span><span class="p">(</span><span class="s">&quot;assistant&quot;</span><span class="p">,</span>
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithName</span><span class="p">(</span><span class="s">&quot;Delegate to assistant agent&quot;</span><span class="p">),</span>
</span><span id="__span-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithDescription</span><span class="p">(</span><span class="s">&quot;Invoke the pre-registered assistant agent&quot;</span><span class="p">),</span>
</span><span id="__span-20-5"><a id="__codelineno-20-5" name="__codelineno-20-5"></a><span class="p">)</span>
</span><span id="__span-20-6"><a id="__codelineno-20-6" name="__codelineno-20-6"></a>
</span><span id="__span-20-7"><a id="__codelineno-20-7" name="__codelineno-20-7"></a><span class="c1">// During execution the GraphAgent looks up a sub-agent with the same name and runs it</span>
</span></code></pre></div></td></tr></table></div>
<blockquote>
<p>The agent node uses its ID for the lookup, so keep <code>AddAgentNode("assistant")</code>
aligned with <code>subAgent.Info().Name == "assistant"</code>.</p>
</blockquote>
<h4 id="agent-nodes-passing-data-to-the-next-agent">Agent nodes: passing data to the next agent</h4>
<p>An agent node does not automatically "pipe" its output into the next agent
node. Edges only control execution order; data flows through graph state.</p>
<p>By default, an agent node builds the child invocation message from
<code>state[graph.StateKeyUserInput]</code>. But <code>user_input</code> is <strong>one‑shot</strong>:
LLM/Agent nodes clear it after a successful run to avoid reusing the same input.
This is why a chain like <code>A (agent) → B (agent)</code> often looks like "A produced
output, but B got an empty input".</p>
<p>To make downstream agent nodes consume upstream outputs, explicitly map a state
field into <code>user_input</code> before the downstream agent runs:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-21-1">1</a></span>
<span class="normal"><a href="#__codelineno-21-2">2</a></span>
<span class="normal"><a href="#__codelineno-21-3">3</a></span>
<span class="normal"><a href="#__codelineno-21-4">4</a></span>
<span class="normal"><a href="#__codelineno-21-5">5</a></span>
<span class="normal"><a href="#__codelineno-21-6">6</a></span>
<span class="normal"><a href="#__codelineno-21-7">7</a></span>
<span class="normal"><a href="#__codelineno-21-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2"></a><span class="w">    </span><span class="nx">nodeA</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;a&quot;</span>
</span><span id="__span-21-3"><a id="__codelineno-21-3" name="__codelineno-21-3"></a><span class="w">    </span><span class="nx">nodeB</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;b&quot;</span>
</span><span id="__span-21-4"><a id="__codelineno-21-4" name="__codelineno-21-4"></a><span class="p">)</span>
</span><span id="__span-21-5"><a id="__codelineno-21-5" name="__codelineno-21-5"></a>
</span><span id="__span-21-6"><a id="__codelineno-21-6" name="__codelineno-21-6"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddAgentNode</span><span class="p">(</span><span class="nx">nodeA</span><span class="p">)</span>
</span><span id="__span-21-7"><a id="__codelineno-21-7" name="__codelineno-21-7"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddAgentNode</span><span class="p">(</span><span class="nx">nodeB</span><span class="p">,</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithSubgraphInputFromLastResponse</span><span class="p">())</span>
</span><span id="__span-21-8"><a id="__codelineno-21-8" name="__codelineno-21-8"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddEdge</span><span class="p">(</span><span class="nx">nodeA</span><span class="p">,</span><span class="w"> </span><span class="nx">nodeB</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>Notes:</p>
<ul>
<li><code>WithSubgraphInputFromLastResponse()</code> maps the <strong>current</strong> <code>last_response</code>
  into this agent node's <code>user_input</code> for this run, so <code>nodeB</code> consumes <code>nodeA</code>
  as input.</li>
<li>If you need to pass a <em>specific</em> node's output (not the most recent), use a
  pre‑node callback and read from <code>node_responses[targetNodeID]</code>, then write it
  into <code>user_input</code>.</li>
</ul>
<h4 id="agent-nodes-combining-original-input-with-upstream-output">Agent nodes: combining original input with upstream output</h4>
<p>Sometimes the downstream agent needs <strong>both</strong>:</p>
<ul>
<li>The upstream agent result (often <code>state[graph.StateKeyLastResponse]</code>), and</li>
<li>The original user request for this run.</li>
</ul>
<p>Because <code>user_input</code> is one‑shot and is cleared after LLM/Agent nodes, you
should <strong>persist</strong> the original user input under your own state key, then
compose the downstream <code>user_input</code> explicitly.</p>
<p>The simplest pattern is to add two function nodes:</p>
<ol>
<li>Capture the initial <code>user_input</code> once.</li>
<li>Build the next <code>user_input</code> from <code>original_user_input + last_response</code>.</li>
</ol>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-22-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-22-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-22-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-22-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-22-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-22-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-22-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-22-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-22-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-22-10">10</a></span>
<span class="normal"><a href="#__codelineno-22-11">11</a></span>
<span class="normal"><a href="#__codelineno-22-12">12</a></span>
<span class="normal"><a href="#__codelineno-22-13">13</a></span>
<span class="normal"><a href="#__codelineno-22-14">14</a></span>
<span class="normal"><a href="#__codelineno-22-15">15</a></span>
<span class="normal"><a href="#__codelineno-22-16">16</a></span>
<span class="normal"><a href="#__codelineno-22-17">17</a></span>
<span class="normal"><a href="#__codelineno-22-18">18</a></span>
<span class="normal"><a href="#__codelineno-22-19">19</a></span>
<span class="normal"><a href="#__codelineno-22-20">20</a></span>
<span class="normal"><a href="#__codelineno-22-21">21</a></span>
<span class="normal"><a href="#__codelineno-22-22">22</a></span>
<span class="normal"><a href="#__codelineno-22-23">23</a></span>
<span class="normal"><a href="#__codelineno-22-24">24</a></span>
<span class="normal"><a href="#__codelineno-22-25">25</a></span>
<span class="normal"><a href="#__codelineno-22-26">26</a></span>
<span class="normal"><a href="#__codelineno-22-27">27</a></span>
<span class="normal"><a href="#__codelineno-22-28">28</a></span>
<span class="normal"><a href="#__codelineno-22-29">29</a></span>
<span class="normal"><a href="#__codelineno-22-30">30</a></span>
<span class="normal"><a href="#__codelineno-22-31">31</a></span>
<span class="normal"><a href="#__codelineno-22-32">32</a></span>
<span class="normal"><a href="#__codelineno-22-33">33</a></span>
<span class="normal"><a href="#__codelineno-22-34">34</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2"></a><span class="w">    </span><span class="nx">keyOriginalUserInput</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;original_user_input&quot;</span>
</span><span id="__span-22-3"><a id="__codelineno-22-3" name="__codelineno-22-3"></a>
</span><span id="__span-22-4"><a id="__codelineno-22-4" name="__codelineno-22-4"></a><span class="w">    </span><span class="nx">nodeSaveInput</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;save_input&quot;</span>
</span><span id="__span-22-5"><a id="__codelineno-22-5" name="__codelineno-22-5"></a><span class="w">    </span><span class="nx">nodeA</span><span class="w">         </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;a&quot;</span>
</span><span id="__span-22-6"><a id="__codelineno-22-6" name="__codelineno-22-6"></a><span class="w">    </span><span class="nx">nodeCompose</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;compose_input&quot;</span>
</span><span id="__span-22-7"><a id="__codelineno-22-7" name="__codelineno-22-7"></a><span class="w">    </span><span class="nx">nodeB</span><span class="w">         </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;b&quot;</span>
</span><span id="__span-22-8"><a id="__codelineno-22-8" name="__codelineno-22-8"></a><span class="p">)</span>
</span><span id="__span-22-9"><a id="__codelineno-22-9" name="__codelineno-22-9"></a>
</span><span id="__span-22-10"><a id="__codelineno-22-10" name="__codelineno-22-10"></a><span class="kd">func</span><span class="w"> </span><span class="nx">saveOriginalInput</span><span class="p">(</span><span class="nx">_</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-22-11"><a id="__codelineno-22-11" name="__codelineno-22-11"></a><span class="w">    </span><span class="nx">input</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">s</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyUserInput</span><span class="p">].(</span><span class="kt">string</span><span class="p">)</span>
</span><span id="__span-22-12"><a id="__codelineno-22-12" name="__codelineno-22-12"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">input</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-22-13"><a id="__codelineno-22-13" name="__codelineno-22-13"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-22-14"><a id="__codelineno-22-14" name="__codelineno-22-14"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-22-15"><a id="__codelineno-22-15" name="__codelineno-22-15"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="nx">keyOriginalUserInput</span><span class="p">:</span><span class="w"> </span><span class="nx">input</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-22-16"><a id="__codelineno-22-16" name="__codelineno-22-16"></a><span class="p">}</span>
</span><span id="__span-22-17"><a id="__codelineno-22-17" name="__codelineno-22-17"></a>
</span><span id="__span-22-18"><a id="__codelineno-22-18" name="__codelineno-22-18"></a><span class="kd">func</span><span class="w"> </span><span class="nx">composeNextInput</span><span class="p">(</span><span class="nx">_</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-22-19"><a id="__codelineno-22-19" name="__codelineno-22-19"></a><span class="w">    </span><span class="nx">orig</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">s</span><span class="p">[</span><span class="nx">keyOriginalUserInput</span><span class="p">].(</span><span class="kt">string</span><span class="p">)</span>
</span><span id="__span-22-20"><a id="__codelineno-22-20" name="__codelineno-22-20"></a><span class="w">    </span><span class="nx">last</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">s</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyLastResponse</span><span class="p">].(</span><span class="kt">string</span><span class="p">)</span>
</span><span id="__span-22-21"><a id="__codelineno-22-21" name="__codelineno-22-21"></a>
</span><span id="__span-22-22"><a id="__codelineno-22-22" name="__codelineno-22-22"></a><span class="w">    </span><span class="c1">// This becomes nodeB&#39;s Invocation.Message.Content.</span>
</span><span id="__span-22-23"><a id="__codelineno-22-23" name="__codelineno-22-23"></a><span class="w">    </span><span class="nx">combined</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">orig</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;\n\n&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">last</span>
</span><span id="__span-22-24"><a id="__codelineno-22-24" name="__codelineno-22-24"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyUserInput</span><span class="p">:</span><span class="w"> </span><span class="nx">combined</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-22-25"><a id="__codelineno-22-25" name="__codelineno-22-25"></a><span class="p">}</span>
</span><span id="__span-22-26"><a id="__codelineno-22-26" name="__codelineno-22-26"></a>
</span><span id="__span-22-27"><a id="__codelineno-22-27" name="__codelineno-22-27"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="nx">nodeSaveInput</span><span class="p">,</span><span class="w"> </span><span class="nx">saveOriginalInput</span><span class="p">)</span>
</span><span id="__span-22-28"><a id="__codelineno-22-28" name="__codelineno-22-28"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddAgentNode</span><span class="p">(</span><span class="nx">nodeA</span><span class="p">)</span>
</span><span id="__span-22-29"><a id="__codelineno-22-29" name="__codelineno-22-29"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="nx">nodeCompose</span><span class="p">,</span><span class="w"> </span><span class="nx">composeNextInput</span><span class="p">)</span>
</span><span id="__span-22-30"><a id="__codelineno-22-30" name="__codelineno-22-30"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddAgentNode</span><span class="p">(</span><span class="nx">nodeB</span><span class="p">)</span>
</span><span id="__span-22-31"><a id="__codelineno-22-31" name="__codelineno-22-31"></a>
</span><span id="__span-22-32"><a id="__codelineno-22-32" name="__codelineno-22-32"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddEdge</span><span class="p">(</span><span class="nx">nodeSaveInput</span><span class="p">,</span><span class="w"> </span><span class="nx">nodeA</span><span class="p">)</span>
</span><span id="__span-22-33"><a id="__codelineno-22-33" name="__codelineno-22-33"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddEdge</span><span class="p">(</span><span class="nx">nodeA</span><span class="p">,</span><span class="w"> </span><span class="nx">nodeCompose</span><span class="p">)</span>
</span><span id="__span-22-34"><a id="__codelineno-22-34" name="__codelineno-22-34"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddEdge</span><span class="p">(</span><span class="nx">nodeCompose</span><span class="p">,</span><span class="w"> </span><span class="nx">nodeB</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>Important:</p>
<ul>
<li>Treat <code>graph.State</code> passed into function nodes as read‑only.</li>
<li>Return a <strong>delta</strong> state update (a small <code>graph.State</code>) instead of returning
  or mutating the full state. Returning full state can accidentally overwrite
  internal keys (execution context, callbacks, session) and break the workflow.</li>
</ul>
<h4 id="agent-nodes-state-mappers-advanced">Agent nodes: state mappers (advanced)</h4>
<p>Agent nodes support two mappers to control what data crosses the parent/child
boundary:</p>
<ul>
<li><code>WithSubgraphInputMapper</code>: project parent state → child runtime state
  (<code>Invocation.RunOptions.RuntimeState</code>).</li>
<li><code>WithSubgraphOutputMapper</code>: project child results → parent state updates.</li>
</ul>
<p>Use cases:</p>
<ul>
<li><strong>Let the child read structured data from state</strong> (without stuffing it into
  prompts): pass only selected keys to the child via <code>WithSubgraphInputMapper</code>.
  Runnable example: <code>examples/graph/subagent_runtime_state</code>.</li>
<li><strong>Copy structured outputs back to the parent graph</strong>: when the child is a
  GraphAgent, <code>SubgraphResult.FinalState</code> contains the child's final state
  snapshot and can be mapped into parent keys. Runnable example:
  <code>examples/graph/agent_state_handoff</code>.</li>
<li><strong>Store the child LLM's final text under your own keys</strong>: <code>SubgraphResult</code>
  always includes <code>LastResponse</code>, so output mappers work for both GraphAgent and
  non-graph agents.</li>
</ul>
<h4 id="agent-nodes-isolation-vs-multiturn-tool-calls">Agent nodes: isolation vs multi‑turn tool calls</h4>
<p>Tool calling is usually multi‑turn within a single run: the model returns a
tool call, the framework executes the tool, then the next model request must
include the tool result (a <code>role=tool</code> message) so the model can continue.</p>
<p><code>WithSubgraphIsolatedMessages(true)</code> is a <strong>strong isolation switch</strong>: it
prevents the sub‑agent from reading any session history when building the next
model request (internally it sets <code>include_contents="none"</code> for the sub‑agent).
This makes the sub‑agent “black‑box” (it only sees the current <code>user_input</code>),
but it also means the sub‑agent will not see tool results, so it cannot do
multi‑turn tool calling.</p>
<p>If a sub‑agent needs tools <strong>and</strong> needs to continue after tools return:</p>
<ul>
<li>Do <strong>not</strong> enable <code>WithSubgraphIsolatedMessages(true)</code> on that agent node.</li>
<li>Instead, keep session seeding enabled and isolate the sub‑agent by filtering
  its message history to only its own invocation. For <code>LLMAgent</code>, use:
  <code>llmagent.WithMessageFilterMode(llmagent.IsolatedInvocation)</code>.</li>
</ul>
<p>Symptoms of the misconfiguration:</p>
<ul>
<li>The second model request looks the same as the first one (tool results never
  appear in the prompt).</li>
<li>The agent repeats the first tool call or loops because it never “sees” the
  tool output.</li>
</ul>
<h4 id="agent-nodes-checkpoints-and-nested-interrupts">Agent nodes: checkpoints and nested interrupts</h4>
<p>If a sub-agent is a GraphAgent (a graph-based agent) and checkpointing is
enabled (via a <code>CheckpointSaver</code>), the child graph also needs its own checkpoint
namespace. Otherwise, the child graph can accidentally resume from a checkpoint
that belongs to the parent graph.</p>
<p>Default behavior for agent nodes that invoke a GraphAgent:</p>
<ul>
<li>The child GraphAgent runs under the child checkpoint namespace (the sub-agent
  name), even though the runtime state is cloned from the parent.</li>
<li>The parent checkpoint identifier (ID) is not forwarded to the child unless
  you explicitly set it via a subgraph input mapper.</li>
</ul>
<p>Nested Human-in-the-Loop (HITL) interrupt/resume:</p>
<ul>
<li>If the child GraphAgent calls <code>graph.Interrupt</code>, the parent graph also
  interrupts and checkpoints.</li>
<li>Resume from the parent checkpoint as usual; the agent node resumes the child
  checkpoint automatically.</li>
</ul>
<p>Runnable example: <code>examples/graph/nested_interrupt</code>.</p>
<h3 id="4-conditional-routing">4. Conditional Routing</h3>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-23-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-23-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-23-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-23-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-23-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-23-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-23-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-23-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-23-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-23-10">10</a></span>
<span class="normal"><a href="#__codelineno-23-11">11</a></span>
<span class="normal"><a href="#__codelineno-23-12">12</a></span>
<span class="normal"><a href="#__codelineno-23-13">13</a></span>
<span class="normal"><a href="#__codelineno-23-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1"></a><span class="c1">// Define condition function.</span>
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2"></a><span class="kd">func</span><span class="w"> </span><span class="nx">complexityCondition</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3"></a><span class="w">    </span><span class="nx">complexity</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">state</span><span class="p">[</span><span class="s">&quot;complexity&quot;</span><span class="p">].(</span><span class="kt">string</span><span class="p">)</span>
</span><span id="__span-23-4"><a id="__codelineno-23-4" name="__codelineno-23-4"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">complexity</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;simple&quot;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-5"><a id="__codelineno-23-5" name="__codelineno-23-5"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;simple_process&quot;</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-23-6"><a id="__codelineno-23-6" name="__codelineno-23-6"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-23-7"><a id="__codelineno-23-7" name="__codelineno-23-7"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;complex_process&quot;</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-23-8"><a id="__codelineno-23-8" name="__codelineno-23-8"></a><span class="p">}</span>
</span><span id="__span-23-9"><a id="__codelineno-23-9" name="__codelineno-23-9"></a>
</span><span id="__span-23-10"><a id="__codelineno-23-10" name="__codelineno-23-10"></a><span class="c1">// Add conditional edges.</span>
</span><span id="__span-23-11"><a id="__codelineno-23-11" name="__codelineno-23-11"></a><span class="nx">stateGraph</span><span class="p">.</span><span class="nx">AddConditionalEdges</span><span class="p">(</span><span class="s">&quot;analyze&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">complexityCondition</span><span class="p">,</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span>
</span><span id="__span-23-12"><a id="__codelineno-23-12" name="__codelineno-23-12"></a><span class="w">    </span><span class="s">&quot;simple_process&quot;</span><span class="p">:</span><span class="w">  </span><span class="s">&quot;simple_node&quot;</span><span class="p">,</span>
</span><span id="__span-23-13"><a id="__codelineno-23-13" name="__codelineno-23-13"></a><span class="w">    </span><span class="s">&quot;complex_process&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;complex_node&quot;</span><span class="p">,</span>
</span><span id="__span-23-14"><a id="__codelineno-23-14" name="__codelineno-23-14"></a><span class="p">})</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="41-named-ends-pernode-ends">4.1 Named Ends (Per‑node Ends)</h3>
<p>When a node produces business outcomes (e.g., <code>approve</code>/<code>reject</code>/<code>manual_review</code>) and you want to route by those semantic labels, declare node‑local Named Ends (Ends).</p>
<p>Why this helps:</p>
<ul>
<li>Central, declarative mapping from labels to concrete targets at the node site.</li>
<li>Compile‑time validation: <code>Compile()</code> verifies every end target exists (or is the special <code>graph.End</code>).</li>
<li>Unified routing: reused by both <code>Command.GoTo</code> and conditional edges.</li>
<li>Decoupling: nodes express outcomes in business terms; the mapping ties outcomes to graph structure.</li>
</ul>
<p>API:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-24-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-24-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-24-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-24-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-24-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-24-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-24-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-24-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-24-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-24-10">10</a></span>
<span class="normal"><a href="#__codelineno-24-11">11</a></span>
<span class="normal"><a href="#__codelineno-24-12">12</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1"></a><span class="c1">// Declare Ends on a node (label -&gt; concrete target)</span>
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;decision&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">decideNode</span><span class="p">,</span>
</span><span id="__span-24-3"><a id="__codelineno-24-3" name="__codelineno-24-3"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithEndsMap</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span>
</span><span id="__span-24-4"><a id="__codelineno-24-4" name="__codelineno-24-4"></a><span class="w">        </span><span class="s">&quot;approve&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;approved&quot;</span><span class="p">,</span>
</span><span id="__span-24-5"><a id="__codelineno-24-5" name="__codelineno-24-5"></a><span class="w">        </span><span class="s">&quot;reject&quot;</span><span class="p">:</span><span class="w">  </span><span class="s">&quot;rejected&quot;</span><span class="p">,</span>
</span><span id="__span-24-6"><a id="__codelineno-24-6" name="__codelineno-24-6"></a><span class="w">        </span><span class="c1">// You may map a label to the terminal End</span>
</span><span id="__span-24-7"><a id="__codelineno-24-7" name="__codelineno-24-7"></a><span class="w">        </span><span class="c1">// &quot;drop&quot;:  graph.End,</span>
</span><span id="__span-24-8"><a id="__codelineno-24-8" name="__codelineno-24-8"></a><span class="w">    </span><span class="p">}),</span>
</span><span id="__span-24-9"><a id="__codelineno-24-9" name="__codelineno-24-9"></a><span class="p">)</span>
</span><span id="__span-24-10"><a id="__codelineno-24-10" name="__codelineno-24-10"></a>
</span><span id="__span-24-11"><a id="__codelineno-24-11" name="__codelineno-24-11"></a><span class="c1">// Short form: label equals the target node ID</span>
</span><span id="__span-24-12"><a id="__codelineno-24-12" name="__codelineno-24-12"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;router&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">routerNode</span><span class="p">,</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithEnds</span><span class="p">(</span><span class="s">&quot;nodeB&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;nodeC&quot;</span><span class="p">))</span>
</span></code></pre></div></td></tr></table></div>
<p>Command‑style routing (Command.GoTo):</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-25-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-25-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-25-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-25-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-25-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-25-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-25-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-25-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-25-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-25-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1"></a><span class="kd">func</span><span class="w"> </span><span class="nx">decideNode</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2"></a><span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="nx">s</span><span class="p">[</span><span class="s">&quot;decision&quot;</span><span class="p">].(</span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s">&quot;approve&quot;</span><span class="p">:</span>
</span><span id="__span-25-4"><a id="__codelineno-25-4" name="__codelineno-25-4"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">graph</span><span class="p">.</span><span class="nx">Command</span><span class="p">{</span><span class="nx">GoTo</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;approve&quot;</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="c1">// label</span>
</span><span id="__span-25-5"><a id="__codelineno-25-5" name="__codelineno-25-5"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s">&quot;reject&quot;</span><span class="p">:</span>
</span><span id="__span-25-6"><a id="__codelineno-25-6" name="__codelineno-25-6"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">graph</span><span class="p">.</span><span class="nx">Command</span><span class="p">{</span><span class="nx">GoTo</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;reject&quot;</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-25-7"><a id="__codelineno-25-7" name="__codelineno-25-7"></a><span class="w">    </span><span class="k">default</span><span class="p">:</span>
</span><span id="__span-25-8"><a id="__codelineno-25-8" name="__codelineno-25-8"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">graph</span><span class="p">.</span><span class="nx">Command</span><span class="p">{</span><span class="nx">GoTo</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;reject&quot;</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-25-9"><a id="__codelineno-25-9" name="__codelineno-25-9"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-25-10"><a id="__codelineno-25-10" name="__codelineno-25-10"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>Conditional edges can reuse Ends: when <code>AddConditionalEdges(from, condition, pathMap)</code> receives a <code>nil</code> <code>pathMap</code> or no match is found, the executor tries the node's Ends; if still no match, the return string is treated as a concrete node ID.</p>
<p>Resolution precedence:</p>
<ol>
<li>Explicit mapping in the conditional edge's <code>pathMap</code>.</li>
<li>The node's Ends mapping (label → concrete target).</li>
<li>Treat the return string as a node ID.</li>
</ol>
<p>Compile‑time checks:</p>
<ul>
<li><code>WithEndsMap/WithEnds</code> targets are validated in <code>Compile()</code>.</li>
<li>Targets must exist in the graph or be the special constant <code>graph.End</code>.</li>
</ul>
<p>Notes:</p>
<ul>
<li>Use the constant <code>graph.End</code> to terminate; do not use the string "END".</li>
<li>With <code>Command.GoTo</code>, you don't need to add a static <code>AddEdge(from, to)</code> for the target; ensure the target exists and set <code>SetFinishPoint(target)</code> if it should end the graph.</li>
</ul>
<p>Runnable example: <code>examples/graph/multiends</code>.</p>
<h3 id="42-multiconditional-fanout">4.2 Multi‑conditional Fan‑out</h3>
<p>Sometimes a single decision needs to spawn multiple branches in parallel
for independent processing (e.g., route to both summarization and tagging).</p>
<p>API:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-26-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-26-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-26-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-26-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-26-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-26-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-26-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-26-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-26-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-26-10">10</a></span>
<span class="normal"><a href="#__codelineno-26-11">11</a></span>
<span class="normal"><a href="#__codelineno-26-12">12</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1"></a><span class="c1">// Return multiple branch keys, each resolved to a concrete target.</span>
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddMultiConditionalEdges</span><span class="p">(</span>
</span><span id="__span-26-3"><a id="__codelineno-26-3" name="__codelineno-26-3"></a><span class="w">    </span><span class="s">&quot;router&quot;</span><span class="p">,</span>
</span><span id="__span-26-4"><a id="__codelineno-26-4" name="__codelineno-26-4"></a><span class="w">    </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">([]</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-5"><a id="__codelineno-26-5" name="__codelineno-26-5"></a><span class="w">        </span><span class="c1">// Decide multiple paths at once</span>
</span><span id="__span-26-6"><a id="__codelineno-26-6" name="__codelineno-26-6"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&quot;toA&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;toB&quot;</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-26-7"><a id="__codelineno-26-7" name="__codelineno-26-7"></a><span class="w">    </span><span class="p">},</span>
</span><span id="__span-26-8"><a id="__codelineno-26-8" name="__codelineno-26-8"></a><span class="w">    </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span>
</span><span id="__span-26-9"><a id="__codelineno-26-9" name="__codelineno-26-9"></a><span class="w">        </span><span class="s">&quot;toA&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;A&quot;</span><span class="p">,</span><span class="w"> </span><span class="c1">// branch key -&gt; target node</span>
</span><span id="__span-26-10"><a id="__codelineno-26-10" name="__codelineno-26-10"></a><span class="w">        </span><span class="s">&quot;toB&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;B&quot;</span><span class="p">,</span>
</span><span id="__span-26-11"><a id="__codelineno-26-11" name="__codelineno-26-11"></a><span class="w">    </span><span class="p">},</span>
</span><span id="__span-26-12"><a id="__codelineno-26-12" name="__codelineno-26-12"></a><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>Notes:</p>
<ul>
<li>Like other routing, targets become runnable in the <strong>next</strong> BSP superstep
  (after the router node finishes). This can affect latency; see “BSP superstep
  barrier” below.</li>
<li>Results are de‑duplicated before triggering; repeated keys do not trigger a
  target more than once in the same step.</li>
<li>Resolution precedence for each branch key mirrors single‑conditional routing:<ol>
<li>explicit <code>pathMap</code>; 2) node's Ends; 3) treat as node ID.</li>
</ol>
</li>
<li>Visualization: when <code>pathMap</code> is omitted, DOT falls back to the node's Ends
  mapping to render dashed conditional edges.</li>
</ul>
<h3 id="5-tool-node-integration">5. Tool Node Integration</h3>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-27-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-27-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-27-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-27-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-27-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-27-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-27-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-27-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-27-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-27-10">10</a></span>
<span class="normal"><a href="#__codelineno-27-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1"></a><span class="c1">// Create tools.</span>
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2"></a><span class="nx">tools</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">tool</span><span class="p">.</span><span class="nx">Tool</span><span class="p">{</span>
</span><span id="__span-27-3"><a id="__codelineno-27-3" name="__codelineno-27-3"></a><span class="w">    </span><span class="s">&quot;calculator&quot;</span><span class="p">:</span><span class="w"> </span><span class="nx">calculatorTool</span><span class="p">,</span>
</span><span id="__span-27-4"><a id="__codelineno-27-4" name="__codelineno-27-4"></a><span class="w">    </span><span class="s">&quot;search&quot;</span><span class="p">:</span><span class="w">     </span><span class="nx">searchTool</span><span class="p">,</span>
</span><span id="__span-27-5"><a id="__codelineno-27-5" name="__codelineno-27-5"></a><span class="p">}</span>
</span><span id="__span-27-6"><a id="__codelineno-27-6" name="__codelineno-27-6"></a>
</span><span id="__span-27-7"><a id="__codelineno-27-7" name="__codelineno-27-7"></a><span class="c1">// Add tool node.</span>
</span><span id="__span-27-8"><a id="__codelineno-27-8" name="__codelineno-27-8"></a><span class="nx">stateGraph</span><span class="p">.</span><span class="nx">AddToolsNode</span><span class="p">(</span><span class="s">&quot;tools&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">tools</span><span class="p">)</span>
</span><span id="__span-27-9"><a id="__codelineno-27-9" name="__codelineno-27-9"></a>
</span><span id="__span-27-10"><a id="__codelineno-27-10" name="__codelineno-27-10"></a><span class="c1">// Add conditional routing from LLM to tools.</span>
</span><span id="__span-27-11"><a id="__codelineno-27-11" name="__codelineno-27-11"></a><span class="nx">stateGraph</span><span class="p">.</span><span class="nx">AddToolsConditionalEdges</span><span class="p">(</span><span class="s">&quot;llm_node&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;tools&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;fallback_node&quot;</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>Enable parallel tool execution for the Tools node (aligns with LLMAgent's option):</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-28-1">1</a></span>
<span class="normal"><a href="#__codelineno-28-2">2</a></span>
<span class="normal"><a href="#__codelineno-28-3">3</a></span>
<span class="normal"><a href="#__codelineno-28-4">4</a></span>
<span class="normal"><a href="#__codelineno-28-5">5</a></span>
<span class="normal"><a href="#__codelineno-28-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1"></a><span class="c1">// Tools node runs tool calls concurrently when multiple tool_calls are present.</span>
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2"></a><span class="nx">stateGraph</span><span class="p">.</span><span class="nx">AddToolsNode</span><span class="p">(</span>
</span><span id="__span-28-3"><a id="__codelineno-28-3" name="__codelineno-28-3"></a><span class="w">    </span><span class="s">&quot;tools&quot;</span><span class="p">,</span>
</span><span id="__span-28-4"><a id="__codelineno-28-4" name="__codelineno-28-4"></a><span class="w">    </span><span class="nx">tools</span><span class="p">,</span>
</span><span id="__span-28-5"><a id="__codelineno-28-5" name="__codelineno-28-5"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithEnableParallelTools</span><span class="p">(</span><span class="kc">true</span><span class="p">),</span><span class="w"> </span><span class="c1">// optional; default is serial</span>
</span><span id="__span-28-6"><a id="__codelineno-28-6" name="__codelineno-28-6"></a><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>Tool-call pairing and second entry into LLM:</p>
<ul>
<li>Scan <code>messages</code> backward from the tail to find the most recent <code>assistant(tool_calls)</code>; stop at <code>user</code> to ensure correct pairing.</li>
<li>When returning from tools to the LLM node, since <code>user_input</code> is cleared, the LLM follows the "Messages only" branch and continues based on the tool response in history.</li>
</ul>
<h4 id="placeholder-variables-in-llm-instructions">Placeholder Variables in LLM Instructions</h4>
<p>LLM nodes support placeholder injection in their <code>instruction</code> string (same rules as LLMAgent). Both native <code>{key}</code> and Mustache <code>{{key}}</code> syntaxes are accepted (Mustache is normalized to the native form automatically):</p>
<ul>
<li><code>{key}</code> / <code>{{key}}</code> → Replaced with the string value corresponding to the key <code>key</code> in the session state (write via <code>sess.SetState("key", ...)</code> or SessionService).</li>
<li><code>{key?}</code> / <code>{{key?}}</code> → optional; missing values become empty</li>
<li><code>{user:subkey}</code>, <code>{app:subkey}</code>, <code>{temp:subkey}</code> (and their Mustache forms) → access user/app/temp scopes (session services merge app/user state into session with these prefixes)</li>
<li><code>{invocation:subkey}</code> / <code>{{invocation:subkey}}</code> → replaced with <code>invocation.state["subkey"]</code> (set via <code>invocation.SetState("subkey", v)</code>)</li>
</ul>
<p>Notes:</p>
<ul>
<li>GraphAgent writes the current <code>*session.Session</code> into graph state under <code>StateKeySession</code>; the LLM node reads values from there</li>
<li><code>{invocation:*}</code> values are read from the current <code>*agent.Invocation</code> for this run</li>
<li>Unprefixed keys (e.g., <code>research_topics</code>) must be present directly in <code>session.State</code></li>
</ul>
<p>Example:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-29-1">1</a></span>
<span class="normal"><a href="#__codelineno-29-2">2</a></span>
<span class="normal"><a href="#__codelineno-29-3">3</a></span>
<span class="normal"><a href="#__codelineno-29-4">4</a></span>
<span class="normal"><a href="#__codelineno-29-5">5</a></span>
<span class="normal"><a href="#__codelineno-29-6">6</a></span>
<span class="normal"><a href="#__codelineno-29-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1"></a><span class="nx">mdl</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">openai</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="nx">modelName</span><span class="p">)</span>
</span><span id="__span-29-2"><a id="__codelineno-29-2" name="__codelineno-29-2"></a><span class="nx">stateGraph</span><span class="p">.</span><span class="nx">AddLLMNode</span><span class="p">(</span>
</span><span id="__span-29-3"><a id="__codelineno-29-3" name="__codelineno-29-3"></a><span class="w">  </span><span class="s">&quot;research&quot;</span><span class="p">,</span>
</span><span id="__span-29-4"><a id="__codelineno-29-4" name="__codelineno-29-4"></a><span class="w">  </span><span class="nx">mdl</span><span class="p">,</span>
</span><span id="__span-29-5"><a id="__codelineno-29-5" name="__codelineno-29-5"></a><span class="w">  </span><span class="s">&quot;You are a research assistant. Focus: {research_topics}. User: {user:topics?}. App: {app:banner?}.&quot;</span><span class="p">,</span>
</span><span id="__span-29-6"><a id="__codelineno-29-6" name="__codelineno-29-6"></a><span class="w">  </span><span class="kc">nil</span><span class="p">,</span>
</span><span id="__span-29-7"><a id="__codelineno-29-7" name="__codelineno-29-7"></a><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>See the runnable example: <code>examples/graph/placeholder</code>.</p>
<p>Injecting retrieval output and user input</p>
<ul>
<li>Upstream nodes can place temporary values into the session's <code>temp:</code>
  namespace so the LLM instruction can read them with placeholders.</li>
<li>Pattern:</li>
</ul>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-30-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-30-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-30-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-30-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-30-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-30-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-30-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-30-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-30-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-30-10">10</a></span>
<span class="normal"><a href="#__codelineno-30-11">11</a></span>
<span class="normal"><a href="#__codelineno-30-12">12</a></span>
<span class="normal"><a href="#__codelineno-30-13">13</a></span>
<span class="normal"><a href="#__codelineno-30-14">14</a></span>
<span class="normal"><a href="#__codelineno-30-15">15</a></span>
<span class="normal"><a href="#__codelineno-30-16">16</a></span>
<span class="normal"><a href="#__codelineno-30-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1"></a><span class="c1">// In a node before the LLM node</span>
</span><span id="__span-30-2"><a id="__codelineno-30-2" name="__codelineno-30-2"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;retrieve&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-30-3"><a id="__codelineno-30-3" name="__codelineno-30-3"></a><span class="w">    </span><span class="c1">// Suppose you computed `retrieved` and want to include current user input.</span>
</span><span id="__span-30-4"><a id="__codelineno-30-4" name="__codelineno-30-4"></a><span class="w">    </span><span class="nx">retrieved</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;• doc A...\n• doc B...&quot;</span>
</span><span id="__span-30-5"><a id="__codelineno-30-5" name="__codelineno-30-5"></a><span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">input</span><span class="w"> </span><span class="kt">string</span>
</span><span id="__span-30-6"><a id="__codelineno-30-6" name="__codelineno-30-6"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">v</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">s</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyUserInput</span><span class="p">].(</span><span class="kt">string</span><span class="p">);</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">input</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">v</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-30-7"><a id="__codelineno-30-7" name="__codelineno-30-7"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">sess</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">s</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeySession</span><span class="p">].(</span><span class="o">*</span><span class="nx">session</span><span class="p">.</span><span class="nx">Session</span><span class="p">);</span><span class="w"> </span><span class="nx">sess</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-30-8"><a id="__codelineno-30-8" name="__codelineno-30-8"></a><span class="w">        </span><span class="nx">sess</span><span class="p">.</span><span class="nx">SetState</span><span class="p">(</span><span class="nx">session</span><span class="p">.</span><span class="nx">StateTempPrefix</span><span class="o">+</span><span class="s">&quot;retrieved_context&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">retrieved</span><span class="p">))</span>
</span><span id="__span-30-9"><a id="__codelineno-30-9" name="__codelineno-30-9"></a><span class="w">        </span><span class="nx">sess</span><span class="p">.</span><span class="nx">SetState</span><span class="p">(</span><span class="nx">session</span><span class="p">.</span><span class="nx">StateTempPrefix</span><span class="o">+</span><span class="s">&quot;user_input&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">input</span><span class="p">))</span>
</span><span id="__span-30-10"><a id="__codelineno-30-10" name="__codelineno-30-10"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-30-11"><a id="__codelineno-30-11" name="__codelineno-30-11"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-30-12"><a id="__codelineno-30-12" name="__codelineno-30-12"></a><span class="p">})</span>
</span><span id="__span-30-13"><a id="__codelineno-30-13" name="__codelineno-30-13"></a>
</span><span id="__span-30-14"><a id="__codelineno-30-14" name="__codelineno-30-14"></a><span class="c1">// LLM node instruction can reference {temp:retrieved_context} and {temp:user_input}</span>
</span><span id="__span-30-15"><a id="__codelineno-30-15" name="__codelineno-30-15"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddLLMNode</span><span class="p">(</span><span class="s">&quot;answer&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">mdl</span><span class="p">,</span>
</span><span id="__span-30-16"><a id="__codelineno-30-16" name="__codelineno-30-16"></a><span class="w">    </span><span class="s">&quot;Use context to answer.\n\nContext:\n{temp:retrieved_context}\n\nQuestion: {temp:user_input}&quot;</span><span class="p">,</span>
</span><span id="__span-30-17"><a id="__codelineno-30-17" name="__codelineno-30-17"></a><span class="w">    </span><span class="kc">nil</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>Example: <code>examples/graph/retrieval_placeholder</code>.</p>
<p>Best practices for placeholders and session state</p>
<ul>
<li>Session-scoped vs persistent: write temporary values used to build
  prompts to <code>temp:*</code> on session state (often overwritten each turn via
  <code>sess.SetState</code>). Persistent configuration should go through
  <code>SessionService</code> with <code>user:*</code>/<code>app:*</code>.</li>
<li>Why <code>SetState</code> is recommended: LLM nodes expand placeholders from the session object present in graph state; using <code>sess.SetState</code> avoids unsafe concurrent map access.</li>
<li>Service guardrails: the in‑memory service intentionally disallows writing <code>temp:*</code> (and <code>app:*</code> via user updater); see <a href="https://github.com/trpc-group/trpc-agent-go/blob/main/session/inmemory/service.go">session/inmemory/service.go</a>.</li>
<li>Concurrency: when multiple branches run in parallel, avoid multiple nodes mutating the same <code>session.State</code> keys. Prefer composing in a single node before the LLM, or store intermediate values in graph state then write once to <code>temp:*</code>.</li>
<li>Observability: if you want parts of the prompt to appear in completion events, also store a compact summary in graph state (e.g., under <code>metadata</code>). The final event serializes non‑internal final state; see <a href="https://github.com/trpc-group/trpc-agent-go/blob/main/graph/events.go">graph/events.go</a>.</li>
</ul>
<h3 id="6-node-retry-backoff">6. Node Retry &amp; Backoff</h3>
<p>Configure per‑node retry with exponential backoff and optional jitter. Failed attempts do not produce writes; only a successful attempt applies its state delta and routing.</p>
<ul>
<li>Per‑node policy via <code>WithRetryPolicy</code>:</li>
</ul>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-31-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-31-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-31-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-31-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-31-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-31-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-31-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-31-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-31-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-31-10">10</a></span>
<span class="normal"><a href="#__codelineno-31-11">11</a></span>
<span class="normal"><a href="#__codelineno-31-12">12</a></span>
<span class="normal"><a href="#__codelineno-31-13">13</a></span>
<span class="normal"><a href="#__codelineno-31-14">14</a></span>
<span class="normal"><a href="#__codelineno-31-15">15</a></span>
<span class="normal"><a href="#__codelineno-31-16">16</a></span>
<span class="normal"><a href="#__codelineno-31-17">17</a></span>
<span class="normal"><a href="#__codelineno-31-18">18</a></span>
<span class="normal"><a href="#__codelineno-31-19">19</a></span>
<span class="normal"><a href="#__codelineno-31-20">20</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1"></a><span class="c1">// Simple convenience policy (attempts include the first try)</span>
</span><span id="__span-31-2"><a id="__codelineno-31-2" name="__codelineno-31-2"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;unstable&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">unstableFunc</span><span class="p">,</span>
</span><span id="__span-31-3"><a id="__codelineno-31-3" name="__codelineno-31-3"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithRetryPolicy</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithSimpleRetry</span><span class="p">(</span><span class="mi">3</span><span class="p">)))</span>
</span><span id="__span-31-4"><a id="__codelineno-31-4" name="__codelineno-31-4"></a>
</span><span id="__span-31-5"><a id="__codelineno-31-5" name="__codelineno-31-5"></a><span class="c1">// Full policy</span>
</span><span id="__span-31-6"><a id="__codelineno-31-6" name="__codelineno-31-6"></a><span class="nx">policy</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">RetryPolicy</span><span class="p">{</span>
</span><span id="__span-31-7"><a id="__codelineno-31-7" name="__codelineno-31-7"></a><span class="w">    </span><span class="nx">MaxAttempts</span><span class="p">:</span><span class="w">     </span><span class="mi">3</span><span class="p">,</span><span class="w">                      </span><span class="c1">// 1 initial + up to 2 retries</span>
</span><span id="__span-31-8"><a id="__codelineno-31-8" name="__codelineno-31-8"></a><span class="w">    </span><span class="nx">InitialInterval</span><span class="p">:</span><span class="w"> </span><span class="mi">200</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span><span class="p">,</span><span class="w"> </span><span class="c1">// base delay</span>
</span><span id="__span-31-9"><a id="__codelineno-31-9" name="__codelineno-31-9"></a><span class="w">    </span><span class="nx">BackoffFactor</span><span class="p">:</span><span class="w">   </span><span class="mf">2.0</span><span class="p">,</span><span class="w">                    </span><span class="c1">// exponential backoff</span>
</span><span id="__span-31-10"><a id="__codelineno-31-10" name="__codelineno-31-10"></a><span class="w">    </span><span class="nx">MaxInterval</span><span class="p">:</span><span class="w">     </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">,</span><span class="w">        </span><span class="c1">// clamp</span>
</span><span id="__span-31-11"><a id="__codelineno-31-11" name="__codelineno-31-11"></a><span class="w">    </span><span class="nx">Jitter</span><span class="p">:</span><span class="w">          </span><span class="kc">true</span><span class="p">,</span><span class="w">                   </span><span class="c1">// randomize delay</span>
</span><span id="__span-31-12"><a id="__codelineno-31-12" name="__codelineno-31-12"></a><span class="w">    </span><span class="nx">RetryOn</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="nx">graph</span><span class="p">.</span><span class="nx">RetryCondition</span><span class="p">{</span>
</span><span id="__span-31-13"><a id="__codelineno-31-13" name="__codelineno-31-13"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">DefaultTransientCondition</span><span class="p">(),</span><span class="w">   </span><span class="c1">// deadline/net timeouts</span>
</span><span id="__span-31-14"><a id="__codelineno-31-14" name="__codelineno-31-14"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">RetryOnErrors</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">DeadlineExceeded</span><span class="p">),</span>
</span><span id="__span-31-15"><a id="__codelineno-31-15" name="__codelineno-31-15"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">RetryOnPredicate</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">err</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">}),</span>
</span><span id="__span-31-16"><a id="__codelineno-31-16" name="__codelineno-31-16"></a><span class="w">    </span><span class="p">},</span>
</span><span id="__span-31-17"><a id="__codelineno-31-17" name="__codelineno-31-17"></a><span class="w">    </span><span class="nx">MaxElapsedTime</span><span class="p">:</span><span class="w">  </span><span class="mi">5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">,</span><span class="w">        </span><span class="c1">// total retry budget (optional)</span>
</span><span id="__span-31-18"><a id="__codelineno-31-18" name="__codelineno-31-18"></a><span class="w">    </span><span class="c1">// PerAttemptTimeout: 0,                 // reserved; node timeout comes from executor</span>
</span><span id="__span-31-19"><a id="__codelineno-31-19" name="__codelineno-31-19"></a><span class="p">}</span>
</span><span id="__span-31-20"><a id="__codelineno-31-20" name="__codelineno-31-20"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;unstable&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">unstableFunc</span><span class="p">,</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithRetryPolicy</span><span class="p">(</span><span class="nx">policy</span><span class="p">))</span>
</span></code></pre></div></td></tr></table></div>
<ul>
<li>Default policy via Executor (applies when a node has none):</li>
</ul>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-32-1">1</a></span>
<span class="normal"><a href="#__codelineno-32-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1"></a><span class="nx">exec</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewExecutor</span><span class="p">(</span><span class="nx">compiled</span><span class="p">,</span>
</span><span id="__span-32-2"><a id="__codelineno-32-2" name="__codelineno-32-2"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithDefaultRetryPolicy</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithSimpleRetry</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span>
</span></code></pre></div></td></tr></table></div>
<p>Notes</p>
<ul>
<li>Interrupts are never retried.</li>
<li>Backoff delay is clamped by the current step deadline when set (<code>WithStepTimeout</code>).</li>
<li>Events carry retry metadata so UIs/CLIs can display progress:</li>
</ul>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-33-1">1</a></span>
<span class="normal"><a href="#__codelineno-33-2">2</a></span>
<span class="normal"><a href="#__codelineno-33-3">3</a></span>
<span class="normal"><a href="#__codelineno-33-4">4</a></span>
<span class="normal"><a href="#__codelineno-33-5">5</a></span>
<span class="normal"><a href="#__codelineno-33-6">6</a></span>
<span class="normal"><a href="#__codelineno-33-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1"></a><span class="k">if</span><span class="w"> </span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">ev</span><span class="p">.</span><span class="nx">StateDelta</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">MetadataKeyNode</span><span class="p">];</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-33-2"><a id="__codelineno-33-2" name="__codelineno-33-2"></a><span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">md</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NodeExecutionMetadata</span>
</span><span id="__span-33-3"><a id="__codelineno-33-3" name="__codelineno-33-3"></a><span class="w">    </span><span class="nx">_</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">json</span><span class="p">.</span><span class="nx">Unmarshal</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">md</span><span class="p">)</span>
</span><span id="__span-33-4"><a id="__codelineno-33-4" name="__codelineno-33-4"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">md</span><span class="p">.</span><span class="nx">Phase</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">ExecutionPhaseError</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">md</span><span class="p">.</span><span class="nx">Retrying</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-33-5"><a id="__codelineno-33-5" name="__codelineno-33-5"></a><span class="w">        </span><span class="c1">// md.Attempt, md.MaxAttempts, md.NextDelay</span>
</span><span id="__span-33-6"><a id="__codelineno-33-6" name="__codelineno-33-6"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-33-7"><a id="__codelineno-33-7" name="__codelineno-33-7"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>Example: <code>examples/graph/retry</code> shows an unstable node that retries before a final LLM answer.</p>
<h3 id="7-runner-configuration">7. Runner Configuration</h3>
<p>Runner provides session management and execution environment:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-34-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-34-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-34-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-34-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-34-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-34-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-34-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-34-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-34-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-34-10">10</a></span>
<span class="normal"><a href="#__codelineno-34-11">11</a></span>
<span class="normal"><a href="#__codelineno-34-12">12</a></span>
<span class="normal"><a href="#__codelineno-34-13">13</a></span>
<span class="normal"><a href="#__codelineno-34-14">14</a></span>
<span class="normal"><a href="#__codelineno-34-15">15</a></span>
<span class="normal"><a href="#__codelineno-34-16">16</a></span>
<span class="normal"><a href="#__codelineno-34-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1"></a><span class="c1">// Create session service.</span>
</span><span id="__span-34-2"><a id="__codelineno-34-2" name="__codelineno-34-2"></a><span class="nx">sessionService</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">inmemory</span><span class="p">.</span><span class="nx">NewSessionService</span><span class="p">()</span>
</span><span id="__span-34-3"><a id="__codelineno-34-3" name="__codelineno-34-3"></a><span class="c1">// Or use Redis session service.</span>
</span><span id="__span-34-4"><a id="__codelineno-34-4" name="__codelineno-34-4"></a><span class="c1">// sessionService, err := redis.NewService(redis.WithRedisClientURL(&quot;redis://localhost:6379&quot;))</span>
</span><span id="__span-34-5"><a id="__codelineno-34-5" name="__codelineno-34-5"></a>
</span><span id="__span-34-6"><a id="__codelineno-34-6" name="__codelineno-34-6"></a><span class="c1">// Create Runner.</span>
</span><span id="__span-34-7"><a id="__codelineno-34-7" name="__codelineno-34-7"></a><span class="nx">appRunner</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">runner</span><span class="p">.</span><span class="nx">NewRunner</span><span class="p">(</span>
</span><span id="__span-34-8"><a id="__codelineno-34-8" name="__codelineno-34-8"></a><span class="w">    </span><span class="s">&quot;app-name&quot;</span><span class="p">,</span>
</span><span id="__span-34-9"><a id="__codelineno-34-9" name="__codelineno-34-9"></a><span class="w">    </span><span class="nx">graphAgent</span><span class="p">,</span>
</span><span id="__span-34-10"><a id="__codelineno-34-10" name="__codelineno-34-10"></a><span class="w">    </span><span class="nx">runner</span><span class="p">.</span><span class="nx">WithSessionService</span><span class="p">(</span><span class="nx">sessionService</span><span class="p">),</span>
</span><span id="__span-34-11"><a id="__codelineno-34-11" name="__codelineno-34-11"></a><span class="w">    </span><span class="c1">// Can add more configuration options.</span>
</span><span id="__span-34-12"><a id="__codelineno-34-12" name="__codelineno-34-12"></a><span class="p">)</span>
</span><span id="__span-34-13"><a id="__codelineno-34-13" name="__codelineno-34-13"></a>
</span><span id="__span-34-14"><a id="__codelineno-34-14" name="__codelineno-34-14"></a><span class="c1">// Use Runner to execute workflow.</span>
</span><span id="__span-34-15"><a id="__codelineno-34-15" name="__codelineno-34-15"></a><span class="c1">// Runner only sets StateKeyUserInput; it no longer pre-populates StateKeyMessages.</span>
</span><span id="__span-34-16"><a id="__codelineno-34-16" name="__codelineno-34-16"></a><span class="nx">message</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">model</span><span class="p">.</span><span class="nx">NewUserMessage</span><span class="p">(</span><span class="s">&quot;User input&quot;</span><span class="p">)</span>
</span><span id="__span-34-17"><a id="__codelineno-34-17" name="__codelineno-34-17"></a><span class="nx">eventChan</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">appRunner</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">userID</span><span class="p">,</span><span class="w"> </span><span class="nx">sessionID</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="8-message-state-schema">8. Message State Schema</h3>
<p>For conversational applications, you can use predefined message state schema:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-35-1">1</a></span>
<span class="normal"><a href="#__codelineno-35-2">2</a></span>
<span class="normal"><a href="#__codelineno-35-3">3</a></span>
<span class="normal"><a href="#__codelineno-35-4">4</a></span>
<span class="normal"><a href="#__codelineno-35-5">5</a></span>
<span class="normal"><a href="#__codelineno-35-6">6</a></span>
<span class="normal"><a href="#__codelineno-35-7">7</a></span>
<span class="normal"><a href="#__codelineno-35-8">8</a></span>
<span class="normal"><a href="#__codelineno-35-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1"></a><span class="c1">// Use message state schema.</span>
</span><span id="__span-35-2"><a id="__codelineno-35-2" name="__codelineno-35-2"></a><span class="nx">schema</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">MessagesStateSchema</span><span class="p">()</span>
</span><span id="__span-35-3"><a id="__codelineno-35-3" name="__codelineno-35-3"></a>
</span><span id="__span-35-4"><a id="__codelineno-35-4" name="__codelineno-35-4"></a><span class="c1">// This schema includes:</span>
</span><span id="__span-35-5"><a id="__codelineno-35-5" name="__codelineno-35-5"></a><span class="c1">// - messages: Conversation history (StateKeyMessages).</span>
</span><span id="__span-35-6"><a id="__codelineno-35-6" name="__codelineno-35-6"></a><span class="c1">// - user_input: User input (StateKeyUserInput).</span>
</span><span id="__span-35-7"><a id="__codelineno-35-7" name="__codelineno-35-7"></a><span class="c1">// - last_response: Last response (StateKeyLastResponse).</span>
</span><span id="__span-35-8"><a id="__codelineno-35-8" name="__codelineno-35-8"></a><span class="c1">// - node_responses: Map of nodeID -&gt; response (StateKeyNodeResponses).</span>
</span><span id="__span-35-9"><a id="__codelineno-35-9" name="__codelineno-35-9"></a><span class="c1">// - metadata: Metadata (StateKeyMetadata).</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="9-state-key-usage-scenarios">9. State Key Usage Scenarios</h3>
<p><strong>User-defined State Keys</strong>: Used to store business logic data.</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-36-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-36-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-36-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-36-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-36-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-36-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-36-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-36-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-36-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-36-10">10</a></span>
<span class="normal"><a href="#__codelineno-36-11">11</a></span>
<span class="normal"><a href="#__codelineno-36-12">12</a></span>
<span class="normal"><a href="#__codelineno-36-13">13</a></span>
<span class="normal"><a href="#__codelineno-36-14">14</a></span>
<span class="normal"><a href="#__codelineno-36-15">15</a></span>
<span class="normal"><a href="#__codelineno-36-16">16</a></span>
<span class="normal"><a href="#__codelineno-36-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-36-2"><a id="__codelineno-36-2" name="__codelineno-36-2"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-36-3"><a id="__codelineno-36-3" name="__codelineno-36-3"></a><span class="p">)</span>
</span><span id="__span-36-4"><a id="__codelineno-36-4" name="__codelineno-36-4"></a>
</span><span id="__span-36-5"><a id="__codelineno-36-5" name="__codelineno-36-5"></a><span class="c1">// Recommended: Use custom state keys.</span>
</span><span id="__span-36-6"><a id="__codelineno-36-6" name="__codelineno-36-6"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-36-7"><a id="__codelineno-36-7" name="__codelineno-36-7"></a><span class="w">    </span><span class="nx">StateKeyDocumentLength</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;document_length&quot;</span>
</span><span id="__span-36-8"><a id="__codelineno-36-8" name="__codelineno-36-8"></a><span class="w">    </span><span class="nx">StateKeyComplexityLevel</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;complexity_level&quot;</span>
</span><span id="__span-36-9"><a id="__codelineno-36-9" name="__codelineno-36-9"></a><span class="w">    </span><span class="nx">StateKeyProcessingStage</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;processing_stage&quot;</span>
</span><span id="__span-36-10"><a id="__codelineno-36-10" name="__codelineno-36-10"></a><span class="p">)</span>
</span><span id="__span-36-11"><a id="__codelineno-36-11" name="__codelineno-36-11"></a>
</span><span id="__span-36-12"><a id="__codelineno-36-12" name="__codelineno-36-12"></a><span class="c1">// Use in nodes.</span>
</span><span id="__span-36-13"><a id="__codelineno-36-13" name="__codelineno-36-13"></a><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span>
</span><span id="__span-36-14"><a id="__codelineno-36-14" name="__codelineno-36-14"></a><span class="w">    </span><span class="nx">StateKeyDocumentLength</span><span class="p">:</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">input</span><span class="p">),</span>
</span><span id="__span-36-15"><a id="__codelineno-36-15" name="__codelineno-36-15"></a><span class="w">    </span><span class="nx">StateKeyComplexityLevel</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;simple&quot;</span><span class="p">,</span>
</span><span id="__span-36-16"><a id="__codelineno-36-16" name="__codelineno-36-16"></a><span class="w">    </span><span class="nx">StateKeyProcessingStage</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;completed&quot;</span><span class="p">,</span>
</span><span id="__span-36-17"><a id="__codelineno-36-17" name="__codelineno-36-17"></a><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span></code></pre></div></td></tr></table></div>
<p><strong>Built-in State Keys</strong>: Used for system integration.</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-37-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-37-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-37-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-37-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-37-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-37-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-37-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-37-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-37-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-37-10">10</a></span>
<span class="normal"><a href="#__codelineno-37-11">11</a></span>
<span class="normal"><a href="#__codelineno-37-12">12</a></span>
<span class="normal"><a href="#__codelineno-37-13">13</a></span>
<span class="normal"><a href="#__codelineno-37-14">14</a></span>
<span class="normal"><a href="#__codelineno-37-15">15</a></span>
<span class="normal"><a href="#__codelineno-37-16">16</a></span>
<span class="normal"><a href="#__codelineno-37-17">17</a></span>
<span class="normal"><a href="#__codelineno-37-18">18</a></span>
<span class="normal"><a href="#__codelineno-37-19">19</a></span>
<span class="normal"><a href="#__codelineno-37-20">20</a></span>
<span class="normal"><a href="#__codelineno-37-21">21</a></span>
<span class="normal"><a href="#__codelineno-37-22">22</a></span>
<span class="normal"><a href="#__codelineno-37-23">23</a></span>
<span class="normal"><a href="#__codelineno-37-24">24</a></span>
<span class="normal"><a href="#__codelineno-37-25">25</a></span>
<span class="normal"><a href="#__codelineno-37-26">26</a></span>
<span class="normal"><a href="#__codelineno-37-27">27</a></span>
<span class="normal"><a href="#__codelineno-37-28">28</a></span>
<span class="normal"><a href="#__codelineno-37-29">29</a></span>
<span class="normal"><a href="#__codelineno-37-30">30</a></span>
<span class="normal"><a href="#__codelineno-37-31">31</a></span>
<span class="normal"><a href="#__codelineno-37-32">32</a></span>
<span class="normal"><a href="#__codelineno-37-33">33</a></span>
<span class="normal"><a href="#__codelineno-37-34">34</a></span>
<span class="normal"><a href="#__codelineno-37-35">35</a></span>
<span class="normal"><a href="#__codelineno-37-36">36</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-37-1"><a id="__codelineno-37-1" name="__codelineno-37-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-37-2"><a id="__codelineno-37-2" name="__codelineno-37-2"></a><span class="w">    </span><span class="s">&quot;time&quot;</span>
</span><span id="__span-37-3"><a id="__codelineno-37-3" name="__codelineno-37-3"></a>
</span><span id="__span-37-4"><a id="__codelineno-37-4" name="__codelineno-37-4"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-37-5"><a id="__codelineno-37-5" name="__codelineno-37-5"></a><span class="p">)</span>
</span><span id="__span-37-6"><a id="__codelineno-37-6" name="__codelineno-37-6"></a>
</span><span id="__span-37-7"><a id="__codelineno-37-7" name="__codelineno-37-7"></a><span class="c1">// Get user input (automatically set by system).</span>
</span><span id="__span-37-8"><a id="__codelineno-37-8" name="__codelineno-37-8"></a><span class="nx">userInput</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">state</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyUserInput</span><span class="p">].(</span><span class="kt">string</span><span class="p">)</span>
</span><span id="__span-37-9"><a id="__codelineno-37-9" name="__codelineno-37-9"></a>
</span><span id="__span-37-10"><a id="__codelineno-37-10" name="__codelineno-37-10"></a><span class="c1">// Set final output (system will read this value).</span>
</span><span id="__span-37-11"><a id="__codelineno-37-11" name="__codelineno-37-11"></a><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span>
</span><span id="__span-37-12"><a id="__codelineno-37-12" name="__codelineno-37-12"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyLastResponse</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Processing complete&quot;</span><span class="p">,</span>
</span><span id="__span-37-13"><a id="__codelineno-37-13" name="__codelineno-37-13"></a><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-37-14"><a id="__codelineno-37-14" name="__codelineno-37-14"></a>
</span><span id="__span-37-15"><a id="__codelineno-37-15" name="__codelineno-37-15"></a><span class="c1">// Read per-node responses when multiple nodes (e.g., parallel LLM nodes)</span>
</span><span id="__span-37-16"><a id="__codelineno-37-16" name="__codelineno-37-16"></a><span class="c1">// produce outputs. Values are stored as a map[nodeID]any and merged across</span>
</span><span id="__span-37-17"><a id="__codelineno-37-17" name="__codelineno-37-17"></a><span class="c1">// steps. Use LastResponse for the final serial output; use NodeResponses for</span>
</span><span id="__span-37-18"><a id="__codelineno-37-18" name="__codelineno-37-18"></a><span class="c1">// converged parallel outputs.</span>
</span><span id="__span-37-19"><a id="__codelineno-37-19" name="__codelineno-37-19"></a><span class="nx">responses</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">state</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyNodeResponses</span><span class="p">].(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">any</span><span class="p">)</span>
</span><span id="__span-37-20"><a id="__codelineno-37-20" name="__codelineno-37-20"></a><span class="nx">news</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">responses</span><span class="p">[</span><span class="s">&quot;news&quot;</span><span class="p">].(</span><span class="kt">string</span><span class="p">)</span>
</span><span id="__span-37-21"><a id="__codelineno-37-21" name="__codelineno-37-21"></a><span class="nx">dialog</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">responses</span><span class="p">[</span><span class="s">&quot;dialog&quot;</span><span class="p">].(</span><span class="kt">string</span><span class="p">)</span>
</span><span id="__span-37-22"><a id="__codelineno-37-22" name="__codelineno-37-22"></a>
</span><span id="__span-37-23"><a id="__codelineno-37-23" name="__codelineno-37-23"></a><span class="c1">// Use them separately or combine into the final output.</span>
</span><span id="__span-37-24"><a id="__codelineno-37-24" name="__codelineno-37-24"></a><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span>
</span><span id="__span-37-25"><a id="__codelineno-37-25" name="__codelineno-37-25"></a><span class="w">    </span><span class="s">&quot;news_output&quot;</span><span class="p">:</span><span class="w">  </span><span class="nx">news</span><span class="p">,</span>
</span><span id="__span-37-26"><a id="__codelineno-37-26" name="__codelineno-37-26"></a><span class="w">    </span><span class="s">&quot;dialog_output&quot;</span><span class="p">:</span><span class="w"> </span><span class="nx">dialog</span><span class="p">,</span>
</span><span id="__span-37-27"><a id="__codelineno-37-27" name="__codelineno-37-27"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyLastResponse</span><span class="p">:</span><span class="w"> </span><span class="nx">news</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;\n&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">dialog</span><span class="p">,</span>
</span><span id="__span-37-28"><a id="__codelineno-37-28" name="__codelineno-37-28"></a><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-37-29"><a id="__codelineno-37-29" name="__codelineno-37-29"></a>
</span><span id="__span-37-30"><a id="__codelineno-37-30" name="__codelineno-37-30"></a><span class="c1">// Store metadata.</span>
</span><span id="__span-37-31"><a id="__codelineno-37-31" name="__codelineno-37-31"></a><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span>
</span><span id="__span-37-32"><a id="__codelineno-37-32" name="__codelineno-37-32"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyMetadata</span><span class="p">:</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">any</span><span class="p">{</span>
</span><span id="__span-37-33"><a id="__codelineno-37-33" name="__codelineno-37-33"></a><span class="w">        </span><span class="s">&quot;timestamp&quot;</span><span class="p">:</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">(),</span>
</span><span id="__span-37-34"><a id="__codelineno-37-34" name="__codelineno-37-34"></a><span class="w">        </span><span class="s">&quot;version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1.0&quot;</span><span class="p">,</span>
</span><span id="__span-37-35"><a id="__codelineno-37-35" name="__codelineno-37-35"></a><span class="w">    </span><span class="p">},</span>
</span><span id="__span-37-36"><a id="__codelineno-37-36" name="__codelineno-37-36"></a><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span></code></pre></div></td></tr></table></div>
<h2 id="advanced-features">Advanced Features</h2>
<h3 id="1-interrupt-and-resume-human-in-the-loop">1. Interrupt and Resume (Human-in-the-Loop)</h3>
<p>The Graph package supports human-in-the-loop (HITL) workflows through interrupt and resume functionality. This enables workflows to pause execution, wait for human input or approval, and then resume from the exact point where they were interrupted.</p>
<h4 id="basic-usage">Basic Usage</h4>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-38-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-38-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-38-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-38-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-38-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-38-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-38-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-38-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-38-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-38-10">10</a></span>
<span class="normal"><a href="#__codelineno-38-11">11</a></span>
<span class="normal"><a href="#__codelineno-38-12">12</a></span>
<span class="normal"><a href="#__codelineno-38-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-38-1"><a id="__codelineno-38-1" name="__codelineno-38-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-38-2"><a id="__codelineno-38-2" name="__codelineno-38-2"></a><span class="w">    </span><span class="s">&quot;context&quot;</span>
</span><span id="__span-38-3"><a id="__codelineno-38-3" name="__codelineno-38-3"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-38-4"><a id="__codelineno-38-4" name="__codelineno-38-4"></a><span class="p">)</span>
</span><span id="__span-38-5"><a id="__codelineno-38-5" name="__codelineno-38-5"></a>
</span><span id="__span-38-6"><a id="__codelineno-38-6" name="__codelineno-38-6"></a><span class="c1">// Create a node that can interrupt execution for human input</span>
</span><span id="__span-38-7"><a id="__codelineno-38-7" name="__codelineno-38-7"></a><span class="nx">b</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;approval_node&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-38-8"><a id="__codelineno-38-8" name="__codelineno-38-8"></a><span class="w">    </span><span class="c1">// Use the Interrupt helper for clean interrupt/resume handling</span>
</span><span id="__span-38-9"><a id="__codelineno-38-9" name="__codelineno-38-9"></a><span class="w">    </span><span class="nx">prompt</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">any</span><span class="p">{</span>
</span><span id="__span-38-10"><a id="__codelineno-38-10" name="__codelineno-38-10"></a><span class="w">        </span><span class="s">&quot;message&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Please approve this action (yes/no):&quot;</span><span class="p">,</span>
</span><span id="__span-38-11"><a id="__codelineno-38-11" name="__codelineno-38-11"></a><span class="w">        </span><span class="s">&quot;data&quot;</span><span class="p">:</span><span class="w">    </span><span class="nx">s</span><span class="p">[</span><span class="s">&quot;some_data&quot;</span><span class="p">],</span>
</span><span id="__span-38-12"><a id="__codelineno-38-12" name="__codelineno-38-12"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-38-13"><a id="__codelineno-38-13" name="__codelineno-38-13"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>Turn the diagram into a runnable workflow:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-39-1">  1</a></span>
<span class="normal"><a href="#__codelineno-39-2">  2</a></span>
<span class="normal"><a href="#__codelineno-39-3">  3</a></span>
<span class="normal"><a href="#__codelineno-39-4">  4</a></span>
<span class="normal"><a href="#__codelineno-39-5">  5</a></span>
<span class="normal"><a href="#__codelineno-39-6">  6</a></span>
<span class="normal"><a href="#__codelineno-39-7">  7</a></span>
<span class="normal"><a href="#__codelineno-39-8">  8</a></span>
<span class="normal"><a href="#__codelineno-39-9">  9</a></span>
<span class="normal"><a href="#__codelineno-39-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-39-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-39-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-39-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-39-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-39-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-39-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-39-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-39-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-39-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-39-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-39-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-39-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-39-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-39-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-39-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-39-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-39-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-39-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-39-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-39-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-39-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-39-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-39-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-39-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-39-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-39-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-39-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-39-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-39-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-39-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-39-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-39-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-39-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-39-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-39-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-39-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-39-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-39-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-39-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-39-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-39-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-39-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-39-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-39-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-39-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-39-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-39-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-39-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-39-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-39-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-39-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-39-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-39-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-39-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-39-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-39-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-39-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-39-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-39-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-39-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-39-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-39-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-39-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-39-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-39-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-39-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-39-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-39-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-39-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-39-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-39-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-39-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-39-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-39-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-39-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-39-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-39-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-39-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-39-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-39-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-39-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-39-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-39-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-39-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-39-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-39-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-39-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-39-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-39-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-39-100">100</a></span>
<span class="normal"><a href="#__codelineno-39-101">101</a></span>
<span class="normal"><a href="#__codelineno-39-102">102</a></span>
<span class="normal"><a href="#__codelineno-39-103">103</a></span>
<span class="normal"><a href="#__codelineno-39-104">104</a></span>
<span class="normal"><a href="#__codelineno-39-105">105</a></span>
<span class="normal"><a href="#__codelineno-39-106">106</a></span>
<span class="normal"><a href="#__codelineno-39-107">107</a></span>
<span class="normal"><a href="#__codelineno-39-108">108</a></span>
<span class="normal"><a href="#__codelineno-39-109">109</a></span>
<span class="normal"><a href="#__codelineno-39-110">110</a></span>
<span class="normal"><a href="#__codelineno-39-111">111</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-39-1"><a id="__codelineno-39-1" name="__codelineno-39-1"></a><span class="kn">package</span><span class="w"> </span><span class="nx">main</span>
</span><span id="__span-39-2"><a id="__codelineno-39-2" name="__codelineno-39-2"></a>
</span><span id="__span-39-3"><a id="__codelineno-39-3" name="__codelineno-39-3"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-39-4"><a id="__codelineno-39-4" name="__codelineno-39-4"></a><span class="w">    </span><span class="s">&quot;context&quot;</span>
</span><span id="__span-39-5"><a id="__codelineno-39-5" name="__codelineno-39-5"></a><span class="w">    </span><span class="s">&quot;fmt&quot;</span>
</span><span id="__span-39-6"><a id="__codelineno-39-6" name="__codelineno-39-6"></a><span class="w">    </span><span class="s">&quot;strings&quot;</span>
</span><span id="__span-39-7"><a id="__codelineno-39-7" name="__codelineno-39-7"></a>
</span><span id="__span-39-8"><a id="__codelineno-39-8" name="__codelineno-39-8"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/agent/graphagent&quot;</span>
</span><span id="__span-39-9"><a id="__codelineno-39-9" name="__codelineno-39-9"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-39-10"><a id="__codelineno-39-10" name="__codelineno-39-10"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/model&quot;</span>
</span><span id="__span-39-11"><a id="__codelineno-39-11" name="__codelineno-39-11"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/model/openai&quot;</span>
</span><span id="__span-39-12"><a id="__codelineno-39-12" name="__codelineno-39-12"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/runner&quot;</span>
</span><span id="__span-39-13"><a id="__codelineno-39-13" name="__codelineno-39-13"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/tool&quot;</span>
</span><span id="__span-39-14"><a id="__codelineno-39-14" name="__codelineno-39-14"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/tool/function&quot;</span>
</span><span id="__span-39-15"><a id="__codelineno-39-15" name="__codelineno-39-15"></a><span class="p">)</span>
</span><span id="__span-39-16"><a id="__codelineno-39-16" name="__codelineno-39-16"></a>
</span><span id="__span-39-17"><a id="__codelineno-39-17" name="__codelineno-39-17"></a><span class="c1">// Unexported constants to avoid magic strings</span>
</span><span id="__span-39-18"><a id="__codelineno-39-18" name="__codelineno-39-18"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-39-19"><a id="__codelineno-39-19" name="__codelineno-39-19"></a><span class="w">    </span><span class="nx">nodePrepare</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;prepare&quot;</span>
</span><span id="__span-39-20"><a id="__codelineno-39-20" name="__codelineno-39-20"></a><span class="w">    </span><span class="nx">nodeAsk</span><span class="w">      </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;ask&quot;</span>
</span><span id="__span-39-21"><a id="__codelineno-39-21" name="__codelineno-39-21"></a><span class="w">    </span><span class="nx">nodeTools</span><span class="w">    </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;tools&quot;</span>
</span><span id="__span-39-22"><a id="__codelineno-39-22" name="__codelineno-39-22"></a><span class="w">    </span><span class="nx">nodeFallback</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;fallback&quot;</span>
</span><span id="__span-39-23"><a id="__codelineno-39-23" name="__codelineno-39-23"></a><span class="w">    </span><span class="nx">nodeFinish</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;finish&quot;</span>
</span><span id="__span-39-24"><a id="__codelineno-39-24" name="__codelineno-39-24"></a>
</span><span id="__span-39-25"><a id="__codelineno-39-25" name="__codelineno-39-25"></a><span class="w">    </span><span class="nx">modelName</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;gpt-4o-mini&quot;</span>
</span><span id="__span-39-26"><a id="__codelineno-39-26" name="__codelineno-39-26"></a><span class="w">    </span><span class="nx">systemPrompt</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;You are a careful assistant.&quot;</span>
</span><span id="__span-39-27"><a id="__codelineno-39-27" name="__codelineno-39-27"></a><span class="w">    </span><span class="nx">outputKeyFinal</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;final_output&quot;</span>
</span><span id="__span-39-28"><a id="__codelineno-39-28" name="__codelineno-39-28"></a>
</span><span id="__span-39-29"><a id="__codelineno-39-29" name="__codelineno-39-29"></a><span class="w">    </span><span class="nx">toolNameCalculator</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;calculator&quot;</span>
</span><span id="__span-39-30"><a id="__codelineno-39-30" name="__codelineno-39-30"></a>
</span><span id="__span-39-31"><a id="__codelineno-39-31" name="__codelineno-39-31"></a><span class="w">    </span><span class="nx">demoUserID</span><span class="w">    </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;user&quot;</span>
</span><span id="__span-39-32"><a id="__codelineno-39-32" name="__codelineno-39-32"></a><span class="w">    </span><span class="nx">demoSessionID</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;session&quot;</span>
</span><span id="__span-39-33"><a id="__codelineno-39-33" name="__codelineno-39-33"></a><span class="w">    </span><span class="nx">demoQuestion</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;What is 6 * 7?&quot;</span>
</span><span id="__span-39-34"><a id="__codelineno-39-34" name="__codelineno-39-34"></a><span class="p">)</span>
</span><span id="__span-39-35"><a id="__codelineno-39-35" name="__codelineno-39-35"></a>
</span><span id="__span-39-36"><a id="__codelineno-39-36" name="__codelineno-39-36"></a><span class="kd">func</span><span class="w"> </span><span class="nx">newCalculator</span><span class="p">()</span><span class="w"> </span><span class="nx">tool</span><span class="p">.</span><span class="nx">Tool</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-37"><a id="__codelineno-39-37" name="__codelineno-39-37"></a><span class="w">    </span><span class="kd">type</span><span class="w"> </span><span class="nx">Input</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-38"><a id="__codelineno-39-38" name="__codelineno-39-38"></a><span class="w">        </span><span class="nx">Expression</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="s">`json:&quot;expression&quot;`</span>
</span><span id="__span-39-39"><a id="__codelineno-39-39" name="__codelineno-39-39"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-39-40"><a id="__codelineno-39-40" name="__codelineno-39-40"></a><span class="w">    </span><span class="kd">type</span><span class="w"> </span><span class="nx">Output</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-41"><a id="__codelineno-39-41" name="__codelineno-39-41"></a><span class="w">        </span><span class="nx">Result</span><span class="w"> </span><span class="kt">float64</span><span class="w"> </span><span class="s">`json:&quot;result&quot;`</span>
</span><span id="__span-39-42"><a id="__codelineno-39-42" name="__codelineno-39-42"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-39-43"><a id="__codelineno-39-43" name="__codelineno-39-43"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">function</span><span class="p">.</span><span class="nx">NewFunctionTool</span><span class="p">[</span><span class="nx">Input</span><span class="p">,</span><span class="w"> </span><span class="nx">Output</span><span class="p">](</span>
</span><span id="__span-39-44"><a id="__codelineno-39-44" name="__codelineno-39-44"></a><span class="w">        </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">in</span><span class="w"> </span><span class="nx">Input</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nx">Output</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-45"><a id="__codelineno-39-45" name="__codelineno-39-45"></a><span class="w">            </span><span class="c1">// Implement a real evaluator here</span>
</span><span id="__span-39-46"><a id="__codelineno-39-46" name="__codelineno-39-46"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">Output</span><span class="p">{</span><span class="nx">Result</span><span class="p">:</span><span class="w"> </span><span class="mi">42</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-39-47"><a id="__codelineno-39-47" name="__codelineno-39-47"></a><span class="w">        </span><span class="p">},</span>
</span><span id="__span-39-48"><a id="__codelineno-39-48" name="__codelineno-39-48"></a><span class="w">        </span><span class="nx">function</span><span class="p">.</span><span class="nx">WithName</span><span class="p">(</span><span class="nx">toolNameCalculator</span><span class="p">),</span>
</span><span id="__span-39-49"><a id="__codelineno-39-49" name="__codelineno-39-49"></a><span class="w">        </span><span class="nx">function</span><span class="p">.</span><span class="nx">WithDescription</span><span class="p">(</span><span class="s">&quot;Evaluate a math expression&quot;</span><span class="p">),</span>
</span><span id="__span-39-50"><a id="__codelineno-39-50" name="__codelineno-39-50"></a><span class="w">    </span><span class="p">)</span>
</span><span id="__span-39-51"><a id="__codelineno-39-51" name="__codelineno-39-51"></a><span class="p">}</span>
</span><span id="__span-39-52"><a id="__codelineno-39-52" name="__codelineno-39-52"></a>
</span><span id="__span-39-53"><a id="__codelineno-39-53" name="__codelineno-39-53"></a><span class="kd">func</span><span class="w"> </span><span class="nx">buildWorkflow</span><span class="p">(</span><span class="nx">m</span><span class="w"> </span><span class="nx">model</span><span class="p">.</span><span class="nx">Model</span><span class="p">,</span><span class="w"> </span><span class="nx">tools</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">tool</span><span class="p">.</span><span class="nx">Tool</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">graph</span><span class="p">.</span><span class="nx">Graph</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-54"><a id="__codelineno-39-54" name="__codelineno-39-54"></a><span class="w">    </span><span class="nx">sg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateGraph</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">MessagesStateSchema</span><span class="p">())</span>
</span><span id="__span-39-55"><a id="__codelineno-39-55" name="__codelineno-39-55"></a>
</span><span id="__span-39-56"><a id="__codelineno-39-56" name="__codelineno-39-56"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="nx">nodePrepare</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-57"><a id="__codelineno-39-57" name="__codelineno-39-57"></a><span class="w">        </span><span class="nx">raw</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprint</span><span class="p">(</span><span class="nx">s</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyUserInput</span><span class="p">])</span>
</span><span id="__span-39-58"><a id="__codelineno-39-58" name="__codelineno-39-58"></a><span class="w">        </span><span class="nx">cleaned</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">strings</span><span class="p">.</span><span class="nx">TrimSpace</span><span class="p">(</span><span class="nx">raw</span><span class="p">)</span>
</span><span id="__span-39-59"><a id="__codelineno-39-59" name="__codelineno-39-59"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyUserInput</span><span class="p">:</span><span class="w"> </span><span class="nx">cleaned</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-39-60"><a id="__codelineno-39-60" name="__codelineno-39-60"></a><span class="w">    </span><span class="p">})</span>
</span><span id="__span-39-61"><a id="__codelineno-39-61" name="__codelineno-39-61"></a>
</span><span id="__span-39-62"><a id="__codelineno-39-62" name="__codelineno-39-62"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddLLMNode</span><span class="p">(</span><span class="nx">nodeAsk</span><span class="p">,</span><span class="w"> </span><span class="nx">m</span><span class="p">,</span><span class="w"> </span><span class="nx">systemPrompt</span><span class="p">,</span><span class="w"> </span><span class="nx">tools</span><span class="p">)</span>
</span><span id="__span-39-63"><a id="__codelineno-39-63" name="__codelineno-39-63"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddToolsNode</span><span class="p">(</span><span class="nx">nodeTools</span><span class="p">,</span><span class="w"> </span><span class="nx">tools</span><span class="p">)</span>
</span><span id="__span-39-64"><a id="__codelineno-39-64" name="__codelineno-39-64"></a>
</span><span id="__span-39-65"><a id="__codelineno-39-65" name="__codelineno-39-65"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="nx">nodeFallback</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-66"><a id="__codelineno-39-66" name="__codelineno-39-66"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyLastResponse</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;No tools required; answer directly&quot;</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-39-67"><a id="__codelineno-39-67" name="__codelineno-39-67"></a><span class="w">    </span><span class="p">})</span>
</span><span id="__span-39-68"><a id="__codelineno-39-68" name="__codelineno-39-68"></a>
</span><span id="__span-39-69"><a id="__codelineno-39-69" name="__codelineno-39-69"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="nx">nodeFinish</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-70"><a id="__codelineno-39-70" name="__codelineno-39-70"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="nx">outputKeyFinal</span><span class="p">:</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprint</span><span class="p">(</span><span class="nx">s</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyLastResponse</span><span class="p">])},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-39-71"><a id="__codelineno-39-71" name="__codelineno-39-71"></a><span class="w">    </span><span class="p">})</span>
</span><span id="__span-39-72"><a id="__codelineno-39-72" name="__codelineno-39-72"></a>
</span><span id="__span-39-73"><a id="__codelineno-39-73" name="__codelineno-39-73"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">SetEntryPoint</span><span class="p">(</span><span class="nx">nodePrepare</span><span class="p">)</span>
</span><span id="__span-39-74"><a id="__codelineno-39-74" name="__codelineno-39-74"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddEdge</span><span class="p">(</span><span class="nx">nodePrepare</span><span class="p">,</span><span class="w"> </span><span class="nx">nodeAsk</span><span class="p">)</span>
</span><span id="__span-39-75"><a id="__codelineno-39-75" name="__codelineno-39-75"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddToolsConditionalEdges</span><span class="p">(</span><span class="nx">nodeAsk</span><span class="p">,</span><span class="w"> </span><span class="nx">nodeTools</span><span class="p">,</span><span class="w"> </span><span class="nx">nodeFallback</span><span class="p">)</span>
</span><span id="__span-39-76"><a id="__codelineno-39-76" name="__codelineno-39-76"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddEdge</span><span class="p">(</span><span class="nx">nodeTools</span><span class="p">,</span><span class="w"> </span><span class="nx">nodeAsk</span><span class="p">)</span>
</span><span id="__span-39-77"><a id="__codelineno-39-77" name="__codelineno-39-77"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddEdge</span><span class="p">(</span><span class="nx">nodeFallback</span><span class="p">,</span><span class="w"> </span><span class="nx">nodeFinish</span><span class="p">)</span>
</span><span id="__span-39-78"><a id="__codelineno-39-78" name="__codelineno-39-78"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">SetFinishPoint</span><span class="p">(</span><span class="nx">nodeFinish</span><span class="p">)</span>
</span><span id="__span-39-79"><a id="__codelineno-39-79" name="__codelineno-39-79"></a>
</span><span id="__span-39-80"><a id="__codelineno-39-80" name="__codelineno-39-80"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">sg</span><span class="p">.</span><span class="nx">Compile</span><span class="p">()</span>
</span><span id="__span-39-81"><a id="__codelineno-39-81" name="__codelineno-39-81"></a><span class="p">}</span>
</span><span id="__span-39-82"><a id="__codelineno-39-82" name="__codelineno-39-82"></a>
</span><span id="__span-39-83"><a id="__codelineno-39-83" name="__codelineno-39-83"></a><span class="kd">func</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-84"><a id="__codelineno-39-84" name="__codelineno-39-84"></a><span class="w">    </span><span class="nx">mdl</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">openai</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="nx">modelName</span><span class="p">)</span>
</span><span id="__span-39-85"><a id="__codelineno-39-85" name="__codelineno-39-85"></a><span class="w">    </span><span class="nx">tools</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">tool</span><span class="p">.</span><span class="nx">Tool</span><span class="p">{</span><span class="nx">toolNameCalculator</span><span class="p">:</span><span class="w"> </span><span class="nx">newCalculator</span><span class="p">()}</span>
</span><span id="__span-39-86"><a id="__codelineno-39-86" name="__codelineno-39-86"></a>
</span><span id="__span-39-87"><a id="__codelineno-39-87" name="__codelineno-39-87"></a><span class="w">    </span><span class="nx">g</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">buildWorkflow</span><span class="p">(</span><span class="nx">mdl</span><span class="p">,</span><span class="w"> </span><span class="nx">tools</span><span class="p">)</span>
</span><span id="__span-39-88"><a id="__codelineno-39-88" name="__codelineno-39-88"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-89"><a id="__codelineno-39-89" name="__codelineno-39-89"></a><span class="w">        </span><span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span id="__span-39-90"><a id="__codelineno-39-90" name="__codelineno-39-90"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-39-91"><a id="__codelineno-39-91" name="__codelineno-39-91"></a>
</span><span id="__span-39-92"><a id="__codelineno-39-92" name="__codelineno-39-92"></a><span class="w">    </span><span class="c1">// Run with GraphAgent + Runner (no direct Executor.Execute)</span>
</span><span id="__span-39-93"><a id="__codelineno-39-93" name="__codelineno-39-93"></a><span class="w">    </span><span class="nx">ga</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;demo&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">g</span><span class="p">)</span>
</span><span id="__span-39-94"><a id="__codelineno-39-94" name="__codelineno-39-94"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-95"><a id="__codelineno-39-95" name="__codelineno-39-95"></a><span class="w">        </span><span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span id="__span-39-96"><a id="__codelineno-39-96" name="__codelineno-39-96"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-39-97"><a id="__codelineno-39-97" name="__codelineno-39-97"></a><span class="w">    </span><span class="nx">app</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">runner</span><span class="p">.</span><span class="nx">NewRunner</span><span class="p">(</span><span class="s">&quot;app&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">ga</span><span class="p">)</span>
</span><span id="__span-39-98"><a id="__codelineno-39-98" name="__codelineno-39-98"></a><span class="w">    </span><span class="nx">events</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">app</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Background</span><span class="p">(),</span><span class="w"> </span><span class="nx">demoUserID</span><span class="p">,</span><span class="w"> </span><span class="nx">demoSessionID</span><span class="p">,</span>
</span><span id="__span-39-99"><a id="__codelineno-39-99" name="__codelineno-39-99"></a><span class="w">        </span><span class="nx">model</span><span class="p">.</span><span class="nx">NewUserMessage</span><span class="p">(</span><span class="nx">demoQuestion</span><span class="p">))</span>
</span><span id="__span-39-100"><a id="__codelineno-39-100" name="__codelineno-39-100"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-101"><a id="__codelineno-39-101" name="__codelineno-39-101"></a><span class="w">        </span><span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span id="__span-39-102"><a id="__codelineno-39-102" name="__codelineno-39-102"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-39-103"><a id="__codelineno-39-103" name="__codelineno-39-103"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">ev</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">events</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-104"><a id="__codelineno-39-104" name="__codelineno-39-104"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">ev</span><span class="p">.</span><span class="nx">Response</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-105"><a id="__codelineno-39-105" name="__codelineno-39-105"></a><span class="w">            </span><span class="k">continue</span>
</span><span id="__span-39-106"><a id="__codelineno-39-106" name="__codelineno-39-106"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-39-107"><a id="__codelineno-39-107" name="__codelineno-39-107"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">ev</span><span class="p">.</span><span class="nx">Author</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">nodeAsk</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">!</span><span class="nx">ev</span><span class="p">.</span><span class="nx">Response</span><span class="p">.</span><span class="nx">IsPartial</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">ev</span><span class="p">.</span><span class="nx">Response</span><span class="p">.</span><span class="nx">Choices</span><span class="p">)</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-108"><a id="__codelineno-39-108" name="__codelineno-39-108"></a><span class="w">            </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;LLM:&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">ev</span><span class="p">.</span><span class="nx">Response</span><span class="p">.</span><span class="nx">Choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">Message</span><span class="p">.</span><span class="nx">Content</span><span class="p">)</span>
</span><span id="__span-39-109"><a id="__codelineno-39-109" name="__codelineno-39-109"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-39-110"><a id="__codelineno-39-110" name="__codelineno-39-110"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-39-111"><a id="__codelineno-39-111" name="__codelineno-39-111"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>The example shows how to declare nodes, connect edges, and run. Next, we'll cover execution with GraphAgent + Runner, then core concepts and common practices.</p>
<h3 id="2-static-interrupts-debug-breakpoints">2. Static Interrupts (Debug Breakpoints)</h3>
<p>Static interrupts are "breakpoints" that pause the graph <strong>before</strong> or
<strong>after</strong> specific nodes execute. They are mainly used for debugging, and they
do not require you to call <code>graph.Interrupt(...)</code> inside node logic.</p>
<p>Key differences from HITL interrupts:</p>
<ul>
<li><strong>HITL interrupt</strong>: a node calls <code>graph.Interrupt(ctx, state, key, prompt)</code>.
  Resuming requires providing a resume input for that <code>key</code>.</li>
<li><strong>Static interrupt</strong>: you attach interrupt options when declaring nodes.
  Resuming only requires the checkpoint coordinates (<code>lineage_id</code> +
  <code>checkpoint_id</code>).</li>
</ul>
<p>Enable static interrupts:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-40-1">1</a></span>
<span class="normal"><a href="#__codelineno-40-2">2</a></span>
<span class="normal"><a href="#__codelineno-40-3">3</a></span>
<span class="normal"><a href="#__codelineno-40-4">4</a></span>
<span class="normal"><a href="#__codelineno-40-5">5</a></span>
<span class="normal"><a href="#__codelineno-40-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-40-1"><a id="__codelineno-40-1" name="__codelineno-40-1"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;my_node&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">fn</span><span class="p">,</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithInterruptBefore</span><span class="p">())</span>
</span><span id="__span-40-2"><a id="__codelineno-40-2" name="__codelineno-40-2"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;my_node&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">fn</span><span class="p">,</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithInterruptAfter</span><span class="p">())</span>
</span><span id="__span-40-3"><a id="__codelineno-40-3" name="__codelineno-40-3"></a>
</span><span id="__span-40-4"><a id="__codelineno-40-4" name="__codelineno-40-4"></a><span class="c1">// Or enable by node IDs after building nodes:</span>
</span><span id="__span-40-5"><a id="__codelineno-40-5" name="__codelineno-40-5"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">WithInterruptBeforeNodes</span><span class="p">(</span><span class="s">&quot;my_node&quot;</span><span class="p">)</span>
</span><span id="__span-40-6"><a id="__codelineno-40-6" name="__codelineno-40-6"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">WithInterruptAfterNodes</span><span class="p">(</span><span class="s">&quot;my_node&quot;</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>When a static interrupt is triggered, the executor raises an
<code>*graph.InterruptError</code> with:</p>
<ul>
<li><code>Key</code> prefixed by <code>graph.StaticInterruptKeyPrefixBefore</code> or
  <code>graph.StaticInterruptKeyPrefixAfter</code></li>
<li><code>Value</code> set to <code>graph.StaticInterruptPayload</code> (<code>phase</code>, <code>nodes</code>,
  <code>activeNodes</code>)</li>
</ul>
<p>Resuming:</p>
<ul>
<li>Run again with the same <code>lineage_id</code> and the <code>checkpoint_id</code> returned by the
  interrupt event.</li>
<li>No resume input is required because no node called <code>graph.Interrupt(...)</code>.</li>
</ul>
<p>See <code>examples/graph/static_interrupt</code> for an end-to-end runnable demo.</p>
<h3 id="execution">Execution</h3>
<ul>
<li>Wrap the compiled graph with <code>graphagent.New</code> (as a generic <code>agent.Agent</code>) and hand it to <code>runner.Runner</code> to manage sessions and streaming events.</li>
</ul>
<p>Minimal GraphAgent + Runner:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-41-1">1</a></span>
<span class="normal"><a href="#__codelineno-41-2">2</a></span>
<span class="normal"><a href="#__codelineno-41-3">3</a></span>
<span class="normal"><a href="#__codelineno-41-4">4</a></span>
<span class="normal"><a href="#__codelineno-41-5">5</a></span>
<span class="normal"><a href="#__codelineno-41-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-41-1"><a id="__codelineno-41-1" name="__codelineno-41-1"></a><span class="nx">compiled</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">buildWorkflow</span><span class="p">(</span><span class="nx">openai</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;gpt-4o-mini&quot;</span><span class="p">),</span><span class="w"> </span><span class="kc">nil</span><span class="p">)</span>
</span><span id="__span-41-2"><a id="__codelineno-41-2" name="__codelineno-41-2"></a><span class="nx">ga</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;demo&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">compiled</span><span class="p">)</span>
</span><span id="__span-41-3"><a id="__codelineno-41-3" name="__codelineno-41-3"></a><span class="nx">app</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">runner</span><span class="p">.</span><span class="nx">NewRunner</span><span class="p">(</span><span class="s">&quot;app&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">ga</span><span class="p">)</span>
</span><span id="__span-41-4"><a id="__codelineno-41-4" name="__codelineno-41-4"></a>
</span><span id="__span-41-5"><a id="__codelineno-41-5" name="__codelineno-41-5"></a><span class="nx">events</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">app</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;user&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;session&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">model</span><span class="p">.</span><span class="nx">NewUserMessage</span><span class="p">(</span><span class="s">&quot;hi&quot;</span><span class="p">))</span>
</span><span id="__span-41-6"><a id="__codelineno-41-6" name="__codelineno-41-6"></a><span class="k">for</span><span class="w"> </span><span class="nx">ev</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">events</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* handle events */</span><span class="w"> </span><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>Session backends:</p>
<ul>
<li>In-memory: <code>session/inmemory</code> (used by examples)</li>
<li>Redis: <code>session/redis</code> (more common in production)</li>
</ul>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-42-1">1</a></span>
<span class="normal"><a href="#__codelineno-42-2">2</a></span>
<span class="normal"><a href="#__codelineno-42-3">3</a></span>
<span class="normal"><a href="#__codelineno-42-4">4</a></span>
<span class="normal"><a href="#__codelineno-42-5">5</a></span>
<span class="normal"><a href="#__codelineno-42-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-42-1"><a id="__codelineno-42-1" name="__codelineno-42-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-42-2"><a id="__codelineno-42-2" name="__codelineno-42-2"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/session/redis&quot;</span>
</span><span id="__span-42-3"><a id="__codelineno-42-3" name="__codelineno-42-3"></a><span class="p">)</span>
</span><span id="__span-42-4"><a id="__codelineno-42-4" name="__codelineno-42-4"></a>
</span><span id="__span-42-5"><a id="__codelineno-42-5" name="__codelineno-42-5"></a><span class="nx">sess</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">redis</span><span class="p">.</span><span class="nx">NewService</span><span class="p">(</span><span class="nx">redis</span><span class="p">.</span><span class="nx">WithRedisClientURL</span><span class="p">(</span><span class="s">&quot;redis://localhost:6379&quot;</span><span class="p">))</span>
</span><span id="__span-42-6"><a id="__codelineno-42-6" name="__codelineno-42-6"></a><span class="nx">app</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">runner</span><span class="p">.</span><span class="nx">NewRunner</span><span class="p">(</span><span class="s">&quot;app&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">ga</span><span class="p">,</span><span class="w"> </span><span class="nx">runner</span><span class="p">.</span><span class="nx">WithSessionService</span><span class="p">(</span><span class="nx">sess</span><span class="p">))</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="graphagent-options">GraphAgent Options</h3>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-43-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-43-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-43-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-43-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-43-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-43-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-43-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-43-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-43-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-43-10">10</a></span>
<span class="normal"><a href="#__codelineno-43-11">11</a></span>
<span class="normal"><a href="#__codelineno-43-12">12</a></span>
<span class="normal"><a href="#__codelineno-43-13">13</a></span>
<span class="normal"><a href="#__codelineno-43-14">14</a></span>
<span class="normal"><a href="#__codelineno-43-15">15</a></span>
<span class="normal"><a href="#__codelineno-43-16">16</a></span>
<span class="normal"><a href="#__codelineno-43-17">17</a></span>
<span class="normal"><a href="#__codelineno-43-18">18</a></span>
<span class="normal"><a href="#__codelineno-43-19">19</a></span>
<span class="normal"><a href="#__codelineno-43-20">20</a></span>
<span class="normal"><a href="#__codelineno-43-21">21</a></span>
<span class="normal"><a href="#__codelineno-43-22">22</a></span>
<span class="normal"><a href="#__codelineno-43-23">23</a></span>
<span class="normal"><a href="#__codelineno-43-24">24</a></span>
<span class="normal"><a href="#__codelineno-43-25">25</a></span>
<span class="normal"><a href="#__codelineno-43-26">26</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-43-1"><a id="__codelineno-43-1" name="__codelineno-43-1"></a><span class="nx">ga</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span>
</span><span id="__span-43-2"><a id="__codelineno-43-2" name="__codelineno-43-2"></a><span class="w">    </span><span class="s">&quot;workflow&quot;</span><span class="p">,</span>
</span><span id="__span-43-3"><a id="__codelineno-43-3" name="__codelineno-43-3"></a><span class="w">    </span><span class="nx">compiledGraph</span><span class="p">,</span>
</span><span id="__span-43-4"><a id="__codelineno-43-4" name="__codelineno-43-4"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithDescription</span><span class="p">(</span><span class="s">&quot;Workflow description&quot;</span><span class="p">),</span>
</span><span id="__span-43-5"><a id="__codelineno-43-5" name="__codelineno-43-5"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithInitialState</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="s">&quot;init&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">}),</span>
</span><span id="__span-43-6"><a id="__codelineno-43-6" name="__codelineno-43-6"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithChannelBufferSize</span><span class="p">(</span><span class="mi">512</span><span class="p">),</span>
</span><span id="__span-43-7"><a id="__codelineno-43-7" name="__codelineno-43-7"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithCheckpointSaver</span><span class="p">(</span><span class="nx">saver</span><span class="p">),</span>
</span><span id="__span-43-8"><a id="__codelineno-43-8" name="__codelineno-43-8"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithSubAgents</span><span class="p">([]</span><span class="nx">agent</span><span class="p">.</span><span class="nx">Agent</span><span class="p">{</span><span class="nx">subAgent</span><span class="p">}),</span><span class="w"> </span><span class="c1">// Set Subagents</span>
</span><span id="__span-43-9"><a id="__codelineno-43-9" name="__codelineno-43-9"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithAgentCallbacks</span><span class="p">(</span><span class="nx">agent</span><span class="p">.</span><span class="nx">NewCallbacks</span><span class="p">()),</span><span class="w"> </span><span class="c1">// Note: Structured callback API requires trpc-agent-go &gt;= 0.6.0</span>
</span><span id="__span-43-10"><a id="__codelineno-43-10" name="__codelineno-43-10"></a><span class="w">    </span><span class="c1">// Set the filter mode for messages passed to the model. The final messages passed to the model must satisfy both WithMessageTimelineFilterMode and WithMessageBranchFilterMode conditions.</span>
</span><span id="__span-43-11"><a id="__codelineno-43-11" name="__codelineno-43-11"></a><span class="w">    </span><span class="c1">// Timeline dimension filter conditions</span>
</span><span id="__span-43-12"><a id="__codelineno-43-12" name="__codelineno-43-12"></a><span class="w">    </span><span class="c1">// Default: graphagent.TimelineFilterAll</span>
</span><span id="__span-43-13"><a id="__codelineno-43-13" name="__codelineno-43-13"></a><span class="w">    </span><span class="c1">// Optional values:</span>
</span><span id="__span-43-14"><a id="__codelineno-43-14" name="__codelineno-43-14"></a><span class="w">    </span><span class="c1">//  - graphagent.TimelineFilterAll: Includes historical messages as well as messages generated in the current request</span>
</span><span id="__span-43-15"><a id="__codelineno-43-15" name="__codelineno-43-15"></a><span class="w">    </span><span class="c1">//  - graphagent.TimelineFilterCurrentRequest: Only includes messages generated in the current request</span>
</span><span id="__span-43-16"><a id="__codelineno-43-16" name="__codelineno-43-16"></a><span class="w">    </span><span class="c1">//  - graphagent.TimelineFilterCurrentInvocation: Only includes messages generated in the current invocation context</span>
</span><span id="__span-43-17"><a id="__codelineno-43-17" name="__codelineno-43-17"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithMessageTimelineFilterMode</span><span class="p">(</span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">TimelineFilterAll</span><span class="p">),</span>
</span><span id="__span-43-18"><a id="__codelineno-43-18" name="__codelineno-43-18"></a>
</span><span id="__span-43-19"><a id="__codelineno-43-19" name="__codelineno-43-19"></a><span class="w">    </span><span class="c1">// Branch dimension filter conditions</span>
</span><span id="__span-43-20"><a id="__codelineno-43-20" name="__codelineno-43-20"></a><span class="w">    </span><span class="c1">// Default: graphagent.BranchFilterModePrefix</span>
</span><span id="__span-43-21"><a id="__codelineno-43-21" name="__codelineno-43-21"></a><span class="w">    </span><span class="c1">// Optional values:</span>
</span><span id="__span-43-22"><a id="__codelineno-43-22" name="__codelineno-43-22"></a><span class="w">    </span><span class="c1">//  - graphagent.BranchFilterModeAll: Includes messages from all agents. Use this when the current agent interacts with the model and needs to synchronize all valid content messages generated by all agents to the model.</span>
</span><span id="__span-43-23"><a id="__codelineno-43-23" name="__codelineno-43-23"></a><span class="w">    </span><span class="c1">//  - graphagent.BranchFilterModePrefix: Filters messages by prefix matching Event.FilterKey with Invocation.eventFilterKey. Use this when you want to pass messages generated by the current agent and related upstream/downstream agents to the model.</span>
</span><span id="__span-43-24"><a id="__codelineno-43-24" name="__codelineno-43-24"></a><span class="w">    </span><span class="c1">//  - graphagent.BranchFilterModeExact: Filters messages where Event.FilterKey == Invocation.eventFilterKey. Use this when the current agent interacts with the model and only needs to use messages generated by the current agent.</span>
</span><span id="__span-43-25"><a id="__codelineno-43-25" name="__codelineno-43-25"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithMessageBranchFilterMode</span><span class="p">(</span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">BranchFilterModeAll</span><span class="p">),</span>
</span><span id="__span-43-26"><a id="__codelineno-43-26" name="__codelineno-43-26"></a><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<h2 id="core-concepts_1">Core Concepts</h2>
<h3 id="state-management">State Management</h3>
<p>GraphAgent uses a Schema + Reducer model to manage state. You first define the state shape and merge rules; later nodes have clear expectations about the origin and lifecycle of keys they read/write.</p>
<h4 id="builtin-schema">Built‑in Schema</h4>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-44-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-44-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-44-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-44-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-44-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-44-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-44-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-44-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-44-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-44-10">10</a></span>
<span class="normal"><a href="#__codelineno-44-11">11</a></span>
<span class="normal"><a href="#__codelineno-44-12">12</a></span>
<span class="normal"><a href="#__codelineno-44-13">13</a></span>
<span class="normal"><a href="#__codelineno-44-14">14</a></span>
<span class="normal"><a href="#__codelineno-44-15">15</a></span>
<span class="normal"><a href="#__codelineno-44-16">16</a></span>
<span class="normal"><a href="#__codelineno-44-17">17</a></span>
<span class="normal"><a href="#__codelineno-44-18">18</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-44-1"><a id="__codelineno-44-1" name="__codelineno-44-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-44-2"><a id="__codelineno-44-2" name="__codelineno-44-2"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-44-3"><a id="__codelineno-44-3" name="__codelineno-44-3"></a><span class="p">)</span>
</span><span id="__span-44-4"><a id="__codelineno-44-4" name="__codelineno-44-4"></a>
</span><span id="__span-44-5"><a id="__codelineno-44-5" name="__codelineno-44-5"></a><span class="nx">schema</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">MessagesStateSchema</span><span class="p">()</span>
</span><span id="__span-44-6"><a id="__codelineno-44-6" name="__codelineno-44-6"></a>
</span><span id="__span-44-7"><a id="__codelineno-44-7" name="__codelineno-44-7"></a><span class="c1">// Predefined fields (key constants) and semantics:</span>
</span><span id="__span-44-8"><a id="__codelineno-44-8" name="__codelineno-44-8"></a><span class="c1">// - graph.StateKeyMessages       (&quot;messages&quot;)        Conversation history ([]model.Message; MessageReducer + MessageOp for atomic updates)</span>
</span><span id="__span-44-9"><a id="__codelineno-44-9" name="__codelineno-44-9"></a><span class="c1">// - graph.StateKeyUserInput      (&quot;user_input&quot;)      User input (string; one-shot; cleared after successful execution)</span>
</span><span id="__span-44-10"><a id="__codelineno-44-10" name="__codelineno-44-10"></a><span class="c1">// - graph.StateKeyLastResponse   (&quot;last_response&quot;)   Last response (string)</span>
</span><span id="__span-44-11"><a id="__codelineno-44-11" name="__codelineno-44-11"></a><span class="c1">// - graph.StateKeyNodeResponses  (&quot;node_responses&quot;)  Per-node outputs (map[string]any; aggregated across parallel branches)</span>
</span><span id="__span-44-12"><a id="__codelineno-44-12" name="__codelineno-44-12"></a><span class="c1">// - graph.StateKeyMetadata       (&quot;metadata&quot;)        Metadata (map[string]any; merged by MergeReducer)</span>
</span><span id="__span-44-13"><a id="__codelineno-44-13" name="__codelineno-44-13"></a>
</span><span id="__span-44-14"><a id="__codelineno-44-14" name="__codelineno-44-14"></a><span class="c1">// Additional one-shot/system keys (use as needed):</span>
</span><span id="__span-44-15"><a id="__codelineno-44-15" name="__codelineno-44-15"></a><span class="c1">// - graph.StateKeyOneShotMessages (&quot;one_shot_messages&quot;)  One-shot override of this turn&#39;s input ([]model.Message)</span>
</span><span id="__span-44-16"><a id="__codelineno-44-16" name="__codelineno-44-16"></a><span class="c1">// - graph.StateKeyOneShotMessagesByNode (&quot;one_shot_messages_by_node&quot;)  One-shot override scoped by node ID (map[string][]model.Message)</span>
</span><span id="__span-44-17"><a id="__codelineno-44-17" name="__codelineno-44-17"></a><span class="c1">// - graph.StateKeySession         (&quot;session&quot;)            Session object (internal)</span>
</span><span id="__span-44-18"><a id="__codelineno-44-18" name="__codelineno-44-18"></a><span class="c1">// - graph.StateKeyExecContext     (&quot;exec_context&quot;)       Execution context (events etc., internal)</span>
</span></code></pre></div></td></tr></table></div>
<h4 id="custom-schema">Custom Schema</h4>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-45-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-45-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-45-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-45-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-45-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-45-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-45-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-45-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-45-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-45-10">10</a></span>
<span class="normal"><a href="#__codelineno-45-11">11</a></span>
<span class="normal"><a href="#__codelineno-45-12">12</a></span>
<span class="normal"><a href="#__codelineno-45-13">13</a></span>
<span class="normal"><a href="#__codelineno-45-14">14</a></span>
<span class="normal"><a href="#__codelineno-45-15">15</a></span>
<span class="normal"><a href="#__codelineno-45-16">16</a></span>
<span class="normal"><a href="#__codelineno-45-17">17</a></span>
<span class="normal"><a href="#__codelineno-45-18">18</a></span>
<span class="normal"><a href="#__codelineno-45-19">19</a></span>
<span class="normal"><a href="#__codelineno-45-20">20</a></span>
<span class="normal"><a href="#__codelineno-45-21">21</a></span>
<span class="normal"><a href="#__codelineno-45-22">22</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-45-1"><a id="__codelineno-45-1" name="__codelineno-45-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-45-2"><a id="__codelineno-45-2" name="__codelineno-45-2"></a><span class="w">    </span><span class="s">&quot;reflect&quot;</span>
</span><span id="__span-45-3"><a id="__codelineno-45-3" name="__codelineno-45-3"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-45-4"><a id="__codelineno-45-4" name="__codelineno-45-4"></a><span class="p">)</span>
</span><span id="__span-45-5"><a id="__codelineno-45-5" name="__codelineno-45-5"></a>
</span><span id="__span-45-6"><a id="__codelineno-45-6" name="__codelineno-45-6"></a><span class="nx">schema</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateSchema</span><span class="p">()</span>
</span><span id="__span-45-7"><a id="__codelineno-45-7" name="__codelineno-45-7"></a>
</span><span id="__span-45-8"><a id="__codelineno-45-8" name="__codelineno-45-8"></a><span class="c1">// Add a custom field</span>
</span><span id="__span-45-9"><a id="__codelineno-45-9" name="__codelineno-45-9"></a><span class="nx">schema</span><span class="p">.</span><span class="nx">AddField</span><span class="p">(</span><span class="s">&quot;counter&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateField</span><span class="p">{</span>
</span><span id="__span-45-10"><a id="__codelineno-45-10" name="__codelineno-45-10"></a><span class="w">    </span><span class="nx">Type</span><span class="p">:</span><span class="w">    </span><span class="nx">reflect</span><span class="p">.</span><span class="nx">TypeOf</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span><span id="__span-45-11"><a id="__codelineno-45-11" name="__codelineno-45-11"></a><span class="w">    </span><span class="nx">Default</span><span class="p">:</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="kt">any</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">},</span>
</span><span id="__span-45-12"><a id="__codelineno-45-12" name="__codelineno-45-12"></a><span class="w">    </span><span class="nx">Reducer</span><span class="p">:</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">old</span><span class="p">,</span><span class="w"> </span><span class="nx">new</span><span class="w"> </span><span class="kt">any</span><span class="p">)</span><span class="w"> </span><span class="kt">any</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-45-13"><a id="__codelineno-45-13" name="__codelineno-45-13"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">old</span><span class="p">.(</span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">new</span><span class="p">.(</span><span class="kt">int</span><span class="p">)</span><span class="w">  </span><span class="c1">// accumulate</span>
</span><span id="__span-45-14"><a id="__codelineno-45-14" name="__codelineno-45-14"></a><span class="w">    </span><span class="p">},</span>
</span><span id="__span-45-15"><a id="__codelineno-45-15" name="__codelineno-45-15"></a><span class="p">})</span>
</span><span id="__span-45-16"><a id="__codelineno-45-16" name="__codelineno-45-16"></a>
</span><span id="__span-45-17"><a id="__codelineno-45-17" name="__codelineno-45-17"></a><span class="c1">// String slice with a built-in reducer</span>
</span><span id="__span-45-18"><a id="__codelineno-45-18" name="__codelineno-45-18"></a><span class="nx">schema</span><span class="p">.</span><span class="nx">AddField</span><span class="p">(</span><span class="s">&quot;items&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateField</span><span class="p">{</span>
</span><span id="__span-45-19"><a id="__codelineno-45-19" name="__codelineno-45-19"></a><span class="w">    </span><span class="nx">Type</span><span class="p">:</span><span class="w">    </span><span class="nx">reflect</span><span class="p">.</span><span class="nx">TypeOf</span><span class="p">([]</span><span class="kt">string</span><span class="p">{}),</span>
</span><span id="__span-45-20"><a id="__codelineno-45-20" name="__codelineno-45-20"></a><span class="w">    </span><span class="nx">Default</span><span class="p">:</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="kt">any</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="p">[]</span><span class="kt">string</span><span class="p">{}</span><span class="w"> </span><span class="p">},</span>
</span><span id="__span-45-21"><a id="__codelineno-45-21" name="__codelineno-45-21"></a><span class="w">    </span><span class="nx">Reducer</span><span class="p">:</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">StringSliceReducer</span><span class="p">,</span>
</span><span id="__span-45-22"><a id="__codelineno-45-22" name="__codelineno-45-22"></a><span class="p">})</span>
</span></code></pre></div></td></tr></table></div>
<p>Reducers ensure fields are merged safely per predefined rules, which is critical under concurrent execution.</p>
<p>Tip: define constants for business keys to avoid scattered magic strings.</p>
<h3 id="node-types">Node Types</h3>
<p>GraphAgent provides four built‑in node types:</p>
<h4 id="function-node">Function Node</h4>
<p>The most basic node, for custom logic:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-46-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-46-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-46-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-46-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-46-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-46-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-46-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-46-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-46-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-46-10">10</a></span>
<span class="normal"><a href="#__codelineno-46-11">11</a></span>
<span class="normal"><a href="#__codelineno-46-12">12</a></span>
<span class="normal"><a href="#__codelineno-46-13">13</a></span>
<span class="normal"><a href="#__codelineno-46-14">14</a></span>
<span class="normal"><a href="#__codelineno-46-15">15</a></span>
<span class="normal"><a href="#__codelineno-46-16">16</a></span>
<span class="normal"><a href="#__codelineno-46-17">17</a></span>
<span class="normal"><a href="#__codelineno-46-18">18</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-46-1"><a id="__codelineno-46-1" name="__codelineno-46-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-46-2"><a id="__codelineno-46-2" name="__codelineno-46-2"></a><span class="w">    </span><span class="s">&quot;context&quot;</span>
</span><span id="__span-46-3"><a id="__codelineno-46-3" name="__codelineno-46-3"></a>
</span><span id="__span-46-4"><a id="__codelineno-46-4" name="__codelineno-46-4"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-46-5"><a id="__codelineno-46-5" name="__codelineno-46-5"></a><span class="p">)</span>
</span><span id="__span-46-6"><a id="__codelineno-46-6" name="__codelineno-46-6"></a>
</span><span id="__span-46-7"><a id="__codelineno-46-7" name="__codelineno-46-7"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-46-8"><a id="__codelineno-46-8" name="__codelineno-46-8"></a><span class="w">    </span><span class="nx">stateKeyInput</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;input&quot;</span>
</span><span id="__span-46-9"><a id="__codelineno-46-9" name="__codelineno-46-9"></a><span class="w">    </span><span class="nx">stateKeyOutput</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;output&quot;</span>
</span><span id="__span-46-10"><a id="__codelineno-46-10" name="__codelineno-46-10"></a><span class="w">    </span><span class="nx">nodeProcess</span><span class="w">    </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;process&quot;</span>
</span><span id="__span-46-11"><a id="__codelineno-46-11" name="__codelineno-46-11"></a><span class="p">)</span>
</span><span id="__span-46-12"><a id="__codelineno-46-12" name="__codelineno-46-12"></a>
</span><span id="__span-46-13"><a id="__codelineno-46-13" name="__codelineno-46-13"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="nx">nodeProcess</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-46-14"><a id="__codelineno-46-14" name="__codelineno-46-14"></a><span class="w">    </span><span class="nx">data</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">state</span><span class="p">[</span><span class="nx">stateKeyInput</span><span class="p">].(</span><span class="kt">string</span><span class="p">)</span>
</span><span id="__span-46-15"><a id="__codelineno-46-15" name="__codelineno-46-15"></a><span class="w">    </span><span class="nx">processed</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">transform</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
</span><span id="__span-46-16"><a id="__codelineno-46-16" name="__codelineno-46-16"></a><span class="w">    </span><span class="c1">// Function nodes must explicitly specify the output key</span>
</span><span id="__span-46-17"><a id="__codelineno-46-17" name="__codelineno-46-17"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="nx">stateKeyOutput</span><span class="p">:</span><span class="w"> </span><span class="nx">processed</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-46-18"><a id="__codelineno-46-18" name="__codelineno-46-18"></a><span class="p">})</span>
</span></code></pre></div></td></tr></table></div>
<h4 id="llm-node">LLM Node</h4>
<p>Integrates an LLM and auto‑manages conversation history:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-47-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-47-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-47-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-47-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-47-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-47-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-47-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-47-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-47-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-47-10">10</a></span>
<span class="normal"><a href="#__codelineno-47-11">11</a></span>
<span class="normal"><a href="#__codelineno-47-12">12</a></span>
<span class="normal"><a href="#__codelineno-47-13">13</a></span>
<span class="normal"><a href="#__codelineno-47-14">14</a></span>
<span class="normal"><a href="#__codelineno-47-15">15</a></span>
<span class="normal"><a href="#__codelineno-47-16">16</a></span>
<span class="normal"><a href="#__codelineno-47-17">17</a></span>
<span class="normal"><a href="#__codelineno-47-18">18</a></span>
<span class="normal"><a href="#__codelineno-47-19">19</a></span>
<span class="normal"><a href="#__codelineno-47-20">20</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-47-1"><a id="__codelineno-47-1" name="__codelineno-47-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-47-2"><a id="__codelineno-47-2" name="__codelineno-47-2"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-47-3"><a id="__codelineno-47-3" name="__codelineno-47-3"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/model/openai&quot;</span>
</span><span id="__span-47-4"><a id="__codelineno-47-4" name="__codelineno-47-4"></a><span class="p">)</span>
</span><span id="__span-47-5"><a id="__codelineno-47-5" name="__codelineno-47-5"></a>
</span><span id="__span-47-6"><a id="__codelineno-47-6" name="__codelineno-47-6"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-47-7"><a id="__codelineno-47-7" name="__codelineno-47-7"></a><span class="w">    </span><span class="nx">llmModelName</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;gpt-4o-mini&quot;</span>
</span><span id="__span-47-8"><a id="__codelineno-47-8" name="__codelineno-47-8"></a><span class="w">    </span><span class="nx">llmSystemPrompt</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;System prompt&quot;</span>
</span><span id="__span-47-9"><a id="__codelineno-47-9" name="__codelineno-47-9"></a><span class="w">    </span><span class="nx">llmNodeAssistant</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;assistant&quot;</span>
</span><span id="__span-47-10"><a id="__codelineno-47-10" name="__codelineno-47-10"></a><span class="p">)</span>
</span><span id="__span-47-11"><a id="__codelineno-47-11" name="__codelineno-47-11"></a>
</span><span id="__span-47-12"><a id="__codelineno-47-12" name="__codelineno-47-12"></a><span class="nx">model</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">openai</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="nx">llmModelName</span><span class="p">)</span>
</span><span id="__span-47-13"><a id="__codelineno-47-13" name="__codelineno-47-13"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddLLMNode</span><span class="p">(</span><span class="nx">llmNodeAssistant</span><span class="p">,</span><span class="w"> </span><span class="nx">model</span><span class="p">,</span><span class="w"> </span><span class="nx">llmSystemPrompt</span><span class="p">,</span><span class="w"> </span><span class="nx">tools</span><span class="p">)</span>
</span><span id="__span-47-14"><a id="__codelineno-47-14" name="__codelineno-47-14"></a>
</span><span id="__span-47-15"><a id="__codelineno-47-15" name="__codelineno-47-15"></a><span class="c1">// Inputs (priority):</span>
</span><span id="__span-47-16"><a id="__codelineno-47-16" name="__codelineno-47-16"></a><span class="c1">// graph.StateKeyOneShotMessagesByNode[&lt;node_id&gt;] &gt;</span>
</span><span id="__span-47-17"><a id="__codelineno-47-17" name="__codelineno-47-17"></a><span class="c1">// graph.StateKeyOneShotMessages &gt;</span>
</span><span id="__span-47-18"><a id="__codelineno-47-18" name="__codelineno-47-18"></a><span class="c1">// graph.StateKeyUserInput &gt;</span>
</span><span id="__span-47-19"><a id="__codelineno-47-19" name="__codelineno-47-19"></a><span class="c1">// graph.StateKeyMessages</span>
</span><span id="__span-47-20"><a id="__codelineno-47-20" name="__codelineno-47-20"></a><span class="c1">// Outputs: graph.StateKeyLastResponse, graph.StateKeyMessages (atomic), graph.StateKeyNodeResponses (includes this node&#39;s output for aggregation)</span>
</span></code></pre></div></td></tr></table></div>
<h2 id="node-cache">Node Cache</h2>
<p>Enable caching for pure function-like nodes to avoid repeated computation.</p>
<ul>
<li>Graph-level settings:<ul>
<li><code>WithCache(cache Cache)</code> sets the cache backend (an in-memory implementation is provided for testing)</li>
<li><code>WithCachePolicy(policy *CachePolicy)</code> sets the default cache policy (key function + Time To Live, TTL)</li>
</ul>
</li>
<li>Node-level override: <code>WithNodeCachePolicy(policy *CachePolicy)</code></li>
<li>Clear by nodes: <code>ClearCache(nodes ...string)</code></li>
</ul>
<p>References:</p>
<ul>
<li>Graph accessors and setters: <a href="https://github.com/trpc-group/trpc-agent-go/blob/main/graph/graph.go">graph/graph.go</a></li>
<li>Defaults and in-memory backend:<ul>
<li>Interface/policy + canonical JSON + SHA‑256: <a href="https://github.com/trpc-group/trpc-agent-go/blob/main/graph/cache.go">graph/cache.go</a></li>
<li>In-memory cache with read-write lock and deep copy: <a href="https://github.com/trpc-group/trpc-agent-go/blob/main/graph/cache.go">graph/cache.go</a></li>
</ul>
</li>
<li>Executor:<ul>
<li>Try Get before executing a node; on hit, skip the node function and only run callbacks + writes: <a href="https://github.com/trpc-group/trpc-agent-go/blob/main/graph/executor.go">graph/executor.go</a></li>
<li>Persist Set after successful execution: <a href="https://github.com/trpc-group/trpc-agent-go/blob/main/graph/executor.go">graph/executor.go</a></li>
<li>Attach <code>_cache_hit</code> flag on node.complete events: <a href="https://github.com/trpc-group/trpc-agent-go/blob/main/graph/executor.go">graph/executor.go</a></li>
</ul>
</li>
</ul>
<p>Minimal usage:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-48-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-48-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-48-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-48-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-48-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-48-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-48-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-48-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-48-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-48-10">10</a></span>
<span class="normal"><a href="#__codelineno-48-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-48-1"><a id="__codelineno-48-1" name="__codelineno-48-1"></a><span class="nx">schema</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateSchema</span><span class="p">()</span>
</span><span id="__span-48-2"><a id="__codelineno-48-2" name="__codelineno-48-2"></a><span class="nx">sg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateGraph</span><span class="p">(</span><span class="nx">schema</span><span class="p">).</span>
</span><span id="__span-48-3"><a id="__codelineno-48-3" name="__codelineno-48-3"></a><span class="w">  </span><span class="nx">WithCache</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewInMemoryCache</span><span class="p">()).</span>
</span><span id="__span-48-4"><a id="__codelineno-48-4" name="__codelineno-48-4"></a><span class="w">  </span><span class="nx">WithCachePolicy</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">DefaultCachePolicy</span><span class="p">())</span>
</span><span id="__span-48-5"><a id="__codelineno-48-5" name="__codelineno-48-5"></a>
</span><span id="__span-48-6"><a id="__codelineno-48-6" name="__codelineno-48-6"></a><span class="nx">nodePolicy</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">graph</span><span class="p">.</span><span class="nx">CachePolicy</span><span class="p">{</span><span class="nx">KeyFunc</span><span class="p">:</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">DefaultCachePolicy</span><span class="p">().</span><span class="nx">KeyFunc</span><span class="p">,</span><span class="w"> </span><span class="nx">TTL</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span><span class="p">}</span>
</span><span id="__span-48-7"><a id="__codelineno-48-7" name="__codelineno-48-7"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;compute&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">computeFunc</span><span class="p">,</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithNodeCachePolicy</span><span class="p">(</span><span class="nx">nodePolicy</span><span class="p">)).</span>
</span><span id="__span-48-8"><a id="__codelineno-48-8" name="__codelineno-48-8"></a><span class="w">  </span><span class="nx">SetEntryPoint</span><span class="p">(</span><span class="s">&quot;compute&quot;</span><span class="p">).</span>
</span><span id="__span-48-9"><a id="__codelineno-48-9" name="__codelineno-48-9"></a><span class="w">  </span><span class="nx">SetFinishPoint</span><span class="p">(</span><span class="s">&quot;compute&quot;</span><span class="p">)</span>
</span><span id="__span-48-10"><a id="__codelineno-48-10" name="__codelineno-48-10"></a>
</span><span id="__span-48-11"><a id="__codelineno-48-11" name="__codelineno-48-11"></a><span class="nx">compiled</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">sg</span><span class="p">.</span><span class="nx">Compile</span><span class="p">()</span>
</span></code></pre></div></td></tr></table></div>
<p>Advanced usage:</p>
<ul>
<li>Field-based keys (recommended)</li>
</ul>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-49-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-49-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-49-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-49-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-49-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-49-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-49-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-49-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-49-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-49-10">10</a></span>
<span class="normal"><a href="#__codelineno-49-11">11</a></span>
<span class="normal"><a href="#__codelineno-49-12">12</a></span>
<span class="normal"><a href="#__codelineno-49-13">13</a></span>
<span class="normal"><a href="#__codelineno-49-14">14</a></span>
<span class="normal"><a href="#__codelineno-49-15">15</a></span>
<span class="normal"><a href="#__codelineno-49-16">16</a></span>
<span class="normal"><a href="#__codelineno-49-17">17</a></span>
<span class="normal"><a href="#__codelineno-49-18">18</a></span>
<span class="normal"><a href="#__codelineno-49-19">19</a></span>
<span class="normal"><a href="#__codelineno-49-20">20</a></span>
<span class="normal"><a href="#__codelineno-49-21">21</a></span>
<span class="normal"><a href="#__codelineno-49-22">22</a></span>
<span class="normal"><a href="#__codelineno-49-23">23</a></span>
<span class="normal"><a href="#__codelineno-49-24">24</a></span>
<span class="normal"><a href="#__codelineno-49-25">25</a></span>
<span class="normal"><a href="#__codelineno-49-26">26</a></span>
<span class="normal"><a href="#__codelineno-49-27">27</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-49-1"><a id="__codelineno-49-1" name="__codelineno-49-1"></a><span class="kn">package</span><span class="w"> </span><span class="nx">main</span>
</span><span id="__span-49-2"><a id="__codelineno-49-2" name="__codelineno-49-2"></a>
</span><span id="__span-49-3"><a id="__codelineno-49-3" name="__codelineno-49-3"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-49-4"><a id="__codelineno-49-4" name="__codelineno-49-4"></a><span class="w">    </span><span class="s">&quot;context&quot;</span>
</span><span id="__span-49-5"><a id="__codelineno-49-5" name="__codelineno-49-5"></a><span class="w">    </span><span class="s">&quot;time&quot;</span>
</span><span id="__span-49-6"><a id="__codelineno-49-6" name="__codelineno-49-6"></a>
</span><span id="__span-49-7"><a id="__codelineno-49-7" name="__codelineno-49-7"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-49-8"><a id="__codelineno-49-8" name="__codelineno-49-8"></a><span class="p">)</span>
</span><span id="__span-49-9"><a id="__codelineno-49-9" name="__codelineno-49-9"></a>
</span><span id="__span-49-10"><a id="__codelineno-49-10" name="__codelineno-49-10"></a><span class="kd">func</span><span class="w"> </span><span class="nx">build</span><span class="p">()</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">graph</span><span class="p">.</span><span class="nx">Graph</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-49-11"><a id="__codelineno-49-11" name="__codelineno-49-11"></a><span class="w">    </span><span class="nx">schema</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateSchema</span><span class="p">()</span>
</span><span id="__span-49-12"><a id="__codelineno-49-12" name="__codelineno-49-12"></a><span class="w">    </span><span class="nx">sg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateGraph</span><span class="p">(</span><span class="nx">schema</span><span class="p">).</span>
</span><span id="__span-49-13"><a id="__codelineno-49-13" name="__codelineno-49-13"></a><span class="w">        </span><span class="nx">WithCache</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewInMemoryCache</span><span class="p">()).</span>
</span><span id="__span-49-14"><a id="__codelineno-49-14" name="__codelineno-49-14"></a><span class="w">        </span><span class="nx">WithCachePolicy</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">DefaultCachePolicy</span><span class="p">())</span>
</span><span id="__span-49-15"><a id="__codelineno-49-15" name="__codelineno-49-15"></a>
</span><span id="__span-49-16"><a id="__codelineno-49-16" name="__codelineno-49-16"></a><span class="w">    </span><span class="nx">compute</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-49-17"><a id="__codelineno-49-17" name="__codelineno-49-17"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="s">&quot;out&quot;</span><span class="p">:</span><span class="w"> </span><span class="nx">s</span><span class="p">[</span><span class="s">&quot;n&quot;</span><span class="p">].(</span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-49-18"><a id="__codelineno-49-18" name="__codelineno-49-18"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-49-19"><a id="__codelineno-49-19" name="__codelineno-49-19"></a>
</span><span id="__span-49-20"><a id="__codelineno-49-20" name="__codelineno-49-20"></a><span class="w">    </span><span class="c1">// Use only `n` and `user_id` for cache key derivation; other fields won&#39;t affect hits</span>
</span><span id="__span-49-21"><a id="__codelineno-49-21" name="__codelineno-49-21"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;compute&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">compute</span><span class="p">,</span>
</span><span id="__span-49-22"><a id="__codelineno-49-22" name="__codelineno-49-22"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithNodeCachePolicy</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">graph</span><span class="p">.</span><span class="nx">CachePolicy</span><span class="p">{</span><span class="nx">KeyFunc</span><span class="p">:</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">DefaultCachePolicy</span><span class="p">().</span><span class="nx">KeyFunc</span><span class="p">,</span><span class="w"> </span><span class="nx">TTL</span><span class="p">:</span><span class="w"> </span><span class="mi">30</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span><span class="p">}),</span>
</span><span id="__span-49-23"><a id="__codelineno-49-23" name="__codelineno-49-23"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithCacheKeyFields</span><span class="p">(</span><span class="s">&quot;n&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;user_id&quot;</span><span class="p">),</span>
</span><span id="__span-49-24"><a id="__codelineno-49-24" name="__codelineno-49-24"></a><span class="w">    </span><span class="p">)</span>
</span><span id="__span-49-25"><a id="__codelineno-49-25" name="__codelineno-49-25"></a>
</span><span id="__span-49-26"><a id="__codelineno-49-26" name="__codelineno-49-26"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">sg</span><span class="p">.</span><span class="nx">Compile</span><span class="p">()</span>
</span><span id="__span-49-27"><a id="__codelineno-49-27" name="__codelineno-49-27"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<ul>
<li>Custom selector (for complex projections)</li>
</ul>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-50-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-50-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-50-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-50-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-50-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-50-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-50-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-50-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-50-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-50-10">10</a></span>
<span class="normal"><a href="#__codelineno-50-11">11</a></span>
<span class="normal"><a href="#__codelineno-50-12">12</a></span>
<span class="normal"><a href="#__codelineno-50-13">13</a></span>
<span class="normal"><a href="#__codelineno-50-14">14</a></span>
<span class="normal"><a href="#__codelineno-50-15">15</a></span>
<span class="normal"><a href="#__codelineno-50-16">16</a></span>
<span class="normal"><a href="#__codelineno-50-17">17</a></span>
<span class="normal"><a href="#__codelineno-50-18">18</a></span>
<span class="normal"><a href="#__codelineno-50-19">19</a></span>
<span class="normal"><a href="#__codelineno-50-20">20</a></span>
<span class="normal"><a href="#__codelineno-50-21">21</a></span>
<span class="normal"><a href="#__codelineno-50-22">22</a></span>
<span class="normal"><a href="#__codelineno-50-23">23</a></span>
<span class="normal"><a href="#__codelineno-50-24">24</a></span>
<span class="normal"><a href="#__codelineno-50-25">25</a></span>
<span class="normal"><a href="#__codelineno-50-26">26</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-50-1"><a id="__codelineno-50-1" name="__codelineno-50-1"></a><span class="kn">package</span><span class="w"> </span><span class="nx">main</span>
</span><span id="__span-50-2"><a id="__codelineno-50-2" name="__codelineno-50-2"></a>
</span><span id="__span-50-3"><a id="__codelineno-50-3" name="__codelineno-50-3"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-50-4"><a id="__codelineno-50-4" name="__codelineno-50-4"></a><span class="w">    </span><span class="s">&quot;context&quot;</span>
</span><span id="__span-50-5"><a id="__codelineno-50-5" name="__codelineno-50-5"></a><span class="w">    </span><span class="s">&quot;time&quot;</span>
</span><span id="__span-50-6"><a id="__codelineno-50-6" name="__codelineno-50-6"></a>
</span><span id="__span-50-7"><a id="__codelineno-50-7" name="__codelineno-50-7"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-50-8"><a id="__codelineno-50-8" name="__codelineno-50-8"></a><span class="p">)</span>
</span><span id="__span-50-9"><a id="__codelineno-50-9" name="__codelineno-50-9"></a>
</span><span id="__span-50-10"><a id="__codelineno-50-10" name="__codelineno-50-10"></a><span class="kd">func</span><span class="w"> </span><span class="nx">build</span><span class="p">()</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">graph</span><span class="p">.</span><span class="nx">Graph</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-50-11"><a id="__codelineno-50-11" name="__codelineno-50-11"></a><span class="w">    </span><span class="nx">schema</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateSchema</span><span class="p">()</span>
</span><span id="__span-50-12"><a id="__codelineno-50-12" name="__codelineno-50-12"></a><span class="w">    </span><span class="nx">sg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateGraph</span><span class="p">(</span><span class="nx">schema</span><span class="p">).</span>
</span><span id="__span-50-13"><a id="__codelineno-50-13" name="__codelineno-50-13"></a><span class="w">        </span><span class="nx">WithCache</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewInMemoryCache</span><span class="p">()).</span>
</span><span id="__span-50-14"><a id="__codelineno-50-14" name="__codelineno-50-14"></a><span class="w">        </span><span class="nx">WithCachePolicy</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">DefaultCachePolicy</span><span class="p">())</span>
</span><span id="__span-50-15"><a id="__codelineno-50-15" name="__codelineno-50-15"></a>
</span><span id="__span-50-16"><a id="__codelineno-50-16" name="__codelineno-50-16"></a><span class="w">    </span><span class="nx">compute</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="s">&quot;out&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">42</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-50-17"><a id="__codelineno-50-17" name="__codelineno-50-17"></a>
</span><span id="__span-50-18"><a id="__codelineno-50-18" name="__codelineno-50-18"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;compute&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">compute</span><span class="p">,</span>
</span><span id="__span-50-19"><a id="__codelineno-50-19" name="__codelineno-50-19"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithNodeCachePolicy</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">graph</span><span class="p">.</span><span class="nx">CachePolicy</span><span class="p">{</span><span class="nx">KeyFunc</span><span class="p">:</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">DefaultCachePolicy</span><span class="p">().</span><span class="nx">KeyFunc</span><span class="p">,</span><span class="w"> </span><span class="nx">TTL</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span><span class="p">}),</span>
</span><span id="__span-50-20"><a id="__codelineno-50-20" name="__codelineno-50-20"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithCacheKeySelector</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">m</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">any</span><span class="p">)</span><span class="w"> </span><span class="kt">any</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-50-21"><a id="__codelineno-50-21" name="__codelineno-50-21"></a><span class="w">            </span><span class="c1">// derive cache key input from sanitized map</span>
</span><span id="__span-50-22"><a id="__codelineno-50-22" name="__codelineno-50-22"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">any</span><span class="p">{</span><span class="s">&quot;n&quot;</span><span class="p">:</span><span class="w"> </span><span class="nx">m</span><span class="p">[</span><span class="s">&quot;n&quot;</span><span class="p">],</span><span class="w"> </span><span class="s">&quot;uid&quot;</span><span class="p">:</span><span class="w"> </span><span class="nx">m</span><span class="p">[</span><span class="s">&quot;uid&quot;</span><span class="p">]}</span>
</span><span id="__span-50-23"><a id="__codelineno-50-23" name="__codelineno-50-23"></a><span class="w">        </span><span class="p">}),</span>
</span><span id="__span-50-24"><a id="__codelineno-50-24" name="__codelineno-50-24"></a><span class="w">    </span><span class="p">)</span>
</span><span id="__span-50-25"><a id="__codelineno-50-25" name="__codelineno-50-25"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">sg</span><span class="p">.</span><span class="nx">Compile</span><span class="p">()</span>
</span><span id="__span-50-26"><a id="__codelineno-50-26" name="__codelineno-50-26"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<ul>
<li>Versioned namespace (avoid stale cache across versions)</li>
</ul>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-51-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-51-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-51-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-51-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-51-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-51-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-51-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-51-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-51-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-51-10">10</a></span>
<span class="normal"><a href="#__codelineno-51-11">11</a></span>
<span class="normal"><a href="#__codelineno-51-12">12</a></span>
<span class="normal"><a href="#__codelineno-51-13">13</a></span>
<span class="normal"><a href="#__codelineno-51-14">14</a></span>
<span class="normal"><a href="#__codelineno-51-15">15</a></span>
<span class="normal"><a href="#__codelineno-51-16">16</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-51-1"><a id="__codelineno-51-1" name="__codelineno-51-1"></a><span class="kn">package</span><span class="w"> </span><span class="nx">main</span>
</span><span id="__span-51-2"><a id="__codelineno-51-2" name="__codelineno-51-2"></a>
</span><span id="__span-51-3"><a id="__codelineno-51-3" name="__codelineno-51-3"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-51-4"><a id="__codelineno-51-4" name="__codelineno-51-4"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-51-5"><a id="__codelineno-51-5" name="__codelineno-51-5"></a><span class="p">)</span>
</span><span id="__span-51-6"><a id="__codelineno-51-6" name="__codelineno-51-6"></a>
</span><span id="__span-51-7"><a id="__codelineno-51-7" name="__codelineno-51-7"></a><span class="kd">func</span><span class="w"> </span><span class="nx">build</span><span class="p">()</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">graph</span><span class="p">.</span><span class="nx">Graph</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-51-8"><a id="__codelineno-51-8" name="__codelineno-51-8"></a><span class="w">    </span><span class="nx">schema</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateSchema</span><span class="p">()</span>
</span><span id="__span-51-9"><a id="__codelineno-51-9" name="__codelineno-51-9"></a><span class="w">    </span><span class="nx">sg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateGraph</span><span class="p">(</span><span class="nx">schema</span><span class="p">).</span>
</span><span id="__span-51-10"><a id="__codelineno-51-10" name="__codelineno-51-10"></a><span class="w">        </span><span class="nx">WithGraphVersion</span><span class="p">(</span><span class="s">&quot;v2025.03&quot;</span><span class="p">).</span><span class="w"> </span><span class="c1">// namespace becomes __writes__:v2025.03:&lt;node&gt;</span>
</span><span id="__span-51-11"><a id="__codelineno-51-11" name="__codelineno-51-11"></a><span class="w">        </span><span class="nx">WithCache</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewInMemoryCache</span><span class="p">()).</span>
</span><span id="__span-51-12"><a id="__codelineno-51-12" name="__codelineno-51-12"></a><span class="w">        </span><span class="nx">WithCachePolicy</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">DefaultCachePolicy</span><span class="p">())</span>
</span><span id="__span-51-13"><a id="__codelineno-51-13" name="__codelineno-51-13"></a>
</span><span id="__span-51-14"><a id="__codelineno-51-14" name="__codelineno-51-14"></a><span class="w">    </span><span class="c1">// ... AddNode(...)</span>
</span><span id="__span-51-15"><a id="__codelineno-51-15" name="__codelineno-51-15"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">sg</span><span class="p">.</span><span class="nx">Compile</span><span class="p">()</span>
</span><span id="__span-51-16"><a id="__codelineno-51-16" name="__codelineno-51-16"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<ul>
<li>Per-node TTL (Time To Live)</li>
</ul>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-52-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-52-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-52-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-52-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-52-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-52-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-52-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-52-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-52-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-52-10">10</a></span>
<span class="normal"><a href="#__codelineno-52-11">11</a></span>
<span class="normal"><a href="#__codelineno-52-12">12</a></span>
<span class="normal"><a href="#__codelineno-52-13">13</a></span>
<span class="normal"><a href="#__codelineno-52-14">14</a></span>
<span class="normal"><a href="#__codelineno-52-15">15</a></span>
<span class="normal"><a href="#__codelineno-52-16">16</a></span>
<span class="normal"><a href="#__codelineno-52-17">17</a></span>
<span class="normal"><a href="#__codelineno-52-18">18</a></span>
<span class="normal"><a href="#__codelineno-52-19">19</a></span>
<span class="normal"><a href="#__codelineno-52-20">20</a></span>
<span class="normal"><a href="#__codelineno-52-21">21</a></span>
<span class="normal"><a href="#__codelineno-52-22">22</a></span>
<span class="normal"><a href="#__codelineno-52-23">23</a></span>
<span class="normal"><a href="#__codelineno-52-24">24</a></span>
<span class="normal"><a href="#__codelineno-52-25">25</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-52-1"><a id="__codelineno-52-1" name="__codelineno-52-1"></a><span class="kn">package</span><span class="w"> </span><span class="nx">main</span>
</span><span id="__span-52-2"><a id="__codelineno-52-2" name="__codelineno-52-2"></a>
</span><span id="__span-52-3"><a id="__codelineno-52-3" name="__codelineno-52-3"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-52-4"><a id="__codelineno-52-4" name="__codelineno-52-4"></a><span class="w">    </span><span class="s">&quot;context&quot;</span>
</span><span id="__span-52-5"><a id="__codelineno-52-5" name="__codelineno-52-5"></a><span class="w">    </span><span class="s">&quot;time&quot;</span>
</span><span id="__span-52-6"><a id="__codelineno-52-6" name="__codelineno-52-6"></a>
</span><span id="__span-52-7"><a id="__codelineno-52-7" name="__codelineno-52-7"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-52-8"><a id="__codelineno-52-8" name="__codelineno-52-8"></a><span class="p">)</span>
</span><span id="__span-52-9"><a id="__codelineno-52-9" name="__codelineno-52-9"></a>
</span><span id="__span-52-10"><a id="__codelineno-52-10" name="__codelineno-52-10"></a><span class="kd">func</span><span class="w"> </span><span class="nx">build</span><span class="p">()</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">graph</span><span class="p">.</span><span class="nx">Graph</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-52-11"><a id="__codelineno-52-11" name="__codelineno-52-11"></a><span class="w">    </span><span class="nx">schema</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateSchema</span><span class="p">()</span>
</span><span id="__span-52-12"><a id="__codelineno-52-12" name="__codelineno-52-12"></a><span class="w">    </span><span class="nx">sg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateGraph</span><span class="p">(</span><span class="nx">schema</span><span class="p">).</span>
</span><span id="__span-52-13"><a id="__codelineno-52-13" name="__codelineno-52-13"></a><span class="w">        </span><span class="nx">WithCache</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewInMemoryCache</span><span class="p">()).</span>
</span><span id="__span-52-14"><a id="__codelineno-52-14" name="__codelineno-52-14"></a><span class="w">        </span><span class="nx">WithCachePolicy</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">DefaultCachePolicy</span><span class="p">())</span>
</span><span id="__span-52-15"><a id="__codelineno-52-15" name="__codelineno-52-15"></a>
</span><span id="__span-52-16"><a id="__codelineno-52-16" name="__codelineno-52-16"></a><span class="w">    </span><span class="nx">compute</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="s">&quot;out&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">42</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-52-17"><a id="__codelineno-52-17" name="__codelineno-52-17"></a>
</span><span id="__span-52-18"><a id="__codelineno-52-18" name="__codelineno-52-18"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;compute&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">compute</span><span class="p">,</span>
</span><span id="__span-52-19"><a id="__codelineno-52-19" name="__codelineno-52-19"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithNodeCachePolicy</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">graph</span><span class="p">.</span><span class="nx">CachePolicy</span><span class="p">{</span>
</span><span id="__span-52-20"><a id="__codelineno-52-20" name="__codelineno-52-20"></a><span class="w">            </span><span class="nx">KeyFunc</span><span class="p">:</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">DefaultCachePolicy</span><span class="p">().</span><span class="nx">KeyFunc</span><span class="p">,</span>
</span><span id="__span-52-21"><a id="__codelineno-52-21" name="__codelineno-52-21"></a><span class="w">            </span><span class="nx">TTL</span><span class="p">:</span><span class="w">     </span><span class="mi">10</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span><span class="p">,</span>
</span><span id="__span-52-22"><a id="__codelineno-52-22" name="__codelineno-52-22"></a><span class="w">        </span><span class="p">}),</span>
</span><span id="__span-52-23"><a id="__codelineno-52-23" name="__codelineno-52-23"></a><span class="w">    </span><span class="p">)</span>
</span><span id="__span-52-24"><a id="__codelineno-52-24" name="__codelineno-52-24"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">sg</span><span class="p">.</span><span class="nx">Compile</span><span class="p">()</span>
</span><span id="__span-52-25"><a id="__codelineno-52-25" name="__codelineno-52-25"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<ul>
<li>Clear cache (per node)</li>
</ul>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-53-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-53-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-53-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-53-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-53-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-53-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-53-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-53-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-53-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-53-10">10</a></span>
<span class="normal"><a href="#__codelineno-53-11">11</a></span>
<span class="normal"><a href="#__codelineno-53-12">12</a></span>
<span class="normal"><a href="#__codelineno-53-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-53-1"><a id="__codelineno-53-1" name="__codelineno-53-1"></a><span class="kn">package</span><span class="w"> </span><span class="nx">main</span>
</span><span id="__span-53-2"><a id="__codelineno-53-2" name="__codelineno-53-2"></a>
</span><span id="__span-53-3"><a id="__codelineno-53-3" name="__codelineno-53-3"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-53-4"><a id="__codelineno-53-4" name="__codelineno-53-4"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-53-5"><a id="__codelineno-53-5" name="__codelineno-53-5"></a><span class="p">)</span>
</span><span id="__span-53-6"><a id="__codelineno-53-6" name="__codelineno-53-6"></a>
</span><span id="__span-53-7"><a id="__codelineno-53-7" name="__codelineno-53-7"></a><span class="kd">func</span><span class="w"> </span><span class="nb">clear</span><span class="p">(</span><span class="nx">sg</span><span class="w"> </span><span class="o">*</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateGraph</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-53-8"><a id="__codelineno-53-8" name="__codelineno-53-8"></a><span class="w">    </span><span class="c1">// clear specific nodes</span>
</span><span id="__span-53-9"><a id="__codelineno-53-9" name="__codelineno-53-9"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">ClearCache</span><span class="p">(</span><span class="s">&quot;compute&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;format&quot;</span><span class="p">)</span>
</span><span id="__span-53-10"><a id="__codelineno-53-10" name="__codelineno-53-10"></a>
</span><span id="__span-53-11"><a id="__codelineno-53-11" name="__codelineno-53-11"></a><span class="w">    </span><span class="c1">// clear all nodes in the graph (no args)</span>
</span><span id="__span-53-12"><a id="__codelineno-53-12" name="__codelineno-53-12"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">ClearCache</span><span class="p">()</span>
</span><span id="__span-53-13"><a id="__codelineno-53-13" name="__codelineno-53-13"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<ul>
<li>Read cache-hit marker (<code>_cache_hit</code>)</li>
</ul>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-54-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-54-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-54-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-54-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-54-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-54-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-54-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-54-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-54-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-54-10">10</a></span>
<span class="normal"><a href="#__codelineno-54-11">11</a></span>
<span class="normal"><a href="#__codelineno-54-12">12</a></span>
<span class="normal"><a href="#__codelineno-54-13">13</a></span>
<span class="normal"><a href="#__codelineno-54-14">14</a></span>
<span class="normal"><a href="#__codelineno-54-15">15</a></span>
<span class="normal"><a href="#__codelineno-54-16">16</a></span>
<span class="normal"><a href="#__codelineno-54-17">17</a></span>
<span class="normal"><a href="#__codelineno-54-18">18</a></span>
<span class="normal"><a href="#__codelineno-54-19">19</a></span>
<span class="normal"><a href="#__codelineno-54-20">20</a></span>
<span class="normal"><a href="#__codelineno-54-21">21</a></span>
<span class="normal"><a href="#__codelineno-54-22">22</a></span>
<span class="normal"><a href="#__codelineno-54-23">23</a></span>
<span class="normal"><a href="#__codelineno-54-24">24</a></span>
<span class="normal"><a href="#__codelineno-54-25">25</a></span>
<span class="normal"><a href="#__codelineno-54-26">26</a></span>
<span class="normal"><a href="#__codelineno-54-27">27</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-54-1"><a id="__codelineno-54-1" name="__codelineno-54-1"></a><span class="kn">package</span><span class="w"> </span><span class="nx">main</span>
</span><span id="__span-54-2"><a id="__codelineno-54-2" name="__codelineno-54-2"></a>
</span><span id="__span-54-3"><a id="__codelineno-54-3" name="__codelineno-54-3"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-54-4"><a id="__codelineno-54-4" name="__codelineno-54-4"></a><span class="w">    </span><span class="s">&quot;context&quot;</span>
</span><span id="__span-54-5"><a id="__codelineno-54-5" name="__codelineno-54-5"></a><span class="w">    </span><span class="s">&quot;fmt&quot;</span>
</span><span id="__span-54-6"><a id="__codelineno-54-6" name="__codelineno-54-6"></a>
</span><span id="__span-54-7"><a id="__codelineno-54-7" name="__codelineno-54-7"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/agent&quot;</span>
</span><span id="__span-54-8"><a id="__codelineno-54-8" name="__codelineno-54-8"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/event&quot;</span>
</span><span id="__span-54-9"><a id="__codelineno-54-9" name="__codelineno-54-9"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-54-10"><a id="__codelineno-54-10" name="__codelineno-54-10"></a><span class="p">)</span>
</span><span id="__span-54-11"><a id="__codelineno-54-11" name="__codelineno-54-11"></a>
</span><span id="__span-54-12"><a id="__codelineno-54-12" name="__codelineno-54-12"></a><span class="kd">func</span><span class="w"> </span><span class="nx">runAndReadHits</span><span class="p">(</span><span class="nx">executor</span><span class="w"> </span><span class="o">*</span><span class="nx">graph</span><span class="p">.</span><span class="nx">Executor</span><span class="p">,</span><span class="w"> </span><span class="nx">initial</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-54-13"><a id="__codelineno-54-13" name="__codelineno-54-13"></a><span class="w">    </span><span class="nx">inv</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">agent</span><span class="p">.</span><span class="nx">Invocation</span><span class="p">{</span><span class="nx">InvocationID</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;demo&quot;</span><span class="p">}</span>
</span><span id="__span-54-14"><a id="__codelineno-54-14" name="__codelineno-54-14"></a><span class="w">    </span><span class="nx">ch</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">executor</span><span class="p">.</span><span class="nx">Execute</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Background</span><span class="p">(),</span><span class="w"> </span><span class="nx">initial</span><span class="p">,</span><span class="w"> </span><span class="nx">inv</span><span class="p">)</span>
</span><span id="__span-54-15"><a id="__codelineno-54-15" name="__codelineno-54-15"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-54-16"><a id="__codelineno-54-16" name="__codelineno-54-16"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">e</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">ch</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-54-17"><a id="__codelineno-54-17" name="__codelineno-54-17"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">Response</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">Response</span><span class="p">.</span><span class="nx">Object</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">ObjectTypeGraphNodeComplete</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-54-18"><a id="__codelineno-54-18" name="__codelineno-54-18"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">StateDelta</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-54-19"><a id="__codelineno-54-19" name="__codelineno-54-19"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">StateDelta</span><span class="p">[</span><span class="s">&quot;_cache_hit&quot;</span><span class="p">];</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-54-20"><a id="__codelineno-54-20" name="__codelineno-54-20"></a><span class="w">                    </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;cache hit: skipped node function&quot;</span><span class="p">)</span>
</span><span id="__span-54-21"><a id="__codelineno-54-21" name="__codelineno-54-21"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-54-22"><a id="__codelineno-54-22" name="__codelineno-54-22"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-54-23"><a id="__codelineno-54-23" name="__codelineno-54-23"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-54-24"><a id="__codelineno-54-24" name="__codelineno-54-24"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">Done</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">break</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-54-25"><a id="__codelineno-54-25" name="__codelineno-54-25"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-54-26"><a id="__codelineno-54-26" name="__codelineno-54-26"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-54-27"><a id="__codelineno-54-27" name="__codelineno-54-27"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>Advanced usage:</p>
<ul>
<li>Field-based keys (recommended): declare <code>WithCacheKeyFields("n", "user_id")</code> on a node; internally this maps the sanitized input to <code>{n, user_id}</code> before default canonicalization and hashing.</li>
<li>Custom selector: <code>WithCacheKeySelector(func(m map[string]any) any { return map[string]any{"n": m["n"], "uid": m["uid"]} })</code></li>
<li>Versioned namespace: <code>WithGraphVersion("v2025.03")</code> expands the namespace to <code>__writes__:&lt;version&gt;:&lt;node&gt;</code>, reducing stale cache collisions across code changes.</li>
</ul>
<p>Notes:</p>
<ul>
<li>Prefer caching only pure functions (no side effects)</li>
<li>TTL=0 means no expiration; consider a persistent backend (Redis/SQLite) in production</li>
<li>Key function sanitizes input to avoid volatile/non-serializable fields being part of the key: <a href="https://github.com/trpc-group/trpc-agent-go/blob/main/graph/cache_key.go">graph/cache_key.go</a></li>
<li>Call <code>ClearCache("nodeID")</code> after code changes or include a function identifier/version in the key</li>
</ul>
<p>Runner + GraphAgent usage example:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-55-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-55-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-55-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-55-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-55-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-55-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-55-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-55-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-55-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-55-10">10</a></span>
<span class="normal"><a href="#__codelineno-55-11">11</a></span>
<span class="normal"><a href="#__codelineno-55-12">12</a></span>
<span class="normal"><a href="#__codelineno-55-13">13</a></span>
<span class="normal"><a href="#__codelineno-55-14">14</a></span>
<span class="normal"><a href="#__codelineno-55-15">15</a></span>
<span class="normal"><a href="#__codelineno-55-16">16</a></span>
<span class="normal"><a href="#__codelineno-55-17">17</a></span>
<span class="normal"><a href="#__codelineno-55-18">18</a></span>
<span class="normal"><a href="#__codelineno-55-19">19</a></span>
<span class="normal"><a href="#__codelineno-55-20">20</a></span>
<span class="normal"><a href="#__codelineno-55-21">21</a></span>
<span class="normal"><a href="#__codelineno-55-22">22</a></span>
<span class="normal"><a href="#__codelineno-55-23">23</a></span>
<span class="normal"><a href="#__codelineno-55-24">24</a></span>
<span class="normal"><a href="#__codelineno-55-25">25</a></span>
<span class="normal"><a href="#__codelineno-55-26">26</a></span>
<span class="normal"><a href="#__codelineno-55-27">27</a></span>
<span class="normal"><a href="#__codelineno-55-28">28</a></span>
<span class="normal"><a href="#__codelineno-55-29">29</a></span>
<span class="normal"><a href="#__codelineno-55-30">30</a></span>
<span class="normal"><a href="#__codelineno-55-31">31</a></span>
<span class="normal"><a href="#__codelineno-55-32">32</a></span>
<span class="normal"><a href="#__codelineno-55-33">33</a></span>
<span class="normal"><a href="#__codelineno-55-34">34</a></span>
<span class="normal"><a href="#__codelineno-55-35">35</a></span>
<span class="normal"><a href="#__codelineno-55-36">36</a></span>
<span class="normal"><a href="#__codelineno-55-37">37</a></span>
<span class="normal"><a href="#__codelineno-55-38">38</a></span>
<span class="normal"><a href="#__codelineno-55-39">39</a></span>
<span class="normal"><a href="#__codelineno-55-40">40</a></span>
<span class="normal"><a href="#__codelineno-55-41">41</a></span>
<span class="normal"><a href="#__codelineno-55-42">42</a></span>
<span class="normal"><a href="#__codelineno-55-43">43</a></span>
<span class="normal"><a href="#__codelineno-55-44">44</a></span>
<span class="normal"><a href="#__codelineno-55-45">45</a></span>
<span class="normal"><a href="#__codelineno-55-46">46</a></span>
<span class="normal"><a href="#__codelineno-55-47">47</a></span>
<span class="normal"><a href="#__codelineno-55-48">48</a></span>
<span class="normal"><a href="#__codelineno-55-49">49</a></span>
<span class="normal"><a href="#__codelineno-55-50">50</a></span>
<span class="normal"><a href="#__codelineno-55-51">51</a></span>
<span class="normal"><a href="#__codelineno-55-52">52</a></span>
<span class="normal"><a href="#__codelineno-55-53">53</a></span>
<span class="normal"><a href="#__codelineno-55-54">54</a></span>
<span class="normal"><a href="#__codelineno-55-55">55</a></span>
<span class="normal"><a href="#__codelineno-55-56">56</a></span>
<span class="normal"><a href="#__codelineno-55-57">57</a></span>
<span class="normal"><a href="#__codelineno-55-58">58</a></span>
<span class="normal"><a href="#__codelineno-55-59">59</a></span>
<span class="normal"><a href="#__codelineno-55-60">60</a></span>
<span class="normal"><a href="#__codelineno-55-61">61</a></span>
<span class="normal"><a href="#__codelineno-55-62">62</a></span>
<span class="normal"><a href="#__codelineno-55-63">63</a></span>
<span class="normal"><a href="#__codelineno-55-64">64</a></span>
<span class="normal"><a href="#__codelineno-55-65">65</a></span>
<span class="normal"><a href="#__codelineno-55-66">66</a></span>
<span class="normal"><a href="#__codelineno-55-67">67</a></span>
<span class="normal"><a href="#__codelineno-55-68">68</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-55-1"><a id="__codelineno-55-1" name="__codelineno-55-1"></a><span class="kn">package</span><span class="w"> </span><span class="nx">main</span>
</span><span id="__span-55-2"><a id="__codelineno-55-2" name="__codelineno-55-2"></a>
</span><span id="__span-55-3"><a id="__codelineno-55-3" name="__codelineno-55-3"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-55-4"><a id="__codelineno-55-4" name="__codelineno-55-4"></a><span class="w">    </span><span class="s">&quot;bufio&quot;</span>
</span><span id="__span-55-5"><a id="__codelineno-55-5" name="__codelineno-55-5"></a><span class="w">    </span><span class="s">&quot;context&quot;</span>
</span><span id="__span-55-6"><a id="__codelineno-55-6" name="__codelineno-55-6"></a><span class="w">    </span><span class="s">&quot;flag&quot;</span>
</span><span id="__span-55-7"><a id="__codelineno-55-7" name="__codelineno-55-7"></a><span class="w">    </span><span class="s">&quot;fmt&quot;</span>
</span><span id="__span-55-8"><a id="__codelineno-55-8" name="__codelineno-55-8"></a><span class="w">    </span><span class="s">&quot;os&quot;</span>
</span><span id="__span-55-9"><a id="__codelineno-55-9" name="__codelineno-55-9"></a><span class="w">    </span><span class="s">&quot;strings&quot;</span>
</span><span id="__span-55-10"><a id="__codelineno-55-10" name="__codelineno-55-10"></a><span class="w">    </span><span class="s">&quot;time&quot;</span>
</span><span id="__span-55-11"><a id="__codelineno-55-11" name="__codelineno-55-11"></a>
</span><span id="__span-55-12"><a id="__codelineno-55-12" name="__codelineno-55-12"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/agent&quot;</span>
</span><span id="__span-55-13"><a id="__codelineno-55-13" name="__codelineno-55-13"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/agent/graphagent&quot;</span>
</span><span id="__span-55-14"><a id="__codelineno-55-14" name="__codelineno-55-14"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-55-15"><a id="__codelineno-55-15" name="__codelineno-55-15"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/model&quot;</span>
</span><span id="__span-55-16"><a id="__codelineno-55-16" name="__codelineno-55-16"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/runner&quot;</span>
</span><span id="__span-55-17"><a id="__codelineno-55-17" name="__codelineno-55-17"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/session/inmemory&quot;</span>
</span><span id="__span-55-18"><a id="__codelineno-55-18" name="__codelineno-55-18"></a><span class="p">)</span>
</span><span id="__span-55-19"><a id="__codelineno-55-19" name="__codelineno-55-19"></a>
</span><span id="__span-55-20"><a id="__codelineno-55-20" name="__codelineno-55-20"></a><span class="kd">func</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-55-21"><a id="__codelineno-55-21" name="__codelineno-55-21"></a><span class="w">    </span><span class="nx">ttl</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">flag</span><span class="p">.</span><span class="nx">Duration</span><span class="p">(</span><span class="s">&quot;ttl&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;cache ttl&quot;</span><span class="p">)</span>
</span><span id="__span-55-22"><a id="__codelineno-55-22" name="__codelineno-55-22"></a><span class="w">    </span><span class="nx">flag</span><span class="p">.</span><span class="nx">Parse</span><span class="p">()</span>
</span><span id="__span-55-23"><a id="__codelineno-55-23" name="__codelineno-55-23"></a>
</span><span id="__span-55-24"><a id="__codelineno-55-24" name="__codelineno-55-24"></a><span class="w">    </span><span class="c1">// Build graph with cache</span>
</span><span id="__span-55-25"><a id="__codelineno-55-25" name="__codelineno-55-25"></a><span class="w">    </span><span class="nx">schema</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateSchema</span><span class="p">()</span>
</span><span id="__span-55-26"><a id="__codelineno-55-26" name="__codelineno-55-26"></a><span class="w">    </span><span class="nx">sg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateGraph</span><span class="p">(</span><span class="nx">schema</span><span class="p">).</span>
</span><span id="__span-55-27"><a id="__codelineno-55-27" name="__codelineno-55-27"></a><span class="w">        </span><span class="nx">WithCache</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewInMemoryCache</span><span class="p">()).</span>
</span><span id="__span-55-28"><a id="__codelineno-55-28" name="__codelineno-55-28"></a><span class="w">        </span><span class="nx">WithCachePolicy</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">DefaultCachePolicy</span><span class="p">())</span>
</span><span id="__span-55-29"><a id="__codelineno-55-29" name="__codelineno-55-29"></a>
</span><span id="__span-55-30"><a id="__codelineno-55-30" name="__codelineno-55-30"></a><span class="w">    </span><span class="nx">compute</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-55-31"><a id="__codelineno-55-31" name="__codelineno-55-31"></a><span class="w">        </span><span class="nx">n</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">s</span><span class="p">[</span><span class="s">&quot;n&quot;</span><span class="p">].(</span><span class="kt">int</span><span class="p">)</span>
</span><span id="__span-55-32"><a id="__codelineno-55-32" name="__codelineno-55-32"></a><span class="w">        </span><span class="nx">time</span><span class="p">.</span><span class="nx">Sleep</span><span class="p">(</span><span class="mi">200</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span><span class="p">)</span>
</span><span id="__span-55-33"><a id="__codelineno-55-33" name="__codelineno-55-33"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="s">&quot;out&quot;</span><span class="p">:</span><span class="w"> </span><span class="nx">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-55-34"><a id="__codelineno-55-34" name="__codelineno-55-34"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-55-35"><a id="__codelineno-55-35" name="__codelineno-55-35"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;compute&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">compute</span><span class="p">,</span>
</span><span id="__span-55-36"><a id="__codelineno-55-36" name="__codelineno-55-36"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithNodeCachePolicy</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">graph</span><span class="p">.</span><span class="nx">CachePolicy</span><span class="p">{</span><span class="nx">KeyFunc</span><span class="p">:</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">DefaultCachePolicy</span><span class="p">().</span><span class="nx">KeyFunc</span><span class="p">,</span><span class="w"> </span><span class="nx">TTL</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="nx">ttl</span><span class="p">}),</span>
</span><span id="__span-55-37"><a id="__codelineno-55-37" name="__codelineno-55-37"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithCacheKeyFields</span><span class="p">(</span><span class="s">&quot;n&quot;</span><span class="p">),</span>
</span><span id="__span-55-38"><a id="__codelineno-55-38" name="__codelineno-55-38"></a><span class="w">    </span><span class="p">).</span>
</span><span id="__span-55-39"><a id="__codelineno-55-39" name="__codelineno-55-39"></a><span class="w">        </span><span class="nx">SetEntryPoint</span><span class="p">(</span><span class="s">&quot;compute&quot;</span><span class="p">).</span>
</span><span id="__span-55-40"><a id="__codelineno-55-40" name="__codelineno-55-40"></a><span class="w">        </span><span class="nx">SetFinishPoint</span><span class="p">(</span><span class="s">&quot;compute&quot;</span><span class="p">)</span>
</span><span id="__span-55-41"><a id="__codelineno-55-41" name="__codelineno-55-41"></a><span class="w">    </span><span class="nx">g</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">sg</span><span class="p">.</span><span class="nx">Compile</span><span class="p">()</span>
</span><span id="__span-55-42"><a id="__codelineno-55-42" name="__codelineno-55-42"></a>
</span><span id="__span-55-43"><a id="__codelineno-55-43" name="__codelineno-55-43"></a><span class="w">    </span><span class="c1">// GraphAgent + Runner</span>
</span><span id="__span-55-44"><a id="__codelineno-55-44" name="__codelineno-55-44"></a><span class="w">    </span><span class="nx">ga</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;cache-demo&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">g</span><span class="p">,</span><span class="w"> </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithInitialState</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{}))</span>
</span><span id="__span-55-45"><a id="__codelineno-55-45" name="__codelineno-55-45"></a><span class="w">    </span><span class="nx">app</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">runner</span><span class="p">.</span><span class="nx">NewRunner</span><span class="p">(</span><span class="s">&quot;app&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">ga</span><span class="p">,</span><span class="w"> </span><span class="nx">runner</span><span class="p">.</span><span class="nx">WithSessionService</span><span class="p">(</span><span class="nx">inmemory</span><span class="p">.</span><span class="nx">NewSessionService</span><span class="p">()))</span>
</span><span id="__span-55-46"><a id="__codelineno-55-46" name="__codelineno-55-46"></a>
</span><span id="__span-55-47"><a id="__codelineno-55-47" name="__codelineno-55-47"></a><span class="w">    </span><span class="c1">// Interactive</span>
</span><span id="__span-55-48"><a id="__codelineno-55-48" name="__codelineno-55-48"></a><span class="w">    </span><span class="nx">sc</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">bufio</span><span class="p">.</span><span class="nx">NewScanner</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Stdin</span><span class="p">)</span>
</span><span id="__span-55-49"><a id="__codelineno-55-49" name="__codelineno-55-49"></a><span class="w">    </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Enter integers; repeated inputs should hit cache. type &#39;exit&#39; to quit&quot;</span><span class="p">)</span>
</span><span id="__span-55-50"><a id="__codelineno-55-50" name="__codelineno-55-50"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-55-51"><a id="__codelineno-55-51" name="__codelineno-55-51"></a><span class="w">        </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Print</span><span class="p">(</span><span class="s">&quot;&gt; &quot;</span><span class="p">)</span>
</span><span id="__span-55-52"><a id="__codelineno-55-52" name="__codelineno-55-52"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">!</span><span class="nx">sc</span><span class="p">.</span><span class="nx">Scan</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">break</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-55-53"><a id="__codelineno-55-53" name="__codelineno-55-53"></a><span class="w">        </span><span class="nx">txt</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">strings</span><span class="p">.</span><span class="nx">TrimSpace</span><span class="p">(</span><span class="nx">sc</span><span class="p">.</span><span class="nx">Text</span><span class="p">())</span>
</span><span id="__span-55-54"><a id="__codelineno-55-54" name="__codelineno-55-54"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">txt</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;exit&quot;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">break</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-55-55"><a id="__codelineno-55-55" name="__codelineno-55-55"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">txt</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">continue</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-55-56"><a id="__codelineno-55-56" name="__codelineno-55-56"></a><span class="w">        </span><span class="nx">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">model</span><span class="p">.</span><span class="nx">NewUserMessage</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;compute %s&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">txt</span><span class="p">))</span>
</span><span id="__span-55-57"><a id="__codelineno-55-57" name="__codelineno-55-57"></a><span class="w">        </span><span class="nx">evts</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">app</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Background</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;user&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;s-%d&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">().</span><span class="nx">UnixNano</span><span class="p">()),</span><span class="w"> </span><span class="nx">msg</span><span class="p">,</span><span class="w"> </span><span class="nx">agent</span><span class="p">.</span><span class="nx">WithRuntimeState</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="s">&quot;n&quot;</span><span class="p">:</span><span class="w"> </span><span class="nx">atoi</span><span class="p">(</span><span class="nx">txt</span><span class="p">)}))</span>
</span><span id="__span-55-58"><a id="__codelineno-55-58" name="__codelineno-55-58"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;run error:&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">);</span><span class="w"> </span><span class="k">continue</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-55-59"><a id="__codelineno-55-59" name="__codelineno-55-59"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="nx">e</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">evts</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-55-60"><a id="__codelineno-55-60" name="__codelineno-55-60"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">Response</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">Response</span><span class="p">.</span><span class="nx">Object</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">ObjectTypeGraphNodeComplete</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-55-61"><a id="__codelineno-55-61" name="__codelineno-55-61"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">StateDelta</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">StateDelta</span><span class="p">[</span><span class="s">&quot;_cache_hit&quot;</span><span class="p">];</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;cache hit&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-55-62"><a id="__codelineno-55-62" name="__codelineno-55-62"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-55-63"><a id="__codelineno-55-63" name="__codelineno-55-63"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">Done</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">break</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-55-64"><a id="__codelineno-55-64" name="__codelineno-55-64"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-55-65"><a id="__codelineno-55-65" name="__codelineno-55-65"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-55-66"><a id="__codelineno-55-66" name="__codelineno-55-66"></a><span class="p">}</span>
</span><span id="__span-55-67"><a id="__codelineno-55-67" name="__codelineno-55-67"></a>
</span><span id="__span-55-68"><a id="__codelineno-55-68" name="__codelineno-55-68"></a><span class="kd">func</span><span class="w"> </span><span class="nx">atoi</span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="nx">n</span><span class="w"> </span><span class="kt">int</span><span class="p">;</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sscanf</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%d&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">n</span><span class="p">);</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">n</span><span class="w"> </span><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>Example:</p>
<ul>
<li>Interactive + Runner + GraphAgent: <a href="https://github.com/trpc-group/trpc-agent-go/blob/main/examples/graph/nodecache/main.go">examples/graph/nodecache/main.go</a></li>
</ul>
<h4 id="tools-node">Tools Node</h4>
<p>Executes tool calls in sequence:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-56-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-56-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-56-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-56-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-56-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-56-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-56-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-56-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-56-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-56-10">10</a></span>
<span class="normal"><a href="#__codelineno-56-11">11</a></span>
<span class="normal"><a href="#__codelineno-56-12">12</a></span>
<span class="normal"><a href="#__codelineno-56-13">13</a></span>
<span class="normal"><a href="#__codelineno-56-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-56-1"><a id="__codelineno-56-1" name="__codelineno-56-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-56-2"><a id="__codelineno-56-2" name="__codelineno-56-2"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-56-3"><a id="__codelineno-56-3" name="__codelineno-56-3"></a><span class="p">)</span>
</span><span id="__span-56-4"><a id="__codelineno-56-4" name="__codelineno-56-4"></a>
</span><span id="__span-56-5"><a id="__codelineno-56-5" name="__codelineno-56-5"></a><span class="kd">const</span><span class="w"> </span><span class="nx">nodeTools</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;tools&quot;</span>
</span><span id="__span-56-6"><a id="__codelineno-56-6" name="__codelineno-56-6"></a>
</span><span id="__span-56-7"><a id="__codelineno-56-7" name="__codelineno-56-7"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddToolsNode</span><span class="p">(</span><span class="nx">nodeTools</span><span class="p">,</span><span class="w"> </span><span class="nx">tools</span><span class="p">)</span>
</span><span id="__span-56-8"><a id="__codelineno-56-8" name="__codelineno-56-8"></a><span class="c1">// Multiple tools execute in the order returned by the LLM</span>
</span><span id="__span-56-9"><a id="__codelineno-56-9" name="__codelineno-56-9"></a><span class="c1">// For parallelism, use multiple nodes + parallel edges</span>
</span><span id="__span-56-10"><a id="__codelineno-56-10" name="__codelineno-56-10"></a><span class="c1">// Pairing rule: walk the messages from the tail to the most recent assistant(tool_calls)</span>
</span><span id="__span-56-11"><a id="__codelineno-56-11" name="__codelineno-56-11"></a><span class="c1">// message; stop at a new user to ensure pairing with the current tool call round.</span>
</span><span id="__span-56-12"><a id="__codelineno-56-12" name="__codelineno-56-12"></a><span class="c1">// Output: appends tool messages to graph.StateKeyMessages, sets</span>
</span><span id="__span-56-13"><a id="__codelineno-56-13" name="__codelineno-56-13"></a><span class="c1">// graph.StateKeyLastToolResponse, and sets</span>
</span><span id="__span-56-14"><a id="__codelineno-56-14" name="__codelineno-56-14"></a><span class="c1">// graph.StateKeyNodeResponses[nodeTools] to a JSON array string.</span>
</span></code></pre></div></td></tr></table></div>
<h4 id="reading-tool-results-into-state">Reading Tool Results into State</h4>
<p>Tools nodes already expose their outputs via:</p>
<ul>
<li><code>graph.StateKeyLastToolResponse</code>: JSON string of the last tool output in this node run</li>
<li><code>graph.StateKeyNodeResponses[&lt;tools_node_id&gt;]</code>: JSON array string of all tool outputs from this node run</li>
</ul>
<p>After a tools node, add a function node to collect tool outputs from <code>graph.StateKeyMessages</code> and write a structured result into state:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-57-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-57-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-57-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-57-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-57-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-57-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-57-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-57-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-57-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-57-10">10</a></span>
<span class="normal"><a href="#__codelineno-57-11">11</a></span>
<span class="normal"><a href="#__codelineno-57-12">12</a></span>
<span class="normal"><a href="#__codelineno-57-13">13</a></span>
<span class="normal"><a href="#__codelineno-57-14">14</a></span>
<span class="normal"><a href="#__codelineno-57-15">15</a></span>
<span class="normal"><a href="#__codelineno-57-16">16</a></span>
<span class="normal"><a href="#__codelineno-57-17">17</a></span>
<span class="normal"><a href="#__codelineno-57-18">18</a></span>
<span class="normal"><a href="#__codelineno-57-19">19</a></span>
<span class="normal"><a href="#__codelineno-57-20">20</a></span>
<span class="normal"><a href="#__codelineno-57-21">21</a></span>
<span class="normal"><a href="#__codelineno-57-22">22</a></span>
<span class="normal"><a href="#__codelineno-57-23">23</a></span>
<span class="normal"><a href="#__codelineno-57-24">24</a></span>
<span class="normal"><a href="#__codelineno-57-25">25</a></span>
<span class="normal"><a href="#__codelineno-57-26">26</a></span>
<span class="normal"><a href="#__codelineno-57-27">27</a></span>
<span class="normal"><a href="#__codelineno-57-28">28</a></span>
<span class="normal"><a href="#__codelineno-57-29">29</a></span>
<span class="normal"><a href="#__codelineno-57-30">30</a></span>
<span class="normal"><a href="#__codelineno-57-31">31</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-57-1"><a id="__codelineno-57-1" name="__codelineno-57-1"></a><span class="kd">const</span><span class="w"> </span><span class="nx">stateKeyToolResults</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;tool_results&quot;</span>
</span><span id="__span-57-2"><a id="__codelineno-57-2" name="__codelineno-57-2"></a>
</span><span id="__span-57-3"><a id="__codelineno-57-3" name="__codelineno-57-3"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;collect_tool_results&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-57-4"><a id="__codelineno-57-4" name="__codelineno-57-4"></a><span class="w">    </span><span class="nx">msgs</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">s</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyMessages</span><span class="p">].([]</span><span class="nx">model</span><span class="p">.</span><span class="nx">Message</span><span class="p">)</span>
</span><span id="__span-57-5"><a id="__codelineno-57-5" name="__codelineno-57-5"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">msgs</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-57-6"><a id="__codelineno-57-6" name="__codelineno-57-6"></a>
</span><span id="__span-57-7"><a id="__codelineno-57-7" name="__codelineno-57-7"></a><span class="w">    </span><span class="c1">// Find latest assistant(tool_calls) for this round</span>
</span><span id="__span-57-8"><a id="__codelineno-57-8" name="__codelineno-57-8"></a><span class="w">    </span><span class="nx">i</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">msgs</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-57-9"><a id="__codelineno-57-9" name="__codelineno-57-9"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">!(</span><span class="nx">msgs</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">Role</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">model</span><span class="p">.</span><span class="nx">RoleAssistant</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">msgs</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">ToolCalls</span><span class="p">)</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-57-10"><a id="__codelineno-57-10" name="__codelineno-57-10"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">msgs</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">Role</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">model</span><span class="p">.</span><span class="nx">RoleUser</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// crossed a new round</span>
</span><span id="__span-57-11"><a id="__codelineno-57-11" name="__codelineno-57-11"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-57-12"><a id="__codelineno-57-12" name="__codelineno-57-12"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-57-13"><a id="__codelineno-57-13" name="__codelineno-57-13"></a><span class="w">        </span><span class="nx">i</span><span class="o">--</span>
</span><span id="__span-57-14"><a id="__codelineno-57-14" name="__codelineno-57-14"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-57-15"><a id="__codelineno-57-15" name="__codelineno-57-15"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-57-16"><a id="__codelineno-57-16" name="__codelineno-57-16"></a>
</span><span id="__span-57-17"><a id="__codelineno-57-17" name="__codelineno-57-17"></a><span class="w">    </span><span class="c1">// Collect matching tool results (by ToolID)</span>
</span><span id="__span-57-18"><a id="__codelineno-57-18" name="__codelineno-57-18"></a><span class="w">    </span><span class="nx">idset</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">bool</span><span class="p">{}</span>
</span><span id="__span-57-19"><a id="__codelineno-57-19" name="__codelineno-57-19"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">tc</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">msgs</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">ToolCalls</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">idset</span><span class="p">[</span><span class="nx">tc</span><span class="p">.</span><span class="nx">ID</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-57-20"><a id="__codelineno-57-20" name="__codelineno-57-20"></a><span class="w">    </span><span class="nx">results</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{}</span>
</span><span id="__span-57-21"><a id="__codelineno-57-21" name="__codelineno-57-21"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">j</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="nx">j</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">msgs</span><span class="p">);</span><span class="w"> </span><span class="nx">j</span><span class="o">++</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-57-22"><a id="__codelineno-57-22" name="__codelineno-57-22"></a><span class="w">        </span><span class="nx">m</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">msgs</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span>
</span><span id="__span-57-23"><a id="__codelineno-57-23" name="__codelineno-57-23"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">m</span><span class="p">.</span><span class="nx">Role</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">model</span><span class="p">.</span><span class="nx">RoleTool</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">idset</span><span class="p">[</span><span class="nx">m</span><span class="p">.</span><span class="nx">ToolID</span><span class="p">]</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-57-24"><a id="__codelineno-57-24" name="__codelineno-57-24"></a><span class="w">            </span><span class="c1">// Each tool decided its own output encoding; here treat content as JSON/text</span>
</span><span id="__span-57-25"><a id="__codelineno-57-25" name="__codelineno-57-25"></a><span class="w">            </span><span class="nx">results</span><span class="p">[</span><span class="nx">m</span><span class="p">.</span><span class="nx">ToolName</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">m</span><span class="p">.</span><span class="nx">Content</span>
</span><span id="__span-57-26"><a id="__codelineno-57-26" name="__codelineno-57-26"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-57-27"><a id="__codelineno-57-27" name="__codelineno-57-27"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">m</span><span class="p">.</span><span class="nx">Role</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">model</span><span class="p">.</span><span class="nx">RoleUser</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">break</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-57-28"><a id="__codelineno-57-28" name="__codelineno-57-28"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-57-29"><a id="__codelineno-57-29" name="__codelineno-57-29"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">results</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-57-30"><a id="__codelineno-57-30" name="__codelineno-57-30"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="nx">stateKeyToolResults</span><span class="p">:</span><span class="w"> </span><span class="nx">results</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-57-31"><a id="__codelineno-57-31" name="__codelineno-57-31"></a><span class="p">})</span>
</span></code></pre></div></td></tr></table></div>
<p>Reference example: <code>examples/graph/io_conventions_tools</code>.</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-58-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-58-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-58-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-58-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-58-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-58-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-58-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-58-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-58-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-58-10">10</a></span>
<span class="normal"><a href="#__codelineno-58-11">11</a></span>
<span class="normal"><a href="#__codelineno-58-12">12</a></span>
<span class="normal"><a href="#__codelineno-58-13">13</a></span>
<span class="normal"><a href="#__codelineno-58-14">14</a></span>
<span class="normal"><a href="#__codelineno-58-15">15</a></span>
<span class="normal"><a href="#__codelineno-58-16">16</a></span>
<span class="normal"><a href="#__codelineno-58-17">17</a></span>
<span class="normal"><a href="#__codelineno-58-18">18</a></span>
<span class="normal"><a href="#__codelineno-58-19">19</a></span>
<span class="normal"><a href="#__codelineno-58-20">20</a></span>
<span class="normal"><a href="#__codelineno-58-21">21</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-58-1"><a id="__codelineno-58-1" name="__codelineno-58-1"></a>#### Agent Node
</span><span id="__span-58-2"><a id="__codelineno-58-2" name="__codelineno-58-2"></a>Embed a sub‑agent to enable multi‑agent collaboration:
</span><span id="__span-58-3"><a id="__codelineno-58-3" name="__codelineno-58-3"></a>
</span><span id="__span-58-4"><a id="__codelineno-58-4" name="__codelineno-58-4"></a>```go
</span><span id="__span-58-5"><a id="__codelineno-58-5" name="__codelineno-58-5"></a>import (
</span><span id="__span-58-6"><a id="__codelineno-58-6" name="__codelineno-58-6"></a>    &quot;trpc.group/trpc-go/trpc-agent-go/agent&quot;
</span><span id="__span-58-7"><a id="__codelineno-58-7" name="__codelineno-58-7"></a>    &quot;trpc.group/trpc-go/trpc-agent-go/agent/graphagent&quot;
</span><span id="__span-58-8"><a id="__codelineno-58-8" name="__codelineno-58-8"></a>)
</span><span id="__span-58-9"><a id="__codelineno-58-9" name="__codelineno-58-9"></a>
</span><span id="__span-58-10"><a id="__codelineno-58-10" name="__codelineno-58-10"></a>const (
</span><span id="__span-58-11"><a id="__codelineno-58-11" name="__codelineno-58-11"></a>    subAgentNameAnalyzer = &quot;analyzer&quot;
</span><span id="__span-58-12"><a id="__codelineno-58-12" name="__codelineno-58-12"></a>    graphAgentNameMain   = &quot;main&quot;
</span><span id="__span-58-13"><a id="__codelineno-58-13" name="__codelineno-58-13"></a>)
</span><span id="__span-58-14"><a id="__codelineno-58-14" name="__codelineno-58-14"></a>
</span><span id="__span-58-15"><a id="__codelineno-58-15" name="__codelineno-58-15"></a>// Important: node ID must match the sub‑agent&#39;s name
</span><span id="__span-58-16"><a id="__codelineno-58-16" name="__codelineno-58-16"></a>sg.AddAgentNode(subAgentNameAnalyzer)
</span><span id="__span-58-17"><a id="__codelineno-58-17" name="__codelineno-58-17"></a>
</span><span id="__span-58-18"><a id="__codelineno-58-18" name="__codelineno-58-18"></a>// Inject sub‑agent instances when creating the GraphAgent
</span><span id="__span-58-19"><a id="__codelineno-58-19" name="__codelineno-58-19"></a>analyzer := createAnalyzer()  // internal agent name must be &quot;analyzer&quot;
</span><span id="__span-58-20"><a id="__codelineno-58-20" name="__codelineno-58-20"></a>graphAgent, _ := graphagent.New(graphAgentNameMain, g,
</span><span id="__span-58-21"><a id="__codelineno-58-21" name="__codelineno-58-21"></a>    graphagent.WithSubAgents([]agent.Agent{analyzer}))
</span></code></pre></div></td></tr></table></div>
<h3 id="edges-and-routing">Edges and Routing</h3>
<p>Edges define control flow between nodes:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-59-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-59-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-59-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-59-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-59-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-59-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-59-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-59-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-59-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-59-10">10</a></span>
<span class="normal"><a href="#__codelineno-59-11">11</a></span>
<span class="normal"><a href="#__codelineno-59-12">12</a></span>
<span class="normal"><a href="#__codelineno-59-13">13</a></span>
<span class="normal"><a href="#__codelineno-59-14">14</a></span>
<span class="normal"><a href="#__codelineno-59-15">15</a></span>
<span class="normal"><a href="#__codelineno-59-16">16</a></span>
<span class="normal"><a href="#__codelineno-59-17">17</a></span>
<span class="normal"><a href="#__codelineno-59-18">18</a></span>
<span class="normal"><a href="#__codelineno-59-19">19</a></span>
<span class="normal"><a href="#__codelineno-59-20">20</a></span>
<span class="normal"><a href="#__codelineno-59-21">21</a></span>
<span class="normal"><a href="#__codelineno-59-22">22</a></span>
<span class="normal"><a href="#__codelineno-59-23">23</a></span>
<span class="normal"><a href="#__codelineno-59-24">24</a></span>
<span class="normal"><a href="#__codelineno-59-25">25</a></span>
<span class="normal"><a href="#__codelineno-59-26">26</a></span>
<span class="normal"><a href="#__codelineno-59-27">27</a></span>
<span class="normal"><a href="#__codelineno-59-28">28</a></span>
<span class="normal"><a href="#__codelineno-59-29">29</a></span>
<span class="normal"><a href="#__codelineno-59-30">30</a></span>
<span class="normal"><a href="#__codelineno-59-31">31</a></span>
<span class="normal"><a href="#__codelineno-59-32">32</a></span>
<span class="normal"><a href="#__codelineno-59-33">33</a></span>
<span class="normal"><a href="#__codelineno-59-34">34</a></span>
<span class="normal"><a href="#__codelineno-59-35">35</a></span>
<span class="normal"><a href="#__codelineno-59-36">36</a></span>
<span class="normal"><a href="#__codelineno-59-37">37</a></span>
<span class="normal"><a href="#__codelineno-59-38">38</a></span>
<span class="normal"><a href="#__codelineno-59-39">39</a></span>
<span class="normal"><a href="#__codelineno-59-40">40</a></span>
<span class="normal"><a href="#__codelineno-59-41">41</a></span>
<span class="normal"><a href="#__codelineno-59-42">42</a></span>
<span class="normal"><a href="#__codelineno-59-43">43</a></span>
<span class="normal"><a href="#__codelineno-59-44">44</a></span>
<span class="normal"><a href="#__codelineno-59-45">45</a></span>
<span class="normal"><a href="#__codelineno-59-46">46</a></span>
<span class="normal"><a href="#__codelineno-59-47">47</a></span>
<span class="normal"><a href="#__codelineno-59-48">48</a></span>
<span class="normal"><a href="#__codelineno-59-49">49</a></span>
<span class="normal"><a href="#__codelineno-59-50">50</a></span>
<span class="normal"><a href="#__codelineno-59-51">51</a></span>
<span class="normal"><a href="#__codelineno-59-52">52</a></span>
<span class="normal"><a href="#__codelineno-59-53">53</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-59-1"><a id="__codelineno-59-1" name="__codelineno-59-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-59-2"><a id="__codelineno-59-2" name="__codelineno-59-2"></a><span class="w">    </span><span class="s">&quot;context&quot;</span>
</span><span id="__span-59-3"><a id="__codelineno-59-3" name="__codelineno-59-3"></a>
</span><span id="__span-59-4"><a id="__codelineno-59-4" name="__codelineno-59-4"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-59-5"><a id="__codelineno-59-5" name="__codelineno-59-5"></a><span class="p">)</span>
</span><span id="__span-59-6"><a id="__codelineno-59-6" name="__codelineno-59-6"></a>
</span><span id="__span-59-7"><a id="__codelineno-59-7" name="__codelineno-59-7"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-59-8"><a id="__codelineno-59-8" name="__codelineno-59-8"></a><span class="w">    </span><span class="nx">nodeA</span><span class="w">         </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;nodeA&quot;</span>
</span><span id="__span-59-9"><a id="__codelineno-59-9" name="__codelineno-59-9"></a><span class="w">    </span><span class="nx">nodeB</span><span class="w">         </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;nodeB&quot;</span>
</span><span id="__span-59-10"><a id="__codelineno-59-10" name="__codelineno-59-10"></a><span class="w">    </span><span class="nx">nodeDecision</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;decision&quot;</span>
</span><span id="__span-59-11"><a id="__codelineno-59-11" name="__codelineno-59-11"></a><span class="w">    </span><span class="nx">nodePathA</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;pathA&quot;</span>
</span><span id="__span-59-12"><a id="__codelineno-59-12" name="__codelineno-59-12"></a><span class="w">    </span><span class="nx">nodePathB</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;pathB&quot;</span>
</span><span id="__span-59-13"><a id="__codelineno-59-13" name="__codelineno-59-13"></a>
</span><span id="__span-59-14"><a id="__codelineno-59-14" name="__codelineno-59-14"></a><span class="w">    </span><span class="nx">routeToPathA</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;route_to_pathA&quot;</span>
</span><span id="__span-59-15"><a id="__codelineno-59-15" name="__codelineno-59-15"></a><span class="w">    </span><span class="nx">routeToPathB</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;route_to_pathB&quot;</span>
</span><span id="__span-59-16"><a id="__codelineno-59-16" name="__codelineno-59-16"></a><span class="w">    </span><span class="nx">stateKeyFlag</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;flag&quot;</span>
</span><span id="__span-59-17"><a id="__codelineno-59-17" name="__codelineno-59-17"></a><span class="p">)</span>
</span><span id="__span-59-18"><a id="__codelineno-59-18" name="__codelineno-59-18"></a>
</span><span id="__span-59-19"><a id="__codelineno-59-19" name="__codelineno-59-19"></a><span class="c1">// Straight edge</span>
</span><span id="__span-59-20"><a id="__codelineno-59-20" name="__codelineno-59-20"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddEdge</span><span class="p">(</span><span class="nx">nodeA</span><span class="p">,</span><span class="w"> </span><span class="nx">nodeB</span><span class="p">)</span>
</span><span id="__span-59-21"><a id="__codelineno-59-21" name="__codelineno-59-21"></a>
</span><span id="__span-59-22"><a id="__codelineno-59-22" name="__codelineno-59-22"></a><span class="c1">// Conditional edges (third arg is the route map; provide explicitly for static checks)</span>
</span><span id="__span-59-23"><a id="__codelineno-59-23" name="__codelineno-59-23"></a><span class="c1">// Define target nodes first</span>
</span><span id="__span-59-24"><a id="__codelineno-59-24" name="__codelineno-59-24"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="nx">nodePathA</span><span class="p">,</span><span class="w"> </span><span class="nx">handlerA</span><span class="p">)</span>
</span><span id="__span-59-25"><a id="__codelineno-59-25" name="__codelineno-59-25"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="nx">nodePathB</span><span class="p">,</span><span class="w"> </span><span class="nx">handlerB</span><span class="p">)</span>
</span><span id="__span-59-26"><a id="__codelineno-59-26" name="__codelineno-59-26"></a><span class="c1">// Then add conditional routing</span>
</span><span id="__span-59-27"><a id="__codelineno-59-27" name="__codelineno-59-27"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddConditionalEdges</span><span class="p">(</span><span class="nx">nodeDecision</span><span class="p">,</span>
</span><span id="__span-59-28"><a id="__codelineno-59-28" name="__codelineno-59-28"></a><span class="w">    </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-59-29"><a id="__codelineno-59-29" name="__codelineno-59-29"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">s</span><span class="p">[</span><span class="nx">stateKeyFlag</span><span class="p">].(</span><span class="kt">bool</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-59-30"><a id="__codelineno-59-30" name="__codelineno-59-30"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">routeToPathA</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-59-31"><a id="__codelineno-59-31" name="__codelineno-59-31"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-59-32"><a id="__codelineno-59-32" name="__codelineno-59-32"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">routeToPathB</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-59-33"><a id="__codelineno-59-33" name="__codelineno-59-33"></a><span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span>
</span><span id="__span-59-34"><a id="__codelineno-59-34" name="__codelineno-59-34"></a><span class="w">        </span><span class="nx">routeToPathA</span><span class="p">:</span><span class="w"> </span><span class="nx">nodePathA</span><span class="p">,</span>
</span><span id="__span-59-35"><a id="__codelineno-59-35" name="__codelineno-59-35"></a><span class="w">        </span><span class="nx">routeToPathB</span><span class="p">:</span><span class="w"> </span><span class="nx">nodePathB</span><span class="p">,</span>
</span><span id="__span-59-36"><a id="__codelineno-59-36" name="__codelineno-59-36"></a><span class="w">    </span><span class="p">})</span>
</span><span id="__span-59-37"><a id="__codelineno-59-37" name="__codelineno-59-37"></a>
</span><span id="__span-59-38"><a id="__codelineno-59-38" name="__codelineno-59-38"></a><span class="c1">// Tools conditional edges: handle LLM tool calls</span>
</span><span id="__span-59-39"><a id="__codelineno-59-39" name="__codelineno-59-39"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-59-40"><a id="__codelineno-59-40" name="__codelineno-59-40"></a><span class="w">    </span><span class="nx">nodeLLM</span><span class="w">      </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;llm&quot;</span>
</span><span id="__span-59-41"><a id="__codelineno-59-41" name="__codelineno-59-41"></a><span class="w">    </span><span class="nx">nodeToolsUse</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;tools&quot;</span>
</span><span id="__span-59-42"><a id="__codelineno-59-42" name="__codelineno-59-42"></a><span class="w">    </span><span class="nx">nodeFallback</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;fallback&quot;</span>
</span><span id="__span-59-43"><a id="__codelineno-59-43" name="__codelineno-59-43"></a><span class="p">)</span>
</span><span id="__span-59-44"><a id="__codelineno-59-44" name="__codelineno-59-44"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddToolsConditionalEdges</span><span class="p">(</span><span class="nx">nodeLLM</span><span class="p">,</span><span class="w"> </span><span class="nx">nodeToolsUse</span><span class="p">,</span><span class="w"> </span><span class="nx">nodeFallback</span><span class="p">)</span>
</span><span id="__span-59-45"><a id="__codelineno-59-45" name="__codelineno-59-45"></a>
</span><span id="__span-59-46"><a id="__codelineno-59-46" name="__codelineno-59-46"></a><span class="c1">// Parallel edges: branches from the same node run in parallel</span>
</span><span id="__span-59-47"><a id="__codelineno-59-47" name="__codelineno-59-47"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-59-48"><a id="__codelineno-59-48" name="__codelineno-59-48"></a><span class="w">    </span><span class="nx">nodeSplit</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;split&quot;</span>
</span><span id="__span-59-49"><a id="__codelineno-59-49" name="__codelineno-59-49"></a><span class="w">    </span><span class="nx">nodeBranch1</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;branch1&quot;</span>
</span><span id="__span-59-50"><a id="__codelineno-59-50" name="__codelineno-59-50"></a><span class="w">    </span><span class="nx">nodeBranch2</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;branch2&quot;</span>
</span><span id="__span-59-51"><a id="__codelineno-59-51" name="__codelineno-59-51"></a><span class="p">)</span>
</span><span id="__span-59-52"><a id="__codelineno-59-52" name="__codelineno-59-52"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddEdge</span><span class="p">(</span><span class="nx">nodeSplit</span><span class="p">,</span><span class="w"> </span><span class="nx">nodeBranch1</span><span class="p">)</span>
</span><span id="__span-59-53"><a id="__codelineno-59-53" name="__codelineno-59-53"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddEdge</span><span class="p">(</span><span class="nx">nodeSplit</span><span class="p">,</span><span class="w"> </span><span class="nx">nodeBranch2</span><span class="p">)</span><span class="w">  </span><span class="c1">// branch1 and branch2 execute in parallel</span>
</span></code></pre></div></td></tr></table></div>
<h4 id="join-edges-wait-all-fan-in">Join edges (wait-all fan-in)</h4>
<p>When multiple upstream branches run in parallel, a normal <code>AddEdge(from, to)</code>
triggers <code>to</code> whenever <strong>any</strong> upstream node updates its edge channel. That can
make <code>to</code> execute multiple times.</p>
<p>If you need classic “wait for all branches, then run once” fan-in semantics,
use <code>AddJoinEdge</code>:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-60-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-60-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-60-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-60-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-60-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-60-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-60-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-60-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-60-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-60-10">10</a></span>
<span class="normal"><a href="#__codelineno-60-11">11</a></span>
<span class="normal"><a href="#__codelineno-60-12">12</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-60-1"><a id="__codelineno-60-1" name="__codelineno-60-1"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-60-2"><a id="__codelineno-60-2" name="__codelineno-60-2"></a><span class="w">    </span><span class="nx">nodeSplit</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;split&quot;</span>
</span><span id="__span-60-3"><a id="__codelineno-60-3" name="__codelineno-60-3"></a><span class="w">    </span><span class="nx">nodeA</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;branch_a&quot;</span>
</span><span id="__span-60-4"><a id="__codelineno-60-4" name="__codelineno-60-4"></a><span class="w">    </span><span class="nx">nodeB</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;branch_b&quot;</span>
</span><span id="__span-60-5"><a id="__codelineno-60-5" name="__codelineno-60-5"></a><span class="w">    </span><span class="nx">nodeJoin</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;join&quot;</span>
</span><span id="__span-60-6"><a id="__codelineno-60-6" name="__codelineno-60-6"></a><span class="p">)</span>
</span><span id="__span-60-7"><a id="__codelineno-60-7" name="__codelineno-60-7"></a>
</span><span id="__span-60-8"><a id="__codelineno-60-8" name="__codelineno-60-8"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddEdge</span><span class="p">(</span><span class="nx">nodeSplit</span><span class="p">,</span><span class="w"> </span><span class="nx">nodeA</span><span class="p">)</span>
</span><span id="__span-60-9"><a id="__codelineno-60-9" name="__codelineno-60-9"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddEdge</span><span class="p">(</span><span class="nx">nodeSplit</span><span class="p">,</span><span class="w"> </span><span class="nx">nodeB</span><span class="p">)</span>
</span><span id="__span-60-10"><a id="__codelineno-60-10" name="__codelineno-60-10"></a>
</span><span id="__span-60-11"><a id="__codelineno-60-11" name="__codelineno-60-11"></a><span class="c1">// Wait for both A and B to complete before running join.</span>
</span><span id="__span-60-12"><a id="__codelineno-60-12" name="__codelineno-60-12"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddJoinEdge</span><span class="p">([]</span><span class="kt">string</span><span class="p">{</span><span class="nx">nodeA</span><span class="p">,</span><span class="w"> </span><span class="nx">nodeB</span><span class="p">},</span><span class="w"> </span><span class="nx">nodeJoin</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p><code>AddJoinEdge</code> creates an internal barrier channel and triggers <code>nodeJoin</code> only
after every <code>from</code> node has reported completion. The barrier resets after it
triggers, so the same join can be reached again in loops.</p>
<p>Reference example: <code>examples/graph/join_edge</code>.</p>
<h4 id="bsp-superstep-barrier-why-downstream-waits">BSP superstep barrier (why downstream waits)</h4>
<p>Graph executes workflows in <strong>BSP supersteps</strong> (Planning → Execution → Update).
In each superstep:</p>
<ul>
<li>Planning computes the runnable frontier from channels updated in the previous
  superstep.</li>
<li>Execution runs all runnable nodes concurrently (up to <code>WithMaxConcurrency</code>).</li>
<li>Update merges state updates and applies routing signals (channel writes).</li>
</ul>
<p>The next superstep starts only after <strong>all</strong> nodes in the current superstep
finish. Because routing signals are applied in Update, a node triggered by an
upstream completion always becomes runnable in the <strong>next</strong> superstep.</p>
<p>This can look like “depth‑K nodes wait for depth‑(K‑1) nodes”, even across
independent branches.</p>
<p>Example graph:</p>
<pre class="mermaid"><code>flowchart LR
    S[split] --&gt; B[branch_b]
    B --&gt; C[branch_b_next]
    S --&gt; E[branch_e]
    S --&gt; F[branch_f]</code></pre>
<p>Runtime behavior:</p>
<ul>
<li>Superstep 0: <code>split</code></li>
<li>Superstep 1: <code>branch_b</code>, <code>branch_e</code>, <code>branch_f</code> run in parallel</li>
<li>Superstep 2: <code>branch_b_next</code> runs (even though it only depends on <code>branch_b</code>)</li>
</ul>
<p>Practical tips:</p>
<ul>
<li><strong>Reduce supersteps</strong>: if <code>X → Y</code> is always sequential, consider collapsing it
  into one node so you don’t pay an extra superstep.</li>
<li><strong>Avoid extra “prepare” nodes</strong> when you only need to enrich a single node’s
  input: move the preparation into the node, or use <code>graph.WithPreNodeCallback</code>
  on that node.</li>
<li><strong>Use stable per-branch outputs</strong> in parallel flows: avoid reading a specific
  branch from <code>last_response</code>; use <code>node_responses[nodeID]</code> (or dedicated state
  keys) so fan-in logic does not depend on scheduling.</li>
<li><strong>Choose the right fan-in</strong>:<ul>
<li>Use <code>AddEdge(from, to)</code> when <code>to</code> should react to incremental updates (it
  may run multiple times).</li>
<li>Use <code>AddJoinEdge([...], to)</code> when you need “wait for all, then run once”.</li>
</ul>
</li>
</ul>
<p>Tip: setting entry and finish points implicitly connects to virtual Start/End nodes:</p>
<ul>
<li><code>SetEntryPoint("first")</code> is equivalent to Start → first.</li>
<li><code>SetFinishPoint("last")</code> is equivalent to last → End.
  There's no need to add these two edges explicitly.</li>
</ul>
<p>Constants: <code>graph.Start == "__start__"</code>, <code>graph.End == "__end__"</code>.</p>
<h3 id="message-visibility-options">Message Visibility Options</h3>
<p>The Agent can dynamically manage the visibility of messages generated by other Agents and historical session messages based on different scenarios. This is configurable through relevant options.
When interacting with the model, only the visible content is passed as input.</p>
<p>TIPS:
- Messages from different sessionIDs are never visible to each other under any circumstances. The following control strategies only apply to messages sharing the same sessionID.
- Invocation.Message always visible regardless of the configuration.
- The related configuration only controls the initial value of State[graph.StateKeyMessages].
- The messages generated by the Agent node have a filterKey corresponding to the subAgent name. As a result, when using <code>IsolatedRequest</code> or <code>IsolatedInvocation</code> for filtering, these messages are not visible to the current GraphAgent.
- When the option is not configured, the default value is FullContext.</p>
<p>Config:
- <code>graphagent.WithMessageFilterMode(MessageFilterMode)</code>:
  - <code>FullContext</code>: Includes historical messages and messages generated in the current request, filtered by prefix matching with the filterKey.
  - <code>RequestContext</code>: Only includes messages generated in the current request, filtered by prefix matching with the filterKey.
  - <code>IsolatedRequest</code>: Only includes messages generated in the current request, filtered by exact matching with the filterKey.
  - <code>IsolatedInvocation</code>: Only includes messages generated in the current Invocation context, filtered by exact matching with the filterKey.</p>
<p>Recommended Usage Examples (These examples are simplified configurations based on advanced usage):</p>
<p>Example 1: Message Visibility Control for graphAgent
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-61-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-61-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-61-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-61-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-61-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-61-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-61-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-61-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-61-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-61-10">10</a></span>
<span class="normal"><a href="#__codelineno-61-11">11</a></span>
<span class="normal"><a href="#__codelineno-61-12">12</a></span>
<span class="normal"><a href="#__codelineno-61-13">13</a></span>
<span class="normal"><a href="#__codelineno-61-14">14</a></span>
<span class="normal"><a href="#__codelineno-61-15">15</a></span>
<span class="normal"><a href="#__codelineno-61-16">16</a></span>
<span class="normal"><a href="#__codelineno-61-17">17</a></span>
<span class="normal"><a href="#__codelineno-61-18">18</a></span>
<span class="normal"><a href="#__codelineno-61-19">19</a></span>
<span class="normal"><a href="#__codelineno-61-20">20</a></span>
<span class="normal"><a href="#__codelineno-61-21">21</a></span>
<span class="normal"><a href="#__codelineno-61-22">22</a></span>
<span class="normal"><a href="#__codelineno-61-23">23</a></span>
<span class="normal"><a href="#__codelineno-61-24">24</a></span>
<span class="normal"><a href="#__codelineno-61-25">25</a></span>
<span class="normal"><a href="#__codelineno-61-26">26</a></span>
<span class="normal"><a href="#__codelineno-61-27">27</a></span>
<span class="normal"><a href="#__codelineno-61-28">28</a></span>
<span class="normal"><a href="#__codelineno-61-29">29</a></span>
<span class="normal"><a href="#__codelineno-61-30">30</a></span>
<span class="normal"><a href="#__codelineno-61-31">31</a></span>
<span class="normal"><a href="#__codelineno-61-32">32</a></span>
<span class="normal"><a href="#__codelineno-61-33">33</a></span>
<span class="normal"><a href="#__codelineno-61-34">34</a></span>
<span class="normal"><a href="#__codelineno-61-35">35</a></span>
<span class="normal"><a href="#__codelineno-61-36">36</a></span>
<span class="normal"><a href="#__codelineno-61-37">37</a></span>
<span class="normal"><a href="#__codelineno-61-38">38</a></span>
<span class="normal"><a href="#__codelineno-61-39">39</a></span>
<span class="normal"><a href="#__codelineno-61-40">40</a></span>
<span class="normal"><a href="#__codelineno-61-41">41</a></span>
<span class="normal"><a href="#__codelineno-61-42">42</a></span>
<span class="normal"><a href="#__codelineno-61-43">43</a></span>
<span class="normal"><a href="#__codelineno-61-44">44</a></span>
<span class="normal"><a href="#__codelineno-61-45">45</a></span>
<span class="normal"><a href="#__codelineno-61-46">46</a></span>
<span class="normal"><a href="#__codelineno-61-47">47</a></span>
<span class="normal"><a href="#__codelineno-61-48">48</a></span>
<span class="normal"><a href="#__codelineno-61-49">49</a></span>
<span class="normal"><a href="#__codelineno-61-50">50</a></span>
<span class="normal"><a href="#__codelineno-61-51">51</a></span>
<span class="normal"><a href="#__codelineno-61-52">52</a></span>
<span class="normal"><a href="#__codelineno-61-53">53</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-61-1"><a id="__codelineno-61-1" name="__codelineno-61-1"></a><span class="nx">subgraphAgentA</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span>
</span><span id="__span-61-2"><a id="__codelineno-61-2" name="__codelineno-61-2"></a><span class="w">    </span><span class="s">&quot;subgraphA&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">subgraph</span><span class="p">,</span>
</span><span id="__span-61-3"><a id="__codelineno-61-3" name="__codelineno-61-3"></a><span class="w">    </span><span class="c1">// All messages generated by parentAgent, subgraphAgentA, and subgraphAgentB (including messages from task1 and task2) are visible (includes historical messages from the same sessionID)</span>
</span><span id="__span-61-4"><a id="__codelineno-61-4" name="__codelineno-61-4"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithMessageFilterMode</span><span class="p">(</span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">FullContext</span><span class="p">),</span>
</span><span id="__span-61-5"><a id="__codelineno-61-5" name="__codelineno-61-5"></a><span class="w">    </span><span class="c1">// All messages generated during the current runner.Run by parentAgent, subgraphAgentA, and subgraphAgentB (including messages from task1 and task2) are visible (excludes historical messages from previous sessions)</span>
</span><span id="__span-61-6"><a id="__codelineno-61-6" name="__codelineno-61-6"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithMessageFilterMode</span><span class="p">(</span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">RequestContext</span><span class="p">),</span>
</span><span id="__span-61-7"><a id="__codelineno-61-7" name="__codelineno-61-7"></a><span class="w">    </span><span class="c1">// Only messages generated by subgraphAgentA during the current runner.Run are visible (excludes its own historical messages)</span>
</span><span id="__span-61-8"><a id="__codelineno-61-8" name="__codelineno-61-8"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithMessageFilterMode</span><span class="p">(</span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">IsolatedRequest</span><span class="p">),</span>
</span><span id="__span-61-9"><a id="__codelineno-61-9" name="__codelineno-61-9"></a><span class="w">    </span><span class="c1">// Only messages generated during the current invocation of subgraphAgentA are visible (in this example, subgraphAgentA executes only once, making it equivalent to graphagent.IsolatedRequest)</span>
</span><span id="__span-61-10"><a id="__codelineno-61-10" name="__codelineno-61-10"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithMessageFilterMode</span><span class="p">(</span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">IsolatedInvocation</span><span class="p">),</span>
</span><span id="__span-61-11"><a id="__codelineno-61-11" name="__codelineno-61-11"></a><span class="p">)</span>
</span><span id="__span-61-12"><a id="__codelineno-61-12" name="__codelineno-61-12"></a>
</span><span id="__span-61-13"><a id="__codelineno-61-13" name="__codelineno-61-13"></a><span class="nx">subgraphAgentB</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span>
</span><span id="__span-61-14"><a id="__codelineno-61-14" name="__codelineno-61-14"></a><span class="w">    </span><span class="s">&quot;subgraphB&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">subgraph</span><span class="p">,</span>
</span><span id="__span-61-15"><a id="__codelineno-61-15" name="__codelineno-61-15"></a><span class="w">    </span><span class="c1">// All messages generated by parentAgent, subgraphAgentA, and subgraphAgentB (including messages from task1 and task2) are visible (includes historical messages from the same sessionID)</span>
</span><span id="__span-61-16"><a id="__codelineno-61-16" name="__codelineno-61-16"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithMessageFilterMode</span><span class="p">(</span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">FullContext</span><span class="p">),</span>
</span><span id="__span-61-17"><a id="__codelineno-61-17" name="__codelineno-61-17"></a><span class="w">    </span><span class="c1">// All messages generated during the current runner.Run by parentAgent, subgraphAgentA, and subgraphAgentB (including messages from task1 and task2) are visible (excludes historical messages from previous sessions)</span>
</span><span id="__span-61-18"><a id="__codelineno-61-18" name="__codelineno-61-18"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithMessageFilterMode</span><span class="p">(</span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">RequestContext</span><span class="p">),</span>
</span><span id="__span-61-19"><a id="__codelineno-61-19" name="__codelineno-61-19"></a><span class="w">    </span><span class="c1">// Only messages generated by subgraphAgentB (including messages from task1 and task2) during the current runner.Run are visible (excludes its own historical messages)</span>
</span><span id="__span-61-20"><a id="__codelineno-61-20" name="__codelineno-61-20"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithMessageFilterMode</span><span class="p">(</span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">IsolatedRequest</span><span class="p">),</span>
</span><span id="__span-61-21"><a id="__codelineno-61-21" name="__codelineno-61-21"></a><span class="w">    </span><span class="c1">// Only messages generated during the current invocation of subgraphAgentB are visible, excluding historical messages (messages generated during task1 and task2 executions are not visible to each other).</span>
</span><span id="__span-61-22"><a id="__codelineno-61-22" name="__codelineno-61-22"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithMessageFilterMode</span><span class="p">(</span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">IsolatedInvocation</span><span class="p">),</span>
</span><span id="__span-61-23"><a id="__codelineno-61-23" name="__codelineno-61-23"></a><span class="p">)</span>
</span><span id="__span-61-24"><a id="__codelineno-61-24" name="__codelineno-61-24"></a>
</span><span id="__span-61-25"><a id="__codelineno-61-25" name="__codelineno-61-25"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddAgentNode</span><span class="p">(</span><span class="s">&quot;subgraphA&quot;</span><span class="p">)</span>
</span><span id="__span-61-26"><a id="__codelineno-61-26" name="__codelineno-61-26"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;fanout&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-27"><a id="__codelineno-61-27" name="__codelineno-61-27"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">[]</span><span class="o">*</span><span class="nx">graph</span><span class="p">.</span><span class="nx">Command</span><span class="p">{</span>
</span><span id="__span-61-28"><a id="__codelineno-61-28" name="__codelineno-61-28"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-61-29"><a id="__codelineno-61-29" name="__codelineno-61-29"></a><span class="w">            </span><span class="nx">GoTo</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;subgraph&quot;</span><span class="p">,</span>
</span><span id="__span-61-30"><a id="__codelineno-61-30" name="__codelineno-61-30"></a><span class="w">            </span><span class="nx">Update</span><span class="p">:</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span>
</span><span id="__span-61-31"><a id="__codelineno-61-31" name="__codelineno-61-31"></a><span class="w">                </span><span class="s">&quot;task&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;task 1&quot;</span>
</span><span id="__span-61-32"><a id="__codelineno-61-32" name="__codelineno-61-32"></a><span class="w">            </span><span class="p">},</span>
</span><span id="__span-61-33"><a id="__codelineno-61-33" name="__codelineno-61-33"></a><span class="w">        </span><span class="p">},</span>
</span><span id="__span-61-34"><a id="__codelineno-61-34" name="__codelineno-61-34"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-61-35"><a id="__codelineno-61-35" name="__codelineno-61-35"></a><span class="w">            </span><span class="nx">GoTo</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;subgraph&quot;</span><span class="p">,</span>
</span><span id="__span-61-36"><a id="__codelineno-61-36" name="__codelineno-61-36"></a><span class="w">            </span><span class="nx">Update</span><span class="p">:</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span>
</span><span id="__span-61-37"><a id="__codelineno-61-37" name="__codelineno-61-37"></a><span class="w">                </span><span class="s">&quot;task&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;task 2&quot;</span>
</span><span id="__span-61-38"><a id="__codelineno-61-38" name="__codelineno-61-38"></a><span class="w">            </span><span class="p">},</span>
</span><span id="__span-61-39"><a id="__codelineno-61-39" name="__codelineno-61-39"></a><span class="w">        </span><span class="p">},</span>
</span><span id="__span-61-40"><a id="__codelineno-61-40" name="__codelineno-61-40"></a><span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-61-41"><a id="__codelineno-61-41" name="__codelineno-61-41"></a><span class="p">})</span>
</span><span id="__span-61-42"><a id="__codelineno-61-42" name="__codelineno-61-42"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddAgentNode</span><span class="p">(</span><span class="s">&quot;subgraphB&quot;</span><span class="p">)</span>
</span><span id="__span-61-43"><a id="__codelineno-61-43" name="__codelineno-61-43"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddEdge</span><span class="p">(</span><span class="s">&quot;subgraphA&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;fanout&quot;</span><span class="p">)</span>
</span><span id="__span-61-44"><a id="__codelineno-61-44" name="__codelineno-61-44"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">SetEntryPoint</span><span class="p">(</span><span class="nx">subgraphA</span><span class="p">)</span>
</span><span id="__span-61-45"><a id="__codelineno-61-45" name="__codelineno-61-45"></a><span class="nx">graph</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">sg</span><span class="p">.</span><span class="nx">Compile</span><span class="p">()</span>
</span><span id="__span-61-46"><a id="__codelineno-61-46" name="__codelineno-61-46"></a><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-47"><a id="__codelineno-61-47" name="__codelineno-61-47"></a><span class="w">    </span><span class="nx">log</span><span class="p">.</span><span class="nx">Fatalf</span><span class="p">(</span><span class="s">&quot;Failed to Compile state graph, err: %w&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
</span><span id="__span-61-48"><a id="__codelineno-61-48" name="__codelineno-61-48"></a><span class="p">}</span>
</span><span id="__span-61-49"><a id="__codelineno-61-49" name="__codelineno-61-49"></a><span class="nx">parentAgent</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span>
</span><span id="__span-61-50"><a id="__codelineno-61-50" name="__codelineno-61-50"></a><span class="w">    </span><span class="s">&quot;subgraph&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">graph</span><span class="p">,</span>
</span><span id="__span-61-51"><a id="__codelineno-61-51" name="__codelineno-61-51"></a><span class="w">    </span><span class="c1">// subagent</span>
</span><span id="__span-61-52"><a id="__codelineno-61-52" name="__codelineno-61-52"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithSubAgents</span><span class="p">(</span><span class="nx">subgraphAgent</span><span class="p">)</span>
</span><span id="__span-61-53"><a id="__codelineno-61-53" name="__codelineno-61-53"></a><span class="p">)</span>
</span></code></pre></div></td></tr></table></div></p>
<p>Example 2: Message Visibility Control for LLM Agent node
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-62-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-62-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-62-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-62-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-62-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-62-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-62-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-62-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-62-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-62-10">10</a></span>
<span class="normal"><a href="#__codelineno-62-11">11</a></span>
<span class="normal"><a href="#__codelineno-62-12">12</a></span>
<span class="normal"><a href="#__codelineno-62-13">13</a></span>
<span class="normal"><a href="#__codelineno-62-14">14</a></span>
<span class="normal"><a href="#__codelineno-62-15">15</a></span>
<span class="normal"><a href="#__codelineno-62-16">16</a></span>
<span class="normal"><a href="#__codelineno-62-17">17</a></span>
<span class="normal"><a href="#__codelineno-62-18">18</a></span>
<span class="normal"><a href="#__codelineno-62-19">19</a></span>
<span class="normal"><a href="#__codelineno-62-20">20</a></span>
<span class="normal"><a href="#__codelineno-62-21">21</a></span>
<span class="normal"><a href="#__codelineno-62-22">22</a></span>
<span class="normal"><a href="#__codelineno-62-23">23</a></span>
<span class="normal"><a href="#__codelineno-62-24">24</a></span>
<span class="normal"><a href="#__codelineno-62-25">25</a></span>
<span class="normal"><a href="#__codelineno-62-26">26</a></span>
<span class="normal"><a href="#__codelineno-62-27">27</a></span>
<span class="normal"><a href="#__codelineno-62-28">28</a></span>
<span class="normal"><a href="#__codelineno-62-29">29</a></span>
<span class="normal"><a href="#__codelineno-62-30">30</a></span>
<span class="normal"><a href="#__codelineno-62-31">31</a></span>
<span class="normal"><a href="#__codelineno-62-32">32</a></span>
<span class="normal"><a href="#__codelineno-62-33">33</a></span>
<span class="normal"><a href="#__codelineno-62-34">34</a></span>
<span class="normal"><a href="#__codelineno-62-35">35</a></span>
<span class="normal"><a href="#__codelineno-62-36">36</a></span>
<span class="normal"><a href="#__codelineno-62-37">37</a></span>
<span class="normal"><a href="#__codelineno-62-38">38</a></span>
<span class="normal"><a href="#__codelineno-62-39">39</a></span>
<span class="normal"><a href="#__codelineno-62-40">40</a></span>
<span class="normal"><a href="#__codelineno-62-41">41</a></span>
<span class="normal"><a href="#__codelineno-62-42">42</a></span>
<span class="normal"><a href="#__codelineno-62-43">43</a></span>
<span class="normal"><a href="#__codelineno-62-44">44</a></span>
<span class="normal"><a href="#__codelineno-62-45">45</a></span>
<span class="normal"><a href="#__codelineno-62-46">46</a></span>
<span class="normal"><a href="#__codelineno-62-47">47</a></span>
<span class="normal"><a href="#__codelineno-62-48">48</a></span>
<span class="normal"><a href="#__codelineno-62-49">49</a></span>
<span class="normal"><a href="#__codelineno-62-50">50</a></span>
<span class="normal"><a href="#__codelineno-62-51">51</a></span>
<span class="normal"><a href="#__codelineno-62-52">52</a></span>
<span class="normal"><a href="#__codelineno-62-53">53</a></span>
<span class="normal"><a href="#__codelineno-62-54">54</a></span>
<span class="normal"><a href="#__codelineno-62-55">55</a></span>
<span class="normal"><a href="#__codelineno-62-56">56</a></span>
<span class="normal"><a href="#__codelineno-62-57">57</a></span>
<span class="normal"><a href="#__codelineno-62-58">58</a></span>
<span class="normal"><a href="#__codelineno-62-59">59</a></span>
<span class="normal"><a href="#__codelineno-62-60">60</a></span>
<span class="normal"><a href="#__codelineno-62-61">61</a></span>
<span class="normal"><a href="#__codelineno-62-62">62</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-62-1"><a id="__codelineno-62-1" name="__codelineno-62-1"></a><span class="nx">taskagentA</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">llmagent</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span>
</span><span id="__span-62-2"><a id="__codelineno-62-2" name="__codelineno-62-2"></a><span class="w">  </span><span class="s">&quot;coordinator&quot;</span><span class="p">,</span>
</span><span id="__span-62-3"><a id="__codelineno-62-3" name="__codelineno-62-3"></a><span class="w">  </span><span class="nx">llmagent</span><span class="p">.</span><span class="nx">WithModel</span><span class="p">(</span><span class="nx">modelInstance</span><span class="p">),</span>
</span><span id="__span-62-4"><a id="__codelineno-62-4" name="__codelineno-62-4"></a><span class="w">  </span><span class="c1">// Makes all messages generated by taskagentA and taskagentB visible (including historical session messages under the same sessionID)</span>
</span><span id="__span-62-5"><a id="__codelineno-62-5" name="__codelineno-62-5"></a><span class="w">  </span><span class="nx">llmagent</span><span class="p">.</span><span class="nx">WithMessageFilterMode</span><span class="p">(</span><span class="nx">llmagent</span><span class="p">.</span><span class="nx">FullContext</span><span class="p">),</span>
</span><span id="__span-62-6"><a id="__codelineno-62-6" name="__codelineno-62-6"></a><span class="w">  </span><span class="c1">// Makes all messages generated during the current runner.Run of taskagentA and taskagentB visible (excluding historical session messages)</span>
</span><span id="__span-62-7"><a id="__codelineno-62-7" name="__codelineno-62-7"></a><span class="w">  </span><span class="nx">llmagent</span><span class="p">.</span><span class="nx">WithMessageFilterMode</span><span class="p">(</span><span class="nx">llmagent</span><span class="p">.</span><span class="nx">RequestContext</span><span class="p">),</span>
</span><span id="__span-62-8"><a id="__codelineno-62-8" name="__codelineno-62-8"></a><span class="w">  </span><span class="c1">// Only makes messages generated during the current runner.Run of taskagentA visible (excluding its own historical session messages)</span>
</span><span id="__span-62-9"><a id="__codelineno-62-9" name="__codelineno-62-9"></a><span class="w">  </span><span class="nx">llmagent</span><span class="p">.</span><span class="nx">WithMessageFilterMode</span><span class="p">(</span><span class="nx">llmagent</span><span class="p">.</span><span class="nx">IsolatedRequest</span><span class="p">),</span>
</span><span id="__span-62-10"><a id="__codelineno-62-10" name="__codelineno-62-10"></a><span class="w">  </span><span class="c1">// Agent execution order: taskagentA-invocation1 -&gt; taskagentB-invocation2 -&gt; taskagentA-invocation3 (current execution phase)</span>
</span><span id="__span-62-11"><a id="__codelineno-62-11" name="__codelineno-62-11"></a><span class="w">  </span><span class="c1">// Only makes messages generated during the current taskagentA-invocation3 phase visible (excluding its own historical session messages and messages generated during taskagentA-invocation1)</span>
</span><span id="__span-62-12"><a id="__codelineno-62-12" name="__codelineno-62-12"></a><span class="w">  </span><span class="nx">llmagent</span><span class="p">.</span><span class="nx">WithMessageFilterMode</span><span class="p">(</span><span class="nx">llmagent</span><span class="p">.</span><span class="nx">IsolatedInvocation</span><span class="p">),</span>
</span><span id="__span-62-13"><a id="__codelineno-62-13" name="__codelineno-62-13"></a><span class="p">)</span>
</span><span id="__span-62-14"><a id="__codelineno-62-14" name="__codelineno-62-14"></a>
</span><span id="__span-62-15"><a id="__codelineno-62-15" name="__codelineno-62-15"></a><span class="nx">taskagentB</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">llmagent</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span>
</span><span id="__span-62-16"><a id="__codelineno-62-16" name="__codelineno-62-16"></a><span class="w">  </span><span class="s">&quot;coordinator&quot;</span><span class="p">,</span>
</span><span id="__span-62-17"><a id="__codelineno-62-17" name="__codelineno-62-17"></a><span class="w">  </span><span class="nx">llmagent</span><span class="p">.</span><span class="nx">WithModel</span><span class="p">(</span><span class="nx">modelInstance</span><span class="p">),</span>
</span><span id="__span-62-18"><a id="__codelineno-62-18" name="__codelineno-62-18"></a><span class="w">  </span><span class="c1">// Makes all messages generated by taskagentA and taskagentB visible (including historical session messages under the same sessionID)</span>
</span><span id="__span-62-19"><a id="__codelineno-62-19" name="__codelineno-62-19"></a><span class="w">  </span><span class="nx">llmagent</span><span class="p">.</span><span class="nx">WithMessageFilterMode</span><span class="p">(</span><span class="nx">llmagent</span><span class="p">.</span><span class="nx">FullContext</span><span class="p">),</span>
</span><span id="__span-62-20"><a id="__codelineno-62-20" name="__codelineno-62-20"></a><span class="w">  </span><span class="c1">// Makes all messages generated during the current runner.Run of taskagentA and taskagentB visible (excluding historical session messages)</span>
</span><span id="__span-62-21"><a id="__codelineno-62-21" name="__codelineno-62-21"></a><span class="w">  </span><span class="nx">llmagent</span><span class="p">.</span><span class="nx">WithMessageFilterMode</span><span class="p">(</span><span class="nx">llmagent</span><span class="p">.</span><span class="nx">RequestContext</span><span class="p">),</span>
</span><span id="__span-62-22"><a id="__codelineno-62-22" name="__codelineno-62-22"></a><span class="w">  </span><span class="c1">// Only makes messages generated during the current runner.Run of taskagentB visible (excluding its own historical session messages)</span>
</span><span id="__span-62-23"><a id="__codelineno-62-23" name="__codelineno-62-23"></a><span class="w">  </span><span class="nx">llmagent</span><span class="p">.</span><span class="nx">WithMessageFilterMode</span><span class="p">(</span><span class="nx">llmagent</span><span class="p">.</span><span class="nx">IsolatedRequest</span><span class="p">),</span>
</span><span id="__span-62-24"><a id="__codelineno-62-24" name="__codelineno-62-24"></a><span class="w">  </span><span class="c1">// Agent execution order: taskagentA-invocation1 -&gt; taskagentB-invocation2 -&gt; taskagentA-invocation3 -&gt; taskagentB-invocation4 (current execution phase)</span>
</span><span id="__span-62-25"><a id="__codelineno-62-25" name="__codelineno-62-25"></a><span class="w">  </span><span class="c1">// Only makes messages generated during the current taskagentB-invocation4 phase visible (excluding its own historical session messages and messages generated during taskagentB-invocation2)</span>
</span><span id="__span-62-26"><a id="__codelineno-62-26" name="__codelineno-62-26"></a><span class="w">  </span><span class="nx">llmagent</span><span class="p">.</span><span class="nx">WithMessageFilterMode</span><span class="p">(</span><span class="nx">llmagent</span><span class="p">.</span><span class="nx">IsolatedInvocation</span><span class="p">),</span>
</span><span id="__span-62-27"><a id="__codelineno-62-27" name="__codelineno-62-27"></a><span class="p">)</span>
</span><span id="__span-62-28"><a id="__codelineno-62-28" name="__codelineno-62-28"></a>
</span><span id="__span-62-29"><a id="__codelineno-62-29" name="__codelineno-62-29"></a><span class="c1">// Cyclically execute taskagentA and taskagentB</span>
</span><span id="__span-62-30"><a id="__codelineno-62-30" name="__codelineno-62-30"></a><span class="nx">cycleAgent</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">cycleagent</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span>
</span><span id="__span-62-31"><a id="__codelineno-62-31" name="__codelineno-62-31"></a><span class="w">  </span><span class="s">&quot;coordinator&quot;</span><span class="p">,</span>
</span><span id="__span-62-32"><a id="__codelineno-62-32" name="__codelineno-62-32"></a><span class="w">  </span><span class="nx">llmagent</span><span class="p">.</span><span class="nx">WithModel</span><span class="p">(</span><span class="nx">modelInstance</span><span class="p">),</span>
</span><span id="__span-62-33"><a id="__codelineno-62-33" name="__codelineno-62-33"></a><span class="w">  </span><span class="nx">llmagent</span><span class="p">.</span><span class="nx">WithSubAgents</span><span class="p">([]</span><span class="nx">agent</span><span class="p">.</span><span class="nx">Agent</span><span class="p">{</span><span class="nx">taskagentA</span><span class="p">,</span><span class="w"> </span><span class="nx">taskagentB</span><span class="p">}),</span>
</span><span id="__span-62-34"><a id="__codelineno-62-34" name="__codelineno-62-34"></a><span class="w">  </span><span class="nx">llmagent</span><span class="p">.</span><span class="nx">WithMessageFilterMode</span><span class="p">(</span><span class="nx">llmagent</span><span class="p">.</span><span class="nx">FullContext</span><span class="p">)</span>
</span><span id="__span-62-35"><a id="__codelineno-62-35" name="__codelineno-62-35"></a><span class="p">)</span>
</span><span id="__span-62-36"><a id="__codelineno-62-36" name="__codelineno-62-36"></a>
</span><span id="__span-62-37"><a id="__codelineno-62-37" name="__codelineno-62-37"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddAgentNode</span><span class="p">(</span><span class="s">&quot;taskagentA&quot;</span><span class="p">)</span>
</span><span id="__span-62-38"><a id="__codelineno-62-38" name="__codelineno-62-38"></a><span class="c1">// Execute multiple tasks in parallel at the same time</span>
</span><span id="__span-62-39"><a id="__codelineno-62-39" name="__codelineno-62-39"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;fanout&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-62-40"><a id="__codelineno-62-40" name="__codelineno-62-40"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">[]</span><span class="o">*</span><span class="nx">graph</span><span class="p">.</span><span class="nx">Command</span><span class="p">{</span>
</span><span id="__span-62-41"><a id="__codelineno-62-41" name="__codelineno-62-41"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-62-42"><a id="__codelineno-62-42" name="__codelineno-62-42"></a><span class="w">            </span><span class="nx">GoTo</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;taskB&quot;</span><span class="p">,</span>
</span><span id="__span-62-43"><a id="__codelineno-62-43" name="__codelineno-62-43"></a><span class="w">            </span><span class="nx">Update</span><span class="p">:</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span>
</span><span id="__span-62-44"><a id="__codelineno-62-44" name="__codelineno-62-44"></a><span class="w">                </span><span class="s">&quot;task&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;task 1&quot;</span>
</span><span id="__span-62-45"><a id="__codelineno-62-45" name="__codelineno-62-45"></a><span class="w">            </span><span class="p">},</span>
</span><span id="__span-62-46"><a id="__codelineno-62-46" name="__codelineno-62-46"></a><span class="w">        </span><span class="p">},</span>
</span><span id="__span-62-47"><a id="__codelineno-62-47" name="__codelineno-62-47"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-62-48"><a id="__codelineno-62-48" name="__codelineno-62-48"></a><span class="w">            </span><span class="nx">GoTo</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;taskB&quot;</span><span class="p">,</span>
</span><span id="__span-62-49"><a id="__codelineno-62-49" name="__codelineno-62-49"></a><span class="w">            </span><span class="nx">Update</span><span class="p">:</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span>
</span><span id="__span-62-50"><a id="__codelineno-62-50" name="__codelineno-62-50"></a><span class="w">                </span><span class="s">&quot;task&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;task 2&quot;</span>
</span><span id="__span-62-51"><a id="__codelineno-62-51" name="__codelineno-62-51"></a><span class="w">            </span><span class="p">},</span>
</span><span id="__span-62-52"><a id="__codelineno-62-52" name="__codelineno-62-52"></a><span class="w">        </span><span class="p">},</span>
</span><span id="__span-62-53"><a id="__codelineno-62-53" name="__codelineno-62-53"></a><span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-62-54"><a id="__codelineno-62-54" name="__codelineno-62-54"></a><span class="p">})</span>
</span><span id="__span-62-55"><a id="__codelineno-62-55" name="__codelineno-62-55"></a><span class="c1">// You can set the message filter mode of taskagentB to llmagent.IsolatedInvocation to isolate contextual conversation information between multiple tasks.</span>
</span><span id="__span-62-56"><a id="__codelineno-62-56" name="__codelineno-62-56"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;taskB&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">){</span>
</span><span id="__span-62-57"><a id="__codelineno-62-57" name="__codelineno-62-57"></a><span class="w">    </span><span class="nx">task</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">state</span><span class="p">[</span><span class="s">&quot;task-id&quot;</span><span class="p">]</span>
</span><span id="__span-62-58"><a id="__codelineno-62-58" name="__codelineno-62-58"></a><span class="w">    </span><span class="nx">inv</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">agent</span><span class="p">.</span><span class="nx">InvocationFromContext</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</span><span id="__span-62-59"><a id="__codelineno-62-59" name="__codelineno-62-59"></a><span class="w">    </span><span class="nx">inv</span><span class="p">.</span><span class="nx">Message</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">model</span><span class="p">.</span><span class="nx">NewUserMessage</span><span class="p">(</span><span class="nx">task</span><span class="p">)</span>
</span><span id="__span-62-60"><a id="__codelineno-62-60" name="__codelineno-62-60"></a><span class="w">    </span><span class="kd">chan</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">taskagentB</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">inv</span><span class="p">)</span>
</span><span id="__span-62-61"><a id="__codelineno-62-61" name="__codelineno-62-61"></a><span class="w">    </span><span class="c1">// do any thing</span>
</span><span id="__span-62-62"><a id="__codelineno-62-62" name="__codelineno-62-62"></a><span class="p">})</span>
</span></code></pre></div></td></tr></table></div></p>
<p>Advanced Usage Examples:
You can independently control the visibility of historical messages and messages generated by other Agents for the current agent using WithMessageTimelineFilterModeand WithMessageBranchFilterMode.
When the current agent interacts with the model, only messages satisfying both conditions are input to the model. (invocation.Messageis always visible in any scenario.)
- <code>WithMessageTimelineFilterMode</code>: Controls visibility from a temporal dimension
  - <code>TimelineFilterAll</code>: Includes historical messages and messages generated in the current request.
  - <code>TimelineFilterCurrentRequest</code>: Only includes messages generated in the current request (one runner.Runcounts as one request).
  - <code>TimelineFilterCurrentInvocation</code>: Only includes messages generated in the current invocation context.
- <code>WithMessageBranchFilterMode</code>: Controls visibility from a branch dimension (used to manage visibility of messages generated by other agents).
  - <code>BranchFilterModePrefix</code>: Uses prefix matching between Event.FilterKeyand Invocation.eventFilterKey.
  - <code>BranchFilterModeAll</code>: Includes messages from all agents.
  - <code>BranchFilterModeExact</code>: Only includes messages generated by the current agent.</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-63-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-63-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-63-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-63-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-63-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-63-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-63-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-63-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-63-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-63-10">10</a></span>
<span class="normal"><a href="#__codelineno-63-11">11</a></span>
<span class="normal"><a href="#__codelineno-63-12">12</a></span>
<span class="normal"><a href="#__codelineno-63-13">13</a></span>
<span class="normal"><a href="#__codelineno-63-14">14</a></span>
<span class="normal"><a href="#__codelineno-63-15">15</a></span>
<span class="normal"><a href="#__codelineno-63-16">16</a></span>
<span class="normal"><a href="#__codelineno-63-17">17</a></span>
<span class="normal"><a href="#__codelineno-63-18">18</a></span>
<span class="normal"><a href="#__codelineno-63-19">19</a></span>
<span class="normal"><a href="#__codelineno-63-20">20</a></span>
<span class="normal"><a href="#__codelineno-63-21">21</a></span>
<span class="normal"><a href="#__codelineno-63-22">22</a></span>
<span class="normal"><a href="#__codelineno-63-23">23</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-63-1"><a id="__codelineno-63-1" name="__codelineno-63-1"></a><span class="nx">llmAgent</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">llmagent</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span>
</span><span id="__span-63-2"><a id="__codelineno-63-2" name="__codelineno-63-2"></a><span class="w">    </span><span class="s">&quot;demo-agent&quot;</span><span class="p">,</span><span class="w">                      </span><span class="c1">// Agent name</span>
</span><span id="__span-63-3"><a id="__codelineno-63-3" name="__codelineno-63-3"></a><span class="w">    </span><span class="nx">llmagent</span><span class="p">.</span><span class="nx">WithModel</span><span class="p">(</span><span class="nx">modelInstance</span><span class="p">),</span><span class="w"> </span><span class="c1">// Set the model</span>
</span><span id="__span-63-4"><a id="__codelineno-63-4" name="__codelineno-63-4"></a><span class="w">    </span><span class="nx">llmagent</span><span class="p">.</span><span class="nx">WithDescription</span><span class="p">(</span><span class="s">&quot;A helpful AI assistant for demonstrations&quot;</span><span class="p">),</span><span class="w">              </span><span class="c1">// Set description</span>
</span><span id="__span-63-5"><a id="__codelineno-63-5" name="__codelineno-63-5"></a><span class="w">    </span><span class="nx">llmagent</span><span class="p">.</span><span class="nx">WithInstruction</span><span class="p">(</span><span class="s">&quot;Be helpful, concise, and informative in your responses&quot;</span><span class="p">),</span><span class="w"> </span><span class="c1">// Set instruction</span>
</span><span id="__span-63-6"><a id="__codelineno-63-6" name="__codelineno-63-6"></a><span class="w">    </span><span class="nx">llmagent</span><span class="p">.</span><span class="nx">WithGenerationConfig</span><span class="p">(</span><span class="nx">genConfig</span><span class="p">),</span><span class="w">                                           </span><span class="c1">// Set generation parameters</span>
</span><span id="__span-63-7"><a id="__codelineno-63-7" name="__codelineno-63-7"></a>
</span><span id="__span-63-8"><a id="__codelineno-63-8" name="__codelineno-63-8"></a><span class="w">    </span><span class="c1">// Set the message filtering mode for input to the model. The final messages passed to the model must satisfy both WithMessageTimelineFilterMode and WithMessageBranchFilterMode conditions.</span>
</span><span id="__span-63-9"><a id="__codelineno-63-9" name="__codelineno-63-9"></a><span class="w">    </span><span class="c1">// Temporal dimension filtering condition</span>
</span><span id="__span-63-10"><a id="__codelineno-63-10" name="__codelineno-63-10"></a><span class="w">    </span><span class="c1">// Default: llmagent.TimelineFilterAll</span>
</span><span id="__span-63-11"><a id="__codelineno-63-11" name="__codelineno-63-11"></a><span class="w">    </span><span class="c1">// Options:</span>
</span><span id="__span-63-12"><a id="__codelineno-63-12" name="__codelineno-63-12"></a><span class="w">    </span><span class="c1">//  - llmagent.TimelineFilterAll: Includes historical messages and messages generated in the current request.</span>
</span><span id="__span-63-13"><a id="__codelineno-63-13" name="__codelineno-63-13"></a><span class="w">    </span><span class="c1">//  - llmagent.TimelineFilterCurrentRequest: Only includes messages generated in the current request.</span>
</span><span id="__span-63-14"><a id="__codelineno-63-14" name="__codelineno-63-14"></a><span class="w">    </span><span class="c1">//  - llmagent.TimelineFilterCurrentInvocation: Only includes messages generated in the current invocation context.</span>
</span><span id="__span-63-15"><a id="__codelineno-63-15" name="__codelineno-63-15"></a><span class="w">    </span><span class="nx">llmagent</span><span class="p">.</span><span class="nx">WithMessageTimelineFilterMode</span><span class="p">(</span><span class="nx">llmagent</span><span class="p">.</span><span class="nx">TimelineFilterAll</span><span class="p">),</span>
</span><span id="__span-63-16"><a id="__codelineno-63-16" name="__codelineno-63-16"></a><span class="w">    </span><span class="c1">// Branch dimension filtering condition</span>
</span><span id="__span-63-17"><a id="__codelineno-63-17" name="__codelineno-63-17"></a><span class="w">    </span><span class="c1">// Default: llmagent.BranchFilterModePrefix</span>
</span><span id="__span-63-18"><a id="__codelineno-63-18" name="__codelineno-63-18"></a><span class="w">    </span><span class="c1">// Options:</span>
</span><span id="__span-63-19"><a id="__codelineno-63-19" name="__codelineno-63-19"></a><span class="w">    </span><span class="c1">//  - llmagent.BranchFilterModeAll: Includes messages from all agents. Use this when the current agent needs to sync valid content messages generated by all agents to the model during interaction.</span>
</span><span id="__span-63-20"><a id="__codelineno-63-20" name="__codelineno-63-20"></a><span class="w">    </span><span class="c1">//  - llmagent.BranchFilterModePrefix: Filters messages by prefix matching Event.FilterKey with Invocation.eventFilterKey. Use this when you want to pass messages generated by the current agent and related upstream/downstream agents to the model.</span>
</span><span id="__span-63-21"><a id="__codelineno-63-21" name="__codelineno-63-21"></a><span class="w">    </span><span class="c1">//  - llmagent.BranchFilterModeExact: Filters messages where Event.FilterKey exactly matches Invocation.eventFilterKey. Use this when the current agent only needs to use messages generated by itself during model interaction.</span>
</span><span id="__span-63-22"><a id="__codelineno-63-22" name="__codelineno-63-22"></a><span class="w">    </span><span class="nx">llmagent</span><span class="p">.</span><span class="nx">WithMessageBranchFilterMode</span><span class="p">(</span><span class="nx">llmagent</span><span class="p">.</span><span class="nx">BranchFilterModeAll</span><span class="p">),</span>
</span><span id="__span-63-23"><a id="__codelineno-63-23" name="__codelineno-63-23"></a><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="command-mode-dynamic-routing-fanout">Command Mode (Dynamic Routing / Fan‑out)</h3>
<p>Nodes can return <code>graph.State</code>, or <code>*graph.Command</code> / <code>[]*graph.Command</code> to update state and direct the next hop:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-64-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-64-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-64-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-64-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-64-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-64-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-64-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-64-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-64-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-64-10">10</a></span>
<span class="normal"><a href="#__codelineno-64-11">11</a></span>
<span class="normal"><a href="#__codelineno-64-12">12</a></span>
<span class="normal"><a href="#__codelineno-64-13">13</a></span>
<span class="normal"><a href="#__codelineno-64-14">14</a></span>
<span class="normal"><a href="#__codelineno-64-15">15</a></span>
<span class="normal"><a href="#__codelineno-64-16">16</a></span>
<span class="normal"><a href="#__codelineno-64-17">17</a></span>
<span class="normal"><a href="#__codelineno-64-18">18</a></span>
<span class="normal"><a href="#__codelineno-64-19">19</a></span>
<span class="normal"><a href="#__codelineno-64-20">20</a></span>
<span class="normal"><a href="#__codelineno-64-21">21</a></span>
<span class="normal"><a href="#__codelineno-64-22">22</a></span>
<span class="normal"><a href="#__codelineno-64-23">23</a></span>
<span class="normal"><a href="#__codelineno-64-24">24</a></span>
<span class="normal"><a href="#__codelineno-64-25">25</a></span>
<span class="normal"><a href="#__codelineno-64-26">26</a></span>
<span class="normal"><a href="#__codelineno-64-27">27</a></span>
<span class="normal"><a href="#__codelineno-64-28">28</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-64-1"><a id="__codelineno-64-1" name="__codelineno-64-1"></a><span class="c1">// Dynamic route to A or B with a state write</span>
</span><span id="__span-64-2"><a id="__codelineno-64-2" name="__codelineno-64-2"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-64-3"><a id="__codelineno-64-3" name="__codelineno-64-3"></a><span class="w">    </span><span class="nx">nodeDecide</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;decide&quot;</span>
</span><span id="__span-64-4"><a id="__codelineno-64-4" name="__codelineno-64-4"></a><span class="w">    </span><span class="nx">nodeA</span><span class="w">      </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;A&quot;</span>
</span><span id="__span-64-5"><a id="__codelineno-64-5" name="__codelineno-64-5"></a><span class="w">    </span><span class="nx">nodeB</span><span class="w">      </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;B&quot;</span>
</span><span id="__span-64-6"><a id="__codelineno-64-6" name="__codelineno-64-6"></a><span class="w">    </span><span class="nx">stateKeyFlag</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;flag&quot;</span>
</span><span id="__span-64-7"><a id="__codelineno-64-7" name="__codelineno-64-7"></a><span class="p">)</span>
</span><span id="__span-64-8"><a id="__codelineno-64-8" name="__codelineno-64-8"></a>
</span><span id="__span-64-9"><a id="__codelineno-64-9" name="__codelineno-64-9"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="nx">nodeDecide</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-64-10"><a id="__codelineno-64-10" name="__codelineno-64-10"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">s</span><span class="p">[</span><span class="nx">stateKeyFlag</span><span class="p">].(</span><span class="kt">bool</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-64-11"><a id="__codelineno-64-11" name="__codelineno-64-11"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">graph</span><span class="p">.</span><span class="nx">Command</span><span class="p">{</span><span class="nx">Update</span><span class="p">:</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="s">&quot;routed&quot;</span><span class="p">:</span><span class="w"> </span><span class="nx">nodeA</span><span class="p">},</span><span class="w"> </span><span class="nx">GoTo</span><span class="p">:</span><span class="w"> </span><span class="nx">nodeA</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-64-12"><a id="__codelineno-64-12" name="__codelineno-64-12"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-64-13"><a id="__codelineno-64-13" name="__codelineno-64-13"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">graph</span><span class="p">.</span><span class="nx">Command</span><span class="p">{</span><span class="nx">Update</span><span class="p">:</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="s">&quot;routed&quot;</span><span class="p">:</span><span class="w"> </span><span class="nx">nodeB</span><span class="p">},</span><span class="w"> </span><span class="nx">GoTo</span><span class="p">:</span><span class="w"> </span><span class="nx">nodeB</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-64-14"><a id="__codelineno-64-14" name="__codelineno-64-14"></a><span class="p">})</span>
</span><span id="__span-64-15"><a id="__codelineno-64-15" name="__codelineno-64-15"></a>
</span><span id="__span-64-16"><a id="__codelineno-64-16" name="__codelineno-64-16"></a><span class="c1">// Fan-out: dispatch multiple tasks to the same worker in parallel</span>
</span><span id="__span-64-17"><a id="__codelineno-64-17" name="__codelineno-64-17"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-64-18"><a id="__codelineno-64-18" name="__codelineno-64-18"></a><span class="w">    </span><span class="nx">nodeFanout</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;fanout&quot;</span>
</span><span id="__span-64-19"><a id="__codelineno-64-19" name="__codelineno-64-19"></a><span class="w">    </span><span class="nx">nodeWorker</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;worker&quot;</span>
</span><span id="__span-64-20"><a id="__codelineno-64-20" name="__codelineno-64-20"></a><span class="p">)</span>
</span><span id="__span-64-21"><a id="__codelineno-64-21" name="__codelineno-64-21"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="nx">nodeFanout</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-64-22"><a id="__codelineno-64-22" name="__codelineno-64-22"></a><span class="w">    </span><span class="nx">cmds</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">[]</span><span class="o">*</span><span class="nx">graph</span><span class="p">.</span><span class="nx">Command</span><span class="p">{</span>
</span><span id="__span-64-23"><a id="__codelineno-64-23" name="__codelineno-64-23"></a><span class="w">        </span><span class="p">{</span><span class="nx">Update</span><span class="p">:</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="s">&quot;param&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;A&quot;</span><span class="p">},</span><span class="w"> </span><span class="nx">GoTo</span><span class="p">:</span><span class="w"> </span><span class="nx">nodeWorker</span><span class="p">},</span>
</span><span id="__span-64-24"><a id="__codelineno-64-24" name="__codelineno-64-24"></a><span class="w">        </span><span class="p">{</span><span class="nx">Update</span><span class="p">:</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="s">&quot;param&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;B&quot;</span><span class="p">},</span><span class="w"> </span><span class="nx">GoTo</span><span class="p">:</span><span class="w"> </span><span class="nx">nodeWorker</span><span class="p">},</span>
</span><span id="__span-64-25"><a id="__codelineno-64-25" name="__codelineno-64-25"></a><span class="w">        </span><span class="p">{</span><span class="nx">Update</span><span class="p">:</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="s">&quot;param&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;C&quot;</span><span class="p">},</span><span class="w"> </span><span class="nx">GoTo</span><span class="p">:</span><span class="w"> </span><span class="nx">nodeWorker</span><span class="p">},</span>
</span><span id="__span-64-26"><a id="__codelineno-64-26" name="__codelineno-64-26"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-64-27"><a id="__codelineno-64-27" name="__codelineno-64-27"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">cmds</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-64-28"><a id="__codelineno-64-28" name="__codelineno-64-28"></a><span class="p">})</span>
</span></code></pre></div></td></tr></table></div>
<p>When using command‑based routing, you don't need static edges to <code>GoTo</code> targets; just ensure the target nodes exist and call <code>SetFinishPoint</code> where appropriate.</p>
<h2 id="architecture">Architecture</h2>
<h3 id="overall-architecture">Overall Architecture</h3>
<p>GraphAgent's architecture manages complexity via clear layering. Each layer has a well‑defined responsibility and communicates through standard interfaces.</p>
<pre class="mermaid"><code>flowchart TB
    subgraph "Runner Layer"
        R[Runner]:::runnerClass
        S[Session Service]:::sessionClass
    end

    subgraph "GraphAgent"
        GA[GraphAgent Wrapper]:::agentClass
        CB[Callbacks]:::callbackClass
    end

    subgraph "Graph Engine"
        SG[StateGraph Builder]:::builderClass
        G[Graph]:::graphClass
        E[Executor]:::executorClass
    end

    subgraph "Execution Components"
        P[Planning]:::phaseClass
        EX[Execution]:::phaseClass
        U[Update]:::phaseClass
    end

    subgraph "Storage"
        CP[Checkpoint]:::storageClass
        ST[State Store]:::storageClass
    end

    R --&gt; GA
    GA --&gt; G
    G --&gt; E
    E --&gt; P
    E --&gt; EX
    E --&gt; U
    E --&gt; CP

    classDef runnerClass fill:#e8f5e9,stroke:#43a047,stroke-width:2px
    classDef sessionClass fill:#f3e5f5,stroke:#8e24aa,stroke-width:2px
    classDef agentClass fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    classDef callbackClass fill:#fce4ec,stroke:#c2185b,stroke-width:2px
    classDef builderClass fill:#fff8e1,stroke:#f57c00,stroke-width:2px
    classDef graphClass fill:#f1f8e9,stroke:#689f38,stroke-width:2px
    classDef executorClass fill:#e0f2f1,stroke:#00796b,stroke-width:2px
    classDef phaseClass fill:#ede7f6,stroke:#512da8,stroke-width:2px
    classDef storageClass fill:#efebe9,stroke:#5d4037,stroke-width:2px</code></pre>
<h3 id="core-modules">Core Modules</h3>
<p>Overview of core components:</p>
<p><code>graph/state_graph.go</code> — StateGraph builder<br />
Provides a fluent, declarative Go API to build graphs via method chaining (AddNode → AddEdge → Compile) covering nodes, edges, and conditional routing.</p>
<p><code>graph/graph.go</code> — Compiled runtime<br />
Implements channel‑based, event‑triggered execution. Node results merge into State; channels are used to drive routing and carry sentinel values (not business data).</p>
<p><code>graph/executor.go</code> — BSP executor<br />
Heart of the system, inspired by Google's Pregel. Implements BSP (Bulk Synchronous Parallel) supersteps: Planning → Execution → Update.</p>
<p><code>graph/checkpoint/*</code> — Checkpoints and recovery<br />
Optional checkpoint persistence (e.g., sqlite). Atomically saves state and pending writes; supports lineage/checkpoint‑based recovery.</p>
<p><code>agent/graphagent/graph_agent.go</code> — Bridge between Graph and Agent<br />
Adapts a compiled Graph into a generic Agent, reusing sessions, callbacks, and streaming.</p>
<h3 id="execution-model">Execution Model</h3>
<p>GraphAgent adapts Pregel's BSP (Bulk Synchronous Parallel) to a single‑process runtime and adds checkpoints, HITL interrupts/resumes, and time travel:</p>
<pre class="mermaid"><code>sequenceDiagram
    autonumber
    participant R as Runner
    participant GA as GraphAgent
    participant EX as Executor
    participant CK as Checkpoint Saver
    participant DB as Storage
    participant H as Human

    R-&gt;&gt;GA: Run(invocation)
    GA-&gt;&gt;EX: Execute(graph, state, options)
    GA--&gt;&gt;R: Stream node/tool/model events

    loop Each superstep (BSP)
        EX-&gt;&gt;EX: Planning — compute frontier
        par Parallel node execution
            EX-&gt;&gt;EX: Run node i (shallow state copy)
            EX--&gt;&gt;GA: node-start event (author=nodeID)
        and
            EX-&gt;&gt;EX: Run node j (shallow state copy)
            EX--&gt;&gt;GA: node-start event
        end

        alt Node triggers Interrupt(key,prompt)
            EX-&gt;&gt;CK: Save checkpoint(state,frontier,
            EX-&gt;&gt;CK: pending_writes,versions_seen,reason=interrupt)
            CK-&gt;&gt;DB: atomic commit
            EX--&gt;&gt;GA: interrupt event(checkpoint_id,prompt)
            GA--&gt;&gt;R: propagate + pause
            R-&gt;&gt;H: ask for input/approval
            H--&gt;&gt;R: provide decision/value
            R-&gt;&gt;GA: Run(resume) runtime_state{
            R-&gt;&gt;GA: checkpoint_id,resume_map}
            GA-&gt;&gt;EX: ResumeFromCheckpoint(checkpoint_id,resume_map)
            EX-&gt;&gt;CK: Load checkpoint
            CK-&gt;&gt;EX: state/frontier/pending_writes/versions_seen
            EX-&gt;&gt;EX: rebuild frontier and apply resume values
        else Normal
            EX--&gt;&gt;GA: node-complete events (incl. tool/model)
            EX-&gt;&gt;EX: Update — merge via reducers
            EX-&gt;&gt;CK: Save checkpoint(state,frontier,
            EX-&gt;&gt;CK: pending_writes,versions_seen)
            CK-&gt;&gt;DB: atomic commit
        end
    end

    Note over EX,CK: versions_seen prevents re-execution
    Note over EX,CK: pending_writes rebuilds channels
    Note over EX,CK: parent_id forms lineage for time travel

    opt Time travel (rewind/branch)
        R-&gt;&gt;GA: Run(runtime_state{checkpoint_id})
        GA-&gt;&gt;EX: ResumeFromCheckpoint(checkpoint_id)
        EX-&gt;&gt;CK: Load checkpoint + lineage
        CK-&gt;&gt;EX: Restore state; may create new lineage_id
    end

    EX--&gt;&gt;GA: done event (last_response)
    GA--&gt;&gt;R: final output</code></pre>
<pre class="mermaid"><code>flowchart TB
    %% Execution panorama (compact wiring)
    subgraph Client
        R[Runner]:::runner --&gt; GA[GraphAgent]:::agent
    end

    subgraph Engine[Graph Engine]
        GA --&gt; EX[Executor]:::executor
        subgraph BSP["BSP Superstep"]
            P[Planning]:::phase --&gt; X[Execution]:::phase --&gt; U[Update]:::phase
        end
    end

    N[Nodes: LLM / Tools / Function / Agent]:::process
    CK[(Checkpoint)]:::storage
    H[Human]:::human

    EX --&gt; BSP
    EX --&gt; N
    EX -.-&gt; CK
    GA &lt;--&gt; H
    GA --&gt; R

    classDef runner fill:#e8f5e9,stroke:#43a047,stroke-width:2px
    classDef agent fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    classDef executor fill:#e0f2f1,stroke:#00796b,stroke-width:2px
    classDef phase fill:#ede7f6,stroke:#512da8,stroke-width:2px
    classDef process fill:#f3e5f5,stroke:#9c27b0,stroke-width:2px
    classDef storage fill:#efebe9,stroke:#6d4c41,stroke-width:2px
    classDef human fill:#e8f5e9,stroke:#43a047,stroke-width:2px</code></pre>
<p>Key points:</p>
<ol>
<li>Planning: determine runnable nodes from the channel frontier.</li>
<li>Execution: each node gets a shallow state copy (maps.Copy) and runs in parallel.</li>
<li>Update: reducers merge updates safely for concurrency.</li>
</ol>
<p>This design enables per‑step observability and safe interruption/recovery.</p>
<h4 id="runtime-isolation-and-event-snapshots">Runtime Isolation and Event Snapshots</h4>
<ul>
<li>The Executor is reusable and concurrency‑safe. Per‑run state lives in <code>ExecutionContext</code> (channel versions, pending writes, last checkpoint, etc.).</li>
<li>Each event's <code>StateDelta</code> is a deep‑copy snapshot containing only serializable and allowed keys; internal keys (execution context, callbacks, etc.) are filtered out for external telemetry and persistence.</li>
</ul>
<h3 id="executor-configuration">Executor Configuration</h3>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-65-1">1</a></span>
<span class="normal"><a href="#__codelineno-65-2">2</a></span>
<span class="normal"><a href="#__codelineno-65-3">3</a></span>
<span class="normal"><a href="#__codelineno-65-4">4</a></span>
<span class="normal"><a href="#__codelineno-65-5">5</a></span>
<span class="normal"><a href="#__codelineno-65-6">6</a></span>
<span class="normal"><a href="#__codelineno-65-7">7</a></span>
<span class="normal"><a href="#__codelineno-65-8">8</a></span>
<span class="normal"><a href="#__codelineno-65-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-65-1"><a id="__codelineno-65-1" name="__codelineno-65-1"></a><span class="nx">exec</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewExecutor</span><span class="p">(</span><span class="nx">g</span><span class="p">,</span>
</span><span id="__span-65-2"><a id="__codelineno-65-2" name="__codelineno-65-2"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithChannelBufferSize</span><span class="p">(</span><span class="mi">1024</span><span class="p">),</span><span class="w">              </span><span class="c1">// event channel buffer</span>
</span><span id="__span-65-3"><a id="__codelineno-65-3" name="__codelineno-65-3"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithMaxSteps</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span><span class="w">                          </span><span class="c1">// max steps</span>
</span><span id="__span-65-4"><a id="__codelineno-65-4" name="__codelineno-65-4"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithMaxConcurrency</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w">                     </span><span class="c1">// task concurrency</span>
</span><span id="__span-65-5"><a id="__codelineno-65-5" name="__codelineno-65-5"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithStepTimeout</span><span class="p">(</span><span class="mi">5</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span><span class="p">),</span><span class="w">            </span><span class="c1">// step timeout</span>
</span><span id="__span-65-6"><a id="__codelineno-65-6" name="__codelineno-65-6"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithNodeTimeout</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span><span class="p">),</span><span class="w">            </span><span class="c1">// node timeout</span>
</span><span id="__span-65-7"><a id="__codelineno-65-7" name="__codelineno-65-7"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithCheckpointSaver</span><span class="p">(</span><span class="nx">saver</span><span class="p">),</span><span class="w">                </span><span class="c1">// enable checkpoints (sqlite/inmemory)</span>
</span><span id="__span-65-8"><a id="__codelineno-65-8" name="__codelineno-65-8"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithCheckpointSaveTimeout</span><span class="p">(</span><span class="mi">30</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">),</span><span class="w"> </span><span class="c1">// checkpoint save timeout</span>
</span><span id="__span-65-9"><a id="__codelineno-65-9" name="__codelineno-65-9"></a><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="defaults-and-notes">Defaults and Notes</h3>
<ul>
<li>
<p>Defaults (Executor)</p>
<ul>
<li><code>ChannelBufferSize = 256</code>, <code>MaxSteps = 100</code>, <code>MaxConcurrency = GOMAXPROCS(0)</code>, <code>CheckpointSaveTimeout = 10s</code></li>
<li>Per‑step/node timeouts are available via <code>WithExecutorOptions</code> when creating <code>GraphAgent</code> (see "Executor Advanced Configuration" section above), or directly on <code>Executor</code> via <code>WithStepTimeout</code> / <code>WithNodeTimeout</code></li>
</ul>
</li>
</ul>
<ul>
<li>Sessions<ul>
<li>Prefer Redis session backend in production; set TTLs and cleanup</li>
</ul>
</li>
<li>Runner seeds multi‑turn <code>graph.StateKeyMessages</code> from session events automatically</li>
</ul>
<ul>
<li>
<p>Checkpoints</p>
<ul>
<li>Use stable <code>namespace</code> names (e.g., <code>svc:prod:flowX</code>); audit and clean up by lineage via <code>CheckpointManager</code></li>
</ul>
</li>
</ul>
<ul>
<li>
<p>Events/backpressure</p>
<ul>
<li>Tune <code>WithChannelBufferSize</code>; cap task parallelism via <code>WithMaxConcurrency</code></li>
<li>Filter events by <code>author</code>/<code>object</code> to reduce noise</li>
</ul>
</li>
</ul>
<ul>
<li>
<p>Naming and keys</p>
<ul>
<li>Use constants for node IDs, route labels, and state keys; define reducers for non‑trivial merges</li>
</ul>
</li>
</ul>
<ul>
<li>Governance</li>
<li>Insert HITL on critical paths; prefer storing sensitive details under <code>graph.StateKeyMetadata</code> rather than <code>graph.StateKeyMessages</code></li>
</ul>
<h2 id="integrating-with-multiagent-systems">Integrating with Multi‑Agent Systems</h2>
<p>GraphAgent is designed to be part of the tRPC‑Agent‑Go multi‑agent ecosystem, not an island. It implements the standard Agent interface and collaborates with other agent types.</p>
<h3 id="graphagent-as-an-agent">GraphAgent as an Agent</h3>
<p>GraphAgent implements the standard Agent interface:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-66-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-66-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-66-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-66-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-66-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-66-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-66-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-66-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-66-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-66-10">10</a></span>
<span class="normal"><a href="#__codelineno-66-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-66-1"><a id="__codelineno-66-1" name="__codelineno-66-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-66-2"><a id="__codelineno-66-2" name="__codelineno-66-2"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/agent&quot;</span>
</span><span id="__span-66-3"><a id="__codelineno-66-3" name="__codelineno-66-3"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/agent/chainagent&quot;</span>
</span><span id="__span-66-4"><a id="__codelineno-66-4" name="__codelineno-66-4"></a><span class="p">)</span>
</span><span id="__span-66-5"><a id="__codelineno-66-5" name="__codelineno-66-5"></a>
</span><span id="__span-66-6"><a id="__codelineno-66-6" name="__codelineno-66-6"></a><span class="c1">// Use directly inside ChainAgent, ParallelAgent, CycleAgent</span>
</span><span id="__span-66-7"><a id="__codelineno-66-7" name="__codelineno-66-7"></a><span class="nx">chain</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">chainagent</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;chain&quot;</span><span class="p">,</span>
</span><span id="__span-66-8"><a id="__codelineno-66-8" name="__codelineno-66-8"></a><span class="w">    </span><span class="nx">chainagent</span><span class="p">.</span><span class="nx">WithSubAgents</span><span class="p">([]</span><span class="nx">agent</span><span class="p">.</span><span class="nx">Agent</span><span class="p">{</span>
</span><span id="__span-66-9"><a id="__codelineno-66-9" name="__codelineno-66-9"></a><span class="w">        </span><span class="nx">graphAgent1</span><span class="p">,</span><span class="w">  </span><span class="c1">// structured flow #1</span>
</span><span id="__span-66-10"><a id="__codelineno-66-10" name="__codelineno-66-10"></a><span class="w">        </span><span class="nx">graphAgent2</span><span class="p">,</span><span class="w">  </span><span class="c1">// structured flow #2</span>
</span><span id="__span-66-11"><a id="__codelineno-66-11" name="__codelineno-66-11"></a><span class="w">    </span><span class="p">}))</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="advanced-orchestration">Advanced Orchestration</h3>
<p>End‑to‑end business flow: entry normalization → smart routing → multiple pods (Email, Weather, Research) → parallel fan‑out/aggregation → final composition and publish.</p>
<pre class="mermaid"><code>flowchart LR
    %% Layout
    subgraph UE["User &amp; Entry"]
        U((User)):::human --&gt; IN["entry&lt;br/&gt;normalize"]:::process
    end

    subgraph FAB["Graph Orchestration"]
        Rtr["where_to_go&lt;br/&gt;router"]:::router
        Compose["compose&lt;br/&gt;LLM"]:::llm
    end

    IN --&gt; Rtr

    %% Email Agent (expanded)
    subgraph EC["Email Agent"]
        direction LR
        CE["classifier&lt;br/&gt;LLM"]:::llm --&gt; WE["writer&lt;br/&gt;LLM"]:::llm
    end

    %% Weather Agent (expanded)
    subgraph WA["Weather Agent"]
        direction LR
        LE["locate&lt;br/&gt;LLM"]:::llm --&gt; WT["weather tool"]:::tool
    end

    %% Routing from router to pods
    Rtr -- email --&gt; CE
    Rtr -- weather --&gt; LE
    Rtr -- other --&gt; REPLY["reply&lt;br/&gt;LLM"]:::llm

    %% Fanout Pipeline (fanout → workers → aggregate)
    subgraph FP["Fanout Pipeline"]
        direction LR
        Fan["plan_fanout"]:::process --&gt; W1["worker A"]:::process
        Fan --&gt; W2["worker B"]:::process
        Fan --&gt; W3["worker C"]:::process
        W1 --&gt; Agg["aggregate"]:::process
        W2 --&gt; Agg
        W3 --&gt; Agg
    end
    Rtr -- research --&gt; Fan

    %% Human-in-the-loop (optional)
    Compose -. review .- HG["human&lt;br/&gt;review"]:::human

    %% Compose final (minimal wiring)
    Agg --&gt; Compose
    WE --&gt; Compose
    WT --&gt; Compose
    REPLY --&gt; Compose
    Compose --&gt; END([END]):::terminal

    %% Styles
    classDef router fill:#fff7e0,stroke:#f5a623,stroke-width:2px
    classDef llm fill:#e3f2fd,stroke:#1e88e5,stroke-width:2px
    classDef tool fill:#fff3e0,stroke:#fb8c00,stroke-width:2px
    classDef process fill:#f3e5f5,stroke:#8e24aa,stroke-width:2px
    classDef human fill:#e8f5e9,stroke:#43a047,stroke-width:2px
    classDef terminal fill:#ffebee,stroke:#e53935,stroke-width:2px</code></pre>
<p>Highlights:</p>
<ul>
<li><code>where_to_go</code> can be LLM‑decided or function‑driven (conditional edges).</li>
<li>Fanout Pipeline uses Command GoTo at runtime, then aggregates.</li>
<li>Optional human review follows aggregation to gate critical output.</li>
<li>Single checkpoint display at Compose balances clarity and recoverability.</li>
</ul>
<h3 id="embedding-agents-in-a-graph">Embedding Agents in a Graph</h3>
<p>Inside a graph, you can call existing sub‑agents as nodes. The example below shows how to create sub‑agents, declare the corresponding nodes, and inject them when constructing the GraphAgent.</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-67-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-67-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-67-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-67-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-67-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-67-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-67-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-67-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-67-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-67-10">10</a></span>
<span class="normal"><a href="#__codelineno-67-11">11</a></span>
<span class="normal"><a href="#__codelineno-67-12">12</a></span>
<span class="normal"><a href="#__codelineno-67-13">13</a></span>
<span class="normal"><a href="#__codelineno-67-14">14</a></span>
<span class="normal"><a href="#__codelineno-67-15">15</a></span>
<span class="normal"><a href="#__codelineno-67-16">16</a></span>
<span class="normal"><a href="#__codelineno-67-17">17</a></span>
<span class="normal"><a href="#__codelineno-67-18">18</a></span>
<span class="normal"><a href="#__codelineno-67-19">19</a></span>
<span class="normal"><a href="#__codelineno-67-20">20</a></span>
<span class="normal"><a href="#__codelineno-67-21">21</a></span>
<span class="normal"><a href="#__codelineno-67-22">22</a></span>
<span class="normal"><a href="#__codelineno-67-23">23</a></span>
<span class="normal"><a href="#__codelineno-67-24">24</a></span>
<span class="normal"><a href="#__codelineno-67-25">25</a></span>
<span class="normal"><a href="#__codelineno-67-26">26</a></span>
<span class="normal"><a href="#__codelineno-67-27">27</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-67-1"><a id="__codelineno-67-1" name="__codelineno-67-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-67-2"><a id="__codelineno-67-2" name="__codelineno-67-2"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/agent&quot;</span>
</span><span id="__span-67-3"><a id="__codelineno-67-3" name="__codelineno-67-3"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/agent/graphagent&quot;</span>
</span><span id="__span-67-4"><a id="__codelineno-67-4" name="__codelineno-67-4"></a><span class="p">)</span>
</span><span id="__span-67-5"><a id="__codelineno-67-5" name="__codelineno-67-5"></a>
</span><span id="__span-67-6"><a id="__codelineno-67-6" name="__codelineno-67-6"></a><span class="c1">// Create sub‑agents</span>
</span><span id="__span-67-7"><a id="__codelineno-67-7" name="__codelineno-67-7"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-67-8"><a id="__codelineno-67-8" name="__codelineno-67-8"></a><span class="w">    </span><span class="nx">SubAgentAnalyzer</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;analyzer&quot;</span>
</span><span id="__span-67-9"><a id="__codelineno-67-9" name="__codelineno-67-9"></a><span class="w">    </span><span class="nx">SubAgentReviewer</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;reviewer&quot;</span>
</span><span id="__span-67-10"><a id="__codelineno-67-10" name="__codelineno-67-10"></a><span class="p">)</span>
</span><span id="__span-67-11"><a id="__codelineno-67-11" name="__codelineno-67-11"></a><span class="nx">analyzer</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">createAnalyzer</span><span class="p">()</span><span class="w">  </span><span class="c1">// name must be &quot;analyzer&quot;</span>
</span><span id="__span-67-12"><a id="__codelineno-67-12" name="__codelineno-67-12"></a><span class="nx">reviewer</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">createReviewer</span><span class="p">()</span><span class="w">  </span><span class="c1">// name must be &quot;reviewer&quot;</span>
</span><span id="__span-67-13"><a id="__codelineno-67-13" name="__codelineno-67-13"></a>
</span><span id="__span-67-14"><a id="__codelineno-67-14" name="__codelineno-67-14"></a><span class="c1">// Declare agent nodes in the graph</span>
</span><span id="__span-67-15"><a id="__codelineno-67-15" name="__codelineno-67-15"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddAgentNode</span><span class="p">(</span><span class="nx">SubAgentAnalyzer</span><span class="p">)</span>
</span><span id="__span-67-16"><a id="__codelineno-67-16" name="__codelineno-67-16"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddAgentNode</span><span class="p">(</span><span class="nx">SubAgentReviewer</span><span class="p">)</span>
</span><span id="__span-67-17"><a id="__codelineno-67-17" name="__codelineno-67-17"></a>
</span><span id="__span-67-18"><a id="__codelineno-67-18" name="__codelineno-67-18"></a><span class="c1">// Inject sub‑agents when creating the GraphAgent</span>
</span><span id="__span-67-19"><a id="__codelineno-67-19" name="__codelineno-67-19"></a><span class="nx">graphAgent</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;workflow&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">g</span><span class="p">,</span>
</span><span id="__span-67-20"><a id="__codelineno-67-20" name="__codelineno-67-20"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithSubAgents</span><span class="p">([]</span><span class="nx">agent</span><span class="p">.</span><span class="nx">Agent</span><span class="p">{</span>
</span><span id="__span-67-21"><a id="__codelineno-67-21" name="__codelineno-67-21"></a><span class="w">        </span><span class="nx">analyzer</span><span class="p">,</span>
</span><span id="__span-67-22"><a id="__codelineno-67-22" name="__codelineno-67-22"></a><span class="w">        </span><span class="nx">reviewer</span><span class="p">,</span>
</span><span id="__span-67-23"><a id="__codelineno-67-23" name="__codelineno-67-23"></a><span class="w">    </span><span class="p">}))</span>
</span><span id="__span-67-24"><a id="__codelineno-67-24" name="__codelineno-67-24"></a>
</span><span id="__span-67-25"><a id="__codelineno-67-25" name="__codelineno-67-25"></a><span class="c1">// I/O: sub‑agents receive graph.StateKeyUserInput as the message AND the full</span>
</span><span id="__span-67-26"><a id="__codelineno-67-26" name="__codelineno-67-26"></a><span class="c1">// graph state via inv.RunOptions.RuntimeState; on finish they update</span>
</span><span id="__span-67-27"><a id="__codelineno-67-27" name="__codelineno-67-27"></a><span class="c1">// graph.StateKeyLastResponse and graph.StateKeyNodeResponses[nodeID]</span>
</span></code></pre></div></td></tr></table></div>
<h4 id="passing-only-results-map-last_response-to-downstream-user_input">Passing only results: map last_response to downstream user_input</h4>
<blockquote>
<p>Scenario: A → B → C as black boxes. Downstream should only consume upstream's result text as this turn's input, without pulling full session history.</p>
</blockquote>
<ul>
<li>Approach 1 (dependency‑free, universally available): add a pre‑node callback to the target Agent node that assigns parent <code>last_response</code> to <code>user_input</code>. Optionally isolate messages.</li>
</ul>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-68-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-68-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-68-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-68-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-68-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-68-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-68-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-68-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-68-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-68-10">10</a></span>
<span class="normal"><a href="#__codelineno-68-11">11</a></span>
<span class="normal"><a href="#__codelineno-68-12">12</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-68-1"><a id="__codelineno-68-1" name="__codelineno-68-1"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddAgentNode</span><span class="p">(</span><span class="s">&quot;orchestrator&quot;</span><span class="p">,</span>
</span><span id="__span-68-2"><a id="__codelineno-68-2" name="__codelineno-68-2"></a><span class="w">    </span><span class="c1">// Map upstream last_response → this turn&#39;s user_input</span>
</span><span id="__span-68-3"><a id="__codelineno-68-3" name="__codelineno-68-3"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithPreNodeCallback</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">cb</span><span class="w"> </span><span class="o">*</span><span class="nx">graph</span><span class="p">.</span><span class="nx">NodeCallbackContext</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-68-4"><a id="__codelineno-68-4" name="__codelineno-68-4"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">v</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">s</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyLastResponse</span><span class="p">].(</span><span class="kt">string</span><span class="p">);</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">v</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-68-5"><a id="__codelineno-68-5" name="__codelineno-68-5"></a><span class="w">            </span><span class="nx">s</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyUserInput</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">v</span>
</span><span id="__span-68-6"><a id="__codelineno-68-6" name="__codelineno-68-6"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-68-7"><a id="__codelineno-68-7" name="__codelineno-68-7"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-68-8"><a id="__codelineno-68-8" name="__codelineno-68-8"></a><span class="w">    </span><span class="p">}),</span>
</span><span id="__span-68-9"><a id="__codelineno-68-9" name="__codelineno-68-9"></a><span class="w">    </span><span class="c1">// Optional: isolate child sub‑agent from session contents.</span>
</span><span id="__span-68-10"><a id="__codelineno-68-10" name="__codelineno-68-10"></a><span class="w">    </span><span class="c1">// Use only when the sub‑agent is single‑turn (no multi‑turn tool calls).</span>
</span><span id="__span-68-11"><a id="__codelineno-68-11" name="__codelineno-68-11"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithSubgraphIsolatedMessages</span><span class="p">(</span><span class="kc">true</span><span class="p">),</span>
</span><span id="__span-68-12"><a id="__codelineno-68-12" name="__codelineno-68-12"></a><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<ul>
<li>Approach 2 (enhanced option, more concise):</li>
</ul>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-69-1">1</a></span>
<span class="normal"><a href="#__codelineno-69-2">2</a></span>
<span class="normal"><a href="#__codelineno-69-3">3</a></span>
<span class="normal"><a href="#__codelineno-69-4">4</a></span>
<span class="normal"><a href="#__codelineno-69-5">5</a></span>
<span class="normal"><a href="#__codelineno-69-6">6</a></span>
<span class="normal"><a href="#__codelineno-69-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-69-1"><a id="__codelineno-69-1" name="__codelineno-69-1"></a><span class="c1">// Declarative option that automatically maps last_response → user_input</span>
</span><span id="__span-69-2"><a id="__codelineno-69-2" name="__codelineno-69-2"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddAgentNode</span><span class="p">(</span><span class="s">&quot;orchestrator&quot;</span><span class="p">,</span>
</span><span id="__span-69-3"><a id="__codelineno-69-3" name="__codelineno-69-3"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithSubgraphInputFromLastResponse</span><span class="p">(),</span>
</span><span id="__span-69-4"><a id="__codelineno-69-4" name="__codelineno-69-4"></a><span class="w">    </span><span class="c1">// Optional: isolate for true &quot;pass only results&quot;.</span>
</span><span id="__span-69-5"><a id="__codelineno-69-5" name="__codelineno-69-5"></a><span class="w">    </span><span class="c1">// Use only when the sub‑agent is single‑turn (no multi‑turn tool calls).</span>
</span><span id="__span-69-6"><a id="__codelineno-69-6" name="__codelineno-69-6"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithSubgraphIsolatedMessages</span><span class="p">(</span><span class="kc">true</span><span class="p">),</span>
</span><span id="__span-69-7"><a id="__codelineno-69-7" name="__codelineno-69-7"></a><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>Notes: Both approaches ensure B only sees A's result, and C only sees B's. The option is more concise when available; the callback is zero‑dependency and works everywhere.</p>
<h3 id="hybrid-pattern-example">Hybrid Pattern Example</h3>
<p>Embed dynamic decision‑making within a structured flow:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-70-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-70-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-70-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-70-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-70-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-70-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-70-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-70-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-70-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-70-10">10</a></span>
<span class="normal"><a href="#__codelineno-70-11">11</a></span>
<span class="normal"><a href="#__codelineno-70-12">12</a></span>
<span class="normal"><a href="#__codelineno-70-13">13</a></span>
<span class="normal"><a href="#__codelineno-70-14">14</a></span>
<span class="normal"><a href="#__codelineno-70-15">15</a></span>
<span class="normal"><a href="#__codelineno-70-16">16</a></span>
<span class="normal"><a href="#__codelineno-70-17">17</a></span>
<span class="normal"><a href="#__codelineno-70-18">18</a></span>
<span class="normal"><a href="#__codelineno-70-19">19</a></span>
<span class="normal"><a href="#__codelineno-70-20">20</a></span>
<span class="normal"><a href="#__codelineno-70-21">21</a></span>
<span class="normal"><a href="#__codelineno-70-22">22</a></span>
<span class="normal"><a href="#__codelineno-70-23">23</a></span>
<span class="normal"><a href="#__codelineno-70-24">24</a></span>
<span class="normal"><a href="#__codelineno-70-25">25</a></span>
<span class="normal"><a href="#__codelineno-70-26">26</a></span>
<span class="normal"><a href="#__codelineno-70-27">27</a></span>
<span class="normal"><a href="#__codelineno-70-28">28</a></span>
<span class="normal"><a href="#__codelineno-70-29">29</a></span>
<span class="normal"><a href="#__codelineno-70-30">30</a></span>
<span class="normal"><a href="#__codelineno-70-31">31</a></span>
<span class="normal"><a href="#__codelineno-70-32">32</a></span>
<span class="normal"><a href="#__codelineno-70-33">33</a></span>
<span class="normal"><a href="#__codelineno-70-34">34</a></span>
<span class="normal"><a href="#__codelineno-70-35">35</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-70-1"><a id="__codelineno-70-1" name="__codelineno-70-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-70-2"><a id="__codelineno-70-2" name="__codelineno-70-2"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/agent&quot;</span>
</span><span id="__span-70-3"><a id="__codelineno-70-3" name="__codelineno-70-3"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/agent/chainagent&quot;</span>
</span><span id="__span-70-4"><a id="__codelineno-70-4" name="__codelineno-70-4"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/agent/graphagent&quot;</span>
</span><span id="__span-70-5"><a id="__codelineno-70-5" name="__codelineno-70-5"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-70-6"><a id="__codelineno-70-6" name="__codelineno-70-6"></a><span class="p">)</span>
</span><span id="__span-70-7"><a id="__codelineno-70-7" name="__codelineno-70-7"></a>
</span><span id="__span-70-8"><a id="__codelineno-70-8" name="__codelineno-70-8"></a><span class="nx">sg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateGraph</span><span class="p">(</span><span class="nx">schema</span><span class="p">)</span>
</span><span id="__span-70-9"><a id="__codelineno-70-9" name="__codelineno-70-9"></a>
</span><span id="__span-70-10"><a id="__codelineno-70-10" name="__codelineno-70-10"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-70-11"><a id="__codelineno-70-11" name="__codelineno-70-11"></a><span class="w">    </span><span class="nx">nodePrepare</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;prepare&quot;</span>
</span><span id="__span-70-12"><a id="__codelineno-70-12" name="__codelineno-70-12"></a><span class="w">    </span><span class="nx">nodeAnalyzer</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;analyzer&quot;</span>
</span><span id="__span-70-13"><a id="__codelineno-70-13" name="__codelineno-70-13"></a><span class="w">    </span><span class="nx">nodeFinalize</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;finalize&quot;</span>
</span><span id="__span-70-14"><a id="__codelineno-70-14" name="__codelineno-70-14"></a><span class="p">)</span>
</span><span id="__span-70-15"><a id="__codelineno-70-15" name="__codelineno-70-15"></a>
</span><span id="__span-70-16"><a id="__codelineno-70-16" name="__codelineno-70-16"></a><span class="c1">// Structured data preparation</span>
</span><span id="__span-70-17"><a id="__codelineno-70-17" name="__codelineno-70-17"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="nx">nodePrepare</span><span class="p">,</span><span class="w"> </span><span class="nx">prepareData</span><span class="p">)</span>
</span><span id="__span-70-18"><a id="__codelineno-70-18" name="__codelineno-70-18"></a>
</span><span id="__span-70-19"><a id="__codelineno-70-19" name="__codelineno-70-19"></a><span class="c1">// Dynamic decision point — use a ChainAgent</span>
</span><span id="__span-70-20"><a id="__codelineno-70-20" name="__codelineno-70-20"></a><span class="nx">dynamicAgent</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">chainagent</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="nx">nodeAnalyzer</span><span class="p">,</span>
</span><span id="__span-70-21"><a id="__codelineno-70-21" name="__codelineno-70-21"></a><span class="w">    </span><span class="nx">chainagent</span><span class="p">.</span><span class="nx">WithSubAgents</span><span class="p">([]</span><span class="nx">agent</span><span class="p">.</span><span class="nx">Agent</span><span class="p">{</span><span class="o">...</span><span class="p">}))</span>
</span><span id="__span-70-22"><a id="__codelineno-70-22" name="__codelineno-70-22"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddAgentNode</span><span class="p">(</span><span class="nx">nodeAnalyzer</span><span class="p">)</span>
</span><span id="__span-70-23"><a id="__codelineno-70-23" name="__codelineno-70-23"></a>
</span><span id="__span-70-24"><a id="__codelineno-70-24" name="__codelineno-70-24"></a><span class="c1">// Continue the structured flow</span>
</span><span id="__span-70-25"><a id="__codelineno-70-25" name="__codelineno-70-25"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="nx">nodeFinalize</span><span class="p">,</span><span class="w"> </span><span class="nx">finalizeResults</span><span class="p">)</span>
</span><span id="__span-70-26"><a id="__codelineno-70-26" name="__codelineno-70-26"></a>
</span><span id="__span-70-27"><a id="__codelineno-70-27" name="__codelineno-70-27"></a><span class="c1">// Wire the flow</span>
</span><span id="__span-70-28"><a id="__codelineno-70-28" name="__codelineno-70-28"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">SetEntryPoint</span><span class="p">(</span><span class="nx">nodePrepare</span><span class="p">)</span>
</span><span id="__span-70-29"><a id="__codelineno-70-29" name="__codelineno-70-29"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddEdge</span><span class="p">(</span><span class="nx">nodePrepare</span><span class="p">,</span><span class="w"> </span><span class="nx">nodeAnalyzer</span><span class="p">)</span><span class="w">   </span><span class="c1">// hand over to dynamic agent</span>
</span><span id="__span-70-30"><a id="__codelineno-70-30" name="__codelineno-70-30"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddEdge</span><span class="p">(</span><span class="nx">nodeAnalyzer</span><span class="p">,</span><span class="w"> </span><span class="nx">nodeFinalize</span><span class="p">)</span><span class="w">  </span><span class="c1">// return to structured flow</span>
</span><span id="__span-70-31"><a id="__codelineno-70-31" name="__codelineno-70-31"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">SetFinishPoint</span><span class="p">(</span><span class="nx">nodeFinalize</span><span class="p">)</span>
</span><span id="__span-70-32"><a id="__codelineno-70-32" name="__codelineno-70-32"></a>
</span><span id="__span-70-33"><a id="__codelineno-70-33" name="__codelineno-70-33"></a><span class="c1">// Inject on creation</span>
</span><span id="__span-70-34"><a id="__codelineno-70-34" name="__codelineno-70-34"></a><span class="nx">graphAgent</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;hybrid&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">g</span><span class="p">,</span>
</span><span id="__span-70-35"><a id="__codelineno-70-35" name="__codelineno-70-35"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithSubAgents</span><span class="p">([]</span><span class="nx">agent</span><span class="p">.</span><span class="nx">Agent</span><span class="p">{</span><span class="nx">dynamicAgent</span><span class="p">}))</span>
</span></code></pre></div></td></tr></table></div>
<h2 id="core-mechanics-in-depth">Core Mechanics in Depth</h2>
<h3 id="state-management-schema-reducer">State Management: Schema + Reducer</h3>
<p>State is a central challenge in graph workflows. We designed a Schema + Reducer mechanism that provides type safety and supports high‑concurrency atomic updates.</p>
<pre class="mermaid"><code>flowchart LR
    subgraph "State Schema"
        MS[messages: MessageList]:::schemaClass
        UI[user_input: string]:::schemaClass
        LR[last_response: string]:::schemaClass
        NR[node_responses: Map]:::schemaClass
    end

    subgraph "Reducers"
        R1[MessageReducer + MessageOp]:::reducerClass
        R2[MergeReducer (Map)]:::reducerClass
        R3[ReplaceReducer (String)]:::reducerClass
    end

    subgraph "Node Outputs"
        N1[Node 1 Output]:::nodeOutputClass
        N2[Node 2 Output]:::nodeOutputClass
        N3[Node 3 Output]:::nodeOutputClass
    end

    N1 --&gt; R1
    N2 --&gt; R2
    N3 --&gt; R3
    R1 --&gt; MS
    R2 --&gt; NR
    R3 --&gt; LR

    classDef schemaClass fill:#e3f2fd,stroke:#1565c0,stroke-width:2px
    classDef reducerClass fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    classDef nodeOutputClass fill:#fff8e1,stroke:#f57f17,stroke-width:2px</code></pre>
<p>Graph state is a <code>map[string]any</code> with runtime validation provided by <code>StateSchema</code>. The reducer mechanism ensures safe merging and avoids conflicts under concurrent updates.</p>
<h4 id="common-state-keys">Common State Keys</h4>
<ul>
<li>User‑visible: <code>graph.StateKeyUserInput</code>, <code>graph.StateKeyOneShotMessages</code>,
  <code>graph.StateKeyOneShotMessagesByNode</code>, <code>graph.StateKeyMessages</code>,
  <code>graph.StateKeyLastResponse</code>, <code>graph.StateKeyLastToolResponse</code>,
  <code>graph.StateKeyNodeResponses</code>, <code>graph.StateKeyMetadata</code></li>
<li>Internal: <code>session</code>, <code>exec_context</code>, <code>tool_callbacks</code>, <code>model_callbacks</code>, <code>agent_callbacks</code>, <code>current_node_id</code>, <code>parent_agent</code></li>
<li>Command/Resume: <code>__command__</code>, <code>__resume_map__</code></li>
</ul>
<p>Constants live in <code>graph/state.go</code> and <code>graph/keys.go</code>. Prefer referencing constants over hard‑coding strings.</p>
<h4 id="nodelevel-callbacks-tools-generation-parameters">Node‑level Callbacks, Tools &amp; Generation Parameters</h4>
<p>Per‑node options (see <code>graph/state_graph.go</code>):</p>
<ul>
<li><code>graph.WithPreNodeCallback</code> / <code>graph.WithPostNodeCallback</code> / <code>graph.WithNodeErrorCallback</code></li>
<li>LLM nodes: <code>graph.WithGenerationConfig</code>, <code>graph.WithModelCallbacks</code></li>
<li>Tooling: <code>graph.WithToolCallbacks</code>, <code>graph.WithToolSets</code> (supply ToolSets in addition to <code>tools []tool.Tool</code>),
  <code>graph.WithRefreshToolSetsOnRun</code> (rebuild tools from ToolSets on each run for dynamic sources such as MCP)</li>
<li>Agent nodes: <code>graph.WithAgentNodeEventCallback</code></li>
</ul>
<h4 id="invocationlevel-call-options-perrun-overrides">Invocation‑level Call Options (per‑run overrides)</h4>
<p><code>graph.WithGenerationConfig(...)</code> is a <strong>compile‑time</strong> configuration: you set
it when building the graph. In real services you often want <strong>runtime</strong> control:
use the same graph, but override sampling parameters for this request.</p>
<p>Graph supports this with <strong>call options</strong>, which are attached to
<code>Invocation.RunOptions</code> and automatically propagated into nested GraphAgent
subgraphs.</p>
<p>Common use cases:</p>
<ul>
<li>One request needs higher <code>temperature</code>, another needs lower.</li>
<li>The same graph has multiple LLM nodes, and you want different parameters per
  node.</li>
<li>A parent graph calls a subgraph (Agent node), and you want overrides only
  inside that subgraph.</li>
</ul>
<p>API:</p>
<ul>
<li><code>graph.WithCallOptions(...)</code> attaches call options to this run.</li>
<li><code>graph.WithCallGenerationConfigPatch(...)</code> overrides <code>model.GenerationConfig</code>
  fields for LLM nodes in the current graph scope.</li>
<li><code>graph.DesignateNode(nodeID, ...)</code> targets a specific node in the current
  graph.<ul>
<li>For LLM nodes: affects that node's model call.</li>
<li>For Agent nodes (subgraphs): affects the child invocation, so it becomes the
  default for the nested graph.</li>
</ul>
</li>
<li><code>graph.DesignateNodeWithPath(graph.NodePath{...}, ...)</code> targets a node inside
  nested subgraphs (path segments are node IDs).</li>
</ul>
<p>Patch format:</p>
<ul>
<li>Use <code>model.GenerationConfigPatch</code> and set only the fields you want to
  override.</li>
<li>Pointer fields use <code>nil</code> for "do not override", so you typically create
  pointers using helpers like <code>model.Float64Ptr</code>, <code>model.IntPtr</code>, etc.</li>
<li><code>Stop</code>: <code>nil</code> means "do not override"; an empty slice clears stop sequences.</li>
</ul>
<p>Example:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-71-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-71-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-71-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-71-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-71-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-71-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-71-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-71-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-71-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-71-10">10</a></span>
<span class="normal"><a href="#__codelineno-71-11">11</a></span>
<span class="normal"><a href="#__codelineno-71-12">12</a></span>
<span class="normal"><a href="#__codelineno-71-13">13</a></span>
<span class="normal"><a href="#__codelineno-71-14">14</a></span>
<span class="normal"><a href="#__codelineno-71-15">15</a></span>
<span class="normal"><a href="#__codelineno-71-16">16</a></span>
<span class="normal"><a href="#__codelineno-71-17">17</a></span>
<span class="normal"><a href="#__codelineno-71-18">18</a></span>
<span class="normal"><a href="#__codelineno-71-19">19</a></span>
<span class="normal"><a href="#__codelineno-71-20">20</a></span>
<span class="normal"><a href="#__codelineno-71-21">21</a></span>
<span class="normal"><a href="#__codelineno-71-22">22</a></span>
<span class="normal"><a href="#__codelineno-71-23">23</a></span>
<span class="normal"><a href="#__codelineno-71-24">24</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-71-1"><a id="__codelineno-71-1" name="__codelineno-71-1"></a><span class="nx">runOpts</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithCallOptions</span><span class="p">(</span>
</span><span id="__span-71-2"><a id="__codelineno-71-2" name="__codelineno-71-2"></a><span class="w">    </span><span class="c1">// Global override for this run (affects all LLM nodes in this graph).</span>
</span><span id="__span-71-3"><a id="__codelineno-71-3" name="__codelineno-71-3"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithCallGenerationConfigPatch</span><span class="p">(</span><span class="nx">model</span><span class="p">.</span><span class="nx">GenerationConfigPatch</span><span class="p">{</span>
</span><span id="__span-71-4"><a id="__codelineno-71-4" name="__codelineno-71-4"></a><span class="w">        </span><span class="nx">Temperature</span><span class="p">:</span><span class="w"> </span><span class="nx">model</span><span class="p">.</span><span class="nx">Float64Ptr</span><span class="p">(</span><span class="mf">0.2</span><span class="p">),</span>
</span><span id="__span-71-5"><a id="__codelineno-71-5" name="__codelineno-71-5"></a><span class="w">    </span><span class="p">}),</span>
</span><span id="__span-71-6"><a id="__codelineno-71-6" name="__codelineno-71-6"></a>
</span><span id="__span-71-7"><a id="__codelineno-71-7" name="__codelineno-71-7"></a><span class="w">    </span><span class="c1">// Override a single LLM node in the current graph.</span>
</span><span id="__span-71-8"><a id="__codelineno-71-8" name="__codelineno-71-8"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">DesignateNode</span><span class="p">(</span><span class="s">&quot;final_answer&quot;</span><span class="p">,</span>
</span><span id="__span-71-9"><a id="__codelineno-71-9" name="__codelineno-71-9"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithCallGenerationConfigPatch</span><span class="p">(</span><span class="nx">model</span><span class="p">.</span><span class="nx">GenerationConfigPatch</span><span class="p">{</span>
</span><span id="__span-71-10"><a id="__codelineno-71-10" name="__codelineno-71-10"></a><span class="w">            </span><span class="nx">MaxTokens</span><span class="p">:</span><span class="w"> </span><span class="nx">model</span><span class="p">.</span><span class="nx">IntPtr</span><span class="p">(</span><span class="mi">256</span><span class="p">),</span>
</span><span id="__span-71-11"><a id="__codelineno-71-11" name="__codelineno-71-11"></a><span class="w">        </span><span class="p">}),</span>
</span><span id="__span-71-12"><a id="__codelineno-71-12" name="__codelineno-71-12"></a><span class="w">    </span><span class="p">),</span>
</span><span id="__span-71-13"><a id="__codelineno-71-13" name="__codelineno-71-13"></a>
</span><span id="__span-71-14"><a id="__codelineno-71-14" name="__codelineno-71-14"></a><span class="w">    </span><span class="c1">// Override a node inside a nested subgraph:</span>
</span><span id="__span-71-15"><a id="__codelineno-71-15" name="__codelineno-71-15"></a><span class="w">    </span><span class="c1">// node &quot;child_agent&quot; (Agent node) -&gt; node &quot;llm&quot; (inside the child graph).</span>
</span><span id="__span-71-16"><a id="__codelineno-71-16" name="__codelineno-71-16"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">DesignateNodeWithPath</span><span class="p">(</span>
</span><span id="__span-71-17"><a id="__codelineno-71-17" name="__codelineno-71-17"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NodePath</span><span class="p">{</span><span class="s">&quot;child_agent&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;llm&quot;</span><span class="p">},</span>
</span><span id="__span-71-18"><a id="__codelineno-71-18" name="__codelineno-71-18"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithCallGenerationConfigPatch</span><span class="p">(</span><span class="nx">model</span><span class="p">.</span><span class="nx">GenerationConfigPatch</span><span class="p">{</span>
</span><span id="__span-71-19"><a id="__codelineno-71-19" name="__codelineno-71-19"></a><span class="w">            </span><span class="nx">Temperature</span><span class="p">:</span><span class="w"> </span><span class="nx">model</span><span class="p">.</span><span class="nx">Float64Ptr</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span><span id="__span-71-20"><a id="__codelineno-71-20" name="__codelineno-71-20"></a><span class="w">        </span><span class="p">}),</span>
</span><span id="__span-71-21"><a id="__codelineno-71-21" name="__codelineno-71-21"></a><span class="w">    </span><span class="p">),</span>
</span><span id="__span-71-22"><a id="__codelineno-71-22" name="__codelineno-71-22"></a><span class="p">)</span>
</span><span id="__span-71-23"><a id="__codelineno-71-23" name="__codelineno-71-23"></a>
</span><span id="__span-71-24"><a id="__codelineno-71-24" name="__codelineno-71-24"></a><span class="nx">ch</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">userID</span><span class="p">,</span><span class="w"> </span><span class="nx">sessionID</span><span class="p">,</span><span class="w"> </span><span class="nx">msg</span><span class="p">,</span><span class="w"> </span><span class="nx">runOpts</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>See <code>examples/graph/call_options_generation_config</code> for a runnable demo.</p>
<h4 id="toolsets-in-graphs-vs-agents">ToolSets in Graphs vs Agents</h4>
<p><code>graph.WithToolSets</code> is a <strong>per‑node, compile‑time</strong> configuration. It attaches one or more <code>tool.ToolSet</code> instances to a specific LLM node when you build the graph:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-72-1">1</a></span>
<span class="normal"><a href="#__codelineno-72-2">2</a></span>
<span class="normal"><a href="#__codelineno-72-3">3</a></span>
<span class="normal"><a href="#__codelineno-72-4">4</a></span>
<span class="normal"><a href="#__codelineno-72-5">5</a></span>
<span class="normal"><a href="#__codelineno-72-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-72-1"><a id="__codelineno-72-1" name="__codelineno-72-1"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddLLMNode</span><span class="p">(</span><span class="s">&quot;llm&quot;</span><span class="p">,</span>
</span><span id="__span-72-2"><a id="__codelineno-72-2" name="__codelineno-72-2"></a><span class="w">    </span><span class="nx">model</span><span class="p">,</span>
</span><span id="__span-72-3"><a id="__codelineno-72-3" name="__codelineno-72-3"></a><span class="w">    </span><span class="s">&quot;inst&quot;</span><span class="p">,</span>
</span><span id="__span-72-4"><a id="__codelineno-72-4" name="__codelineno-72-4"></a><span class="w">    </span><span class="nx">tools</span><span class="p">,</span>
</span><span id="__span-72-5"><a id="__codelineno-72-5" name="__codelineno-72-5"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithToolSets</span><span class="p">([]</span><span class="nx">tool</span><span class="p">.</span><span class="nx">ToolSet</span><span class="p">{</span><span class="nx">mcpToolSet</span><span class="p">,</span><span class="w"> </span><span class="nx">fileToolSet</span><span class="p">}),</span>
</span><span id="__span-72-6"><a id="__codelineno-72-6" name="__codelineno-72-6"></a><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>Key points:</p>
<ul>
<li>Graph structure (including node ToolSets) is <strong>immutable</strong> after <code>Compile()</code>. Changing ToolSets requires rebuilding the graph or providing a new <code>GraphAgent</code>.</li>
<li>Runtime‑level ToolSet changes should be handled at the Agent level (for example, <code>llmagent.AddToolSet</code>, <code>llmagent.RemoveToolSet</code>, <code>llmagent.SetToolSets</code>) or by swapping the underlying Agent used by a graph Agent node.</li>
</ul>
<p>Additionally, <code>graph.WithName</code>/<code>graph.WithDescription</code> add friendly labels; <code>graph.WithDestinations</code> declares potential dynamic destinations (for static checks/visualization only).</p>
<h3 id="llm-input-rules-threestage-design">LLM Input Rules: Three‑Stage Design</h3>
<p>The LLM input pipeline looks simple but solves common context‑management problems in AI apps.</p>
<p>Built‑in selection logic (no extra config):</p>
<ol>
<li>Prefer <code>graph.StateKeyOneShotMessages</code>: fully override inputs (system/user) for this turn; cleared after execution.</li>
<li>Else use <code>graph.StateKeyUserInput</code>: append this turn's user to <code>graph.StateKeyMessages</code>, then atomically write back user+assistant; finally clear <code>graph.StateKeyUserInput</code>.</li>
<li>Else use <code>graph.StateKeyMessages</code> only: common on tool loops re‑entering LLM (since <code>graph.StateKeyUserInput</code> has been cleared).</li>
</ol>
<p>The benefit: preprocess nodes can rewrite <code>graph.StateKeyUserInput</code> and take effect in the same turn, while seamlessly integrating with the tool loop (tool_calls → tools → LLM).</p>
<p>Examples (showing the three paths):</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-73-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-73-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-73-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-73-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-73-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-73-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-73-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-73-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-73-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-73-10">10</a></span>
<span class="normal"><a href="#__codelineno-73-11">11</a></span>
<span class="normal"><a href="#__codelineno-73-12">12</a></span>
<span class="normal"><a href="#__codelineno-73-13">13</a></span>
<span class="normal"><a href="#__codelineno-73-14">14</a></span>
<span class="normal"><a href="#__codelineno-73-15">15</a></span>
<span class="normal"><a href="#__codelineno-73-16">16</a></span>
<span class="normal"><a href="#__codelineno-73-17">17</a></span>
<span class="normal"><a href="#__codelineno-73-18">18</a></span>
<span class="normal"><a href="#__codelineno-73-19">19</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-73-1"><a id="__codelineno-73-1" name="__codelineno-73-1"></a><span class="c1">// OneShot (graph.StateKeyOneShotMessages): completely override this turn&#39;s inputs (system/user)</span>
</span><span id="__span-73-2"><a id="__codelineno-73-2" name="__codelineno-73-2"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-73-3"><a id="__codelineno-73-3" name="__codelineno-73-3"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-73-4"><a id="__codelineno-73-4" name="__codelineno-73-4"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/model&quot;</span>
</span><span id="__span-73-5"><a id="__codelineno-73-5" name="__codelineno-73-5"></a><span class="p">)</span>
</span><span id="__span-73-6"><a id="__codelineno-73-6" name="__codelineno-73-6"></a>
</span><span id="__span-73-7"><a id="__codelineno-73-7" name="__codelineno-73-7"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-73-8"><a id="__codelineno-73-8" name="__codelineno-73-8"></a><span class="w">    </span><span class="nx">systemPrompt</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;You are a careful and reliable assistant&quot;</span>
</span><span id="__span-73-9"><a id="__codelineno-73-9" name="__codelineno-73-9"></a><span class="w">    </span><span class="nx">userPrompt</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;Summarize this text in bullet points&quot;</span>
</span><span id="__span-73-10"><a id="__codelineno-73-10" name="__codelineno-73-10"></a><span class="p">)</span>
</span><span id="__span-73-11"><a id="__codelineno-73-11" name="__codelineno-73-11"></a>
</span><span id="__span-73-12"><a id="__codelineno-73-12" name="__codelineno-73-12"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;prepare_prompt&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-73-13"><a id="__codelineno-73-13" name="__codelineno-73-13"></a><span class="w">    </span><span class="nx">oneShot</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">[]</span><span class="nx">model</span><span class="p">.</span><span class="nx">Message</span><span class="p">{</span>
</span><span id="__span-73-14"><a id="__codelineno-73-14" name="__codelineno-73-14"></a><span class="w">        </span><span class="nx">model</span><span class="p">.</span><span class="nx">NewSystemMessage</span><span class="p">(</span><span class="nx">systemPrompt</span><span class="p">),</span>
</span><span id="__span-73-15"><a id="__codelineno-73-15" name="__codelineno-73-15"></a><span class="w">        </span><span class="nx">model</span><span class="p">.</span><span class="nx">NewUserMessage</span><span class="p">(</span><span class="nx">userPrompt</span><span class="p">),</span>
</span><span id="__span-73-16"><a id="__codelineno-73-16" name="__codelineno-73-16"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-73-17"><a id="__codelineno-73-17" name="__codelineno-73-17"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyOneShotMessages</span><span class="p">:</span><span class="w"> </span><span class="nx">oneShot</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-73-18"><a id="__codelineno-73-18" name="__codelineno-73-18"></a><span class="p">})</span>
</span><span id="__span-73-19"><a id="__codelineno-73-19" name="__codelineno-73-19"></a><span class="c1">// The following LLM node will use graph.StateKeyOneShotMessages only and clear it afterwards</span>
</span></code></pre></div></td></tr></table></div>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-74-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-74-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-74-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-74-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-74-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-74-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-74-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-74-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-74-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-74-10">10</a></span>
<span class="normal"><a href="#__codelineno-74-11">11</a></span>
<span class="normal"><a href="#__codelineno-74-12">12</a></span>
<span class="normal"><a href="#__codelineno-74-13">13</a></span>
<span class="normal"><a href="#__codelineno-74-14">14</a></span>
<span class="normal"><a href="#__codelineno-74-15">15</a></span>
<span class="normal"><a href="#__codelineno-74-16">16</a></span>
<span class="normal"><a href="#__codelineno-74-17">17</a></span>
<span class="normal"><a href="#__codelineno-74-18">18</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-74-1"><a id="__codelineno-74-1" name="__codelineno-74-1"></a><span class="c1">// UserInput (graph.StateKeyUserInput): append this turn&#39;s user input on top of history graph.StateKeyMessages</span>
</span><span id="__span-74-2"><a id="__codelineno-74-2" name="__codelineno-74-2"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-74-3"><a id="__codelineno-74-3" name="__codelineno-74-3"></a><span class="w">    </span><span class="s">&quot;strings&quot;</span>
</span><span id="__span-74-4"><a id="__codelineno-74-4" name="__codelineno-74-4"></a>
</span><span id="__span-74-5"><a id="__codelineno-74-5" name="__codelineno-74-5"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-74-6"><a id="__codelineno-74-6" name="__codelineno-74-6"></a><span class="p">)</span>
</span><span id="__span-74-7"><a id="__codelineno-74-7" name="__codelineno-74-7"></a>
</span><span id="__span-74-8"><a id="__codelineno-74-8" name="__codelineno-74-8"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-74-9"><a id="__codelineno-74-9" name="__codelineno-74-9"></a><span class="w">    </span><span class="nx">stateKeyCleanedInput</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;cleaned_input&quot;</span>
</span><span id="__span-74-10"><a id="__codelineno-74-10" name="__codelineno-74-10"></a><span class="p">)</span>
</span><span id="__span-74-11"><a id="__codelineno-74-11" name="__codelineno-74-11"></a>
</span><span id="__span-74-12"><a id="__codelineno-74-12" name="__codelineno-74-12"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;clean_input&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-74-13"><a id="__codelineno-74-13" name="__codelineno-74-13"></a><span class="w">    </span><span class="nx">in</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">strings</span><span class="p">.</span><span class="nx">TrimSpace</span><span class="p">(</span><span class="nx">s</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyUserInput</span><span class="p">].(</span><span class="kt">string</span><span class="p">))</span>
</span><span id="__span-74-14"><a id="__codelineno-74-14" name="__codelineno-74-14"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span>
</span><span id="__span-74-15"><a id="__codelineno-74-15" name="__codelineno-74-15"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyUserInput</span><span class="p">:</span><span class="w"> </span><span class="nx">in</span><span class="p">,</span><span class="w">                </span><span class="c1">// LLM node atomically writes user+assistant to messages</span>
</span><span id="__span-74-16"><a id="__codelineno-74-16" name="__codelineno-74-16"></a><span class="w">        </span><span class="nx">stateKeyCleanedInput</span><span class="p">:</span><span class="w">    </span><span class="nx">in</span><span class="p">,</span><span class="w">                </span><span class="c1">// keep a business‑specific key as well</span>
</span><span id="__span-74-17"><a id="__codelineno-74-17" name="__codelineno-74-17"></a><span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-74-18"><a id="__codelineno-74-18" name="__codelineno-74-18"></a><span class="p">})</span>
</span></code></pre></div></td></tr></table></div>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-75-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-75-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-75-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-75-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-75-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-75-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-75-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-75-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-75-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-75-10">10</a></span>
<span class="normal"><a href="#__codelineno-75-11">11</a></span>
<span class="normal"><a href="#__codelineno-75-12">12</a></span>
<span class="normal"><a href="#__codelineno-75-13">13</a></span>
<span class="normal"><a href="#__codelineno-75-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-75-1"><a id="__codelineno-75-1" name="__codelineno-75-1"></a><span class="c1">// Messages‑only (graph.StateKeyMessages): after tool loop returns, graph.StateKeyUserInput is cleared; LLM continues based on graph.StateKeyMessages (incl. tool responses)</span>
</span><span id="__span-75-2"><a id="__codelineno-75-2" name="__codelineno-75-2"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-75-3"><a id="__codelineno-75-3" name="__codelineno-75-3"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-75-4"><a id="__codelineno-75-4" name="__codelineno-75-4"></a><span class="p">)</span>
</span><span id="__span-75-5"><a id="__codelineno-75-5" name="__codelineno-75-5"></a>
</span><span id="__span-75-6"><a id="__codelineno-75-6" name="__codelineno-75-6"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-75-7"><a id="__codelineno-75-7" name="__codelineno-75-7"></a><span class="w">    </span><span class="nx">nodeAsk</span><span class="w">       </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;ask&quot;</span>
</span><span id="__span-75-8"><a id="__codelineno-75-8" name="__codelineno-75-8"></a><span class="w">    </span><span class="nx">nodeExecTools</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;exec_tools&quot;</span>
</span><span id="__span-75-9"><a id="__codelineno-75-9" name="__codelineno-75-9"></a><span class="w">    </span><span class="nx">nodeFallback</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;fallback&quot;</span>
</span><span id="__span-75-10"><a id="__codelineno-75-10" name="__codelineno-75-10"></a><span class="p">)</span>
</span><span id="__span-75-11"><a id="__codelineno-75-11" name="__codelineno-75-11"></a>
</span><span id="__span-75-12"><a id="__codelineno-75-12" name="__codelineno-75-12"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddToolsNode</span><span class="p">(</span><span class="nx">nodeExecTools</span><span class="p">,</span><span class="w"> </span><span class="nx">tools</span><span class="p">)</span>
</span><span id="__span-75-13"><a id="__codelineno-75-13" name="__codelineno-75-13"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddToolsConditionalEdges</span><span class="p">(</span><span class="nx">nodeAsk</span><span class="p">,</span><span class="w"> </span><span class="nx">nodeExecTools</span><span class="p">,</span><span class="w"> </span><span class="nx">nodeFallback</span><span class="p">)</span>
</span><span id="__span-75-14"><a id="__codelineno-75-14" name="__codelineno-75-14"></a><span class="c1">// On returning to nodeAsk (or a downstream LLM) graph.StateKeyUserInput is empty, so it follows the messages‑only path</span>
</span></code></pre></div></td></tr></table></div>
<h4 id="instruction-placeholder-injection">Instruction Placeholder Injection</h4>
<p><code>AddLLMNode</code>'s <code>instruction</code> supports placeholders, same syntax as <code>llmagent</code>:</p>
<ul>
<li><code>{key}</code> / <code>{key?}</code>: read from <code>session.State</code>; optional <code>?</code> yields empty when missing.</li>
<li><code>{user:subkey}</code>, <code>{app:subkey}</code>, <code>{temp:subkey}</code>: read by namespace.</li>
</ul>
<p>GraphAgent stores the current <code>*session.Session</code> into state (<code>graph.StateKeySession</code>) and expands placeholders before the LLM call.</p>
<p>Tip: GraphAgent seeds <code>graph.StateKeyMessages</code> from prior session events for multi‑turn continuity. When resuming from a checkpoint, a plain "resume" message is not injected as <code>graph.StateKeyUserInput</code>, preserving the recovered state.</p>
<h3 id="concurrency-and-state-safety">Concurrency and State Safety</h3>
<p>When a node has multiple outgoing edges, parallel execution is triggered automatically:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-76-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-76-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-76-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-76-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-76-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-76-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-76-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-76-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-76-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-76-10">10</a></span>
<span class="normal"><a href="#__codelineno-76-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-76-1"><a id="__codelineno-76-1" name="__codelineno-76-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-76-2"><a id="__codelineno-76-2" name="__codelineno-76-2"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-76-3"><a id="__codelineno-76-3" name="__codelineno-76-3"></a><span class="p">)</span>
</span><span id="__span-76-4"><a id="__codelineno-76-4" name="__codelineno-76-4"></a>
</span><span id="__span-76-5"><a id="__codelineno-76-5" name="__codelineno-76-5"></a><span class="c1">// This graph structure executes in parallel automatically</span>
</span><span id="__span-76-6"><a id="__codelineno-76-6" name="__codelineno-76-6"></a><span class="nx">stateGraph</span><span class="p">.</span>
</span><span id="__span-76-7"><a id="__codelineno-76-7" name="__codelineno-76-7"></a><span class="w">    </span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;analyze&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">analyzeData</span><span class="p">).</span>
</span><span id="__span-76-8"><a id="__codelineno-76-8" name="__codelineno-76-8"></a><span class="w">    </span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;generate_report&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">generateReport</span><span class="p">).</span>
</span><span id="__span-76-9"><a id="__codelineno-76-9" name="__codelineno-76-9"></a><span class="w">    </span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;call_external_api&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">callAPI</span><span class="p">).</span>
</span><span id="__span-76-10"><a id="__codelineno-76-10" name="__codelineno-76-10"></a><span class="w">    </span><span class="nx">AddEdge</span><span class="p">(</span><span class="s">&quot;analyze&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;generate_report&quot;</span><span class="p">).</span><span class="w">    </span><span class="c1">// these two run in parallel</span>
</span><span id="__span-76-11"><a id="__codelineno-76-11" name="__codelineno-76-11"></a><span class="w">    </span><span class="nx">AddEdge</span><span class="p">(</span><span class="s">&quot;analyze&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;call_external_api&quot;</span><span class="p">)</span><span class="w">   </span><span class="c1">//</span>
</span></code></pre></div></td></tr></table></div>
<p>Internally, the executor constructs shallow copies (maps.Copy) per task and merges under a lock, with reducers ensuring safe concurrent updates.</p>
<h3 id="node-io-conventions_1">Node I/O Conventions</h3>
<p>Nodes communicate only via the shared <code>State</code>. Each node returns a state delta that merges via the Schema's reducers.</p>
<ul>
<li>
<p>Function nodes</p>
<ul>
<li>Input: full <code>State</code> (read keys declared in your schema)</li>
<li>Output: write business keys only (e.g., <code>{"parsed_time":"..."}</code>); avoid internal keys</li>
</ul>
</li>
</ul>
<ul>
<li>
<p>LLM nodes</p>
<ul>
<li>Input priority:
  <code>graph.StateKeyOneShotMessagesByNode[&lt;node_id&gt;]</code> →
  <code>graph.StateKeyOneShotMessages</code> →
  <code>graph.StateKeyUserInput</code> →
  <code>graph.StateKeyMessages</code></li>
<li>Output: append to <code>graph.StateKeyMessages</code> atomically, set <code>graph.StateKeyLastResponse</code>, set <code>graph.StateKeyNodeResponses[&lt;llm_node_id&gt;]</code></li>
</ul>
</li>
</ul>
<ul>
<li>
<p>Tools nodes</p>
<ul>
<li>Read the latest assistant message with <code>tool_calls</code> for the current round and append tool responses to <code>graph.StateKeyMessages</code></li>
<li>Output: set <code>graph.StateKeyLastToolResponse</code>, set <code>graph.StateKeyNodeResponses[&lt;tools_node_id&gt;]</code> (JSON array string)</li>
<li>Multiple tools execute in the order returned by the LLM</li>
</ul>
</li>
</ul>
<ul>
<li>Agent nodes<ul>
<li>Receive graph <code>State</code> via <code>Invocation.RunOptions.RuntimeState</code></li>
<li>Output: set <code>graph.StateKeyLastResponse</code> and <code>graph.StateKeyNodeResponses[&lt;agent_node_id&gt;]</code>; <code>graph.StateKeyUserInput</code> is cleared after execution</li>
</ul>
</li>
</ul>
<p>Good practice:</p>
<ul>
<li>Sequential reads: consume the immediate upstream text from <code>graph.StateKeyLastResponse</code>.</li>
<li>Parallel/merge reads: read specific node outputs from <code>graph.StateKeyNodeResponses[&lt;nodeID&gt;]</code>.</li>
<li>Declare business keys in your schema with suitable reducers to avoid data races.</li>
</ul>
<h3 id="api-cheat-sheet">API Cheat Sheet</h3>
<ul>
<li>
<p>Build graph</p>
<ul>
<li><code>graph.NewStateGraph(schema)</code> → builder</li>
<li><code>AddNode(id, func, ...opts)</code> / <code>AddLLMNode(id, model, instruction, tools, ...opts)</code></li>
<li><code>AddToolsNode(id, tools, ...opts)</code> / <code>AddAgentNode(id, ...opts)</code></li>
<li><code>AddEdge(from, to)</code> / <code>AddConditionalEdges(from, condition, pathMap)</code></li>
<li><code>AddToolsConditionalEdges(llmNode, toolsNode, fallback)</code></li>
<li><code>SetEntryPoint(nodeID)</code> / <code>SetFinishPoint(nodeID)</code> / <code>Compile()</code></li>
</ul>
</li>
</ul>
<ul>
<li>
<p>State keys (user‑visible)</p>
<ul>
<li><code>graph.StateKeyUserInput</code>, <code>graph.StateKeyOneShotMessages</code>, <code>graph.StateKeyMessages</code>, <code>graph.StateKeyLastResponse</code>, <code>graph.StateKeyNodeResponses</code>, <code>graph.StateKeyMetadata</code></li>
</ul>
</li>
</ul>
<ul>
<li>
<p>Per‑node options</p>
<ul>
<li>LLM/tools:<ul>
<li><code>graph.WithGenerationConfig</code>, <code>graph.WithModelCallbacks</code></li>
<li><code>graph.WithToolCallbacks</code>, <code>graph.WithToolSets</code></li>
</ul>
</li>
<li>Callbacks:<ul>
<li><code>graph.WithPreNodeCallback</code>, <code>graph.WithPostNodeCallback</code>, <code>graph.WithNodeErrorCallback</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li>Execution<ul>
<li><code>graphagent.New(name, compiledGraph, ...opts)</code> → <code>runner.NewRunner(app, agent)</code> → <code>Run(...)</code></li>
</ul>
</li>
</ul>
<p>See examples under <code>examples/graph</code> for end‑to‑end patterns (basic/parallel/multi‑turn/interrupts/nested_interrupt/static_interrupt/tools/placeholder).</p>
<h2 id="visualization-dotimage">Visualization (DOT/Image)</h2>
<p>Graph can export a Graphviz DOT (Directed Graph Language) description and render images via the <code>dot</code> (Graph Visualization layout engine) executable.</p>
<ul>
<li><code>WithDestinations</code> draws dotted gray edges for declared dynamic routes (visualization + static checks only; it does not affect runtime).</li>
<li>Conditional edges render as dashed gray edges with branch labels.</li>
<li>Regular edges render as solid lines.</li>
<li>Virtual <code>Start</code>/<code>End</code> nodes can be shown or hidden via an option.</li>
</ul>
<p>Example:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-77-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-77-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-77-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-77-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-77-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-77-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-77-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-77-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-77-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-77-10">10</a></span>
<span class="normal"><a href="#__codelineno-77-11">11</a></span>
<span class="normal"><a href="#__codelineno-77-12">12</a></span>
<span class="normal"><a href="#__codelineno-77-13">13</a></span>
<span class="normal"><a href="#__codelineno-77-14">14</a></span>
<span class="normal"><a href="#__codelineno-77-15">15</a></span>
<span class="normal"><a href="#__codelineno-77-16">16</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-77-1"><a id="__codelineno-77-1" name="__codelineno-77-1"></a><span class="nx">g</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">sg</span><span class="p">.</span><span class="nx">MustCompile</span><span class="p">()</span>
</span><span id="__span-77-2"><a id="__codelineno-77-2" name="__codelineno-77-2"></a>
</span><span id="__span-77-3"><a id="__codelineno-77-3" name="__codelineno-77-3"></a><span class="c1">// Build DOT text</span>
</span><span id="__span-77-4"><a id="__codelineno-77-4" name="__codelineno-77-4"></a><span class="nx">dot</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">DOT</span><span class="p">(</span>
</span><span id="__span-77-5"><a id="__codelineno-77-5" name="__codelineno-77-5"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithRankDir</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">RankDirLR</span><span class="p">),</span><span class="w">  </span><span class="c1">// left→right (or graph.RankDirTB)</span>
</span><span id="__span-77-6"><a id="__codelineno-77-6" name="__codelineno-77-6"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithIncludeDestinations</span><span class="p">(</span><span class="kc">true</span><span class="p">),</span><span class="w"> </span><span class="c1">// show declared WithDestinations</span>
</span><span id="__span-77-7"><a id="__codelineno-77-7" name="__codelineno-77-7"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithGraphLabel</span><span class="p">(</span><span class="s">&quot;My Workflow&quot;</span><span class="p">),</span>
</span><span id="__span-77-8"><a id="__codelineno-77-8" name="__codelineno-77-8"></a><span class="p">)</span>
</span><span id="__span-77-9"><a id="__codelineno-77-9" name="__codelineno-77-9"></a>
</span><span id="__span-77-10"><a id="__codelineno-77-10" name="__codelineno-77-10"></a><span class="c1">// Render PNG (requires Graphviz&#39;s dot)</span>
</span><span id="__span-77-11"><a id="__codelineno-77-11" name="__codelineno-77-11"></a><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">RenderImage</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Background</span><span class="p">(),</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">ImageFormatPNG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;workflow.png&quot;</span><span class="p">,</span>
</span><span id="__span-77-12"><a id="__codelineno-77-12" name="__codelineno-77-12"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithRankDir</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">RankDirLR</span><span class="p">),</span>
</span><span id="__span-77-13"><a id="__codelineno-77-13" name="__codelineno-77-13"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithIncludeDestinations</span><span class="p">(</span><span class="kc">true</span><span class="p">),</span>
</span><span id="__span-77-14"><a id="__codelineno-77-14" name="__codelineno-77-14"></a><span class="p">);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-77-15"><a id="__codelineno-77-15" name="__codelineno-77-15"></a><span class="w">    </span><span class="c1">// If Graphviz is not installed, this returns an error — ignore or instruct the user to install dot</span>
</span><span id="__span-77-16"><a id="__codelineno-77-16" name="__codelineno-77-16"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>API reference:</p>
<ul>
<li><code>g.DOT(...)</code> / <code>g.WriteDOT(w, ...)</code> on a compiled <code>*graph.Graph</code></li>
<li><code>g.RenderImage(ctx, format, outputPath, ...)</code> (e.g., <code>png</code>/<code>svg</code>)</li>
<li>Options: <code>WithRankDir(graph.RankDirLR|graph.RankDirTB)</code>, <code>WithIncludeDestinations(bool)</code>, <code>WithIncludeStartEnd(bool)</code>, <code>WithGraphLabel(string)</code></li>
</ul>
<p>Full example: <code>examples/graph/visualization</code></p>
<h2 id="advanced-features_1">Advanced Features</h2>
<h3 id="checkpoints-and-recovery">Checkpoints and Recovery</h3>
<p>To support time‑travel and reliable recovery, configure a checkpoint saver on the Executor or GraphAgent. Below uses the SQLite saver to persist checkpoints and resume from a specific checkpoint.</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-78-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-78-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-78-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-78-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-78-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-78-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-78-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-78-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-78-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-78-10">10</a></span>
<span class="normal"><a href="#__codelineno-78-11">11</a></span>
<span class="normal"><a href="#__codelineno-78-12">12</a></span>
<span class="normal"><a href="#__codelineno-78-13">13</a></span>
<span class="normal"><a href="#__codelineno-78-14">14</a></span>
<span class="normal"><a href="#__codelineno-78-15">15</a></span>
<span class="normal"><a href="#__codelineno-78-16">16</a></span>
<span class="normal"><a href="#__codelineno-78-17">17</a></span>
<span class="normal"><a href="#__codelineno-78-18">18</a></span>
<span class="normal"><a href="#__codelineno-78-19">19</a></span>
<span class="normal"><a href="#__codelineno-78-20">20</a></span>
<span class="normal"><a href="#__codelineno-78-21">21</a></span>
<span class="normal"><a href="#__codelineno-78-22">22</a></span>
<span class="normal"><a href="#__codelineno-78-23">23</a></span>
<span class="normal"><a href="#__codelineno-78-24">24</a></span>
<span class="normal"><a href="#__codelineno-78-25">25</a></span>
<span class="normal"><a href="#__codelineno-78-26">26</a></span>
<span class="normal"><a href="#__codelineno-78-27">27</a></span>
<span class="normal"><a href="#__codelineno-78-28">28</a></span>
<span class="normal"><a href="#__codelineno-78-29">29</a></span>
<span class="normal"><a href="#__codelineno-78-30">30</a></span>
<span class="normal"><a href="#__codelineno-78-31">31</a></span>
<span class="normal"><a href="#__codelineno-78-32">32</a></span>
<span class="normal"><a href="#__codelineno-78-33">33</a></span>
<span class="normal"><a href="#__codelineno-78-34">34</a></span>
<span class="normal"><a href="#__codelineno-78-35">35</a></span>
<span class="normal"><a href="#__codelineno-78-36">36</a></span>
<span class="normal"><a href="#__codelineno-78-37">37</a></span>
<span class="normal"><a href="#__codelineno-78-38">38</a></span>
<span class="normal"><a href="#__codelineno-78-39">39</a></span>
<span class="normal"><a href="#__codelineno-78-40">40</a></span>
<span class="normal"><a href="#__codelineno-78-41">41</a></span>
<span class="normal"><a href="#__codelineno-78-42">42</a></span>
<span class="normal"><a href="#__codelineno-78-43">43</a></span>
<span class="normal"><a href="#__codelineno-78-44">44</a></span>
<span class="normal"><a href="#__codelineno-78-45">45</a></span>
<span class="normal"><a href="#__codelineno-78-46">46</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-78-1"><a id="__codelineno-78-1" name="__codelineno-78-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-78-2"><a id="__codelineno-78-2" name="__codelineno-78-2"></a><span class="w">    </span><span class="s">&quot;database/sql&quot;</span>
</span><span id="__span-78-3"><a id="__codelineno-78-3" name="__codelineno-78-3"></a>
</span><span id="__span-78-4"><a id="__codelineno-78-4" name="__codelineno-78-4"></a><span class="w">    </span><span class="nx">_</span><span class="w"> </span><span class="s">&quot;github.com/mattn/go-sqlite3&quot;</span>
</span><span id="__span-78-5"><a id="__codelineno-78-5" name="__codelineno-78-5"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/agent&quot;</span>
</span><span id="__span-78-6"><a id="__codelineno-78-6" name="__codelineno-78-6"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/agent/graphagent&quot;</span>
</span><span id="__span-78-7"><a id="__codelineno-78-7" name="__codelineno-78-7"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-78-8"><a id="__codelineno-78-8" name="__codelineno-78-8"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph/checkpoint/sqlite&quot;</span>
</span><span id="__span-78-9"><a id="__codelineno-78-9" name="__codelineno-78-9"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph/checkpoint/redis&quot;</span>
</span><span id="__span-78-10"><a id="__codelineno-78-10" name="__codelineno-78-10"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/model&quot;</span>
</span><span id="__span-78-11"><a id="__codelineno-78-11" name="__codelineno-78-11"></a><span class="p">)</span>
</span><span id="__span-78-12"><a id="__codelineno-78-12" name="__codelineno-78-12"></a>
</span><span id="__span-78-13"><a id="__codelineno-78-13" name="__codelineno-78-13"></a><span class="c1">// Configure checkpoints</span>
</span><span id="__span-78-14"><a id="__codelineno-78-14" name="__codelineno-78-14"></a><span class="nx">db</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">sql</span><span class="p">.</span><span class="nx">Open</span><span class="p">(</span><span class="s">&quot;sqlite3&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;./checkpoints.db&quot;</span><span class="p">)</span>
</span><span id="__span-78-15"><a id="__codelineno-78-15" name="__codelineno-78-15"></a><span class="nx">saver</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">sqlite</span><span class="p">.</span><span class="nx">NewSaver</span><span class="p">(</span><span class="nx">db</span><span class="p">)</span>
</span><span id="__span-78-16"><a id="__codelineno-78-16" name="__codelineno-78-16"></a>
</span><span id="__span-78-17"><a id="__codelineno-78-17" name="__codelineno-78-17"></a><span class="nx">graphAgent</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;workflow&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">g</span><span class="p">,</span>
</span><span id="__span-78-18"><a id="__codelineno-78-18" name="__codelineno-78-18"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithCheckpointSaver</span><span class="p">(</span><span class="nx">saver</span><span class="p">))</span>
</span><span id="__span-78-19"><a id="__codelineno-78-19" name="__codelineno-78-19"></a>
</span><span id="__span-78-20"><a id="__codelineno-78-20" name="__codelineno-78-20"></a><span class="c1">// Checkpoints are saved automatically during execution (by default every step)</span>
</span><span id="__span-78-21"><a id="__codelineno-78-21" name="__codelineno-78-21"></a>
</span><span id="__span-78-22"><a id="__codelineno-78-22" name="__codelineno-78-22"></a><span class="c1">// Resume from a checkpoint</span>
</span><span id="__span-78-23"><a id="__codelineno-78-23" name="__codelineno-78-23"></a><span class="nx">eventCh</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">userID</span><span class="p">,</span><span class="w"> </span><span class="nx">sessionID</span><span class="p">,</span>
</span><span id="__span-78-24"><a id="__codelineno-78-24" name="__codelineno-78-24"></a><span class="w">    </span><span class="nx">model</span><span class="p">.</span><span class="nx">NewUserMessage</span><span class="p">(</span><span class="s">&quot;resume&quot;</span><span class="p">),</span>
</span><span id="__span-78-25"><a id="__codelineno-78-25" name="__codelineno-78-25"></a><span class="w">    </span><span class="nx">agent</span><span class="p">.</span><span class="nx">WithRuntimeState</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">any</span><span class="p">{</span>
</span><span id="__span-78-26"><a id="__codelineno-78-26" name="__codelineno-78-26"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">CfgKeyLineageID</span><span class="p">:</span><span class="w">    </span><span class="nx">lineageID</span><span class="p">,</span>
</span><span id="__span-78-27"><a id="__codelineno-78-27" name="__codelineno-78-27"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">CfgKeyCheckpointID</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ckpt-123&quot;</span><span class="p">,</span>
</span><span id="__span-78-28"><a id="__codelineno-78-28" name="__codelineno-78-28"></a><span class="w">    </span><span class="p">}),</span>
</span><span id="__span-78-29"><a id="__codelineno-78-29" name="__codelineno-78-29"></a><span class="p">)</span>
</span><span id="__span-78-30"><a id="__codelineno-78-30" name="__codelineno-78-30"></a>
</span><span id="__span-78-31"><a id="__codelineno-78-31" name="__codelineno-78-31"></a><span class="c1">// Configure redis checkpoints</span>
</span><span id="__span-78-32"><a id="__codelineno-78-32" name="__codelineno-78-32"></a><span class="nx">redisSaver</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">redis</span><span class="p">.</span><span class="nx">NewSaver</span><span class="p">(</span><span class="nx">redis</span><span class="p">.</span><span class="nx">WithRedisClientURL</span><span class="p">(</span><span class="s">&quot;redis://[username:password@]host:port[/database]&quot;</span><span class="p">))</span>
</span><span id="__span-78-33"><a id="__codelineno-78-33" name="__codelineno-78-33"></a>
</span><span id="__span-78-34"><a id="__codelineno-78-34" name="__codelineno-78-34"></a><span class="nx">graphAgent</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;workflow&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">g</span><span class="p">,</span>
</span><span id="__span-78-35"><a id="__codelineno-78-35" name="__codelineno-78-35"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithCheckpointSaver</span><span class="p">(</span><span class="nx">redisSaver</span><span class="p">))</span>
</span><span id="__span-78-36"><a id="__codelineno-78-36" name="__codelineno-78-36"></a>
</span><span id="__span-78-37"><a id="__codelineno-78-37" name="__codelineno-78-37"></a><span class="c1">// Checkpoints are saved automatically during execution (by default every step)</span>
</span><span id="__span-78-38"><a id="__codelineno-78-38" name="__codelineno-78-38"></a>
</span><span id="__span-78-39"><a id="__codelineno-78-39" name="__codelineno-78-39"></a><span class="c1">// Resume from a checkpoint</span>
</span><span id="__span-78-40"><a id="__codelineno-78-40" name="__codelineno-78-40"></a><span class="nx">eventCh</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">userID</span><span class="p">,</span><span class="w"> </span><span class="nx">sessionID</span><span class="p">,</span>
</span><span id="__span-78-41"><a id="__codelineno-78-41" name="__codelineno-78-41"></a><span class="w">    </span><span class="nx">model</span><span class="p">.</span><span class="nx">NewUserMessage</span><span class="p">(</span><span class="s">&quot;resume&quot;</span><span class="p">),</span>
</span><span id="__span-78-42"><a id="__codelineno-78-42" name="__codelineno-78-42"></a><span class="w">    </span><span class="nx">agent</span><span class="p">.</span><span class="nx">WithRuntimeState</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">any</span><span class="p">{</span>
</span><span id="__span-78-43"><a id="__codelineno-78-43" name="__codelineno-78-43"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">CfgKeyLineageID</span><span class="p">:</span><span class="w">    </span><span class="nx">lineageID</span><span class="p">,</span>
</span><span id="__span-78-44"><a id="__codelineno-78-44" name="__codelineno-78-44"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">CfgKeyCheckpointID</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ckpt-123&quot;</span><span class="p">,</span>
</span><span id="__span-78-45"><a id="__codelineno-78-45" name="__codelineno-78-45"></a><span class="w">    </span><span class="p">}),</span>
</span><span id="__span-78-46"><a id="__codelineno-78-46" name="__codelineno-78-46"></a><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<h4 id="checkpoint-management">Checkpoint Management</h4>
<p>Use the manager to list, query, and delete checkpoints:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-79-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-79-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-79-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-79-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-79-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-79-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-79-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-79-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-79-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-79-10">10</a></span>
<span class="normal"><a href="#__codelineno-79-11">11</a></span>
<span class="normal"><a href="#__codelineno-79-12">12</a></span>
<span class="normal"><a href="#__codelineno-79-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-79-1"><a id="__codelineno-79-1" name="__codelineno-79-1"></a><span class="nx">cm</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewCheckpointManager</span><span class="p">(</span><span class="nx">saver</span><span class="p">)</span>
</span><span id="__span-79-2"><a id="__codelineno-79-2" name="__codelineno-79-2"></a>
</span><span id="__span-79-3"><a id="__codelineno-79-3" name="__codelineno-79-3"></a><span class="c1">// Latest checkpoint (filter by namespace; empty string means cross‑namespace)</span>
</span><span id="__span-79-4"><a id="__codelineno-79-4" name="__codelineno-79-4"></a><span class="nx">latest</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">cm</span><span class="p">.</span><span class="nx">Latest</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">lineageID</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">)</span>
</span><span id="__span-79-5"><a id="__codelineno-79-5" name="__codelineno-79-5"></a>
</span><span id="__span-79-6"><a id="__codelineno-79-6" name="__codelineno-79-6"></a><span class="c1">// List (time‑desc)</span>
</span><span id="__span-79-7"><a id="__codelineno-79-7" name="__codelineno-79-7"></a><span class="nx">tuples</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">cm</span><span class="p">.</span><span class="nx">ListCheckpoints</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewCheckpointConfig</span><span class="p">(</span><span class="nx">lineageID</span><span class="p">).</span><span class="nx">ToMap</span><span class="p">(),</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">graph</span><span class="p">.</span><span class="nx">CheckpointFilter</span><span class="p">{</span><span class="nx">Limit</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="p">})</span>
</span><span id="__span-79-8"><a id="__codelineno-79-8" name="__codelineno-79-8"></a>
</span><span id="__span-79-9"><a id="__codelineno-79-9" name="__codelineno-79-9"></a><span class="c1">// Get a specific checkpoint tuple (includes pending writes)</span>
</span><span id="__span-79-10"><a id="__codelineno-79-10" name="__codelineno-79-10"></a><span class="nx">tuple</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">cm</span><span class="p">.</span><span class="nx">GetTuple</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">CreateCheckpointConfig</span><span class="p">(</span><span class="nx">lineageID</span><span class="p">,</span><span class="w"> </span><span class="nx">checkpointID</span><span class="p">,</span><span class="w"> </span><span class="nx">namespace</span><span class="p">))</span>
</span><span id="__span-79-11"><a id="__codelineno-79-11" name="__codelineno-79-11"></a>
</span><span id="__span-79-12"><a id="__codelineno-79-12" name="__codelineno-79-12"></a><span class="c1">// Delete a lineage</span>
</span><span id="__span-79-13"><a id="__codelineno-79-13" name="__codelineno-79-13"></a><span class="nx">_</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">cm</span><span class="p">.</span><span class="nx">DeleteLineage</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">lineageID</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>Use a stable business identifier for <code>namespace</code> in production (e.g., <code>svc:prod:flowX</code>) for clear auditing.</p>
<h4 id="time-travel-read-edit-state">Time Travel: Read / Edit State</h4>
<p>Resuming from a checkpoint gives you "time travel" (rewind to any checkpoint and continue). For HITL and debugging, you often want one extra step: edit the state at a checkpoint and keep running from there.</p>
<p>Important detail: on resume, the executor restores state from the checkpoint first. <code>runtime_state</code> does not override existing checkpoint keys; it only fills missing non-internal keys. If you need to change an existing key, you must write a new checkpoint.</p>
<p>Use <code>graph.TimeTravel</code>:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-80-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-80-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-80-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-80-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-80-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-80-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-80-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-80-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-80-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-80-10">10</a></span>
<span class="normal"><a href="#__codelineno-80-11">11</a></span>
<span class="normal"><a href="#__codelineno-80-12">12</a></span>
<span class="normal"><a href="#__codelineno-80-13">13</a></span>
<span class="normal"><a href="#__codelineno-80-14">14</a></span>
<span class="normal"><a href="#__codelineno-80-15">15</a></span>
<span class="normal"><a href="#__codelineno-80-16">16</a></span>
<span class="normal"><a href="#__codelineno-80-17">17</a></span>
<span class="normal"><a href="#__codelineno-80-18">18</a></span>
<span class="normal"><a href="#__codelineno-80-19">19</a></span>
<span class="normal"><a href="#__codelineno-80-20">20</a></span>
<span class="normal"><a href="#__codelineno-80-21">21</a></span>
<span class="normal"><a href="#__codelineno-80-22">22</a></span>
<span class="normal"><a href="#__codelineno-80-23">23</a></span>
<span class="normal"><a href="#__codelineno-80-24">24</a></span>
<span class="normal"><a href="#__codelineno-80-25">25</a></span>
<span class="normal"><a href="#__codelineno-80-26">26</a></span>
<span class="normal"><a href="#__codelineno-80-27">27</a></span>
<span class="normal"><a href="#__codelineno-80-28">28</a></span>
<span class="normal"><a href="#__codelineno-80-29">29</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-80-1"><a id="__codelineno-80-1" name="__codelineno-80-1"></a><span class="c1">// If you&#39;re using GraphAgent:</span>
</span><span id="__span-80-2"><a id="__codelineno-80-2" name="__codelineno-80-2"></a><span class="nx">tt</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">ga</span><span class="p">.</span><span class="nx">TimeTravel</span><span class="p">()</span>
</span><span id="__span-80-3"><a id="__codelineno-80-3" name="__codelineno-80-3"></a><span class="c1">// Or if you have a raw executor:</span>
</span><span id="__span-80-4"><a id="__codelineno-80-4" name="__codelineno-80-4"></a><span class="c1">// tt, _ := exec.TimeTravel()</span>
</span><span id="__span-80-5"><a id="__codelineno-80-5" name="__codelineno-80-5"></a>
</span><span id="__span-80-6"><a id="__codelineno-80-6" name="__codelineno-80-6"></a><span class="nx">base</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">CheckpointRef</span><span class="p">{</span>
</span><span id="__span-80-7"><a id="__codelineno-80-7" name="__codelineno-80-7"></a><span class="w">    </span><span class="nx">LineageID</span><span class="p">:</span><span class="w">    </span><span class="nx">lineageID</span><span class="p">,</span>
</span><span id="__span-80-8"><a id="__codelineno-80-8" name="__codelineno-80-8"></a><span class="w">    </span><span class="nx">Namespace</span><span class="p">:</span><span class="w">    </span><span class="nx">namespace</span><span class="p">,</span>
</span><span id="__span-80-9"><a id="__codelineno-80-9" name="__codelineno-80-9"></a><span class="w">    </span><span class="nx">CheckpointID</span><span class="p">:</span><span class="w"> </span><span class="nx">checkpointID</span><span class="p">,</span><span class="w"> </span><span class="c1">// empty means &quot;latest&quot;</span>
</span><span id="__span-80-10"><a id="__codelineno-80-10" name="__codelineno-80-10"></a><span class="p">}</span>
</span><span id="__span-80-11"><a id="__codelineno-80-11" name="__codelineno-80-11"></a>
</span><span id="__span-80-12"><a id="__codelineno-80-12" name="__codelineno-80-12"></a><span class="c1">// Read checkpointed state (types restored using the graph schema).</span>
</span><span id="__span-80-13"><a id="__codelineno-80-13" name="__codelineno-80-13"></a><span class="nx">snap</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">tt</span><span class="p">.</span><span class="nx">GetState</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">base</span><span class="p">)</span>
</span><span id="__span-80-14"><a id="__codelineno-80-14" name="__codelineno-80-14"></a>
</span><span id="__span-80-15"><a id="__codelineno-80-15" name="__codelineno-80-15"></a><span class="c1">// Write an &quot;update&quot; checkpoint derived from base with patched state.</span>
</span><span id="__span-80-16"><a id="__codelineno-80-16" name="__codelineno-80-16"></a><span class="nx">newRef</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">tt</span><span class="p">.</span><span class="nx">EditState</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">base</span><span class="p">,</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span>
</span><span id="__span-80-17"><a id="__codelineno-80-17" name="__codelineno-80-17"></a><span class="w">    </span><span class="s">&quot;counter&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">42</span><span class="p">,</span>
</span><span id="__span-80-18"><a id="__codelineno-80-18" name="__codelineno-80-18"></a><span class="p">})</span>
</span><span id="__span-80-19"><a id="__codelineno-80-19" name="__codelineno-80-19"></a>
</span><span id="__span-80-20"><a id="__codelineno-80-20" name="__codelineno-80-20"></a><span class="c1">// Resume from the updated checkpoint (and provide resume values if needed).</span>
</span><span id="__span-80-21"><a id="__codelineno-80-21" name="__codelineno-80-21"></a><span class="nx">cmd</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewResumeCommand</span><span class="p">().</span>
</span><span id="__span-80-22"><a id="__codelineno-80-22" name="__codelineno-80-22"></a><span class="w">    </span><span class="nx">AddResumeValue</span><span class="p">(</span><span class="s">&quot;review_key&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;approved&quot;</span><span class="p">)</span>
</span><span id="__span-80-23"><a id="__codelineno-80-23" name="__codelineno-80-23"></a>
</span><span id="__span-80-24"><a id="__codelineno-80-24" name="__codelineno-80-24"></a><span class="nx">rs</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">newRef</span><span class="p">.</span><span class="nx">ToRuntimeState</span><span class="p">()</span>
</span><span id="__span-80-25"><a id="__codelineno-80-25" name="__codelineno-80-25"></a><span class="nx">rs</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyCommand</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">cmd</span>
</span><span id="__span-80-26"><a id="__codelineno-80-26" name="__codelineno-80-26"></a><span class="nx">eventCh</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">userID</span><span class="p">,</span><span class="w"> </span><span class="nx">sessionID</span><span class="p">,</span>
</span><span id="__span-80-27"><a id="__codelineno-80-27" name="__codelineno-80-27"></a><span class="w">    </span><span class="nx">model</span><span class="p">.</span><span class="nx">NewUserMessage</span><span class="p">(</span><span class="s">&quot;resume&quot;</span><span class="p">),</span>
</span><span id="__span-80-28"><a id="__codelineno-80-28" name="__codelineno-80-28"></a><span class="w">    </span><span class="nx">agent</span><span class="p">.</span><span class="nx">WithRuntimeState</span><span class="p">(</span><span class="nx">rs</span><span class="p">),</span>
</span><span id="__span-80-29"><a id="__codelineno-80-29" name="__codelineno-80-29"></a><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>Notes:</p>
<ul>
<li><code>EditState</code> writes a new checkpoint with <code>Source="update"</code> and <code>ParentCheckpointID=base</code>.</li>
<li>Internal keys are blocked by default; use <code>graph.WithAllowInternalKeys()</code> only if you know what you're doing.</li>
<li>Updated checkpoints include metadata keys: <code>graph.CheckpointMetaKeyBaseCheckpointID</code> and <code>graph.CheckpointMetaKeyUpdatedKeys</code>.</li>
</ul>
<p>Runnable example: <code>examples/graph/time_travel_edit_state</code>.</p>
<h3 id="events-at-a-glance">Events at a Glance</h3>
<ul>
<li>
<p>Authors</p>
<ul>
<li>Node-level: node ID (fallback <code>graph.AuthorGraphNode</code>)</li>
<li>Pregel phases: <code>graph.AuthorGraphPregel</code></li>
<li>Executor/system: <code>graph.AuthorGraphExecutor</code></li>
<li>User input: <code>user</code> (no exported constant)</li>
</ul>
</li>
</ul>
<ul>
<li>Object types (subset)<ul>
<li>Node: <code>graph.ObjectTypeGraphNodeStart | graph.ObjectTypeGraphNodeComplete | graph.ObjectTypeGraphNodeError</code></li>
<li>Pregel: <code>graph.ObjectTypeGraphPregelPlanning | graph.ObjectTypeGraphPregelExecution | graph.ObjectTypeGraphPregelUpdate</code></li>
<li>Channel/state: <code>graph.ObjectTypeGraphChannelUpdate</code> / <code>graph.ObjectTypeGraphStateUpdate</code></li>
<li>Checkpoints: <code>graph.ObjectTypeGraphCheckpoint</code>, <code>graph.ObjectTypeGraphCheckpointCreated</code>, <code>graph.ObjectTypeGraphCheckpointCommitted</code>, <code>graph.ObjectTypeGraphCheckpointInterrupt</code></li>
</ul>
</li>
</ul>
<p>See "Event Monitoring" for a full streaming example and metadata parsing.</p>
<h3 id="humanintheloop">Human‑in‑the‑Loop</h3>
<p>Introduce human confirmation on critical paths. The example shows a basic interrupt → resume flow:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-81-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-81-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-81-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-81-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-81-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-81-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-81-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-81-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-81-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-81-10">10</a></span>
<span class="normal"><a href="#__codelineno-81-11">11</a></span>
<span class="normal"><a href="#__codelineno-81-12">12</a></span>
<span class="normal"><a href="#__codelineno-81-13">13</a></span>
<span class="normal"><a href="#__codelineno-81-14">14</a></span>
<span class="normal"><a href="#__codelineno-81-15">15</a></span>
<span class="normal"><a href="#__codelineno-81-16">16</a></span>
<span class="normal"><a href="#__codelineno-81-17">17</a></span>
<span class="normal"><a href="#__codelineno-81-18">18</a></span>
<span class="normal"><a href="#__codelineno-81-19">19</a></span>
<span class="normal"><a href="#__codelineno-81-20">20</a></span>
<span class="normal"><a href="#__codelineno-81-21">21</a></span>
<span class="normal"><a href="#__codelineno-81-22">22</a></span>
<span class="normal"><a href="#__codelineno-81-23">23</a></span>
<span class="normal"><a href="#__codelineno-81-24">24</a></span>
<span class="normal"><a href="#__codelineno-81-25">25</a></span>
<span class="normal"><a href="#__codelineno-81-26">26</a></span>
<span class="normal"><a href="#__codelineno-81-27">27</a></span>
<span class="normal"><a href="#__codelineno-81-28">28</a></span>
<span class="normal"><a href="#__codelineno-81-29">29</a></span>
<span class="normal"><a href="#__codelineno-81-30">30</a></span>
<span class="normal"><a href="#__codelineno-81-31">31</a></span>
<span class="normal"><a href="#__codelineno-81-32">32</a></span>
<span class="normal"><a href="#__codelineno-81-33">33</a></span>
<span class="normal"><a href="#__codelineno-81-34">34</a></span>
<span class="normal"><a href="#__codelineno-81-35">35</a></span>
<span class="normal"><a href="#__codelineno-81-36">36</a></span>
<span class="normal"><a href="#__codelineno-81-37">37</a></span>
<span class="normal"><a href="#__codelineno-81-38">38</a></span>
<span class="normal"><a href="#__codelineno-81-39">39</a></span>
<span class="normal"><a href="#__codelineno-81-40">40</a></span>
<span class="normal"><a href="#__codelineno-81-41">41</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-81-1"><a id="__codelineno-81-1" name="__codelineno-81-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-81-2"><a id="__codelineno-81-2" name="__codelineno-81-2"></a><span class="w">    </span><span class="s">&quot;context&quot;</span>
</span><span id="__span-81-3"><a id="__codelineno-81-3" name="__codelineno-81-3"></a><span class="w">    </span><span class="s">&quot;fmt&quot;</span>
</span><span id="__span-81-4"><a id="__codelineno-81-4" name="__codelineno-81-4"></a>
</span><span id="__span-81-5"><a id="__codelineno-81-5" name="__codelineno-81-5"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/agent&quot;</span>
</span><span id="__span-81-6"><a id="__codelineno-81-6" name="__codelineno-81-6"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-81-7"><a id="__codelineno-81-7" name="__codelineno-81-7"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/model&quot;</span>
</span><span id="__span-81-8"><a id="__codelineno-81-8" name="__codelineno-81-8"></a><span class="p">)</span>
</span><span id="__span-81-9"><a id="__codelineno-81-9" name="__codelineno-81-9"></a>
</span><span id="__span-81-10"><a id="__codelineno-81-10" name="__codelineno-81-10"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-81-11"><a id="__codelineno-81-11" name="__codelineno-81-11"></a><span class="w">    </span><span class="nx">stateKeyContent</span><span class="w">    </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;content&quot;</span>
</span><span id="__span-81-12"><a id="__codelineno-81-12" name="__codelineno-81-12"></a><span class="w">    </span><span class="nx">stateKeyDecision</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;decision&quot;</span>
</span><span id="__span-81-13"><a id="__codelineno-81-13" name="__codelineno-81-13"></a><span class="w">    </span><span class="nx">interruptKeyReview</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;review_key&quot;</span>
</span><span id="__span-81-14"><a id="__codelineno-81-14" name="__codelineno-81-14"></a><span class="w">    </span><span class="nx">nodeReview</span><span class="w">         </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;review&quot;</span>
</span><span id="__span-81-15"><a id="__codelineno-81-15" name="__codelineno-81-15"></a><span class="p">)</span>
</span><span id="__span-81-16"><a id="__codelineno-81-16" name="__codelineno-81-16"></a>
</span><span id="__span-81-17"><a id="__codelineno-81-17" name="__codelineno-81-17"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="nx">nodeReview</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-81-18"><a id="__codelineno-81-18" name="__codelineno-81-18"></a><span class="w">    </span><span class="nx">content</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">s</span><span class="p">[</span><span class="nx">stateKeyContent</span><span class="p">].(</span><span class="kt">string</span><span class="p">)</span>
</span><span id="__span-81-19"><a id="__codelineno-81-19" name="__codelineno-81-19"></a>
</span><span id="__span-81-20"><a id="__codelineno-81-20" name="__codelineno-81-20"></a><span class="w">    </span><span class="c1">// Interrupt and wait for human input</span>
</span><span id="__span-81-21"><a id="__codelineno-81-21" name="__codelineno-81-21"></a><span class="w">    </span><span class="nx">result</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">Interrupt</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="p">,</span><span class="w"> </span><span class="nx">interruptKeyReview</span><span class="p">,</span>
</span><span id="__span-81-22"><a id="__codelineno-81-22" name="__codelineno-81-22"></a><span class="w">        </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;Please review: %s&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">content</span><span class="p">))</span>
</span><span id="__span-81-23"><a id="__codelineno-81-23" name="__codelineno-81-23"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-81-24"><a id="__codelineno-81-24" name="__codelineno-81-24"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
</span><span id="__span-81-25"><a id="__codelineno-81-25" name="__codelineno-81-25"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-81-26"><a id="__codelineno-81-26" name="__codelineno-81-26"></a>
</span><span id="__span-81-27"><a id="__codelineno-81-27" name="__codelineno-81-27"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="nx">stateKeyDecision</span><span class="p">:</span><span class="w"> </span><span class="nx">result</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-81-28"><a id="__codelineno-81-28" name="__codelineno-81-28"></a><span class="p">})</span>
</span><span id="__span-81-29"><a id="__codelineno-81-29" name="__codelineno-81-29"></a>
</span><span id="__span-81-30"><a id="__codelineno-81-30" name="__codelineno-81-30"></a><span class="c1">// Resume execution (requires the agent package)</span>
</span><span id="__span-81-31"><a id="__codelineno-81-31" name="__codelineno-81-31"></a><span class="nx">cmd</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewResumeCommand</span><span class="p">().</span>
</span><span id="__span-81-32"><a id="__codelineno-81-32" name="__codelineno-81-32"></a><span class="w">    </span><span class="nx">AddResumeValue</span><span class="p">(</span><span class="nx">interruptKeyReview</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;approved&quot;</span><span class="p">)</span>
</span><span id="__span-81-33"><a id="__codelineno-81-33" name="__codelineno-81-33"></a>
</span><span id="__span-81-34"><a id="__codelineno-81-34" name="__codelineno-81-34"></a><span class="nx">eventCh</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">userID</span><span class="p">,</span><span class="w"> </span><span class="nx">sessionID</span><span class="p">,</span>
</span><span id="__span-81-35"><a id="__codelineno-81-35" name="__codelineno-81-35"></a><span class="w">    </span><span class="nx">model</span><span class="p">.</span><span class="nx">NewUserMessage</span><span class="p">(</span><span class="s">&quot;resume&quot;</span><span class="p">),</span>
</span><span id="__span-81-36"><a id="__codelineno-81-36" name="__codelineno-81-36"></a><span class="w">    </span><span class="nx">agent</span><span class="p">.</span><span class="nx">WithRuntimeState</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">any</span><span class="p">{</span>
</span><span id="__span-81-37"><a id="__codelineno-81-37" name="__codelineno-81-37"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">CfgKeyLineageID</span><span class="p">:</span><span class="w">    </span><span class="nx">lineageID</span><span class="p">,</span>
</span><span id="__span-81-38"><a id="__codelineno-81-38" name="__codelineno-81-38"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">CfgKeyCheckpointID</span><span class="p">:</span><span class="w"> </span><span class="nx">checkpointID</span><span class="p">,</span>
</span><span id="__span-81-39"><a id="__codelineno-81-39" name="__codelineno-81-39"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyCommand</span><span class="p">:</span><span class="w">    </span><span class="nx">cmd</span><span class="p">,</span>
</span><span id="__span-81-40"><a id="__codelineno-81-40" name="__codelineno-81-40"></a><span class="w">    </span><span class="p">}),</span>
</span><span id="__span-81-41"><a id="__codelineno-81-41" name="__codelineno-81-41"></a><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<h4 id="nested-graphs-child-graphagent-interrupts">Nested graphs (child GraphAgent interrupts)</h4>
<p>If your parent graph delegates to a child GraphAgent via an agent node
(<code>AddAgentNode</code> / <code>AddSubgraphNode</code>), the child graph can interrupt with
<code>graph.Interrupt</code> and the parent graph will also interrupt.</p>
<p>Resume from the parent checkpoint the same way as a non-nested interrupt.
When the agent node runs again, it will resume the child checkpoint
automatically.</p>
<p>Runnable example: <code>examples/graph/nested_interrupt</code>.</p>
<p>It supports multi-level nesting via the <code>-depth</code> flag.</p>
<p>Key idea: <code>graph.Interrupt(ctx, state, key, prompt)</code> uses <code>key</code> as the routing
key for <code>ResumeMap</code>. When you resume, the map key must match that <code>key</code>.</p>
<p>You will see two different identifiers:</p>
<ul>
<li>Node Identifier (Node ID): where the current graph paused (in nested graphs,
  this is often the parent agent node).</li>
<li>Task Identifier (Task ID): the interrupt key used for <code>ResumeMap</code> routing.
  For <code>graph.Interrupt</code>, Task ID equals the <code>key</code> argument.</li>
</ul>
<p>To resume without hard-coding the key, read the Task ID from the interrupted
checkpoint and use it as the <code>ResumeMap</code> key:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-82-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-82-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-82-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-82-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-82-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-82-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-82-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-82-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-82-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-82-10">10</a></span>
<span class="normal"><a href="#__codelineno-82-11">11</a></span>
<span class="normal"><a href="#__codelineno-82-12">12</a></span>
<span class="normal"><a href="#__codelineno-82-13">13</a></span>
<span class="normal"><a href="#__codelineno-82-14">14</a></span>
<span class="normal"><a href="#__codelineno-82-15">15</a></span>
<span class="normal"><a href="#__codelineno-82-16">16</a></span>
<span class="normal"><a href="#__codelineno-82-17">17</a></span>
<span class="normal"><a href="#__codelineno-82-18">18</a></span>
<span class="normal"><a href="#__codelineno-82-19">19</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-82-1"><a id="__codelineno-82-1" name="__codelineno-82-1"></a><span class="c1">// cm is a graph.CheckpointManager. If you&#39;re using GraphAgent, you can get it</span>
</span><span id="__span-82-2"><a id="__codelineno-82-2" name="__codelineno-82-2"></a><span class="c1">// from ga.Executor().CheckpointManager().</span>
</span><span id="__span-82-3"><a id="__codelineno-82-3" name="__codelineno-82-3"></a><span class="nx">latest</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">cm</span><span class="p">.</span><span class="nx">Latest</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">lineageID</span><span class="p">,</span><span class="w"> </span><span class="nx">namespace</span><span class="p">)</span>
</span><span id="__span-82-4"><a id="__codelineno-82-4" name="__codelineno-82-4"></a><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">latest</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">latest</span><span class="p">.</span><span class="nx">Checkpoint</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-82-5"><a id="__codelineno-82-5" name="__codelineno-82-5"></a><span class="w">    </span><span class="c1">// handle error</span>
</span><span id="__span-82-6"><a id="__codelineno-82-6" name="__codelineno-82-6"></a><span class="p">}</span>
</span><span id="__span-82-7"><a id="__codelineno-82-7" name="__codelineno-82-7"></a><span class="nx">taskID</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">latest</span><span class="p">.</span><span class="nx">Checkpoint</span><span class="p">.</span><span class="nx">InterruptState</span><span class="p">.</span><span class="nx">TaskID</span>
</span><span id="__span-82-8"><a id="__codelineno-82-8" name="__codelineno-82-8"></a>
</span><span id="__span-82-9"><a id="__codelineno-82-9" name="__codelineno-82-9"></a><span class="nx">cmd</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewResumeCommand</span><span class="p">().</span>
</span><span id="__span-82-10"><a id="__codelineno-82-10" name="__codelineno-82-10"></a><span class="w">    </span><span class="nx">AddResumeValue</span><span class="p">(</span><span class="nx">taskID</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;approved&quot;</span><span class="p">)</span>
</span><span id="__span-82-11"><a id="__codelineno-82-11" name="__codelineno-82-11"></a>
</span><span id="__span-82-12"><a id="__codelineno-82-12" name="__codelineno-82-12"></a><span class="nx">eventCh</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">userID</span><span class="p">,</span><span class="w"> </span><span class="nx">sessionID</span><span class="p">,</span>
</span><span id="__span-82-13"><a id="__codelineno-82-13" name="__codelineno-82-13"></a><span class="w">    </span><span class="nx">model</span><span class="p">.</span><span class="nx">NewUserMessage</span><span class="p">(</span><span class="s">&quot;resume&quot;</span><span class="p">),</span>
</span><span id="__span-82-14"><a id="__codelineno-82-14" name="__codelineno-82-14"></a><span class="w">    </span><span class="nx">agent</span><span class="p">.</span><span class="nx">WithRuntimeState</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">any</span><span class="p">{</span>
</span><span id="__span-82-15"><a id="__codelineno-82-15" name="__codelineno-82-15"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">CfgKeyLineageID</span><span class="p">:</span><span class="w">    </span><span class="nx">lineageID</span><span class="p">,</span>
</span><span id="__span-82-16"><a id="__codelineno-82-16" name="__codelineno-82-16"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">CfgKeyCheckpointID</span><span class="p">:</span><span class="w"> </span><span class="nx">latest</span><span class="p">.</span><span class="nx">Checkpoint</span><span class="p">.</span><span class="nx">ID</span><span class="p">,</span>
</span><span id="__span-82-17"><a id="__codelineno-82-17" name="__codelineno-82-17"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyCommand</span><span class="p">:</span><span class="w">    </span><span class="nx">cmd</span><span class="p">,</span>
</span><span id="__span-82-18"><a id="__codelineno-82-18" name="__codelineno-82-18"></a><span class="w">    </span><span class="p">}),</span>
</span><span id="__span-82-19"><a id="__codelineno-82-19" name="__codelineno-82-19"></a><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>This works the same for multi-level nesting: resume from the parent checkpoint
and the framework will resume each child checkpoint automatically.</p>
<p>Helpers:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-83-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-83-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-83-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-83-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-83-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-83-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-83-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-83-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-83-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-83-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-83-1"><a id="__codelineno-83-1" name="__codelineno-83-1"></a><span class="c1">// Typed resume value</span>
</span><span id="__span-83-2"><a id="__codelineno-83-2" name="__codelineno-83-2"></a><span class="k">if</span><span class="w"> </span><span class="nx">v</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">ResumeValue</span><span class="p">[</span><span class="kt">string</span><span class="p">](</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;approval&quot;</span><span class="p">);</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* use v */</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-83-3"><a id="__codelineno-83-3" name="__codelineno-83-3"></a>
</span><span id="__span-83-4"><a id="__codelineno-83-4" name="__codelineno-83-4"></a><span class="c1">// With default</span>
</span><span id="__span-83-5"><a id="__codelineno-83-5" name="__codelineno-83-5"></a><span class="nx">v</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">ResumeValueOrDefault</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;approval&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;no&quot;</span><span class="p">)</span>
</span><span id="__span-83-6"><a id="__codelineno-83-6" name="__codelineno-83-6"></a>
</span><span id="__span-83-7"><a id="__codelineno-83-7" name="__codelineno-83-7"></a><span class="c1">// Check / clear</span>
</span><span id="__span-83-8"><a id="__codelineno-83-8" name="__codelineno-83-8"></a><span class="nx">_</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">HasResumeValue</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;approval&quot;</span><span class="p">)</span>
</span><span id="__span-83-9"><a id="__codelineno-83-9" name="__codelineno-83-9"></a><span class="nx">graph</span><span class="p">.</span><span class="nx">ClearResumeValue</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;approval&quot;</span><span class="p">)</span>
</span><span id="__span-83-10"><a id="__codelineno-83-10" name="__codelineno-83-10"></a><span class="nx">graph</span><span class="p">.</span><span class="nx">ClearAllResumeValues</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>You can also inject resume values at entry via a command (no need to jump to a specific node first). Pass it via Runner runtime state:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-84-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-84-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-84-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-84-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-84-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-84-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-84-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-84-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-84-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-84-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-84-1"><a id="__codelineno-84-1" name="__codelineno-84-1"></a><span class="nx">cmd</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewResumeCommand</span><span class="p">().</span>
</span><span id="__span-84-2"><a id="__codelineno-84-2" name="__codelineno-84-2"></a><span class="w">    </span><span class="nx">WithResumeMap</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">any</span><span class="p">{</span><span class="s">&quot;approval&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span><span class="p">})</span>
</span><span id="__span-84-3"><a id="__codelineno-84-3" name="__codelineno-84-3"></a>
</span><span id="__span-84-4"><a id="__codelineno-84-4" name="__codelineno-84-4"></a><span class="c1">// Inject __command__ into initial state via RuntimeState</span>
</span><span id="__span-84-5"><a id="__codelineno-84-5" name="__codelineno-84-5"></a><span class="nx">eventCh</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">userID</span><span class="p">,</span><span class="w"> </span><span class="nx">sessionID</span><span class="p">,</span>
</span><span id="__span-84-6"><a id="__codelineno-84-6" name="__codelineno-84-6"></a><span class="w">    </span><span class="nx">model</span><span class="p">.</span><span class="nx">NewUserMessage</span><span class="p">(</span><span class="s">&quot;resume&quot;</span><span class="p">),</span>
</span><span id="__span-84-7"><a id="__codelineno-84-7" name="__codelineno-84-7"></a><span class="w">    </span><span class="nx">agent</span><span class="p">.</span><span class="nx">WithRuntimeState</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">any</span><span class="p">{</span>
</span><span id="__span-84-8"><a id="__codelineno-84-8" name="__codelineno-84-8"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyCommand</span><span class="p">:</span><span class="w"> </span><span class="nx">cmd</span><span class="p">,</span>
</span><span id="__span-84-9"><a id="__codelineno-84-9" name="__codelineno-84-9"></a><span class="w">    </span><span class="p">}),</span>
</span><span id="__span-84-10"><a id="__codelineno-84-10" name="__codelineno-84-10"></a><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="event-monitoring">Event Monitoring</h3>
<p>The event stream carries execution progress and incremental outputs. The example shows how to iterate events and distinguish graph events vs model deltas:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-85-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-85-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-85-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-85-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-85-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-85-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-85-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-85-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-85-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-85-10">10</a></span>
<span class="normal"><a href="#__codelineno-85-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-85-1"><a id="__codelineno-85-1" name="__codelineno-85-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-85-2"><a id="__codelineno-85-2" name="__codelineno-85-2"></a><span class="w">    </span><span class="s">&quot;fmt&quot;</span>
</span><span id="__span-85-3"><a id="__codelineno-85-3" name="__codelineno-85-3"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-85-4"><a id="__codelineno-85-4" name="__codelineno-85-4"></a><span class="p">)</span>
</span><span id="__span-85-5"><a id="__codelineno-85-5" name="__codelineno-85-5"></a>
</span><span id="__span-85-6"><a id="__codelineno-85-6" name="__codelineno-85-6"></a><span class="k">for</span><span class="w"> </span><span class="nx">ev</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">eventCh</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-85-7"><a id="__codelineno-85-7" name="__codelineno-85-7"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">ev</span><span class="p">.</span><span class="nx">Response</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-85-8"><a id="__codelineno-85-8" name="__codelineno-85-8"></a><span class="w">        </span><span class="k">continue</span>
</span><span id="__span-85-9"><a id="__codelineno-85-9" name="__codelineno-85-9"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-85-10"><a id="__codelineno-85-10" name="__codelineno-85-10"></a><span class="w">    </span><span class="c1">// ... your handling here</span>
</span><span id="__span-85-11"><a id="__codelineno-85-11" name="__codelineno-85-11"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>You can also filter by the event's <code>Author</code> field:</p>
<ul>
<li>Node‑level events (model, tools, node start/stop): <code>Author = &lt;nodeID&gt;</code> (or <code>graph-node</code> if unavailable)</li>
<li>Pregel (planning/execution/update/errors): <code>Author = graph.AuthorGraphPregel</code></li>
<li>Executor‑level (state updates/checkpoints): <code>Author = graph.AuthorGraphExecutor</code></li>
<li>User input (Runner writes): <code>Author = user</code></li>
</ul>
<p>This convention lets you subscribe to a specific node's stream without passing streaming context through nodes (streaming travels via the event channel; state stays structured in a LangGraph‑like style).</p>
<p>Example: consume only node <code>ask</code>'s streaming output and print the final message when done.</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-86-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-86-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-86-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-86-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-86-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-86-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-86-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-86-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-86-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-86-10">10</a></span>
<span class="normal"><a href="#__codelineno-86-11">11</a></span>
<span class="normal"><a href="#__codelineno-86-12">12</a></span>
<span class="normal"><a href="#__codelineno-86-13">13</a></span>
<span class="normal"><a href="#__codelineno-86-14">14</a></span>
<span class="normal"><a href="#__codelineno-86-15">15</a></span>
<span class="normal"><a href="#__codelineno-86-16">16</a></span>
<span class="normal"><a href="#__codelineno-86-17">17</a></span>
<span class="normal"><a href="#__codelineno-86-18">18</a></span>
<span class="normal"><a href="#__codelineno-86-19">19</a></span>
<span class="normal"><a href="#__codelineno-86-20">20</a></span>
<span class="normal"><a href="#__codelineno-86-21">21</a></span>
<span class="normal"><a href="#__codelineno-86-22">22</a></span>
<span class="normal"><a href="#__codelineno-86-23">23</a></span>
<span class="normal"><a href="#__codelineno-86-24">24</a></span>
<span class="normal"><a href="#__codelineno-86-25">25</a></span>
<span class="normal"><a href="#__codelineno-86-26">26</a></span>
<span class="normal"><a href="#__codelineno-86-27">27</a></span>
<span class="normal"><a href="#__codelineno-86-28">28</a></span>
<span class="normal"><a href="#__codelineno-86-29">29</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-86-1"><a id="__codelineno-86-1" name="__codelineno-86-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-86-2"><a id="__codelineno-86-2" name="__codelineno-86-2"></a><span class="w">    </span><span class="s">&quot;fmt&quot;</span>
</span><span id="__span-86-3"><a id="__codelineno-86-3" name="__codelineno-86-3"></a>
</span><span id="__span-86-4"><a id="__codelineno-86-4" name="__codelineno-86-4"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-86-5"><a id="__codelineno-86-5" name="__codelineno-86-5"></a><span class="p">)</span>
</span><span id="__span-86-6"><a id="__codelineno-86-6" name="__codelineno-86-6"></a>
</span><span id="__span-86-7"><a id="__codelineno-86-7" name="__codelineno-86-7"></a><span class="kd">const</span><span class="w"> </span><span class="nx">nodeIDWatch</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;ask&quot;</span>
</span><span id="__span-86-8"><a id="__codelineno-86-8" name="__codelineno-86-8"></a>
</span><span id="__span-86-9"><a id="__codelineno-86-9" name="__codelineno-86-9"></a><span class="k">for</span><span class="w"> </span><span class="nx">ev</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">eventCh</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-86-10"><a id="__codelineno-86-10" name="__codelineno-86-10"></a><span class="w">    </span><span class="c1">// Only care about events from the watched node</span>
</span><span id="__span-86-11"><a id="__codelineno-86-11" name="__codelineno-86-11"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">ev</span><span class="p">.</span><span class="nx">Author</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">nodeIDWatch</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-86-12"><a id="__codelineno-86-12" name="__codelineno-86-12"></a><span class="w">        </span><span class="k">continue</span>
</span><span id="__span-86-13"><a id="__codelineno-86-13" name="__codelineno-86-13"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-86-14"><a id="__codelineno-86-14" name="__codelineno-86-14"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">ev</span><span class="p">.</span><span class="nx">Response</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">ev</span><span class="p">.</span><span class="nx">Response</span><span class="p">.</span><span class="nx">Choices</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-86-15"><a id="__codelineno-86-15" name="__codelineno-86-15"></a><span class="w">        </span><span class="k">continue</span>
</span><span id="__span-86-16"><a id="__codelineno-86-16" name="__codelineno-86-16"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-86-17"><a id="__codelineno-86-17" name="__codelineno-86-17"></a><span class="w">    </span><span class="nx">choice</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">ev</span><span class="p">.</span><span class="nx">Response</span><span class="p">.</span><span class="nx">Choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="__span-86-18"><a id="__codelineno-86-18" name="__codelineno-86-18"></a>
</span><span id="__span-86-19"><a id="__codelineno-86-19" name="__codelineno-86-19"></a><span class="w">    </span><span class="c1">// Streaming deltas</span>
</span><span id="__span-86-20"><a id="__codelineno-86-20" name="__codelineno-86-20"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">ev</span><span class="p">.</span><span class="nx">Response</span><span class="p">.</span><span class="nx">IsPartial</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">choice</span><span class="p">.</span><span class="nx">Delta</span><span class="p">.</span><span class="nx">Content</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-86-21"><a id="__codelineno-86-21" name="__codelineno-86-21"></a><span class="w">        </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Print</span><span class="p">(</span><span class="nx">choice</span><span class="p">.</span><span class="nx">Delta</span><span class="p">.</span><span class="nx">Content</span><span class="p">)</span>
</span><span id="__span-86-22"><a id="__codelineno-86-22" name="__codelineno-86-22"></a><span class="w">        </span><span class="k">continue</span>
</span><span id="__span-86-23"><a id="__codelineno-86-23" name="__codelineno-86-23"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-86-24"><a id="__codelineno-86-24" name="__codelineno-86-24"></a>
</span><span id="__span-86-25"><a id="__codelineno-86-25" name="__codelineno-86-25"></a><span class="w">    </span><span class="c1">// Final full message</span>
</span><span id="__span-86-26"><a id="__codelineno-86-26" name="__codelineno-86-26"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">!</span><span class="nx">ev</span><span class="p">.</span><span class="nx">Response</span><span class="p">.</span><span class="nx">IsPartial</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">choice</span><span class="p">.</span><span class="nx">Message</span><span class="p">.</span><span class="nx">Content</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-86-27"><a id="__codelineno-86-27" name="__codelineno-86-27"></a><span class="w">        </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;\n[ask] final output:&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">choice</span><span class="p">.</span><span class="nx">Message</span><span class="p">.</span><span class="nx">Content</span><span class="p">)</span>
</span><span id="__span-86-28"><a id="__codelineno-86-28" name="__codelineno-86-28"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-86-29"><a id="__codelineno-86-29" name="__codelineno-86-29"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<h4 id="streammode">StreamMode</h4>
<p>Runner can filter the event stream before it reaches your application code.
This is useful when you only want a subset of events (for example, only model
tokens for user interface streaming).</p>
<p>Use <code>agent.WithStreamMode(...)</code>:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-87-1">1</a></span>
<span class="normal"><a href="#__codelineno-87-2">2</a></span>
<span class="normal"><a href="#__codelineno-87-3">3</a></span>
<span class="normal"><a href="#__codelineno-87-4">4</a></span>
<span class="normal"><a href="#__codelineno-87-5">5</a></span>
<span class="normal"><a href="#__codelineno-87-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-87-1"><a id="__codelineno-87-1" name="__codelineno-87-1"></a><span class="nx">eventCh</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">userID</span><span class="p">,</span><span class="w"> </span><span class="nx">sessionID</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="p">,</span>
</span><span id="__span-87-2"><a id="__codelineno-87-2" name="__codelineno-87-2"></a><span class="w">    </span><span class="nx">agent</span><span class="p">.</span><span class="nx">WithStreamMode</span><span class="p">(</span>
</span><span id="__span-87-3"><a id="__codelineno-87-3" name="__codelineno-87-3"></a><span class="w">        </span><span class="nx">agent</span><span class="p">.</span><span class="nx">StreamModeMessages</span><span class="p">,</span>
</span><span id="__span-87-4"><a id="__codelineno-87-4" name="__codelineno-87-4"></a><span class="w">        </span><span class="nx">agent</span><span class="p">.</span><span class="nx">StreamModeCustom</span><span class="p">,</span>
</span><span id="__span-87-5"><a id="__codelineno-87-5" name="__codelineno-87-5"></a><span class="w">    </span><span class="p">),</span>
</span><span id="__span-87-6"><a id="__codelineno-87-6" name="__codelineno-87-6"></a><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>Supported modes (graph workflows):</p>
<ul>
<li><code>messages</code>: model output events (for example, <code>chat.completion.chunk</code>)</li>
<li><code>updates</code>: <code>graph.state.update</code> / <code>graph.channel.update</code> / <code>graph.execution</code></li>
<li><code>checkpoints</code>: <code>graph.checkpoint.*</code></li>
<li><code>tasks</code>: task lifecycle events (<code>graph.node.*</code>, <code>graph.pregel.*</code>)</li>
<li><code>debug</code>: same as <code>checkpoints</code> + <code>tasks</code></li>
<li><code>custom</code>: node-emitted events (<code>graph.node.custom</code>)</li>
</ul>
<p>Notes:</p>
<ul>
<li>When <code>agent.StreamModeMessages</code> is selected, graph-based Large Language Model
  (LLM) nodes enable final model response events automatically for that run.
  To override it, call <code>agent.WithGraphEmitFinalModelResponses(false)</code> after
  <code>agent.WithStreamMode(...)</code>.</li>
<li>StreamMode only affects what Runner forwards to your <code>eventCh</code>. Runner still
  processes and persists events internally.</li>
<li>For graph workflows, some event types (for example, <code>graph.checkpoint.*</code>)
  are emitted only when their corresponding mode is selected.</li>
<li>Runner always emits a final <code>runner.completion</code> event.</li>
</ul>
<h4 id="event-metadata-statedelta">Event Metadata (StateDelta)</h4>
<p>Each event also carries <code>StateDelta</code>, which includes execution metadata for models/tools:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-88-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-88-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-88-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-88-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-88-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-88-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-88-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-88-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-88-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-88-10">10</a></span>
<span class="normal"><a href="#__codelineno-88-11">11</a></span>
<span class="normal"><a href="#__codelineno-88-12">12</a></span>
<span class="normal"><a href="#__codelineno-88-13">13</a></span>
<span class="normal"><a href="#__codelineno-88-14">14</a></span>
<span class="normal"><a href="#__codelineno-88-15">15</a></span>
<span class="normal"><a href="#__codelineno-88-16">16</a></span>
<span class="normal"><a href="#__codelineno-88-17">17</a></span>
<span class="normal"><a href="#__codelineno-88-18">18</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-88-1"><a id="__codelineno-88-1" name="__codelineno-88-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-88-2"><a id="__codelineno-88-2" name="__codelineno-88-2"></a><span class="w">    </span><span class="s">&quot;encoding/json&quot;</span>
</span><span id="__span-88-3"><a id="__codelineno-88-3" name="__codelineno-88-3"></a>
</span><span id="__span-88-4"><a id="__codelineno-88-4" name="__codelineno-88-4"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-88-5"><a id="__codelineno-88-5" name="__codelineno-88-5"></a><span class="p">)</span>
</span><span id="__span-88-6"><a id="__codelineno-88-6" name="__codelineno-88-6"></a>
</span><span id="__span-88-7"><a id="__codelineno-88-7" name="__codelineno-88-7"></a><span class="k">for</span><span class="w"> </span><span class="nx">ev</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">events</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-88-8"><a id="__codelineno-88-8" name="__codelineno-88-8"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">ev</span><span class="p">.</span><span class="nx">StateDelta</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">continue</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-88-9"><a id="__codelineno-88-9" name="__codelineno-88-9"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">ev</span><span class="p">.</span><span class="nx">StateDelta</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">MetadataKeyModel</span><span class="p">];</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-88-10"><a id="__codelineno-88-10" name="__codelineno-88-10"></a><span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="nx">md</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">ModelExecutionMetadata</span>
</span><span id="__span-88-11"><a id="__codelineno-88-11" name="__codelineno-88-11"></a><span class="w">        </span><span class="nx">_</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">json</span><span class="p">.</span><span class="nx">Unmarshal</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">md</span><span class="p">)</span>
</span><span id="__span-88-12"><a id="__codelineno-88-12" name="__codelineno-88-12"></a><span class="w">        </span><span class="c1">// md.Input / md.Output / md.Duration</span>
</span><span id="__span-88-13"><a id="__codelineno-88-13" name="__codelineno-88-13"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-88-14"><a id="__codelineno-88-14" name="__codelineno-88-14"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">ev</span><span class="p">.</span><span class="nx">StateDelta</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">MetadataKeyTool</span><span class="p">];</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-88-15"><a id="__codelineno-88-15" name="__codelineno-88-15"></a><span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="nx">td</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">ToolExecutionMetadata</span>
</span><span id="__span-88-16"><a id="__codelineno-88-16" name="__codelineno-88-16"></a><span class="w">        </span><span class="nx">_</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">json</span><span class="p">.</span><span class="nx">Unmarshal</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">td</span><span class="p">)</span>
</span><span id="__span-88-17"><a id="__codelineno-88-17" name="__codelineno-88-17"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-88-18"><a id="__codelineno-88-18" name="__codelineno-88-18"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<h4 id="emit-selected-values-from-node-callbacks">Emit selected values from node callbacks</h4>
<p>By default, mid‑run events like <code>graph.state.update</code> report which keys were updated (metadata‑only). Concrete values are not included to keep the stream lightweight and avoid exposing intermediate, potentially conflicting updates. The final <code>graph.execution</code> event's <code>StateDelta</code> carries the serialized final snapshot of allowed keys (see implementations in <a href="https://github.com/trpc-group/trpc-agent-go/blob/main/graph/executor.go#L2001">graph/executor.go:2001</a>, <a href="https://github.com/trpc-group/trpc-agent-go/blob/main/graph/events.go#L1276">graph/events.go:1276</a>, <a href="https://github.com/trpc-group/trpc-agent-go/blob/main/graph/events.go#L1330">graph/events.go:1330</a>).</p>
<p>If you only need to surface a few values from the result of a specific node right after it completes, register an After‑node callback and emit a small custom event containing just those values:</p>
<p>Steps:</p>
<ul>
<li>Register <code>WithPostNodeCallback</code> on the target node.</li>
<li>In the callback, read <code>result any</code>; when the node returns <code>graph.State</code>, this is the node's state delta.</li>
<li>Pick the needed keys, serialize to JSON, attach to a new event's <code>StateDelta</code>.</li>
<li>Send via <code>agent.EmitEvent</code>.</li>
</ul>
<p>Example:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-89-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-89-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-89-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-89-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-89-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-89-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-89-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-89-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-89-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-89-10">10</a></span>
<span class="normal"><a href="#__codelineno-89-11">11</a></span>
<span class="normal"><a href="#__codelineno-89-12">12</a></span>
<span class="normal"><a href="#__codelineno-89-13">13</a></span>
<span class="normal"><a href="#__codelineno-89-14">14</a></span>
<span class="normal"><a href="#__codelineno-89-15">15</a></span>
<span class="normal"><a href="#__codelineno-89-16">16</a></span>
<span class="normal"><a href="#__codelineno-89-17">17</a></span>
<span class="normal"><a href="#__codelineno-89-18">18</a></span>
<span class="normal"><a href="#__codelineno-89-19">19</a></span>
<span class="normal"><a href="#__codelineno-89-20">20</a></span>
<span class="normal"><a href="#__codelineno-89-21">21</a></span>
<span class="normal"><a href="#__codelineno-89-22">22</a></span>
<span class="normal"><a href="#__codelineno-89-23">23</a></span>
<span class="normal"><a href="#__codelineno-89-24">24</a></span>
<span class="normal"><a href="#__codelineno-89-25">25</a></span>
<span class="normal"><a href="#__codelineno-89-26">26</a></span>
<span class="normal"><a href="#__codelineno-89-27">27</a></span>
<span class="normal"><a href="#__codelineno-89-28">28</a></span>
<span class="normal"><a href="#__codelineno-89-29">29</a></span>
<span class="normal"><a href="#__codelineno-89-30">30</a></span>
<span class="normal"><a href="#__codelineno-89-31">31</a></span>
<span class="normal"><a href="#__codelineno-89-32">32</a></span>
<span class="normal"><a href="#__codelineno-89-33">33</a></span>
<span class="normal"><a href="#__codelineno-89-34">34</a></span>
<span class="normal"><a href="#__codelineno-89-35">35</a></span>
<span class="normal"><a href="#__codelineno-89-36">36</a></span>
<span class="normal"><a href="#__codelineno-89-37">37</a></span>
<span class="normal"><a href="#__codelineno-89-38">38</a></span>
<span class="normal"><a href="#__codelineno-89-39">39</a></span>
<span class="normal"><a href="#__codelineno-89-40">40</a></span>
<span class="normal"><a href="#__codelineno-89-41">41</a></span>
<span class="normal"><a href="#__codelineno-89-42">42</a></span>
<span class="normal"><a href="#__codelineno-89-43">43</a></span>
<span class="normal"><a href="#__codelineno-89-44">44</a></span>
<span class="normal"><a href="#__codelineno-89-45">45</a></span>
<span class="normal"><a href="#__codelineno-89-46">46</a></span>
<span class="normal"><a href="#__codelineno-89-47">47</a></span>
<span class="normal"><a href="#__codelineno-89-48">48</a></span>
<span class="normal"><a href="#__codelineno-89-49">49</a></span>
<span class="normal"><a href="#__codelineno-89-50">50</a></span>
<span class="normal"><a href="#__codelineno-89-51">51</a></span>
<span class="normal"><a href="#__codelineno-89-52">52</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-89-1"><a id="__codelineno-89-1" name="__codelineno-89-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-89-2"><a id="__codelineno-89-2" name="__codelineno-89-2"></a><span class="w">    </span><span class="s">&quot;context&quot;</span>
</span><span id="__span-89-3"><a id="__codelineno-89-3" name="__codelineno-89-3"></a><span class="w">    </span><span class="s">&quot;encoding/json&quot;</span>
</span><span id="__span-89-4"><a id="__codelineno-89-4" name="__codelineno-89-4"></a>
</span><span id="__span-89-5"><a id="__codelineno-89-5" name="__codelineno-89-5"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/agent&quot;</span>
</span><span id="__span-89-6"><a id="__codelineno-89-6" name="__codelineno-89-6"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-89-7"><a id="__codelineno-89-7" name="__codelineno-89-7"></a><span class="p">)</span>
</span><span id="__span-89-8"><a id="__codelineno-89-8" name="__codelineno-89-8"></a>
</span><span id="__span-89-9"><a id="__codelineno-89-9" name="__codelineno-89-9"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-89-10"><a id="__codelineno-89-10" name="__codelineno-89-10"></a><span class="w">    </span><span class="nx">nodeParse</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;parse&quot;</span>
</span><span id="__span-89-11"><a id="__codelineno-89-11" name="__codelineno-89-11"></a><span class="w">    </span><span class="nx">stateKeyOut</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;parsed_value&quot;</span><span class="w"> </span><span class="c1">// emit only what upstream needs</span>
</span><span id="__span-89-12"><a id="__codelineno-89-12" name="__codelineno-89-12"></a><span class="p">)</span>
</span><span id="__span-89-13"><a id="__codelineno-89-13" name="__codelineno-89-13"></a>
</span><span id="__span-89-14"><a id="__codelineno-89-14" name="__codelineno-89-14"></a><span class="kd">func</span><span class="w"> </span><span class="nx">parseNode</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-89-15"><a id="__codelineno-89-15" name="__codelineno-89-15"></a><span class="w">    </span><span class="nx">val</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">any</span><span class="p">{</span><span class="s">&quot;ok&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;score&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.97</span><span class="p">}</span>
</span><span id="__span-89-16"><a id="__codelineno-89-16" name="__codelineno-89-16"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="nx">stateKeyOut</span><span class="p">:</span><span class="w"> </span><span class="nx">val</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-89-17"><a id="__codelineno-89-17" name="__codelineno-89-17"></a><span class="p">}</span>
</span><span id="__span-89-18"><a id="__codelineno-89-18" name="__codelineno-89-18"></a>
</span><span id="__span-89-19"><a id="__codelineno-89-19" name="__codelineno-89-19"></a><span class="kd">func</span><span class="w"> </span><span class="nx">buildGraph</span><span class="p">()</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">graph</span><span class="p">.</span><span class="nx">Graph</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-89-20"><a id="__codelineno-89-20" name="__codelineno-89-20"></a><span class="w">    </span><span class="nx">sg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateGraph</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">MessagesStateSchema</span><span class="p">())</span>
</span><span id="__span-89-21"><a id="__codelineno-89-21" name="__codelineno-89-21"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="nx">nodeParse</span><span class="p">,</span><span class="w"> </span><span class="nx">parseNode</span><span class="p">,</span>
</span><span id="__span-89-22"><a id="__codelineno-89-22" name="__codelineno-89-22"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithPostNodeCallback</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span>
</span><span id="__span-89-23"><a id="__codelineno-89-23" name="__codelineno-89-23"></a><span class="w">            </span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span>
</span><span id="__span-89-24"><a id="__codelineno-89-24" name="__codelineno-89-24"></a><span class="w">            </span><span class="nx">cb</span><span class="w"> </span><span class="o">*</span><span class="nx">graph</span><span class="p">.</span><span class="nx">NodeCallbackContext</span><span class="p">,</span>
</span><span id="__span-89-25"><a id="__codelineno-89-25" name="__codelineno-89-25"></a><span class="w">            </span><span class="nx">st</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">,</span>
</span><span id="__span-89-26"><a id="__codelineno-89-26" name="__codelineno-89-26"></a><span class="w">            </span><span class="nx">result</span><span class="w"> </span><span class="kt">any</span><span class="p">,</span>
</span><span id="__span-89-27"><a id="__codelineno-89-27" name="__codelineno-89-27"></a><span class="w">            </span><span class="nx">nodeErr</span><span class="w"> </span><span class="kt">error</span><span class="p">,</span>
</span><span id="__span-89-28"><a id="__codelineno-89-28" name="__codelineno-89-28"></a><span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-89-29"><a id="__codelineno-89-29" name="__codelineno-89-29"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">nodeErr</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-89-30"><a id="__codelineno-89-30" name="__codelineno-89-30"></a><span class="w">            </span><span class="nx">inv</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">agent</span><span class="p">.</span><span class="nx">InvocationFromContext</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</span><span id="__span-89-31"><a id="__codelineno-89-31" name="__codelineno-89-31"></a><span class="w">            </span><span class="nx">execCtx</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">st</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyExecContext</span><span class="p">].(</span><span class="o">*</span><span class="nx">graph</span><span class="p">.</span><span class="nx">ExecutionContext</span><span class="p">)</span>
</span><span id="__span-89-32"><a id="__codelineno-89-32" name="__codelineno-89-32"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">delta</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">result</span><span class="p">.(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">);</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-89-33"><a id="__codelineno-89-33" name="__codelineno-89-33"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="nx">v</span><span class="p">,</span><span class="w"> </span><span class="nx">exists</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">delta</span><span class="p">[</span><span class="nx">stateKeyOut</span><span class="p">];</span><span class="w"> </span><span class="nx">exists</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">execCtx</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-89-34"><a id="__codelineno-89-34" name="__codelineno-89-34"></a><span class="w">                    </span><span class="nx">evt</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewGraphEvent</span><span class="p">(</span>
</span><span id="__span-89-35"><a id="__codelineno-89-35" name="__codelineno-89-35"></a><span class="w">                        </span><span class="nx">inv</span><span class="p">.</span><span class="nx">InvocationID</span><span class="p">,</span>
</span><span id="__span-89-36"><a id="__codelineno-89-36" name="__codelineno-89-36"></a><span class="w">                        </span><span class="nx">cb</span><span class="p">.</span><span class="nx">NodeID</span><span class="p">,</span><span class="w"> </span><span class="c1">// author = node id for easy filtering</span>
</span><span id="__span-89-37"><a id="__codelineno-89-37" name="__codelineno-89-37"></a><span class="w">                        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">ObjectTypeGraphNodeExecution</span><span class="p">,</span>
</span><span id="__span-89-38"><a id="__codelineno-89-38" name="__codelineno-89-38"></a><span class="w">                    </span><span class="p">)</span>
</span><span id="__span-89-39"><a id="__codelineno-89-39" name="__codelineno-89-39"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="nx">evt</span><span class="p">.</span><span class="nx">StateDelta</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">evt</span><span class="p">.</span><span class="nx">StateDelta</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">][]</span><span class="kt">byte</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-89-40"><a id="__codelineno-89-40" name="__codelineno-89-40"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">json</span><span class="p">.</span><span class="nx">Marshal</span><span class="p">(</span><span class="nx">v</span><span class="p">);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-89-41"><a id="__codelineno-89-41" name="__codelineno-89-41"></a><span class="w">                        </span><span class="nx">evt</span><span class="p">.</span><span class="nx">StateDelta</span><span class="p">[</span><span class="nx">stateKeyOut</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">b</span>
</span><span id="__span-89-42"><a id="__codelineno-89-42" name="__codelineno-89-42"></a><span class="w">                        </span><span class="nx">_</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">agent</span><span class="p">.</span><span class="nx">EmitEvent</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">inv</span><span class="p">,</span><span class="w"> </span><span class="nx">execCtx</span><span class="p">.</span><span class="nx">EventChan</span><span class="p">,</span><span class="w"> </span><span class="nx">evt</span><span class="p">)</span>
</span><span id="__span-89-43"><a id="__codelineno-89-43" name="__codelineno-89-43"></a><span class="w">                    </span><span class="p">}</span>
</span><span id="__span-89-44"><a id="__codelineno-89-44" name="__codelineno-89-44"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-89-45"><a id="__codelineno-89-45" name="__codelineno-89-45"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-89-46"><a id="__codelineno-89-46" name="__codelineno-89-46"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-89-47"><a id="__codelineno-89-47" name="__codelineno-89-47"></a><span class="w">        </span><span class="p">}),</span>
</span><span id="__span-89-48"><a id="__codelineno-89-48" name="__codelineno-89-48"></a><span class="w">    </span><span class="p">).</span>
</span><span id="__span-89-49"><a id="__codelineno-89-49" name="__codelineno-89-49"></a><span class="w">        </span><span class="nx">SetEntryPoint</span><span class="p">(</span><span class="nx">nodeParse</span><span class="p">).</span>
</span><span id="__span-89-50"><a id="__codelineno-89-50" name="__codelineno-89-50"></a><span class="w">        </span><span class="nx">SetFinishPoint</span><span class="p">(</span><span class="nx">nodeParse</span><span class="p">)</span>
</span><span id="__span-89-51"><a id="__codelineno-89-51" name="__codelineno-89-51"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">sg</span><span class="p">.</span><span class="nx">Compile</span><span class="p">()</span>
</span><span id="__span-89-52"><a id="__codelineno-89-52" name="__codelineno-89-52"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>Recommendations:</p>
<ul>
<li>Emit only necessary keys to control bandwidth and avoid leaking sensitive data.</li>
<li>Internal/volatile keys are filtered from final snapshots and should not be emitted (see <a href="https://github.com/trpc-group/trpc-agent-go/blob/main/graph/internal_keys.go#L16">graph/internal_keys.go:16</a>).</li>
<li>For textual intermediate outputs, prefer existing model streaming events (<code>choice.Delta.Content</code>).</li>
</ul>
<p>You can also configure agent‑level callbacks:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-90-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-90-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-90-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-90-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-90-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-90-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-90-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-90-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-90-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-90-10">10</a></span>
<span class="normal"><a href="#__codelineno-90-11">11</a></span>
<span class="normal"><a href="#__codelineno-90-12">12</a></span>
<span class="normal"><a href="#__codelineno-90-13">13</a></span>
<span class="normal"><a href="#__codelineno-90-14">14</a></span>
<span class="normal"><a href="#__codelineno-90-15">15</a></span>
<span class="normal"><a href="#__codelineno-90-16">16</a></span>
<span class="normal"><a href="#__codelineno-90-17">17</a></span>
<span class="normal"><a href="#__codelineno-90-18">18</a></span>
<span class="normal"><a href="#__codelineno-90-19">19</a></span>
<span class="normal"><a href="#__codelineno-90-20">20</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-90-1"><a id="__codelineno-90-1" name="__codelineno-90-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-90-2"><a id="__codelineno-90-2" name="__codelineno-90-2"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/agent&quot;</span>
</span><span id="__span-90-3"><a id="__codelineno-90-3" name="__codelineno-90-3"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/model&quot;</span>
</span><span id="__span-90-4"><a id="__codelineno-90-4" name="__codelineno-90-4"></a><span class="p">)</span>
</span><span id="__span-90-5"><a id="__codelineno-90-5" name="__codelineno-90-5"></a>
</span><span id="__span-90-6"><a id="__codelineno-90-6" name="__codelineno-90-6"></a><span class="c1">// Construct and register callbacks (recommended)</span>
</span><span id="__span-90-7"><a id="__codelineno-90-7" name="__codelineno-90-7"></a><span class="c1">// Note: Structured callback API requires trpc-agent-go &gt;= 0.6.0</span>
</span><span id="__span-90-8"><a id="__codelineno-90-8" name="__codelineno-90-8"></a><span class="nx">cb</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">agent</span><span class="p">.</span><span class="nx">NewCallbacks</span><span class="p">().</span>
</span><span id="__span-90-9"><a id="__codelineno-90-9" name="__codelineno-90-9"></a><span class="w">    </span><span class="nx">RegisterBeforeAgent</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">args</span><span class="w"> </span><span class="o">*</span><span class="nx">agent</span><span class="p">.</span><span class="nx">BeforeAgentArgs</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">agent</span><span class="p">.</span><span class="nx">BeforeAgentResult</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-90-10"><a id="__codelineno-90-10" name="__codelineno-90-10"></a><span class="w">        </span><span class="c1">// Return a non-nil CustomResponse to short-circuit this turn</span>
</span><span id="__span-90-11"><a id="__codelineno-90-11" name="__codelineno-90-11"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-90-12"><a id="__codelineno-90-12" name="__codelineno-90-12"></a><span class="w">    </span><span class="p">}).</span>
</span><span id="__span-90-13"><a id="__codelineno-90-13" name="__codelineno-90-13"></a><span class="w">    </span><span class="nx">RegisterAfterAgent</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">args</span><span class="w"> </span><span class="o">*</span><span class="nx">agent</span><span class="p">.</span><span class="nx">AfterAgentArgs</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">agent</span><span class="p">.</span><span class="nx">AfterAgentResult</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-90-14"><a id="__codelineno-90-14" name="__codelineno-90-14"></a><span class="w">        </span><span class="c1">// Modify/replace the final response</span>
</span><span id="__span-90-15"><a id="__codelineno-90-15" name="__codelineno-90-15"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-90-16"><a id="__codelineno-90-16" name="__codelineno-90-16"></a><span class="w">    </span><span class="p">})</span>
</span><span id="__span-90-17"><a id="__codelineno-90-17" name="__codelineno-90-17"></a>
</span><span id="__span-90-18"><a id="__codelineno-90-18" name="__codelineno-90-18"></a><span class="nx">graphAgent</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;workflow&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">g</span><span class="p">,</span>
</span><span id="__span-90-19"><a id="__codelineno-90-19" name="__codelineno-90-19"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithAgentCallbacks</span><span class="p">(</span><span class="nx">cb</span><span class="p">),</span>
</span><span id="__span-90-20"><a id="__codelineno-90-20" name="__codelineno-90-20"></a><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<h2 id="troubleshooting">Troubleshooting</h2>
<p><strong>Q1: Graph has no entry point</strong></p>
<ul>
<li>Error: "graph must have an entry point". Call <code>SetEntryPoint()</code> and ensure the node exists.</li>
</ul>
<p><strong>Q2: Edge target/source does not exist</strong></p>
<ul>
<li>Error mentions missing node. Define nodes before wiring edges/condition maps.</li>
</ul>
<p><strong>Q3: Tools don't run after LLM</strong></p>
<ul>
<li>Ensure the LLM actually returned <code>tool_calls</code> and you used <code>AddToolsConditionalEdges(ask, tools, fallback)</code>.</li>
<li>Check that tool names in your map match the model's declared tool names.</li>
<li>Pairing walks from the latest assistant(tool_calls) until a new user; verify messages ordering.</li>
</ul>
<p><strong>Q4: LLM returns tool_calls but tools never execute (always routes to fallback)</strong></p>
<ul>
<li><strong>Root cause</strong>: Using <code>NewStateSchema()</code> instead of <code>MessagesStateSchema()</code>.</li>
<li><code>AddToolsConditionalEdges</code> internally checks <code>state[StateKeyMessages].([]model.Message)</code> to determine if there are tool calls.</li>
<li>If the Schema lacks the <code>StateKeyMessages</code> field, <code>MessageReducer</code> won't be applied. The LLM node returns <code>[]graph.MessageOp</code> instead of <code>[]model.Message</code>, causing type assertion to fail and always routing to <code>fallbackNode</code>.</li>
<li><strong>Solution</strong>: Replace <code>graph.NewStateSchema()</code> with <code>graph.MessagesStateSchema()</code>, then add custom fields on top:
  <div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-91-1">1</a></span>
<span class="normal"><a href="#__codelineno-91-2">2</a></span>
<span class="normal"><a href="#__codelineno-91-3">3</a></span>
<span class="normal"><a href="#__codelineno-91-4">4</a></span>
<span class="normal"><a href="#__codelineno-91-5">5</a></span>
<span class="normal"><a href="#__codelineno-91-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-91-1"><a id="__codelineno-91-1" name="__codelineno-91-1"></a><span class="c1">// Wrong</span>
</span><span id="__span-91-2"><a id="__codelineno-91-2" name="__codelineno-91-2"></a><span class="nx">schema</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateSchema</span><span class="p">()</span>
</span><span id="__span-91-3"><a id="__codelineno-91-3" name="__codelineno-91-3"></a>
</span><span id="__span-91-4"><a id="__codelineno-91-4" name="__codelineno-91-4"></a><span class="c1">// Correct</span>
</span><span id="__span-91-5"><a id="__codelineno-91-5" name="__codelineno-91-5"></a><span class="nx">schema</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">MessagesStateSchema</span><span class="p">()</span>
</span><span id="__span-91-6"><a id="__codelineno-91-6" name="__codelineno-91-6"></a><span class="nx">schema</span><span class="p">.</span><span class="nx">AddField</span><span class="p">(</span><span class="s">&quot;my_field&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateField</span><span class="p">{</span><span class="o">...</span><span class="p">})</span>
</span></code></pre></div></td></tr></table></div></li>
</ul>
<p><strong>Q5: No streaming events observed</strong></p>
<ul>
<li>Increase <code>WithChannelBufferSize</code> and filter by <code>Author</code>/object types.</li>
<li>Verify you're consuming events from <code>Runner.Run(...)</code> and not from direct <code>Executor</code> calls.</li>
</ul>
<p><strong>Q6: Resume did not continue where expected</strong></p>
<ul>
<li>Pass <code>agent.WithRuntimeState(map[string]any{ graph.CfgKeyLineageID: "...", graph.CfgKeyCheckpointID: "..." })</code>.</li>
<li>Provide <code>ResumeMap</code> for HITL continuation when needed. A plain "resume" message is not added to <code>graph.StateKeyUserInput</code>.</li>
</ul>
<p><strong>Q7: State conflicts in parallel</strong></p>
<ul>
<li>Define reducers for lists/maps (e.g., <code>StringSliceReducer</code>, <code>MergeReducer</code>), avoid overwriting the same key from multiple branches without merge semantics.</li>
</ul>
<p><strong>Q8: What does the tools parameter in AddLLMNode do? When are tools actually called?</strong></p>
<ul>
<li><strong>tools parameter is declarative</strong>: The tools passed to <code>AddLLMNode</code> are placed in <code>model.Request.Tools</code>, telling the LLM what tools are available.</li>
<li><strong>LLM decides whether to call tools</strong>: Based on the tools declaration and user input, the LLM decides whether to return <code>tool_calls</code> in its response.</li>
<li><strong>tools are NOT automatically executed</strong>: <code>AddLLMNode</code> only declares tools and sends requests to the LLM; it does not execute tools.</li>
<li><strong>Tool execution requires AddToolsNode + AddToolsConditionalEdges</strong>:
  <div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-92-1">1</a></span>
<span class="normal"><a href="#__codelineno-92-2">2</a></span>
<span class="normal"><a href="#__codelineno-92-3">3</a></span>
<span class="normal"><a href="#__codelineno-92-4">4</a></span>
<span class="normal"><a href="#__codelineno-92-5">5</a></span>
<span class="normal"><a href="#__codelineno-92-6">6</a></span>
<span class="normal"><a href="#__codelineno-92-7">7</a></span>
<span class="normal"><a href="#__codelineno-92-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-92-1"><a id="__codelineno-92-1" name="__codelineno-92-1"></a><span class="c1">// 1. LLM node declares tools (tells LLM what tools are available)</span>
</span><span id="__span-92-2"><a id="__codelineno-92-2" name="__codelineno-92-2"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddLLMNode</span><span class="p">(</span><span class="s">&quot;ask&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">model</span><span class="p">,</span><span class="w"> </span><span class="nx">systemPrompt</span><span class="p">,</span><span class="w"> </span><span class="nx">tools</span><span class="p">)</span>
</span><span id="__span-92-3"><a id="__codelineno-92-3" name="__codelineno-92-3"></a>
</span><span id="__span-92-4"><a id="__codelineno-92-4" name="__codelineno-92-4"></a><span class="c1">// 2. Tools node executes tools (based on tool_calls returned by LLM)</span>
</span><span id="__span-92-5"><a id="__codelineno-92-5" name="__codelineno-92-5"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddToolsNode</span><span class="p">(</span><span class="s">&quot;tools&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">tools</span><span class="p">)</span>
</span><span id="__span-92-6"><a id="__codelineno-92-6" name="__codelineno-92-6"></a>
</span><span id="__span-92-7"><a id="__codelineno-92-7" name="__codelineno-92-7"></a><span class="c1">// 3. Conditional edges route based on LLM response (routes to tools node if tool_calls present)</span>
</span><span id="__span-92-8"><a id="__codelineno-92-8" name="__codelineno-92-8"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddToolsConditionalEdges</span><span class="p">(</span><span class="s">&quot;ask&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;tools&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;fallback&quot;</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div></li>
<li><strong>Execution timing</strong>: When <code>AddToolsConditionalEdges</code> detects <code>tool_calls</code> in the LLM response, it routes to <code>AddToolsNode</code>, which executes the actual tool calls.</li>
</ul>
<p><strong>Q9: Messages are duplicated in req.Messages when chaining multiple LLM nodes</strong></p>
<ul>
<li><strong>Symptom</strong>: The same user input appears multiple times in <code>req.Messages</code>.</li>
<li><strong>Root cause</strong>: When using <code>MessagesStateSchema()</code>, <code>MessageReducer</code> accumulates messages. Each LLM node execution appends a new user message if <code>StateKeyUserInput</code> is not empty. When there are loops (e.g., tool call loops) or multiple LLM nodes chained together, messages keep accumulating.</li>
<li><strong>Solution</strong>: Use <code>RemoveAllMessages</code> to clear previous messages before setting a new <code>StateKeyUserInput</code>:
  <div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-93-1">1</a></span>
<span class="normal"><a href="#__codelineno-93-2">2</a></span>
<span class="normal"><a href="#__codelineno-93-3">3</a></span>
<span class="normal"><a href="#__codelineno-93-4">4</a></span>
<span class="normal"><a href="#__codelineno-93-5">5</a></span>
<span class="normal"><a href="#__codelineno-93-6">6</a></span>
<span class="normal"><a href="#__codelineno-93-7">7</a></span>
<span class="normal"><a href="#__codelineno-93-8">8</a></span>
<span class="normal"><a href="#__codelineno-93-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-93-1"><a id="__codelineno-93-1" name="__codelineno-93-1"></a><span class="c1">// In the prepare prompt node</span>
</span><span id="__span-93-2"><a id="__codelineno-93-2" name="__codelineno-93-2"></a><span class="kd">func</span><span class="w"> </span><span class="nx">preparePromptNode</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-93-3"><a id="__codelineno-93-3" name="__codelineno-93-3"></a><span class="w">    </span><span class="nx">userMessage</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">buildUserMessage</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</span><span id="__span-93-4"><a id="__codelineno-93-4" name="__codelineno-93-4"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span>
</span><span id="__span-93-5"><a id="__codelineno-93-5" name="__codelineno-93-5"></a><span class="w">        </span><span class="c1">// Key: Clear previous messages to avoid accumulation</span>
</span><span id="__span-93-6"><a id="__codelineno-93-6" name="__codelineno-93-6"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyMessages</span><span class="p">:</span><span class="w">  </span><span class="nx">graph</span><span class="p">.</span><span class="nx">RemoveAllMessages</span><span class="p">{},</span>
</span><span id="__span-93-7"><a id="__codelineno-93-7" name="__codelineno-93-7"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyUserInput</span><span class="p">:</span><span class="w"> </span><span class="nx">userMessage</span><span class="p">,</span>
</span><span id="__span-93-8"><a id="__codelineno-93-8" name="__codelineno-93-8"></a><span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-93-9"><a id="__codelineno-93-9" name="__codelineno-93-9"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div></li>
<li><strong>Note</strong>: <code>WithSubgraphIsolatedMessages(true)</code> only works for <code>AddSubgraphNode</code>, not for <code>AddLLMNode</code>.</li>
</ul>
<p><strong>Q10: Downstream Agent node receives an empty input</strong></p>
<ul>
<li><strong>Symptom</strong>: In a chain like <code>A (agent) → B (agent)</code>, the downstream agent
  runs but <code>Invocation.Message.Content</code> is empty (or it behaves as if it didn't
  get A's output).</li>
<li><strong>Root cause</strong>: Agent nodes consume <code>user_input</code> as their input message and
  clear it after a successful run. Edges do not automatically pipe outputs.</li>
<li><strong>Solution</strong>: Explicitly write the desired upstream value into <code>user_input</code>
  before the downstream agent runs:
  <div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-94-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-94-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-94-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-94-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-94-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-94-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-94-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-94-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-94-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-94-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-94-1"><a id="__codelineno-94-1" name="__codelineno-94-1"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddAgentNode</span><span class="p">(</span><span class="s">&quot;B&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithSubgraphInputFromLastResponse</span><span class="p">())</span>
</span><span id="__span-94-2"><a id="__codelineno-94-2" name="__codelineno-94-2"></a><span class="c1">// or:</span>
</span><span id="__span-94-3"><a id="__codelineno-94-3" name="__codelineno-94-3"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddAgentNode</span><span class="p">(</span><span class="s">&quot;B&quot;</span><span class="p">,</span>
</span><span id="__span-94-4"><a id="__codelineno-94-4" name="__codelineno-94-4"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithPreNodeCallback</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">cb</span><span class="w"> </span><span class="o">*</span><span class="nx">graph</span><span class="p">.</span><span class="nx">NodeCallbackContext</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-94-5"><a id="__codelineno-94-5" name="__codelineno-94-5"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">v</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">s</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyLastResponse</span><span class="p">].(</span><span class="kt">string</span><span class="p">);</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-94-6"><a id="__codelineno-94-6" name="__codelineno-94-6"></a><span class="w">            </span><span class="nx">s</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyUserInput</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">v</span>
</span><span id="__span-94-7"><a id="__codelineno-94-7" name="__codelineno-94-7"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-94-8"><a id="__codelineno-94-8" name="__codelineno-94-8"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-94-9"><a id="__codelineno-94-9" name="__codelineno-94-9"></a><span class="w">    </span><span class="p">}),</span>
</span><span id="__span-94-10"><a id="__codelineno-94-10" name="__codelineno-94-10"></a><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
  If you need a specific node's output, read it from
  <code>node_responses[targetNodeID]</code> and write that into <code>user_input</code>.</li>
</ul>
<p><strong>Q11: Downstream Agent needs both original input and upstream output</strong></p>
<ul>
<li><strong>Symptom</strong>: <code>WithSubgraphInputFromLastResponse()</code> makes the downstream agent
  consume <code>last_response</code> as its current input, but you also need the original
  user request for this run.</li>
<li><strong>Solution</strong>: Persist the original <code>user_input</code> into your own state key (for
  example, <code>original_user_input</code>) and use a function node to compose the next
  <code>user_input</code> as <code>original + upstream</code> before the downstream agent runs.
  See "Agent nodes: combining original input with upstream output".</li>
</ul>
<h2 id="realworld-example">Real‑World Example</h2>
<h3 id="approval-workflow">Approval Workflow</h3>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-95-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-95-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-95-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-95-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-95-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-95-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-95-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-95-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-95-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-95-10">10</a></span>
<span class="normal"><a href="#__codelineno-95-11">11</a></span>
<span class="normal"><a href="#__codelineno-95-12">12</a></span>
<span class="normal"><a href="#__codelineno-95-13">13</a></span>
<span class="normal"><a href="#__codelineno-95-14">14</a></span>
<span class="normal"><a href="#__codelineno-95-15">15</a></span>
<span class="normal"><a href="#__codelineno-95-16">16</a></span>
<span class="normal"><a href="#__codelineno-95-17">17</a></span>
<span class="normal"><a href="#__codelineno-95-18">18</a></span>
<span class="normal"><a href="#__codelineno-95-19">19</a></span>
<span class="normal"><a href="#__codelineno-95-20">20</a></span>
<span class="normal"><a href="#__codelineno-95-21">21</a></span>
<span class="normal"><a href="#__codelineno-95-22">22</a></span>
<span class="normal"><a href="#__codelineno-95-23">23</a></span>
<span class="normal"><a href="#__codelineno-95-24">24</a></span>
<span class="normal"><a href="#__codelineno-95-25">25</a></span>
<span class="normal"><a href="#__codelineno-95-26">26</a></span>
<span class="normal"><a href="#__codelineno-95-27">27</a></span>
<span class="normal"><a href="#__codelineno-95-28">28</a></span>
<span class="normal"><a href="#__codelineno-95-29">29</a></span>
<span class="normal"><a href="#__codelineno-95-30">30</a></span>
<span class="normal"><a href="#__codelineno-95-31">31</a></span>
<span class="normal"><a href="#__codelineno-95-32">32</a></span>
<span class="normal"><a href="#__codelineno-95-33">33</a></span>
<span class="normal"><a href="#__codelineno-95-34">34</a></span>
<span class="normal"><a href="#__codelineno-95-35">35</a></span>
<span class="normal"><a href="#__codelineno-95-36">36</a></span>
<span class="normal"><a href="#__codelineno-95-37">37</a></span>
<span class="normal"><a href="#__codelineno-95-38">38</a></span>
<span class="normal"><a href="#__codelineno-95-39">39</a></span>
<span class="normal"><a href="#__codelineno-95-40">40</a></span>
<span class="normal"><a href="#__codelineno-95-41">41</a></span>
<span class="normal"><a href="#__codelineno-95-42">42</a></span>
<span class="normal"><a href="#__codelineno-95-43">43</a></span>
<span class="normal"><a href="#__codelineno-95-44">44</a></span>
<span class="normal"><a href="#__codelineno-95-45">45</a></span>
<span class="normal"><a href="#__codelineno-95-46">46</a></span>
<span class="normal"><a href="#__codelineno-95-47">47</a></span>
<span class="normal"><a href="#__codelineno-95-48">48</a></span>
<span class="normal"><a href="#__codelineno-95-49">49</a></span>
<span class="normal"><a href="#__codelineno-95-50">50</a></span>
<span class="normal"><a href="#__codelineno-95-51">51</a></span>
<span class="normal"><a href="#__codelineno-95-52">52</a></span>
<span class="normal"><a href="#__codelineno-95-53">53</a></span>
<span class="normal"><a href="#__codelineno-95-54">54</a></span>
<span class="normal"><a href="#__codelineno-95-55">55</a></span>
<span class="normal"><a href="#__codelineno-95-56">56</a></span>
<span class="normal"><a href="#__codelineno-95-57">57</a></span>
<span class="normal"><a href="#__codelineno-95-58">58</a></span>
<span class="normal"><a href="#__codelineno-95-59">59</a></span>
<span class="normal"><a href="#__codelineno-95-60">60</a></span>
<span class="normal"><a href="#__codelineno-95-61">61</a></span>
<span class="normal"><a href="#__codelineno-95-62">62</a></span>
<span class="normal"><a href="#__codelineno-95-63">63</a></span>
<span class="normal"><a href="#__codelineno-95-64">64</a></span>
<span class="normal"><a href="#__codelineno-95-65">65</a></span>
<span class="normal"><a href="#__codelineno-95-66">66</a></span>
<span class="normal"><a href="#__codelineno-95-67">67</a></span>
<span class="normal"><a href="#__codelineno-95-68">68</a></span>
<span class="normal"><a href="#__codelineno-95-69">69</a></span>
<span class="normal"><a href="#__codelineno-95-70">70</a></span>
<span class="normal"><a href="#__codelineno-95-71">71</a></span>
<span class="normal"><a href="#__codelineno-95-72">72</a></span>
<span class="normal"><a href="#__codelineno-95-73">73</a></span>
<span class="normal"><a href="#__codelineno-95-74">74</a></span>
<span class="normal"><a href="#__codelineno-95-75">75</a></span>
<span class="normal"><a href="#__codelineno-95-76">76</a></span>
<span class="normal"><a href="#__codelineno-95-77">77</a></span>
<span class="normal"><a href="#__codelineno-95-78">78</a></span>
<span class="normal"><a href="#__codelineno-95-79">79</a></span>
<span class="normal"><a href="#__codelineno-95-80">80</a></span>
<span class="normal"><a href="#__codelineno-95-81">81</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-95-1"><a id="__codelineno-95-1" name="__codelineno-95-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-95-2"><a id="__codelineno-95-2" name="__codelineno-95-2"></a><span class="w">    </span><span class="s">&quot;context&quot;</span>
</span><span id="__span-95-3"><a id="__codelineno-95-3" name="__codelineno-95-3"></a><span class="w">    </span><span class="s">&quot;fmt&quot;</span>
</span><span id="__span-95-4"><a id="__codelineno-95-4" name="__codelineno-95-4"></a><span class="w">    </span><span class="s">&quot;strings&quot;</span>
</span><span id="__span-95-5"><a id="__codelineno-95-5" name="__codelineno-95-5"></a>
</span><span id="__span-95-6"><a id="__codelineno-95-6" name="__codelineno-95-6"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-95-7"><a id="__codelineno-95-7" name="__codelineno-95-7"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/model/openai&quot;</span>
</span><span id="__span-95-8"><a id="__codelineno-95-8" name="__codelineno-95-8"></a><span class="p">)</span>
</span><span id="__span-95-9"><a id="__codelineno-95-9" name="__codelineno-95-9"></a>
</span><span id="__span-95-10"><a id="__codelineno-95-10" name="__codelineno-95-10"></a><span class="kd">func</span><span class="w"> </span><span class="nx">buildApprovalWorkflow</span><span class="p">()</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">graph</span><span class="p">.</span><span class="nx">Graph</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-95-11"><a id="__codelineno-95-11" name="__codelineno-95-11"></a><span class="w">    </span><span class="nx">sg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateGraph</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">MessagesStateSchema</span><span class="p">())</span>
</span><span id="__span-95-12"><a id="__codelineno-95-12" name="__codelineno-95-12"></a>
</span><span id="__span-95-13"><a id="__codelineno-95-13" name="__codelineno-95-13"></a><span class="w">    </span><span class="c1">// AI pre‑review (define LLM model)</span>
</span><span id="__span-95-14"><a id="__codelineno-95-14" name="__codelineno-95-14"></a><span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-95-15"><a id="__codelineno-95-15" name="__codelineno-95-15"></a><span class="w">        </span><span class="nx">modelNameApprove</span><span class="w">      </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;gpt-4o-mini&quot;</span>
</span><span id="__span-95-16"><a id="__codelineno-95-16" name="__codelineno-95-16"></a><span class="w">        </span><span class="nx">promptApproveDecision</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;Decide whether the application meets requirements; reply approve or reject&quot;</span>
</span><span id="__span-95-17"><a id="__codelineno-95-17" name="__codelineno-95-17"></a>
</span><span id="__span-95-18"><a id="__codelineno-95-18" name="__codelineno-95-18"></a><span class="w">        </span><span class="nx">nodeAIReview</span><span class="w">    </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;ai_review&quot;</span>
</span><span id="__span-95-19"><a id="__codelineno-95-19" name="__codelineno-95-19"></a><span class="w">        </span><span class="nx">nodeHumanReview</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;human_review&quot;</span>
</span><span id="__span-95-20"><a id="__codelineno-95-20" name="__codelineno-95-20"></a><span class="w">        </span><span class="nx">nodeApprove</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;approve&quot;</span>
</span><span id="__span-95-21"><a id="__codelineno-95-21" name="__codelineno-95-21"></a><span class="w">        </span><span class="nx">nodeReject</span><span class="w">      </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;reject&quot;</span>
</span><span id="__span-95-22"><a id="__codelineno-95-22" name="__codelineno-95-22"></a>
</span><span id="__span-95-23"><a id="__codelineno-95-23" name="__codelineno-95-23"></a><span class="w">        </span><span class="nx">routeHumanReview</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;route_human_review&quot;</span>
</span><span id="__span-95-24"><a id="__codelineno-95-24" name="__codelineno-95-24"></a><span class="w">        </span><span class="nx">routeReject</span><span class="w">      </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;route_reject&quot;</span>
</span><span id="__span-95-25"><a id="__codelineno-95-25" name="__codelineno-95-25"></a><span class="w">        </span><span class="nx">routeApprove</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;route_approve&quot;</span>
</span><span id="__span-95-26"><a id="__codelineno-95-26" name="__codelineno-95-26"></a>
</span><span id="__span-95-27"><a id="__codelineno-95-27" name="__codelineno-95-27"></a><span class="w">        </span><span class="nx">stateKeyApplication</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;application&quot;</span>
</span><span id="__span-95-28"><a id="__codelineno-95-28" name="__codelineno-95-28"></a><span class="w">        </span><span class="nx">stateKeyDecision</span><span class="w">    </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;decision&quot;</span>
</span><span id="__span-95-29"><a id="__codelineno-95-29" name="__codelineno-95-29"></a><span class="w">    </span><span class="p">)</span>
</span><span id="__span-95-30"><a id="__codelineno-95-30" name="__codelineno-95-30"></a>
</span><span id="__span-95-31"><a id="__codelineno-95-31" name="__codelineno-95-31"></a><span class="w">    </span><span class="nx">llm</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">openai</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="nx">modelNameApprove</span><span class="p">)</span>
</span><span id="__span-95-32"><a id="__codelineno-95-32" name="__codelineno-95-32"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddLLMNode</span><span class="p">(</span><span class="nx">nodeAIReview</span><span class="p">,</span><span class="w"> </span><span class="nx">llm</span><span class="p">,</span><span class="w"> </span><span class="nx">promptApproveDecision</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span><span class="p">)</span>
</span><span id="__span-95-33"><a id="__codelineno-95-33" name="__codelineno-95-33"></a>
</span><span id="__span-95-34"><a id="__codelineno-95-34" name="__codelineno-95-34"></a><span class="w">    </span><span class="c1">// Route to human review or reject</span>
</span><span id="__span-95-35"><a id="__codelineno-95-35" name="__codelineno-95-35"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddConditionalEdges</span><span class="p">(</span><span class="nx">nodeAIReview</span><span class="p">,</span>
</span><span id="__span-95-36"><a id="__codelineno-95-36" name="__codelineno-95-36"></a><span class="w">        </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-95-37"><a id="__codelineno-95-37" name="__codelineno-95-37"></a><span class="w">            </span><span class="nx">resp</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">s</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyLastResponse</span><span class="p">].(</span><span class="kt">string</span><span class="p">)</span>
</span><span id="__span-95-38"><a id="__codelineno-95-38" name="__codelineno-95-38"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">strings</span><span class="p">.</span><span class="nx">Contains</span><span class="p">(</span><span class="nx">resp</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;approve&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-95-39"><a id="__codelineno-95-39" name="__codelineno-95-39"></a><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nx">routeHumanReview</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-95-40"><a id="__codelineno-95-40" name="__codelineno-95-40"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-95-41"><a id="__codelineno-95-41" name="__codelineno-95-41"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">routeReject</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-95-42"><a id="__codelineno-95-42" name="__codelineno-95-42"></a><span class="w">        </span><span class="p">},</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span>
</span><span id="__span-95-43"><a id="__codelineno-95-43" name="__codelineno-95-43"></a><span class="w">            </span><span class="nx">routeHumanReview</span><span class="p">:</span><span class="w"> </span><span class="nx">nodeHumanReview</span><span class="p">,</span>
</span><span id="__span-95-44"><a id="__codelineno-95-44" name="__codelineno-95-44"></a><span class="w">            </span><span class="nx">routeReject</span><span class="p">:</span><span class="w">      </span><span class="nx">nodeReject</span><span class="p">,</span>
</span><span id="__span-95-45"><a id="__codelineno-95-45" name="__codelineno-95-45"></a><span class="w">        </span><span class="p">})</span>
</span><span id="__span-95-46"><a id="__codelineno-95-46" name="__codelineno-95-46"></a>
</span><span id="__span-95-47"><a id="__codelineno-95-47" name="__codelineno-95-47"></a><span class="w">    </span><span class="c1">// Human review node</span>
</span><span id="__span-95-48"><a id="__codelineno-95-48" name="__codelineno-95-48"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="nx">nodeHumanReview</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-95-49"><a id="__codelineno-95-49" name="__codelineno-95-49"></a><span class="w">        </span><span class="nx">app</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">s</span><span class="p">[</span><span class="nx">stateKeyApplication</span><span class="p">].(</span><span class="kt">string</span><span class="p">)</span>
</span><span id="__span-95-50"><a id="__codelineno-95-50" name="__codelineno-95-50"></a><span class="w">        </span><span class="nx">decision</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">Interrupt</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;approval&quot;</span><span class="p">,</span>
</span><span id="__span-95-51"><a id="__codelineno-95-51" name="__codelineno-95-51"></a><span class="w">            </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;Please approve: %s&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">app</span><span class="p">))</span>
</span><span id="__span-95-52"><a id="__codelineno-95-52" name="__codelineno-95-52"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-95-53"><a id="__codelineno-95-53" name="__codelineno-95-53"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
</span><span id="__span-95-54"><a id="__codelineno-95-54" name="__codelineno-95-54"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-95-55"><a id="__codelineno-95-55" name="__codelineno-95-55"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="nx">stateKeyDecision</span><span class="p">:</span><span class="w"> </span><span class="nx">decision</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-95-56"><a id="__codelineno-95-56" name="__codelineno-95-56"></a><span class="w">    </span><span class="p">})</span>
</span><span id="__span-95-57"><a id="__codelineno-95-57" name="__codelineno-95-57"></a>
</span><span id="__span-95-58"><a id="__codelineno-95-58" name="__codelineno-95-58"></a><span class="w">    </span><span class="c1">// Outcome handling</span>
</span><span id="__span-95-59"><a id="__codelineno-95-59" name="__codelineno-95-59"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="nx">nodeApprove</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-95-60"><a id="__codelineno-95-60" name="__codelineno-95-60"></a><span class="w">        </span><span class="c1">// perform approval logic</span>
</span><span id="__span-95-61"><a id="__codelineno-95-61" name="__codelineno-95-61"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="s">&quot;status&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;approved&quot;</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-95-62"><a id="__codelineno-95-62" name="__codelineno-95-62"></a><span class="w">    </span><span class="p">})</span>
</span><span id="__span-95-63"><a id="__codelineno-95-63" name="__codelineno-95-63"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="nx">nodeReject</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-95-64"><a id="__codelineno-95-64" name="__codelineno-95-64"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="s">&quot;status&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;rejected&quot;</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-95-65"><a id="__codelineno-95-65" name="__codelineno-95-65"></a><span class="w">    </span><span class="p">})</span>
</span><span id="__span-95-66"><a id="__codelineno-95-66" name="__codelineno-95-66"></a>
</span><span id="__span-95-67"><a id="__codelineno-95-67" name="__codelineno-95-67"></a><span class="w">    </span><span class="c1">// Wire the flow</span>
</span><span id="__span-95-68"><a id="__codelineno-95-68" name="__codelineno-95-68"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">SetEntryPoint</span><span class="p">(</span><span class="nx">nodeAIReview</span><span class="p">)</span>
</span><span id="__span-95-69"><a id="__codelineno-95-69" name="__codelineno-95-69"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddConditionalEdges</span><span class="p">(</span><span class="nx">nodeHumanReview</span><span class="p">,</span>
</span><span id="__span-95-70"><a id="__codelineno-95-70" name="__codelineno-95-70"></a><span class="w">        </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-95-71"><a id="__codelineno-95-71" name="__codelineno-95-71"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">s</span><span class="p">[</span><span class="nx">stateKeyDecision</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;approve&quot;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-95-72"><a id="__codelineno-95-72" name="__codelineno-95-72"></a><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nx">routeApprove</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-95-73"><a id="__codelineno-95-73" name="__codelineno-95-73"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-95-74"><a id="__codelineno-95-74" name="__codelineno-95-74"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">routeReject</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-95-75"><a id="__codelineno-95-75" name="__codelineno-95-75"></a><span class="w">        </span><span class="p">},</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span>
</span><span id="__span-95-76"><a id="__codelineno-95-76" name="__codelineno-95-76"></a><span class="w">            </span><span class="nx">routeApprove</span><span class="p">:</span><span class="w"> </span><span class="nx">nodeApprove</span><span class="p">,</span>
</span><span id="__span-95-77"><a id="__codelineno-95-77" name="__codelineno-95-77"></a><span class="w">            </span><span class="nx">routeReject</span><span class="p">:</span><span class="w">  </span><span class="nx">nodeReject</span><span class="p">,</span>
</span><span id="__span-95-78"><a id="__codelineno-95-78" name="__codelineno-95-78"></a><span class="w">        </span><span class="p">})</span>
</span><span id="__span-95-79"><a id="__codelineno-95-79" name="__codelineno-95-79"></a>
</span><span id="__span-95-80"><a id="__codelineno-95-80" name="__codelineno-95-80"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">sg</span><span class="p">.</span><span class="nx">Compile</span><span class="p">()</span>
</span><span id="__span-95-81"><a id="__codelineno-95-81" name="__codelineno-95-81"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<h2 id="summary">Summary</h2>
<p>This guide introduced the core usage of the <code>graph</code> package and GraphAgent: declaring nodes and routes, safely merging state via Schema + Reducers, and leveraging events, checkpoints, and interrupts for observability and recovery. For structured flows (approvals, content moderation, stepwise processing), Graph provides stable, auditable execution. For intelligent decisions, extend with LLM nodes and sub‑agents.</p>
<h2 id="references-examples">References &amp; Examples</h2>
<ul>
<li>Repository: https://github.com/trpc-group/trpc-agent-go</li>
<li>Graph examples: <code>examples/graph</code> (basic/parallel/multi‑turn/interrupts and recovery)<ul>
<li>I/O conventions: <code>io_conventions</code>, <code>io_conventions_tools</code></li>
<li>Parallel/fan‑out: <code>parallel</code>, <code>fanout</code>, <code>diamond</code></li>
<li>Placeholders: <code>placeholder</code></li>
<li>Checkpoints/interrupts: <code>checkpoint</code>, <code>interrupt</code>, <code>nested_interrupt</code>, <code>static_interrupt</code></li>
</ul>
</li>
<li>Further reading: <code>graph/state_graph.go</code>, <code>graph/executor.go</code>, <code>agent/graphagent</code></li>
</ul>







  
    
  
  
    
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Last update">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_datetime" title="January 26, 2026 01:29:30 UTC">2026-01-26 01:29:30</span>
  </span>

    
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Created">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_datetime" title="August 25, 2025 07:06:16 UTC">2025-08-25 07:06:16</span>
  </span>

    
    
    
  </aside>


  



  <form class="md-feedback" name="feedback" hidden>
    <fieldset>
      <legend class="md-feedback__title">
        Was this page helpful?
      </legend>
      <div class="md-feedback__inner">
        <div class="md-feedback__list">
          
            <button class="md-feedback__icon md-icon" type="submit" title="This page was helpful" data-md-value="1">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m7 0c0 .8-.7 1.5-1.5 1.5S14 10.3 14 9.5 14.7 8 15.5 8s1.5.7 1.5 1.5m-5 7.73c-1.75 0-3.29-.73-4.19-1.81L9.23 14c.45.72 1.52 1.23 2.77 1.23s2.32-.51 2.77-1.23l1.42 1.42c-.9 1.08-2.44 1.81-4.19 1.81"/></svg>
            </button>
          
            <button class="md-feedback__icon md-icon" type="submit" title="This page could be improved" data-md-value="0">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10m-6.5-4c.8 0 1.5.7 1.5 1.5s-.7 1.5-1.5 1.5-1.5-.7-1.5-1.5.7-1.5 1.5-1.5M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m2 4.5c1.75 0 3.29.72 4.19 1.81l-1.42 1.42C14.32 16.5 13.25 16 12 16s-2.32.5-2.77 1.23l-1.42-1.42C8.71 14.72 10.25 14 12 14"/></svg>
            </button>
          
        </div>
        <div class="md-feedback__note">
          
            <div data-md-value="1" hidden>
              
              
                
              
              
              
                
                
              
              Thanks for your feedback!
            </div>
          
            <div data-md-value="0" hidden>
              
              
                
              
              
              
                
                
              
              Thanks for your feedback!<br>Please help us improve by opening an <a href="https://github.com/trpc-group/trpc-agent-go/issues/new" target="_blank" rel="noopener">issue</a>.
            </div>
          
        </div>
      </div>
    </fieldset>
  </form>


                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../team/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Team">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Team
              </div>
            </div>
          </a>
        
        
          
          <a href="../custom-agent/" class="md-footer__link md-footer__link--next" aria-label="Next: Custom Agent">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                Custom Agent
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": ["content.code.copy", "navigation.footer", "navigation.tabs", "search.suggest", "search.share", "content.action.edit", "content.action.view"], "search": "../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.92b07e13.min.js"></script>
      
    
  </body>
</html>