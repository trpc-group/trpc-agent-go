
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://trpc-group.github.io/trpc-agent-go/graph/">
      
      
        <link rel="prev" href="../multiagent/">
      
      
        <link rel="next" href="../custom-agent/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.17">
    
    
      
        <title>Graph Agent - tRPC-Agent-Go</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.7e37652d.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/extra.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config",""),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#graph-package-guide" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="tRPC-Agent-Go" class="md-header__button md-logo" aria-label="tRPC-Agent-Go" data-md-component="logo">
      
  <img src="../assets/img/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            tRPC-Agent-Go
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Graph Agent
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
      <div class="md-header__option">
  <div class="md-select">
    
    <button class="md-header__button md-icon" aria-label="Select language">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m12.87 15.07-2.54-2.51.03-.03A17.5 17.5 0 0 0 14.07 6H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2zm-2.62 7 1.62-4.33L19.12 17z"/></svg>
    </button>
    <div class="md-select__inner">
      <ul class="md-select__list">
        
          <li class="md-select__item">
            <a href="./" hreflang="en" class="md-select__link">
              English
            </a>
          </li>
        
          <li class="md-select__item">
            <a href="../zh/graph/" hreflang="zh" class="md-select__link">
              中文
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</div>
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/trpc-group/trpc-agent-go" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    trpc-group/trpc-agent-go
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href=".." class="md-tabs__link">
        
  
  
    
  
  Overview

      </a>
    </li>
  

      
        
  
  
  
    
  
  
    
    
      
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../agent/" class="md-tabs__link">
          
  
  
  Components

        </a>
      </li>
    
  

    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../debugserver/" class="md-tabs__link">
          
  
  
  Server

        </a>
      </li>
    
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../observability/" class="md-tabs__link">
        
  
  
    
  
  Observability

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../ecosystem/" class="md-tabs__link">
        
  
  
    
  
  Ecosystem

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="tRPC-Agent-Go" class="md-nav__button md-logo" aria-label="tRPC-Agent-Go" data-md-component="logo">
      
  <img src="../assets/img/logo.png" alt="logo">

    </a>
    tRPC-Agent-Go
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/trpc-group/trpc-agent-go" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    trpc-group/trpc-agent-go
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Components
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Components
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1" checked>
        
          
          <label class="md-nav__link" for="__nav_2_1" id="__nav_2_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Agent
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_1">
            <span class="md-nav__icon md-icon"></span>
            Agent
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Agent
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../multiagent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Multi Agent
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Graph Agent
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Graph Agent
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    <span class="md-ellipsis">
      Overview
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#quick-start" class="md-nav__link">
    <span class="md-ellipsis">
      Quick Start
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Quick Start">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#minimal-workflow" class="md-nav__link">
    <span class="md-ellipsis">
      Minimal Workflow
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#usage-pattern" class="md-nav__link">
    <span class="md-ellipsis">
      Usage Pattern
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agent-integration" class="md-nav__link">
    <span class="md-ellipsis">
      Agent Integration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#key-features" class="md-nav__link">
    <span class="md-ellipsis">
      Key Features
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#core-concepts" class="md-nav__link">
    <span class="md-ellipsis">
      Core Concepts
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Core Concepts">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-graph" class="md-nav__link">
    <span class="md-ellipsis">
      1. Graph
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-node" class="md-nav__link">
    <span class="md-ellipsis">
      2. Node
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-state" class="md-nav__link">
    <span class="md-ellipsis">
      3. State
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-state-schema" class="md-nav__link">
    <span class="md-ellipsis">
      4. State Schema
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#usage-guide" class="md-nav__link">
    <span class="md-ellipsis">
      Usage Guide
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Usage Guide">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#node-io-conventions" class="md-nav__link">
    <span class="md-ellipsis">
      Node I/O Conventions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Node I/O Conventions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#constant-references-import-and-keys" class="md-nav__link">
    <span class="md-ellipsis">
      Constant references (import and keys)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#event-metadata-keys-statedelta" class="md-nav__link">
    <span class="md-ellipsis">
      Event metadata keys (StateDelta)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1-creating-graphagent-and-runner" class="md-nav__link">
    <span class="md-ellipsis">
      1. Creating GraphAgent and Runner
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-using-llm-nodes" class="md-nav__link">
    <span class="md-ellipsis">
      2. Using LLM Nodes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. Using LLM Nodes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#three-input-paradigms" class="md-nav__link">
    <span class="md-ellipsis">
      Three input paradigms
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#atomic-updates-with-reducer-and-messageop" class="md-nav__link">
    <span class="md-ellipsis">
      Atomic updates with Reducer and MessageOp
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-graphagent-configuration-options" class="md-nav__link">
    <span class="md-ellipsis">
      3. GraphAgent Configuration Options
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-conditional-routing" class="md-nav__link">
    <span class="md-ellipsis">
      4. Conditional Routing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#41-named-ends-pernode-ends" class="md-nav__link">
    <span class="md-ellipsis">
      4.1 Named Ends (Per‑node Ends)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-tool-node-integration" class="md-nav__link">
    <span class="md-ellipsis">
      5. Tool Node Integration
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5. Tool Node Integration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#placeholder-variables-in-llm-instructions" class="md-nav__link">
    <span class="md-ellipsis">
      Placeholder Variables in LLM Instructions
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6-node-retry-backoff" class="md-nav__link">
    <span class="md-ellipsis">
      6. Node Retry &amp; Backoff
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#7-runner-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      7. Runner Configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#8-message-state-schema" class="md-nav__link">
    <span class="md-ellipsis">
      8. Message State Schema
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#9-state-key-usage-scenarios" class="md-nav__link">
    <span class="md-ellipsis">
      9. State Key Usage Scenarios
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#advanced-features" class="md-nav__link">
    <span class="md-ellipsis">
      Advanced Features
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Advanced Features">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-interrupt-and-resume-human-in-the-loop" class="md-nav__link">
    <span class="md-ellipsis">
      1. Interrupt and Resume (Human-in-the-Loop)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1. Interrupt and Resume (Human-in-the-Loop)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#basic-usage" class="md-nav__link">
    <span class="md-ellipsis">
      Basic Usage
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution" class="md-nav__link">
    <span class="md-ellipsis">
      Execution
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#graphagent-options" class="md-nav__link">
    <span class="md-ellipsis">
      GraphAgent Options
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#core-concepts_1" class="md-nav__link">
    <span class="md-ellipsis">
      Core Concepts
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Core Concepts">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#state-management" class="md-nav__link">
    <span class="md-ellipsis">
      State Management
    </span>
  </a>
  
    <nav class="md-nav" aria-label="State Management">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#builtin-schema" class="md-nav__link">
    <span class="md-ellipsis">
      Built‑in Schema
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#custom-schema" class="md-nav__link">
    <span class="md-ellipsis">
      Custom Schema
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#node-types" class="md-nav__link">
    <span class="md-ellipsis">
      Node Types
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Node Types">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#function-node" class="md-nav__link">
    <span class="md-ellipsis">
      Function Node
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llm-node" class="md-nav__link">
    <span class="md-ellipsis">
      LLM Node
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#node-cache" class="md-nav__link">
    <span class="md-ellipsis">
      Node Cache
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Node Cache">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tools-node" class="md-nav__link">
    <span class="md-ellipsis">
      Tools Node
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reading-tool-results-into-state" class="md-nav__link">
    <span class="md-ellipsis">
      Reading Tool Results into State
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#edges-and-routing" class="md-nav__link">
    <span class="md-ellipsis">
      Edges and Routing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#command-mode-dynamic-routing-fanout" class="md-nav__link">
    <span class="md-ellipsis">
      Command Mode (Dynamic Routing / Fan‑out)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#architecture" class="md-nav__link">
    <span class="md-ellipsis">
      Architecture
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Architecture">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overall-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      Overall Architecture
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#core-modules" class="md-nav__link">
    <span class="md-ellipsis">
      Core Modules
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution-model" class="md-nav__link">
    <span class="md-ellipsis">
      Execution Model
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Execution Model">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#runtime-isolation-and-event-snapshots" class="md-nav__link">
    <span class="md-ellipsis">
      Runtime Isolation and Event Snapshots
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#executor-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Executor Configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#defaults-and-notes" class="md-nav__link">
    <span class="md-ellipsis">
      Defaults and Notes
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#integrating-with-multiagent-systems" class="md-nav__link">
    <span class="md-ellipsis">
      Integrating with Multi‑Agent Systems
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Integrating with Multi‑Agent Systems">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#graphagent-as-an-agent" class="md-nav__link">
    <span class="md-ellipsis">
      GraphAgent as an Agent
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#advanced-orchestration" class="md-nav__link">
    <span class="md-ellipsis">
      Advanced Orchestration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#embedding-agents-in-a-graph" class="md-nav__link">
    <span class="md-ellipsis">
      Embedding Agents in a Graph
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Embedding Agents in a Graph">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#passing-only-results-map-last_response-to-downstream-user_input" class="md-nav__link">
    <span class="md-ellipsis">
      Passing only results: map last_response to downstream user_input
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hybrid-pattern-example" class="md-nav__link">
    <span class="md-ellipsis">
      Hybrid Pattern Example
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#core-mechanics-in-depth" class="md-nav__link">
    <span class="md-ellipsis">
      Core Mechanics in Depth
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Core Mechanics in Depth">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#state-management-schema-reducer" class="md-nav__link">
    <span class="md-ellipsis">
      State Management: Schema + Reducer
    </span>
  </a>
  
    <nav class="md-nav" aria-label="State Management: Schema + Reducer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#common-state-keys" class="md-nav__link">
    <span class="md-ellipsis">
      Common State Keys
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nodelevel-callbacks-generation-parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Node‑level Callbacks &amp; Generation Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llm-input-rules-threestage-design" class="md-nav__link">
    <span class="md-ellipsis">
      LLM Input Rules: Three‑Stage Design
    </span>
  </a>
  
    <nav class="md-nav" aria-label="LLM Input Rules: Three‑Stage Design">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#instruction-placeholder-injection" class="md-nav__link">
    <span class="md-ellipsis">
      Instruction Placeholder Injection
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#concurrency-and-state-safety" class="md-nav__link">
    <span class="md-ellipsis">
      Concurrency and State Safety
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#node-io-conventions_1" class="md-nav__link">
    <span class="md-ellipsis">
      Node I/O Conventions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#api-cheat-sheet" class="md-nav__link">
    <span class="md-ellipsis">
      API Cheat Sheet
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#visualization-dotimage" class="md-nav__link">
    <span class="md-ellipsis">
      Visualization (DOT/Image)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#advanced-features_1" class="md-nav__link">
    <span class="md-ellipsis">
      Advanced Features
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Advanced Features">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#checkpoints-and-recovery" class="md-nav__link">
    <span class="md-ellipsis">
      Checkpoints and Recovery
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Checkpoints and Recovery">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#checkpoint-management" class="md-nav__link">
    <span class="md-ellipsis">
      Checkpoint Management
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#events-at-a-glance" class="md-nav__link">
    <span class="md-ellipsis">
      Events at a Glance
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#humanintheloop" class="md-nav__link">
    <span class="md-ellipsis">
      Human‑in‑the‑Loop
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#event-monitoring" class="md-nav__link">
    <span class="md-ellipsis">
      Event Monitoring
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Event Monitoring">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#event-metadata-statedelta" class="md-nav__link">
    <span class="md-ellipsis">
      Event Metadata (StateDelta)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#emit-selected-values-from-node-callbacks" class="md-nav__link">
    <span class="md-ellipsis">
      Emit selected values from node callbacks
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#troubleshooting" class="md-nav__link">
    <span class="md-ellipsis">
      Troubleshooting
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#realworld-example" class="md-nav__link">
    <span class="md-ellipsis">
      Real‑World Example
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Real‑World Example">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#approval-workflow" class="md-nav__link">
    <span class="md-ellipsis">
      Approval Workflow
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    <span class="md-ellipsis">
      Summary
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references-examples" class="md-nav__link">
    <span class="md-ellipsis">
      References &amp; Examples
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../custom-agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Custom Agent
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../runner/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Runner
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../model/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Model
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../callbacks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Callbacks
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../memory/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Memory
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../artifact/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Artifact
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tool/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Tool
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../session/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Session
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../knowledge/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Knowledge
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../planner/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Planner
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../event/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Event
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Server
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Server
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../debugserver/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Debug
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../agui/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    AG-UI
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../a2a/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    A2A
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../observability/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Observability
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../ecosystem/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Ecosystem
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    <span class="md-ellipsis">
      Overview
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#quick-start" class="md-nav__link">
    <span class="md-ellipsis">
      Quick Start
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Quick Start">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#minimal-workflow" class="md-nav__link">
    <span class="md-ellipsis">
      Minimal Workflow
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#usage-pattern" class="md-nav__link">
    <span class="md-ellipsis">
      Usage Pattern
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agent-integration" class="md-nav__link">
    <span class="md-ellipsis">
      Agent Integration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#key-features" class="md-nav__link">
    <span class="md-ellipsis">
      Key Features
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#core-concepts" class="md-nav__link">
    <span class="md-ellipsis">
      Core Concepts
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Core Concepts">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-graph" class="md-nav__link">
    <span class="md-ellipsis">
      1. Graph
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-node" class="md-nav__link">
    <span class="md-ellipsis">
      2. Node
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-state" class="md-nav__link">
    <span class="md-ellipsis">
      3. State
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-state-schema" class="md-nav__link">
    <span class="md-ellipsis">
      4. State Schema
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#usage-guide" class="md-nav__link">
    <span class="md-ellipsis">
      Usage Guide
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Usage Guide">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#node-io-conventions" class="md-nav__link">
    <span class="md-ellipsis">
      Node I/O Conventions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Node I/O Conventions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#constant-references-import-and-keys" class="md-nav__link">
    <span class="md-ellipsis">
      Constant references (import and keys)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#event-metadata-keys-statedelta" class="md-nav__link">
    <span class="md-ellipsis">
      Event metadata keys (StateDelta)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1-creating-graphagent-and-runner" class="md-nav__link">
    <span class="md-ellipsis">
      1. Creating GraphAgent and Runner
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-using-llm-nodes" class="md-nav__link">
    <span class="md-ellipsis">
      2. Using LLM Nodes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. Using LLM Nodes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#three-input-paradigms" class="md-nav__link">
    <span class="md-ellipsis">
      Three input paradigms
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#atomic-updates-with-reducer-and-messageop" class="md-nav__link">
    <span class="md-ellipsis">
      Atomic updates with Reducer and MessageOp
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-graphagent-configuration-options" class="md-nav__link">
    <span class="md-ellipsis">
      3. GraphAgent Configuration Options
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-conditional-routing" class="md-nav__link">
    <span class="md-ellipsis">
      4. Conditional Routing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#41-named-ends-pernode-ends" class="md-nav__link">
    <span class="md-ellipsis">
      4.1 Named Ends (Per‑node Ends)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-tool-node-integration" class="md-nav__link">
    <span class="md-ellipsis">
      5. Tool Node Integration
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5. Tool Node Integration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#placeholder-variables-in-llm-instructions" class="md-nav__link">
    <span class="md-ellipsis">
      Placeholder Variables in LLM Instructions
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6-node-retry-backoff" class="md-nav__link">
    <span class="md-ellipsis">
      6. Node Retry &amp; Backoff
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#7-runner-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      7. Runner Configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#8-message-state-schema" class="md-nav__link">
    <span class="md-ellipsis">
      8. Message State Schema
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#9-state-key-usage-scenarios" class="md-nav__link">
    <span class="md-ellipsis">
      9. State Key Usage Scenarios
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#advanced-features" class="md-nav__link">
    <span class="md-ellipsis">
      Advanced Features
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Advanced Features">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-interrupt-and-resume-human-in-the-loop" class="md-nav__link">
    <span class="md-ellipsis">
      1. Interrupt and Resume (Human-in-the-Loop)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1. Interrupt and Resume (Human-in-the-Loop)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#basic-usage" class="md-nav__link">
    <span class="md-ellipsis">
      Basic Usage
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution" class="md-nav__link">
    <span class="md-ellipsis">
      Execution
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#graphagent-options" class="md-nav__link">
    <span class="md-ellipsis">
      GraphAgent Options
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#core-concepts_1" class="md-nav__link">
    <span class="md-ellipsis">
      Core Concepts
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Core Concepts">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#state-management" class="md-nav__link">
    <span class="md-ellipsis">
      State Management
    </span>
  </a>
  
    <nav class="md-nav" aria-label="State Management">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#builtin-schema" class="md-nav__link">
    <span class="md-ellipsis">
      Built‑in Schema
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#custom-schema" class="md-nav__link">
    <span class="md-ellipsis">
      Custom Schema
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#node-types" class="md-nav__link">
    <span class="md-ellipsis">
      Node Types
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Node Types">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#function-node" class="md-nav__link">
    <span class="md-ellipsis">
      Function Node
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llm-node" class="md-nav__link">
    <span class="md-ellipsis">
      LLM Node
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#node-cache" class="md-nav__link">
    <span class="md-ellipsis">
      Node Cache
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Node Cache">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tools-node" class="md-nav__link">
    <span class="md-ellipsis">
      Tools Node
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reading-tool-results-into-state" class="md-nav__link">
    <span class="md-ellipsis">
      Reading Tool Results into State
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#edges-and-routing" class="md-nav__link">
    <span class="md-ellipsis">
      Edges and Routing
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#command-mode-dynamic-routing-fanout" class="md-nav__link">
    <span class="md-ellipsis">
      Command Mode (Dynamic Routing / Fan‑out)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#architecture" class="md-nav__link">
    <span class="md-ellipsis">
      Architecture
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Architecture">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overall-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      Overall Architecture
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#core-modules" class="md-nav__link">
    <span class="md-ellipsis">
      Core Modules
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#execution-model" class="md-nav__link">
    <span class="md-ellipsis">
      Execution Model
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Execution Model">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#runtime-isolation-and-event-snapshots" class="md-nav__link">
    <span class="md-ellipsis">
      Runtime Isolation and Event Snapshots
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#executor-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Executor Configuration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#defaults-and-notes" class="md-nav__link">
    <span class="md-ellipsis">
      Defaults and Notes
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#integrating-with-multiagent-systems" class="md-nav__link">
    <span class="md-ellipsis">
      Integrating with Multi‑Agent Systems
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Integrating with Multi‑Agent Systems">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#graphagent-as-an-agent" class="md-nav__link">
    <span class="md-ellipsis">
      GraphAgent as an Agent
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#advanced-orchestration" class="md-nav__link">
    <span class="md-ellipsis">
      Advanced Orchestration
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#embedding-agents-in-a-graph" class="md-nav__link">
    <span class="md-ellipsis">
      Embedding Agents in a Graph
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Embedding Agents in a Graph">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#passing-only-results-map-last_response-to-downstream-user_input" class="md-nav__link">
    <span class="md-ellipsis">
      Passing only results: map last_response to downstream user_input
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hybrid-pattern-example" class="md-nav__link">
    <span class="md-ellipsis">
      Hybrid Pattern Example
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#core-mechanics-in-depth" class="md-nav__link">
    <span class="md-ellipsis">
      Core Mechanics in Depth
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Core Mechanics in Depth">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#state-management-schema-reducer" class="md-nav__link">
    <span class="md-ellipsis">
      State Management: Schema + Reducer
    </span>
  </a>
  
    <nav class="md-nav" aria-label="State Management: Schema + Reducer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#common-state-keys" class="md-nav__link">
    <span class="md-ellipsis">
      Common State Keys
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nodelevel-callbacks-generation-parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Node‑level Callbacks &amp; Generation Parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llm-input-rules-threestage-design" class="md-nav__link">
    <span class="md-ellipsis">
      LLM Input Rules: Three‑Stage Design
    </span>
  </a>
  
    <nav class="md-nav" aria-label="LLM Input Rules: Three‑Stage Design">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#instruction-placeholder-injection" class="md-nav__link">
    <span class="md-ellipsis">
      Instruction Placeholder Injection
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#concurrency-and-state-safety" class="md-nav__link">
    <span class="md-ellipsis">
      Concurrency and State Safety
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#node-io-conventions_1" class="md-nav__link">
    <span class="md-ellipsis">
      Node I/O Conventions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#api-cheat-sheet" class="md-nav__link">
    <span class="md-ellipsis">
      API Cheat Sheet
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#visualization-dotimage" class="md-nav__link">
    <span class="md-ellipsis">
      Visualization (DOT/Image)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#advanced-features_1" class="md-nav__link">
    <span class="md-ellipsis">
      Advanced Features
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Advanced Features">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#checkpoints-and-recovery" class="md-nav__link">
    <span class="md-ellipsis">
      Checkpoints and Recovery
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Checkpoints and Recovery">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#checkpoint-management" class="md-nav__link">
    <span class="md-ellipsis">
      Checkpoint Management
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#events-at-a-glance" class="md-nav__link">
    <span class="md-ellipsis">
      Events at a Glance
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#humanintheloop" class="md-nav__link">
    <span class="md-ellipsis">
      Human‑in‑the‑Loop
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#event-monitoring" class="md-nav__link">
    <span class="md-ellipsis">
      Event Monitoring
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Event Monitoring">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#event-metadata-statedelta" class="md-nav__link">
    <span class="md-ellipsis">
      Event Metadata (StateDelta)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#emit-selected-values-from-node-callbacks" class="md-nav__link">
    <span class="md-ellipsis">
      Emit selected values from node callbacks
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#troubleshooting" class="md-nav__link">
    <span class="md-ellipsis">
      Troubleshooting
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#realworld-example" class="md-nav__link">
    <span class="md-ellipsis">
      Real‑World Example
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Real‑World Example">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#approval-workflow" class="md-nav__link">
    <span class="md-ellipsis">
      Approval Workflow
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#summary" class="md-nav__link">
    <span class="md-ellipsis">
      Summary
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#references-examples" class="md-nav__link">
    <span class="md-ellipsis">
      References &amp; Examples
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
    <a href="https://github.com/trpc-group/trpc-agent-go/edit/main/docs/mkdocs/en/graph.md" title="Edit this page" class="md-content__button md-icon" rel="edit">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg>
    </a>
  
  
    
      
    
    <a href="https://github.com/trpc-group/trpc-agent-go/raw/main/docs/mkdocs/en/graph.md" title="View source of this page" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 18c.56 0 1 .44 1 1s-.44 1-1 1-1-.44-1-1 .44-1 1-1m0-3c-2.73 0-5.06 1.66-6 4 .94 2.34 3.27 4 6 4s5.06-1.66 6-4c-.94-2.34-3.27-4-6-4m0 6.5a2.5 2.5 0 0 1-2.5-2.5 2.5 2.5 0 0 1 2.5-2.5 2.5 2.5 0 0 1 2.5 2.5 2.5 2.5 0 0 1-2.5 2.5M9.27 20H6V4h7v5h5v4.07c.7.08 1.36.25 2 .49V8l-6-6H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h4.5a8.2 8.2 0 0 1-1.23-2"/></svg>
    </a>
  


<h1 id="graph-package-guide">Graph Package Guide</h1>
<h2 id="overview">Overview</h2>
<p>Graph combines controllable workflow orchestration with extensible agent capabilities. It is suitable for:
- Type-safe state management and predictable routing.
- LLM decision making, tool-calling loops, and optional Human in the Loop (HITL).
- Reusable components that can run standalone or be composed as sub‑agents.</p>
<p>Highlights:
- Schema‑driven State and Reducers to avoid data races when concurrent branches write the same field.
- Deterministic parallelism with BSP style (Plan / Execute / Update).
- Built‑in node types wrap LLM, Tools, and Agent to reduce boilerplate.
- Streaming events, checkpoints, and interrupts for observability and recovery.
- Node‑level retry/backoff with exponential delay and jitter, plus executor‑level defaults and rich retry metadata in events.</p>
<h2 id="quick-start">Quick Start</h2>
<h3 id="minimal-workflow">Minimal Workflow</h3>
<p>Below is a classic “prepare → ask LLM → optionally call tools” loop using <code>graph.MessagesStateSchema()</code> (predefines <code>graph.StateKeyMessages</code>, <code>graph.StateKeyUserInput</code>, <code>graph.StateKeyLastResponse</code>, etc.).</p>
<pre class="mermaid"><code>flowchart LR
    START([start]):::startNode --&gt; P[prepare]:::processNode
    P --&gt; A[ask LLM]:::llmNode
    A -. tool_calls .-&gt; T[tools]:::toolNode
    A -- no tool_calls --&gt; F[fallback]:::processNode
    T --&gt; A
    F --&gt; END([finish]):::endNode

    classDef startNode fill:#e1f5e1,stroke:#4caf50,stroke-width:2px
    classDef endNode fill:#ffe1e1,stroke:#f44336,stroke-width:2px
    classDef llmNode fill:#e3f2fd,stroke:#2196f3,stroke-width:2px
    classDef toolNode fill:#fff3e0,stroke:#ff9800,stroke-width:2px
    classDef processNode fill:#f3e5f5,stroke:#9c27b0,stroke-width:2px</code></pre>
<p>The Graph package allows you to model complex AI workflows as directed graphs, where nodes represent processing steps and edges represent data flow and control flow. It is particularly suitable for building AI applications that require conditional routing, state management, and multi-step processing.</p>
<h3 id="usage-pattern">Usage Pattern</h3>
<p>The usage of the Graph package follows this pattern:</p>
<ol>
<li><strong>Create Graph</strong>: Use <code>StateGraph</code> builder to define workflow structure</li>
<li><strong>Create GraphAgent</strong>: Wrap the compiled Graph as an Agent</li>
<li><strong>Create Runner</strong>: Use Runner to manage sessions and execution environment</li>
<li><strong>Execute Workflow</strong>: Execute workflow through Runner and handle results</li>
</ol>
<p>This pattern provides:</p>
<ul>
<li><strong>Type Safety</strong>: Ensures data consistency through state schema</li>
<li><strong>Session Management</strong>: Supports concurrent execution for multiple users and sessions</li>
<li><strong>Event Stream</strong>: Real-time monitoring of workflow execution progress</li>
<li><strong>Error Handling</strong>: Unified error handling and recovery mechanisms</li>
</ul>
<h3 id="agent-integration">Agent Integration</h3>
<p>GraphAgent implements the <code>agent.Agent</code> interface and can:</p>
<ul>
<li><strong>Act as Independent Agent</strong>: Execute directly through Runner</li>
<li><strong>Act as SubAgent</strong>: Be used as a sub-agent by other Agents (such as LLMAgent)</li>
<li><strong>Host SubAgents</strong>: Register child agents via <code>graphagent.WithSubAgents</code> and invoke them through <code>AddAgentNode</code></li>
</ul>
<p>This design lets GraphAgent plug into other agents while orchestrating its own specialized sub-agents.</p>
<h3 id="key-features">Key Features</h3>
<ul>
<li><strong>Type-safe state management</strong>: Use Schema to define state structure, support custom Reducers</li>
<li><strong>Conditional routing</strong>: Dynamically select execution paths based on state</li>
<li><strong>LLM node integration</strong>: Built-in support for large language models</li>
<li><strong>Tool nodes</strong>: Support function calls and external tool integration</li>
<li><strong>Agent nodes</strong>: Delegate parts of the workflow to registered sub-agents</li>
<li><strong>Streaming execution</strong>: Support real-time event streams and progress tracking</li>
<li><strong>Concurrency safety</strong>: Thread-safe graph execution</li>
<li><strong>Checkpoint-based Time Travel</strong>: Navigate through execution history and restore previous states</li>
<li><strong>Human-in-the-Loop (HITL)</strong>: Support for interactive workflows with interrupt and resume capabilities</li>
<li><strong>Atomic checkpointing</strong>: Atomic storage of checkpoints with pending writes for reliable recovery</li>
<li><strong>Checkpoint Lineage</strong>: Track related checkpoints forming execution threads with parent-child relationships</li>
</ul>
<h2 id="core-concepts">Core Concepts</h2>
<h3 id="1-graph">1. Graph</h3>
<p>A graph is the core structure of a workflow, consisting of nodes and edges:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span>
<span class="normal"><a href="#__codelineno-0-2">2</a></span>
<span class="normal"><a href="#__codelineno-0-3">3</a></span>
<span class="normal"><a href="#__codelineno-0-4">4</a></span>
<span class="normal"><a href="#__codelineno-0-5">5</a></span>
<span class="normal"><a href="#__codelineno-0-6">6</a></span>
<span class="normal"><a href="#__codelineno-0-7">7</a></span>
<span class="normal"><a href="#__codelineno-0-8">8</a></span>
<span class="normal"><a href="#__codelineno-0-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="p">)</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4"></a>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="c1">// Create state schema.</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="nx">schema</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateSchema</span><span class="p">()</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7"></a>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="c1">// Create graph.</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="nx">graph</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="nx">schema</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p><strong>Virtual Nodes</strong>:</p>
<ul>
<li><code>Start</code>: Virtual start node, automatically connected through <code>SetEntryPoint()</code></li>
<li><code>End</code>: Virtual end node, automatically connected through <code>SetFinishPoint()</code></li>
<li>These nodes don't need to be explicitly created, the system automatically handles connections</li>
</ul>
<h3 id="2-node">2. Node</h3>
<p>A node represents a processing step in the workflow:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-1-10">10</a></span>
<span class="normal"><a href="#__codelineno-1-11">11</a></span>
<span class="normal"><a href="#__codelineno-1-12">12</a></span>
<span class="normal"><a href="#__codelineno-1-13">13</a></span>
<span class="normal"><a href="#__codelineno-1-14">14</a></span>
<span class="normal"><a href="#__codelineno-1-15">15</a></span>
<span class="normal"><a href="#__codelineno-1-16">16</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="w">    </span><span class="s">&quot;context&quot;</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3"></a>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="p">)</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6"></a>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="c1">// Node function signature.</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="kd">type</span><span class="w"> </span><span class="nx">NodeFunc</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9"></a>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="c1">// Create node.</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="nx">node</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">graph</span><span class="p">.</span><span class="nx">Node</span><span class="p">{</span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="w">    </span><span class="nx">ID</span><span class="p">:</span><span class="w">          </span><span class="s">&quot;process_data&quot;</span><span class="p">,</span>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="w">    </span><span class="nx">Name</span><span class="p">:</span><span class="w">        </span><span class="s">&quot;Data Processing&quot;</span><span class="p">,</span>
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14"></a><span class="w">    </span><span class="nx">Description</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Process input data&quot;</span><span class="p">,</span>
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="w">    </span><span class="nx">Function</span><span class="p">:</span><span class="w">    </span><span class="nx">processDataFunc</span><span class="p">,</span>
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="3-state">3. State</h3>
<p>State is a data container passed between nodes:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-2-10">10</a></span>
<span class="normal"><a href="#__codelineno-2-11">11</a></span>
<span class="normal"><a href="#__codelineno-2-12">12</a></span>
<span class="normal"><a href="#__codelineno-2-13">13</a></span>
<span class="normal"><a href="#__codelineno-2-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="p">)</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4"></a>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="c1">// State is a key-value pair mapping.</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="kd">type</span><span class="w"> </span><span class="nx">State</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">any</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7"></a>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="c1">// User-defined state keys.</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10"></a><span class="w">    </span><span class="nx">StateKeyInput</span><span class="w">         </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;input&quot;</span><span class="w">          </span><span class="c1">// Input data.</span>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11"></a><span class="w">    </span><span class="nx">StateKeyResult</span><span class="w">        </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;result&quot;</span><span class="w">         </span><span class="c1">// Processing result.</span>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12"></a><span class="w">    </span><span class="nx">StateKeyProcessedData</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;processed_data&quot;</span><span class="w"> </span><span class="c1">// Processed data.</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13"></a><span class="w">    </span><span class="nx">StateKeyStatus</span><span class="w">        </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;status&quot;</span><span class="w">         </span><span class="c1">// Processing status.</span>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14"></a><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p><strong>Built-in State Keys</strong>:</p>
<p>The Graph package provides some built-in state keys, mainly for internal system communication:</p>
<p><strong>User-accessible Built-in Keys</strong>:</p>
<ul>
<li><code>StateKeyUserInput</code>: User input (one-shot, cleared after consumption, persisted by LLM nodes)</li>
<li><code>StateKeyOneShotMessages</code>: One-shot messages (complete override for current round, cleared after consumption)</li>
<li><code>StateKeyLastResponse</code>: Last response (used to set final output, Executor reads this value as result)</li>
<li><code>StateKeyMessages</code>: Message history (durable, supports append + MessageOp patch operations)</li>
<li><code>StateKeyNodeResponses</code>: Per-node responses map. Key is node ID, value is the
  node's final textual response. Use <code>StateKeyLastResponse</code> for the final
  serial output; when multiple parallel nodes converge, read each node's
  output from <code>StateKeyNodeResponses</code>.</li>
<li><code>StateKeyMetadata</code>: Metadata (general metadata storage available to users)</li>
</ul>
<p><strong>System Internal Keys</strong> (users should not use directly):</p>
<ul>
<li><code>StateKeySession</code>: Session information (automatically set by GraphAgent)</li>
<li><code>StateKeyExecContext</code>: Execution context (automatically set by Executor)</li>
<li><code>StateKeyToolCallbacks</code>: Tool callbacks (automatically set by Executor)</li>
<li><code>StateKeyModelCallbacks</code>: Model callbacks (automatically set by Executor)</li>
</ul>
<p>Users should use custom state keys to store business data, and only use user-accessible built-in state keys when necessary.</p>
<h3 id="4-state-schema">4. State Schema</h3>
<p>State schema defines the structure and behavior of state:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-3-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-3-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-3-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-3-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-3-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-3-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-3-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-3-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-3-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-3-10">10</a></span>
<span class="normal"><a href="#__codelineno-3-11">11</a></span>
<span class="normal"><a href="#__codelineno-3-12">12</a></span>
<span class="normal"><a href="#__codelineno-3-13">13</a></span>
<span class="normal"><a href="#__codelineno-3-14">14</a></span>
<span class="normal"><a href="#__codelineno-3-15">15</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="w">    </span><span class="s">&quot;reflect&quot;</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3"></a>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="p">)</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6"></a>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="c1">// Create state schema.</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8"></a><span class="nx">schema</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateSchema</span><span class="p">()</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9"></a>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10"></a><span class="c1">// Add field definitions.</span>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11"></a><span class="nx">schema</span><span class="p">.</span><span class="nx">AddField</span><span class="p">(</span><span class="s">&quot;counter&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateField</span><span class="p">{</span>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12"></a><span class="w">    </span><span class="nx">Type</span><span class="p">:</span><span class="w">    </span><span class="nx">reflect</span><span class="p">.</span><span class="nx">TypeOf</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13"></a><span class="w">    </span><span class="nx">Reducer</span><span class="p">:</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">DefaultReducer</span><span class="p">,</span>
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14"></a><span class="w">    </span><span class="nx">Default</span><span class="p">:</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="kt">any</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">},</span>
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15"></a><span class="p">})</span>
</span></code></pre></div></td></tr></table></div>
<h2 id="usage-guide">Usage Guide</h2>
<h3 id="node-io-conventions">Node I/O Conventions</h3>
<p>Nodes communicate exclusively through the shared state. Each node returns a state delta which is merged into the graph state using the schema’s reducers. Downstream nodes read whatever upstream nodes wrote.</p>
<ul>
<li>Common built‑in keys (user‑facing)<ul>
<li><code>user_input</code>: One‑shot input for the next LLM/Agent node. Cleared after consumption.</li>
<li><code>one_shot_messages</code>: Full message override for the next LLM call. Cleared after consumption.</li>
<li><code>messages</code>: Durable conversation history (LLM/Tools append here). Supports MessageOp patches.</li>
<li><code>last_response</code>: The last textual assistant response.</li>
<li><code>node_responses</code>: Map[nodeID]any — per‑node final textual response. Use <code>last_response</code> for the most recent.</li>
</ul>
</li>
</ul>
<ul>
<li>Function node<ul>
<li>Input: the entire state</li>
<li>Output: return a <code>graph.State</code> delta with custom keys (declare them in the schema), e.g. <code>{"parsed_time": "..."}</code></li>
</ul>
</li>
</ul>
<ul>
<li>LLM node<ul>
<li>Input priority: <code>one_shot_messages</code> → <code>user_input</code> → <code>messages</code></li>
<li>Output:<ul>
<li>Appends assistant message to <code>messages</code></li>
<li>Sets <code>last_response</code></li>
<li>Sets <code>node_responses[&lt;llm_node_id&gt;]</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li>Tools node<ul>
<li>Input: scans <code>messages</code> for the latest assistant message with <code>tool_calls</code></li>
<li>Output: appends tool responses to <code>messages</code></li>
</ul>
</li>
</ul>
<ul>
<li>Agent node (sub‑agent)<ul>
<li>Input: state is injected into the sub‑agent’s <code>Invocation.RunOptions.RuntimeState</code>.<ul>
<li>Model/Tool callbacks can access it via <code>agent.InvocationFromContext(ctx)</code>.</li>
</ul>
</li>
<li>Output on finish:<ul>
<li>Sets <code>last_response</code></li>
<li>Sets <code>node_responses[&lt;agent_node_id&gt;]</code></li>
<li>Clears <code>user_input</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>Recommended patterns</p>
<ul>
<li>Add your own keys in the schema (e.g., <code>parsed_time</code>, <code>final_payload</code>) and write/read them in function nodes.</li>
<li>To feed structured hints into an LLM node, write <code>one_shot_messages</code> in the previous node (e.g., prepend a system message with parsed context).</li>
<li>To consume an upstream node’s text, read <code>last_response</code> immediately downstream or fetch from <code>node_responses[that_node_id]</code> later.</li>
</ul>
<p>See examples:</p>
<ul>
<li><code>examples/graph/io_conventions</code> — Function + LLM + Agent I/O</li>
<li><code>examples/graph/io_conventions_tools</code> — Adds a Tools node path and shows how to capture tool JSON</li>
<li><code>examples/graph/retry</code> — Node-level retry/backoff demonstration</li>
</ul>
<h4 id="constant-references-import-and-keys">Constant references (import and keys)</h4>
<ul>
<li>Import: <code>import "trpc.group/trpc-go/trpc-agent-go/graph"</code></li>
<li>Defined in: <code>graph/state.go</code></li>
</ul>
<ul>
<li>User‑facing keys<ul>
<li><code>user_input</code> → <code>graph.StateKeyUserInput</code></li>
<li><code>one_shot_messages</code> → <code>graph.StateKeyOneShotMessages</code></li>
<li><code>messages</code> → <code>graph.StateKeyMessages</code></li>
<li><code>last_response</code> → <code>graph.StateKeyLastResponse</code></li>
<li><code>node_responses</code> → <code>graph.StateKeyNodeResponses</code></li>
</ul>
</li>
</ul>
<ul>
<li>Other useful keys<ul>
<li><code>session</code> → <code>graph.StateKeySession</code></li>
<li><code>metadata</code> → <code>graph.StateKeyMetadata</code></li>
<li><code>current_node_id</code> → <code>graph.StateKeyCurrentNodeID</code></li>
<li><code>exec_context</code> → <code>graph.StateKeyExecContext</code></li>
<li><code>tool_callbacks</code> → <code>graph.StateKeyToolCallbacks</code></li>
<li><code>model_callbacks</code> → <code>graph.StateKeyModelCallbacks</code></li>
<li><code>agent_callbacks</code> → <code>graph.StateKeyAgentCallbacks</code></li>
<li><code>parent_agent</code> → <code>graph.StateKeyParentAgent</code></li>
</ul>
</li>
</ul>
<p>Snippet:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-4-1">1</a></span>
<span class="normal"><a href="#__codelineno-4-2">2</a></span>
<span class="normal"><a href="#__codelineno-4-3">3</a></span>
<span class="normal"><a href="#__codelineno-4-4">4</a></span>
<span class="normal"><a href="#__codelineno-4-5">5</a></span>
<span class="normal"><a href="#__codelineno-4-6">6</a></span>
<span class="normal"><a href="#__codelineno-4-7">7</a></span>
<span class="normal"><a href="#__codelineno-4-8">8</a></span>
<span class="normal"><a href="#__codelineno-4-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="w">    </span><span class="s">&quot;context&quot;</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="p">)</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5"></a>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="kd">func</span><span class="w"> </span><span class="nx">myNode</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7"></a><span class="w">    </span><span class="nx">last</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">state</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyLastResponse</span><span class="p">].(</span><span class="kt">string</span><span class="p">)</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="s">&quot;my_key&quot;</span><span class="p">:</span><span class="w"> </span><span class="nx">last</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<h4 id="event-metadata-keys-statedelta">Event metadata keys (StateDelta)</h4>
<ul>
<li>Import: <code>import "trpc.group/trpc-go/trpc-agent-go/graph"</code></li>
<li>Defined in: <code>graph/events.go</code></li>
</ul>
<ul>
<li>Model metadata: <code>_model_metadata</code> → <code>graph.MetadataKeyModel</code> (struct <code>graph.ModelExecutionMetadata</code>)</li>
<li>Tool metadata: <code>_tool_metadata</code> → <code>graph.MetadataKeyTool</code> (struct <code>graph.ToolExecutionMetadata</code>)</li>
<li>Node metadata: <code>_node_metadata</code> → <code>graph.MetadataKeyNode</code> (struct <code>graph.NodeExecutionMetadata</code>). Includes retry info: <code>Attempt</code>, <code>MaxAttempts</code>, <code>NextDelay</code>, <code>Retrying</code> and timing fields.</li>
</ul>
<p>Snippet:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-5-1">1</a></span>
<span class="normal"><a href="#__codelineno-5-2">2</a></span>
<span class="normal"><a href="#__codelineno-5-3">3</a></span>
<span class="normal"><a href="#__codelineno-5-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="k">if</span><span class="w"> </span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">event</span><span class="p">.</span><span class="nx">StateDelta</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">MetadataKeyModel</span><span class="p">];</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">md</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">ModelExecutionMetadata</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="w">    </span><span class="nx">_</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">json</span><span class="p">.</span><span class="nx">Unmarshal</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">md</span><span class="p">)</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="1-creating-graphagent-and-runner">1. Creating GraphAgent and Runner</h3>
<p>Users mainly use the Graph package by creating GraphAgent and then using it through Runner. This is the recommended usage pattern:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-6-1">  1</a></span>
<span class="normal"><a href="#__codelineno-6-2">  2</a></span>
<span class="normal"><a href="#__codelineno-6-3">  3</a></span>
<span class="normal"><a href="#__codelineno-6-4">  4</a></span>
<span class="normal"><a href="#__codelineno-6-5">  5</a></span>
<span class="normal"><a href="#__codelineno-6-6">  6</a></span>
<span class="normal"><a href="#__codelineno-6-7">  7</a></span>
<span class="normal"><a href="#__codelineno-6-8">  8</a></span>
<span class="normal"><a href="#__codelineno-6-9">  9</a></span>
<span class="normal"><a href="#__codelineno-6-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-6-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-6-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-6-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-6-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-6-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-6-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-6-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-6-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-6-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-6-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-6-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-6-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-6-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-6-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-6-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-6-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-6-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-6-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-6-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-6-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-6-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-6-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-6-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-6-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-6-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-6-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-6-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-6-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-6-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-6-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-6-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-6-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-6-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-6-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-6-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-6-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-6-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-6-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-6-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-6-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-6-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-6-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-6-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-6-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-6-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-6-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-6-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-6-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-6-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-6-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-6-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-6-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-6-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-6-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-6-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-6-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-6-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-6-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-6-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-6-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-6-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-6-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-6-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-6-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-6-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-6-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-6-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-6-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-6-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-6-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-6-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-6-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-6-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-6-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-6-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-6-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-6-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-6-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-6-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-6-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-6-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-6-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-6-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-6-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-6-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-6-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-6-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-6-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-6-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-6-100">100</a></span>
<span class="normal"><a href="#__codelineno-6-101">101</a></span>
<span class="normal"><a href="#__codelineno-6-102">102</a></span>
<span class="normal"><a href="#__codelineno-6-103">103</a></span>
<span class="normal"><a href="#__codelineno-6-104">104</a></span>
<span class="normal"><a href="#__codelineno-6-105">105</a></span>
<span class="normal"><a href="#__codelineno-6-106">106</a></span>
<span class="normal"><a href="#__codelineno-6-107">107</a></span>
<span class="normal"><a href="#__codelineno-6-108">108</a></span>
<span class="normal"><a href="#__codelineno-6-109">109</a></span>
<span class="normal"><a href="#__codelineno-6-110">110</a></span>
<span class="normal"><a href="#__codelineno-6-111">111</a></span>
<span class="normal"><a href="#__codelineno-6-112">112</a></span>
<span class="normal"><a href="#__codelineno-6-113">113</a></span>
<span class="normal"><a href="#__codelineno-6-114">114</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="kn">package</span><span class="w"> </span><span class="nx">main</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2"></a>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4"></a><span class="w">    </span><span class="s">&quot;context&quot;</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5"></a><span class="w">    </span><span class="s">&quot;fmt&quot;</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6"></a><span class="w">    </span><span class="s">&quot;time&quot;</span>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7"></a>
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/agent/graphagent&quot;</span>
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/event&quot;</span>
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-6-11"><a id="__codelineno-6-11" name="__codelineno-6-11"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/model&quot;</span>
</span><span id="__span-6-12"><a id="__codelineno-6-12" name="__codelineno-6-12"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/runner&quot;</span>
</span><span id="__span-6-13"><a id="__codelineno-6-13" name="__codelineno-6-13"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/session/inmemory&quot;</span>
</span><span id="__span-6-14"><a id="__codelineno-6-14" name="__codelineno-6-14"></a><span class="p">)</span>
</span><span id="__span-6-15"><a id="__codelineno-6-15" name="__codelineno-6-15"></a>
</span><span id="__span-6-16"><a id="__codelineno-6-16" name="__codelineno-6-16"></a><span class="kd">func</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-6-17"><a id="__codelineno-6-17" name="__codelineno-6-17"></a><span class="w">    </span><span class="c1">// 1. Create state schema.</span>
</span><span id="__span-6-18"><a id="__codelineno-6-18" name="__codelineno-6-18"></a><span class="w">    </span><span class="nx">schema</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">MessagesStateSchema</span><span class="p">()</span>
</span><span id="__span-6-19"><a id="__codelineno-6-19" name="__codelineno-6-19"></a>
</span><span id="__span-6-20"><a id="__codelineno-6-20" name="__codelineno-6-20"></a><span class="w">    </span><span class="c1">// 2. Create state graph builder.</span>
</span><span id="__span-6-21"><a id="__codelineno-6-21" name="__codelineno-6-21"></a><span class="w">    </span><span class="nx">stateGraph</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateGraph</span><span class="p">(</span><span class="nx">schema</span><span class="p">)</span>
</span><span id="__span-6-22"><a id="__codelineno-6-22" name="__codelineno-6-22"></a>
</span><span id="__span-6-23"><a id="__codelineno-6-23" name="__codelineno-6-23"></a><span class="w">    </span><span class="c1">// 3. Add nodes.</span>
</span><span id="__span-6-24"><a id="__codelineno-6-24" name="__codelineno-6-24"></a><span class="w">    </span><span class="nx">stateGraph</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;start&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">startNodeFunc</span><span class="p">).</span>
</span><span id="__span-6-25"><a id="__codelineno-6-25" name="__codelineno-6-25"></a><span class="w">        </span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;process&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">processNodeFunc</span><span class="p">)</span>
</span><span id="__span-6-26"><a id="__codelineno-6-26" name="__codelineno-6-26"></a>
</span><span id="__span-6-27"><a id="__codelineno-6-27" name="__codelineno-6-27"></a><span class="w">    </span><span class="c1">// 4. Set edges.</span>
</span><span id="__span-6-28"><a id="__codelineno-6-28" name="__codelineno-6-28"></a><span class="w">    </span><span class="nx">stateGraph</span><span class="p">.</span><span class="nx">AddEdge</span><span class="p">(</span><span class="s">&quot;start&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;process&quot;</span><span class="p">)</span>
</span><span id="__span-6-29"><a id="__codelineno-6-29" name="__codelineno-6-29"></a>
</span><span id="__span-6-30"><a id="__codelineno-6-30" name="__codelineno-6-30"></a><span class="w">    </span><span class="c1">// 5. Set entry point and finish point.</span>
</span><span id="__span-6-31"><a id="__codelineno-6-31" name="__codelineno-6-31"></a><span class="w">    </span><span class="c1">// SetEntryPoint automatically creates edge from virtual Start node to &quot;start&quot; node.</span>
</span><span id="__span-6-32"><a id="__codelineno-6-32" name="__codelineno-6-32"></a><span class="w">    </span><span class="c1">// SetFinishPoint automatically creates edge from &quot;process&quot; node to virtual End node.</span>
</span><span id="__span-6-33"><a id="__codelineno-6-33" name="__codelineno-6-33"></a><span class="w">    </span><span class="nx">stateGraph</span><span class="p">.</span><span class="nx">SetEntryPoint</span><span class="p">(</span><span class="s">&quot;start&quot;</span><span class="p">).</span>
</span><span id="__span-6-34"><a id="__codelineno-6-34" name="__codelineno-6-34"></a><span class="w">        </span><span class="nx">SetFinishPoint</span><span class="p">(</span><span class="s">&quot;process&quot;</span><span class="p">)</span>
</span><span id="__span-6-35"><a id="__codelineno-6-35" name="__codelineno-6-35"></a>
</span><span id="__span-6-36"><a id="__codelineno-6-36" name="__codelineno-6-36"></a><span class="w">    </span><span class="c1">// 6. Compile graph.</span>
</span><span id="__span-6-37"><a id="__codelineno-6-37" name="__codelineno-6-37"></a><span class="w">    </span><span class="nx">compiledGraph</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">stateGraph</span><span class="p">.</span><span class="nx">Compile</span><span class="p">()</span>
</span><span id="__span-6-38"><a id="__codelineno-6-38" name="__codelineno-6-38"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-6-39"><a id="__codelineno-6-39" name="__codelineno-6-39"></a><span class="w">        </span><span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span id="__span-6-40"><a id="__codelineno-6-40" name="__codelineno-6-40"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-6-41"><a id="__codelineno-6-41" name="__codelineno-6-41"></a>
</span><span id="__span-6-42"><a id="__codelineno-6-42" name="__codelineno-6-42"></a><span class="w">    </span><span class="c1">// 7. Create GraphAgent.</span>
</span><span id="__span-6-43"><a id="__codelineno-6-43" name="__codelineno-6-43"></a><span class="w">    </span><span class="nx">graphAgent</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;simple-workflow&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">compiledGraph</span><span class="p">,</span>
</span><span id="__span-6-44"><a id="__codelineno-6-44" name="__codelineno-6-44"></a><span class="w">        </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithDescription</span><span class="p">(</span><span class="s">&quot;Simple workflow example&quot;</span><span class="p">),</span>
</span><span id="__span-6-45"><a id="__codelineno-6-45" name="__codelineno-6-45"></a><span class="w">        </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithInitialState</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{}),</span>
</span><span id="__span-6-46"><a id="__codelineno-6-46" name="__codelineno-6-46"></a><span class="w">    </span><span class="p">)</span>
</span><span id="__span-6-47"><a id="__codelineno-6-47" name="__codelineno-6-47"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-6-48"><a id="__codelineno-6-48" name="__codelineno-6-48"></a><span class="w">        </span><span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span id="__span-6-49"><a id="__codelineno-6-49" name="__codelineno-6-49"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-6-50"><a id="__codelineno-6-50" name="__codelineno-6-50"></a>
</span><span id="__span-6-51"><a id="__codelineno-6-51" name="__codelineno-6-51"></a><span class="w">    </span><span class="c1">// 8. Create session service.</span>
</span><span id="__span-6-52"><a id="__codelineno-6-52" name="__codelineno-6-52"></a><span class="w">    </span><span class="nx">sessionService</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">inmemory</span><span class="p">.</span><span class="nx">NewSessionService</span><span class="p">()</span>
</span><span id="__span-6-53"><a id="__codelineno-6-53" name="__codelineno-6-53"></a>
</span><span id="__span-6-54"><a id="__codelineno-6-54" name="__codelineno-6-54"></a><span class="w">    </span><span class="c1">// 9. Create Runner.</span>
</span><span id="__span-6-55"><a id="__codelineno-6-55" name="__codelineno-6-55"></a><span class="w">    </span><span class="nx">appRunner</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">runner</span><span class="p">.</span><span class="nx">NewRunner</span><span class="p">(</span>
</span><span id="__span-6-56"><a id="__codelineno-6-56" name="__codelineno-6-56"></a><span class="w">        </span><span class="s">&quot;simple-app&quot;</span><span class="p">,</span>
</span><span id="__span-6-57"><a id="__codelineno-6-57" name="__codelineno-6-57"></a><span class="w">        </span><span class="nx">graphAgent</span><span class="p">,</span>
</span><span id="__span-6-58"><a id="__codelineno-6-58" name="__codelineno-6-58"></a><span class="w">        </span><span class="nx">runner</span><span class="p">.</span><span class="nx">WithSessionService</span><span class="p">(</span><span class="nx">sessionService</span><span class="p">),</span>
</span><span id="__span-6-59"><a id="__codelineno-6-59" name="__codelineno-6-59"></a><span class="w">    </span><span class="p">)</span>
</span><span id="__span-6-60"><a id="__codelineno-6-60" name="__codelineno-6-60"></a>
</span><span id="__span-6-61"><a id="__codelineno-6-61" name="__codelineno-6-61"></a><span class="w">    </span><span class="c1">// 10. Execute workflow.</span>
</span><span id="__span-6-62"><a id="__codelineno-6-62" name="__codelineno-6-62"></a><span class="w">    </span><span class="nx">ctx</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Background</span><span class="p">()</span>
</span><span id="__span-6-63"><a id="__codelineno-6-63" name="__codelineno-6-63"></a><span class="w">    </span><span class="nx">userID</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;user&quot;</span>
</span><span id="__span-6-64"><a id="__codelineno-6-64" name="__codelineno-6-64"></a><span class="w">    </span><span class="nx">sessionID</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;session-%d&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">().</span><span class="nx">Unix</span><span class="p">())</span>
</span><span id="__span-6-65"><a id="__codelineno-6-65" name="__codelineno-6-65"></a>
</span><span id="__span-6-66"><a id="__codelineno-6-66" name="__codelineno-6-66"></a><span class="w">    </span><span class="c1">// Create user message (Runner automatically puts message content into StateKeyUserInput).</span>
</span><span id="__span-6-67"><a id="__codelineno-6-67" name="__codelineno-6-67"></a><span class="w">    </span><span class="nx">message</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">model</span><span class="p">.</span><span class="nx">NewUserMessage</span><span class="p">(</span><span class="s">&quot;Hello World&quot;</span><span class="p">)</span>
</span><span id="__span-6-68"><a id="__codelineno-6-68" name="__codelineno-6-68"></a>
</span><span id="__span-6-69"><a id="__codelineno-6-69" name="__codelineno-6-69"></a><span class="w">    </span><span class="c1">// Execute through Runner.</span>
</span><span id="__span-6-70"><a id="__codelineno-6-70" name="__codelineno-6-70"></a><span class="w">    </span><span class="nx">eventChan</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">appRunner</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">userID</span><span class="p">,</span><span class="w"> </span><span class="nx">sessionID</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="p">)</span>
</span><span id="__span-6-71"><a id="__codelineno-6-71" name="__codelineno-6-71"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-6-72"><a id="__codelineno-6-72" name="__codelineno-6-72"></a><span class="w">        </span><span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span id="__span-6-73"><a id="__codelineno-6-73" name="__codelineno-6-73"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-6-74"><a id="__codelineno-6-74" name="__codelineno-6-74"></a>
</span><span id="__span-6-75"><a id="__codelineno-6-75" name="__codelineno-6-75"></a><span class="w">    </span><span class="c1">// Handle event stream.</span>
</span><span id="__span-6-76"><a id="__codelineno-6-76" name="__codelineno-6-76"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">event</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">eventChan</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-6-77"><a id="__codelineno-6-77" name="__codelineno-6-77"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">event</span><span class="p">.</span><span class="nx">Error</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-6-78"><a id="__codelineno-6-78" name="__codelineno-6-78"></a><span class="w">            </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Error: %s\n&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">event</span><span class="p">.</span><span class="nx">Error</span><span class="p">.</span><span class="nx">Message</span><span class="p">)</span>
</span><span id="__span-6-79"><a id="__codelineno-6-79" name="__codelineno-6-79"></a><span class="w">            </span><span class="k">continue</span>
</span><span id="__span-6-80"><a id="__codelineno-6-80" name="__codelineno-6-80"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-6-81"><a id="__codelineno-6-81" name="__codelineno-6-81"></a>
</span><span id="__span-6-82"><a id="__codelineno-6-82" name="__codelineno-6-82"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">Response</span><span class="p">.</span><span class="nx">Choices</span><span class="p">)</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-6-83"><a id="__codelineno-6-83" name="__codelineno-6-83"></a><span class="w">            </span><span class="nx">choice</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">event</span><span class="p">.</span><span class="nx">Response</span><span class="p">.</span><span class="nx">Choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="__span-6-84"><a id="__codelineno-6-84" name="__codelineno-6-84"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">choice</span><span class="p">.</span><span class="nx">Delta</span><span class="p">.</span><span class="nx">Content</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-6-85"><a id="__codelineno-6-85" name="__codelineno-6-85"></a><span class="w">                </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Print</span><span class="p">(</span><span class="nx">choice</span><span class="p">.</span><span class="nx">Delta</span><span class="p">.</span><span class="nx">Content</span><span class="p">)</span>
</span><span id="__span-6-86"><a id="__codelineno-6-86" name="__codelineno-6-86"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-6-87"><a id="__codelineno-6-87" name="__codelineno-6-87"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-6-88"><a id="__codelineno-6-88" name="__codelineno-6-88"></a>
</span><span id="__span-6-89"><a id="__codelineno-6-89" name="__codelineno-6-89"></a><span class="w">        </span><span class="c1">// Prefer Runner completion as the end-of-run signal.</span>
</span><span id="__span-6-90"><a id="__codelineno-6-90" name="__codelineno-6-90"></a><span class="w">        </span><span class="c1">// LLM final response is not equal to graph completion.</span>
</span><span id="__span-6-91"><a id="__codelineno-6-91" name="__codelineno-6-91"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">event</span><span class="p">.</span><span class="nx">IsRunnerCompletion</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-6-92"><a id="__codelineno-6-92" name="__codelineno-6-92"></a><span class="w">            </span><span class="k">break</span>
</span><span id="__span-6-93"><a id="__codelineno-6-93" name="__codelineno-6-93"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-6-94"><a id="__codelineno-6-94" name="__codelineno-6-94"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-6-95"><a id="__codelineno-6-95" name="__codelineno-6-95"></a><span class="p">}</span>
</span><span id="__span-6-96"><a id="__codelineno-6-96" name="__codelineno-6-96"></a>
</span><span id="__span-6-97"><a id="__codelineno-6-97" name="__codelineno-6-97"></a><span class="c1">// Node function implementations.</span>
</span><span id="__span-6-98"><a id="__codelineno-6-98" name="__codelineno-6-98"></a><span class="kd">func</span><span class="w"> </span><span class="nx">startNodeFunc</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-6-99"><a id="__codelineno-6-99" name="__codelineno-6-99"></a><span class="w">    </span><span class="c1">// Get user input from built-in StateKeyUserInput (automatically set by Runner).</span>
</span><span id="__span-6-100"><a id="__codelineno-6-100" name="__codelineno-6-100"></a><span class="w">    </span><span class="nx">input</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">state</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyUserInput</span><span class="p">].(</span><span class="kt">string</span><span class="p">)</span>
</span><span id="__span-6-101"><a id="__codelineno-6-101" name="__codelineno-6-101"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span>
</span><span id="__span-6-102"><a id="__codelineno-6-102" name="__codelineno-6-102"></a><span class="w">        </span><span class="nx">StateKeyProcessedData</span><span class="p">:</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;Processed: %s&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">input</span><span class="p">),</span>
</span><span id="__span-6-103"><a id="__codelineno-6-103" name="__codelineno-6-103"></a><span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-6-104"><a id="__codelineno-6-104" name="__codelineno-6-104"></a><span class="p">}</span>
</span><span id="__span-6-105"><a id="__codelineno-6-105" name="__codelineno-6-105"></a>
</span><span id="__span-6-106"><a id="__codelineno-6-106" name="__codelineno-6-106"></a><span class="kd">func</span><span class="w"> </span><span class="nx">processNodeFunc</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-6-107"><a id="__codelineno-6-107" name="__codelineno-6-107"></a><span class="w">    </span><span class="nx">processed</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">state</span><span class="p">[</span><span class="nx">StateKeyProcessedData</span><span class="p">].(</span><span class="kt">string</span><span class="p">)</span>
</span><span id="__span-6-108"><a id="__codelineno-6-108" name="__codelineno-6-108"></a><span class="w">    </span><span class="nx">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;Result: %s&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">processed</span><span class="p">)</span>
</span><span id="__span-6-109"><a id="__codelineno-6-109" name="__codelineno-6-109"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span>
</span><span id="__span-6-110"><a id="__codelineno-6-110" name="__codelineno-6-110"></a><span class="w">        </span><span class="nx">StateKeyResult</span><span class="p">:</span><span class="w"> </span><span class="nx">result</span><span class="p">,</span>
</span><span id="__span-6-111"><a id="__codelineno-6-111" name="__codelineno-6-111"></a><span class="w">        </span><span class="c1">// Use built-in StateKeyLastResponse to set final output.</span>
</span><span id="__span-6-112"><a id="__codelineno-6-112" name="__codelineno-6-112"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyLastResponse</span><span class="p">:</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;Final result: %s&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">result</span><span class="p">),</span>
</span><span id="__span-6-113"><a id="__codelineno-6-113" name="__codelineno-6-113"></a><span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-6-114"><a id="__codelineno-6-114" name="__codelineno-6-114"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="2-using-llm-nodes">2. Using LLM Nodes</h3>
<p>LLM nodes implement a fixed three-stage input rule without extra configuration:</p>
<ol>
<li>OneShot first: If <code>one_shot_messages</code> exists, use it as the input for this round.</li>
<li>UserInput next: Otherwise, if <code>user_input</code> exists, persist once to history.</li>
<li>History default: Otherwise, use durable <code>messages</code> as input.</li>
</ol>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-7-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-7-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-7-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-7-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-7-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-7-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-7-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-7-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-7-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-7-10">10</a></span>
<span class="normal"><a href="#__codelineno-7-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="c1">// Create LLM model.</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="nx">model</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">openai</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;gpt-4&quot;</span><span class="p">)</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3"></a>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4"></a><span class="c1">// Add LLM node.</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5"></a><span class="nx">stateGraph</span><span class="p">.</span><span class="nx">AddLLMNode</span><span class="p">(</span><span class="s">&quot;analyze&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">model</span><span class="p">,</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6"></a><span class="w">    </span><span class="s">`You are a document analysis expert. Analyze the provided document and:</span>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7"></a><span class="s">1. Classify document type and complexity</span>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8"></a><span class="s">2. Extract key themes</span>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9"></a><span class="s">3. Evaluate content quality</span>
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10"></a><span class="s">Please provide structured analysis results.`</span><span class="p">,</span>
</span><span id="__span-7-11"><a id="__codelineno-7-11" name="__codelineno-7-11"></a><span class="w">    </span><span class="kc">nil</span><span class="p">)</span><span class="w"> </span><span class="c1">// Tool mapping.</span>
</span></code></pre></div></td></tr></table></div>
<p>Important notes:</p>
<ul>
<li>System prompt is only used for this round and is not persisted to state.</li>
<li>One-shot keys (<code>user_input</code> / <code>one_shot_messages</code>) are automatically cleared after successful execution.</li>
<li>All state updates are atomic.</li>
<li>GraphAgent/Runner only sets <code>user_input</code> and no longer pre-populates <code>messages</code> with a user message. This allows any pre-LLM node to modify <code>user_input</code> and have it take effect in the same round.</li>
</ul>
<h4 id="three-input-paradigms">Three input paradigms</h4>
<ul>
<li>
<p>OneShot (<code>StateKeyOneShotMessages</code>):</p>
<ul>
<li>When present, only the provided <code>[]model.Message</code> is used for this round, typically including a full system prompt and user prompt. Automatically cleared afterwards.</li>
<li>Use case: a dedicated pre-node constructs the full prompt and must fully override input.</li>
</ul>
</li>
</ul>
<ul>
<li>
<p>UserInput (<code>StateKeyUserInput</code>):</p>
<ul>
<li>When non-empty, the LLM node uses durable <code>messages</code> plus this round's user input to call the model. After the call, it writes the user input and assistant reply to <code>messages</code> using <code>MessageOp</code> (e.g., <code>AppendMessages</code>, <code>ReplaceLastUser</code>) atomically, and clears <code>user_input</code> to avoid repeated appends.</li>
<li>Use case: conversational flows where pre-nodes may adjust user input.</li>
</ul>
</li>
</ul>
<ul>
<li>Messages only (just <code>StateKeyMessages</code>):<ul>
<li>Common in tool-call loops. After the first round via <code>user_input</code>, routing to tools and back to LLM, since <code>user_input</code> is cleared, the LLM uses only <code>messages</code> (history). The tail is often a <code>tool</code> response, enabling the model to continue reasoning based on tool outputs.</li>
</ul>
</li>
</ul>
<h4 id="atomic-updates-with-reducer-and-messageop">Atomic updates with Reducer and MessageOp</h4>
<p>The Graph package supports <code>MessageOp</code> patch operations (e.g., <code>ReplaceLastUser</code>,
<code>AppendMessages</code>) on message state via <code>MessageReducer</code> to achieve atomic merges. Benefits:</p>
<ul>
<li>Pre-LLM nodes can modify <code>user_input</code>. The LLM node returns a single state delta with the needed patch operations (replace last user message, append assistant message) for one-shot, race-free persistence.</li>
<li>Backwards compatible with appending <code>[]Message</code>, while providing more expressive updates for complex cases.</li>
</ul>
<p>Example: modify <code>user_input</code> in a pre-node before entering the LLM node.</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-8-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-8-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-8-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-8-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-8-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-8-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-8-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-8-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-8-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-8-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="nx">stateGraph</span><span class="p">.</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="w">    </span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;prepare_input&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="w">        </span><span class="nx">cleaned</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">strings</span><span class="p">.</span><span class="nx">TrimSpace</span><span class="p">(</span><span class="nx">s</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyUserInput</span><span class="p">].(</span><span class="kt">string</span><span class="p">))</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyUserInput</span><span class="p">:</span><span class="w"> </span><span class="nx">cleaned</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5"></a><span class="w">    </span><span class="p">}).</span>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6"></a><span class="w">    </span><span class="nx">AddLLMNode</span><span class="p">(</span><span class="s">&quot;ask&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">modelInstance</span><span class="p">,</span>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7"></a><span class="w">        </span><span class="s">&quot;You are a helpful assistant. Answer concisely.&quot;</span><span class="p">,</span>
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8"></a><span class="w">        </span><span class="kc">nil</span><span class="p">).</span>
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9"></a><span class="w">    </span><span class="nx">SetEntryPoint</span><span class="p">(</span><span class="s">&quot;prepare_input&quot;</span><span class="p">).</span>
</span><span id="__span-8-10"><a id="__codelineno-8-10" name="__codelineno-8-10"></a><span class="w">    </span><span class="nx">SetFinishPoint</span><span class="p">(</span><span class="s">&quot;ask&quot;</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="3-graphagent-configuration-options">3. GraphAgent Configuration Options</h3>
<p>GraphAgent supports various configuration options:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-9-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-9-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-9-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-9-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-9-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-9-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-9-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-9-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-9-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-9-10">10</a></span>
<span class="normal"><a href="#__codelineno-9-11">11</a></span>
<span class="normal"><a href="#__codelineno-9-12">12</a></span>
<span class="normal"><a href="#__codelineno-9-13">13</a></span>
<span class="normal"><a href="#__codelineno-9-14">14</a></span>
<span class="normal"><a href="#__codelineno-9-15">15</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="c1">// Multiple options can be used when creating GraphAgent.</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2"></a><span class="nx">graphAgent</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3"></a><span class="w">    </span><span class="s">&quot;workflow-name&quot;</span><span class="p">,</span>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4"></a><span class="w">    </span><span class="nx">compiledGraph</span><span class="p">,</span>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithDescription</span><span class="p">(</span><span class="s">&quot;Workflow description&quot;</span><span class="p">),</span>
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithInitialState</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span>
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7"></a><span class="w">        </span><span class="s">&quot;initial_data&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Initial data&quot;</span><span class="p">,</span>
</span><span id="__span-9-8"><a id="__codelineno-9-8" name="__codelineno-9-8"></a><span class="w">    </span><span class="p">}),</span>
</span><span id="__span-9-9"><a id="__codelineno-9-9" name="__codelineno-9-9"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithChannelBufferSize</span><span class="p">(</span><span class="mi">1024</span><span class="p">),</span><span class="w">            </span><span class="c1">// Tune event buffer size</span>
</span><span id="__span-9-10"><a id="__codelineno-9-10" name="__codelineno-9-10"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithCheckpointSaver</span><span class="p">(</span><span class="nx">memorySaver</span><span class="p">),</span><span class="w">       </span><span class="c1">// Persist checkpoints if needed</span>
</span><span id="__span-9-11"><a id="__codelineno-9-11" name="__codelineno-9-11"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithSubAgents</span><span class="p">([]</span><span class="nx">agent</span><span class="p">.</span><span class="nx">Agent</span><span class="p">{</span><span class="nx">subAgent</span><span class="p">}),</span><span class="w"> </span><span class="c1">// Register sub-agents by name</span>
</span><span id="__span-9-12"><a id="__codelineno-9-12" name="__codelineno-9-12"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithAgentCallbacks</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">agent</span><span class="p">.</span><span class="nx">Callbacks</span><span class="p">{</span>
</span><span id="__span-9-13"><a id="__codelineno-9-13" name="__codelineno-9-13"></a><span class="w">        </span><span class="c1">// Agent-level callbacks.</span>
</span><span id="__span-9-14"><a id="__codelineno-9-14" name="__codelineno-9-14"></a><span class="w">    </span><span class="p">}),</span>
</span><span id="__span-9-15"><a id="__codelineno-9-15" name="__codelineno-9-15"></a><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<blockquote>
<p>Model/tool callbacks are configured per node, e.g. <code>AddLLMNode(..., graph.WithModelCallbacks(...))</code>
or <code>AddToolsNode(..., graph.WithToolCallbacks(...))</code>.</p>
</blockquote>
<p>Once sub-agents are registered you can delegate within the graph via agent nodes:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-10-1">1</a></span>
<span class="normal"><a href="#__codelineno-10-2">2</a></span>
<span class="normal"><a href="#__codelineno-10-3">3</a></span>
<span class="normal"><a href="#__codelineno-10-4">4</a></span>
<span class="normal"><a href="#__codelineno-10-5">5</a></span>
<span class="normal"><a href="#__codelineno-10-6">6</a></span>
<span class="normal"><a href="#__codelineno-10-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="c1">// Assume subAgent.Info().Name == &quot;assistant&quot;</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2"></a><span class="nx">stateGraph</span><span class="p">.</span><span class="nx">AddAgentNode</span><span class="p">(</span><span class="s">&quot;assistant&quot;</span><span class="p">,</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithName</span><span class="p">(</span><span class="s">&quot;Delegate to assistant agent&quot;</span><span class="p">),</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithDescription</span><span class="p">(</span><span class="s">&quot;Invoke the pre-registered assistant agent&quot;</span><span class="p">),</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5"></a><span class="p">)</span>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6"></a>
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7"></a><span class="c1">// During execution the GraphAgent looks up a sub-agent with the same name and runs it</span>
</span></code></pre></div></td></tr></table></div>
<blockquote>
<p>The agent node uses its ID for the lookup, so keep <code>AddAgentNode("assistant")</code>
aligned with <code>subAgent.Info().Name == "assistant"</code>.</p>
</blockquote>
<h3 id="4-conditional-routing">4. Conditional Routing</h3>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-11-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-11-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-11-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-11-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-11-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-11-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-11-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-11-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-11-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-11-10">10</a></span>
<span class="normal"><a href="#__codelineno-11-11">11</a></span>
<span class="normal"><a href="#__codelineno-11-12">12</a></span>
<span class="normal"><a href="#__codelineno-11-13">13</a></span>
<span class="normal"><a href="#__codelineno-11-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="c1">// Define condition function.</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2"></a><span class="kd">func</span><span class="w"> </span><span class="nx">complexityCondition</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3"></a><span class="w">    </span><span class="nx">complexity</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">state</span><span class="p">[</span><span class="s">&quot;complexity&quot;</span><span class="p">].(</span><span class="kt">string</span><span class="p">)</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">complexity</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;simple&quot;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;simple_process&quot;</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;complex_process&quot;</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8"></a><span class="p">}</span>
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9"></a>
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10"></a><span class="c1">// Add conditional edges.</span>
</span><span id="__span-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11"></a><span class="nx">stateGraph</span><span class="p">.</span><span class="nx">AddConditionalEdges</span><span class="p">(</span><span class="s">&quot;analyze&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">complexityCondition</span><span class="p">,</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span>
</span><span id="__span-11-12"><a id="__codelineno-11-12" name="__codelineno-11-12"></a><span class="w">    </span><span class="s">&quot;simple_process&quot;</span><span class="p">:</span><span class="w">  </span><span class="s">&quot;simple_node&quot;</span><span class="p">,</span>
</span><span id="__span-11-13"><a id="__codelineno-11-13" name="__codelineno-11-13"></a><span class="w">    </span><span class="s">&quot;complex_process&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;complex_node&quot;</span><span class="p">,</span>
</span><span id="__span-11-14"><a id="__codelineno-11-14" name="__codelineno-11-14"></a><span class="p">})</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="41-named-ends-pernode-ends">4.1 Named Ends (Per‑node Ends)</h3>
<p>When a node produces business outcomes (e.g., <code>approve</code>/<code>reject</code>/<code>manual_review</code>) and you want to route by those semantic labels, declare node‑local Named Ends (Ends).</p>
<p>Why this helps:
- Central, declarative mapping from labels to concrete targets at the node site.
- Compile‑time validation: <code>Compile()</code> verifies every end target exists (or is the special <code>graph.End</code>).
- Unified routing: reused by both <code>Command.GoTo</code> and conditional edges.
- Decoupling: nodes express outcomes in business terms; the mapping ties outcomes to graph structure.</p>
<p>API:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-12-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-12-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-12-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-12-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-12-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-12-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-12-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-12-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-12-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-12-10">10</a></span>
<span class="normal"><a href="#__codelineno-12-11">11</a></span>
<span class="normal"><a href="#__codelineno-12-12">12</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="c1">// Declare Ends on a node (label -&gt; concrete target)</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;decision&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">decideNode</span><span class="p">,</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithEndsMap</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4"></a><span class="w">        </span><span class="s">&quot;approve&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;approved&quot;</span><span class="p">,</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5"></a><span class="w">        </span><span class="s">&quot;reject&quot;</span><span class="p">:</span><span class="w">  </span><span class="s">&quot;rejected&quot;</span><span class="p">,</span>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6"></a><span class="w">        </span><span class="c1">// You may map a label to the terminal End</span>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7"></a><span class="w">        </span><span class="c1">// &quot;drop&quot;:  graph.End,</span>
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8"></a><span class="w">    </span><span class="p">}),</span>
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9"></a><span class="p">)</span>
</span><span id="__span-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10"></a>
</span><span id="__span-12-11"><a id="__codelineno-12-11" name="__codelineno-12-11"></a><span class="c1">// Short form: label equals the target node ID</span>
</span><span id="__span-12-12"><a id="__codelineno-12-12" name="__codelineno-12-12"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;router&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">routerNode</span><span class="p">,</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithEnds</span><span class="p">(</span><span class="s">&quot;nodeB&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;nodeC&quot;</span><span class="p">))</span>
</span></code></pre></div></td></tr></table></div>
<p>Command‑style routing (Command.GoTo):</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-13-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-13-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-13-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-13-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-13-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-13-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-13-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-13-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-13-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-13-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="kd">func</span><span class="w"> </span><span class="nx">decideNode</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2"></a><span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="nx">s</span><span class="p">[</span><span class="s">&quot;decision&quot;</span><span class="p">].(</span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s">&quot;approve&quot;</span><span class="p">:</span>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">graph</span><span class="p">.</span><span class="nx">Command</span><span class="p">{</span><span class="nx">GoTo</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;approve&quot;</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="c1">// label</span>
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s">&quot;reject&quot;</span><span class="p">:</span>
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">graph</span><span class="p">.</span><span class="nx">Command</span><span class="p">{</span><span class="nx">GoTo</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;reject&quot;</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7"></a><span class="w">    </span><span class="k">default</span><span class="p">:</span>
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">graph</span><span class="p">.</span><span class="nx">Command</span><span class="p">{</span><span class="nx">GoTo</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;reject&quot;</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-13-9"><a id="__codelineno-13-9" name="__codelineno-13-9"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-13-10"><a id="__codelineno-13-10" name="__codelineno-13-10"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>Conditional edges can reuse Ends: when <code>AddConditionalEdges(from, condition, pathMap)</code> receives a <code>nil</code> <code>pathMap</code> or no match is found, the executor tries the node’s Ends; if still no match, the return string is treated as a concrete node ID.</p>
<p>Resolution precedence:
1. Explicit mapping in the conditional edge’s <code>pathMap</code>.
2. The node’s Ends mapping (label → concrete target).
3. Treat the return string as a node ID.</p>
<p>Compile‑time checks:
- <code>WithEndsMap/WithEnds</code> targets are validated in <code>Compile()</code>.
- Targets must exist in the graph or be the special constant <code>graph.End</code>.</p>
<p>Notes:
- Use the constant <code>graph.End</code> to terminate; do not use the string "END".
- With <code>Command.GoTo</code>, you don’t need to add a static <code>AddEdge(from, to)</code> for the target; ensure the target exists and set <code>SetFinishPoint(target)</code> if it should end the graph.</p>
<p>Runnable example: <code>examples/graph/multiends</code>.</p>
<h3 id="5-tool-node-integration">5. Tool Node Integration</h3>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-14-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-14-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-14-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-14-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-14-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-14-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-14-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-14-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-14-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-14-10">10</a></span>
<span class="normal"><a href="#__codelineno-14-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="c1">// Create tools.</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2"></a><span class="nx">tools</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">tool</span><span class="p">.</span><span class="nx">Tool</span><span class="p">{</span>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3"></a><span class="w">    </span><span class="s">&quot;calculator&quot;</span><span class="p">:</span><span class="w"> </span><span class="nx">calculatorTool</span><span class="p">,</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4"></a><span class="w">    </span><span class="s">&quot;search&quot;</span><span class="p">:</span><span class="w">     </span><span class="nx">searchTool</span><span class="p">,</span>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5"></a><span class="p">}</span>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6"></a>
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7"></a><span class="c1">// Add tool node.</span>
</span><span id="__span-14-8"><a id="__codelineno-14-8" name="__codelineno-14-8"></a><span class="nx">stateGraph</span><span class="p">.</span><span class="nx">AddToolsNode</span><span class="p">(</span><span class="s">&quot;tools&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">tools</span><span class="p">)</span>
</span><span id="__span-14-9"><a id="__codelineno-14-9" name="__codelineno-14-9"></a>
</span><span id="__span-14-10"><a id="__codelineno-14-10" name="__codelineno-14-10"></a><span class="c1">// Add conditional routing from LLM to tools.</span>
</span><span id="__span-14-11"><a id="__codelineno-14-11" name="__codelineno-14-11"></a><span class="nx">stateGraph</span><span class="p">.</span><span class="nx">AddToolsConditionalEdges</span><span class="p">(</span><span class="s">&quot;llm_node&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;tools&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;fallback_node&quot;</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>Enable parallel tool execution for the Tools node (aligns with LLMAgent’s option):</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-15-1">1</a></span>
<span class="normal"><a href="#__codelineno-15-2">2</a></span>
<span class="normal"><a href="#__codelineno-15-3">3</a></span>
<span class="normal"><a href="#__codelineno-15-4">4</a></span>
<span class="normal"><a href="#__codelineno-15-5">5</a></span>
<span class="normal"><a href="#__codelineno-15-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1"></a><span class="c1">// Tools node runs tool calls concurrently when multiple tool_calls are present.</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2"></a><span class="nx">stateGraph</span><span class="p">.</span><span class="nx">AddToolsNode</span><span class="p">(</span>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3"></a><span class="w">    </span><span class="s">&quot;tools&quot;</span><span class="p">,</span>
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4"></a><span class="w">    </span><span class="nx">tools</span><span class="p">,</span>
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithEnableParallelTools</span><span class="p">(</span><span class="kc">true</span><span class="p">),</span><span class="w"> </span><span class="c1">// optional; default is serial</span>
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6"></a><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>Tool-call pairing and second entry into LLM:</p>
<ul>
<li>Scan <code>messages</code> backward from the tail to find the most recent <code>assistant(tool_calls)</code>; stop at <code>user</code> to ensure correct pairing.</li>
<li>When returning from tools to the LLM node, since <code>user_input</code> is cleared, the LLM follows the “Messages only” branch and continues based on the tool response in history.</li>
</ul>
<h4 id="placeholder-variables-in-llm-instructions">Placeholder Variables in LLM Instructions</h4>
<p>LLM nodes support placeholder injection in their <code>instruction</code> string (same rules as LLMAgent). Both native <code>{key}</code> and Mustache <code>{{key}}</code> syntaxes are accepted (Mustache is normalized to the native form automatically):</p>
<ul>
<li><code>{key}</code> / <code>{{key}}</code> → replaced by <code>session.State["key"]</code></li>
<li><code>{key?}</code> / <code>{{key?}}</code> → optional; missing values become empty</li>
<li><code>{user:subkey}</code>, <code>{app:subkey}</code>, <code>{temp:subkey}</code> (and their Mustache forms) → access user/app/temp scopes (session services merge app/user state into session with these prefixes)</li>
</ul>
<p>Notes:</p>
<ul>
<li>GraphAgent writes the current <code>*session.Session</code> into graph state under <code>StateKeySession</code>; the LLM node reads values from there</li>
<li>Unprefixed keys (e.g., <code>research_topics</code>) must be present directly in <code>session.State</code></li>
</ul>
<p>Example:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-16-1">1</a></span>
<span class="normal"><a href="#__codelineno-16-2">2</a></span>
<span class="normal"><a href="#__codelineno-16-3">3</a></span>
<span class="normal"><a href="#__codelineno-16-4">4</a></span>
<span class="normal"><a href="#__codelineno-16-5">5</a></span>
<span class="normal"><a href="#__codelineno-16-6">6</a></span>
<span class="normal"><a href="#__codelineno-16-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1"></a><span class="nx">mdl</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">openai</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="nx">modelName</span><span class="p">)</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2"></a><span class="nx">stateGraph</span><span class="p">.</span><span class="nx">AddLLMNode</span><span class="p">(</span>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3"></a><span class="w">  </span><span class="s">&quot;research&quot;</span><span class="p">,</span>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4"></a><span class="w">  </span><span class="nx">mdl</span><span class="p">,</span>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5"></a><span class="w">  </span><span class="s">&quot;You are a research assistant. Focus: {research_topics}. User: {user:topics?}. App: {app:banner?}.&quot;</span><span class="p">,</span>
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6"></a><span class="w">  </span><span class="kc">nil</span><span class="p">,</span>
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7"></a><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>See the runnable example: <code>examples/graph/placeholder</code>.</p>
<p>Injecting retrieval output and user input</p>
<ul>
<li>Upstream nodes can place ephemeral values into the session's <code>temp:</code> namespace so the LLM instruction can read them with placeholders.</li>
<li>Pattern:</li>
</ul>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-17-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-17-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-17-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-17-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-17-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-17-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-17-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-17-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-17-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-17-10">10</a></span>
<span class="normal"><a href="#__codelineno-17-11">11</a></span>
<span class="normal"><a href="#__codelineno-17-12">12</a></span>
<span class="normal"><a href="#__codelineno-17-13">13</a></span>
<span class="normal"><a href="#__codelineno-17-14">14</a></span>
<span class="normal"><a href="#__codelineno-17-15">15</a></span>
<span class="normal"><a href="#__codelineno-17-16">16</a></span>
<span class="normal"><a href="#__codelineno-17-17">17</a></span>
<span class="normal"><a href="#__codelineno-17-18">18</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1"></a><span class="c1">// In a node before the LLM node</span>
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;retrieve&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3"></a><span class="w">    </span><span class="c1">// Suppose you computed `retrieved` and want to include current user input.</span>
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4"></a><span class="w">    </span><span class="nx">retrieved</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;• doc A...\n• doc B...&quot;</span>
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5"></a><span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">input</span><span class="w"> </span><span class="kt">string</span>
</span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">v</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">s</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyUserInput</span><span class="p">].(</span><span class="kt">string</span><span class="p">);</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">input</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">v</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-17-7"><a id="__codelineno-17-7" name="__codelineno-17-7"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">sess</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">s</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeySession</span><span class="p">].(</span><span class="o">*</span><span class="nx">session</span><span class="p">.</span><span class="nx">Session</span><span class="p">);</span><span class="w"> </span><span class="nx">sess</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-17-8"><a id="__codelineno-17-8" name="__codelineno-17-8"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">sess</span><span class="p">.</span><span class="nx">State</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">sess</span><span class="p">.</span><span class="nx">State</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="nx">session</span><span class="p">.</span><span class="nx">StateMap</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-17-9"><a id="__codelineno-17-9" name="__codelineno-17-9"></a><span class="w">        </span><span class="nx">sess</span><span class="p">.</span><span class="nx">State</span><span class="p">[</span><span class="nx">session</span><span class="p">.</span><span class="nx">StateTempPrefix</span><span class="o">+</span><span class="s">&quot;retrieved_context&quot;</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">retrieved</span><span class="p">)</span>
</span><span id="__span-17-10"><a id="__codelineno-17-10" name="__codelineno-17-10"></a><span class="w">        </span><span class="nx">sess</span><span class="p">.</span><span class="nx">State</span><span class="p">[</span><span class="nx">session</span><span class="p">.</span><span class="nx">StateTempPrefix</span><span class="o">+</span><span class="s">&quot;user_input&quot;</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">input</span><span class="p">)</span>
</span><span id="__span-17-11"><a id="__codelineno-17-11" name="__codelineno-17-11"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-17-12"><a id="__codelineno-17-12" name="__codelineno-17-12"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-17-13"><a id="__codelineno-17-13" name="__codelineno-17-13"></a><span class="p">})</span>
</span><span id="__span-17-14"><a id="__codelineno-17-14" name="__codelineno-17-14"></a>
</span><span id="__span-17-15"><a id="__codelineno-17-15" name="__codelineno-17-15"></a><span class="c1">// LLM node instruction can reference {temp:retrieved_context} and {temp:user_input}</span>
</span><span id="__span-17-16"><a id="__codelineno-17-16" name="__codelineno-17-16"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddLLMNode</span><span class="p">(</span><span class="s">&quot;answer&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">mdl</span><span class="p">,</span>
</span><span id="__span-17-17"><a id="__codelineno-17-17" name="__codelineno-17-17"></a><span class="w">    </span><span class="s">&quot;Use context to answer.\n\nContext:\n{temp:retrieved_context}\n\nQuestion: {temp:user_input}&quot;</span><span class="p">,</span>
</span><span id="__span-17-18"><a id="__codelineno-17-18" name="__codelineno-17-18"></a><span class="w">    </span><span class="kc">nil</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>Example: <code>examples/graph/retrieval_placeholder</code>.</p>
<p>Best practices for placeholders and session state</p>
<ul>
<li>Ephemeral vs persistent: write per‑turn values to <code>temp:*</code> on <code>session.State</code> (session state). Persistent configuration should go through <code>SessionService</code> with <code>user:*</code>/<code>app:*</code>.</li>
<li>Why direct write is OK: LLM nodes expand placeholders from the session object present in graph state; see <a href="https://github.com/trpc-group/trpc-agent-go/blob/main/graph/state_graph.go">graph/state_graph.go</a>. GraphAgent puts the session into state; see <a href="https://github.com/trpc-group/trpc-agent-go/blob/main/agent/graphagent/graph_agent.go">agent/graphagent/graph_agent.go</a>.</li>
<li>Service guardrails: the in‑memory service intentionally disallows writing <code>temp:*</code> (and <code>app:*</code> via user updater); see <a href="https://github.com/trpc-group/trpc-agent-go/blob/main/session/inmemory/service.go">session/inmemory/service.go</a>.</li>
<li>Concurrency: when multiple branches run in parallel, avoid multiple nodes mutating the same <code>session.State</code> keys. Prefer composing in a single node before the LLM, or store intermediate values in graph state then write once to <code>temp:*</code>.</li>
<li>Observability: if you want parts of the prompt to appear in completion events, also store a compact summary in graph state (e.g., under <code>metadata</code>). The final event serializes non‑internal final state; see <a href="https://github.com/trpc-group/trpc-agent-go/blob/main/graph/events.go">graph/events.go</a>.</li>
</ul>
<h3 id="6-node-retry-backoff">6. Node Retry &amp; Backoff</h3>
<p>Configure per‑node retry with exponential backoff and optional jitter. Failed attempts do not produce writes; only a successful attempt applies its state delta and routing.</p>
<ul>
<li>Per‑node policy via <code>WithRetryPolicy</code>:</li>
</ul>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-18-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-18-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-18-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-18-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-18-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-18-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-18-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-18-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-18-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-18-10">10</a></span>
<span class="normal"><a href="#__codelineno-18-11">11</a></span>
<span class="normal"><a href="#__codelineno-18-12">12</a></span>
<span class="normal"><a href="#__codelineno-18-13">13</a></span>
<span class="normal"><a href="#__codelineno-18-14">14</a></span>
<span class="normal"><a href="#__codelineno-18-15">15</a></span>
<span class="normal"><a href="#__codelineno-18-16">16</a></span>
<span class="normal"><a href="#__codelineno-18-17">17</a></span>
<span class="normal"><a href="#__codelineno-18-18">18</a></span>
<span class="normal"><a href="#__codelineno-18-19">19</a></span>
<span class="normal"><a href="#__codelineno-18-20">20</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1"></a><span class="c1">// Simple convenience policy (attempts include the first try)</span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;unstable&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">unstableFunc</span><span class="p">,</span>
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithRetryPolicy</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithSimpleRetry</span><span class="p">(</span><span class="mi">3</span><span class="p">)))</span>
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4"></a>
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5"></a><span class="c1">// Full policy</span>
</span><span id="__span-18-6"><a id="__codelineno-18-6" name="__codelineno-18-6"></a><span class="nx">policy</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">RetryPolicy</span><span class="p">{</span>
</span><span id="__span-18-7"><a id="__codelineno-18-7" name="__codelineno-18-7"></a><span class="w">    </span><span class="nx">MaxAttempts</span><span class="p">:</span><span class="w">     </span><span class="mi">3</span><span class="p">,</span><span class="w">                      </span><span class="c1">// 1 initial + up to 2 retries</span>
</span><span id="__span-18-8"><a id="__codelineno-18-8" name="__codelineno-18-8"></a><span class="w">    </span><span class="nx">InitialInterval</span><span class="p">:</span><span class="w"> </span><span class="mi">200</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span><span class="p">,</span><span class="w"> </span><span class="c1">// base delay</span>
</span><span id="__span-18-9"><a id="__codelineno-18-9" name="__codelineno-18-9"></a><span class="w">    </span><span class="nx">BackoffFactor</span><span class="p">:</span><span class="w">   </span><span class="mf">2.0</span><span class="p">,</span><span class="w">                    </span><span class="c1">// exponential backoff</span>
</span><span id="__span-18-10"><a id="__codelineno-18-10" name="__codelineno-18-10"></a><span class="w">    </span><span class="nx">MaxInterval</span><span class="p">:</span><span class="w">     </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">,</span><span class="w">        </span><span class="c1">// clamp</span>
</span><span id="__span-18-11"><a id="__codelineno-18-11" name="__codelineno-18-11"></a><span class="w">    </span><span class="nx">Jitter</span><span class="p">:</span><span class="w">          </span><span class="kc">true</span><span class="p">,</span><span class="w">                   </span><span class="c1">// randomize delay</span>
</span><span id="__span-18-12"><a id="__codelineno-18-12" name="__codelineno-18-12"></a><span class="w">    </span><span class="nx">RetryOn</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="nx">graph</span><span class="p">.</span><span class="nx">RetryCondition</span><span class="p">{</span>
</span><span id="__span-18-13"><a id="__codelineno-18-13" name="__codelineno-18-13"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">DefaultTransientCondition</span><span class="p">(),</span><span class="w">   </span><span class="c1">// deadline/net timeouts</span>
</span><span id="__span-18-14"><a id="__codelineno-18-14" name="__codelineno-18-14"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">RetryOnErrors</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">DeadlineExceeded</span><span class="p">),</span>
</span><span id="__span-18-15"><a id="__codelineno-18-15" name="__codelineno-18-15"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">RetryOnPredicate</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">err</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">}),</span>
</span><span id="__span-18-16"><a id="__codelineno-18-16" name="__codelineno-18-16"></a><span class="w">    </span><span class="p">},</span>
</span><span id="__span-18-17"><a id="__codelineno-18-17" name="__codelineno-18-17"></a><span class="w">    </span><span class="nx">MaxElapsedTime</span><span class="p">:</span><span class="w">  </span><span class="mi">5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">,</span><span class="w">        </span><span class="c1">// total retry budget (optional)</span>
</span><span id="__span-18-18"><a id="__codelineno-18-18" name="__codelineno-18-18"></a><span class="w">    </span><span class="c1">// PerAttemptTimeout: 0,                 // reserved; node timeout comes from executor</span>
</span><span id="__span-18-19"><a id="__codelineno-18-19" name="__codelineno-18-19"></a><span class="p">}</span>
</span><span id="__span-18-20"><a id="__codelineno-18-20" name="__codelineno-18-20"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;unstable&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">unstableFunc</span><span class="p">,</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithRetryPolicy</span><span class="p">(</span><span class="nx">policy</span><span class="p">))</span>
</span></code></pre></div></td></tr></table></div>
<ul>
<li>Default policy via Executor (applies when a node has none):</li>
</ul>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-19-1">1</a></span>
<span class="normal"><a href="#__codelineno-19-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1"></a><span class="nx">exec</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewExecutor</span><span class="p">(</span><span class="nx">compiled</span><span class="p">,</span>
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithDefaultRetryPolicy</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithSimpleRetry</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span>
</span></code></pre></div></td></tr></table></div>
<p>Notes
- Interrupts are never retried.
- Backoff delay is clamped by the current step deadline when set (<code>WithStepTimeout</code>).
- Events carry retry metadata so UIs/CLIs can display progress:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-20-1">1</a></span>
<span class="normal"><a href="#__codelineno-20-2">2</a></span>
<span class="normal"><a href="#__codelineno-20-3">3</a></span>
<span class="normal"><a href="#__codelineno-20-4">4</a></span>
<span class="normal"><a href="#__codelineno-20-5">5</a></span>
<span class="normal"><a href="#__codelineno-20-6">6</a></span>
<span class="normal"><a href="#__codelineno-20-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1"></a><span class="k">if</span><span class="w"> </span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">ev</span><span class="p">.</span><span class="nx">StateDelta</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">MetadataKeyNode</span><span class="p">];</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2"></a><span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">md</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NodeExecutionMetadata</span>
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3"></a><span class="w">    </span><span class="nx">_</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">json</span><span class="p">.</span><span class="nx">Unmarshal</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">md</span><span class="p">)</span>
</span><span id="__span-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">md</span><span class="p">.</span><span class="nx">Phase</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">ExecutionPhaseError</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">md</span><span class="p">.</span><span class="nx">Retrying</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-20-5"><a id="__codelineno-20-5" name="__codelineno-20-5"></a><span class="w">        </span><span class="c1">// md.Attempt, md.MaxAttempts, md.NextDelay</span>
</span><span id="__span-20-6"><a id="__codelineno-20-6" name="__codelineno-20-6"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-20-7"><a id="__codelineno-20-7" name="__codelineno-20-7"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>Example: <code>examples/graph/retry</code> shows an unstable node that retries before a final LLM answer.</p>
<h3 id="7-runner-configuration">7. Runner Configuration</h3>
<p>Runner provides session management and execution environment:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-21-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-21-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-21-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-21-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-21-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-21-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-21-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-21-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-21-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-21-10">10</a></span>
<span class="normal"><a href="#__codelineno-21-11">11</a></span>
<span class="normal"><a href="#__codelineno-21-12">12</a></span>
<span class="normal"><a href="#__codelineno-21-13">13</a></span>
<span class="normal"><a href="#__codelineno-21-14">14</a></span>
<span class="normal"><a href="#__codelineno-21-15">15</a></span>
<span class="normal"><a href="#__codelineno-21-16">16</a></span>
<span class="normal"><a href="#__codelineno-21-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1"></a><span class="c1">// Create session service.</span>
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2"></a><span class="nx">sessionService</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">inmemory</span><span class="p">.</span><span class="nx">NewSessionService</span><span class="p">()</span>
</span><span id="__span-21-3"><a id="__codelineno-21-3" name="__codelineno-21-3"></a><span class="c1">// Or use Redis session service.</span>
</span><span id="__span-21-4"><a id="__codelineno-21-4" name="__codelineno-21-4"></a><span class="c1">// sessionService, err := redis.NewService(redis.WithRedisClientURL(&quot;redis://localhost:6379&quot;))</span>
</span><span id="__span-21-5"><a id="__codelineno-21-5" name="__codelineno-21-5"></a>
</span><span id="__span-21-6"><a id="__codelineno-21-6" name="__codelineno-21-6"></a><span class="c1">// Create Runner.</span>
</span><span id="__span-21-7"><a id="__codelineno-21-7" name="__codelineno-21-7"></a><span class="nx">appRunner</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">runner</span><span class="p">.</span><span class="nx">NewRunner</span><span class="p">(</span>
</span><span id="__span-21-8"><a id="__codelineno-21-8" name="__codelineno-21-8"></a><span class="w">    </span><span class="s">&quot;app-name&quot;</span><span class="p">,</span>
</span><span id="__span-21-9"><a id="__codelineno-21-9" name="__codelineno-21-9"></a><span class="w">    </span><span class="nx">graphAgent</span><span class="p">,</span>
</span><span id="__span-21-10"><a id="__codelineno-21-10" name="__codelineno-21-10"></a><span class="w">    </span><span class="nx">runner</span><span class="p">.</span><span class="nx">WithSessionService</span><span class="p">(</span><span class="nx">sessionService</span><span class="p">),</span>
</span><span id="__span-21-11"><a id="__codelineno-21-11" name="__codelineno-21-11"></a><span class="w">    </span><span class="c1">// Can add more configuration options.</span>
</span><span id="__span-21-12"><a id="__codelineno-21-12" name="__codelineno-21-12"></a><span class="p">)</span>
</span><span id="__span-21-13"><a id="__codelineno-21-13" name="__codelineno-21-13"></a>
</span><span id="__span-21-14"><a id="__codelineno-21-14" name="__codelineno-21-14"></a><span class="c1">// Use Runner to execute workflow.</span>
</span><span id="__span-21-15"><a id="__codelineno-21-15" name="__codelineno-21-15"></a><span class="c1">// Runner only sets StateKeyUserInput; it no longer pre-populates StateKeyMessages.</span>
</span><span id="__span-21-16"><a id="__codelineno-21-16" name="__codelineno-21-16"></a><span class="nx">message</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">model</span><span class="p">.</span><span class="nx">NewUserMessage</span><span class="p">(</span><span class="s">&quot;User input&quot;</span><span class="p">)</span>
</span><span id="__span-21-17"><a id="__codelineno-21-17" name="__codelineno-21-17"></a><span class="nx">eventChan</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">appRunner</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">userID</span><span class="p">,</span><span class="w"> </span><span class="nx">sessionID</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="8-message-state-schema">8. Message State Schema</h3>
<p>For conversational applications, you can use predefined message state schema:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-22-1">1</a></span>
<span class="normal"><a href="#__codelineno-22-2">2</a></span>
<span class="normal"><a href="#__codelineno-22-3">3</a></span>
<span class="normal"><a href="#__codelineno-22-4">4</a></span>
<span class="normal"><a href="#__codelineno-22-5">5</a></span>
<span class="normal"><a href="#__codelineno-22-6">6</a></span>
<span class="normal"><a href="#__codelineno-22-7">7</a></span>
<span class="normal"><a href="#__codelineno-22-8">8</a></span>
<span class="normal"><a href="#__codelineno-22-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1"></a><span class="c1">// Use message state schema.</span>
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2"></a><span class="nx">schema</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">MessagesStateSchema</span><span class="p">()</span>
</span><span id="__span-22-3"><a id="__codelineno-22-3" name="__codelineno-22-3"></a>
</span><span id="__span-22-4"><a id="__codelineno-22-4" name="__codelineno-22-4"></a><span class="c1">// This schema includes:</span>
</span><span id="__span-22-5"><a id="__codelineno-22-5" name="__codelineno-22-5"></a><span class="c1">// - messages: Conversation history (StateKeyMessages).</span>
</span><span id="__span-22-6"><a id="__codelineno-22-6" name="__codelineno-22-6"></a><span class="c1">// - user_input: User input (StateKeyUserInput).</span>
</span><span id="__span-22-7"><a id="__codelineno-22-7" name="__codelineno-22-7"></a><span class="c1">// - last_response: Last response (StateKeyLastResponse).</span>
</span><span id="__span-22-8"><a id="__codelineno-22-8" name="__codelineno-22-8"></a><span class="c1">// - node_responses: Map of nodeID -&gt; response (StateKeyNodeResponses).</span>
</span><span id="__span-22-9"><a id="__codelineno-22-9" name="__codelineno-22-9"></a><span class="c1">// - metadata: Metadata (StateKeyMetadata).</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="9-state-key-usage-scenarios">9. State Key Usage Scenarios</h3>
<p><strong>User-defined State Keys</strong>: Used to store business logic data.</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-23-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-23-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-23-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-23-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-23-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-23-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-23-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-23-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-23-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-23-10">10</a></span>
<span class="normal"><a href="#__codelineno-23-11">11</a></span>
<span class="normal"><a href="#__codelineno-23-12">12</a></span>
<span class="normal"><a href="#__codelineno-23-13">13</a></span>
<span class="normal"><a href="#__codelineno-23-14">14</a></span>
<span class="normal"><a href="#__codelineno-23-15">15</a></span>
<span class="normal"><a href="#__codelineno-23-16">16</a></span>
<span class="normal"><a href="#__codelineno-23-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3"></a><span class="p">)</span>
</span><span id="__span-23-4"><a id="__codelineno-23-4" name="__codelineno-23-4"></a>
</span><span id="__span-23-5"><a id="__codelineno-23-5" name="__codelineno-23-5"></a><span class="c1">// Recommended: Use custom state keys.</span>
</span><span id="__span-23-6"><a id="__codelineno-23-6" name="__codelineno-23-6"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-23-7"><a id="__codelineno-23-7" name="__codelineno-23-7"></a><span class="w">    </span><span class="nx">StateKeyDocumentLength</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;document_length&quot;</span>
</span><span id="__span-23-8"><a id="__codelineno-23-8" name="__codelineno-23-8"></a><span class="w">    </span><span class="nx">StateKeyComplexityLevel</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;complexity_level&quot;</span>
</span><span id="__span-23-9"><a id="__codelineno-23-9" name="__codelineno-23-9"></a><span class="w">    </span><span class="nx">StateKeyProcessingStage</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;processing_stage&quot;</span>
</span><span id="__span-23-10"><a id="__codelineno-23-10" name="__codelineno-23-10"></a><span class="p">)</span>
</span><span id="__span-23-11"><a id="__codelineno-23-11" name="__codelineno-23-11"></a>
</span><span id="__span-23-12"><a id="__codelineno-23-12" name="__codelineno-23-12"></a><span class="c1">// Use in nodes.</span>
</span><span id="__span-23-13"><a id="__codelineno-23-13" name="__codelineno-23-13"></a><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span>
</span><span id="__span-23-14"><a id="__codelineno-23-14" name="__codelineno-23-14"></a><span class="w">    </span><span class="nx">StateKeyDocumentLength</span><span class="p">:</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">input</span><span class="p">),</span>
</span><span id="__span-23-15"><a id="__codelineno-23-15" name="__codelineno-23-15"></a><span class="w">    </span><span class="nx">StateKeyComplexityLevel</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;simple&quot;</span><span class="p">,</span>
</span><span id="__span-23-16"><a id="__codelineno-23-16" name="__codelineno-23-16"></a><span class="w">    </span><span class="nx">StateKeyProcessingStage</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;completed&quot;</span><span class="p">,</span>
</span><span id="__span-23-17"><a id="__codelineno-23-17" name="__codelineno-23-17"></a><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span></code></pre></div></td></tr></table></div>
<p><strong>Built-in State Keys</strong>: Used for system integration.</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-24-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-24-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-24-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-24-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-24-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-24-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-24-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-24-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-24-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-24-10">10</a></span>
<span class="normal"><a href="#__codelineno-24-11">11</a></span>
<span class="normal"><a href="#__codelineno-24-12">12</a></span>
<span class="normal"><a href="#__codelineno-24-13">13</a></span>
<span class="normal"><a href="#__codelineno-24-14">14</a></span>
<span class="normal"><a href="#__codelineno-24-15">15</a></span>
<span class="normal"><a href="#__codelineno-24-16">16</a></span>
<span class="normal"><a href="#__codelineno-24-17">17</a></span>
<span class="normal"><a href="#__codelineno-24-18">18</a></span>
<span class="normal"><a href="#__codelineno-24-19">19</a></span>
<span class="normal"><a href="#__codelineno-24-20">20</a></span>
<span class="normal"><a href="#__codelineno-24-21">21</a></span>
<span class="normal"><a href="#__codelineno-24-22">22</a></span>
<span class="normal"><a href="#__codelineno-24-23">23</a></span>
<span class="normal"><a href="#__codelineno-24-24">24</a></span>
<span class="normal"><a href="#__codelineno-24-25">25</a></span>
<span class="normal"><a href="#__codelineno-24-26">26</a></span>
<span class="normal"><a href="#__codelineno-24-27">27</a></span>
<span class="normal"><a href="#__codelineno-24-28">28</a></span>
<span class="normal"><a href="#__codelineno-24-29">29</a></span>
<span class="normal"><a href="#__codelineno-24-30">30</a></span>
<span class="normal"><a href="#__codelineno-24-31">31</a></span>
<span class="normal"><a href="#__codelineno-24-32">32</a></span>
<span class="normal"><a href="#__codelineno-24-33">33</a></span>
<span class="normal"><a href="#__codelineno-24-34">34</a></span>
<span class="normal"><a href="#__codelineno-24-35">35</a></span>
<span class="normal"><a href="#__codelineno-24-36">36</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2"></a><span class="w">    </span><span class="s">&quot;time&quot;</span>
</span><span id="__span-24-3"><a id="__codelineno-24-3" name="__codelineno-24-3"></a>
</span><span id="__span-24-4"><a id="__codelineno-24-4" name="__codelineno-24-4"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-24-5"><a id="__codelineno-24-5" name="__codelineno-24-5"></a><span class="p">)</span>
</span><span id="__span-24-6"><a id="__codelineno-24-6" name="__codelineno-24-6"></a>
</span><span id="__span-24-7"><a id="__codelineno-24-7" name="__codelineno-24-7"></a><span class="c1">// Get user input (automatically set by system).</span>
</span><span id="__span-24-8"><a id="__codelineno-24-8" name="__codelineno-24-8"></a><span class="nx">userInput</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">state</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyUserInput</span><span class="p">].(</span><span class="kt">string</span><span class="p">)</span>
</span><span id="__span-24-9"><a id="__codelineno-24-9" name="__codelineno-24-9"></a>
</span><span id="__span-24-10"><a id="__codelineno-24-10" name="__codelineno-24-10"></a><span class="c1">// Set final output (system will read this value).</span>
</span><span id="__span-24-11"><a id="__codelineno-24-11" name="__codelineno-24-11"></a><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span>
</span><span id="__span-24-12"><a id="__codelineno-24-12" name="__codelineno-24-12"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyLastResponse</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Processing complete&quot;</span><span class="p">,</span>
</span><span id="__span-24-13"><a id="__codelineno-24-13" name="__codelineno-24-13"></a><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-24-14"><a id="__codelineno-24-14" name="__codelineno-24-14"></a>
</span><span id="__span-24-15"><a id="__codelineno-24-15" name="__codelineno-24-15"></a><span class="c1">// Read per-node responses when multiple nodes (e.g., parallel LLM nodes)</span>
</span><span id="__span-24-16"><a id="__codelineno-24-16" name="__codelineno-24-16"></a><span class="c1">// produce outputs. Values are stored as a map[nodeID]any and merged across</span>
</span><span id="__span-24-17"><a id="__codelineno-24-17" name="__codelineno-24-17"></a><span class="c1">// steps. Use LastResponse for the final serial output; use NodeResponses for</span>
</span><span id="__span-24-18"><a id="__codelineno-24-18" name="__codelineno-24-18"></a><span class="c1">// converged parallel outputs.</span>
</span><span id="__span-24-19"><a id="__codelineno-24-19" name="__codelineno-24-19"></a><span class="nx">responses</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">state</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyNodeResponses</span><span class="p">].(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">any</span><span class="p">)</span>
</span><span id="__span-24-20"><a id="__codelineno-24-20" name="__codelineno-24-20"></a><span class="nx">news</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">responses</span><span class="p">[</span><span class="s">&quot;news&quot;</span><span class="p">].(</span><span class="kt">string</span><span class="p">)</span>
</span><span id="__span-24-21"><a id="__codelineno-24-21" name="__codelineno-24-21"></a><span class="nx">dialog</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">responses</span><span class="p">[</span><span class="s">&quot;dialog&quot;</span><span class="p">].(</span><span class="kt">string</span><span class="p">)</span>
</span><span id="__span-24-22"><a id="__codelineno-24-22" name="__codelineno-24-22"></a>
</span><span id="__span-24-23"><a id="__codelineno-24-23" name="__codelineno-24-23"></a><span class="c1">// Use them separately or combine into the final output.</span>
</span><span id="__span-24-24"><a id="__codelineno-24-24" name="__codelineno-24-24"></a><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span>
</span><span id="__span-24-25"><a id="__codelineno-24-25" name="__codelineno-24-25"></a><span class="w">    </span><span class="s">&quot;news_output&quot;</span><span class="p">:</span><span class="w">  </span><span class="nx">news</span><span class="p">,</span>
</span><span id="__span-24-26"><a id="__codelineno-24-26" name="__codelineno-24-26"></a><span class="w">    </span><span class="s">&quot;dialog_output&quot;</span><span class="p">:</span><span class="w"> </span><span class="nx">dialog</span><span class="p">,</span>
</span><span id="__span-24-27"><a id="__codelineno-24-27" name="__codelineno-24-27"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyLastResponse</span><span class="p">:</span><span class="w"> </span><span class="nx">news</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;\n&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">dialog</span><span class="p">,</span>
</span><span id="__span-24-28"><a id="__codelineno-24-28" name="__codelineno-24-28"></a><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-24-29"><a id="__codelineno-24-29" name="__codelineno-24-29"></a>
</span><span id="__span-24-30"><a id="__codelineno-24-30" name="__codelineno-24-30"></a><span class="c1">// Store metadata.</span>
</span><span id="__span-24-31"><a id="__codelineno-24-31" name="__codelineno-24-31"></a><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span>
</span><span id="__span-24-32"><a id="__codelineno-24-32" name="__codelineno-24-32"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyMetadata</span><span class="p">:</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">any</span><span class="p">{</span>
</span><span id="__span-24-33"><a id="__codelineno-24-33" name="__codelineno-24-33"></a><span class="w">        </span><span class="s">&quot;timestamp&quot;</span><span class="p">:</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">(),</span>
</span><span id="__span-24-34"><a id="__codelineno-24-34" name="__codelineno-24-34"></a><span class="w">        </span><span class="s">&quot;version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1.0&quot;</span><span class="p">,</span>
</span><span id="__span-24-35"><a id="__codelineno-24-35" name="__codelineno-24-35"></a><span class="w">    </span><span class="p">},</span>
</span><span id="__span-24-36"><a id="__codelineno-24-36" name="__codelineno-24-36"></a><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span></code></pre></div></td></tr></table></div>
<h2 id="advanced-features">Advanced Features</h2>
<h3 id="1-interrupt-and-resume-human-in-the-loop">1. Interrupt and Resume (Human-in-the-Loop)</h3>
<p>The Graph package supports human-in-the-loop (HITL) workflows through interrupt and resume functionality. This enables workflows to pause execution, wait for human input or approval, and then resume from the exact point where they were interrupted.</p>
<h4 id="basic-usage">Basic Usage</h4>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-25-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-25-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-25-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-25-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-25-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-25-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-25-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-25-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-25-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-25-10">10</a></span>
<span class="normal"><a href="#__codelineno-25-11">11</a></span>
<span class="normal"><a href="#__codelineno-25-12">12</a></span>
<span class="normal"><a href="#__codelineno-25-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2"></a><span class="w">    </span><span class="s">&quot;context&quot;</span>
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-25-4"><a id="__codelineno-25-4" name="__codelineno-25-4"></a><span class="p">)</span>
</span><span id="__span-25-5"><a id="__codelineno-25-5" name="__codelineno-25-5"></a>
</span><span id="__span-25-6"><a id="__codelineno-25-6" name="__codelineno-25-6"></a><span class="c1">// Create a node that can interrupt execution for human input</span>
</span><span id="__span-25-7"><a id="__codelineno-25-7" name="__codelineno-25-7"></a><span class="nx">b</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;approval_node&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-8"><a id="__codelineno-25-8" name="__codelineno-25-8"></a><span class="w">    </span><span class="c1">// Use the Interrupt helper for clean interrupt/resume handling</span>
</span><span id="__span-25-9"><a id="__codelineno-25-9" name="__codelineno-25-9"></a><span class="w">    </span><span class="nx">prompt</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">any</span><span class="p">{</span>
</span><span id="__span-25-10"><a id="__codelineno-25-10" name="__codelineno-25-10"></a><span class="w">        </span><span class="s">&quot;message&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Please approve this action (yes/no):&quot;</span><span class="p">,</span>
</span><span id="__span-25-11"><a id="__codelineno-25-11" name="__codelineno-25-11"></a><span class="w">        </span><span class="s">&quot;data&quot;</span><span class="p">:</span><span class="w">    </span><span class="nx">s</span><span class="p">[</span><span class="s">&quot;some_data&quot;</span><span class="p">],</span>
</span><span id="__span-25-12"><a id="__codelineno-25-12" name="__codelineno-25-12"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-25-13"><a id="__codelineno-25-13" name="__codelineno-25-13"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>Turn the diagram into a runnable workflow:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-26-1">  1</a></span>
<span class="normal"><a href="#__codelineno-26-2">  2</a></span>
<span class="normal"><a href="#__codelineno-26-3">  3</a></span>
<span class="normal"><a href="#__codelineno-26-4">  4</a></span>
<span class="normal"><a href="#__codelineno-26-5">  5</a></span>
<span class="normal"><a href="#__codelineno-26-6">  6</a></span>
<span class="normal"><a href="#__codelineno-26-7">  7</a></span>
<span class="normal"><a href="#__codelineno-26-8">  8</a></span>
<span class="normal"><a href="#__codelineno-26-9">  9</a></span>
<span class="normal"><a href="#__codelineno-26-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-26-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-26-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-26-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-26-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-26-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-26-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-26-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-26-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-26-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-26-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-26-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-26-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-26-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-26-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-26-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-26-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-26-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-26-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-26-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-26-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-26-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-26-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-26-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-26-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-26-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-26-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-26-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-26-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-26-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-26-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-26-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-26-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-26-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-26-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-26-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-26-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-26-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-26-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-26-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-26-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-26-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-26-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-26-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-26-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-26-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-26-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-26-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-26-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-26-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-26-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-26-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-26-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-26-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-26-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-26-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-26-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-26-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-26-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-26-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-26-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-26-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-26-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-26-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-26-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-26-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-26-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-26-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-26-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-26-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-26-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-26-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-26-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-26-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-26-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-26-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-26-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-26-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-26-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-26-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-26-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-26-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-26-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-26-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-26-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-26-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-26-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-26-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-26-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-26-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-26-100">100</a></span>
<span class="normal"><a href="#__codelineno-26-101">101</a></span>
<span class="normal"><a href="#__codelineno-26-102">102</a></span>
<span class="normal"><a href="#__codelineno-26-103">103</a></span>
<span class="normal"><a href="#__codelineno-26-104">104</a></span>
<span class="normal"><a href="#__codelineno-26-105">105</a></span>
<span class="normal"><a href="#__codelineno-26-106">106</a></span>
<span class="normal"><a href="#__codelineno-26-107">107</a></span>
<span class="normal"><a href="#__codelineno-26-108">108</a></span>
<span class="normal"><a href="#__codelineno-26-109">109</a></span>
<span class="normal"><a href="#__codelineno-26-110">110</a></span>
<span class="normal"><a href="#__codelineno-26-111">111</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1"></a><span class="kn">package</span><span class="w"> </span><span class="nx">main</span>
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2"></a>
</span><span id="__span-26-3"><a id="__codelineno-26-3" name="__codelineno-26-3"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-26-4"><a id="__codelineno-26-4" name="__codelineno-26-4"></a><span class="w">    </span><span class="s">&quot;context&quot;</span>
</span><span id="__span-26-5"><a id="__codelineno-26-5" name="__codelineno-26-5"></a><span class="w">    </span><span class="s">&quot;fmt&quot;</span>
</span><span id="__span-26-6"><a id="__codelineno-26-6" name="__codelineno-26-6"></a><span class="w">    </span><span class="s">&quot;strings&quot;</span>
</span><span id="__span-26-7"><a id="__codelineno-26-7" name="__codelineno-26-7"></a>
</span><span id="__span-26-8"><a id="__codelineno-26-8" name="__codelineno-26-8"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/agent/graphagent&quot;</span>
</span><span id="__span-26-9"><a id="__codelineno-26-9" name="__codelineno-26-9"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-26-10"><a id="__codelineno-26-10" name="__codelineno-26-10"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/model&quot;</span>
</span><span id="__span-26-11"><a id="__codelineno-26-11" name="__codelineno-26-11"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/model/openai&quot;</span>
</span><span id="__span-26-12"><a id="__codelineno-26-12" name="__codelineno-26-12"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/runner&quot;</span>
</span><span id="__span-26-13"><a id="__codelineno-26-13" name="__codelineno-26-13"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/tool&quot;</span>
</span><span id="__span-26-14"><a id="__codelineno-26-14" name="__codelineno-26-14"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/tool/function&quot;</span>
</span><span id="__span-26-15"><a id="__codelineno-26-15" name="__codelineno-26-15"></a><span class="p">)</span>
</span><span id="__span-26-16"><a id="__codelineno-26-16" name="__codelineno-26-16"></a>
</span><span id="__span-26-17"><a id="__codelineno-26-17" name="__codelineno-26-17"></a><span class="c1">// Unexported constants to avoid magic strings</span>
</span><span id="__span-26-18"><a id="__codelineno-26-18" name="__codelineno-26-18"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-26-19"><a id="__codelineno-26-19" name="__codelineno-26-19"></a><span class="w">    </span><span class="nx">nodePrepare</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;prepare&quot;</span>
</span><span id="__span-26-20"><a id="__codelineno-26-20" name="__codelineno-26-20"></a><span class="w">    </span><span class="nx">nodeAsk</span><span class="w">      </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;ask&quot;</span>
</span><span id="__span-26-21"><a id="__codelineno-26-21" name="__codelineno-26-21"></a><span class="w">    </span><span class="nx">nodeTools</span><span class="w">    </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;tools&quot;</span>
</span><span id="__span-26-22"><a id="__codelineno-26-22" name="__codelineno-26-22"></a><span class="w">    </span><span class="nx">nodeFallback</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;fallback&quot;</span>
</span><span id="__span-26-23"><a id="__codelineno-26-23" name="__codelineno-26-23"></a><span class="w">    </span><span class="nx">nodeFinish</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;finish&quot;</span>
</span><span id="__span-26-24"><a id="__codelineno-26-24" name="__codelineno-26-24"></a>
</span><span id="__span-26-25"><a id="__codelineno-26-25" name="__codelineno-26-25"></a><span class="w">    </span><span class="nx">modelName</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;gpt-4o-mini&quot;</span>
</span><span id="__span-26-26"><a id="__codelineno-26-26" name="__codelineno-26-26"></a><span class="w">    </span><span class="nx">systemPrompt</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;You are a careful assistant.&quot;</span>
</span><span id="__span-26-27"><a id="__codelineno-26-27" name="__codelineno-26-27"></a><span class="w">    </span><span class="nx">outputKeyFinal</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;final_output&quot;</span>
</span><span id="__span-26-28"><a id="__codelineno-26-28" name="__codelineno-26-28"></a>
</span><span id="__span-26-29"><a id="__codelineno-26-29" name="__codelineno-26-29"></a><span class="w">    </span><span class="nx">toolNameCalculator</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;calculator&quot;</span>
</span><span id="__span-26-30"><a id="__codelineno-26-30" name="__codelineno-26-30"></a>
</span><span id="__span-26-31"><a id="__codelineno-26-31" name="__codelineno-26-31"></a><span class="w">    </span><span class="nx">demoUserID</span><span class="w">    </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;user&quot;</span>
</span><span id="__span-26-32"><a id="__codelineno-26-32" name="__codelineno-26-32"></a><span class="w">    </span><span class="nx">demoSessionID</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;session&quot;</span>
</span><span id="__span-26-33"><a id="__codelineno-26-33" name="__codelineno-26-33"></a><span class="w">    </span><span class="nx">demoQuestion</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;What is 6 * 7?&quot;</span>
</span><span id="__span-26-34"><a id="__codelineno-26-34" name="__codelineno-26-34"></a><span class="p">)</span>
</span><span id="__span-26-35"><a id="__codelineno-26-35" name="__codelineno-26-35"></a>
</span><span id="__span-26-36"><a id="__codelineno-26-36" name="__codelineno-26-36"></a><span class="kd">func</span><span class="w"> </span><span class="nx">newCalculator</span><span class="p">()</span><span class="w"> </span><span class="nx">tool</span><span class="p">.</span><span class="nx">Tool</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-37"><a id="__codelineno-26-37" name="__codelineno-26-37"></a><span class="w">    </span><span class="kd">type</span><span class="w"> </span><span class="nx">Input</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-38"><a id="__codelineno-26-38" name="__codelineno-26-38"></a><span class="w">        </span><span class="nx">Expression</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="s">`json:&quot;expression&quot;`</span>
</span><span id="__span-26-39"><a id="__codelineno-26-39" name="__codelineno-26-39"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-26-40"><a id="__codelineno-26-40" name="__codelineno-26-40"></a><span class="w">    </span><span class="kd">type</span><span class="w"> </span><span class="nx">Output</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-41"><a id="__codelineno-26-41" name="__codelineno-26-41"></a><span class="w">        </span><span class="nx">Result</span><span class="w"> </span><span class="kt">float64</span><span class="w"> </span><span class="s">`json:&quot;result&quot;`</span>
</span><span id="__span-26-42"><a id="__codelineno-26-42" name="__codelineno-26-42"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-26-43"><a id="__codelineno-26-43" name="__codelineno-26-43"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">function</span><span class="p">.</span><span class="nx">NewFunctionTool</span><span class="p">[</span><span class="nx">Input</span><span class="p">,</span><span class="w"> </span><span class="nx">Output</span><span class="p">](</span>
</span><span id="__span-26-44"><a id="__codelineno-26-44" name="__codelineno-26-44"></a><span class="w">        </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">in</span><span class="w"> </span><span class="nx">Input</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nx">Output</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-45"><a id="__codelineno-26-45" name="__codelineno-26-45"></a><span class="w">            </span><span class="c1">// Implement a real evaluator here</span>
</span><span id="__span-26-46"><a id="__codelineno-26-46" name="__codelineno-26-46"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">Output</span><span class="p">{</span><span class="nx">Result</span><span class="p">:</span><span class="w"> </span><span class="mi">42</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-26-47"><a id="__codelineno-26-47" name="__codelineno-26-47"></a><span class="w">        </span><span class="p">},</span>
</span><span id="__span-26-48"><a id="__codelineno-26-48" name="__codelineno-26-48"></a><span class="w">        </span><span class="nx">function</span><span class="p">.</span><span class="nx">WithName</span><span class="p">(</span><span class="nx">toolNameCalculator</span><span class="p">),</span>
</span><span id="__span-26-49"><a id="__codelineno-26-49" name="__codelineno-26-49"></a><span class="w">        </span><span class="nx">function</span><span class="p">.</span><span class="nx">WithDescription</span><span class="p">(</span><span class="s">&quot;Evaluate a math expression&quot;</span><span class="p">),</span>
</span><span id="__span-26-50"><a id="__codelineno-26-50" name="__codelineno-26-50"></a><span class="w">    </span><span class="p">)</span>
</span><span id="__span-26-51"><a id="__codelineno-26-51" name="__codelineno-26-51"></a><span class="p">}</span>
</span><span id="__span-26-52"><a id="__codelineno-26-52" name="__codelineno-26-52"></a>
</span><span id="__span-26-53"><a id="__codelineno-26-53" name="__codelineno-26-53"></a><span class="kd">func</span><span class="w"> </span><span class="nx">buildWorkflow</span><span class="p">(</span><span class="nx">m</span><span class="w"> </span><span class="nx">model</span><span class="p">.</span><span class="nx">Model</span><span class="p">,</span><span class="w"> </span><span class="nx">tools</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">tool</span><span class="p">.</span><span class="nx">Tool</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">graph</span><span class="p">.</span><span class="nx">Graph</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-54"><a id="__codelineno-26-54" name="__codelineno-26-54"></a><span class="w">    </span><span class="nx">sg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateGraph</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">MessagesStateSchema</span><span class="p">())</span>
</span><span id="__span-26-55"><a id="__codelineno-26-55" name="__codelineno-26-55"></a>
</span><span id="__span-26-56"><a id="__codelineno-26-56" name="__codelineno-26-56"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="nx">nodePrepare</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-57"><a id="__codelineno-26-57" name="__codelineno-26-57"></a><span class="w">        </span><span class="nx">raw</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprint</span><span class="p">(</span><span class="nx">s</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyUserInput</span><span class="p">])</span>
</span><span id="__span-26-58"><a id="__codelineno-26-58" name="__codelineno-26-58"></a><span class="w">        </span><span class="nx">cleaned</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">strings</span><span class="p">.</span><span class="nx">TrimSpace</span><span class="p">(</span><span class="nx">raw</span><span class="p">)</span>
</span><span id="__span-26-59"><a id="__codelineno-26-59" name="__codelineno-26-59"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyUserInput</span><span class="p">:</span><span class="w"> </span><span class="nx">cleaned</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-26-60"><a id="__codelineno-26-60" name="__codelineno-26-60"></a><span class="w">    </span><span class="p">})</span>
</span><span id="__span-26-61"><a id="__codelineno-26-61" name="__codelineno-26-61"></a>
</span><span id="__span-26-62"><a id="__codelineno-26-62" name="__codelineno-26-62"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddLLMNode</span><span class="p">(</span><span class="nx">nodeAsk</span><span class="p">,</span><span class="w"> </span><span class="nx">m</span><span class="p">,</span><span class="w"> </span><span class="nx">systemPrompt</span><span class="p">,</span><span class="w"> </span><span class="nx">tools</span><span class="p">)</span>
</span><span id="__span-26-63"><a id="__codelineno-26-63" name="__codelineno-26-63"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddToolsNode</span><span class="p">(</span><span class="nx">nodeTools</span><span class="p">,</span><span class="w"> </span><span class="nx">tools</span><span class="p">)</span>
</span><span id="__span-26-64"><a id="__codelineno-26-64" name="__codelineno-26-64"></a>
</span><span id="__span-26-65"><a id="__codelineno-26-65" name="__codelineno-26-65"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="nx">nodeFallback</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-66"><a id="__codelineno-26-66" name="__codelineno-26-66"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyLastResponse</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;No tools required; answer directly&quot;</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-26-67"><a id="__codelineno-26-67" name="__codelineno-26-67"></a><span class="w">    </span><span class="p">})</span>
</span><span id="__span-26-68"><a id="__codelineno-26-68" name="__codelineno-26-68"></a>
</span><span id="__span-26-69"><a id="__codelineno-26-69" name="__codelineno-26-69"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="nx">nodeFinish</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-70"><a id="__codelineno-26-70" name="__codelineno-26-70"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="nx">outputKeyFinal</span><span class="p">:</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprint</span><span class="p">(</span><span class="nx">s</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyLastResponse</span><span class="p">])},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-26-71"><a id="__codelineno-26-71" name="__codelineno-26-71"></a><span class="w">    </span><span class="p">})</span>
</span><span id="__span-26-72"><a id="__codelineno-26-72" name="__codelineno-26-72"></a>
</span><span id="__span-26-73"><a id="__codelineno-26-73" name="__codelineno-26-73"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">SetEntryPoint</span><span class="p">(</span><span class="nx">nodePrepare</span><span class="p">)</span>
</span><span id="__span-26-74"><a id="__codelineno-26-74" name="__codelineno-26-74"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddEdge</span><span class="p">(</span><span class="nx">nodePrepare</span><span class="p">,</span><span class="w"> </span><span class="nx">nodeAsk</span><span class="p">)</span>
</span><span id="__span-26-75"><a id="__codelineno-26-75" name="__codelineno-26-75"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddToolsConditionalEdges</span><span class="p">(</span><span class="nx">nodeAsk</span><span class="p">,</span><span class="w"> </span><span class="nx">nodeTools</span><span class="p">,</span><span class="w"> </span><span class="nx">nodeFallback</span><span class="p">)</span>
</span><span id="__span-26-76"><a id="__codelineno-26-76" name="__codelineno-26-76"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddEdge</span><span class="p">(</span><span class="nx">nodeTools</span><span class="p">,</span><span class="w"> </span><span class="nx">nodeAsk</span><span class="p">)</span>
</span><span id="__span-26-77"><a id="__codelineno-26-77" name="__codelineno-26-77"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddEdge</span><span class="p">(</span><span class="nx">nodeFallback</span><span class="p">,</span><span class="w"> </span><span class="nx">nodeFinish</span><span class="p">)</span>
</span><span id="__span-26-78"><a id="__codelineno-26-78" name="__codelineno-26-78"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">SetFinishPoint</span><span class="p">(</span><span class="nx">nodeFinish</span><span class="p">)</span>
</span><span id="__span-26-79"><a id="__codelineno-26-79" name="__codelineno-26-79"></a>
</span><span id="__span-26-80"><a id="__codelineno-26-80" name="__codelineno-26-80"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">sg</span><span class="p">.</span><span class="nx">Compile</span><span class="p">()</span>
</span><span id="__span-26-81"><a id="__codelineno-26-81" name="__codelineno-26-81"></a><span class="p">}</span>
</span><span id="__span-26-82"><a id="__codelineno-26-82" name="__codelineno-26-82"></a>
</span><span id="__span-26-83"><a id="__codelineno-26-83" name="__codelineno-26-83"></a><span class="kd">func</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-84"><a id="__codelineno-26-84" name="__codelineno-26-84"></a><span class="w">    </span><span class="nx">mdl</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">openai</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="nx">modelName</span><span class="p">)</span>
</span><span id="__span-26-85"><a id="__codelineno-26-85" name="__codelineno-26-85"></a><span class="w">    </span><span class="nx">tools</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">tool</span><span class="p">.</span><span class="nx">Tool</span><span class="p">{</span><span class="nx">toolNameCalculator</span><span class="p">:</span><span class="w"> </span><span class="nx">newCalculator</span><span class="p">()}</span>
</span><span id="__span-26-86"><a id="__codelineno-26-86" name="__codelineno-26-86"></a>
</span><span id="__span-26-87"><a id="__codelineno-26-87" name="__codelineno-26-87"></a><span class="w">    </span><span class="nx">g</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">buildWorkflow</span><span class="p">(</span><span class="nx">mdl</span><span class="p">,</span><span class="w"> </span><span class="nx">tools</span><span class="p">)</span>
</span><span id="__span-26-88"><a id="__codelineno-26-88" name="__codelineno-26-88"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-89"><a id="__codelineno-26-89" name="__codelineno-26-89"></a><span class="w">        </span><span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span id="__span-26-90"><a id="__codelineno-26-90" name="__codelineno-26-90"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-26-91"><a id="__codelineno-26-91" name="__codelineno-26-91"></a>
</span><span id="__span-26-92"><a id="__codelineno-26-92" name="__codelineno-26-92"></a><span class="w">    </span><span class="c1">// Run with GraphAgent + Runner (no direct Executor.Execute)</span>
</span><span id="__span-26-93"><a id="__codelineno-26-93" name="__codelineno-26-93"></a><span class="w">    </span><span class="nx">ga</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;demo&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">g</span><span class="p">)</span>
</span><span id="__span-26-94"><a id="__codelineno-26-94" name="__codelineno-26-94"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-95"><a id="__codelineno-26-95" name="__codelineno-26-95"></a><span class="w">        </span><span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span id="__span-26-96"><a id="__codelineno-26-96" name="__codelineno-26-96"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-26-97"><a id="__codelineno-26-97" name="__codelineno-26-97"></a><span class="w">    </span><span class="nx">app</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">runner</span><span class="p">.</span><span class="nx">NewRunner</span><span class="p">(</span><span class="s">&quot;app&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">ga</span><span class="p">)</span>
</span><span id="__span-26-98"><a id="__codelineno-26-98" name="__codelineno-26-98"></a><span class="w">    </span><span class="nx">events</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">app</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Background</span><span class="p">(),</span><span class="w"> </span><span class="nx">demoUserID</span><span class="p">,</span><span class="w"> </span><span class="nx">demoSessionID</span><span class="p">,</span>
</span><span id="__span-26-99"><a id="__codelineno-26-99" name="__codelineno-26-99"></a><span class="w">        </span><span class="nx">model</span><span class="p">.</span><span class="nx">NewUserMessage</span><span class="p">(</span><span class="nx">demoQuestion</span><span class="p">))</span>
</span><span id="__span-26-100"><a id="__codelineno-26-100" name="__codelineno-26-100"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-101"><a id="__codelineno-26-101" name="__codelineno-26-101"></a><span class="w">        </span><span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span id="__span-26-102"><a id="__codelineno-26-102" name="__codelineno-26-102"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-26-103"><a id="__codelineno-26-103" name="__codelineno-26-103"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">ev</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">events</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-104"><a id="__codelineno-26-104" name="__codelineno-26-104"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">ev</span><span class="p">.</span><span class="nx">Response</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-105"><a id="__codelineno-26-105" name="__codelineno-26-105"></a><span class="w">            </span><span class="k">continue</span>
</span><span id="__span-26-106"><a id="__codelineno-26-106" name="__codelineno-26-106"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-26-107"><a id="__codelineno-26-107" name="__codelineno-26-107"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">ev</span><span class="p">.</span><span class="nx">Author</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">nodeAsk</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">!</span><span class="nx">ev</span><span class="p">.</span><span class="nx">Response</span><span class="p">.</span><span class="nx">IsPartial</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">ev</span><span class="p">.</span><span class="nx">Response</span><span class="p">.</span><span class="nx">Choices</span><span class="p">)</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-108"><a id="__codelineno-26-108" name="__codelineno-26-108"></a><span class="w">            </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;LLM:&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">ev</span><span class="p">.</span><span class="nx">Response</span><span class="p">.</span><span class="nx">Choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">Message</span><span class="p">.</span><span class="nx">Content</span><span class="p">)</span>
</span><span id="__span-26-109"><a id="__codelineno-26-109" name="__codelineno-26-109"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-26-110"><a id="__codelineno-26-110" name="__codelineno-26-110"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-26-111"><a id="__codelineno-26-111" name="__codelineno-26-111"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>The example shows how to declare nodes, connect edges, and run. Next, we’ll cover execution with GraphAgent + Runner, then core concepts and common practices.</p>
<h3 id="execution">Execution</h3>
<ul>
<li>Wrap the compiled graph with <code>graphagent.New</code> (as a generic <code>agent.Agent</code>) and hand it to <code>runner.Runner</code> to manage sessions and streaming events.</li>
</ul>
<p>Minimal GraphAgent + Runner:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-27-1">1</a></span>
<span class="normal"><a href="#__codelineno-27-2">2</a></span>
<span class="normal"><a href="#__codelineno-27-3">3</a></span>
<span class="normal"><a href="#__codelineno-27-4">4</a></span>
<span class="normal"><a href="#__codelineno-27-5">5</a></span>
<span class="normal"><a href="#__codelineno-27-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1"></a><span class="nx">compiled</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">buildWorkflow</span><span class="p">(</span><span class="nx">openai</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;gpt-4o-mini&quot;</span><span class="p">),</span><span class="w"> </span><span class="kc">nil</span><span class="p">)</span>
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2"></a><span class="nx">ga</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;demo&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">compiled</span><span class="p">)</span>
</span><span id="__span-27-3"><a id="__codelineno-27-3" name="__codelineno-27-3"></a><span class="nx">app</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">runner</span><span class="p">.</span><span class="nx">NewRunner</span><span class="p">(</span><span class="s">&quot;app&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">ga</span><span class="p">)</span>
</span><span id="__span-27-4"><a id="__codelineno-27-4" name="__codelineno-27-4"></a>
</span><span id="__span-27-5"><a id="__codelineno-27-5" name="__codelineno-27-5"></a><span class="nx">events</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">app</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;user&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;session&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">model</span><span class="p">.</span><span class="nx">NewUserMessage</span><span class="p">(</span><span class="s">&quot;hi&quot;</span><span class="p">))</span>
</span><span id="__span-27-6"><a id="__codelineno-27-6" name="__codelineno-27-6"></a><span class="k">for</span><span class="w"> </span><span class="nx">ev</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">events</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* handle events */</span><span class="w"> </span><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>Session backends:
- In-memory: <code>session/inmemory</code> (used by examples)
- Redis: <code>session/redis</code> (more common in production)</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-28-1">1</a></span>
<span class="normal"><a href="#__codelineno-28-2">2</a></span>
<span class="normal"><a href="#__codelineno-28-3">3</a></span>
<span class="normal"><a href="#__codelineno-28-4">4</a></span>
<span class="normal"><a href="#__codelineno-28-5">5</a></span>
<span class="normal"><a href="#__codelineno-28-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/session/redis&quot;</span>
</span><span id="__span-28-3"><a id="__codelineno-28-3" name="__codelineno-28-3"></a><span class="p">)</span>
</span><span id="__span-28-4"><a id="__codelineno-28-4" name="__codelineno-28-4"></a>
</span><span id="__span-28-5"><a id="__codelineno-28-5" name="__codelineno-28-5"></a><span class="nx">sess</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">redis</span><span class="p">.</span><span class="nx">NewService</span><span class="p">(</span><span class="nx">redis</span><span class="p">.</span><span class="nx">WithRedisClientURL</span><span class="p">(</span><span class="s">&quot;redis://localhost:6379&quot;</span><span class="p">))</span>
</span><span id="__span-28-6"><a id="__codelineno-28-6" name="__codelineno-28-6"></a><span class="nx">app</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">runner</span><span class="p">.</span><span class="nx">NewRunner</span><span class="p">(</span><span class="s">&quot;app&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">ga</span><span class="p">,</span><span class="w"> </span><span class="nx">runner</span><span class="p">.</span><span class="nx">WithSessionService</span><span class="p">(</span><span class="nx">sess</span><span class="p">))</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="graphagent-options">GraphAgent Options</h3>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-29-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-29-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-29-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-29-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-29-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-29-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-29-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-29-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-29-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-29-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1"></a><span class="nx">ga</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span>
</span><span id="__span-29-2"><a id="__codelineno-29-2" name="__codelineno-29-2"></a><span class="w">    </span><span class="s">&quot;workflow&quot;</span><span class="p">,</span>
</span><span id="__span-29-3"><a id="__codelineno-29-3" name="__codelineno-29-3"></a><span class="w">    </span><span class="nx">compiledGraph</span><span class="p">,</span>
</span><span id="__span-29-4"><a id="__codelineno-29-4" name="__codelineno-29-4"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithDescription</span><span class="p">(</span><span class="s">&quot;Workflow description&quot;</span><span class="p">),</span>
</span><span id="__span-29-5"><a id="__codelineno-29-5" name="__codelineno-29-5"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithInitialState</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="s">&quot;init&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">}),</span>
</span><span id="__span-29-6"><a id="__codelineno-29-6" name="__codelineno-29-6"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithChannelBufferSize</span><span class="p">(</span><span class="mi">512</span><span class="p">),</span>
</span><span id="__span-29-7"><a id="__codelineno-29-7" name="__codelineno-29-7"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithCheckpointSaver</span><span class="p">(</span><span class="nx">saver</span><span class="p">),</span>
</span><span id="__span-29-8"><a id="__codelineno-29-8" name="__codelineno-29-8"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithSubAgents</span><span class="p">([]</span><span class="nx">agent</span><span class="p">.</span><span class="nx">Agent</span><span class="p">{</span><span class="nx">subAgent</span><span class="p">}),</span>
</span><span id="__span-29-9"><a id="__codelineno-29-9" name="__codelineno-29-9"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithAgentCallbacks</span><span class="p">(</span><span class="nx">agent</span><span class="p">.</span><span class="nx">NewCallbacks</span><span class="p">()),</span>
</span><span id="__span-29-10"><a id="__codelineno-29-10" name="__codelineno-29-10"></a><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<h2 id="core-concepts_1">Core Concepts</h2>
<h3 id="state-management">State Management</h3>
<p>GraphAgent uses a Schema + Reducer model to manage state. You first define the state shape and merge rules; later nodes have clear expectations about the origin and lifecycle of keys they read/write.</p>
<h4 id="builtin-schema">Built‑in Schema</h4>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-30-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-30-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-30-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-30-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-30-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-30-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-30-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-30-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-30-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-30-10">10</a></span>
<span class="normal"><a href="#__codelineno-30-11">11</a></span>
<span class="normal"><a href="#__codelineno-30-12">12</a></span>
<span class="normal"><a href="#__codelineno-30-13">13</a></span>
<span class="normal"><a href="#__codelineno-30-14">14</a></span>
<span class="normal"><a href="#__codelineno-30-15">15</a></span>
<span class="normal"><a href="#__codelineno-30-16">16</a></span>
<span class="normal"><a href="#__codelineno-30-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-30-2"><a id="__codelineno-30-2" name="__codelineno-30-2"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-30-3"><a id="__codelineno-30-3" name="__codelineno-30-3"></a><span class="p">)</span>
</span><span id="__span-30-4"><a id="__codelineno-30-4" name="__codelineno-30-4"></a>
</span><span id="__span-30-5"><a id="__codelineno-30-5" name="__codelineno-30-5"></a><span class="nx">schema</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">MessagesStateSchema</span><span class="p">()</span>
</span><span id="__span-30-6"><a id="__codelineno-30-6" name="__codelineno-30-6"></a>
</span><span id="__span-30-7"><a id="__codelineno-30-7" name="__codelineno-30-7"></a><span class="c1">// Predefined fields (key constants) and semantics:</span>
</span><span id="__span-30-8"><a id="__codelineno-30-8" name="__codelineno-30-8"></a><span class="c1">// - graph.StateKeyMessages       (&quot;messages&quot;)        Conversation history ([]model.Message; MessageReducer + MessageOp for atomic updates)</span>
</span><span id="__span-30-9"><a id="__codelineno-30-9" name="__codelineno-30-9"></a><span class="c1">// - graph.StateKeyUserInput      (&quot;user_input&quot;)      User input (string; one-shot; cleared after successful execution)</span>
</span><span id="__span-30-10"><a id="__codelineno-30-10" name="__codelineno-30-10"></a><span class="c1">// - graph.StateKeyLastResponse   (&quot;last_response&quot;)   Last response (string)</span>
</span><span id="__span-30-11"><a id="__codelineno-30-11" name="__codelineno-30-11"></a><span class="c1">// - graph.StateKeyNodeResponses  (&quot;node_responses&quot;)  Per-node outputs (map[string]any; aggregated across parallel branches)</span>
</span><span id="__span-30-12"><a id="__codelineno-30-12" name="__codelineno-30-12"></a><span class="c1">// - graph.StateKeyMetadata       (&quot;metadata&quot;)        Metadata (map[string]any; merged by MergeReducer)</span>
</span><span id="__span-30-13"><a id="__codelineno-30-13" name="__codelineno-30-13"></a>
</span><span id="__span-30-14"><a id="__codelineno-30-14" name="__codelineno-30-14"></a><span class="c1">// Additional one-shot/system keys (use as needed):</span>
</span><span id="__span-30-15"><a id="__codelineno-30-15" name="__codelineno-30-15"></a><span class="c1">// - graph.StateKeyOneShotMessages (&quot;one_shot_messages&quot;)  One-shot override of this turn&#39;s input ([]model.Message)</span>
</span><span id="__span-30-16"><a id="__codelineno-30-16" name="__codelineno-30-16"></a><span class="c1">// - graph.StateKeySession         (&quot;session&quot;)            Session object (internal)</span>
</span><span id="__span-30-17"><a id="__codelineno-30-17" name="__codelineno-30-17"></a><span class="c1">// - graph.StateKeyExecContext     (&quot;exec_context&quot;)       Execution context (events etc., internal)</span>
</span></code></pre></div></td></tr></table></div>
<h4 id="custom-schema">Custom Schema</h4>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-31-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-31-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-31-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-31-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-31-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-31-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-31-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-31-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-31-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-31-10">10</a></span>
<span class="normal"><a href="#__codelineno-31-11">11</a></span>
<span class="normal"><a href="#__codelineno-31-12">12</a></span>
<span class="normal"><a href="#__codelineno-31-13">13</a></span>
<span class="normal"><a href="#__codelineno-31-14">14</a></span>
<span class="normal"><a href="#__codelineno-31-15">15</a></span>
<span class="normal"><a href="#__codelineno-31-16">16</a></span>
<span class="normal"><a href="#__codelineno-31-17">17</a></span>
<span class="normal"><a href="#__codelineno-31-18">18</a></span>
<span class="normal"><a href="#__codelineno-31-19">19</a></span>
<span class="normal"><a href="#__codelineno-31-20">20</a></span>
<span class="normal"><a href="#__codelineno-31-21">21</a></span>
<span class="normal"><a href="#__codelineno-31-22">22</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-31-2"><a id="__codelineno-31-2" name="__codelineno-31-2"></a><span class="w">    </span><span class="s">&quot;reflect&quot;</span>
</span><span id="__span-31-3"><a id="__codelineno-31-3" name="__codelineno-31-3"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-31-4"><a id="__codelineno-31-4" name="__codelineno-31-4"></a><span class="p">)</span>
</span><span id="__span-31-5"><a id="__codelineno-31-5" name="__codelineno-31-5"></a>
</span><span id="__span-31-6"><a id="__codelineno-31-6" name="__codelineno-31-6"></a><span class="nx">schema</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateSchema</span><span class="p">()</span>
</span><span id="__span-31-7"><a id="__codelineno-31-7" name="__codelineno-31-7"></a>
</span><span id="__span-31-8"><a id="__codelineno-31-8" name="__codelineno-31-8"></a><span class="c1">// Add a custom field</span>
</span><span id="__span-31-9"><a id="__codelineno-31-9" name="__codelineno-31-9"></a><span class="nx">schema</span><span class="p">.</span><span class="nx">AddField</span><span class="p">(</span><span class="s">&quot;counter&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateField</span><span class="p">{</span>
</span><span id="__span-31-10"><a id="__codelineno-31-10" name="__codelineno-31-10"></a><span class="w">    </span><span class="nx">Type</span><span class="p">:</span><span class="w">    </span><span class="nx">reflect</span><span class="p">.</span><span class="nx">TypeOf</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span><span id="__span-31-11"><a id="__codelineno-31-11" name="__codelineno-31-11"></a><span class="w">    </span><span class="nx">Default</span><span class="p">:</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="kt">any</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">},</span>
</span><span id="__span-31-12"><a id="__codelineno-31-12" name="__codelineno-31-12"></a><span class="w">    </span><span class="nx">Reducer</span><span class="p">:</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">old</span><span class="p">,</span><span class="w"> </span><span class="nx">new</span><span class="w"> </span><span class="kt">any</span><span class="p">)</span><span class="w"> </span><span class="kt">any</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-31-13"><a id="__codelineno-31-13" name="__codelineno-31-13"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">old</span><span class="p">.(</span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">new</span><span class="p">.(</span><span class="kt">int</span><span class="p">)</span><span class="w">  </span><span class="c1">// accumulate</span>
</span><span id="__span-31-14"><a id="__codelineno-31-14" name="__codelineno-31-14"></a><span class="w">    </span><span class="p">},</span>
</span><span id="__span-31-15"><a id="__codelineno-31-15" name="__codelineno-31-15"></a><span class="p">})</span>
</span><span id="__span-31-16"><a id="__codelineno-31-16" name="__codelineno-31-16"></a>
</span><span id="__span-31-17"><a id="__codelineno-31-17" name="__codelineno-31-17"></a><span class="c1">// String slice with a built-in reducer</span>
</span><span id="__span-31-18"><a id="__codelineno-31-18" name="__codelineno-31-18"></a><span class="nx">schema</span><span class="p">.</span><span class="nx">AddField</span><span class="p">(</span><span class="s">&quot;items&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateField</span><span class="p">{</span>
</span><span id="__span-31-19"><a id="__codelineno-31-19" name="__codelineno-31-19"></a><span class="w">    </span><span class="nx">Type</span><span class="p">:</span><span class="w">    </span><span class="nx">reflect</span><span class="p">.</span><span class="nx">TypeOf</span><span class="p">([]</span><span class="kt">string</span><span class="p">{}),</span>
</span><span id="__span-31-20"><a id="__codelineno-31-20" name="__codelineno-31-20"></a><span class="w">    </span><span class="nx">Default</span><span class="p">:</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="kt">any</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="p">[]</span><span class="kt">string</span><span class="p">{}</span><span class="w"> </span><span class="p">},</span>
</span><span id="__span-31-21"><a id="__codelineno-31-21" name="__codelineno-31-21"></a><span class="w">    </span><span class="nx">Reducer</span><span class="p">:</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">StringSliceReducer</span><span class="p">,</span>
</span><span id="__span-31-22"><a id="__codelineno-31-22" name="__codelineno-31-22"></a><span class="p">})</span>
</span></code></pre></div></td></tr></table></div>
<p>Reducers ensure fields are merged safely per predefined rules, which is critical under concurrent execution.</p>
<p>Tip: define constants for business keys to avoid scattered magic strings.</p>
<h3 id="node-types">Node Types</h3>
<p>GraphAgent provides four built‑in node types:</p>
<h4 id="function-node">Function Node</h4>
<p>The most basic node, for custom logic:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-32-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-32-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-32-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-32-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-32-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-32-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-32-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-32-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-32-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-32-10">10</a></span>
<span class="normal"><a href="#__codelineno-32-11">11</a></span>
<span class="normal"><a href="#__codelineno-32-12">12</a></span>
<span class="normal"><a href="#__codelineno-32-13">13</a></span>
<span class="normal"><a href="#__codelineno-32-14">14</a></span>
<span class="normal"><a href="#__codelineno-32-15">15</a></span>
<span class="normal"><a href="#__codelineno-32-16">16</a></span>
<span class="normal"><a href="#__codelineno-32-17">17</a></span>
<span class="normal"><a href="#__codelineno-32-18">18</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-32-2"><a id="__codelineno-32-2" name="__codelineno-32-2"></a><span class="w">    </span><span class="s">&quot;context&quot;</span>
</span><span id="__span-32-3"><a id="__codelineno-32-3" name="__codelineno-32-3"></a>
</span><span id="__span-32-4"><a id="__codelineno-32-4" name="__codelineno-32-4"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-32-5"><a id="__codelineno-32-5" name="__codelineno-32-5"></a><span class="p">)</span>
</span><span id="__span-32-6"><a id="__codelineno-32-6" name="__codelineno-32-6"></a>
</span><span id="__span-32-7"><a id="__codelineno-32-7" name="__codelineno-32-7"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-32-8"><a id="__codelineno-32-8" name="__codelineno-32-8"></a><span class="w">    </span><span class="nx">stateKeyInput</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;input&quot;</span>
</span><span id="__span-32-9"><a id="__codelineno-32-9" name="__codelineno-32-9"></a><span class="w">    </span><span class="nx">stateKeyOutput</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;output&quot;</span>
</span><span id="__span-32-10"><a id="__codelineno-32-10" name="__codelineno-32-10"></a><span class="w">    </span><span class="nx">nodeProcess</span><span class="w">    </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;process&quot;</span>
</span><span id="__span-32-11"><a id="__codelineno-32-11" name="__codelineno-32-11"></a><span class="p">)</span>
</span><span id="__span-32-12"><a id="__codelineno-32-12" name="__codelineno-32-12"></a>
</span><span id="__span-32-13"><a id="__codelineno-32-13" name="__codelineno-32-13"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="nx">nodeProcess</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-32-14"><a id="__codelineno-32-14" name="__codelineno-32-14"></a><span class="w">    </span><span class="nx">data</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">state</span><span class="p">[</span><span class="nx">stateKeyInput</span><span class="p">].(</span><span class="kt">string</span><span class="p">)</span>
</span><span id="__span-32-15"><a id="__codelineno-32-15" name="__codelineno-32-15"></a><span class="w">    </span><span class="nx">processed</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">transform</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
</span><span id="__span-32-16"><a id="__codelineno-32-16" name="__codelineno-32-16"></a><span class="w">    </span><span class="c1">// Function nodes must explicitly specify the output key</span>
</span><span id="__span-32-17"><a id="__codelineno-32-17" name="__codelineno-32-17"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="nx">stateKeyOutput</span><span class="p">:</span><span class="w"> </span><span class="nx">processed</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-32-18"><a id="__codelineno-32-18" name="__codelineno-32-18"></a><span class="p">})</span>
</span></code></pre></div></td></tr></table></div>
<h4 id="llm-node">LLM Node</h4>
<p>Integrates an LLM and auto‑manages conversation history:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-33-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-33-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-33-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-33-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-33-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-33-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-33-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-33-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-33-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-33-10">10</a></span>
<span class="normal"><a href="#__codelineno-33-11">11</a></span>
<span class="normal"><a href="#__codelineno-33-12">12</a></span>
<span class="normal"><a href="#__codelineno-33-13">13</a></span>
<span class="normal"><a href="#__codelineno-33-14">14</a></span>
<span class="normal"><a href="#__codelineno-33-15">15</a></span>
<span class="normal"><a href="#__codelineno-33-16">16</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-33-2"><a id="__codelineno-33-2" name="__codelineno-33-2"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-33-3"><a id="__codelineno-33-3" name="__codelineno-33-3"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/model/openai&quot;</span>
</span><span id="__span-33-4"><a id="__codelineno-33-4" name="__codelineno-33-4"></a><span class="p">)</span>
</span><span id="__span-33-5"><a id="__codelineno-33-5" name="__codelineno-33-5"></a>
</span><span id="__span-33-6"><a id="__codelineno-33-6" name="__codelineno-33-6"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-33-7"><a id="__codelineno-33-7" name="__codelineno-33-7"></a><span class="w">    </span><span class="nx">llmModelName</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;gpt-4o-mini&quot;</span>
</span><span id="__span-33-8"><a id="__codelineno-33-8" name="__codelineno-33-8"></a><span class="w">    </span><span class="nx">llmSystemPrompt</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;System prompt&quot;</span>
</span><span id="__span-33-9"><a id="__codelineno-33-9" name="__codelineno-33-9"></a><span class="w">    </span><span class="nx">llmNodeAssistant</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;assistant&quot;</span>
</span><span id="__span-33-10"><a id="__codelineno-33-10" name="__codelineno-33-10"></a><span class="p">)</span>
</span><span id="__span-33-11"><a id="__codelineno-33-11" name="__codelineno-33-11"></a>
</span><span id="__span-33-12"><a id="__codelineno-33-12" name="__codelineno-33-12"></a><span class="nx">model</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">openai</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="nx">llmModelName</span><span class="p">)</span>
</span><span id="__span-33-13"><a id="__codelineno-33-13" name="__codelineno-33-13"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddLLMNode</span><span class="p">(</span><span class="nx">llmNodeAssistant</span><span class="p">,</span><span class="w"> </span><span class="nx">model</span><span class="p">,</span><span class="w"> </span><span class="nx">llmSystemPrompt</span><span class="p">,</span><span class="w"> </span><span class="nx">tools</span><span class="p">)</span>
</span><span id="__span-33-14"><a id="__codelineno-33-14" name="__codelineno-33-14"></a>
</span><span id="__span-33-15"><a id="__codelineno-33-15" name="__codelineno-33-15"></a><span class="c1">// Inputs (priority): graph.StateKeyOneShotMessages &gt; graph.StateKeyUserInput &gt; graph.StateKeyMessages</span>
</span><span id="__span-33-16"><a id="__codelineno-33-16" name="__codelineno-33-16"></a><span class="c1">// Outputs: graph.StateKeyLastResponse, graph.StateKeyMessages (atomic), graph.StateKeyNodeResponses (includes this node&#39;s output for aggregation)</span>
</span></code></pre></div></td></tr></table></div>
<h2 id="node-cache">Node Cache</h2>
<p>Enable caching for pure function-like nodes to avoid repeated computation.</p>
<ul>
<li>Graph-level settings:<ul>
<li><code>WithCache(cache Cache)</code> sets the cache backend (an in-memory implementation is provided for testing)</li>
<li><code>WithCachePolicy(policy *CachePolicy)</code> sets the default cache policy (key function + Time To Live, TTL)</li>
</ul>
</li>
<li>Node-level override: <code>WithNodeCachePolicy(policy *CachePolicy)</code></li>
<li>Clear by nodes: <code>ClearCache(nodes ...string)</code></li>
</ul>
<p>References:
- Graph accessors and setters: <a href="https://github.com/trpc-group/trpc-agent-go/blob/main/graph/graph.go">graph/graph.go</a>
- Defaults and in-memory backend:
  - Interface/policy + canonical JSON + SHA‑256: <a href="https://github.com/trpc-group/trpc-agent-go/blob/main/graph/cache.go">graph/cache.go</a>
  - In-memory cache with read-write lock and deep copy: <a href="https://github.com/trpc-group/trpc-agent-go/blob/main/graph/cache.go">graph/cache.go</a>
- Executor:
  - Try Get before executing a node; on hit, skip the node function and only run callbacks + writes: <a href="https://github.com/trpc-group/trpc-agent-go/blob/main/graph/executor.go">graph/executor.go</a>
  - Persist Set after successful execution: <a href="https://github.com/trpc-group/trpc-agent-go/blob/main/graph/executor.go">graph/executor.go</a>
  - Attach <code>_cache_hit</code> flag on node.complete events: <a href="https://github.com/trpc-group/trpc-agent-go/blob/main/graph/executor.go">graph/executor.go</a></p>
<p>Minimal usage:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-34-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-34-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-34-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-34-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-34-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-34-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-34-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-34-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-34-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-34-10">10</a></span>
<span class="normal"><a href="#__codelineno-34-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1"></a><span class="nx">schema</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateSchema</span><span class="p">()</span>
</span><span id="__span-34-2"><a id="__codelineno-34-2" name="__codelineno-34-2"></a><span class="nx">sg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateGraph</span><span class="p">(</span><span class="nx">schema</span><span class="p">).</span>
</span><span id="__span-34-3"><a id="__codelineno-34-3" name="__codelineno-34-3"></a><span class="w">  </span><span class="nx">WithCache</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewInMemoryCache</span><span class="p">()).</span>
</span><span id="__span-34-4"><a id="__codelineno-34-4" name="__codelineno-34-4"></a><span class="w">  </span><span class="nx">WithCachePolicy</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">DefaultCachePolicy</span><span class="p">())</span>
</span><span id="__span-34-5"><a id="__codelineno-34-5" name="__codelineno-34-5"></a>
</span><span id="__span-34-6"><a id="__codelineno-34-6" name="__codelineno-34-6"></a><span class="nx">nodePolicy</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">graph</span><span class="p">.</span><span class="nx">CachePolicy</span><span class="p">{</span><span class="nx">KeyFunc</span><span class="p">:</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">DefaultCachePolicy</span><span class="p">().</span><span class="nx">KeyFunc</span><span class="p">,</span><span class="w"> </span><span class="nx">TTL</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span><span class="p">}</span>
</span><span id="__span-34-7"><a id="__codelineno-34-7" name="__codelineno-34-7"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;compute&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">computeFunc</span><span class="p">,</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithNodeCachePolicy</span><span class="p">(</span><span class="nx">nodePolicy</span><span class="p">)).</span>
</span><span id="__span-34-8"><a id="__codelineno-34-8" name="__codelineno-34-8"></a><span class="w">  </span><span class="nx">SetEntryPoint</span><span class="p">(</span><span class="s">&quot;compute&quot;</span><span class="p">).</span>
</span><span id="__span-34-9"><a id="__codelineno-34-9" name="__codelineno-34-9"></a><span class="w">  </span><span class="nx">SetFinishPoint</span><span class="p">(</span><span class="s">&quot;compute&quot;</span><span class="p">)</span>
</span><span id="__span-34-10"><a id="__codelineno-34-10" name="__codelineno-34-10"></a>
</span><span id="__span-34-11"><a id="__codelineno-34-11" name="__codelineno-34-11"></a><span class="nx">compiled</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">sg</span><span class="p">.</span><span class="nx">Compile</span><span class="p">()</span>
</span></code></pre></div></td></tr></table></div>
<p>Advanced usage:
- Field-based keys (recommended)</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-35-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-35-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-35-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-35-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-35-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-35-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-35-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-35-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-35-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-35-10">10</a></span>
<span class="normal"><a href="#__codelineno-35-11">11</a></span>
<span class="normal"><a href="#__codelineno-35-12">12</a></span>
<span class="normal"><a href="#__codelineno-35-13">13</a></span>
<span class="normal"><a href="#__codelineno-35-14">14</a></span>
<span class="normal"><a href="#__codelineno-35-15">15</a></span>
<span class="normal"><a href="#__codelineno-35-16">16</a></span>
<span class="normal"><a href="#__codelineno-35-17">17</a></span>
<span class="normal"><a href="#__codelineno-35-18">18</a></span>
<span class="normal"><a href="#__codelineno-35-19">19</a></span>
<span class="normal"><a href="#__codelineno-35-20">20</a></span>
<span class="normal"><a href="#__codelineno-35-21">21</a></span>
<span class="normal"><a href="#__codelineno-35-22">22</a></span>
<span class="normal"><a href="#__codelineno-35-23">23</a></span>
<span class="normal"><a href="#__codelineno-35-24">24</a></span>
<span class="normal"><a href="#__codelineno-35-25">25</a></span>
<span class="normal"><a href="#__codelineno-35-26">26</a></span>
<span class="normal"><a href="#__codelineno-35-27">27</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1"></a><span class="kn">package</span><span class="w"> </span><span class="nx">main</span>
</span><span id="__span-35-2"><a id="__codelineno-35-2" name="__codelineno-35-2"></a>
</span><span id="__span-35-3"><a id="__codelineno-35-3" name="__codelineno-35-3"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-35-4"><a id="__codelineno-35-4" name="__codelineno-35-4"></a><span class="w">    </span><span class="s">&quot;context&quot;</span>
</span><span id="__span-35-5"><a id="__codelineno-35-5" name="__codelineno-35-5"></a><span class="w">    </span><span class="s">&quot;time&quot;</span>
</span><span id="__span-35-6"><a id="__codelineno-35-6" name="__codelineno-35-6"></a>
</span><span id="__span-35-7"><a id="__codelineno-35-7" name="__codelineno-35-7"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-35-8"><a id="__codelineno-35-8" name="__codelineno-35-8"></a><span class="p">)</span>
</span><span id="__span-35-9"><a id="__codelineno-35-9" name="__codelineno-35-9"></a>
</span><span id="__span-35-10"><a id="__codelineno-35-10" name="__codelineno-35-10"></a><span class="kd">func</span><span class="w"> </span><span class="nx">build</span><span class="p">()</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">graph</span><span class="p">.</span><span class="nx">Graph</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-35-11"><a id="__codelineno-35-11" name="__codelineno-35-11"></a><span class="w">    </span><span class="nx">schema</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateSchema</span><span class="p">()</span>
</span><span id="__span-35-12"><a id="__codelineno-35-12" name="__codelineno-35-12"></a><span class="w">    </span><span class="nx">sg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateGraph</span><span class="p">(</span><span class="nx">schema</span><span class="p">).</span>
</span><span id="__span-35-13"><a id="__codelineno-35-13" name="__codelineno-35-13"></a><span class="w">        </span><span class="nx">WithCache</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewInMemoryCache</span><span class="p">()).</span>
</span><span id="__span-35-14"><a id="__codelineno-35-14" name="__codelineno-35-14"></a><span class="w">        </span><span class="nx">WithCachePolicy</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">DefaultCachePolicy</span><span class="p">())</span>
</span><span id="__span-35-15"><a id="__codelineno-35-15" name="__codelineno-35-15"></a>
</span><span id="__span-35-16"><a id="__codelineno-35-16" name="__codelineno-35-16"></a><span class="w">    </span><span class="nx">compute</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-35-17"><a id="__codelineno-35-17" name="__codelineno-35-17"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="s">&quot;out&quot;</span><span class="p">:</span><span class="w"> </span><span class="nx">s</span><span class="p">[</span><span class="s">&quot;n&quot;</span><span class="p">].(</span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-35-18"><a id="__codelineno-35-18" name="__codelineno-35-18"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-35-19"><a id="__codelineno-35-19" name="__codelineno-35-19"></a>
</span><span id="__span-35-20"><a id="__codelineno-35-20" name="__codelineno-35-20"></a><span class="w">    </span><span class="c1">// Use only `n` and `user_id` for cache key derivation; other fields won&#39;t affect hits</span>
</span><span id="__span-35-21"><a id="__codelineno-35-21" name="__codelineno-35-21"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;compute&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">compute</span><span class="p">,</span>
</span><span id="__span-35-22"><a id="__codelineno-35-22" name="__codelineno-35-22"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithNodeCachePolicy</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">graph</span><span class="p">.</span><span class="nx">CachePolicy</span><span class="p">{</span><span class="nx">KeyFunc</span><span class="p">:</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">DefaultCachePolicy</span><span class="p">().</span><span class="nx">KeyFunc</span><span class="p">,</span><span class="w"> </span><span class="nx">TTL</span><span class="p">:</span><span class="w"> </span><span class="mi">30</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span><span class="p">}),</span>
</span><span id="__span-35-23"><a id="__codelineno-35-23" name="__codelineno-35-23"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithCacheKeyFields</span><span class="p">(</span><span class="s">&quot;n&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;user_id&quot;</span><span class="p">),</span>
</span><span id="__span-35-24"><a id="__codelineno-35-24" name="__codelineno-35-24"></a><span class="w">    </span><span class="p">)</span>
</span><span id="__span-35-25"><a id="__codelineno-35-25" name="__codelineno-35-25"></a>
</span><span id="__span-35-26"><a id="__codelineno-35-26" name="__codelineno-35-26"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">sg</span><span class="p">.</span><span class="nx">Compile</span><span class="p">()</span>
</span><span id="__span-35-27"><a id="__codelineno-35-27" name="__codelineno-35-27"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<ul>
<li>Custom selector (for complex projections)</li>
</ul>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-36-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-36-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-36-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-36-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-36-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-36-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-36-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-36-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-36-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-36-10">10</a></span>
<span class="normal"><a href="#__codelineno-36-11">11</a></span>
<span class="normal"><a href="#__codelineno-36-12">12</a></span>
<span class="normal"><a href="#__codelineno-36-13">13</a></span>
<span class="normal"><a href="#__codelineno-36-14">14</a></span>
<span class="normal"><a href="#__codelineno-36-15">15</a></span>
<span class="normal"><a href="#__codelineno-36-16">16</a></span>
<span class="normal"><a href="#__codelineno-36-17">17</a></span>
<span class="normal"><a href="#__codelineno-36-18">18</a></span>
<span class="normal"><a href="#__codelineno-36-19">19</a></span>
<span class="normal"><a href="#__codelineno-36-20">20</a></span>
<span class="normal"><a href="#__codelineno-36-21">21</a></span>
<span class="normal"><a href="#__codelineno-36-22">22</a></span>
<span class="normal"><a href="#__codelineno-36-23">23</a></span>
<span class="normal"><a href="#__codelineno-36-24">24</a></span>
<span class="normal"><a href="#__codelineno-36-25">25</a></span>
<span class="normal"><a href="#__codelineno-36-26">26</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1"></a><span class="kn">package</span><span class="w"> </span><span class="nx">main</span>
</span><span id="__span-36-2"><a id="__codelineno-36-2" name="__codelineno-36-2"></a>
</span><span id="__span-36-3"><a id="__codelineno-36-3" name="__codelineno-36-3"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-36-4"><a id="__codelineno-36-4" name="__codelineno-36-4"></a><span class="w">    </span><span class="s">&quot;context&quot;</span>
</span><span id="__span-36-5"><a id="__codelineno-36-5" name="__codelineno-36-5"></a><span class="w">    </span><span class="s">&quot;time&quot;</span>
</span><span id="__span-36-6"><a id="__codelineno-36-6" name="__codelineno-36-6"></a>
</span><span id="__span-36-7"><a id="__codelineno-36-7" name="__codelineno-36-7"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-36-8"><a id="__codelineno-36-8" name="__codelineno-36-8"></a><span class="p">)</span>
</span><span id="__span-36-9"><a id="__codelineno-36-9" name="__codelineno-36-9"></a>
</span><span id="__span-36-10"><a id="__codelineno-36-10" name="__codelineno-36-10"></a><span class="kd">func</span><span class="w"> </span><span class="nx">build</span><span class="p">()</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">graph</span><span class="p">.</span><span class="nx">Graph</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-36-11"><a id="__codelineno-36-11" name="__codelineno-36-11"></a><span class="w">    </span><span class="nx">schema</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateSchema</span><span class="p">()</span>
</span><span id="__span-36-12"><a id="__codelineno-36-12" name="__codelineno-36-12"></a><span class="w">    </span><span class="nx">sg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateGraph</span><span class="p">(</span><span class="nx">schema</span><span class="p">).</span>
</span><span id="__span-36-13"><a id="__codelineno-36-13" name="__codelineno-36-13"></a><span class="w">        </span><span class="nx">WithCache</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewInMemoryCache</span><span class="p">()).</span>
</span><span id="__span-36-14"><a id="__codelineno-36-14" name="__codelineno-36-14"></a><span class="w">        </span><span class="nx">WithCachePolicy</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">DefaultCachePolicy</span><span class="p">())</span>
</span><span id="__span-36-15"><a id="__codelineno-36-15" name="__codelineno-36-15"></a>
</span><span id="__span-36-16"><a id="__codelineno-36-16" name="__codelineno-36-16"></a><span class="w">    </span><span class="nx">compute</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="s">&quot;out&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">42</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-36-17"><a id="__codelineno-36-17" name="__codelineno-36-17"></a>
</span><span id="__span-36-18"><a id="__codelineno-36-18" name="__codelineno-36-18"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;compute&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">compute</span><span class="p">,</span>
</span><span id="__span-36-19"><a id="__codelineno-36-19" name="__codelineno-36-19"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithNodeCachePolicy</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">graph</span><span class="p">.</span><span class="nx">CachePolicy</span><span class="p">{</span><span class="nx">KeyFunc</span><span class="p">:</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">DefaultCachePolicy</span><span class="p">().</span><span class="nx">KeyFunc</span><span class="p">,</span><span class="w"> </span><span class="nx">TTL</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span><span class="p">}),</span>
</span><span id="__span-36-20"><a id="__codelineno-36-20" name="__codelineno-36-20"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithCacheKeySelector</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">m</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">any</span><span class="p">)</span><span class="w"> </span><span class="kt">any</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-36-21"><a id="__codelineno-36-21" name="__codelineno-36-21"></a><span class="w">            </span><span class="c1">// derive cache key input from sanitized map</span>
</span><span id="__span-36-22"><a id="__codelineno-36-22" name="__codelineno-36-22"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">any</span><span class="p">{</span><span class="s">&quot;n&quot;</span><span class="p">:</span><span class="w"> </span><span class="nx">m</span><span class="p">[</span><span class="s">&quot;n&quot;</span><span class="p">],</span><span class="w"> </span><span class="s">&quot;uid&quot;</span><span class="p">:</span><span class="w"> </span><span class="nx">m</span><span class="p">[</span><span class="s">&quot;uid&quot;</span><span class="p">]}</span>
</span><span id="__span-36-23"><a id="__codelineno-36-23" name="__codelineno-36-23"></a><span class="w">        </span><span class="p">}),</span>
</span><span id="__span-36-24"><a id="__codelineno-36-24" name="__codelineno-36-24"></a><span class="w">    </span><span class="p">)</span>
</span><span id="__span-36-25"><a id="__codelineno-36-25" name="__codelineno-36-25"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">sg</span><span class="p">.</span><span class="nx">Compile</span><span class="p">()</span>
</span><span id="__span-36-26"><a id="__codelineno-36-26" name="__codelineno-36-26"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<ul>
<li>Versioned namespace (avoid stale cache across versions)</li>
</ul>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-37-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-37-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-37-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-37-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-37-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-37-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-37-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-37-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-37-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-37-10">10</a></span>
<span class="normal"><a href="#__codelineno-37-11">11</a></span>
<span class="normal"><a href="#__codelineno-37-12">12</a></span>
<span class="normal"><a href="#__codelineno-37-13">13</a></span>
<span class="normal"><a href="#__codelineno-37-14">14</a></span>
<span class="normal"><a href="#__codelineno-37-15">15</a></span>
<span class="normal"><a href="#__codelineno-37-16">16</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-37-1"><a id="__codelineno-37-1" name="__codelineno-37-1"></a><span class="kn">package</span><span class="w"> </span><span class="nx">main</span>
</span><span id="__span-37-2"><a id="__codelineno-37-2" name="__codelineno-37-2"></a>
</span><span id="__span-37-3"><a id="__codelineno-37-3" name="__codelineno-37-3"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-37-4"><a id="__codelineno-37-4" name="__codelineno-37-4"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-37-5"><a id="__codelineno-37-5" name="__codelineno-37-5"></a><span class="p">)</span>
</span><span id="__span-37-6"><a id="__codelineno-37-6" name="__codelineno-37-6"></a>
</span><span id="__span-37-7"><a id="__codelineno-37-7" name="__codelineno-37-7"></a><span class="kd">func</span><span class="w"> </span><span class="nx">build</span><span class="p">()</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">graph</span><span class="p">.</span><span class="nx">Graph</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-37-8"><a id="__codelineno-37-8" name="__codelineno-37-8"></a><span class="w">    </span><span class="nx">schema</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateSchema</span><span class="p">()</span>
</span><span id="__span-37-9"><a id="__codelineno-37-9" name="__codelineno-37-9"></a><span class="w">    </span><span class="nx">sg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateGraph</span><span class="p">(</span><span class="nx">schema</span><span class="p">).</span>
</span><span id="__span-37-10"><a id="__codelineno-37-10" name="__codelineno-37-10"></a><span class="w">        </span><span class="nx">WithGraphVersion</span><span class="p">(</span><span class="s">&quot;v2025.03&quot;</span><span class="p">).</span><span class="w"> </span><span class="c1">// namespace becomes __writes__:v2025.03:&lt;node&gt;</span>
</span><span id="__span-37-11"><a id="__codelineno-37-11" name="__codelineno-37-11"></a><span class="w">        </span><span class="nx">WithCache</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewInMemoryCache</span><span class="p">()).</span>
</span><span id="__span-37-12"><a id="__codelineno-37-12" name="__codelineno-37-12"></a><span class="w">        </span><span class="nx">WithCachePolicy</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">DefaultCachePolicy</span><span class="p">())</span>
</span><span id="__span-37-13"><a id="__codelineno-37-13" name="__codelineno-37-13"></a>
</span><span id="__span-37-14"><a id="__codelineno-37-14" name="__codelineno-37-14"></a><span class="w">    </span><span class="c1">// ... AddNode(...)</span>
</span><span id="__span-37-15"><a id="__codelineno-37-15" name="__codelineno-37-15"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">sg</span><span class="p">.</span><span class="nx">Compile</span><span class="p">()</span>
</span><span id="__span-37-16"><a id="__codelineno-37-16" name="__codelineno-37-16"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<ul>
<li>Per-node TTL (Time To Live)</li>
</ul>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-38-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-38-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-38-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-38-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-38-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-38-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-38-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-38-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-38-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-38-10">10</a></span>
<span class="normal"><a href="#__codelineno-38-11">11</a></span>
<span class="normal"><a href="#__codelineno-38-12">12</a></span>
<span class="normal"><a href="#__codelineno-38-13">13</a></span>
<span class="normal"><a href="#__codelineno-38-14">14</a></span>
<span class="normal"><a href="#__codelineno-38-15">15</a></span>
<span class="normal"><a href="#__codelineno-38-16">16</a></span>
<span class="normal"><a href="#__codelineno-38-17">17</a></span>
<span class="normal"><a href="#__codelineno-38-18">18</a></span>
<span class="normal"><a href="#__codelineno-38-19">19</a></span>
<span class="normal"><a href="#__codelineno-38-20">20</a></span>
<span class="normal"><a href="#__codelineno-38-21">21</a></span>
<span class="normal"><a href="#__codelineno-38-22">22</a></span>
<span class="normal"><a href="#__codelineno-38-23">23</a></span>
<span class="normal"><a href="#__codelineno-38-24">24</a></span>
<span class="normal"><a href="#__codelineno-38-25">25</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-38-1"><a id="__codelineno-38-1" name="__codelineno-38-1"></a><span class="kn">package</span><span class="w"> </span><span class="nx">main</span>
</span><span id="__span-38-2"><a id="__codelineno-38-2" name="__codelineno-38-2"></a>
</span><span id="__span-38-3"><a id="__codelineno-38-3" name="__codelineno-38-3"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-38-4"><a id="__codelineno-38-4" name="__codelineno-38-4"></a><span class="w">    </span><span class="s">&quot;context&quot;</span>
</span><span id="__span-38-5"><a id="__codelineno-38-5" name="__codelineno-38-5"></a><span class="w">    </span><span class="s">&quot;time&quot;</span>
</span><span id="__span-38-6"><a id="__codelineno-38-6" name="__codelineno-38-6"></a>
</span><span id="__span-38-7"><a id="__codelineno-38-7" name="__codelineno-38-7"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-38-8"><a id="__codelineno-38-8" name="__codelineno-38-8"></a><span class="p">)</span>
</span><span id="__span-38-9"><a id="__codelineno-38-9" name="__codelineno-38-9"></a>
</span><span id="__span-38-10"><a id="__codelineno-38-10" name="__codelineno-38-10"></a><span class="kd">func</span><span class="w"> </span><span class="nx">build</span><span class="p">()</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">graph</span><span class="p">.</span><span class="nx">Graph</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-38-11"><a id="__codelineno-38-11" name="__codelineno-38-11"></a><span class="w">    </span><span class="nx">schema</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateSchema</span><span class="p">()</span>
</span><span id="__span-38-12"><a id="__codelineno-38-12" name="__codelineno-38-12"></a><span class="w">    </span><span class="nx">sg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateGraph</span><span class="p">(</span><span class="nx">schema</span><span class="p">).</span>
</span><span id="__span-38-13"><a id="__codelineno-38-13" name="__codelineno-38-13"></a><span class="w">        </span><span class="nx">WithCache</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewInMemoryCache</span><span class="p">()).</span>
</span><span id="__span-38-14"><a id="__codelineno-38-14" name="__codelineno-38-14"></a><span class="w">        </span><span class="nx">WithCachePolicy</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">DefaultCachePolicy</span><span class="p">())</span>
</span><span id="__span-38-15"><a id="__codelineno-38-15" name="__codelineno-38-15"></a>
</span><span id="__span-38-16"><a id="__codelineno-38-16" name="__codelineno-38-16"></a><span class="w">    </span><span class="nx">compute</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="s">&quot;out&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">42</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-38-17"><a id="__codelineno-38-17" name="__codelineno-38-17"></a>
</span><span id="__span-38-18"><a id="__codelineno-38-18" name="__codelineno-38-18"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;compute&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">compute</span><span class="p">,</span>
</span><span id="__span-38-19"><a id="__codelineno-38-19" name="__codelineno-38-19"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithNodeCachePolicy</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">graph</span><span class="p">.</span><span class="nx">CachePolicy</span><span class="p">{</span>
</span><span id="__span-38-20"><a id="__codelineno-38-20" name="__codelineno-38-20"></a><span class="w">            </span><span class="nx">KeyFunc</span><span class="p">:</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">DefaultCachePolicy</span><span class="p">().</span><span class="nx">KeyFunc</span><span class="p">,</span>
</span><span id="__span-38-21"><a id="__codelineno-38-21" name="__codelineno-38-21"></a><span class="w">            </span><span class="nx">TTL</span><span class="p">:</span><span class="w">     </span><span class="mi">10</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span><span class="p">,</span>
</span><span id="__span-38-22"><a id="__codelineno-38-22" name="__codelineno-38-22"></a><span class="w">        </span><span class="p">}),</span>
</span><span id="__span-38-23"><a id="__codelineno-38-23" name="__codelineno-38-23"></a><span class="w">    </span><span class="p">)</span>
</span><span id="__span-38-24"><a id="__codelineno-38-24" name="__codelineno-38-24"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">sg</span><span class="p">.</span><span class="nx">Compile</span><span class="p">()</span>
</span><span id="__span-38-25"><a id="__codelineno-38-25" name="__codelineno-38-25"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<ul>
<li>Clear cache (per node)</li>
</ul>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-39-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-39-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-39-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-39-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-39-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-39-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-39-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-39-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-39-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-39-10">10</a></span>
<span class="normal"><a href="#__codelineno-39-11">11</a></span>
<span class="normal"><a href="#__codelineno-39-12">12</a></span>
<span class="normal"><a href="#__codelineno-39-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-39-1"><a id="__codelineno-39-1" name="__codelineno-39-1"></a><span class="kn">package</span><span class="w"> </span><span class="nx">main</span>
</span><span id="__span-39-2"><a id="__codelineno-39-2" name="__codelineno-39-2"></a>
</span><span id="__span-39-3"><a id="__codelineno-39-3" name="__codelineno-39-3"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-39-4"><a id="__codelineno-39-4" name="__codelineno-39-4"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-39-5"><a id="__codelineno-39-5" name="__codelineno-39-5"></a><span class="p">)</span>
</span><span id="__span-39-6"><a id="__codelineno-39-6" name="__codelineno-39-6"></a>
</span><span id="__span-39-7"><a id="__codelineno-39-7" name="__codelineno-39-7"></a><span class="kd">func</span><span class="w"> </span><span class="nb">clear</span><span class="p">(</span><span class="nx">sg</span><span class="w"> </span><span class="o">*</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateGraph</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-8"><a id="__codelineno-39-8" name="__codelineno-39-8"></a><span class="w">    </span><span class="c1">// clear specific nodes</span>
</span><span id="__span-39-9"><a id="__codelineno-39-9" name="__codelineno-39-9"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">ClearCache</span><span class="p">(</span><span class="s">&quot;compute&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;format&quot;</span><span class="p">)</span>
</span><span id="__span-39-10"><a id="__codelineno-39-10" name="__codelineno-39-10"></a>
</span><span id="__span-39-11"><a id="__codelineno-39-11" name="__codelineno-39-11"></a><span class="w">    </span><span class="c1">// clear all nodes in the graph (no args)</span>
</span><span id="__span-39-12"><a id="__codelineno-39-12" name="__codelineno-39-12"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">ClearCache</span><span class="p">()</span>
</span><span id="__span-39-13"><a id="__codelineno-39-13" name="__codelineno-39-13"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<ul>
<li>Read cache-hit marker (<code>_cache_hit</code>)</li>
</ul>
<p><div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-40-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-40-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-40-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-40-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-40-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-40-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-40-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-40-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-40-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-40-10">10</a></span>
<span class="normal"><a href="#__codelineno-40-11">11</a></span>
<span class="normal"><a href="#__codelineno-40-12">12</a></span>
<span class="normal"><a href="#__codelineno-40-13">13</a></span>
<span class="normal"><a href="#__codelineno-40-14">14</a></span>
<span class="normal"><a href="#__codelineno-40-15">15</a></span>
<span class="normal"><a href="#__codelineno-40-16">16</a></span>
<span class="normal"><a href="#__codelineno-40-17">17</a></span>
<span class="normal"><a href="#__codelineno-40-18">18</a></span>
<span class="normal"><a href="#__codelineno-40-19">19</a></span>
<span class="normal"><a href="#__codelineno-40-20">20</a></span>
<span class="normal"><a href="#__codelineno-40-21">21</a></span>
<span class="normal"><a href="#__codelineno-40-22">22</a></span>
<span class="normal"><a href="#__codelineno-40-23">23</a></span>
<span class="normal"><a href="#__codelineno-40-24">24</a></span>
<span class="normal"><a href="#__codelineno-40-25">25</a></span>
<span class="normal"><a href="#__codelineno-40-26">26</a></span>
<span class="normal"><a href="#__codelineno-40-27">27</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-40-1"><a id="__codelineno-40-1" name="__codelineno-40-1"></a><span class="kn">package</span><span class="w"> </span><span class="nx">main</span>
</span><span id="__span-40-2"><a id="__codelineno-40-2" name="__codelineno-40-2"></a>
</span><span id="__span-40-3"><a id="__codelineno-40-3" name="__codelineno-40-3"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-40-4"><a id="__codelineno-40-4" name="__codelineno-40-4"></a><span class="w">    </span><span class="s">&quot;context&quot;</span>
</span><span id="__span-40-5"><a id="__codelineno-40-5" name="__codelineno-40-5"></a><span class="w">    </span><span class="s">&quot;fmt&quot;</span>
</span><span id="__span-40-6"><a id="__codelineno-40-6" name="__codelineno-40-6"></a>
</span><span id="__span-40-7"><a id="__codelineno-40-7" name="__codelineno-40-7"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/agent&quot;</span>
</span><span id="__span-40-8"><a id="__codelineno-40-8" name="__codelineno-40-8"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/event&quot;</span>
</span><span id="__span-40-9"><a id="__codelineno-40-9" name="__codelineno-40-9"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-40-10"><a id="__codelineno-40-10" name="__codelineno-40-10"></a><span class="p">)</span>
</span><span id="__span-40-11"><a id="__codelineno-40-11" name="__codelineno-40-11"></a>
</span><span id="__span-40-12"><a id="__codelineno-40-12" name="__codelineno-40-12"></a><span class="kd">func</span><span class="w"> </span><span class="nx">runAndReadHits</span><span class="p">(</span><span class="nx">executor</span><span class="w"> </span><span class="o">*</span><span class="nx">graph</span><span class="p">.</span><span class="nx">Executor</span><span class="p">,</span><span class="w"> </span><span class="nx">initial</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-40-13"><a id="__codelineno-40-13" name="__codelineno-40-13"></a><span class="w">    </span><span class="nx">inv</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">agent</span><span class="p">.</span><span class="nx">Invocation</span><span class="p">{</span><span class="nx">InvocationID</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;demo&quot;</span><span class="p">}</span>
</span><span id="__span-40-14"><a id="__codelineno-40-14" name="__codelineno-40-14"></a><span class="w">    </span><span class="nx">ch</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">executor</span><span class="p">.</span><span class="nx">Execute</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Background</span><span class="p">(),</span><span class="w"> </span><span class="nx">initial</span><span class="p">,</span><span class="w"> </span><span class="nx">inv</span><span class="p">)</span>
</span><span id="__span-40-15"><a id="__codelineno-40-15" name="__codelineno-40-15"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-40-16"><a id="__codelineno-40-16" name="__codelineno-40-16"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">e</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">ch</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-40-17"><a id="__codelineno-40-17" name="__codelineno-40-17"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">Response</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">Response</span><span class="p">.</span><span class="nx">Object</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">ObjectTypeGraphNodeComplete</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-40-18"><a id="__codelineno-40-18" name="__codelineno-40-18"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">StateDelta</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-40-19"><a id="__codelineno-40-19" name="__codelineno-40-19"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">StateDelta</span><span class="p">[</span><span class="s">&quot;_cache_hit&quot;</span><span class="p">];</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-40-20"><a id="__codelineno-40-20" name="__codelineno-40-20"></a><span class="w">                    </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;cache hit: skipped node function&quot;</span><span class="p">)</span>
</span><span id="__span-40-21"><a id="__codelineno-40-21" name="__codelineno-40-21"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-40-22"><a id="__codelineno-40-22" name="__codelineno-40-22"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-40-23"><a id="__codelineno-40-23" name="__codelineno-40-23"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-40-24"><a id="__codelineno-40-24" name="__codelineno-40-24"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">Done</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">break</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-40-25"><a id="__codelineno-40-25" name="__codelineno-40-25"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-40-26"><a id="__codelineno-40-26" name="__codelineno-40-26"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-40-27"><a id="__codelineno-40-27" name="__codelineno-40-27"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
Advanced usage:
- Field-based keys (recommended): declare <code>WithCacheKeyFields("n", "user_id")</code> on a node; internally this maps the sanitized input to <code>{n, user_id}</code> before default canonicalization and hashing.
- Custom selector: <code>WithCacheKeySelector(func(m map[string]any) any { return map[string]any{"n": m["n"], "uid": m["uid"]} })</code>
- Versioned namespace: <code>WithGraphVersion("v2025.03")</code> expands the namespace to <code>__writes__:&lt;version&gt;:&lt;node&gt;</code>, reducing stale cache collisions across code changes.</p>
<p>Notes:
- Prefer caching only pure functions (no side effects)
- TTL=0 means no expiration; consider a persistent backend (Redis/SQLite) in production
- Key function sanitizes input to avoid volatile/non-serializable fields being part of the key: <a href="https://github.com/trpc-group/trpc-agent-go/blob/main/graph/cache_key.go">graph/cache_key.go</a>
- Call <code>ClearCache("nodeID")</code> after code changes or include a function identifier/version in the key</p>
<p>Runner + GraphAgent usage example:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-41-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-41-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-41-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-41-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-41-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-41-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-41-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-41-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-41-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-41-10">10</a></span>
<span class="normal"><a href="#__codelineno-41-11">11</a></span>
<span class="normal"><a href="#__codelineno-41-12">12</a></span>
<span class="normal"><a href="#__codelineno-41-13">13</a></span>
<span class="normal"><a href="#__codelineno-41-14">14</a></span>
<span class="normal"><a href="#__codelineno-41-15">15</a></span>
<span class="normal"><a href="#__codelineno-41-16">16</a></span>
<span class="normal"><a href="#__codelineno-41-17">17</a></span>
<span class="normal"><a href="#__codelineno-41-18">18</a></span>
<span class="normal"><a href="#__codelineno-41-19">19</a></span>
<span class="normal"><a href="#__codelineno-41-20">20</a></span>
<span class="normal"><a href="#__codelineno-41-21">21</a></span>
<span class="normal"><a href="#__codelineno-41-22">22</a></span>
<span class="normal"><a href="#__codelineno-41-23">23</a></span>
<span class="normal"><a href="#__codelineno-41-24">24</a></span>
<span class="normal"><a href="#__codelineno-41-25">25</a></span>
<span class="normal"><a href="#__codelineno-41-26">26</a></span>
<span class="normal"><a href="#__codelineno-41-27">27</a></span>
<span class="normal"><a href="#__codelineno-41-28">28</a></span>
<span class="normal"><a href="#__codelineno-41-29">29</a></span>
<span class="normal"><a href="#__codelineno-41-30">30</a></span>
<span class="normal"><a href="#__codelineno-41-31">31</a></span>
<span class="normal"><a href="#__codelineno-41-32">32</a></span>
<span class="normal"><a href="#__codelineno-41-33">33</a></span>
<span class="normal"><a href="#__codelineno-41-34">34</a></span>
<span class="normal"><a href="#__codelineno-41-35">35</a></span>
<span class="normal"><a href="#__codelineno-41-36">36</a></span>
<span class="normal"><a href="#__codelineno-41-37">37</a></span>
<span class="normal"><a href="#__codelineno-41-38">38</a></span>
<span class="normal"><a href="#__codelineno-41-39">39</a></span>
<span class="normal"><a href="#__codelineno-41-40">40</a></span>
<span class="normal"><a href="#__codelineno-41-41">41</a></span>
<span class="normal"><a href="#__codelineno-41-42">42</a></span>
<span class="normal"><a href="#__codelineno-41-43">43</a></span>
<span class="normal"><a href="#__codelineno-41-44">44</a></span>
<span class="normal"><a href="#__codelineno-41-45">45</a></span>
<span class="normal"><a href="#__codelineno-41-46">46</a></span>
<span class="normal"><a href="#__codelineno-41-47">47</a></span>
<span class="normal"><a href="#__codelineno-41-48">48</a></span>
<span class="normal"><a href="#__codelineno-41-49">49</a></span>
<span class="normal"><a href="#__codelineno-41-50">50</a></span>
<span class="normal"><a href="#__codelineno-41-51">51</a></span>
<span class="normal"><a href="#__codelineno-41-52">52</a></span>
<span class="normal"><a href="#__codelineno-41-53">53</a></span>
<span class="normal"><a href="#__codelineno-41-54">54</a></span>
<span class="normal"><a href="#__codelineno-41-55">55</a></span>
<span class="normal"><a href="#__codelineno-41-56">56</a></span>
<span class="normal"><a href="#__codelineno-41-57">57</a></span>
<span class="normal"><a href="#__codelineno-41-58">58</a></span>
<span class="normal"><a href="#__codelineno-41-59">59</a></span>
<span class="normal"><a href="#__codelineno-41-60">60</a></span>
<span class="normal"><a href="#__codelineno-41-61">61</a></span>
<span class="normal"><a href="#__codelineno-41-62">62</a></span>
<span class="normal"><a href="#__codelineno-41-63">63</a></span>
<span class="normal"><a href="#__codelineno-41-64">64</a></span>
<span class="normal"><a href="#__codelineno-41-65">65</a></span>
<span class="normal"><a href="#__codelineno-41-66">66</a></span>
<span class="normal"><a href="#__codelineno-41-67">67</a></span>
<span class="normal"><a href="#__codelineno-41-68">68</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-41-1"><a id="__codelineno-41-1" name="__codelineno-41-1"></a><span class="kn">package</span><span class="w"> </span><span class="nx">main</span>
</span><span id="__span-41-2"><a id="__codelineno-41-2" name="__codelineno-41-2"></a>
</span><span id="__span-41-3"><a id="__codelineno-41-3" name="__codelineno-41-3"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-41-4"><a id="__codelineno-41-4" name="__codelineno-41-4"></a><span class="w">    </span><span class="s">&quot;bufio&quot;</span>
</span><span id="__span-41-5"><a id="__codelineno-41-5" name="__codelineno-41-5"></a><span class="w">    </span><span class="s">&quot;context&quot;</span>
</span><span id="__span-41-6"><a id="__codelineno-41-6" name="__codelineno-41-6"></a><span class="w">    </span><span class="s">&quot;flag&quot;</span>
</span><span id="__span-41-7"><a id="__codelineno-41-7" name="__codelineno-41-7"></a><span class="w">    </span><span class="s">&quot;fmt&quot;</span>
</span><span id="__span-41-8"><a id="__codelineno-41-8" name="__codelineno-41-8"></a><span class="w">    </span><span class="s">&quot;os&quot;</span>
</span><span id="__span-41-9"><a id="__codelineno-41-9" name="__codelineno-41-9"></a><span class="w">    </span><span class="s">&quot;strings&quot;</span>
</span><span id="__span-41-10"><a id="__codelineno-41-10" name="__codelineno-41-10"></a><span class="w">    </span><span class="s">&quot;time&quot;</span>
</span><span id="__span-41-11"><a id="__codelineno-41-11" name="__codelineno-41-11"></a>
</span><span id="__span-41-12"><a id="__codelineno-41-12" name="__codelineno-41-12"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/agent&quot;</span>
</span><span id="__span-41-13"><a id="__codelineno-41-13" name="__codelineno-41-13"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/agent/graphagent&quot;</span>
</span><span id="__span-41-14"><a id="__codelineno-41-14" name="__codelineno-41-14"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-41-15"><a id="__codelineno-41-15" name="__codelineno-41-15"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/model&quot;</span>
</span><span id="__span-41-16"><a id="__codelineno-41-16" name="__codelineno-41-16"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/runner&quot;</span>
</span><span id="__span-41-17"><a id="__codelineno-41-17" name="__codelineno-41-17"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/session/inmemory&quot;</span>
</span><span id="__span-41-18"><a id="__codelineno-41-18" name="__codelineno-41-18"></a><span class="p">)</span>
</span><span id="__span-41-19"><a id="__codelineno-41-19" name="__codelineno-41-19"></a>
</span><span id="__span-41-20"><a id="__codelineno-41-20" name="__codelineno-41-20"></a><span class="kd">func</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-21"><a id="__codelineno-41-21" name="__codelineno-41-21"></a><span class="w">    </span><span class="nx">ttl</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">flag</span><span class="p">.</span><span class="nx">Duration</span><span class="p">(</span><span class="s">&quot;ttl&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;cache ttl&quot;</span><span class="p">)</span>
</span><span id="__span-41-22"><a id="__codelineno-41-22" name="__codelineno-41-22"></a><span class="w">    </span><span class="nx">flag</span><span class="p">.</span><span class="nx">Parse</span><span class="p">()</span>
</span><span id="__span-41-23"><a id="__codelineno-41-23" name="__codelineno-41-23"></a>
</span><span id="__span-41-24"><a id="__codelineno-41-24" name="__codelineno-41-24"></a><span class="w">    </span><span class="c1">// Build graph with cache</span>
</span><span id="__span-41-25"><a id="__codelineno-41-25" name="__codelineno-41-25"></a><span class="w">    </span><span class="nx">schema</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateSchema</span><span class="p">()</span>
</span><span id="__span-41-26"><a id="__codelineno-41-26" name="__codelineno-41-26"></a><span class="w">    </span><span class="nx">sg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateGraph</span><span class="p">(</span><span class="nx">schema</span><span class="p">).</span>
</span><span id="__span-41-27"><a id="__codelineno-41-27" name="__codelineno-41-27"></a><span class="w">        </span><span class="nx">WithCache</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewInMemoryCache</span><span class="p">()).</span>
</span><span id="__span-41-28"><a id="__codelineno-41-28" name="__codelineno-41-28"></a><span class="w">        </span><span class="nx">WithCachePolicy</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">DefaultCachePolicy</span><span class="p">())</span>
</span><span id="__span-41-29"><a id="__codelineno-41-29" name="__codelineno-41-29"></a>
</span><span id="__span-41-30"><a id="__codelineno-41-30" name="__codelineno-41-30"></a><span class="w">    </span><span class="nx">compute</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-31"><a id="__codelineno-41-31" name="__codelineno-41-31"></a><span class="w">        </span><span class="nx">n</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">s</span><span class="p">[</span><span class="s">&quot;n&quot;</span><span class="p">].(</span><span class="kt">int</span><span class="p">)</span>
</span><span id="__span-41-32"><a id="__codelineno-41-32" name="__codelineno-41-32"></a><span class="w">        </span><span class="nx">time</span><span class="p">.</span><span class="nx">Sleep</span><span class="p">(</span><span class="mi">200</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span><span class="p">)</span>
</span><span id="__span-41-33"><a id="__codelineno-41-33" name="__codelineno-41-33"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="s">&quot;out&quot;</span><span class="p">:</span><span class="w"> </span><span class="nx">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-41-34"><a id="__codelineno-41-34" name="__codelineno-41-34"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-41-35"><a id="__codelineno-41-35" name="__codelineno-41-35"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;compute&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">compute</span><span class="p">,</span>
</span><span id="__span-41-36"><a id="__codelineno-41-36" name="__codelineno-41-36"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithNodeCachePolicy</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">graph</span><span class="p">.</span><span class="nx">CachePolicy</span><span class="p">{</span><span class="nx">KeyFunc</span><span class="p">:</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">DefaultCachePolicy</span><span class="p">().</span><span class="nx">KeyFunc</span><span class="p">,</span><span class="w"> </span><span class="nx">TTL</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="nx">ttl</span><span class="p">}),</span>
</span><span id="__span-41-37"><a id="__codelineno-41-37" name="__codelineno-41-37"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithCacheKeyFields</span><span class="p">(</span><span class="s">&quot;n&quot;</span><span class="p">),</span>
</span><span id="__span-41-38"><a id="__codelineno-41-38" name="__codelineno-41-38"></a><span class="w">    </span><span class="p">).</span>
</span><span id="__span-41-39"><a id="__codelineno-41-39" name="__codelineno-41-39"></a><span class="w">        </span><span class="nx">SetEntryPoint</span><span class="p">(</span><span class="s">&quot;compute&quot;</span><span class="p">).</span>
</span><span id="__span-41-40"><a id="__codelineno-41-40" name="__codelineno-41-40"></a><span class="w">        </span><span class="nx">SetFinishPoint</span><span class="p">(</span><span class="s">&quot;compute&quot;</span><span class="p">)</span>
</span><span id="__span-41-41"><a id="__codelineno-41-41" name="__codelineno-41-41"></a><span class="w">    </span><span class="nx">g</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">sg</span><span class="p">.</span><span class="nx">Compile</span><span class="p">()</span>
</span><span id="__span-41-42"><a id="__codelineno-41-42" name="__codelineno-41-42"></a>
</span><span id="__span-41-43"><a id="__codelineno-41-43" name="__codelineno-41-43"></a><span class="w">    </span><span class="c1">// GraphAgent + Runner</span>
</span><span id="__span-41-44"><a id="__codelineno-41-44" name="__codelineno-41-44"></a><span class="w">    </span><span class="nx">ga</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;cache-demo&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">g</span><span class="p">,</span><span class="w"> </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithInitialState</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{}))</span>
</span><span id="__span-41-45"><a id="__codelineno-41-45" name="__codelineno-41-45"></a><span class="w">    </span><span class="nx">app</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">runner</span><span class="p">.</span><span class="nx">NewRunner</span><span class="p">(</span><span class="s">&quot;app&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">ga</span><span class="p">,</span><span class="w"> </span><span class="nx">runner</span><span class="p">.</span><span class="nx">WithSessionService</span><span class="p">(</span><span class="nx">inmemory</span><span class="p">.</span><span class="nx">NewSessionService</span><span class="p">()))</span>
</span><span id="__span-41-46"><a id="__codelineno-41-46" name="__codelineno-41-46"></a>
</span><span id="__span-41-47"><a id="__codelineno-41-47" name="__codelineno-41-47"></a><span class="w">    </span><span class="c1">// Interactive</span>
</span><span id="__span-41-48"><a id="__codelineno-41-48" name="__codelineno-41-48"></a><span class="w">    </span><span class="nx">sc</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">bufio</span><span class="p">.</span><span class="nx">NewScanner</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Stdin</span><span class="p">)</span>
</span><span id="__span-41-49"><a id="__codelineno-41-49" name="__codelineno-41-49"></a><span class="w">    </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Enter integers; repeated inputs should hit cache. type &#39;exit&#39; to quit&quot;</span><span class="p">)</span>
</span><span id="__span-41-50"><a id="__codelineno-41-50" name="__codelineno-41-50"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-51"><a id="__codelineno-41-51" name="__codelineno-41-51"></a><span class="w">        </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Print</span><span class="p">(</span><span class="s">&quot;&gt; &quot;</span><span class="p">)</span>
</span><span id="__span-41-52"><a id="__codelineno-41-52" name="__codelineno-41-52"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">!</span><span class="nx">sc</span><span class="p">.</span><span class="nx">Scan</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">break</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-41-53"><a id="__codelineno-41-53" name="__codelineno-41-53"></a><span class="w">        </span><span class="nx">txt</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">strings</span><span class="p">.</span><span class="nx">TrimSpace</span><span class="p">(</span><span class="nx">sc</span><span class="p">.</span><span class="nx">Text</span><span class="p">())</span>
</span><span id="__span-41-54"><a id="__codelineno-41-54" name="__codelineno-41-54"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">txt</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;exit&quot;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">break</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-41-55"><a id="__codelineno-41-55" name="__codelineno-41-55"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">txt</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">continue</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-41-56"><a id="__codelineno-41-56" name="__codelineno-41-56"></a><span class="w">        </span><span class="nx">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">model</span><span class="p">.</span><span class="nx">NewUserMessage</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;compute %s&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">txt</span><span class="p">))</span>
</span><span id="__span-41-57"><a id="__codelineno-41-57" name="__codelineno-41-57"></a><span class="w">        </span><span class="nx">evts</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">app</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Background</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;user&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;s-%d&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">().</span><span class="nx">UnixNano</span><span class="p">()),</span><span class="w"> </span><span class="nx">msg</span><span class="p">,</span><span class="w"> </span><span class="nx">agent</span><span class="p">.</span><span class="nx">WithRuntimeState</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="s">&quot;n&quot;</span><span class="p">:</span><span class="w"> </span><span class="nx">atoi</span><span class="p">(</span><span class="nx">txt</span><span class="p">)}))</span>
</span><span id="__span-41-58"><a id="__codelineno-41-58" name="__codelineno-41-58"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;run error:&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">);</span><span class="w"> </span><span class="k">continue</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-41-59"><a id="__codelineno-41-59" name="__codelineno-41-59"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="nx">e</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">evts</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-60"><a id="__codelineno-41-60" name="__codelineno-41-60"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">Response</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">Response</span><span class="p">.</span><span class="nx">Object</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">ObjectTypeGraphNodeComplete</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-61"><a id="__codelineno-41-61" name="__codelineno-41-61"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">StateDelta</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">StateDelta</span><span class="p">[</span><span class="s">&quot;_cache_hit&quot;</span><span class="p">];</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;cache hit&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-41-62"><a id="__codelineno-41-62" name="__codelineno-41-62"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-41-63"><a id="__codelineno-41-63" name="__codelineno-41-63"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">Done</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">break</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-41-64"><a id="__codelineno-41-64" name="__codelineno-41-64"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-41-65"><a id="__codelineno-41-65" name="__codelineno-41-65"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-41-66"><a id="__codelineno-41-66" name="__codelineno-41-66"></a><span class="p">}</span>
</span><span id="__span-41-67"><a id="__codelineno-41-67" name="__codelineno-41-67"></a>
</span><span id="__span-41-68"><a id="__codelineno-41-68" name="__codelineno-41-68"></a><span class="kd">func</span><span class="w"> </span><span class="nx">atoi</span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="nx">n</span><span class="w"> </span><span class="kt">int</span><span class="p">;</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sscanf</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%d&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">n</span><span class="p">);</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">n</span><span class="w"> </span><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>Example:
- Interactive + Runner + GraphAgent: <a href="https://github.com/trpc-group/trpc-agent-go/blob/main/examples/graph/nodecache/main.go">examples/graph/nodecache/main.go</a></p>
<h4 id="tools-node">Tools Node</h4>
<p>Executes tool calls in sequence:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-42-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-42-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-42-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-42-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-42-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-42-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-42-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-42-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-42-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-42-10">10</a></span>
<span class="normal"><a href="#__codelineno-42-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-42-1"><a id="__codelineno-42-1" name="__codelineno-42-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-42-2"><a id="__codelineno-42-2" name="__codelineno-42-2"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-42-3"><a id="__codelineno-42-3" name="__codelineno-42-3"></a><span class="p">)</span>
</span><span id="__span-42-4"><a id="__codelineno-42-4" name="__codelineno-42-4"></a>
</span><span id="__span-42-5"><a id="__codelineno-42-5" name="__codelineno-42-5"></a><span class="kd">const</span><span class="w"> </span><span class="nx">nodeTools</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;tools&quot;</span>
</span><span id="__span-42-6"><a id="__codelineno-42-6" name="__codelineno-42-6"></a>
</span><span id="__span-42-7"><a id="__codelineno-42-7" name="__codelineno-42-7"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddToolsNode</span><span class="p">(</span><span class="nx">nodeTools</span><span class="p">,</span><span class="w"> </span><span class="nx">tools</span><span class="p">)</span>
</span><span id="__span-42-8"><a id="__codelineno-42-8" name="__codelineno-42-8"></a><span class="c1">// Multiple tools execute in the order returned by the LLM</span>
</span><span id="__span-42-9"><a id="__codelineno-42-9" name="__codelineno-42-9"></a><span class="c1">// For parallelism, use multiple nodes + parallel edges</span>
</span><span id="__span-42-10"><a id="__codelineno-42-10" name="__codelineno-42-10"></a><span class="c1">// Pairing rule: walk the messages from the tail to the most recent assistant(tool_calls)</span>
</span><span id="__span-42-11"><a id="__codelineno-42-11" name="__codelineno-42-11"></a><span class="c1">// message; stop at a new user to ensure pairing with the current tool call round.</span>
</span></code></pre></div></td></tr></table></div>
<h4 id="reading-tool-results-into-state">Reading Tool Results into State</h4>
<p>After a tools node, add a function node to collect tool outputs from <code>graph.StateKeyMessages</code> and write a structured result into state:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-43-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-43-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-43-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-43-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-43-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-43-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-43-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-43-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-43-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-43-10">10</a></span>
<span class="normal"><a href="#__codelineno-43-11">11</a></span>
<span class="normal"><a href="#__codelineno-43-12">12</a></span>
<span class="normal"><a href="#__codelineno-43-13">13</a></span>
<span class="normal"><a href="#__codelineno-43-14">14</a></span>
<span class="normal"><a href="#__codelineno-43-15">15</a></span>
<span class="normal"><a href="#__codelineno-43-16">16</a></span>
<span class="normal"><a href="#__codelineno-43-17">17</a></span>
<span class="normal"><a href="#__codelineno-43-18">18</a></span>
<span class="normal"><a href="#__codelineno-43-19">19</a></span>
<span class="normal"><a href="#__codelineno-43-20">20</a></span>
<span class="normal"><a href="#__codelineno-43-21">21</a></span>
<span class="normal"><a href="#__codelineno-43-22">22</a></span>
<span class="normal"><a href="#__codelineno-43-23">23</a></span>
<span class="normal"><a href="#__codelineno-43-24">24</a></span>
<span class="normal"><a href="#__codelineno-43-25">25</a></span>
<span class="normal"><a href="#__codelineno-43-26">26</a></span>
<span class="normal"><a href="#__codelineno-43-27">27</a></span>
<span class="normal"><a href="#__codelineno-43-28">28</a></span>
<span class="normal"><a href="#__codelineno-43-29">29</a></span>
<span class="normal"><a href="#__codelineno-43-30">30</a></span>
<span class="normal"><a href="#__codelineno-43-31">31</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-43-1"><a id="__codelineno-43-1" name="__codelineno-43-1"></a><span class="kd">const</span><span class="w"> </span><span class="nx">stateKeyToolResults</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;tool_results&quot;</span>
</span><span id="__span-43-2"><a id="__codelineno-43-2" name="__codelineno-43-2"></a>
</span><span id="__span-43-3"><a id="__codelineno-43-3" name="__codelineno-43-3"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;collect_tool_results&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-43-4"><a id="__codelineno-43-4" name="__codelineno-43-4"></a><span class="w">    </span><span class="nx">msgs</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">s</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyMessages</span><span class="p">].([]</span><span class="nx">model</span><span class="p">.</span><span class="nx">Message</span><span class="p">)</span>
</span><span id="__span-43-5"><a id="__codelineno-43-5" name="__codelineno-43-5"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">msgs</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-43-6"><a id="__codelineno-43-6" name="__codelineno-43-6"></a>
</span><span id="__span-43-7"><a id="__codelineno-43-7" name="__codelineno-43-7"></a><span class="w">    </span><span class="c1">// Find latest assistant(tool_calls) for this round</span>
</span><span id="__span-43-8"><a id="__codelineno-43-8" name="__codelineno-43-8"></a><span class="w">    </span><span class="nx">i</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">msgs</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-43-9"><a id="__codelineno-43-9" name="__codelineno-43-9"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">!(</span><span class="nx">msgs</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">Role</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">model</span><span class="p">.</span><span class="nx">RoleAssistant</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">msgs</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">ToolCalls</span><span class="p">)</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-43-10"><a id="__codelineno-43-10" name="__codelineno-43-10"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">msgs</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">Role</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">model</span><span class="p">.</span><span class="nx">RoleUser</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// crossed a new round</span>
</span><span id="__span-43-11"><a id="__codelineno-43-11" name="__codelineno-43-11"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-43-12"><a id="__codelineno-43-12" name="__codelineno-43-12"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-43-13"><a id="__codelineno-43-13" name="__codelineno-43-13"></a><span class="w">        </span><span class="nx">i</span><span class="o">--</span>
</span><span id="__span-43-14"><a id="__codelineno-43-14" name="__codelineno-43-14"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-43-15"><a id="__codelineno-43-15" name="__codelineno-43-15"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-43-16"><a id="__codelineno-43-16" name="__codelineno-43-16"></a>
</span><span id="__span-43-17"><a id="__codelineno-43-17" name="__codelineno-43-17"></a><span class="w">    </span><span class="c1">// Collect matching tool results (by ToolID)</span>
</span><span id="__span-43-18"><a id="__codelineno-43-18" name="__codelineno-43-18"></a><span class="w">    </span><span class="nx">idset</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">bool</span><span class="p">{}</span>
</span><span id="__span-43-19"><a id="__codelineno-43-19" name="__codelineno-43-19"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">tc</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">msgs</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">ToolCalls</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">idset</span><span class="p">[</span><span class="nx">tc</span><span class="p">.</span><span class="nx">ID</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-43-20"><a id="__codelineno-43-20" name="__codelineno-43-20"></a><span class="w">    </span><span class="nx">results</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{}</span>
</span><span id="__span-43-21"><a id="__codelineno-43-21" name="__codelineno-43-21"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">j</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="nx">j</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">msgs</span><span class="p">);</span><span class="w"> </span><span class="nx">j</span><span class="o">++</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-43-22"><a id="__codelineno-43-22" name="__codelineno-43-22"></a><span class="w">        </span><span class="nx">m</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">msgs</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span>
</span><span id="__span-43-23"><a id="__codelineno-43-23" name="__codelineno-43-23"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">m</span><span class="p">.</span><span class="nx">Role</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">model</span><span class="p">.</span><span class="nx">RoleTool</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">idset</span><span class="p">[</span><span class="nx">m</span><span class="p">.</span><span class="nx">ToolID</span><span class="p">]</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-43-24"><a id="__codelineno-43-24" name="__codelineno-43-24"></a><span class="w">            </span><span class="c1">// Each tool decided its own output encoding; here treat content as JSON/text</span>
</span><span id="__span-43-25"><a id="__codelineno-43-25" name="__codelineno-43-25"></a><span class="w">            </span><span class="nx">results</span><span class="p">[</span><span class="nx">m</span><span class="p">.</span><span class="nx">ToolName</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">m</span><span class="p">.</span><span class="nx">Content</span>
</span><span id="__span-43-26"><a id="__codelineno-43-26" name="__codelineno-43-26"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-43-27"><a id="__codelineno-43-27" name="__codelineno-43-27"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">m</span><span class="p">.</span><span class="nx">Role</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">model</span><span class="p">.</span><span class="nx">RoleUser</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">break</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-43-28"><a id="__codelineno-43-28" name="__codelineno-43-28"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-43-29"><a id="__codelineno-43-29" name="__codelineno-43-29"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">results</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-43-30"><a id="__codelineno-43-30" name="__codelineno-43-30"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="nx">stateKeyToolResults</span><span class="p">:</span><span class="w"> </span><span class="nx">results</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-43-31"><a id="__codelineno-43-31" name="__codelineno-43-31"></a><span class="p">})</span>
</span></code></pre></div></td></tr></table></div>
<p>Reference example: <code>examples/graph/io_conventions_tools</code>.
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-44-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-44-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-44-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-44-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-44-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-44-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-44-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-44-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-44-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-44-10">10</a></span>
<span class="normal"><a href="#__codelineno-44-11">11</a></span>
<span class="normal"><a href="#__codelineno-44-12">12</a></span>
<span class="normal"><a href="#__codelineno-44-13">13</a></span>
<span class="normal"><a href="#__codelineno-44-14">14</a></span>
<span class="normal"><a href="#__codelineno-44-15">15</a></span>
<span class="normal"><a href="#__codelineno-44-16">16</a></span>
<span class="normal"><a href="#__codelineno-44-17">17</a></span>
<span class="normal"><a href="#__codelineno-44-18">18</a></span>
<span class="normal"><a href="#__codelineno-44-19">19</a></span>
<span class="normal"><a href="#__codelineno-44-20">20</a></span>
<span class="normal"><a href="#__codelineno-44-21">21</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-44-1"><a id="__codelineno-44-1" name="__codelineno-44-1"></a>#### Agent Node
</span><span id="__span-44-2"><a id="__codelineno-44-2" name="__codelineno-44-2"></a>Embed a sub‑agent to enable multi‑agent collaboration:
</span><span id="__span-44-3"><a id="__codelineno-44-3" name="__codelineno-44-3"></a>
</span><span id="__span-44-4"><a id="__codelineno-44-4" name="__codelineno-44-4"></a>```go
</span><span id="__span-44-5"><a id="__codelineno-44-5" name="__codelineno-44-5"></a>import (
</span><span id="__span-44-6"><a id="__codelineno-44-6" name="__codelineno-44-6"></a>    &quot;trpc.group/trpc-go/trpc-agent-go/agent&quot;
</span><span id="__span-44-7"><a id="__codelineno-44-7" name="__codelineno-44-7"></a>    &quot;trpc.group/trpc-go/trpc-agent-go/agent/graphagent&quot;
</span><span id="__span-44-8"><a id="__codelineno-44-8" name="__codelineno-44-8"></a>)
</span><span id="__span-44-9"><a id="__codelineno-44-9" name="__codelineno-44-9"></a>
</span><span id="__span-44-10"><a id="__codelineno-44-10" name="__codelineno-44-10"></a>const (
</span><span id="__span-44-11"><a id="__codelineno-44-11" name="__codelineno-44-11"></a>    subAgentNameAnalyzer = &quot;analyzer&quot;
</span><span id="__span-44-12"><a id="__codelineno-44-12" name="__codelineno-44-12"></a>    graphAgentNameMain   = &quot;main&quot;
</span><span id="__span-44-13"><a id="__codelineno-44-13" name="__codelineno-44-13"></a>)
</span><span id="__span-44-14"><a id="__codelineno-44-14" name="__codelineno-44-14"></a>
</span><span id="__span-44-15"><a id="__codelineno-44-15" name="__codelineno-44-15"></a>// Important: node ID must match the sub‑agent&#39;s name
</span><span id="__span-44-16"><a id="__codelineno-44-16" name="__codelineno-44-16"></a>sg.AddAgentNode(subAgentNameAnalyzer)
</span><span id="__span-44-17"><a id="__codelineno-44-17" name="__codelineno-44-17"></a>
</span><span id="__span-44-18"><a id="__codelineno-44-18" name="__codelineno-44-18"></a>// Inject sub‑agent instances when creating the GraphAgent
</span><span id="__span-44-19"><a id="__codelineno-44-19" name="__codelineno-44-19"></a>analyzer := createAnalyzer()  // internal agent name must be &quot;analyzer&quot;
</span><span id="__span-44-20"><a id="__codelineno-44-20" name="__codelineno-44-20"></a>graphAgent, _ := graphagent.New(graphAgentNameMain, g,
</span><span id="__span-44-21"><a id="__codelineno-44-21" name="__codelineno-44-21"></a>    graphagent.WithSubAgents([]agent.Agent{analyzer}))
</span></code></pre></div></td></tr></table></div></p>
<h3 id="edges-and-routing">Edges and Routing</h3>
<p>Edges define control flow between nodes:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-45-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-45-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-45-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-45-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-45-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-45-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-45-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-45-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-45-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-45-10">10</a></span>
<span class="normal"><a href="#__codelineno-45-11">11</a></span>
<span class="normal"><a href="#__codelineno-45-12">12</a></span>
<span class="normal"><a href="#__codelineno-45-13">13</a></span>
<span class="normal"><a href="#__codelineno-45-14">14</a></span>
<span class="normal"><a href="#__codelineno-45-15">15</a></span>
<span class="normal"><a href="#__codelineno-45-16">16</a></span>
<span class="normal"><a href="#__codelineno-45-17">17</a></span>
<span class="normal"><a href="#__codelineno-45-18">18</a></span>
<span class="normal"><a href="#__codelineno-45-19">19</a></span>
<span class="normal"><a href="#__codelineno-45-20">20</a></span>
<span class="normal"><a href="#__codelineno-45-21">21</a></span>
<span class="normal"><a href="#__codelineno-45-22">22</a></span>
<span class="normal"><a href="#__codelineno-45-23">23</a></span>
<span class="normal"><a href="#__codelineno-45-24">24</a></span>
<span class="normal"><a href="#__codelineno-45-25">25</a></span>
<span class="normal"><a href="#__codelineno-45-26">26</a></span>
<span class="normal"><a href="#__codelineno-45-27">27</a></span>
<span class="normal"><a href="#__codelineno-45-28">28</a></span>
<span class="normal"><a href="#__codelineno-45-29">29</a></span>
<span class="normal"><a href="#__codelineno-45-30">30</a></span>
<span class="normal"><a href="#__codelineno-45-31">31</a></span>
<span class="normal"><a href="#__codelineno-45-32">32</a></span>
<span class="normal"><a href="#__codelineno-45-33">33</a></span>
<span class="normal"><a href="#__codelineno-45-34">34</a></span>
<span class="normal"><a href="#__codelineno-45-35">35</a></span>
<span class="normal"><a href="#__codelineno-45-36">36</a></span>
<span class="normal"><a href="#__codelineno-45-37">37</a></span>
<span class="normal"><a href="#__codelineno-45-38">38</a></span>
<span class="normal"><a href="#__codelineno-45-39">39</a></span>
<span class="normal"><a href="#__codelineno-45-40">40</a></span>
<span class="normal"><a href="#__codelineno-45-41">41</a></span>
<span class="normal"><a href="#__codelineno-45-42">42</a></span>
<span class="normal"><a href="#__codelineno-45-43">43</a></span>
<span class="normal"><a href="#__codelineno-45-44">44</a></span>
<span class="normal"><a href="#__codelineno-45-45">45</a></span>
<span class="normal"><a href="#__codelineno-45-46">46</a></span>
<span class="normal"><a href="#__codelineno-45-47">47</a></span>
<span class="normal"><a href="#__codelineno-45-48">48</a></span>
<span class="normal"><a href="#__codelineno-45-49">49</a></span>
<span class="normal"><a href="#__codelineno-45-50">50</a></span>
<span class="normal"><a href="#__codelineno-45-51">51</a></span>
<span class="normal"><a href="#__codelineno-45-52">52</a></span>
<span class="normal"><a href="#__codelineno-45-53">53</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-45-1"><a id="__codelineno-45-1" name="__codelineno-45-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-45-2"><a id="__codelineno-45-2" name="__codelineno-45-2"></a><span class="w">    </span><span class="s">&quot;context&quot;</span>
</span><span id="__span-45-3"><a id="__codelineno-45-3" name="__codelineno-45-3"></a>
</span><span id="__span-45-4"><a id="__codelineno-45-4" name="__codelineno-45-4"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-45-5"><a id="__codelineno-45-5" name="__codelineno-45-5"></a><span class="p">)</span>
</span><span id="__span-45-6"><a id="__codelineno-45-6" name="__codelineno-45-6"></a>
</span><span id="__span-45-7"><a id="__codelineno-45-7" name="__codelineno-45-7"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-45-8"><a id="__codelineno-45-8" name="__codelineno-45-8"></a><span class="w">    </span><span class="nx">nodeA</span><span class="w">         </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;nodeA&quot;</span>
</span><span id="__span-45-9"><a id="__codelineno-45-9" name="__codelineno-45-9"></a><span class="w">    </span><span class="nx">nodeB</span><span class="w">         </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;nodeB&quot;</span>
</span><span id="__span-45-10"><a id="__codelineno-45-10" name="__codelineno-45-10"></a><span class="w">    </span><span class="nx">nodeDecision</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;decision&quot;</span>
</span><span id="__span-45-11"><a id="__codelineno-45-11" name="__codelineno-45-11"></a><span class="w">    </span><span class="nx">nodePathA</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;pathA&quot;</span>
</span><span id="__span-45-12"><a id="__codelineno-45-12" name="__codelineno-45-12"></a><span class="w">    </span><span class="nx">nodePathB</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;pathB&quot;</span>
</span><span id="__span-45-13"><a id="__codelineno-45-13" name="__codelineno-45-13"></a>
</span><span id="__span-45-14"><a id="__codelineno-45-14" name="__codelineno-45-14"></a><span class="w">    </span><span class="nx">routeToPathA</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;route_to_pathA&quot;</span>
</span><span id="__span-45-15"><a id="__codelineno-45-15" name="__codelineno-45-15"></a><span class="w">    </span><span class="nx">routeToPathB</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;route_to_pathB&quot;</span>
</span><span id="__span-45-16"><a id="__codelineno-45-16" name="__codelineno-45-16"></a><span class="w">    </span><span class="nx">stateKeyFlag</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;flag&quot;</span>
</span><span id="__span-45-17"><a id="__codelineno-45-17" name="__codelineno-45-17"></a><span class="p">)</span>
</span><span id="__span-45-18"><a id="__codelineno-45-18" name="__codelineno-45-18"></a>
</span><span id="__span-45-19"><a id="__codelineno-45-19" name="__codelineno-45-19"></a><span class="c1">// Straight edge</span>
</span><span id="__span-45-20"><a id="__codelineno-45-20" name="__codelineno-45-20"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddEdge</span><span class="p">(</span><span class="nx">nodeA</span><span class="p">,</span><span class="w"> </span><span class="nx">nodeB</span><span class="p">)</span>
</span><span id="__span-45-21"><a id="__codelineno-45-21" name="__codelineno-45-21"></a>
</span><span id="__span-45-22"><a id="__codelineno-45-22" name="__codelineno-45-22"></a><span class="c1">// Conditional edges (third arg is the route map; provide explicitly for static checks)</span>
</span><span id="__span-45-23"><a id="__codelineno-45-23" name="__codelineno-45-23"></a><span class="c1">// Define target nodes first</span>
</span><span id="__span-45-24"><a id="__codelineno-45-24" name="__codelineno-45-24"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="nx">nodePathA</span><span class="p">,</span><span class="w"> </span><span class="nx">handlerA</span><span class="p">)</span>
</span><span id="__span-45-25"><a id="__codelineno-45-25" name="__codelineno-45-25"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="nx">nodePathB</span><span class="p">,</span><span class="w"> </span><span class="nx">handlerB</span><span class="p">)</span>
</span><span id="__span-45-26"><a id="__codelineno-45-26" name="__codelineno-45-26"></a><span class="c1">// Then add conditional routing</span>
</span><span id="__span-45-27"><a id="__codelineno-45-27" name="__codelineno-45-27"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddConditionalEdges</span><span class="p">(</span><span class="nx">nodeDecision</span><span class="p">,</span><span class="w"> </span>
</span><span id="__span-45-28"><a id="__codelineno-45-28" name="__codelineno-45-28"></a><span class="w">    </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-45-29"><a id="__codelineno-45-29" name="__codelineno-45-29"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">s</span><span class="p">[</span><span class="nx">stateKeyFlag</span><span class="p">].(</span><span class="kt">bool</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-45-30"><a id="__codelineno-45-30" name="__codelineno-45-30"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">routeToPathA</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-45-31"><a id="__codelineno-45-31" name="__codelineno-45-31"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-45-32"><a id="__codelineno-45-32" name="__codelineno-45-32"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">routeToPathB</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-45-33"><a id="__codelineno-45-33" name="__codelineno-45-33"></a><span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span>
</span><span id="__span-45-34"><a id="__codelineno-45-34" name="__codelineno-45-34"></a><span class="w">        </span><span class="nx">routeToPathA</span><span class="p">:</span><span class="w"> </span><span class="nx">nodePathA</span><span class="p">,</span>
</span><span id="__span-45-35"><a id="__codelineno-45-35" name="__codelineno-45-35"></a><span class="w">        </span><span class="nx">routeToPathB</span><span class="p">:</span><span class="w"> </span><span class="nx">nodePathB</span><span class="p">,</span>
</span><span id="__span-45-36"><a id="__codelineno-45-36" name="__codelineno-45-36"></a><span class="w">    </span><span class="p">})</span>
</span><span id="__span-45-37"><a id="__codelineno-45-37" name="__codelineno-45-37"></a>
</span><span id="__span-45-38"><a id="__codelineno-45-38" name="__codelineno-45-38"></a><span class="c1">// Tools conditional edges: handle LLM tool calls</span>
</span><span id="__span-45-39"><a id="__codelineno-45-39" name="__codelineno-45-39"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-45-40"><a id="__codelineno-45-40" name="__codelineno-45-40"></a><span class="w">    </span><span class="nx">nodeLLM</span><span class="w">      </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;llm&quot;</span>
</span><span id="__span-45-41"><a id="__codelineno-45-41" name="__codelineno-45-41"></a><span class="w">    </span><span class="nx">nodeToolsUse</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;tools&quot;</span>
</span><span id="__span-45-42"><a id="__codelineno-45-42" name="__codelineno-45-42"></a><span class="w">    </span><span class="nx">nodeFallback</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;fallback&quot;</span>
</span><span id="__span-45-43"><a id="__codelineno-45-43" name="__codelineno-45-43"></a><span class="p">)</span>
</span><span id="__span-45-44"><a id="__codelineno-45-44" name="__codelineno-45-44"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddToolsConditionalEdges</span><span class="p">(</span><span class="nx">nodeLLM</span><span class="p">,</span><span class="w"> </span><span class="nx">nodeToolsUse</span><span class="p">,</span><span class="w"> </span><span class="nx">nodeFallback</span><span class="p">)</span>
</span><span id="__span-45-45"><a id="__codelineno-45-45" name="__codelineno-45-45"></a>
</span><span id="__span-45-46"><a id="__codelineno-45-46" name="__codelineno-45-46"></a><span class="c1">// Parallel edges: branches from the same node run in parallel</span>
</span><span id="__span-45-47"><a id="__codelineno-45-47" name="__codelineno-45-47"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-45-48"><a id="__codelineno-45-48" name="__codelineno-45-48"></a><span class="w">    </span><span class="nx">nodeSplit</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;split&quot;</span>
</span><span id="__span-45-49"><a id="__codelineno-45-49" name="__codelineno-45-49"></a><span class="w">    </span><span class="nx">nodeBranch1</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;branch1&quot;</span>
</span><span id="__span-45-50"><a id="__codelineno-45-50" name="__codelineno-45-50"></a><span class="w">    </span><span class="nx">nodeBranch2</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;branch2&quot;</span>
</span><span id="__span-45-51"><a id="__codelineno-45-51" name="__codelineno-45-51"></a><span class="p">)</span>
</span><span id="__span-45-52"><a id="__codelineno-45-52" name="__codelineno-45-52"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddEdge</span><span class="p">(</span><span class="nx">nodeSplit</span><span class="p">,</span><span class="w"> </span><span class="nx">nodeBranch1</span><span class="p">)</span>
</span><span id="__span-45-53"><a id="__codelineno-45-53" name="__codelineno-45-53"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddEdge</span><span class="p">(</span><span class="nx">nodeSplit</span><span class="p">,</span><span class="w"> </span><span class="nx">nodeBranch2</span><span class="p">)</span><span class="w">  </span><span class="c1">// branch1 and branch2 execute in parallel</span>
</span></code></pre></div></td></tr></table></div>
<p>Tip: setting entry and finish points implicitly connects to virtual Start/End nodes:
- <code>SetEntryPoint("first")</code> is equivalent to Start → first.
- <code>SetFinishPoint("last")</code> is equivalent to last → End.
There’s no need to add these two edges explicitly.</p>
<p>Constants: <code>graph.Start == "__start__"</code>, <code>graph.End == "__end__"</code>.</p>
<h3 id="command-mode-dynamic-routing-fanout">Command Mode (Dynamic Routing / Fan‑out)</h3>
<p>Nodes can return <code>graph.State</code>, or <code>*graph.Command</code> / <code>[]*graph.Command</code> to update state and direct the next hop:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-46-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-46-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-46-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-46-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-46-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-46-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-46-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-46-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-46-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-46-10">10</a></span>
<span class="normal"><a href="#__codelineno-46-11">11</a></span>
<span class="normal"><a href="#__codelineno-46-12">12</a></span>
<span class="normal"><a href="#__codelineno-46-13">13</a></span>
<span class="normal"><a href="#__codelineno-46-14">14</a></span>
<span class="normal"><a href="#__codelineno-46-15">15</a></span>
<span class="normal"><a href="#__codelineno-46-16">16</a></span>
<span class="normal"><a href="#__codelineno-46-17">17</a></span>
<span class="normal"><a href="#__codelineno-46-18">18</a></span>
<span class="normal"><a href="#__codelineno-46-19">19</a></span>
<span class="normal"><a href="#__codelineno-46-20">20</a></span>
<span class="normal"><a href="#__codelineno-46-21">21</a></span>
<span class="normal"><a href="#__codelineno-46-22">22</a></span>
<span class="normal"><a href="#__codelineno-46-23">23</a></span>
<span class="normal"><a href="#__codelineno-46-24">24</a></span>
<span class="normal"><a href="#__codelineno-46-25">25</a></span>
<span class="normal"><a href="#__codelineno-46-26">26</a></span>
<span class="normal"><a href="#__codelineno-46-27">27</a></span>
<span class="normal"><a href="#__codelineno-46-28">28</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-46-1"><a id="__codelineno-46-1" name="__codelineno-46-1"></a><span class="c1">// Dynamic route to A or B with a state write</span>
</span><span id="__span-46-2"><a id="__codelineno-46-2" name="__codelineno-46-2"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-46-3"><a id="__codelineno-46-3" name="__codelineno-46-3"></a><span class="w">    </span><span class="nx">nodeDecide</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;decide&quot;</span>
</span><span id="__span-46-4"><a id="__codelineno-46-4" name="__codelineno-46-4"></a><span class="w">    </span><span class="nx">nodeA</span><span class="w">      </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;A&quot;</span>
</span><span id="__span-46-5"><a id="__codelineno-46-5" name="__codelineno-46-5"></a><span class="w">    </span><span class="nx">nodeB</span><span class="w">      </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;B&quot;</span>
</span><span id="__span-46-6"><a id="__codelineno-46-6" name="__codelineno-46-6"></a><span class="w">    </span><span class="nx">stateKeyFlag</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;flag&quot;</span>
</span><span id="__span-46-7"><a id="__codelineno-46-7" name="__codelineno-46-7"></a><span class="p">)</span>
</span><span id="__span-46-8"><a id="__codelineno-46-8" name="__codelineno-46-8"></a>
</span><span id="__span-46-9"><a id="__codelineno-46-9" name="__codelineno-46-9"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="nx">nodeDecide</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-46-10"><a id="__codelineno-46-10" name="__codelineno-46-10"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">s</span><span class="p">[</span><span class="nx">stateKeyFlag</span><span class="p">].(</span><span class="kt">bool</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-46-11"><a id="__codelineno-46-11" name="__codelineno-46-11"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">graph</span><span class="p">.</span><span class="nx">Command</span><span class="p">{</span><span class="nx">Update</span><span class="p">:</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="s">&quot;routed&quot;</span><span class="p">:</span><span class="w"> </span><span class="nx">nodeA</span><span class="p">},</span><span class="w"> </span><span class="nx">GoTo</span><span class="p">:</span><span class="w"> </span><span class="nx">nodeA</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-46-12"><a id="__codelineno-46-12" name="__codelineno-46-12"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-46-13"><a id="__codelineno-46-13" name="__codelineno-46-13"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">graph</span><span class="p">.</span><span class="nx">Command</span><span class="p">{</span><span class="nx">Update</span><span class="p">:</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="s">&quot;routed&quot;</span><span class="p">:</span><span class="w"> </span><span class="nx">nodeB</span><span class="p">},</span><span class="w"> </span><span class="nx">GoTo</span><span class="p">:</span><span class="w"> </span><span class="nx">nodeB</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-46-14"><a id="__codelineno-46-14" name="__codelineno-46-14"></a><span class="p">})</span>
</span><span id="__span-46-15"><a id="__codelineno-46-15" name="__codelineno-46-15"></a>
</span><span id="__span-46-16"><a id="__codelineno-46-16" name="__codelineno-46-16"></a><span class="c1">// Fan-out: dispatch multiple tasks to the same worker in parallel</span>
</span><span id="__span-46-17"><a id="__codelineno-46-17" name="__codelineno-46-17"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-46-18"><a id="__codelineno-46-18" name="__codelineno-46-18"></a><span class="w">    </span><span class="nx">nodeFanout</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;fanout&quot;</span>
</span><span id="__span-46-19"><a id="__codelineno-46-19" name="__codelineno-46-19"></a><span class="w">    </span><span class="nx">nodeWorker</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;worker&quot;</span>
</span><span id="__span-46-20"><a id="__codelineno-46-20" name="__codelineno-46-20"></a><span class="p">)</span>
</span><span id="__span-46-21"><a id="__codelineno-46-21" name="__codelineno-46-21"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="nx">nodeFanout</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-46-22"><a id="__codelineno-46-22" name="__codelineno-46-22"></a><span class="w">    </span><span class="nx">cmds</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">[]</span><span class="o">*</span><span class="nx">graph</span><span class="p">.</span><span class="nx">Command</span><span class="p">{</span>
</span><span id="__span-46-23"><a id="__codelineno-46-23" name="__codelineno-46-23"></a><span class="w">        </span><span class="p">{</span><span class="nx">Update</span><span class="p">:</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="s">&quot;param&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;A&quot;</span><span class="p">},</span><span class="w"> </span><span class="nx">GoTo</span><span class="p">:</span><span class="w"> </span><span class="nx">nodeWorker</span><span class="p">},</span>
</span><span id="__span-46-24"><a id="__codelineno-46-24" name="__codelineno-46-24"></a><span class="w">        </span><span class="p">{</span><span class="nx">Update</span><span class="p">:</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="s">&quot;param&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;B&quot;</span><span class="p">},</span><span class="w"> </span><span class="nx">GoTo</span><span class="p">:</span><span class="w"> </span><span class="nx">nodeWorker</span><span class="p">},</span>
</span><span id="__span-46-25"><a id="__codelineno-46-25" name="__codelineno-46-25"></a><span class="w">        </span><span class="p">{</span><span class="nx">Update</span><span class="p">:</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="s">&quot;param&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;C&quot;</span><span class="p">},</span><span class="w"> </span><span class="nx">GoTo</span><span class="p">:</span><span class="w"> </span><span class="nx">nodeWorker</span><span class="p">},</span>
</span><span id="__span-46-26"><a id="__codelineno-46-26" name="__codelineno-46-26"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-46-27"><a id="__codelineno-46-27" name="__codelineno-46-27"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">cmds</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-46-28"><a id="__codelineno-46-28" name="__codelineno-46-28"></a><span class="p">})</span>
</span></code></pre></div></td></tr></table></div>
<p>When using command‑based routing, you don’t need static edges to <code>GoTo</code> targets; just ensure the target nodes exist and call <code>SetFinishPoint</code> where appropriate.</p>
<h2 id="architecture">Architecture</h2>
<h3 id="overall-architecture">Overall Architecture</h3>
<p>GraphAgent’s architecture manages complexity via clear layering. Each layer has a well‑defined responsibility and communicates through standard interfaces.</p>
<pre class="mermaid"><code>flowchart TB
    subgraph "Runner Layer"
        R[Runner]:::runnerClass
        S[Session Service]:::sessionClass
    end

    subgraph "GraphAgent"
        GA[GraphAgent Wrapper]:::agentClass
        CB[Callbacks]:::callbackClass
    end

    subgraph "Graph Engine"
        SG[StateGraph Builder]:::builderClass
        G[Graph]:::graphClass
        E[Executor]:::executorClass
    end

    subgraph "Execution Components"
        P[Planning]:::phaseClass
        EX[Execution]:::phaseClass
        U[Update]:::phaseClass
    end

    subgraph "Storage"
        CP[Checkpoint]:::storageClass
        ST[State Store]:::storageClass
    end

    R --&gt; GA
    GA --&gt; G
    G --&gt; E
    E --&gt; P
    E --&gt; EX
    E --&gt; U
    E --&gt; CP

    classDef runnerClass fill:#e8f5e9,stroke:#43a047,stroke-width:2px
    classDef sessionClass fill:#f3e5f5,stroke:#8e24aa,stroke-width:2px
    classDef agentClass fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    classDef callbackClass fill:#fce4ec,stroke:#c2185b,stroke-width:2px
    classDef builderClass fill:#fff8e1,stroke:#f57c00,stroke-width:2px
    classDef graphClass fill:#f1f8e9,stroke:#689f38,stroke-width:2px
    classDef executorClass fill:#e0f2f1,stroke:#00796b,stroke-width:2px
    classDef phaseClass fill:#ede7f6,stroke:#512da8,stroke-width:2px
    classDef storageClass fill:#efebe9,stroke:#5d4037,stroke-width:2px</code></pre>
<h3 id="core-modules">Core Modules</h3>
<p>Overview of core components:</p>
<p><code>graph/state_graph.go</code> — StateGraph builder<br />
Provides a fluent, declarative Go API to build graphs via method chaining (AddNode → AddEdge → Compile) covering nodes, edges, and conditional routing.</p>
<p><code>graph/graph.go</code> — Compiled runtime<br />
Implements channel‑based, event‑triggered execution. Node results merge into State; channels are used to drive routing and carry sentinel values (not business data).</p>
<p><code>graph/executor.go</code> — BSP executor<br />
Heart of the system, inspired by Google’s Pregel. Implements BSP (Bulk Synchronous Parallel) supersteps: Planning → Execution → Update.</p>
<p><code>graph/checkpoint/*</code> — Checkpoints and recovery<br />
Optional checkpoint persistence (e.g., sqlite). Atomically saves state and pending writes; supports lineage/checkpoint‑based recovery.</p>
<p><code>agent/graphagent/graph_agent.go</code> — Bridge between Graph and Agent<br />
Adapts a compiled Graph into a generic Agent, reusing sessions, callbacks, and streaming.</p>
<h3 id="execution-model">Execution Model</h3>
<p>GraphAgent adapts Pregel’s BSP (Bulk Synchronous Parallel) to a single‑process runtime and adds checkpoints, HITL interrupts/resumes, and time travel:</p>
<pre class="mermaid"><code>sequenceDiagram
    autonumber
    participant R as Runner
    participant GA as GraphAgent
    participant EX as Executor
    participant CK as Checkpoint Saver
    participant DB as Storage
    participant H as Human

    R-&gt;&gt;GA: Run(invocation)
    GA-&gt;&gt;EX: Execute(graph, state, options)
    GA--&gt;&gt;R: Stream node/tool/model events

    loop Each superstep (BSP)
        EX-&gt;&gt;EX: Planning — compute frontier
        par Parallel node execution
            EX-&gt;&gt;EX: Run node i (shallow state copy)
            EX--&gt;&gt;GA: node-start event (author=nodeID)
        and
            EX-&gt;&gt;EX: Run node j (shallow state copy)
            EX--&gt;&gt;GA: node-start event
        end

        alt Node triggers Interrupt(key,prompt)
            EX-&gt;&gt;CK: Save checkpoint(state,frontier,
            EX-&gt;&gt;CK: pending_writes,versions_seen,reason=interrupt)
            CK-&gt;&gt;DB: atomic commit
            EX--&gt;&gt;GA: interrupt event(checkpoint_id,prompt)
            GA--&gt;&gt;R: propagate + pause
            R-&gt;&gt;H: ask for input/approval
            H--&gt;&gt;R: provide decision/value
            R-&gt;&gt;GA: Run(resume) runtime_state{
            R-&gt;&gt;GA: checkpoint_id,resume_map}
            GA-&gt;&gt;EX: ResumeFromCheckpoint(checkpoint_id,resume_map)
            EX-&gt;&gt;CK: Load checkpoint
            CK-&gt;&gt;EX: state/frontier/pending_writes/versions_seen
            EX-&gt;&gt;EX: rebuild frontier and apply resume values
        else Normal
            EX--&gt;&gt;GA: node-complete events (incl. tool/model)
            EX-&gt;&gt;EX: Update — merge via reducers
            EX-&gt;&gt;CK: Save checkpoint(state,frontier,
            EX-&gt;&gt;CK: pending_writes,versions_seen)
            CK-&gt;&gt;DB: atomic commit
        end
    end

    Note over EX,CK: versions_seen prevents re-execution
    Note over EX,CK: pending_writes rebuilds channels
    Note over EX,CK: parent_id forms lineage for time travel

    opt Time travel (rewind/branch)
        R-&gt;&gt;GA: Run(runtime_state{checkpoint_id})
        GA-&gt;&gt;EX: ResumeFromCheckpoint(checkpoint_id)
        EX-&gt;&gt;CK: Load checkpoint + lineage
        CK-&gt;&gt;EX: Restore state; may create new lineage_id
    end

    EX--&gt;&gt;GA: done event (last_response)
    GA--&gt;&gt;R: final output</code></pre>
<pre class="mermaid"><code>flowchart TB
    %% Execution panorama (compact wiring)
    subgraph Client
        R[Runner]:::runner --&gt; GA[GraphAgent]:::agent
    end

    subgraph Engine[Graph Engine]
        GA --&gt; EX[Executor]:::executor
        subgraph BSP["BSP Superstep"]
            P[Planning]:::phase --&gt; X[Execution]:::phase --&gt; U[Update]:::phase
        end
    end

    N[Nodes: LLM / Tools / Function / Agent]:::process
    CK[(Checkpoint)]:::storage
    H[Human]:::human

    EX --&gt; BSP
    EX --&gt; N
    EX -.-&gt; CK
    GA &lt;--&gt; H
    GA --&gt; R

    classDef runner fill:#e8f5e9,stroke:#43a047,stroke-width:2px
    classDef agent fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    classDef executor fill:#e0f2f1,stroke:#00796b,stroke-width:2px
    classDef phase fill:#ede7f6,stroke:#512da8,stroke-width:2px
    classDef process fill:#f3e5f5,stroke:#9c27b0,stroke-width:2px
    classDef storage fill:#efebe9,stroke:#6d4c41,stroke-width:2px
    classDef human fill:#e8f5e9,stroke:#43a047,stroke-width:2px</code></pre>
<p>Key points:</p>
<ol>
<li>Planning: determine runnable nodes from the channel frontier.</li>
<li>Execution: each node gets a shallow state copy (maps.Copy) and runs in parallel.</li>
<li>Update: reducers merge updates safely for concurrency.</li>
</ol>
<p>This design enables per‑step observability and safe interruption/recovery.</p>
<h4 id="runtime-isolation-and-event-snapshots">Runtime Isolation and Event Snapshots</h4>
<ul>
<li>The Executor is reusable and concurrency‑safe. Per‑run state lives in <code>ExecutionContext</code> (channel versions, pending writes, last checkpoint, etc.).</li>
<li>Each event’s <code>StateDelta</code> is a deep‑copy snapshot containing only serializable and allowed keys; internal keys (execution context, callbacks, etc.) are filtered out for external telemetry and persistence.</li>
</ul>
<h3 id="executor-configuration">Executor Configuration</h3>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-47-1">1</a></span>
<span class="normal"><a href="#__codelineno-47-2">2</a></span>
<span class="normal"><a href="#__codelineno-47-3">3</a></span>
<span class="normal"><a href="#__codelineno-47-4">4</a></span>
<span class="normal"><a href="#__codelineno-47-5">5</a></span>
<span class="normal"><a href="#__codelineno-47-6">6</a></span>
<span class="normal"><a href="#__codelineno-47-7">7</a></span>
<span class="normal"><a href="#__codelineno-47-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-47-1"><a id="__codelineno-47-1" name="__codelineno-47-1"></a><span class="nx">exec</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewExecutor</span><span class="p">(</span><span class="nx">g</span><span class="p">,</span>
</span><span id="__span-47-2"><a id="__codelineno-47-2" name="__codelineno-47-2"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithChannelBufferSize</span><span class="p">(</span><span class="mi">1024</span><span class="p">),</span><span class="w">              </span><span class="c1">// event channel buffer</span>
</span><span id="__span-47-3"><a id="__codelineno-47-3" name="__codelineno-47-3"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithMaxSteps</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span><span class="w">                          </span><span class="c1">// max steps</span>
</span><span id="__span-47-4"><a id="__codelineno-47-4" name="__codelineno-47-4"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithStepTimeout</span><span class="p">(</span><span class="mi">5</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span><span class="p">),</span><span class="w">            </span><span class="c1">// step timeout</span>
</span><span id="__span-47-5"><a id="__codelineno-47-5" name="__codelineno-47-5"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithNodeTimeout</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span><span class="p">),</span><span class="w">            </span><span class="c1">// node timeout</span>
</span><span id="__span-47-6"><a id="__codelineno-47-6" name="__codelineno-47-6"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithCheckpointSaver</span><span class="p">(</span><span class="nx">saver</span><span class="p">),</span><span class="w">                </span><span class="c1">// enable checkpoints (sqlite/inmemory)</span>
</span><span id="__span-47-7"><a id="__codelineno-47-7" name="__codelineno-47-7"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithCheckpointSaveTimeout</span><span class="p">(</span><span class="mi">30</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">),</span><span class="w"> </span><span class="c1">// checkpoint save timeout</span>
</span><span id="__span-47-8"><a id="__codelineno-47-8" name="__codelineno-47-8"></a><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="defaults-and-notes">Defaults and Notes</h3>
<ul>
<li>Defaults (Executor)<ul>
<li><code>ChannelBufferSize = 256</code>, <code>MaxSteps = 100</code>, <code>CheckpointSaveTimeout = 10s</code></li>
<li>Per‑step/node timeouts are available on <code>Executor</code> via <code>WithStepTimeout</code> / <code>WithNodeTimeout</code> (not exposed by <code>GraphAgent</code> options yet)</li>
</ul>
</li>
</ul>
<ul>
<li>Sessions<ul>
<li>Prefer Redis session backend in production; set TTLs and cleanup</li>
</ul>
</li>
<li>Runner seeds multi‑turn <code>graph.StateKeyMessages</code> from session events automatically</li>
</ul>
<ul>
<li>Checkpoints<ul>
<li>Use stable <code>namespace</code> names (e.g., <code>svc:prod:flowX</code>); audit and clean up by lineage via <code>CheckpointManager</code></li>
</ul>
</li>
</ul>
<ul>
<li>Events/backpressure<ul>
<li>Tune <code>WithChannelBufferSize</code>; filter events by <code>author</code>/<code>object</code> to reduce noise</li>
</ul>
</li>
</ul>
<ul>
<li>Naming and keys<ul>
<li>Use constants for node IDs, route labels, and state keys; define reducers for non‑trivial merges</li>
</ul>
</li>
</ul>
<ul>
<li>Governance</li>
<li>Insert HITL on critical paths; prefer storing sensitive details under <code>graph.StateKeyMetadata</code> rather than <code>graph.StateKeyMessages</code></li>
</ul>
<h2 id="integrating-with-multiagent-systems">Integrating with Multi‑Agent Systems</h2>
<p>GraphAgent is designed to be part of the tRPC‑Agent‑Go multi‑agent ecosystem, not an island. It implements the standard Agent interface and collaborates with other agent types.</p>
<h3 id="graphagent-as-an-agent">GraphAgent as an Agent</h3>
<p>GraphAgent implements the standard Agent interface:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-48-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-48-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-48-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-48-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-48-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-48-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-48-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-48-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-48-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-48-10">10</a></span>
<span class="normal"><a href="#__codelineno-48-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-48-1"><a id="__codelineno-48-1" name="__codelineno-48-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-48-2"><a id="__codelineno-48-2" name="__codelineno-48-2"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/agent&quot;</span>
</span><span id="__span-48-3"><a id="__codelineno-48-3" name="__codelineno-48-3"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/agent/chainagent&quot;</span>
</span><span id="__span-48-4"><a id="__codelineno-48-4" name="__codelineno-48-4"></a><span class="p">)</span>
</span><span id="__span-48-5"><a id="__codelineno-48-5" name="__codelineno-48-5"></a>
</span><span id="__span-48-6"><a id="__codelineno-48-6" name="__codelineno-48-6"></a><span class="c1">// Use directly inside ChainAgent, ParallelAgent, CycleAgent</span>
</span><span id="__span-48-7"><a id="__codelineno-48-7" name="__codelineno-48-7"></a><span class="nx">chain</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">chainagent</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;chain&quot;</span><span class="p">,</span>
</span><span id="__span-48-8"><a id="__codelineno-48-8" name="__codelineno-48-8"></a><span class="w">    </span><span class="nx">chainagent</span><span class="p">.</span><span class="nx">WithSubAgents</span><span class="p">([]</span><span class="nx">agent</span><span class="p">.</span><span class="nx">Agent</span><span class="p">{</span>
</span><span id="__span-48-9"><a id="__codelineno-48-9" name="__codelineno-48-9"></a><span class="w">        </span><span class="nx">graphAgent1</span><span class="p">,</span><span class="w">  </span><span class="c1">// structured flow #1</span>
</span><span id="__span-48-10"><a id="__codelineno-48-10" name="__codelineno-48-10"></a><span class="w">        </span><span class="nx">graphAgent2</span><span class="p">,</span><span class="w">  </span><span class="c1">// structured flow #2</span>
</span><span id="__span-48-11"><a id="__codelineno-48-11" name="__codelineno-48-11"></a><span class="w">    </span><span class="p">}))</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="advanced-orchestration">Advanced Orchestration</h3>
<p>End‑to‑end business flow: entry normalization → smart routing → multiple pods (Email, Weather, Research) → parallel fan‑out/aggregation → final composition and publish.</p>
<pre class="mermaid"><code>flowchart LR
    %% Layout
    subgraph UE["User &amp; Entry"]
        U((User)):::human --&gt; IN["entry&lt;br/&gt;normalize"]:::process
    end

    subgraph FAB["Graph Orchestration"]
        Rtr["where_to_go&lt;br/&gt;router"]:::router
        Compose["compose&lt;br/&gt;LLM"]:::llm
    end

    IN --&gt; Rtr

    %% Email Agent (expanded)
    subgraph EC["Email Agent"]
        direction LR
        CE["classifier&lt;br/&gt;LLM"]:::llm --&gt; WE["writer&lt;br/&gt;LLM"]:::llm
    end

    %% Weather Agent (expanded)
    subgraph WA["Weather Agent"]
        direction LR
        LE["locate&lt;br/&gt;LLM"]:::llm --&gt; WT["weather tool"]:::tool
    end

    %% Routing from router to pods
    Rtr -- email --&gt; CE
    Rtr -- weather --&gt; LE
    Rtr -- other --&gt; REPLY["reply&lt;br/&gt;LLM"]:::llm

    %% Fanout Pipeline (fanout → workers → aggregate)
    subgraph FP["Fanout Pipeline"]
        direction LR
        Fan["plan_fanout"]:::process --&gt; W1["worker A"]:::process
        Fan --&gt; W2["worker B"]:::process
        Fan --&gt; W3["worker C"]:::process
        W1 --&gt; Agg["aggregate"]:::process
        W2 --&gt; Agg
        W3 --&gt; Agg
    end
    Rtr -- research --&gt; Fan

    %% Human-in-the-loop (optional)
    Compose -. review .- HG["human&lt;br/&gt;review"]:::human

    %% Compose final (minimal wiring)
    Agg --&gt; Compose
    WE --&gt; Compose
    WT --&gt; Compose
    REPLY --&gt; Compose
    Compose --&gt; END([END]):::terminal

    %% Styles
    classDef router fill:#fff7e0,stroke:#f5a623,stroke-width:2px
    classDef llm fill:#e3f2fd,stroke:#1e88e5,stroke-width:2px
    classDef tool fill:#fff3e0,stroke:#fb8c00,stroke-width:2px
    classDef process fill:#f3e5f5,stroke:#8e24aa,stroke-width:2px
    classDef human fill:#e8f5e9,stroke:#43a047,stroke-width:2px
    classDef terminal fill:#ffebee,stroke:#e53935,stroke-width:2px</code></pre>
<p>Highlights:
- <code>where_to_go</code> can be LLM‑decided or function‑driven (conditional edges).
- Fanout Pipeline uses Command GoTo at runtime, then aggregates.
- Optional human review follows aggregation to gate critical output.
- Single checkpoint display at Compose balances clarity and recoverability.</p>
<h3 id="embedding-agents-in-a-graph">Embedding Agents in a Graph</h3>
<p>Inside a graph, you can call existing sub‑agents as nodes. The example below shows how to create sub‑agents, declare the corresponding nodes, and inject them when constructing the GraphAgent.</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-49-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-49-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-49-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-49-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-49-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-49-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-49-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-49-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-49-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-49-10">10</a></span>
<span class="normal"><a href="#__codelineno-49-11">11</a></span>
<span class="normal"><a href="#__codelineno-49-12">12</a></span>
<span class="normal"><a href="#__codelineno-49-13">13</a></span>
<span class="normal"><a href="#__codelineno-49-14">14</a></span>
<span class="normal"><a href="#__codelineno-49-15">15</a></span>
<span class="normal"><a href="#__codelineno-49-16">16</a></span>
<span class="normal"><a href="#__codelineno-49-17">17</a></span>
<span class="normal"><a href="#__codelineno-49-18">18</a></span>
<span class="normal"><a href="#__codelineno-49-19">19</a></span>
<span class="normal"><a href="#__codelineno-49-20">20</a></span>
<span class="normal"><a href="#__codelineno-49-21">21</a></span>
<span class="normal"><a href="#__codelineno-49-22">22</a></span>
<span class="normal"><a href="#__codelineno-49-23">23</a></span>
<span class="normal"><a href="#__codelineno-49-24">24</a></span>
<span class="normal"><a href="#__codelineno-49-25">25</a></span>
<span class="normal"><a href="#__codelineno-49-26">26</a></span>
<span class="normal"><a href="#__codelineno-49-27">27</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-49-1"><a id="__codelineno-49-1" name="__codelineno-49-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-49-2"><a id="__codelineno-49-2" name="__codelineno-49-2"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/agent&quot;</span>
</span><span id="__span-49-3"><a id="__codelineno-49-3" name="__codelineno-49-3"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/agent/graphagent&quot;</span>
</span><span id="__span-49-4"><a id="__codelineno-49-4" name="__codelineno-49-4"></a><span class="p">)</span>
</span><span id="__span-49-5"><a id="__codelineno-49-5" name="__codelineno-49-5"></a>
</span><span id="__span-49-6"><a id="__codelineno-49-6" name="__codelineno-49-6"></a><span class="c1">// Create sub‑agents</span>
</span><span id="__span-49-7"><a id="__codelineno-49-7" name="__codelineno-49-7"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-49-8"><a id="__codelineno-49-8" name="__codelineno-49-8"></a><span class="w">    </span><span class="nx">SubAgentAnalyzer</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;analyzer&quot;</span>
</span><span id="__span-49-9"><a id="__codelineno-49-9" name="__codelineno-49-9"></a><span class="w">    </span><span class="nx">SubAgentReviewer</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;reviewer&quot;</span>
</span><span id="__span-49-10"><a id="__codelineno-49-10" name="__codelineno-49-10"></a><span class="p">)</span>
</span><span id="__span-49-11"><a id="__codelineno-49-11" name="__codelineno-49-11"></a><span class="nx">analyzer</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">createAnalyzer</span><span class="p">()</span><span class="w">  </span><span class="c1">// name must be &quot;analyzer&quot;</span>
</span><span id="__span-49-12"><a id="__codelineno-49-12" name="__codelineno-49-12"></a><span class="nx">reviewer</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">createReviewer</span><span class="p">()</span><span class="w">  </span><span class="c1">// name must be &quot;reviewer&quot;</span>
</span><span id="__span-49-13"><a id="__codelineno-49-13" name="__codelineno-49-13"></a>
</span><span id="__span-49-14"><a id="__codelineno-49-14" name="__codelineno-49-14"></a><span class="c1">// Declare agent nodes in the graph</span>
</span><span id="__span-49-15"><a id="__codelineno-49-15" name="__codelineno-49-15"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddAgentNode</span><span class="p">(</span><span class="nx">SubAgentAnalyzer</span><span class="p">)</span>
</span><span id="__span-49-16"><a id="__codelineno-49-16" name="__codelineno-49-16"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddAgentNode</span><span class="p">(</span><span class="nx">SubAgentReviewer</span><span class="p">)</span>
</span><span id="__span-49-17"><a id="__codelineno-49-17" name="__codelineno-49-17"></a>
</span><span id="__span-49-18"><a id="__codelineno-49-18" name="__codelineno-49-18"></a><span class="c1">// Inject sub‑agents when creating the GraphAgent</span>
</span><span id="__span-49-19"><a id="__codelineno-49-19" name="__codelineno-49-19"></a><span class="nx">graphAgent</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;workflow&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">g</span><span class="p">,</span>
</span><span id="__span-49-20"><a id="__codelineno-49-20" name="__codelineno-49-20"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithSubAgents</span><span class="p">([]</span><span class="nx">agent</span><span class="p">.</span><span class="nx">Agent</span><span class="p">{</span>
</span><span id="__span-49-21"><a id="__codelineno-49-21" name="__codelineno-49-21"></a><span class="w">        </span><span class="nx">analyzer</span><span class="p">,</span>
</span><span id="__span-49-22"><a id="__codelineno-49-22" name="__codelineno-49-22"></a><span class="w">        </span><span class="nx">reviewer</span><span class="p">,</span>
</span><span id="__span-49-23"><a id="__codelineno-49-23" name="__codelineno-49-23"></a><span class="w">    </span><span class="p">}))</span>
</span><span id="__span-49-24"><a id="__codelineno-49-24" name="__codelineno-49-24"></a>
</span><span id="__span-49-25"><a id="__codelineno-49-25" name="__codelineno-49-25"></a><span class="c1">// I/O: sub‑agents receive graph.StateKeyUserInput as the message AND the full</span>
</span><span id="__span-49-26"><a id="__codelineno-49-26" name="__codelineno-49-26"></a><span class="c1">// graph state via inv.RunOptions.RuntimeState; on finish they update</span>
</span><span id="__span-49-27"><a id="__codelineno-49-27" name="__codelineno-49-27"></a><span class="c1">// graph.StateKeyLastResponse and graph.StateKeyNodeResponses[nodeID]</span>
</span></code></pre></div></td></tr></table></div>
<h4 id="passing-only-results-map-last_response-to-downstream-user_input">Passing only results: map last_response to downstream user_input</h4>
<blockquote>
<p>Scenario: A → B → C as black boxes. Downstream should only consume upstream’s result text as this turn’s input, without pulling full session history.</p>
</blockquote>
<ul>
<li>Approach 1 (dependency‑free, universally available): add a pre‑node callback to the target Agent node that assigns parent <code>last_response</code> to <code>user_input</code>. Optionally isolate messages.</li>
</ul>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-50-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-50-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-50-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-50-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-50-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-50-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-50-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-50-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-50-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-50-10">10</a></span>
<span class="normal"><a href="#__codelineno-50-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-50-1"><a id="__codelineno-50-1" name="__codelineno-50-1"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddAgentNode</span><span class="p">(</span><span class="s">&quot;orchestrator&quot;</span><span class="p">,</span>
</span><span id="__span-50-2"><a id="__codelineno-50-2" name="__codelineno-50-2"></a><span class="w">    </span><span class="c1">// Map upstream last_response → this turn&#39;s user_input</span>
</span><span id="__span-50-3"><a id="__codelineno-50-3" name="__codelineno-50-3"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithPreNodeCallback</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">cb</span><span class="w"> </span><span class="o">*</span><span class="nx">graph</span><span class="p">.</span><span class="nx">NodeCallbackContext</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-50-4"><a id="__codelineno-50-4" name="__codelineno-50-4"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">v</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">s</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyLastResponse</span><span class="p">].(</span><span class="kt">string</span><span class="p">);</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">v</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-50-5"><a id="__codelineno-50-5" name="__codelineno-50-5"></a><span class="w">            </span><span class="nx">s</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyUserInput</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">v</span>
</span><span id="__span-50-6"><a id="__codelineno-50-6" name="__codelineno-50-6"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-50-7"><a id="__codelineno-50-7" name="__codelineno-50-7"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-50-8"><a id="__codelineno-50-8" name="__codelineno-50-8"></a><span class="w">    </span><span class="p">}),</span>
</span><span id="__span-50-9"><a id="__codelineno-50-9" name="__codelineno-50-9"></a><span class="w">    </span><span class="c1">// Optional: isolate child sub‑agent from session contents</span>
</span><span id="__span-50-10"><a id="__codelineno-50-10" name="__codelineno-50-10"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithSubgraphIsolatedMessages</span><span class="p">(</span><span class="kc">true</span><span class="p">),</span>
</span><span id="__span-50-11"><a id="__codelineno-50-11" name="__codelineno-50-11"></a><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<ul>
<li>Approach 2 (enhanced option, more concise):</li>
</ul>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-51-1">1</a></span>
<span class="normal"><a href="#__codelineno-51-2">2</a></span>
<span class="normal"><a href="#__codelineno-51-3">3</a></span>
<span class="normal"><a href="#__codelineno-51-4">4</a></span>
<span class="normal"><a href="#__codelineno-51-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-51-1"><a id="__codelineno-51-1" name="__codelineno-51-1"></a><span class="c1">// Declarative option that automatically maps last_response → user_input</span>
</span><span id="__span-51-2"><a id="__codelineno-51-2" name="__codelineno-51-2"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddAgentNode</span><span class="p">(</span><span class="s">&quot;orchestrator&quot;</span><span class="p">,</span>
</span><span id="__span-51-3"><a id="__codelineno-51-3" name="__codelineno-51-3"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithSubgraphInputFromLastResponse</span><span class="p">(),</span>
</span><span id="__span-51-4"><a id="__codelineno-51-4" name="__codelineno-51-4"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithSubgraphIsolatedMessages</span><span class="p">(</span><span class="kc">true</span><span class="p">),</span><span class="w"> </span><span class="c1">// optional: isolate for true &quot;pass only results&quot;</span>
</span><span id="__span-51-5"><a id="__codelineno-51-5" name="__codelineno-51-5"></a><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>Notes: Both approaches ensure B only sees A’s result, and C only sees B’s. The option is more concise when available; the callback is zero‑dependency and works everywhere.</p>
<h3 id="hybrid-pattern-example">Hybrid Pattern Example</h3>
<p>Embed dynamic decision‑making within a structured flow:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-52-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-52-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-52-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-52-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-52-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-52-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-52-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-52-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-52-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-52-10">10</a></span>
<span class="normal"><a href="#__codelineno-52-11">11</a></span>
<span class="normal"><a href="#__codelineno-52-12">12</a></span>
<span class="normal"><a href="#__codelineno-52-13">13</a></span>
<span class="normal"><a href="#__codelineno-52-14">14</a></span>
<span class="normal"><a href="#__codelineno-52-15">15</a></span>
<span class="normal"><a href="#__codelineno-52-16">16</a></span>
<span class="normal"><a href="#__codelineno-52-17">17</a></span>
<span class="normal"><a href="#__codelineno-52-18">18</a></span>
<span class="normal"><a href="#__codelineno-52-19">19</a></span>
<span class="normal"><a href="#__codelineno-52-20">20</a></span>
<span class="normal"><a href="#__codelineno-52-21">21</a></span>
<span class="normal"><a href="#__codelineno-52-22">22</a></span>
<span class="normal"><a href="#__codelineno-52-23">23</a></span>
<span class="normal"><a href="#__codelineno-52-24">24</a></span>
<span class="normal"><a href="#__codelineno-52-25">25</a></span>
<span class="normal"><a href="#__codelineno-52-26">26</a></span>
<span class="normal"><a href="#__codelineno-52-27">27</a></span>
<span class="normal"><a href="#__codelineno-52-28">28</a></span>
<span class="normal"><a href="#__codelineno-52-29">29</a></span>
<span class="normal"><a href="#__codelineno-52-30">30</a></span>
<span class="normal"><a href="#__codelineno-52-31">31</a></span>
<span class="normal"><a href="#__codelineno-52-32">32</a></span>
<span class="normal"><a href="#__codelineno-52-33">33</a></span>
<span class="normal"><a href="#__codelineno-52-34">34</a></span>
<span class="normal"><a href="#__codelineno-52-35">35</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-52-1"><a id="__codelineno-52-1" name="__codelineno-52-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-52-2"><a id="__codelineno-52-2" name="__codelineno-52-2"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/agent&quot;</span>
</span><span id="__span-52-3"><a id="__codelineno-52-3" name="__codelineno-52-3"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/agent/chainagent&quot;</span>
</span><span id="__span-52-4"><a id="__codelineno-52-4" name="__codelineno-52-4"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/agent/graphagent&quot;</span>
</span><span id="__span-52-5"><a id="__codelineno-52-5" name="__codelineno-52-5"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-52-6"><a id="__codelineno-52-6" name="__codelineno-52-6"></a><span class="p">)</span>
</span><span id="__span-52-7"><a id="__codelineno-52-7" name="__codelineno-52-7"></a>
</span><span id="__span-52-8"><a id="__codelineno-52-8" name="__codelineno-52-8"></a><span class="nx">sg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateGraph</span><span class="p">(</span><span class="nx">schema</span><span class="p">)</span>
</span><span id="__span-52-9"><a id="__codelineno-52-9" name="__codelineno-52-9"></a>
</span><span id="__span-52-10"><a id="__codelineno-52-10" name="__codelineno-52-10"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-52-11"><a id="__codelineno-52-11" name="__codelineno-52-11"></a><span class="w">    </span><span class="nx">nodePrepare</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;prepare&quot;</span>
</span><span id="__span-52-12"><a id="__codelineno-52-12" name="__codelineno-52-12"></a><span class="w">    </span><span class="nx">nodeAnalyzer</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;analyzer&quot;</span>
</span><span id="__span-52-13"><a id="__codelineno-52-13" name="__codelineno-52-13"></a><span class="w">    </span><span class="nx">nodeFinalize</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;finalize&quot;</span>
</span><span id="__span-52-14"><a id="__codelineno-52-14" name="__codelineno-52-14"></a><span class="p">)</span>
</span><span id="__span-52-15"><a id="__codelineno-52-15" name="__codelineno-52-15"></a>
</span><span id="__span-52-16"><a id="__codelineno-52-16" name="__codelineno-52-16"></a><span class="c1">// Structured data preparation</span>
</span><span id="__span-52-17"><a id="__codelineno-52-17" name="__codelineno-52-17"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="nx">nodePrepare</span><span class="p">,</span><span class="w"> </span><span class="nx">prepareData</span><span class="p">)</span>
</span><span id="__span-52-18"><a id="__codelineno-52-18" name="__codelineno-52-18"></a>
</span><span id="__span-52-19"><a id="__codelineno-52-19" name="__codelineno-52-19"></a><span class="c1">// Dynamic decision point — use a ChainAgent</span>
</span><span id="__span-52-20"><a id="__codelineno-52-20" name="__codelineno-52-20"></a><span class="nx">dynamicAgent</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">chainagent</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="nx">nodeAnalyzer</span><span class="p">,</span>
</span><span id="__span-52-21"><a id="__codelineno-52-21" name="__codelineno-52-21"></a><span class="w">    </span><span class="nx">chainagent</span><span class="p">.</span><span class="nx">WithSubAgents</span><span class="p">([]</span><span class="nx">agent</span><span class="p">.</span><span class="nx">Agent</span><span class="p">{</span><span class="o">...</span><span class="p">}))</span>
</span><span id="__span-52-22"><a id="__codelineno-52-22" name="__codelineno-52-22"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddAgentNode</span><span class="p">(</span><span class="nx">nodeAnalyzer</span><span class="p">)</span>
</span><span id="__span-52-23"><a id="__codelineno-52-23" name="__codelineno-52-23"></a>
</span><span id="__span-52-24"><a id="__codelineno-52-24" name="__codelineno-52-24"></a><span class="c1">// Continue the structured flow</span>
</span><span id="__span-52-25"><a id="__codelineno-52-25" name="__codelineno-52-25"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="nx">nodeFinalize</span><span class="p">,</span><span class="w"> </span><span class="nx">finalizeResults</span><span class="p">)</span>
</span><span id="__span-52-26"><a id="__codelineno-52-26" name="__codelineno-52-26"></a>
</span><span id="__span-52-27"><a id="__codelineno-52-27" name="__codelineno-52-27"></a><span class="c1">// Wire the flow</span>
</span><span id="__span-52-28"><a id="__codelineno-52-28" name="__codelineno-52-28"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">SetEntryPoint</span><span class="p">(</span><span class="nx">nodePrepare</span><span class="p">)</span>
</span><span id="__span-52-29"><a id="__codelineno-52-29" name="__codelineno-52-29"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddEdge</span><span class="p">(</span><span class="nx">nodePrepare</span><span class="p">,</span><span class="w"> </span><span class="nx">nodeAnalyzer</span><span class="p">)</span><span class="w">   </span><span class="c1">// hand over to dynamic agent</span>
</span><span id="__span-52-30"><a id="__codelineno-52-30" name="__codelineno-52-30"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddEdge</span><span class="p">(</span><span class="nx">nodeAnalyzer</span><span class="p">,</span><span class="w"> </span><span class="nx">nodeFinalize</span><span class="p">)</span><span class="w">  </span><span class="c1">// return to structured flow</span>
</span><span id="__span-52-31"><a id="__codelineno-52-31" name="__codelineno-52-31"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">SetFinishPoint</span><span class="p">(</span><span class="nx">nodeFinalize</span><span class="p">)</span>
</span><span id="__span-52-32"><a id="__codelineno-52-32" name="__codelineno-52-32"></a>
</span><span id="__span-52-33"><a id="__codelineno-52-33" name="__codelineno-52-33"></a><span class="c1">// Inject on creation</span>
</span><span id="__span-52-34"><a id="__codelineno-52-34" name="__codelineno-52-34"></a><span class="nx">graphAgent</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;hybrid&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">g</span><span class="p">,</span>
</span><span id="__span-52-35"><a id="__codelineno-52-35" name="__codelineno-52-35"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithSubAgents</span><span class="p">([]</span><span class="nx">agent</span><span class="p">.</span><span class="nx">Agent</span><span class="p">{</span><span class="nx">dynamicAgent</span><span class="p">}))</span>
</span></code></pre></div></td></tr></table></div>
<h2 id="core-mechanics-in-depth">Core Mechanics in Depth</h2>
<h3 id="state-management-schema-reducer">State Management: Schema + Reducer</h3>
<p>State is a central challenge in graph workflows. We designed a Schema + Reducer mechanism that provides type safety and supports high‑concurrency atomic updates.</p>
<pre class="mermaid"><code>flowchart LR
    subgraph "State Schema"
        MS[messages: MessageList]:::schemaClass
        UI[user_input: string]:::schemaClass
        LR[last_response: string]:::schemaClass
        NR[node_responses: Map]:::schemaClass
    end

    subgraph "Reducers"
        R1[MessageReducer + MessageOp]:::reducerClass
        R2[MergeReducer (Map)]:::reducerClass
        R3[ReplaceReducer (String)]:::reducerClass
    end

    subgraph "Node Outputs"
        N1[Node 1 Output]:::nodeOutputClass
        N2[Node 2 Output]:::nodeOutputClass
        N3[Node 3 Output]:::nodeOutputClass
    end

    N1 --&gt; R1
    N2 --&gt; R2
    N3 --&gt; R3
    R1 --&gt; MS
    R2 --&gt; NR
    R3 --&gt; LR

    classDef schemaClass fill:#e3f2fd,stroke:#1565c0,stroke-width:2px
    classDef reducerClass fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    classDef nodeOutputClass fill:#fff8e1,stroke:#f57f17,stroke-width:2px</code></pre>
<p>Graph state is a <code>map[string]any</code> with runtime validation provided by <code>StateSchema</code>. The reducer mechanism ensures safe merging and avoids conflicts under concurrent updates.</p>
<h4 id="common-state-keys">Common State Keys</h4>
<ul>
<li>User‑visible: <code>graph.StateKeyUserInput</code>, <code>graph.StateKeyOneShotMessages</code>, <code>graph.StateKeyMessages</code>, <code>graph.StateKeyLastResponse</code>, <code>graph.StateKeyNodeResponses</code>, <code>graph.StateKeyMetadata</code></li>
<li>Internal: <code>session</code>, <code>exec_context</code>, <code>tool_callbacks</code>, <code>model_callbacks</code>, <code>agent_callbacks</code>, <code>current_node_id</code>, <code>parent_agent</code></li>
<li>Command/Resume: <code>__command__</code>, <code>__resume_map__</code></li>
</ul>
<p>Constants live in <code>graph/state.go</code> and <code>graph/keys.go</code>. Prefer referencing constants over hard‑coding strings.</p>
<h4 id="nodelevel-callbacks-generation-parameters">Node‑level Callbacks &amp; Generation Parameters</h4>
<p>Per‑node options (see <code>graph/state_graph.go</code>):
- <code>graph.WithPreNodeCallback</code> / <code>graph.WithPostNodeCallback</code> / <code>graph.WithNodeErrorCallback</code>
- LLM nodes: <code>graph.WithGenerationConfig</code>, <code>graph.WithModelCallbacks</code>
- Tool nodes: <code>graph.WithToolCallbacks</code>
- Agent nodes: <code>graph.WithAgentNodeEventCallback</code></p>
<p>Additionally, <code>graph.WithName</code>/<code>graph.WithDescription</code> add friendly labels; <code>graph.WithDestinations</code> declares potential dynamic destinations (for static checks/visualization only).</p>
<h3 id="llm-input-rules-threestage-design">LLM Input Rules: Three‑Stage Design</h3>
<p>The LLM input pipeline looks simple but solves common context‑management problems in AI apps.</p>
<p>Built‑in selection logic (no extra config):</p>
<ol>
<li>Prefer <code>graph.StateKeyOneShotMessages</code>: fully override inputs (system/user) for this turn; cleared after execution.</li>
<li>Else use <code>graph.StateKeyUserInput</code>: append this turn’s user to <code>graph.StateKeyMessages</code>, then atomically write back user+assistant; finally clear <code>graph.StateKeyUserInput</code>.</li>
<li>Else use <code>graph.StateKeyMessages</code> only: common on tool loops re‑entering LLM (since <code>graph.StateKeyUserInput</code> has been cleared).</li>
</ol>
<p>The benefit: preprocess nodes can rewrite <code>graph.StateKeyUserInput</code> and take effect in the same turn, while seamlessly integrating with the tool loop (tool_calls → tools → LLM).</p>
<p>Examples (showing the three paths):</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-53-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-53-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-53-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-53-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-53-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-53-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-53-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-53-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-53-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-53-10">10</a></span>
<span class="normal"><a href="#__codelineno-53-11">11</a></span>
<span class="normal"><a href="#__codelineno-53-12">12</a></span>
<span class="normal"><a href="#__codelineno-53-13">13</a></span>
<span class="normal"><a href="#__codelineno-53-14">14</a></span>
<span class="normal"><a href="#__codelineno-53-15">15</a></span>
<span class="normal"><a href="#__codelineno-53-16">16</a></span>
<span class="normal"><a href="#__codelineno-53-17">17</a></span>
<span class="normal"><a href="#__codelineno-53-18">18</a></span>
<span class="normal"><a href="#__codelineno-53-19">19</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-53-1"><a id="__codelineno-53-1" name="__codelineno-53-1"></a><span class="c1">// OneShot (graph.StateKeyOneShotMessages): completely override this turn’s inputs (system/user)</span>
</span><span id="__span-53-2"><a id="__codelineno-53-2" name="__codelineno-53-2"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-53-3"><a id="__codelineno-53-3" name="__codelineno-53-3"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-53-4"><a id="__codelineno-53-4" name="__codelineno-53-4"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/model&quot;</span>
</span><span id="__span-53-5"><a id="__codelineno-53-5" name="__codelineno-53-5"></a><span class="p">)</span>
</span><span id="__span-53-6"><a id="__codelineno-53-6" name="__codelineno-53-6"></a>
</span><span id="__span-53-7"><a id="__codelineno-53-7" name="__codelineno-53-7"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-53-8"><a id="__codelineno-53-8" name="__codelineno-53-8"></a><span class="w">    </span><span class="nx">systemPrompt</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;You are a careful and reliable assistant&quot;</span>
</span><span id="__span-53-9"><a id="__codelineno-53-9" name="__codelineno-53-9"></a><span class="w">    </span><span class="nx">userPrompt</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;Summarize this text in bullet points&quot;</span>
</span><span id="__span-53-10"><a id="__codelineno-53-10" name="__codelineno-53-10"></a><span class="p">)</span>
</span><span id="__span-53-11"><a id="__codelineno-53-11" name="__codelineno-53-11"></a>
</span><span id="__span-53-12"><a id="__codelineno-53-12" name="__codelineno-53-12"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;prepare_prompt&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-53-13"><a id="__codelineno-53-13" name="__codelineno-53-13"></a><span class="w">    </span><span class="nx">oneShot</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">[]</span><span class="nx">model</span><span class="p">.</span><span class="nx">Message</span><span class="p">{</span>
</span><span id="__span-53-14"><a id="__codelineno-53-14" name="__codelineno-53-14"></a><span class="w">        </span><span class="nx">model</span><span class="p">.</span><span class="nx">NewSystemMessage</span><span class="p">(</span><span class="nx">systemPrompt</span><span class="p">),</span>
</span><span id="__span-53-15"><a id="__codelineno-53-15" name="__codelineno-53-15"></a><span class="w">        </span><span class="nx">model</span><span class="p">.</span><span class="nx">NewUserMessage</span><span class="p">(</span><span class="nx">userPrompt</span><span class="p">),</span>
</span><span id="__span-53-16"><a id="__codelineno-53-16" name="__codelineno-53-16"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-53-17"><a id="__codelineno-53-17" name="__codelineno-53-17"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyOneShotMessages</span><span class="p">:</span><span class="w"> </span><span class="nx">oneShot</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-53-18"><a id="__codelineno-53-18" name="__codelineno-53-18"></a><span class="p">})</span>
</span><span id="__span-53-19"><a id="__codelineno-53-19" name="__codelineno-53-19"></a><span class="c1">// The following LLM node will use graph.StateKeyOneShotMessages only and clear it afterwards</span>
</span></code></pre></div></td></tr></table></div>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-54-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-54-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-54-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-54-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-54-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-54-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-54-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-54-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-54-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-54-10">10</a></span>
<span class="normal"><a href="#__codelineno-54-11">11</a></span>
<span class="normal"><a href="#__codelineno-54-12">12</a></span>
<span class="normal"><a href="#__codelineno-54-13">13</a></span>
<span class="normal"><a href="#__codelineno-54-14">14</a></span>
<span class="normal"><a href="#__codelineno-54-15">15</a></span>
<span class="normal"><a href="#__codelineno-54-16">16</a></span>
<span class="normal"><a href="#__codelineno-54-17">17</a></span>
<span class="normal"><a href="#__codelineno-54-18">18</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-54-1"><a id="__codelineno-54-1" name="__codelineno-54-1"></a><span class="c1">// UserInput (graph.StateKeyUserInput): append this turn’s user input on top of history graph.StateKeyMessages</span>
</span><span id="__span-54-2"><a id="__codelineno-54-2" name="__codelineno-54-2"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-54-3"><a id="__codelineno-54-3" name="__codelineno-54-3"></a><span class="w">    </span><span class="s">&quot;strings&quot;</span>
</span><span id="__span-54-4"><a id="__codelineno-54-4" name="__codelineno-54-4"></a>
</span><span id="__span-54-5"><a id="__codelineno-54-5" name="__codelineno-54-5"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-54-6"><a id="__codelineno-54-6" name="__codelineno-54-6"></a><span class="p">)</span>
</span><span id="__span-54-7"><a id="__codelineno-54-7" name="__codelineno-54-7"></a>
</span><span id="__span-54-8"><a id="__codelineno-54-8" name="__codelineno-54-8"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-54-9"><a id="__codelineno-54-9" name="__codelineno-54-9"></a><span class="w">    </span><span class="nx">stateKeyCleanedInput</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;cleaned_input&quot;</span>
</span><span id="__span-54-10"><a id="__codelineno-54-10" name="__codelineno-54-10"></a><span class="p">)</span>
</span><span id="__span-54-11"><a id="__codelineno-54-11" name="__codelineno-54-11"></a>
</span><span id="__span-54-12"><a id="__codelineno-54-12" name="__codelineno-54-12"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;clean_input&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-54-13"><a id="__codelineno-54-13" name="__codelineno-54-13"></a><span class="w">    </span><span class="nx">in</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">strings</span><span class="p">.</span><span class="nx">TrimSpace</span><span class="p">(</span><span class="nx">s</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyUserInput</span><span class="p">].(</span><span class="kt">string</span><span class="p">))</span>
</span><span id="__span-54-14"><a id="__codelineno-54-14" name="__codelineno-54-14"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span>
</span><span id="__span-54-15"><a id="__codelineno-54-15" name="__codelineno-54-15"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyUserInput</span><span class="p">:</span><span class="w"> </span><span class="nx">in</span><span class="p">,</span><span class="w">                </span><span class="c1">// LLM node atomically writes user+assistant to messages</span>
</span><span id="__span-54-16"><a id="__codelineno-54-16" name="__codelineno-54-16"></a><span class="w">        </span><span class="nx">stateKeyCleanedInput</span><span class="p">:</span><span class="w">    </span><span class="nx">in</span><span class="p">,</span><span class="w">                </span><span class="c1">// keep a business‑specific key as well</span>
</span><span id="__span-54-17"><a id="__codelineno-54-17" name="__codelineno-54-17"></a><span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-54-18"><a id="__codelineno-54-18" name="__codelineno-54-18"></a><span class="p">})</span>
</span></code></pre></div></td></tr></table></div>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-55-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-55-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-55-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-55-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-55-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-55-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-55-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-55-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-55-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-55-10">10</a></span>
<span class="normal"><a href="#__codelineno-55-11">11</a></span>
<span class="normal"><a href="#__codelineno-55-12">12</a></span>
<span class="normal"><a href="#__codelineno-55-13">13</a></span>
<span class="normal"><a href="#__codelineno-55-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-55-1"><a id="__codelineno-55-1" name="__codelineno-55-1"></a><span class="c1">// Messages‑only (graph.StateKeyMessages): after tool loop returns, graph.StateKeyUserInput is cleared; LLM continues based on graph.StateKeyMessages (incl. tool responses)</span>
</span><span id="__span-55-2"><a id="__codelineno-55-2" name="__codelineno-55-2"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-55-3"><a id="__codelineno-55-3" name="__codelineno-55-3"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-55-4"><a id="__codelineno-55-4" name="__codelineno-55-4"></a><span class="p">)</span>
</span><span id="__span-55-5"><a id="__codelineno-55-5" name="__codelineno-55-5"></a>
</span><span id="__span-55-6"><a id="__codelineno-55-6" name="__codelineno-55-6"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-55-7"><a id="__codelineno-55-7" name="__codelineno-55-7"></a><span class="w">    </span><span class="nx">nodeAsk</span><span class="w">       </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;ask&quot;</span>
</span><span id="__span-55-8"><a id="__codelineno-55-8" name="__codelineno-55-8"></a><span class="w">    </span><span class="nx">nodeExecTools</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;exec_tools&quot;</span>
</span><span id="__span-55-9"><a id="__codelineno-55-9" name="__codelineno-55-9"></a><span class="w">    </span><span class="nx">nodeFallback</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;fallback&quot;</span>
</span><span id="__span-55-10"><a id="__codelineno-55-10" name="__codelineno-55-10"></a><span class="p">)</span>
</span><span id="__span-55-11"><a id="__codelineno-55-11" name="__codelineno-55-11"></a>
</span><span id="__span-55-12"><a id="__codelineno-55-12" name="__codelineno-55-12"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddToolsNode</span><span class="p">(</span><span class="nx">nodeExecTools</span><span class="p">,</span><span class="w"> </span><span class="nx">tools</span><span class="p">)</span>
</span><span id="__span-55-13"><a id="__codelineno-55-13" name="__codelineno-55-13"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddToolsConditionalEdges</span><span class="p">(</span><span class="nx">nodeAsk</span><span class="p">,</span><span class="w"> </span><span class="nx">nodeExecTools</span><span class="p">,</span><span class="w"> </span><span class="nx">nodeFallback</span><span class="p">)</span>
</span><span id="__span-55-14"><a id="__codelineno-55-14" name="__codelineno-55-14"></a><span class="c1">// On returning to nodeAsk (or a downstream LLM) graph.StateKeyUserInput is empty, so it follows the messages‑only path</span>
</span></code></pre></div></td></tr></table></div>
<h4 id="instruction-placeholder-injection">Instruction Placeholder Injection</h4>
<p><code>AddLLMNode</code>’s <code>instruction</code> supports placeholders, same syntax as <code>llmagent</code>:
- <code>{key}</code> / <code>{key?}</code>: read from <code>session.State</code>; optional <code>?</code> yields empty when missing.
- <code>{user:subkey}</code>, <code>{app:subkey}</code>, <code>{temp:subkey}</code>: read by namespace.</p>
<p>GraphAgent stores the current <code>*session.Session</code> into state (<code>graph.StateKeySession</code>) and expands placeholders before the LLM call.</p>
<p>Tip: GraphAgent seeds <code>graph.StateKeyMessages</code> from prior session events for multi‑turn continuity. When resuming from a checkpoint, a plain "resume" message is not injected as <code>graph.StateKeyUserInput</code>, preserving the recovered state.</p>
<h3 id="concurrency-and-state-safety">Concurrency and State Safety</h3>
<p>When a node has multiple outgoing edges, parallel execution is triggered automatically:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-56-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-56-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-56-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-56-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-56-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-56-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-56-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-56-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-56-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-56-10">10</a></span>
<span class="normal"><a href="#__codelineno-56-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-56-1"><a id="__codelineno-56-1" name="__codelineno-56-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-56-2"><a id="__codelineno-56-2" name="__codelineno-56-2"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-56-3"><a id="__codelineno-56-3" name="__codelineno-56-3"></a><span class="p">)</span>
</span><span id="__span-56-4"><a id="__codelineno-56-4" name="__codelineno-56-4"></a>
</span><span id="__span-56-5"><a id="__codelineno-56-5" name="__codelineno-56-5"></a><span class="c1">// This graph structure executes in parallel automatically</span>
</span><span id="__span-56-6"><a id="__codelineno-56-6" name="__codelineno-56-6"></a><span class="nx">stateGraph</span><span class="p">.</span>
</span><span id="__span-56-7"><a id="__codelineno-56-7" name="__codelineno-56-7"></a><span class="w">    </span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;analyze&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">analyzeData</span><span class="p">).</span>
</span><span id="__span-56-8"><a id="__codelineno-56-8" name="__codelineno-56-8"></a><span class="w">    </span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;generate_report&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">generateReport</span><span class="p">).</span><span class="w"> </span>
</span><span id="__span-56-9"><a id="__codelineno-56-9" name="__codelineno-56-9"></a><span class="w">    </span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;call_external_api&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">callAPI</span><span class="p">).</span>
</span><span id="__span-56-10"><a id="__codelineno-56-10" name="__codelineno-56-10"></a><span class="w">    </span><span class="nx">AddEdge</span><span class="p">(</span><span class="s">&quot;analyze&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;generate_report&quot;</span><span class="p">).</span><span class="w">    </span><span class="c1">// these two run in parallel</span>
</span><span id="__span-56-11"><a id="__codelineno-56-11" name="__codelineno-56-11"></a><span class="w">    </span><span class="nx">AddEdge</span><span class="p">(</span><span class="s">&quot;analyze&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;call_external_api&quot;</span><span class="p">)</span><span class="w">   </span><span class="c1">// </span>
</span></code></pre></div></td></tr></table></div>
<p>Internally, the executor constructs shallow copies (maps.Copy) per task and merges under a lock, with reducers ensuring safe concurrent updates.</p>
<h3 id="node-io-conventions_1">Node I/O Conventions</h3>
<p>Nodes communicate only via the shared <code>State</code>. Each node returns a state delta that merges via the Schema’s reducers.</p>
<ul>
<li>Function nodes<ul>
<li>Input: full <code>State</code> (read keys declared in your schema)</li>
<li>Output: write business keys only (e.g., <code>{"parsed_time":"..."}</code>); avoid internal keys</li>
</ul>
</li>
</ul>
<ul>
<li>LLM nodes<ul>
<li>Input priority: <code>graph.StateKeyOneShotMessages</code> → <code>graph.StateKeyUserInput</code> → <code>graph.StateKeyMessages</code></li>
<li>Output: append to <code>graph.StateKeyMessages</code> atomically, set <code>graph.StateKeyLastResponse</code>, set <code>graph.StateKeyNodeResponses[&lt;llm_node_id&gt;]</code></li>
</ul>
</li>
</ul>
<ul>
<li>Tools nodes<ul>
<li>Read the latest assistant message with <code>tool_calls</code> for the current round and append tool responses to <code>graph.StateKeyMessages</code></li>
<li>Multiple tools execute in the order returned by the LLM</li>
</ul>
</li>
</ul>
<ul>
<li>Agent nodes<ul>
<li>Receive graph <code>State</code> via <code>Invocation.RunOptions.RuntimeState</code></li>
<li>Output: set <code>graph.StateKeyLastResponse</code> and <code>graph.StateKeyNodeResponses[&lt;agent_node_id&gt;]</code>; <code>graph.StateKeyUserInput</code> is cleared after execution</li>
</ul>
</li>
</ul>
<p>Good practice:
- Sequential reads: consume the immediate upstream text from <code>graph.StateKeyLastResponse</code>.
- Parallel/merge reads: read specific node outputs from <code>graph.StateKeyNodeResponses[&lt;nodeID&gt;]</code>.
- Declare business keys in your schema with suitable reducers to avoid data races.</p>
<h3 id="api-cheat-sheet">API Cheat Sheet</h3>
<ul>
<li>Build graph<ul>
<li><code>graph.NewStateGraph(schema)</code> → builder</li>
<li><code>AddNode(id, func, ...opts)</code> / <code>AddLLMNode(id, model, instruction, tools, ...opts)</code></li>
<li><code>AddToolsNode(id, tools, ...opts)</code> / <code>AddAgentNode(id, ...opts)</code></li>
<li><code>AddEdge(from, to)</code> / <code>AddConditionalEdges(from, condition, pathMap)</code></li>
<li><code>AddToolsConditionalEdges(llmNode, toolsNode, fallback)</code></li>
<li><code>SetEntryPoint(nodeID)</code> / <code>SetFinishPoint(nodeID)</code> / <code>Compile()</code></li>
</ul>
</li>
</ul>
<ul>
<li>State keys (user‑visible)<ul>
<li><code>graph.StateKeyUserInput</code>, <code>graph.StateKeyOneShotMessages</code>, <code>graph.StateKeyMessages</code>, <code>graph.StateKeyLastResponse</code>, <code>graph.StateKeyNodeResponses</code>, <code>graph.StateKeyMetadata</code></li>
</ul>
</li>
</ul>
<ul>
<li>Per‑node options<ul>
<li><code>graph.WithGenerationConfig</code>, <code>graph.WithModelCallbacks</code>, <code>graph.WithToolCallbacks</code></li>
<li><code>graph.WithPreNodeCallback</code>, <code>graph.WithPostNodeCallback</code>, <code>graph.WithNodeErrorCallback</code></li>
</ul>
</li>
</ul>
<ul>
<li>Execution<ul>
<li><code>graphagent.New(name, compiledGraph, ...opts)</code> → <code>runner.NewRunner(app, agent)</code> → <code>Run(...)</code></li>
</ul>
</li>
</ul>
<p>See examples under <code>examples/graph</code> for end‑to‑end patterns (basic/parallel/multi‑turn/interrupts/tools/placeholder).</p>
<h2 id="visualization-dotimage">Visualization (DOT/Image)</h2>
<p>Graph can export a Graphviz DOT (Directed Graph Language) description and render images via the <code>dot</code> (Graph Visualization layout engine) executable.</p>
<ul>
<li><code>WithDestinations</code> draws dotted gray edges for declared dynamic routes (visualization + static checks only; it does not affect runtime).</li>
<li>Conditional edges render as dashed gray edges with branch labels.</li>
<li>Regular edges render as solid lines.</li>
<li>Virtual <code>Start</code>/<code>End</code> nodes can be shown or hidden via an option.</li>
</ul>
<p>Example:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-57-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-57-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-57-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-57-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-57-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-57-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-57-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-57-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-57-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-57-10">10</a></span>
<span class="normal"><a href="#__codelineno-57-11">11</a></span>
<span class="normal"><a href="#__codelineno-57-12">12</a></span>
<span class="normal"><a href="#__codelineno-57-13">13</a></span>
<span class="normal"><a href="#__codelineno-57-14">14</a></span>
<span class="normal"><a href="#__codelineno-57-15">15</a></span>
<span class="normal"><a href="#__codelineno-57-16">16</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-57-1"><a id="__codelineno-57-1" name="__codelineno-57-1"></a><span class="nx">g</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">sg</span><span class="p">.</span><span class="nx">MustCompile</span><span class="p">()</span>
</span><span id="__span-57-2"><a id="__codelineno-57-2" name="__codelineno-57-2"></a>
</span><span id="__span-57-3"><a id="__codelineno-57-3" name="__codelineno-57-3"></a><span class="c1">// Build DOT text</span>
</span><span id="__span-57-4"><a id="__codelineno-57-4" name="__codelineno-57-4"></a><span class="nx">dot</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">DOT</span><span class="p">(</span>
</span><span id="__span-57-5"><a id="__codelineno-57-5" name="__codelineno-57-5"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithRankDir</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">RankDirLR</span><span class="p">),</span><span class="w">  </span><span class="c1">// left→right (or graph.RankDirTB)</span>
</span><span id="__span-57-6"><a id="__codelineno-57-6" name="__codelineno-57-6"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithIncludeDestinations</span><span class="p">(</span><span class="kc">true</span><span class="p">),</span><span class="w"> </span><span class="c1">// show declared WithDestinations</span>
</span><span id="__span-57-7"><a id="__codelineno-57-7" name="__codelineno-57-7"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithGraphLabel</span><span class="p">(</span><span class="s">&quot;My Workflow&quot;</span><span class="p">),</span>
</span><span id="__span-57-8"><a id="__codelineno-57-8" name="__codelineno-57-8"></a><span class="p">)</span>
</span><span id="__span-57-9"><a id="__codelineno-57-9" name="__codelineno-57-9"></a>
</span><span id="__span-57-10"><a id="__codelineno-57-10" name="__codelineno-57-10"></a><span class="c1">// Render PNG (requires Graphviz&#39;s dot)</span>
</span><span id="__span-57-11"><a id="__codelineno-57-11" name="__codelineno-57-11"></a><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">RenderImage</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Background</span><span class="p">(),</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">ImageFormatPNG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;workflow.png&quot;</span><span class="p">,</span>
</span><span id="__span-57-12"><a id="__codelineno-57-12" name="__codelineno-57-12"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithRankDir</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">RankDirLR</span><span class="p">),</span>
</span><span id="__span-57-13"><a id="__codelineno-57-13" name="__codelineno-57-13"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithIncludeDestinations</span><span class="p">(</span><span class="kc">true</span><span class="p">),</span>
</span><span id="__span-57-14"><a id="__codelineno-57-14" name="__codelineno-57-14"></a><span class="p">);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-57-15"><a id="__codelineno-57-15" name="__codelineno-57-15"></a><span class="w">    </span><span class="c1">// If Graphviz is not installed, this returns an error — ignore or instruct the user to install dot</span>
</span><span id="__span-57-16"><a id="__codelineno-57-16" name="__codelineno-57-16"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>API reference:</p>
<ul>
<li><code>g.DOT(...)</code> / <code>g.WriteDOT(w, ...)</code> on a compiled <code>*graph.Graph</code></li>
<li><code>g.RenderImage(ctx, format, outputPath, ...)</code> (e.g., <code>png</code>/<code>svg</code>)</li>
<li>Options: <code>WithRankDir(graph.RankDirLR|graph.RankDirTB)</code>, <code>WithIncludeDestinations(bool)</code>, <code>WithIncludeStartEnd(bool)</code>, <code>WithGraphLabel(string)</code></li>
</ul>
<p>Full example: <code>examples/graph/visualization</code></p>
<h2 id="advanced-features_1">Advanced Features</h2>
<h3 id="checkpoints-and-recovery">Checkpoints and Recovery</h3>
<p>To support time‑travel and reliable recovery, configure a checkpoint saver on the Executor or GraphAgent. Below uses the SQLite saver to persist checkpoints and resume from a specific checkpoint.</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-58-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-58-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-58-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-58-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-58-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-58-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-58-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-58-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-58-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-58-10">10</a></span>
<span class="normal"><a href="#__codelineno-58-11">11</a></span>
<span class="normal"><a href="#__codelineno-58-12">12</a></span>
<span class="normal"><a href="#__codelineno-58-13">13</a></span>
<span class="normal"><a href="#__codelineno-58-14">14</a></span>
<span class="normal"><a href="#__codelineno-58-15">15</a></span>
<span class="normal"><a href="#__codelineno-58-16">16</a></span>
<span class="normal"><a href="#__codelineno-58-17">17</a></span>
<span class="normal"><a href="#__codelineno-58-18">18</a></span>
<span class="normal"><a href="#__codelineno-58-19">19</a></span>
<span class="normal"><a href="#__codelineno-58-20">20</a></span>
<span class="normal"><a href="#__codelineno-58-21">21</a></span>
<span class="normal"><a href="#__codelineno-58-22">22</a></span>
<span class="normal"><a href="#__codelineno-58-23">23</a></span>
<span class="normal"><a href="#__codelineno-58-24">24</a></span>
<span class="normal"><a href="#__codelineno-58-25">25</a></span>
<span class="normal"><a href="#__codelineno-58-26">26</a></span>
<span class="normal"><a href="#__codelineno-58-27">27</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-58-1"><a id="__codelineno-58-1" name="__codelineno-58-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-58-2"><a id="__codelineno-58-2" name="__codelineno-58-2"></a><span class="w">    </span><span class="s">&quot;database/sql&quot;</span>
</span><span id="__span-58-3"><a id="__codelineno-58-3" name="__codelineno-58-3"></a>
</span><span id="__span-58-4"><a id="__codelineno-58-4" name="__codelineno-58-4"></a><span class="w">    </span><span class="nx">_</span><span class="w"> </span><span class="s">&quot;github.com/mattn/go-sqlite3&quot;</span>
</span><span id="__span-58-5"><a id="__codelineno-58-5" name="__codelineno-58-5"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/agent&quot;</span>
</span><span id="__span-58-6"><a id="__codelineno-58-6" name="__codelineno-58-6"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/agent/graphagent&quot;</span>
</span><span id="__span-58-7"><a id="__codelineno-58-7" name="__codelineno-58-7"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-58-8"><a id="__codelineno-58-8" name="__codelineno-58-8"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph/checkpoint/sqlite&quot;</span>
</span><span id="__span-58-9"><a id="__codelineno-58-9" name="__codelineno-58-9"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/model&quot;</span>
</span><span id="__span-58-10"><a id="__codelineno-58-10" name="__codelineno-58-10"></a><span class="p">)</span>
</span><span id="__span-58-11"><a id="__codelineno-58-11" name="__codelineno-58-11"></a>
</span><span id="__span-58-12"><a id="__codelineno-58-12" name="__codelineno-58-12"></a><span class="c1">// Configure checkpoints</span>
</span><span id="__span-58-13"><a id="__codelineno-58-13" name="__codelineno-58-13"></a><span class="nx">db</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">sql</span><span class="p">.</span><span class="nx">Open</span><span class="p">(</span><span class="s">&quot;sqlite3&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;./checkpoints.db&quot;</span><span class="p">)</span>
</span><span id="__span-58-14"><a id="__codelineno-58-14" name="__codelineno-58-14"></a><span class="nx">saver</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">sqlite</span><span class="p">.</span><span class="nx">NewSaver</span><span class="p">(</span><span class="nx">db</span><span class="p">)</span>
</span><span id="__span-58-15"><a id="__codelineno-58-15" name="__codelineno-58-15"></a>
</span><span id="__span-58-16"><a id="__codelineno-58-16" name="__codelineno-58-16"></a><span class="nx">graphAgent</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;workflow&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">g</span><span class="p">,</span>
</span><span id="__span-58-17"><a id="__codelineno-58-17" name="__codelineno-58-17"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithCheckpointSaver</span><span class="p">(</span><span class="nx">saver</span><span class="p">))</span>
</span><span id="__span-58-18"><a id="__codelineno-58-18" name="__codelineno-58-18"></a>
</span><span id="__span-58-19"><a id="__codelineno-58-19" name="__codelineno-58-19"></a><span class="c1">// Checkpoints are saved automatically during execution (by default every step)</span>
</span><span id="__span-58-20"><a id="__codelineno-58-20" name="__codelineno-58-20"></a>
</span><span id="__span-58-21"><a id="__codelineno-58-21" name="__codelineno-58-21"></a><span class="c1">// Resume from a checkpoint</span>
</span><span id="__span-58-22"><a id="__codelineno-58-22" name="__codelineno-58-22"></a><span class="nx">eventCh</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">userID</span><span class="p">,</span><span class="w"> </span><span class="nx">sessionID</span><span class="p">,</span>
</span><span id="__span-58-23"><a id="__codelineno-58-23" name="__codelineno-58-23"></a><span class="w">    </span><span class="nx">model</span><span class="p">.</span><span class="nx">NewUserMessage</span><span class="p">(</span><span class="s">&quot;resume&quot;</span><span class="p">),</span>
</span><span id="__span-58-24"><a id="__codelineno-58-24" name="__codelineno-58-24"></a><span class="w">    </span><span class="nx">agent</span><span class="p">.</span><span class="nx">WithRuntimeState</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">any</span><span class="p">{</span>
</span><span id="__span-58-25"><a id="__codelineno-58-25" name="__codelineno-58-25"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">CfgKeyCheckpointID</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ckpt-123&quot;</span><span class="p">,</span>
</span><span id="__span-58-26"><a id="__codelineno-58-26" name="__codelineno-58-26"></a><span class="w">    </span><span class="p">}),</span>
</span><span id="__span-58-27"><a id="__codelineno-58-27" name="__codelineno-58-27"></a><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<h4 id="checkpoint-management">Checkpoint Management</h4>
<p>Use the manager to list, query, and delete checkpoints:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-59-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-59-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-59-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-59-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-59-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-59-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-59-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-59-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-59-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-59-10">10</a></span>
<span class="normal"><a href="#__codelineno-59-11">11</a></span>
<span class="normal"><a href="#__codelineno-59-12">12</a></span>
<span class="normal"><a href="#__codelineno-59-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-59-1"><a id="__codelineno-59-1" name="__codelineno-59-1"></a><span class="nx">cm</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewCheckpointManager</span><span class="p">(</span><span class="nx">saver</span><span class="p">)</span>
</span><span id="__span-59-2"><a id="__codelineno-59-2" name="__codelineno-59-2"></a>
</span><span id="__span-59-3"><a id="__codelineno-59-3" name="__codelineno-59-3"></a><span class="c1">// Latest checkpoint (filter by namespace; empty string means cross‑namespace)</span>
</span><span id="__span-59-4"><a id="__codelineno-59-4" name="__codelineno-59-4"></a><span class="nx">latest</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">cm</span><span class="p">.</span><span class="nx">Latest</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">lineageID</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">)</span>
</span><span id="__span-59-5"><a id="__codelineno-59-5" name="__codelineno-59-5"></a>
</span><span id="__span-59-6"><a id="__codelineno-59-6" name="__codelineno-59-6"></a><span class="c1">// List (time‑desc)</span>
</span><span id="__span-59-7"><a id="__codelineno-59-7" name="__codelineno-59-7"></a><span class="nx">tuples</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">cm</span><span class="p">.</span><span class="nx">ListCheckpoints</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewCheckpointConfig</span><span class="p">(</span><span class="nx">lineageID</span><span class="p">).</span><span class="nx">ToMap</span><span class="p">(),</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">graph</span><span class="p">.</span><span class="nx">CheckpointFilter</span><span class="p">{</span><span class="nx">Limit</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="p">})</span>
</span><span id="__span-59-8"><a id="__codelineno-59-8" name="__codelineno-59-8"></a>
</span><span id="__span-59-9"><a id="__codelineno-59-9" name="__codelineno-59-9"></a><span class="c1">// Get a specific checkpoint tuple (includes pending writes)</span>
</span><span id="__span-59-10"><a id="__codelineno-59-10" name="__codelineno-59-10"></a><span class="nx">tuple</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">cm</span><span class="p">.</span><span class="nx">GetTuple</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">CreateCheckpointConfig</span><span class="p">(</span><span class="nx">lineageID</span><span class="p">,</span><span class="w"> </span><span class="nx">checkpointID</span><span class="p">,</span><span class="w"> </span><span class="nx">namespace</span><span class="p">))</span>
</span><span id="__span-59-11"><a id="__codelineno-59-11" name="__codelineno-59-11"></a>
</span><span id="__span-59-12"><a id="__codelineno-59-12" name="__codelineno-59-12"></a><span class="c1">// Delete a lineage</span>
</span><span id="__span-59-13"><a id="__codelineno-59-13" name="__codelineno-59-13"></a><span class="nx">_</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">cm</span><span class="p">.</span><span class="nx">DeleteLineage</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">lineageID</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>Use a stable business identifier for <code>namespace</code> in production (e.g., <code>svc:prod:flowX</code>) for clear auditing.</p>
<h3 id="events-at-a-glance">Events at a Glance</h3>
<ul>
<li>Authors<ul>
<li>Node-level: node ID (fallback <code>graph.AuthorGraphNode</code>)</li>
<li>Pregel phases: <code>graph.AuthorGraphPregel</code></li>
<li>Executor/system: <code>graph.AuthorGraphExecutor</code></li>
<li>User input: <code>user</code> (no exported constant)</li>
</ul>
</li>
</ul>
<ul>
<li>Object types (subset)<ul>
<li>Node: <code>graph.ObjectTypeGraphNodeStart | graph.ObjectTypeGraphNodeComplete | graph.ObjectTypeGraphNodeError</code></li>
<li>Pregel: <code>graph.ObjectTypeGraphPregelPlanning | graph.ObjectTypeGraphPregelExecution | graph.ObjectTypeGraphPregelUpdate</code></li>
<li>Channel/state: <code>graph.ObjectTypeGraphChannelUpdate</code> / <code>graph.ObjectTypeGraphStateUpdate</code></li>
<li>Checkpoints: <code>graph.ObjectTypeGraphCheckpoint</code>, <code>graph.ObjectTypeGraphCheckpointCreated</code>, <code>graph.ObjectTypeGraphCheckpointCommitted</code>, <code>graph.ObjectTypeGraphCheckpointInterrupt</code></li>
</ul>
</li>
</ul>
<p>See “Event Monitoring” for a full streaming example and metadata parsing.</p>
<h3 id="humanintheloop">Human‑in‑the‑Loop</h3>
<p>Introduce human confirmation on critical paths. The example shows a basic interrupt → resume flow:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-60-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-60-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-60-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-60-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-60-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-60-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-60-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-60-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-60-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-60-10">10</a></span>
<span class="normal"><a href="#__codelineno-60-11">11</a></span>
<span class="normal"><a href="#__codelineno-60-12">12</a></span>
<span class="normal"><a href="#__codelineno-60-13">13</a></span>
<span class="normal"><a href="#__codelineno-60-14">14</a></span>
<span class="normal"><a href="#__codelineno-60-15">15</a></span>
<span class="normal"><a href="#__codelineno-60-16">16</a></span>
<span class="normal"><a href="#__codelineno-60-17">17</a></span>
<span class="normal"><a href="#__codelineno-60-18">18</a></span>
<span class="normal"><a href="#__codelineno-60-19">19</a></span>
<span class="normal"><a href="#__codelineno-60-20">20</a></span>
<span class="normal"><a href="#__codelineno-60-21">21</a></span>
<span class="normal"><a href="#__codelineno-60-22">22</a></span>
<span class="normal"><a href="#__codelineno-60-23">23</a></span>
<span class="normal"><a href="#__codelineno-60-24">24</a></span>
<span class="normal"><a href="#__codelineno-60-25">25</a></span>
<span class="normal"><a href="#__codelineno-60-26">26</a></span>
<span class="normal"><a href="#__codelineno-60-27">27</a></span>
<span class="normal"><a href="#__codelineno-60-28">28</a></span>
<span class="normal"><a href="#__codelineno-60-29">29</a></span>
<span class="normal"><a href="#__codelineno-60-30">30</a></span>
<span class="normal"><a href="#__codelineno-60-31">31</a></span>
<span class="normal"><a href="#__codelineno-60-32">32</a></span>
<span class="normal"><a href="#__codelineno-60-33">33</a></span>
<span class="normal"><a href="#__codelineno-60-34">34</a></span>
<span class="normal"><a href="#__codelineno-60-35">35</a></span>
<span class="normal"><a href="#__codelineno-60-36">36</a></span>
<span class="normal"><a href="#__codelineno-60-37">37</a></span>
<span class="normal"><a href="#__codelineno-60-38">38</a></span>
<span class="normal"><a href="#__codelineno-60-39">39</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-60-1"><a id="__codelineno-60-1" name="__codelineno-60-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-60-2"><a id="__codelineno-60-2" name="__codelineno-60-2"></a><span class="w">    </span><span class="s">&quot;context&quot;</span>
</span><span id="__span-60-3"><a id="__codelineno-60-3" name="__codelineno-60-3"></a><span class="w">    </span><span class="s">&quot;fmt&quot;</span>
</span><span id="__span-60-4"><a id="__codelineno-60-4" name="__codelineno-60-4"></a>
</span><span id="__span-60-5"><a id="__codelineno-60-5" name="__codelineno-60-5"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/agent&quot;</span>
</span><span id="__span-60-6"><a id="__codelineno-60-6" name="__codelineno-60-6"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-60-7"><a id="__codelineno-60-7" name="__codelineno-60-7"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/model&quot;</span>
</span><span id="__span-60-8"><a id="__codelineno-60-8" name="__codelineno-60-8"></a><span class="p">)</span>
</span><span id="__span-60-9"><a id="__codelineno-60-9" name="__codelineno-60-9"></a>
</span><span id="__span-60-10"><a id="__codelineno-60-10" name="__codelineno-60-10"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-60-11"><a id="__codelineno-60-11" name="__codelineno-60-11"></a><span class="w">    </span><span class="nx">stateKeyContent</span><span class="w">    </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;content&quot;</span>
</span><span id="__span-60-12"><a id="__codelineno-60-12" name="__codelineno-60-12"></a><span class="w">    </span><span class="nx">stateKeyDecision</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;decision&quot;</span>
</span><span id="__span-60-13"><a id="__codelineno-60-13" name="__codelineno-60-13"></a><span class="w">    </span><span class="nx">interruptKeyReview</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;review_key&quot;</span>
</span><span id="__span-60-14"><a id="__codelineno-60-14" name="__codelineno-60-14"></a><span class="w">    </span><span class="nx">nodeReview</span><span class="w">         </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;review&quot;</span>
</span><span id="__span-60-15"><a id="__codelineno-60-15" name="__codelineno-60-15"></a><span class="p">)</span>
</span><span id="__span-60-16"><a id="__codelineno-60-16" name="__codelineno-60-16"></a>
</span><span id="__span-60-17"><a id="__codelineno-60-17" name="__codelineno-60-17"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="nx">nodeReview</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-60-18"><a id="__codelineno-60-18" name="__codelineno-60-18"></a><span class="w">    </span><span class="nx">content</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">s</span><span class="p">[</span><span class="nx">stateKeyContent</span><span class="p">].(</span><span class="kt">string</span><span class="p">)</span>
</span><span id="__span-60-19"><a id="__codelineno-60-19" name="__codelineno-60-19"></a>
</span><span id="__span-60-20"><a id="__codelineno-60-20" name="__codelineno-60-20"></a><span class="w">    </span><span class="c1">// Interrupt and wait for human input</span>
</span><span id="__span-60-21"><a id="__codelineno-60-21" name="__codelineno-60-21"></a><span class="w">    </span><span class="nx">result</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">Interrupt</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="p">,</span><span class="w"> </span><span class="nx">interruptKeyReview</span><span class="p">,</span>
</span><span id="__span-60-22"><a id="__codelineno-60-22" name="__codelineno-60-22"></a><span class="w">        </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;Please review: %s&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">content</span><span class="p">))</span>
</span><span id="__span-60-23"><a id="__codelineno-60-23" name="__codelineno-60-23"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-60-24"><a id="__codelineno-60-24" name="__codelineno-60-24"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
</span><span id="__span-60-25"><a id="__codelineno-60-25" name="__codelineno-60-25"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-60-26"><a id="__codelineno-60-26" name="__codelineno-60-26"></a>
</span><span id="__span-60-27"><a id="__codelineno-60-27" name="__codelineno-60-27"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="nx">stateKeyDecision</span><span class="p">:</span><span class="w"> </span><span class="nx">result</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-60-28"><a id="__codelineno-60-28" name="__codelineno-60-28"></a><span class="p">})</span>
</span><span id="__span-60-29"><a id="__codelineno-60-29" name="__codelineno-60-29"></a>
</span><span id="__span-60-30"><a id="__codelineno-60-30" name="__codelineno-60-30"></a><span class="c1">// Resume execution (requires the agent package)</span>
</span><span id="__span-60-31"><a id="__codelineno-60-31" name="__codelineno-60-31"></a><span class="nx">eventCh</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">userID</span><span class="p">,</span><span class="w"> </span><span class="nx">sessionID</span><span class="p">,</span>
</span><span id="__span-60-32"><a id="__codelineno-60-32" name="__codelineno-60-32"></a><span class="w">    </span><span class="nx">model</span><span class="p">.</span><span class="nx">NewUserMessage</span><span class="p">(</span><span class="s">&quot;resume&quot;</span><span class="p">),</span>
</span><span id="__span-60-33"><a id="__codelineno-60-33" name="__codelineno-60-33"></a><span class="w">    </span><span class="nx">agent</span><span class="p">.</span><span class="nx">WithRuntimeState</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">any</span><span class="p">{</span>
</span><span id="__span-60-34"><a id="__codelineno-60-34" name="__codelineno-60-34"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">CfgKeyCheckpointID</span><span class="p">:</span><span class="w"> </span><span class="nx">checkpointID</span><span class="p">,</span>
</span><span id="__span-60-35"><a id="__codelineno-60-35" name="__codelineno-60-35"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyResumeMap</span><span class="p">:</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">any</span><span class="p">{</span>
</span><span id="__span-60-36"><a id="__codelineno-60-36" name="__codelineno-60-36"></a><span class="w">            </span><span class="s">&quot;review_key&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;approved&quot;</span><span class="p">,</span>
</span><span id="__span-60-37"><a id="__codelineno-60-37" name="__codelineno-60-37"></a><span class="w">        </span><span class="p">},</span>
</span><span id="__span-60-38"><a id="__codelineno-60-38" name="__codelineno-60-38"></a><span class="w">    </span><span class="p">}),</span>
</span><span id="__span-60-39"><a id="__codelineno-60-39" name="__codelineno-60-39"></a><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>Helpers:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-61-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-61-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-61-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-61-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-61-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-61-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-61-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-61-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-61-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-61-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-61-1"><a id="__codelineno-61-1" name="__codelineno-61-1"></a><span class="c1">// Typed resume value</span>
</span><span id="__span-61-2"><a id="__codelineno-61-2" name="__codelineno-61-2"></a><span class="k">if</span><span class="w"> </span><span class="nx">v</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">ResumeValue</span><span class="p">[</span><span class="kt">string</span><span class="p">](</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;approval&quot;</span><span class="p">);</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* use v */</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-61-3"><a id="__codelineno-61-3" name="__codelineno-61-3"></a>
</span><span id="__span-61-4"><a id="__codelineno-61-4" name="__codelineno-61-4"></a><span class="c1">// With default</span>
</span><span id="__span-61-5"><a id="__codelineno-61-5" name="__codelineno-61-5"></a><span class="nx">v</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">ResumeValueOrDefault</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;approval&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;no&quot;</span><span class="p">)</span>
</span><span id="__span-61-6"><a id="__codelineno-61-6" name="__codelineno-61-6"></a>
</span><span id="__span-61-7"><a id="__codelineno-61-7" name="__codelineno-61-7"></a><span class="c1">// Check / clear</span>
</span><span id="__span-61-8"><a id="__codelineno-61-8" name="__codelineno-61-8"></a><span class="nx">_</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">HasResumeValue</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;approval&quot;</span><span class="p">)</span>
</span><span id="__span-61-9"><a id="__codelineno-61-9" name="__codelineno-61-9"></a><span class="nx">graph</span><span class="p">.</span><span class="nx">ClearResumeValue</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;approval&quot;</span><span class="p">)</span>
</span><span id="__span-61-10"><a id="__codelineno-61-10" name="__codelineno-61-10"></a><span class="nx">graph</span><span class="p">.</span><span class="nx">ClearAllResumeValues</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>You can also inject resume values at entry via a command (no need to jump to a specific node first). Pass it via Runner runtime state:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-62-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-62-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-62-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-62-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-62-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-62-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-62-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-62-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-62-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-62-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-62-1"><a id="__codelineno-62-1" name="__codelineno-62-1"></a><span class="nx">cmd</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewResumeCommand</span><span class="p">().</span>
</span><span id="__span-62-2"><a id="__codelineno-62-2" name="__codelineno-62-2"></a><span class="w">    </span><span class="nx">WithResumeMap</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">any</span><span class="p">{</span><span class="s">&quot;approval&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span><span class="p">})</span>
</span><span id="__span-62-3"><a id="__codelineno-62-3" name="__codelineno-62-3"></a>
</span><span id="__span-62-4"><a id="__codelineno-62-4" name="__codelineno-62-4"></a><span class="c1">// Inject __command__ into initial state via RuntimeState</span>
</span><span id="__span-62-5"><a id="__codelineno-62-5" name="__codelineno-62-5"></a><span class="nx">eventCh</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">userID</span><span class="p">,</span><span class="w"> </span><span class="nx">sessionID</span><span class="p">,</span>
</span><span id="__span-62-6"><a id="__codelineno-62-6" name="__codelineno-62-6"></a><span class="w">    </span><span class="nx">model</span><span class="p">.</span><span class="nx">NewUserMessage</span><span class="p">(</span><span class="s">&quot;resume&quot;</span><span class="p">),</span>
</span><span id="__span-62-7"><a id="__codelineno-62-7" name="__codelineno-62-7"></a><span class="w">    </span><span class="nx">agent</span><span class="p">.</span><span class="nx">WithRuntimeState</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">any</span><span class="p">{</span>
</span><span id="__span-62-8"><a id="__codelineno-62-8" name="__codelineno-62-8"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyCommand</span><span class="p">:</span><span class="w"> </span><span class="nx">cmd</span><span class="p">,</span>
</span><span id="__span-62-9"><a id="__codelineno-62-9" name="__codelineno-62-9"></a><span class="w">    </span><span class="p">}),</span>
</span><span id="__span-62-10"><a id="__codelineno-62-10" name="__codelineno-62-10"></a><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="event-monitoring">Event Monitoring</h3>
<p>The event stream carries execution progress and incremental outputs. The example shows how to iterate events and distinguish graph events vs model deltas:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-63-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-63-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-63-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-63-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-63-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-63-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-63-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-63-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-63-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-63-10">10</a></span>
<span class="normal"><a href="#__codelineno-63-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-63-1"><a id="__codelineno-63-1" name="__codelineno-63-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-63-2"><a id="__codelineno-63-2" name="__codelineno-63-2"></a><span class="w">    </span><span class="s">&quot;fmt&quot;</span>
</span><span id="__span-63-3"><a id="__codelineno-63-3" name="__codelineno-63-3"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-63-4"><a id="__codelineno-63-4" name="__codelineno-63-4"></a><span class="p">)</span>
</span><span id="__span-63-5"><a id="__codelineno-63-5" name="__codelineno-63-5"></a>
</span><span id="__span-63-6"><a id="__codelineno-63-6" name="__codelineno-63-6"></a><span class="k">for</span><span class="w"> </span><span class="nx">ev</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">eventCh</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-63-7"><a id="__codelineno-63-7" name="__codelineno-63-7"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">ev</span><span class="p">.</span><span class="nx">Response</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-63-8"><a id="__codelineno-63-8" name="__codelineno-63-8"></a><span class="w">        </span><span class="k">continue</span>
</span><span id="__span-63-9"><a id="__codelineno-63-9" name="__codelineno-63-9"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-63-10"><a id="__codelineno-63-10" name="__codelineno-63-10"></a><span class="w">    </span><span class="c1">// ... your handling here</span>
</span><span id="__span-63-11"><a id="__codelineno-63-11" name="__codelineno-63-11"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>You can also filter by the event’s <code>Author</code> field:</p>
<ul>
<li>Node‑level events (model, tools, node start/stop): <code>Author = &lt;nodeID&gt;</code> (or <code>graph-node</code> if unavailable)</li>
<li>Pregel (planning/execution/update/errors): <code>Author = graph.AuthorGraphPregel</code></li>
<li>Executor‑level (state updates/checkpoints): <code>Author = graph.AuthorGraphExecutor</code></li>
<li>User input (Runner writes): <code>Author = user</code></li>
</ul>
<p>This convention lets you subscribe to a specific node’s stream without passing streaming context through nodes (streaming travels via the event channel; state stays structured in a LangGraph‑like style).</p>
<p>Example: consume only node <code>ask</code>’s streaming output and print the final message when done.</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-64-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-64-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-64-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-64-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-64-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-64-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-64-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-64-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-64-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-64-10">10</a></span>
<span class="normal"><a href="#__codelineno-64-11">11</a></span>
<span class="normal"><a href="#__codelineno-64-12">12</a></span>
<span class="normal"><a href="#__codelineno-64-13">13</a></span>
<span class="normal"><a href="#__codelineno-64-14">14</a></span>
<span class="normal"><a href="#__codelineno-64-15">15</a></span>
<span class="normal"><a href="#__codelineno-64-16">16</a></span>
<span class="normal"><a href="#__codelineno-64-17">17</a></span>
<span class="normal"><a href="#__codelineno-64-18">18</a></span>
<span class="normal"><a href="#__codelineno-64-19">19</a></span>
<span class="normal"><a href="#__codelineno-64-20">20</a></span>
<span class="normal"><a href="#__codelineno-64-21">21</a></span>
<span class="normal"><a href="#__codelineno-64-22">22</a></span>
<span class="normal"><a href="#__codelineno-64-23">23</a></span>
<span class="normal"><a href="#__codelineno-64-24">24</a></span>
<span class="normal"><a href="#__codelineno-64-25">25</a></span>
<span class="normal"><a href="#__codelineno-64-26">26</a></span>
<span class="normal"><a href="#__codelineno-64-27">27</a></span>
<span class="normal"><a href="#__codelineno-64-28">28</a></span>
<span class="normal"><a href="#__codelineno-64-29">29</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-64-1"><a id="__codelineno-64-1" name="__codelineno-64-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-64-2"><a id="__codelineno-64-2" name="__codelineno-64-2"></a><span class="w">    </span><span class="s">&quot;fmt&quot;</span>
</span><span id="__span-64-3"><a id="__codelineno-64-3" name="__codelineno-64-3"></a>
</span><span id="__span-64-4"><a id="__codelineno-64-4" name="__codelineno-64-4"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-64-5"><a id="__codelineno-64-5" name="__codelineno-64-5"></a><span class="p">)</span>
</span><span id="__span-64-6"><a id="__codelineno-64-6" name="__codelineno-64-6"></a>
</span><span id="__span-64-7"><a id="__codelineno-64-7" name="__codelineno-64-7"></a><span class="kd">const</span><span class="w"> </span><span class="nx">nodeIDWatch</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;ask&quot;</span>
</span><span id="__span-64-8"><a id="__codelineno-64-8" name="__codelineno-64-8"></a>
</span><span id="__span-64-9"><a id="__codelineno-64-9" name="__codelineno-64-9"></a><span class="k">for</span><span class="w"> </span><span class="nx">ev</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">eventCh</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-64-10"><a id="__codelineno-64-10" name="__codelineno-64-10"></a><span class="w">    </span><span class="c1">// Only care about events from the watched node</span>
</span><span id="__span-64-11"><a id="__codelineno-64-11" name="__codelineno-64-11"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">ev</span><span class="p">.</span><span class="nx">Author</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">nodeIDWatch</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-64-12"><a id="__codelineno-64-12" name="__codelineno-64-12"></a><span class="w">        </span><span class="k">continue</span>
</span><span id="__span-64-13"><a id="__codelineno-64-13" name="__codelineno-64-13"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-64-14"><a id="__codelineno-64-14" name="__codelineno-64-14"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">ev</span><span class="p">.</span><span class="nx">Response</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">ev</span><span class="p">.</span><span class="nx">Response</span><span class="p">.</span><span class="nx">Choices</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-64-15"><a id="__codelineno-64-15" name="__codelineno-64-15"></a><span class="w">        </span><span class="k">continue</span>
</span><span id="__span-64-16"><a id="__codelineno-64-16" name="__codelineno-64-16"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-64-17"><a id="__codelineno-64-17" name="__codelineno-64-17"></a><span class="w">    </span><span class="nx">choice</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">ev</span><span class="p">.</span><span class="nx">Response</span><span class="p">.</span><span class="nx">Choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="__span-64-18"><a id="__codelineno-64-18" name="__codelineno-64-18"></a>
</span><span id="__span-64-19"><a id="__codelineno-64-19" name="__codelineno-64-19"></a><span class="w">    </span><span class="c1">// Streaming deltas</span>
</span><span id="__span-64-20"><a id="__codelineno-64-20" name="__codelineno-64-20"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">ev</span><span class="p">.</span><span class="nx">Response</span><span class="p">.</span><span class="nx">IsPartial</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">choice</span><span class="p">.</span><span class="nx">Delta</span><span class="p">.</span><span class="nx">Content</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-64-21"><a id="__codelineno-64-21" name="__codelineno-64-21"></a><span class="w">        </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Print</span><span class="p">(</span><span class="nx">choice</span><span class="p">.</span><span class="nx">Delta</span><span class="p">.</span><span class="nx">Content</span><span class="p">)</span>
</span><span id="__span-64-22"><a id="__codelineno-64-22" name="__codelineno-64-22"></a><span class="w">        </span><span class="k">continue</span>
</span><span id="__span-64-23"><a id="__codelineno-64-23" name="__codelineno-64-23"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-64-24"><a id="__codelineno-64-24" name="__codelineno-64-24"></a>
</span><span id="__span-64-25"><a id="__codelineno-64-25" name="__codelineno-64-25"></a><span class="w">    </span><span class="c1">// Final full message</span>
</span><span id="__span-64-26"><a id="__codelineno-64-26" name="__codelineno-64-26"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">!</span><span class="nx">ev</span><span class="p">.</span><span class="nx">Response</span><span class="p">.</span><span class="nx">IsPartial</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">choice</span><span class="p">.</span><span class="nx">Message</span><span class="p">.</span><span class="nx">Content</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-64-27"><a id="__codelineno-64-27" name="__codelineno-64-27"></a><span class="w">        </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;\n[ask] final output:&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">choice</span><span class="p">.</span><span class="nx">Message</span><span class="p">.</span><span class="nx">Content</span><span class="p">)</span>
</span><span id="__span-64-28"><a id="__codelineno-64-28" name="__codelineno-64-28"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-64-29"><a id="__codelineno-64-29" name="__codelineno-64-29"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<h4 id="event-metadata-statedelta">Event Metadata (StateDelta)</h4>
<p>Each event also carries <code>StateDelta</code>, which includes execution metadata for models/tools:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-65-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-65-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-65-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-65-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-65-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-65-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-65-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-65-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-65-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-65-10">10</a></span>
<span class="normal"><a href="#__codelineno-65-11">11</a></span>
<span class="normal"><a href="#__codelineno-65-12">12</a></span>
<span class="normal"><a href="#__codelineno-65-13">13</a></span>
<span class="normal"><a href="#__codelineno-65-14">14</a></span>
<span class="normal"><a href="#__codelineno-65-15">15</a></span>
<span class="normal"><a href="#__codelineno-65-16">16</a></span>
<span class="normal"><a href="#__codelineno-65-17">17</a></span>
<span class="normal"><a href="#__codelineno-65-18">18</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-65-1"><a id="__codelineno-65-1" name="__codelineno-65-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-65-2"><a id="__codelineno-65-2" name="__codelineno-65-2"></a><span class="w">    </span><span class="s">&quot;encoding/json&quot;</span>
</span><span id="__span-65-3"><a id="__codelineno-65-3" name="__codelineno-65-3"></a>
</span><span id="__span-65-4"><a id="__codelineno-65-4" name="__codelineno-65-4"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-65-5"><a id="__codelineno-65-5" name="__codelineno-65-5"></a><span class="p">)</span>
</span><span id="__span-65-6"><a id="__codelineno-65-6" name="__codelineno-65-6"></a>
</span><span id="__span-65-7"><a id="__codelineno-65-7" name="__codelineno-65-7"></a><span class="k">for</span><span class="w"> </span><span class="nx">ev</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">events</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-65-8"><a id="__codelineno-65-8" name="__codelineno-65-8"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">ev</span><span class="p">.</span><span class="nx">StateDelta</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">continue</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-65-9"><a id="__codelineno-65-9" name="__codelineno-65-9"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">ev</span><span class="p">.</span><span class="nx">StateDelta</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">MetadataKeyModel</span><span class="p">];</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-65-10"><a id="__codelineno-65-10" name="__codelineno-65-10"></a><span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="nx">md</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">ModelExecutionMetadata</span>
</span><span id="__span-65-11"><a id="__codelineno-65-11" name="__codelineno-65-11"></a><span class="w">        </span><span class="nx">_</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">json</span><span class="p">.</span><span class="nx">Unmarshal</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">md</span><span class="p">)</span>
</span><span id="__span-65-12"><a id="__codelineno-65-12" name="__codelineno-65-12"></a><span class="w">        </span><span class="c1">// md.Input / md.Output / md.Duration</span>
</span><span id="__span-65-13"><a id="__codelineno-65-13" name="__codelineno-65-13"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-65-14"><a id="__codelineno-65-14" name="__codelineno-65-14"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">ev</span><span class="p">.</span><span class="nx">StateDelta</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">MetadataKeyTool</span><span class="p">];</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-65-15"><a id="__codelineno-65-15" name="__codelineno-65-15"></a><span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="nx">td</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">ToolExecutionMetadata</span>
</span><span id="__span-65-16"><a id="__codelineno-65-16" name="__codelineno-65-16"></a><span class="w">        </span><span class="nx">_</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">json</span><span class="p">.</span><span class="nx">Unmarshal</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">td</span><span class="p">)</span>
</span><span id="__span-65-17"><a id="__codelineno-65-17" name="__codelineno-65-17"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-65-18"><a id="__codelineno-65-18" name="__codelineno-65-18"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<h4 id="emit-selected-values-from-node-callbacks">Emit selected values from node callbacks</h4>
<p>By default, mid‑run events like <code>graph.state.update</code> report which keys were updated (metadata‑only). Concrete values are not included to keep the stream lightweight and avoid exposing intermediate, potentially conflicting updates. The final <code>graph.execution</code> event’s <code>StateDelta</code> carries the serialized final snapshot of allowed keys (see implementations in <a href="https://github.com/trpc-group/trpc-agent-go/blob/main/graph/executor.go#L2001">graph/executor.go:2001</a>, <a href="https://github.com/trpc-group/trpc-agent-go/blob/main/graph/events.go#L1276">graph/events.go:1276</a>, <a href="https://github.com/trpc-group/trpc-agent-go/blob/main/graph/events.go#L1330">graph/events.go:1330</a>).</p>
<p>If you only need to surface a few values from the result of a specific node right after it completes, register an After‑node callback and emit a small custom event containing just those values:</p>
<p>Steps:
- Register <code>WithPostNodeCallback</code> on the target node.
- In the callback, read <code>result any</code>; when the node returns <code>graph.State</code>, this is the node’s state delta.
- Pick the needed keys, serialize to JSON, attach to a new event’s <code>StateDelta</code>.
- Send via <code>agent.EmitEvent</code>.</p>
<p>Example:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-66-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-66-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-66-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-66-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-66-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-66-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-66-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-66-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-66-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-66-10">10</a></span>
<span class="normal"><a href="#__codelineno-66-11">11</a></span>
<span class="normal"><a href="#__codelineno-66-12">12</a></span>
<span class="normal"><a href="#__codelineno-66-13">13</a></span>
<span class="normal"><a href="#__codelineno-66-14">14</a></span>
<span class="normal"><a href="#__codelineno-66-15">15</a></span>
<span class="normal"><a href="#__codelineno-66-16">16</a></span>
<span class="normal"><a href="#__codelineno-66-17">17</a></span>
<span class="normal"><a href="#__codelineno-66-18">18</a></span>
<span class="normal"><a href="#__codelineno-66-19">19</a></span>
<span class="normal"><a href="#__codelineno-66-20">20</a></span>
<span class="normal"><a href="#__codelineno-66-21">21</a></span>
<span class="normal"><a href="#__codelineno-66-22">22</a></span>
<span class="normal"><a href="#__codelineno-66-23">23</a></span>
<span class="normal"><a href="#__codelineno-66-24">24</a></span>
<span class="normal"><a href="#__codelineno-66-25">25</a></span>
<span class="normal"><a href="#__codelineno-66-26">26</a></span>
<span class="normal"><a href="#__codelineno-66-27">27</a></span>
<span class="normal"><a href="#__codelineno-66-28">28</a></span>
<span class="normal"><a href="#__codelineno-66-29">29</a></span>
<span class="normal"><a href="#__codelineno-66-30">30</a></span>
<span class="normal"><a href="#__codelineno-66-31">31</a></span>
<span class="normal"><a href="#__codelineno-66-32">32</a></span>
<span class="normal"><a href="#__codelineno-66-33">33</a></span>
<span class="normal"><a href="#__codelineno-66-34">34</a></span>
<span class="normal"><a href="#__codelineno-66-35">35</a></span>
<span class="normal"><a href="#__codelineno-66-36">36</a></span>
<span class="normal"><a href="#__codelineno-66-37">37</a></span>
<span class="normal"><a href="#__codelineno-66-38">38</a></span>
<span class="normal"><a href="#__codelineno-66-39">39</a></span>
<span class="normal"><a href="#__codelineno-66-40">40</a></span>
<span class="normal"><a href="#__codelineno-66-41">41</a></span>
<span class="normal"><a href="#__codelineno-66-42">42</a></span>
<span class="normal"><a href="#__codelineno-66-43">43</a></span>
<span class="normal"><a href="#__codelineno-66-44">44</a></span>
<span class="normal"><a href="#__codelineno-66-45">45</a></span>
<span class="normal"><a href="#__codelineno-66-46">46</a></span>
<span class="normal"><a href="#__codelineno-66-47">47</a></span>
<span class="normal"><a href="#__codelineno-66-48">48</a></span>
<span class="normal"><a href="#__codelineno-66-49">49</a></span>
<span class="normal"><a href="#__codelineno-66-50">50</a></span>
<span class="normal"><a href="#__codelineno-66-51">51</a></span>
<span class="normal"><a href="#__codelineno-66-52">52</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-66-1"><a id="__codelineno-66-1" name="__codelineno-66-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-66-2"><a id="__codelineno-66-2" name="__codelineno-66-2"></a><span class="w">    </span><span class="s">&quot;context&quot;</span>
</span><span id="__span-66-3"><a id="__codelineno-66-3" name="__codelineno-66-3"></a><span class="w">    </span><span class="s">&quot;encoding/json&quot;</span>
</span><span id="__span-66-4"><a id="__codelineno-66-4" name="__codelineno-66-4"></a>
</span><span id="__span-66-5"><a id="__codelineno-66-5" name="__codelineno-66-5"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/agent&quot;</span>
</span><span id="__span-66-6"><a id="__codelineno-66-6" name="__codelineno-66-6"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-66-7"><a id="__codelineno-66-7" name="__codelineno-66-7"></a><span class="p">)</span>
</span><span id="__span-66-8"><a id="__codelineno-66-8" name="__codelineno-66-8"></a>
</span><span id="__span-66-9"><a id="__codelineno-66-9" name="__codelineno-66-9"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-66-10"><a id="__codelineno-66-10" name="__codelineno-66-10"></a><span class="w">    </span><span class="nx">nodeParse</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;parse&quot;</span>
</span><span id="__span-66-11"><a id="__codelineno-66-11" name="__codelineno-66-11"></a><span class="w">    </span><span class="nx">stateKeyOut</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;parsed_value&quot;</span><span class="w"> </span><span class="c1">// emit only what upstream needs</span>
</span><span id="__span-66-12"><a id="__codelineno-66-12" name="__codelineno-66-12"></a><span class="p">)</span>
</span><span id="__span-66-13"><a id="__codelineno-66-13" name="__codelineno-66-13"></a>
</span><span id="__span-66-14"><a id="__codelineno-66-14" name="__codelineno-66-14"></a><span class="kd">func</span><span class="w"> </span><span class="nx">parseNode</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-66-15"><a id="__codelineno-66-15" name="__codelineno-66-15"></a><span class="w">    </span><span class="nx">val</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">any</span><span class="p">{</span><span class="s">&quot;ok&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;score&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.97</span><span class="p">}</span>
</span><span id="__span-66-16"><a id="__codelineno-66-16" name="__codelineno-66-16"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="nx">stateKeyOut</span><span class="p">:</span><span class="w"> </span><span class="nx">val</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-66-17"><a id="__codelineno-66-17" name="__codelineno-66-17"></a><span class="p">}</span>
</span><span id="__span-66-18"><a id="__codelineno-66-18" name="__codelineno-66-18"></a>
</span><span id="__span-66-19"><a id="__codelineno-66-19" name="__codelineno-66-19"></a><span class="kd">func</span><span class="w"> </span><span class="nx">buildGraph</span><span class="p">()</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">graph</span><span class="p">.</span><span class="nx">Graph</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-66-20"><a id="__codelineno-66-20" name="__codelineno-66-20"></a><span class="w">    </span><span class="nx">sg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateGraph</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">MessagesStateSchema</span><span class="p">())</span>
</span><span id="__span-66-21"><a id="__codelineno-66-21" name="__codelineno-66-21"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="nx">nodeParse</span><span class="p">,</span><span class="w"> </span><span class="nx">parseNode</span><span class="p">,</span>
</span><span id="__span-66-22"><a id="__codelineno-66-22" name="__codelineno-66-22"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithPostNodeCallback</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span>
</span><span id="__span-66-23"><a id="__codelineno-66-23" name="__codelineno-66-23"></a><span class="w">            </span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span>
</span><span id="__span-66-24"><a id="__codelineno-66-24" name="__codelineno-66-24"></a><span class="w">            </span><span class="nx">cb</span><span class="w"> </span><span class="o">*</span><span class="nx">graph</span><span class="p">.</span><span class="nx">NodeCallbackContext</span><span class="p">,</span>
</span><span id="__span-66-25"><a id="__codelineno-66-25" name="__codelineno-66-25"></a><span class="w">            </span><span class="nx">st</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">,</span>
</span><span id="__span-66-26"><a id="__codelineno-66-26" name="__codelineno-66-26"></a><span class="w">            </span><span class="nx">result</span><span class="w"> </span><span class="kt">any</span><span class="p">,</span>
</span><span id="__span-66-27"><a id="__codelineno-66-27" name="__codelineno-66-27"></a><span class="w">            </span><span class="nx">nodeErr</span><span class="w"> </span><span class="kt">error</span><span class="p">,</span>
</span><span id="__span-66-28"><a id="__codelineno-66-28" name="__codelineno-66-28"></a><span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-66-29"><a id="__codelineno-66-29" name="__codelineno-66-29"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">nodeErr</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-66-30"><a id="__codelineno-66-30" name="__codelineno-66-30"></a><span class="w">            </span><span class="nx">inv</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">agent</span><span class="p">.</span><span class="nx">InvocationFromContext</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</span><span id="__span-66-31"><a id="__codelineno-66-31" name="__codelineno-66-31"></a><span class="w">            </span><span class="nx">execCtx</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">st</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyExecContext</span><span class="p">].(</span><span class="o">*</span><span class="nx">graph</span><span class="p">.</span><span class="nx">ExecutionContext</span><span class="p">)</span>
</span><span id="__span-66-32"><a id="__codelineno-66-32" name="__codelineno-66-32"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">delta</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">result</span><span class="p">.(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">);</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-66-33"><a id="__codelineno-66-33" name="__codelineno-66-33"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="nx">v</span><span class="p">,</span><span class="w"> </span><span class="nx">exists</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">delta</span><span class="p">[</span><span class="nx">stateKeyOut</span><span class="p">];</span><span class="w"> </span><span class="nx">exists</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">execCtx</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-66-34"><a id="__codelineno-66-34" name="__codelineno-66-34"></a><span class="w">                    </span><span class="nx">evt</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewGraphEvent</span><span class="p">(</span>
</span><span id="__span-66-35"><a id="__codelineno-66-35" name="__codelineno-66-35"></a><span class="w">                        </span><span class="nx">inv</span><span class="p">.</span><span class="nx">InvocationID</span><span class="p">,</span>
</span><span id="__span-66-36"><a id="__codelineno-66-36" name="__codelineno-66-36"></a><span class="w">                        </span><span class="nx">cb</span><span class="p">.</span><span class="nx">NodeID</span><span class="p">,</span><span class="w"> </span><span class="c1">// author = node id for easy filtering</span>
</span><span id="__span-66-37"><a id="__codelineno-66-37" name="__codelineno-66-37"></a><span class="w">                        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">ObjectTypeGraphNodeExecution</span><span class="p">,</span>
</span><span id="__span-66-38"><a id="__codelineno-66-38" name="__codelineno-66-38"></a><span class="w">                    </span><span class="p">)</span>
</span><span id="__span-66-39"><a id="__codelineno-66-39" name="__codelineno-66-39"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="nx">evt</span><span class="p">.</span><span class="nx">StateDelta</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">evt</span><span class="p">.</span><span class="nx">StateDelta</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">][]</span><span class="kt">byte</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-66-40"><a id="__codelineno-66-40" name="__codelineno-66-40"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">json</span><span class="p">.</span><span class="nx">Marshal</span><span class="p">(</span><span class="nx">v</span><span class="p">);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-66-41"><a id="__codelineno-66-41" name="__codelineno-66-41"></a><span class="w">                        </span><span class="nx">evt</span><span class="p">.</span><span class="nx">StateDelta</span><span class="p">[</span><span class="nx">stateKeyOut</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">b</span>
</span><span id="__span-66-42"><a id="__codelineno-66-42" name="__codelineno-66-42"></a><span class="w">                        </span><span class="nx">_</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">agent</span><span class="p">.</span><span class="nx">EmitEvent</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">inv</span><span class="p">,</span><span class="w"> </span><span class="nx">execCtx</span><span class="p">.</span><span class="nx">EventChan</span><span class="p">,</span><span class="w"> </span><span class="nx">evt</span><span class="p">)</span>
</span><span id="__span-66-43"><a id="__codelineno-66-43" name="__codelineno-66-43"></a><span class="w">                    </span><span class="p">}</span>
</span><span id="__span-66-44"><a id="__codelineno-66-44" name="__codelineno-66-44"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-66-45"><a id="__codelineno-66-45" name="__codelineno-66-45"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-66-46"><a id="__codelineno-66-46" name="__codelineno-66-46"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-66-47"><a id="__codelineno-66-47" name="__codelineno-66-47"></a><span class="w">        </span><span class="p">}),</span>
</span><span id="__span-66-48"><a id="__codelineno-66-48" name="__codelineno-66-48"></a><span class="w">    </span><span class="p">).</span>
</span><span id="__span-66-49"><a id="__codelineno-66-49" name="__codelineno-66-49"></a><span class="w">        </span><span class="nx">SetEntryPoint</span><span class="p">(</span><span class="nx">nodeParse</span><span class="p">).</span>
</span><span id="__span-66-50"><a id="__codelineno-66-50" name="__codelineno-66-50"></a><span class="w">        </span><span class="nx">SetFinishPoint</span><span class="p">(</span><span class="nx">nodeParse</span><span class="p">)</span>
</span><span id="__span-66-51"><a id="__codelineno-66-51" name="__codelineno-66-51"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">sg</span><span class="p">.</span><span class="nx">Compile</span><span class="p">()</span>
</span><span id="__span-66-52"><a id="__codelineno-66-52" name="__codelineno-66-52"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>Recommendations:
- Emit only necessary keys to control bandwidth and avoid leaking sensitive data.
- Internal/volatile keys are filtered from final snapshots and should not be emitted (see <a href="https://github.com/trpc-group/trpc-agent-go/blob/main/graph/internal_keys.go#L16">graph/internal_keys.go:16</a>).
- For textual intermediate outputs, prefer existing model streaming events (<code>choice.Delta.Content</code>).</p>
<p>You can also configure agent‑level callbacks:</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-67-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-67-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-67-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-67-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-67-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-67-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-67-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-67-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-67-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-67-10">10</a></span>
<span class="normal"><a href="#__codelineno-67-11">11</a></span>
<span class="normal"><a href="#__codelineno-67-12">12</a></span>
<span class="normal"><a href="#__codelineno-67-13">13</a></span>
<span class="normal"><a href="#__codelineno-67-14">14</a></span>
<span class="normal"><a href="#__codelineno-67-15">15</a></span>
<span class="normal"><a href="#__codelineno-67-16">16</a></span>
<span class="normal"><a href="#__codelineno-67-17">17</a></span>
<span class="normal"><a href="#__codelineno-67-18">18</a></span>
<span class="normal"><a href="#__codelineno-67-19">19</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-67-1"><a id="__codelineno-67-1" name="__codelineno-67-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-67-2"><a id="__codelineno-67-2" name="__codelineno-67-2"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/agent&quot;</span>
</span><span id="__span-67-3"><a id="__codelineno-67-3" name="__codelineno-67-3"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/model&quot;</span>
</span><span id="__span-67-4"><a id="__codelineno-67-4" name="__codelineno-67-4"></a><span class="p">)</span>
</span><span id="__span-67-5"><a id="__codelineno-67-5" name="__codelineno-67-5"></a>
</span><span id="__span-67-6"><a id="__codelineno-67-6" name="__codelineno-67-6"></a><span class="c1">// Construct and register callbacks (recommended)</span>
</span><span id="__span-67-7"><a id="__codelineno-67-7" name="__codelineno-67-7"></a><span class="nx">cb</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">agent</span><span class="p">.</span><span class="nx">NewCallbacks</span><span class="p">().</span>
</span><span id="__span-67-8"><a id="__codelineno-67-8" name="__codelineno-67-8"></a><span class="w">    </span><span class="nx">RegisterBeforeAgent</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">inv</span><span class="w"> </span><span class="o">*</span><span class="nx">agent</span><span class="p">.</span><span class="nx">Invocation</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">model</span><span class="p">.</span><span class="nx">Response</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-67-9"><a id="__codelineno-67-9" name="__codelineno-67-9"></a><span class="w">        </span><span class="c1">// Return a non‑nil *model.Response to short‑circuit this turn</span>
</span><span id="__span-67-10"><a id="__codelineno-67-10" name="__codelineno-67-10"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-67-11"><a id="__codelineno-67-11" name="__codelineno-67-11"></a><span class="w">    </span><span class="p">}).</span>
</span><span id="__span-67-12"><a id="__codelineno-67-12" name="__codelineno-67-12"></a><span class="w">    </span><span class="nx">RegisterAfterAgent</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">inv</span><span class="w"> </span><span class="o">*</span><span class="nx">agent</span><span class="p">.</span><span class="nx">Invocation</span><span class="p">,</span><span class="w"> </span><span class="nx">runErr</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">model</span><span class="p">.</span><span class="nx">Response</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-67-13"><a id="__codelineno-67-13" name="__codelineno-67-13"></a><span class="w">        </span><span class="c1">// Modify/replace the final response</span>
</span><span id="__span-67-14"><a id="__codelineno-67-14" name="__codelineno-67-14"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-67-15"><a id="__codelineno-67-15" name="__codelineno-67-15"></a><span class="w">    </span><span class="p">})</span>
</span><span id="__span-67-16"><a id="__codelineno-67-16" name="__codelineno-67-16"></a>
</span><span id="__span-67-17"><a id="__codelineno-67-17" name="__codelineno-67-17"></a><span class="nx">graphAgent</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;workflow&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">g</span><span class="p">,</span>
</span><span id="__span-67-18"><a id="__codelineno-67-18" name="__codelineno-67-18"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithAgentCallbacks</span><span class="p">(</span><span class="nx">cb</span><span class="p">),</span>
</span><span id="__span-67-19"><a id="__codelineno-67-19" name="__codelineno-67-19"></a><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<h2 id="troubleshooting">Troubleshooting</h2>
<ul>
<li>Graph has no entry point<ul>
<li>Error: "graph must have an entry point". Call <code>SetEntryPoint()</code> and ensure the node exists.</li>
</ul>
</li>
</ul>
<ul>
<li>Edge target/source does not exist<ul>
<li>Error mentions missing node. Define nodes before wiring edges/condition maps.</li>
</ul>
</li>
</ul>
<ul>
<li>Tools don’t run after LLM<ul>
<li>Ensure the LLM actually returned <code>tool_calls</code> and you used <code>AddToolsConditionalEdges(ask, tools, fallback)</code>.</li>
<li>Check that tool names in your map match the model’s declared tool names.</li>
<li>Pairing walks from the latest assistant(tool_calls) until a new user; verify messages ordering.</li>
</ul>
</li>
</ul>
<ul>
<li>No streaming events observed<ul>
<li>Increase <code>WithChannelBufferSize</code> and filter by <code>Author</code>/object types.</li>
<li>Verify you’re consuming events from <code>Runner.Run(...)</code> and not from direct <code>Executor</code> calls.</li>
</ul>
</li>
</ul>
<ul>
<li>Resume did not continue where expected<ul>
<li>Pass <code>agent.WithRuntimeState(map[string]any{ graph.CfgKeyCheckpointID: "..." })</code>.</li>
<li>Provide <code>ResumeMap</code> for HITL continuation when needed. A plain "resume" message is not added to <code>graph.StateKeyUserInput</code>.</li>
</ul>
</li>
</ul>
<ul>
<li>State conflicts in parallel<ul>
<li>Define reducers for lists/maps (e.g., <code>StringSliceReducer</code>, <code>MergeReducer</code>), avoid overwriting the same key from multiple branches without merge semantics.</li>
</ul>
</li>
</ul>
<h2 id="realworld-example">Real‑World Example</h2>
<h3 id="approval-workflow">Approval Workflow</h3>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-68-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-68-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-68-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-68-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-68-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-68-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-68-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-68-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-68-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-68-10">10</a></span>
<span class="normal"><a href="#__codelineno-68-11">11</a></span>
<span class="normal"><a href="#__codelineno-68-12">12</a></span>
<span class="normal"><a href="#__codelineno-68-13">13</a></span>
<span class="normal"><a href="#__codelineno-68-14">14</a></span>
<span class="normal"><a href="#__codelineno-68-15">15</a></span>
<span class="normal"><a href="#__codelineno-68-16">16</a></span>
<span class="normal"><a href="#__codelineno-68-17">17</a></span>
<span class="normal"><a href="#__codelineno-68-18">18</a></span>
<span class="normal"><a href="#__codelineno-68-19">19</a></span>
<span class="normal"><a href="#__codelineno-68-20">20</a></span>
<span class="normal"><a href="#__codelineno-68-21">21</a></span>
<span class="normal"><a href="#__codelineno-68-22">22</a></span>
<span class="normal"><a href="#__codelineno-68-23">23</a></span>
<span class="normal"><a href="#__codelineno-68-24">24</a></span>
<span class="normal"><a href="#__codelineno-68-25">25</a></span>
<span class="normal"><a href="#__codelineno-68-26">26</a></span>
<span class="normal"><a href="#__codelineno-68-27">27</a></span>
<span class="normal"><a href="#__codelineno-68-28">28</a></span>
<span class="normal"><a href="#__codelineno-68-29">29</a></span>
<span class="normal"><a href="#__codelineno-68-30">30</a></span>
<span class="normal"><a href="#__codelineno-68-31">31</a></span>
<span class="normal"><a href="#__codelineno-68-32">32</a></span>
<span class="normal"><a href="#__codelineno-68-33">33</a></span>
<span class="normal"><a href="#__codelineno-68-34">34</a></span>
<span class="normal"><a href="#__codelineno-68-35">35</a></span>
<span class="normal"><a href="#__codelineno-68-36">36</a></span>
<span class="normal"><a href="#__codelineno-68-37">37</a></span>
<span class="normal"><a href="#__codelineno-68-38">38</a></span>
<span class="normal"><a href="#__codelineno-68-39">39</a></span>
<span class="normal"><a href="#__codelineno-68-40">40</a></span>
<span class="normal"><a href="#__codelineno-68-41">41</a></span>
<span class="normal"><a href="#__codelineno-68-42">42</a></span>
<span class="normal"><a href="#__codelineno-68-43">43</a></span>
<span class="normal"><a href="#__codelineno-68-44">44</a></span>
<span class="normal"><a href="#__codelineno-68-45">45</a></span>
<span class="normal"><a href="#__codelineno-68-46">46</a></span>
<span class="normal"><a href="#__codelineno-68-47">47</a></span>
<span class="normal"><a href="#__codelineno-68-48">48</a></span>
<span class="normal"><a href="#__codelineno-68-49">49</a></span>
<span class="normal"><a href="#__codelineno-68-50">50</a></span>
<span class="normal"><a href="#__codelineno-68-51">51</a></span>
<span class="normal"><a href="#__codelineno-68-52">52</a></span>
<span class="normal"><a href="#__codelineno-68-53">53</a></span>
<span class="normal"><a href="#__codelineno-68-54">54</a></span>
<span class="normal"><a href="#__codelineno-68-55">55</a></span>
<span class="normal"><a href="#__codelineno-68-56">56</a></span>
<span class="normal"><a href="#__codelineno-68-57">57</a></span>
<span class="normal"><a href="#__codelineno-68-58">58</a></span>
<span class="normal"><a href="#__codelineno-68-59">59</a></span>
<span class="normal"><a href="#__codelineno-68-60">60</a></span>
<span class="normal"><a href="#__codelineno-68-61">61</a></span>
<span class="normal"><a href="#__codelineno-68-62">62</a></span>
<span class="normal"><a href="#__codelineno-68-63">63</a></span>
<span class="normal"><a href="#__codelineno-68-64">64</a></span>
<span class="normal"><a href="#__codelineno-68-65">65</a></span>
<span class="normal"><a href="#__codelineno-68-66">66</a></span>
<span class="normal"><a href="#__codelineno-68-67">67</a></span>
<span class="normal"><a href="#__codelineno-68-68">68</a></span>
<span class="normal"><a href="#__codelineno-68-69">69</a></span>
<span class="normal"><a href="#__codelineno-68-70">70</a></span>
<span class="normal"><a href="#__codelineno-68-71">71</a></span>
<span class="normal"><a href="#__codelineno-68-72">72</a></span>
<span class="normal"><a href="#__codelineno-68-73">73</a></span>
<span class="normal"><a href="#__codelineno-68-74">74</a></span>
<span class="normal"><a href="#__codelineno-68-75">75</a></span>
<span class="normal"><a href="#__codelineno-68-76">76</a></span>
<span class="normal"><a href="#__codelineno-68-77">77</a></span>
<span class="normal"><a href="#__codelineno-68-78">78</a></span>
<span class="normal"><a href="#__codelineno-68-79">79</a></span>
<span class="normal"><a href="#__codelineno-68-80">80</a></span>
<span class="normal"><a href="#__codelineno-68-81">81</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-68-1"><a id="__codelineno-68-1" name="__codelineno-68-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-68-2"><a id="__codelineno-68-2" name="__codelineno-68-2"></a><span class="w">    </span><span class="s">&quot;context&quot;</span>
</span><span id="__span-68-3"><a id="__codelineno-68-3" name="__codelineno-68-3"></a><span class="w">    </span><span class="s">&quot;fmt&quot;</span>
</span><span id="__span-68-4"><a id="__codelineno-68-4" name="__codelineno-68-4"></a><span class="w">    </span><span class="s">&quot;strings&quot;</span>
</span><span id="__span-68-5"><a id="__codelineno-68-5" name="__codelineno-68-5"></a>
</span><span id="__span-68-6"><a id="__codelineno-68-6" name="__codelineno-68-6"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-68-7"><a id="__codelineno-68-7" name="__codelineno-68-7"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/model/openai&quot;</span>
</span><span id="__span-68-8"><a id="__codelineno-68-8" name="__codelineno-68-8"></a><span class="p">)</span>
</span><span id="__span-68-9"><a id="__codelineno-68-9" name="__codelineno-68-9"></a>
</span><span id="__span-68-10"><a id="__codelineno-68-10" name="__codelineno-68-10"></a><span class="kd">func</span><span class="w"> </span><span class="nx">buildApprovalWorkflow</span><span class="p">()</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">graph</span><span class="p">.</span><span class="nx">Graph</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-68-11"><a id="__codelineno-68-11" name="__codelineno-68-11"></a><span class="w">    </span><span class="nx">sg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateGraph</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">MessagesStateSchema</span><span class="p">())</span>
</span><span id="__span-68-12"><a id="__codelineno-68-12" name="__codelineno-68-12"></a>
</span><span id="__span-68-13"><a id="__codelineno-68-13" name="__codelineno-68-13"></a><span class="w">    </span><span class="c1">// AI pre‑review (define LLM model)</span>
</span><span id="__span-68-14"><a id="__codelineno-68-14" name="__codelineno-68-14"></a><span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-68-15"><a id="__codelineno-68-15" name="__codelineno-68-15"></a><span class="w">        </span><span class="nx">modelNameApprove</span><span class="w">      </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;gpt-4o-mini&quot;</span>
</span><span id="__span-68-16"><a id="__codelineno-68-16" name="__codelineno-68-16"></a><span class="w">        </span><span class="nx">promptApproveDecision</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;Decide whether the application meets requirements; reply approve or reject&quot;</span>
</span><span id="__span-68-17"><a id="__codelineno-68-17" name="__codelineno-68-17"></a>
</span><span id="__span-68-18"><a id="__codelineno-68-18" name="__codelineno-68-18"></a><span class="w">        </span><span class="nx">nodeAIReview</span><span class="w">    </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;ai_review&quot;</span>
</span><span id="__span-68-19"><a id="__codelineno-68-19" name="__codelineno-68-19"></a><span class="w">        </span><span class="nx">nodeHumanReview</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;human_review&quot;</span>
</span><span id="__span-68-20"><a id="__codelineno-68-20" name="__codelineno-68-20"></a><span class="w">        </span><span class="nx">nodeApprove</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;approve&quot;</span>
</span><span id="__span-68-21"><a id="__codelineno-68-21" name="__codelineno-68-21"></a><span class="w">        </span><span class="nx">nodeReject</span><span class="w">      </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;reject&quot;</span>
</span><span id="__span-68-22"><a id="__codelineno-68-22" name="__codelineno-68-22"></a>
</span><span id="__span-68-23"><a id="__codelineno-68-23" name="__codelineno-68-23"></a><span class="w">        </span><span class="nx">routeHumanReview</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;route_human_review&quot;</span>
</span><span id="__span-68-24"><a id="__codelineno-68-24" name="__codelineno-68-24"></a><span class="w">        </span><span class="nx">routeReject</span><span class="w">      </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;route_reject&quot;</span>
</span><span id="__span-68-25"><a id="__codelineno-68-25" name="__codelineno-68-25"></a><span class="w">        </span><span class="nx">routeApprove</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;route_approve&quot;</span>
</span><span id="__span-68-26"><a id="__codelineno-68-26" name="__codelineno-68-26"></a>
</span><span id="__span-68-27"><a id="__codelineno-68-27" name="__codelineno-68-27"></a><span class="w">        </span><span class="nx">stateKeyApplication</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;application&quot;</span>
</span><span id="__span-68-28"><a id="__codelineno-68-28" name="__codelineno-68-28"></a><span class="w">        </span><span class="nx">stateKeyDecision</span><span class="w">    </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;decision&quot;</span>
</span><span id="__span-68-29"><a id="__codelineno-68-29" name="__codelineno-68-29"></a><span class="w">    </span><span class="p">)</span>
</span><span id="__span-68-30"><a id="__codelineno-68-30" name="__codelineno-68-30"></a>
</span><span id="__span-68-31"><a id="__codelineno-68-31" name="__codelineno-68-31"></a><span class="w">    </span><span class="nx">llm</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">openai</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="nx">modelNameApprove</span><span class="p">)</span>
</span><span id="__span-68-32"><a id="__codelineno-68-32" name="__codelineno-68-32"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddLLMNode</span><span class="p">(</span><span class="nx">nodeAIReview</span><span class="p">,</span><span class="w"> </span><span class="nx">llm</span><span class="p">,</span><span class="w"> </span><span class="nx">promptApproveDecision</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span><span class="p">)</span>
</span><span id="__span-68-33"><a id="__codelineno-68-33" name="__codelineno-68-33"></a>
</span><span id="__span-68-34"><a id="__codelineno-68-34" name="__codelineno-68-34"></a><span class="w">    </span><span class="c1">// Route to human review or reject</span>
</span><span id="__span-68-35"><a id="__codelineno-68-35" name="__codelineno-68-35"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddConditionalEdges</span><span class="p">(</span><span class="nx">nodeAIReview</span><span class="p">,</span>
</span><span id="__span-68-36"><a id="__codelineno-68-36" name="__codelineno-68-36"></a><span class="w">        </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-68-37"><a id="__codelineno-68-37" name="__codelineno-68-37"></a><span class="w">            </span><span class="nx">resp</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">s</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyLastResponse</span><span class="p">].(</span><span class="kt">string</span><span class="p">)</span>
</span><span id="__span-68-38"><a id="__codelineno-68-38" name="__codelineno-68-38"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">strings</span><span class="p">.</span><span class="nx">Contains</span><span class="p">(</span><span class="nx">resp</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;approve&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-68-39"><a id="__codelineno-68-39" name="__codelineno-68-39"></a><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nx">routeHumanReview</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-68-40"><a id="__codelineno-68-40" name="__codelineno-68-40"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-68-41"><a id="__codelineno-68-41" name="__codelineno-68-41"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">routeReject</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-68-42"><a id="__codelineno-68-42" name="__codelineno-68-42"></a><span class="w">        </span><span class="p">},</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span>
</span><span id="__span-68-43"><a id="__codelineno-68-43" name="__codelineno-68-43"></a><span class="w">            </span><span class="nx">routeHumanReview</span><span class="p">:</span><span class="w"> </span><span class="nx">nodeHumanReview</span><span class="p">,</span>
</span><span id="__span-68-44"><a id="__codelineno-68-44" name="__codelineno-68-44"></a><span class="w">            </span><span class="nx">routeReject</span><span class="p">:</span><span class="w">      </span><span class="nx">nodeReject</span><span class="p">,</span>
</span><span id="__span-68-45"><a id="__codelineno-68-45" name="__codelineno-68-45"></a><span class="w">        </span><span class="p">})</span>
</span><span id="__span-68-46"><a id="__codelineno-68-46" name="__codelineno-68-46"></a>
</span><span id="__span-68-47"><a id="__codelineno-68-47" name="__codelineno-68-47"></a><span class="w">    </span><span class="c1">// Human review node</span>
</span><span id="__span-68-48"><a id="__codelineno-68-48" name="__codelineno-68-48"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="nx">nodeHumanReview</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-68-49"><a id="__codelineno-68-49" name="__codelineno-68-49"></a><span class="w">        </span><span class="nx">app</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">s</span><span class="p">[</span><span class="nx">stateKeyApplication</span><span class="p">].(</span><span class="kt">string</span><span class="p">)</span>
</span><span id="__span-68-50"><a id="__codelineno-68-50" name="__codelineno-68-50"></a><span class="w">        </span><span class="nx">decision</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">Interrupt</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;approval&quot;</span><span class="p">,</span>
</span><span id="__span-68-51"><a id="__codelineno-68-51" name="__codelineno-68-51"></a><span class="w">            </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;Please approve: %s&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">app</span><span class="p">))</span>
</span><span id="__span-68-52"><a id="__codelineno-68-52" name="__codelineno-68-52"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-68-53"><a id="__codelineno-68-53" name="__codelineno-68-53"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
</span><span id="__span-68-54"><a id="__codelineno-68-54" name="__codelineno-68-54"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-68-55"><a id="__codelineno-68-55" name="__codelineno-68-55"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="nx">stateKeyDecision</span><span class="p">:</span><span class="w"> </span><span class="nx">decision</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-68-56"><a id="__codelineno-68-56" name="__codelineno-68-56"></a><span class="w">    </span><span class="p">})</span>
</span><span id="__span-68-57"><a id="__codelineno-68-57" name="__codelineno-68-57"></a>
</span><span id="__span-68-58"><a id="__codelineno-68-58" name="__codelineno-68-58"></a><span class="w">    </span><span class="c1">// Outcome handling</span>
</span><span id="__span-68-59"><a id="__codelineno-68-59" name="__codelineno-68-59"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="nx">nodeApprove</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-68-60"><a id="__codelineno-68-60" name="__codelineno-68-60"></a><span class="w">        </span><span class="c1">// perform approval logic</span>
</span><span id="__span-68-61"><a id="__codelineno-68-61" name="__codelineno-68-61"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="s">&quot;status&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;approved&quot;</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-68-62"><a id="__codelineno-68-62" name="__codelineno-68-62"></a><span class="w">    </span><span class="p">})</span>
</span><span id="__span-68-63"><a id="__codelineno-68-63" name="__codelineno-68-63"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="nx">nodeReject</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-68-64"><a id="__codelineno-68-64" name="__codelineno-68-64"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="s">&quot;status&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;rejected&quot;</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-68-65"><a id="__codelineno-68-65" name="__codelineno-68-65"></a><span class="w">    </span><span class="p">})</span>
</span><span id="__span-68-66"><a id="__codelineno-68-66" name="__codelineno-68-66"></a>
</span><span id="__span-68-67"><a id="__codelineno-68-67" name="__codelineno-68-67"></a><span class="w">    </span><span class="c1">// Wire the flow</span>
</span><span id="__span-68-68"><a id="__codelineno-68-68" name="__codelineno-68-68"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">SetEntryPoint</span><span class="p">(</span><span class="nx">nodeAIReview</span><span class="p">)</span>
</span><span id="__span-68-69"><a id="__codelineno-68-69" name="__codelineno-68-69"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddConditionalEdges</span><span class="p">(</span><span class="nx">nodeHumanReview</span><span class="p">,</span>
</span><span id="__span-68-70"><a id="__codelineno-68-70" name="__codelineno-68-70"></a><span class="w">        </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-68-71"><a id="__codelineno-68-71" name="__codelineno-68-71"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">s</span><span class="p">[</span><span class="nx">stateKeyDecision</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;approve&quot;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-68-72"><a id="__codelineno-68-72" name="__codelineno-68-72"></a><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nx">routeApprove</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-68-73"><a id="__codelineno-68-73" name="__codelineno-68-73"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-68-74"><a id="__codelineno-68-74" name="__codelineno-68-74"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">routeReject</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-68-75"><a id="__codelineno-68-75" name="__codelineno-68-75"></a><span class="w">        </span><span class="p">},</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span>
</span><span id="__span-68-76"><a id="__codelineno-68-76" name="__codelineno-68-76"></a><span class="w">            </span><span class="nx">routeApprove</span><span class="p">:</span><span class="w"> </span><span class="nx">nodeApprove</span><span class="p">,</span>
</span><span id="__span-68-77"><a id="__codelineno-68-77" name="__codelineno-68-77"></a><span class="w">            </span><span class="nx">routeReject</span><span class="p">:</span><span class="w">  </span><span class="nx">nodeReject</span><span class="p">,</span>
</span><span id="__span-68-78"><a id="__codelineno-68-78" name="__codelineno-68-78"></a><span class="w">        </span><span class="p">})</span>
</span><span id="__span-68-79"><a id="__codelineno-68-79" name="__codelineno-68-79"></a>
</span><span id="__span-68-80"><a id="__codelineno-68-80" name="__codelineno-68-80"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">sg</span><span class="p">.</span><span class="nx">Compile</span><span class="p">()</span>
</span><span id="__span-68-81"><a id="__codelineno-68-81" name="__codelineno-68-81"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<h2 id="summary">Summary</h2>
<p>This guide introduced the core usage of the <code>graph</code> package and GraphAgent: declaring nodes and routes, safely merging state via Schema + Reducers, and leveraging events, checkpoints, and interrupts for observability and recovery. For structured flows (approvals, content moderation, stepwise processing), Graph provides stable, auditable execution. For intelligent decisions, extend with LLM nodes and sub‑agents.</p>
<h2 id="references-examples">References &amp; Examples</h2>
<ul>
<li>Repository: https://github.com/trpc-group/trpc-agent-go</li>
<li>Graph examples: <code>examples/graph</code> (basic/parallel/multi‑turn/interrupts and recovery)<ul>
<li>I/O conventions: <code>io_conventions</code>, <code>io_conventions_tools</code></li>
<li>Parallel/fan‑out: <code>parallel</code>, <code>fanout</code>, <code>diamond</code></li>
<li>Placeholders: <code>placeholder</code></li>
<li>Checkpoints/interrupts: <code>checkpoint</code>, <code>interrupt</code></li>
</ul>
</li>
<li>Further reading: <code>graph/state_graph.go</code>, <code>graph/executor.go</code>, <code>agent/graphagent</code></li>
</ul>







  
    
  
  
    
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Last update">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_datetime" title="October 27, 2025 09:18:32 UTC">2025-10-27 09:18:32</span>
  </span>

    
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Created">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_datetime" title="August 25, 2025 07:06:16 UTC">2025-08-25 07:06:16</span>
  </span>

    
    
    
  </aside>


  



  <form class="md-feedback" name="feedback" hidden>
    <fieldset>
      <legend class="md-feedback__title">
        Was this page helpful?
      </legend>
      <div class="md-feedback__inner">
        <div class="md-feedback__list">
          
            <button class="md-feedback__icon md-icon" type="submit" title="This page was helpful" data-md-value="1">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m7 0c0 .8-.7 1.5-1.5 1.5S14 10.3 14 9.5 14.7 8 15.5 8s1.5.7 1.5 1.5m-5 7.73c-1.75 0-3.29-.73-4.19-1.81L9.23 14c.45.72 1.52 1.23 2.77 1.23s2.32-.51 2.77-1.23l1.42 1.42c-.9 1.08-2.44 1.81-4.19 1.81"/></svg>
            </button>
          
            <button class="md-feedback__icon md-icon" type="submit" title="This page could be improved" data-md-value="0">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10m-6.5-4c.8 0 1.5.7 1.5 1.5s-.7 1.5-1.5 1.5-1.5-.7-1.5-1.5.7-1.5 1.5-1.5M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m2 4.5c1.75 0 3.29.72 4.19 1.81l-1.42 1.42C14.32 16.5 13.25 16 12 16s-2.32.5-2.77 1.23l-1.42-1.42C8.71 14.72 10.25 14 12 14"/></svg>
            </button>
          
        </div>
        <div class="md-feedback__note">
          
            <div data-md-value="1" hidden>
              
              
                
              
              
              
                
                
              
              Thanks for your feedback!
            </div>
          
            <div data-md-value="0" hidden>
              
              
                
              
              
              
                
                
              
              Thanks for your feedback!<br>Please help us improve by opening an <a href="https://github.com/trpc-group/trpc-agent-go/issues/new" target="_blank" rel="noopener">issue</a>.
            </div>
          
        </div>
      </div>
    </fieldset>
  </form>


                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../multiagent/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Multi Agent">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                Multi Agent
              </div>
            </div>
          </a>
        
        
          
          <a href="../custom-agent/" class="md-footer__link md-footer__link--next" aria-label="Next: Custom Agent">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                Custom Agent
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": ["content.code.copy", "navigation.footer", "navigation.tabs", "search.suggest", "search.share", "content.action.edit", "content.action.view"], "search": "../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.92b07e13.min.js"></script>
      
    
  </body>
</html>