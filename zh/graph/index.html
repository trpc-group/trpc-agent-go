
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://trpc-group.github.io/trpc-agent-go/zh/graph/">
      
      
        <link rel="prev" href="../team/">
      
      
        <link rel="next" href="../custom-agent/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.17">
    
    
      
        <title>Graph Agent - tRPC-Agent-Go</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.7e37652d.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config",""),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#graph" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../" title="tRPC-Agent-Go" class="md-header__button md-logo" aria-label="tRPC-Agent-Go" data-md-component="logo">
      
  <img src="../../assets/img/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            tRPC-Agent-Go
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Graph Agent
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
      <div class="md-header__option">
  <div class="md-select">
    
    <button class="md-header__button md-icon" aria-label="选择当前语言">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m12.87 15.07-2.54-2.51.03-.03A17.5 17.5 0 0 0 14.07 6H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2zm-2.62 7 1.62-4.33L19.12 17z"/></svg>
    </button>
    <div class="md-select__inner">
      <ul class="md-select__list">
        
          <li class="md-select__item">
            <a href="../../graph/" hreflang="en" class="md-select__link">
              English
            </a>
          </li>
        
          <li class="md-select__item">
            <a href="./" hreflang="zh" class="md-select__link">
              中文
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</div>
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="分享" aria-label="分享" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/trpc-group/trpc-agent-go" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    trpc-group/trpc-agent-go
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../" class="md-tabs__link">
        
  
  
    
  
  概览

      </a>
    </li>
  

      
        
  
  
  
    
  
  
    
    
      
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../agent/" class="md-tabs__link">
          
  
  
  组件

        </a>
      </li>
    
  

    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../agui/" class="md-tabs__link">
          
  
  
  服务

        </a>
      </li>
    
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../observability/" class="md-tabs__link">
        
  
  
    
  
  可观测

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../ecosystem/" class="md-tabs__link">
        
  
  
    
  
  生态

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../" title="tRPC-Agent-Go" class="md-nav__button md-logo" aria-label="tRPC-Agent-Go" data-md-component="logo">
      
  <img src="../../assets/img/logo.png" alt="logo">

    </a>
    tRPC-Agent-Go
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/trpc-group/trpc-agent-go" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    trpc-group/trpc-agent-go
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    概览
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    组件
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            组件
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1" checked>
        
          
          <label class="md-nav__link" for="__nav_2_1" id="__nav_2_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Agent
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_1">
            <span class="md-nav__icon md-icon"></span>
            Agent
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Agent
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../multiagent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Multi Agent
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../team/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Team
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Graph Agent
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Graph Agent
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      概述
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      快速开始
    </span>
  </a>
  
    <nav class="md-nav" aria-label="快速开始">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      最小工作流
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      使用模式
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agent" class="md-nav__link">
    <span class="md-ellipsis">
      Agent 集成
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      主要特性
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      核心概念
    </span>
  </a>
  
    <nav class="md-nav" aria-label="核心概念">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-graph" class="md-nav__link">
    <span class="md-ellipsis">
      1. 图 (Graph)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-node" class="md-nav__link">
    <span class="md-ellipsis">
      2. 节点 (Node)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-state" class="md-nav__link">
    <span class="md-ellipsis">
      3. 状态 (State)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-stateschema" class="md-nav__link">
    <span class="md-ellipsis">
      4. 状态模式 (StateSchema)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      使用指南
    </span>
  </a>
  
    <nav class="md-nav" aria-label="使用指南">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#io" class="md-nav__link">
    <span class="md-ellipsis">
      节点 I/O 约定
    </span>
  </a>
  
    <nav class="md-nav" aria-label="节点 I/O 约定">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      状态键常量与来源（可直接引用）
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#statedelta" class="md-nav__link">
    <span class="md-ellipsis">
      事件元数据键（StateDelta）
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#eventemitter" class="md-nav__link">
    <span class="md-ellipsis">
      节点主动外抛事件（EventEmitter）
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1-graphagent-runner" class="md-nav__link">
    <span class="md-ellipsis">
      1. 创建 GraphAgent 和 Runner
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-llm" class="md-nav__link">
    <span class="md-ellipsis">
      2. 使用 LLM 节点
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. 使用 LLM 节点">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vs" class="md-nav__link">
    <span class="md-ellipsis">
      事件输出（流式分片 vs 最终消息）
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      三种输入范式
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llm" class="md-nav__link">
    <span class="md-ellipsis">
      LLM 指令中的占位符
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reducer-messageop" class="md-nav__link">
    <span class="md-ellipsis">
      通过 Reducer 与 MessageOp 实现的原子更新
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#removeallmessages" class="md-nav__link">
    <span class="md-ellipsis">
      使用 RemoveAllMessages 清除消息历史
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-graphagent" class="md-nav__link">
    <span class="md-ellipsis">
      3. GraphAgent 配置选项
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. GraphAgent 配置选项">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      摘要格式自定义
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    <span class="md-ellipsis">
      并发使用注意事项
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agent-agent" class="md-nav__link">
    <span class="md-ellipsis">
      Agent 节点：把上游输出传给下游 Agent
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agent_1" class="md-nav__link">
    <span class="md-ellipsis">
      Agent 节点：拼接原始输入与上游输出
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agent_2" class="md-nav__link">
    <span class="md-ellipsis">
      Agent 节点：输入/输出映射（进阶）
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agent_3" class="md-nav__link">
    <span class="md-ellipsis">
      Agent 节点：隔离与工具多轮
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agent_4" class="md-nav__link">
    <span class="md-ellipsis">
      Agent 节点：检查点与嵌套中断
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4" class="md-nav__link">
    <span class="md-ellipsis">
      4. 条件路由
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#41-ends" class="md-nav__link">
    <span class="md-ellipsis">
      4.1 节点命名分支（Ends）
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42" class="md-nav__link">
    <span class="md-ellipsis">
      4.2 多条件扇出（并行）
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5" class="md-nav__link">
    <span class="md-ellipsis">
      5. 工具节点集成
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6" class="md-nav__link">
    <span class="md-ellipsis">
      6. 节点重试与退避
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#7-runner" class="md-nav__link">
    <span class="md-ellipsis">
      7. Runner 配置
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#8" class="md-nav__link">
    <span class="md-ellipsis">
      8. 消息状态模式
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#9" class="md-nav__link">
    <span class="md-ellipsis">
      9. 状态键使用场景
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    <span class="md-ellipsis">
      高级功能
    </span>
  </a>
  
    <nav class="md-nav" aria-label="高级功能">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    <span class="md-ellipsis">
      1. 中断和恢复（人机协作）
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1. 中断和恢复（人机协作）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    <span class="md-ellipsis">
      基本用法
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    <span class="md-ellipsis">
      2. 静态中断（调试断点）
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    <span class="md-ellipsis">
      执行方式
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#graphagent" class="md-nav__link">
    <span class="md-ellipsis">
      GraphAgent 配置选项
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_15" class="md-nav__link">
    <span class="md-ellipsis">
      核心概念
    </span>
  </a>
  
    <nav class="md-nav" aria-label="核心概念">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_16" class="md-nav__link">
    <span class="md-ellipsis">
      状态管理
    </span>
  </a>
  
    <nav class="md-nav" aria-label="状态管理">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#schema" class="md-nav__link">
    <span class="md-ellipsis">
      使用内置 Schema
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#schema_1" class="md-nav__link">
    <span class="md-ellipsis">
      自定义 Schema
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_17" class="md-nav__link">
    <span class="md-ellipsis">
      节点类型
    </span>
  </a>
  
    <nav class="md-nav" aria-label="节点类型">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#function" class="md-nav__link">
    <span class="md-ellipsis">
      Function 节点
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llm_1" class="md-nav__link">
    <span class="md-ellipsis">
      LLM 节点
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cache" class="md-nav__link">
    <span class="md-ellipsis">
      节点缓存（Cache）
    </span>
  </a>
  
    <nav class="md-nav" aria-label="节点缓存（Cache）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tools" class="md-nav__link">
    <span class="md-ellipsis">
      Tools 节点
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#state" class="md-nav__link">
    <span class="md-ellipsis">
      将工具结果写入 State
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_18" class="md-nav__link">
    <span class="md-ellipsis">
      边与路由
    </span>
  </a>
  
    <nav class="md-nav" aria-label="边与路由">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#join" class="md-nav__link">
    <span class="md-ellipsis">
      Join（等待所有分支的汇聚）
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_19" class="md-nav__link">
    <span class="md-ellipsis">
      消息可见性选项
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fan-out" class="md-nav__link">
    <span class="md-ellipsis">
      命令模式（动态路由 / Fan-out）
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_20" class="md-nav__link">
    <span class="md-ellipsis">
      架构设计
    </span>
  </a>
  
    <nav class="md-nav" aria-label="架构设计">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_21" class="md-nav__link">
    <span class="md-ellipsis">
      整体架构
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_22" class="md-nav__link">
    <span class="md-ellipsis">
      核心模块解析
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_23" class="md-nav__link">
    <span class="md-ellipsis">
      执行模型
    </span>
  </a>
  
    <nav class="md-nav" aria-label="执行模型">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_24" class="md-nav__link">
    <span class="md-ellipsis">
      运行态隔离与事件快照
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_25" class="md-nav__link">
    <span class="md-ellipsis">
      执行器配置
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#agent_5" class="md-nav__link">
    <span class="md-ellipsis">
      与多 Agent 系统集成
    </span>
  </a>
  
    <nav class="md-nav" aria-label="与多 Agent 系统集成">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#graphagent-agent" class="md-nav__link">
    <span class="md-ellipsis">
      GraphAgent 作为 Agent
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_26" class="md-nav__link">
    <span class="md-ellipsis">
      高级编排
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agent_6" class="md-nav__link">
    <span class="md-ellipsis">
      在图中嵌入 Agent
    </span>
  </a>
  
    <nav class="md-nav" aria-label="在图中嵌入 Agent">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#last_response-user_input" class="md-nav__link">
    <span class="md-ellipsis">
      只传结果：将 last_response 映射为下游 user_input
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_27" class="md-nav__link">
    <span class="md-ellipsis">
      混合模式示例
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_28" class="md-nav__link">
    <span class="md-ellipsis">
      核心机制详解
    </span>
  </a>
  
    <nav class="md-nav" aria-label="核心机制详解">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#schema-reducer" class="md-nav__link">
    <span class="md-ellipsis">
      状态管理：Schema + Reducer 模式
    </span>
  </a>
  
    <nav class="md-nav" aria-label="状态管理：Schema + Reducer 模式">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_29" class="md-nav__link">
    <span class="md-ellipsis">
      常用键常量参考
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_30" class="md-nav__link">
    <span class="md-ellipsis">
      节点级回调、工具与生成参数
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#call-options-run" class="md-nav__link">
    <span class="md-ellipsis">
      调用级 Call Options（按本次 Run 覆盖）
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#graph-toolset-agent" class="md-nav__link">
    <span class="md-ellipsis">
      Graph 中的 ToolSet 与 Agent 的区别
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llm_2" class="md-nav__link">
    <span class="md-ellipsis">
      LLM 输入规则：三段式设计
    </span>
  </a>
  
    <nav class="md-nav" aria-label="LLM 输入规则：三段式设计">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_31" class="md-nav__link">
    <span class="md-ellipsis">
      指令占位符注入
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_32" class="md-nav__link">
    <span class="md-ellipsis">
      并发执行和状态安全
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#io_1" class="md-nav__link">
    <span class="md-ellipsis">
      节点 I/O 约定与常用键
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#api" class="md-nav__link">
    <span class="md-ellipsis">
      API 速查表
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dot" class="md-nav__link">
    <span class="md-ellipsis">
      可视化导出（DOT/图片）
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_33" class="md-nav__link">
    <span class="md-ellipsis">
      高级特性
    </span>
  </a>
  
    <nav class="md-nav" aria-label="高级特性">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_34" class="md-nav__link">
    <span class="md-ellipsis">
      检查点与恢复
    </span>
  </a>
  
    <nav class="md-nav" aria-label="检查点与恢复">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_35" class="md-nav__link">
    <span class="md-ellipsis">
      检查点管理
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_36" class="md-nav__link">
    <span class="md-ellipsis">
      默认值与注意事项
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_37" class="md-nav__link">
    <span class="md-ellipsis">
      事件速览
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#human-in-the-loop" class="md-nav__link">
    <span class="md-ellipsis">
      Human-in-the-Loop
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Human-in-the-Loop">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#graphagent_1" class="md-nav__link">
    <span class="md-ellipsis">
      嵌套图（子 GraphAgent 中断）
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_38" class="md-nav__link">
    <span class="md-ellipsis">
      事件监控
    </span>
  </a>
  
    <nav class="md-nav" aria-label="事件监控">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#streammode" class="md-nav__link">
    <span class="md-ellipsis">
      StreamMode
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#statedelta_1" class="md-nav__link">
    <span class="md-ellipsis">
      事件元数据（StateDelta）
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_39" class="md-nav__link">
    <span class="md-ellipsis">
      在节点回调中携带业务值
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_40" class="md-nav__link">
    <span class="md-ellipsis">
      常见问题排查
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_41" class="md-nav__link">
    <span class="md-ellipsis">
      实际案例
    </span>
  </a>
  
    <nav class="md-nav" aria-label="实际案例">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_42" class="md-nav__link">
    <span class="md-ellipsis">
      审批工作流
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_43" class="md-nav__link">
    <span class="md-ellipsis">
      总结
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_44" class="md-nav__link">
    <span class="md-ellipsis">
      参考与示例
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../custom-agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    自定义 Agent
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../dify/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Dify Agent
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../runner/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Runner
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../model/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Model
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../callbacks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Callbacks
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../plugin/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    插件
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../memory/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Memory
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../artifact/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Artifact
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../skill/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Skill
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tool/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Tool
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../session/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Session
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_11" >
        
          
          <label class="md-nav__link" for="__nav_2_11" id="__nav_2_11_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Knowledge
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_11">
            <span class="md-nav__icon md-icon"></span>
            Knowledge
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../knowledge/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    概述
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../knowledge/embedder/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Embedder
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../knowledge/reranker/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Reranker
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../knowledge/source/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    数据源
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../knowledge/filter/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    过滤器
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../knowledge/management/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    知识库管理
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../knowledge/ocr/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    OCR
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_11_8" >
        
          
          <label class="md-nav__link" for="__nav_2_11_8" id="__nav_2_11_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    向量存储
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_11_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_11_8">
            <span class="md-nav__icon md-icon"></span>
            向量存储
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../knowledge/vectorstore/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    概述
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../knowledge/vectorstore/inmemory/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Memory
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../knowledge/vectorstore/pgvector/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    PGVector
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../knowledge/vectorstore/tcvector/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    TcVector
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../knowledge/vectorstore/elasticsearch/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Elasticsearch
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../knowledge/vectorstore/qdrant/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Qdrant
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../knowledge/vectorstore/milvus/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Milvus
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../knowledge/troubleshooting/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    故障排除
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../planner/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Planner
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../event/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Event
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../evaluation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Evaluation
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    服务
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            服务
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../agui/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    AG-UI
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../a2a/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    A2A
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../observability/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    可观测
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../ecosystem/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    生态
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      概述
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      快速开始
    </span>
  </a>
  
    <nav class="md-nav" aria-label="快速开始">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      最小工作流
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      使用模式
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agent" class="md-nav__link">
    <span class="md-ellipsis">
      Agent 集成
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      主要特性
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      核心概念
    </span>
  </a>
  
    <nav class="md-nav" aria-label="核心概念">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-graph" class="md-nav__link">
    <span class="md-ellipsis">
      1. 图 (Graph)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-node" class="md-nav__link">
    <span class="md-ellipsis">
      2. 节点 (Node)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-state" class="md-nav__link">
    <span class="md-ellipsis">
      3. 状态 (State)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-stateschema" class="md-nav__link">
    <span class="md-ellipsis">
      4. 状态模式 (StateSchema)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      使用指南
    </span>
  </a>
  
    <nav class="md-nav" aria-label="使用指南">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#io" class="md-nav__link">
    <span class="md-ellipsis">
      节点 I/O 约定
    </span>
  </a>
  
    <nav class="md-nav" aria-label="节点 I/O 约定">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      状态键常量与来源（可直接引用）
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#statedelta" class="md-nav__link">
    <span class="md-ellipsis">
      事件元数据键（StateDelta）
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#eventemitter" class="md-nav__link">
    <span class="md-ellipsis">
      节点主动外抛事件（EventEmitter）
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1-graphagent-runner" class="md-nav__link">
    <span class="md-ellipsis">
      1. 创建 GraphAgent 和 Runner
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-llm" class="md-nav__link">
    <span class="md-ellipsis">
      2. 使用 LLM 节点
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. 使用 LLM 节点">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#vs" class="md-nav__link">
    <span class="md-ellipsis">
      事件输出（流式分片 vs 最终消息）
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      三种输入范式
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llm" class="md-nav__link">
    <span class="md-ellipsis">
      LLM 指令中的占位符
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reducer-messageop" class="md-nav__link">
    <span class="md-ellipsis">
      通过 Reducer 与 MessageOp 实现的原子更新
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#removeallmessages" class="md-nav__link">
    <span class="md-ellipsis">
      使用 RemoveAllMessages 清除消息历史
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-graphagent" class="md-nav__link">
    <span class="md-ellipsis">
      3. GraphAgent 配置选项
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. GraphAgent 配置选项">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      摘要格式自定义
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    <span class="md-ellipsis">
      并发使用注意事项
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agent-agent" class="md-nav__link">
    <span class="md-ellipsis">
      Agent 节点：把上游输出传给下游 Agent
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agent_1" class="md-nav__link">
    <span class="md-ellipsis">
      Agent 节点：拼接原始输入与上游输出
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agent_2" class="md-nav__link">
    <span class="md-ellipsis">
      Agent 节点：输入/输出映射（进阶）
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agent_3" class="md-nav__link">
    <span class="md-ellipsis">
      Agent 节点：隔离与工具多轮
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agent_4" class="md-nav__link">
    <span class="md-ellipsis">
      Agent 节点：检查点与嵌套中断
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4" class="md-nav__link">
    <span class="md-ellipsis">
      4. 条件路由
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#41-ends" class="md-nav__link">
    <span class="md-ellipsis">
      4.1 节点命名分支（Ends）
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42" class="md-nav__link">
    <span class="md-ellipsis">
      4.2 多条件扇出（并行）
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5" class="md-nav__link">
    <span class="md-ellipsis">
      5. 工具节点集成
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6" class="md-nav__link">
    <span class="md-ellipsis">
      6. 节点重试与退避
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#7-runner" class="md-nav__link">
    <span class="md-ellipsis">
      7. Runner 配置
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#8" class="md-nav__link">
    <span class="md-ellipsis">
      8. 消息状态模式
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#9" class="md-nav__link">
    <span class="md-ellipsis">
      9. 状态键使用场景
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    <span class="md-ellipsis">
      高级功能
    </span>
  </a>
  
    <nav class="md-nav" aria-label="高级功能">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    <span class="md-ellipsis">
      1. 中断和恢复（人机协作）
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1. 中断和恢复（人机协作）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    <span class="md-ellipsis">
      基本用法
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    <span class="md-ellipsis">
      2. 静态中断（调试断点）
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    <span class="md-ellipsis">
      执行方式
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#graphagent" class="md-nav__link">
    <span class="md-ellipsis">
      GraphAgent 配置选项
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_15" class="md-nav__link">
    <span class="md-ellipsis">
      核心概念
    </span>
  </a>
  
    <nav class="md-nav" aria-label="核心概念">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_16" class="md-nav__link">
    <span class="md-ellipsis">
      状态管理
    </span>
  </a>
  
    <nav class="md-nav" aria-label="状态管理">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#schema" class="md-nav__link">
    <span class="md-ellipsis">
      使用内置 Schema
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#schema_1" class="md-nav__link">
    <span class="md-ellipsis">
      自定义 Schema
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_17" class="md-nav__link">
    <span class="md-ellipsis">
      节点类型
    </span>
  </a>
  
    <nav class="md-nav" aria-label="节点类型">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#function" class="md-nav__link">
    <span class="md-ellipsis">
      Function 节点
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llm_1" class="md-nav__link">
    <span class="md-ellipsis">
      LLM 节点
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cache" class="md-nav__link">
    <span class="md-ellipsis">
      节点缓存（Cache）
    </span>
  </a>
  
    <nav class="md-nav" aria-label="节点缓存（Cache）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tools" class="md-nav__link">
    <span class="md-ellipsis">
      Tools 节点
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#state" class="md-nav__link">
    <span class="md-ellipsis">
      将工具结果写入 State
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_18" class="md-nav__link">
    <span class="md-ellipsis">
      边与路由
    </span>
  </a>
  
    <nav class="md-nav" aria-label="边与路由">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#join" class="md-nav__link">
    <span class="md-ellipsis">
      Join（等待所有分支的汇聚）
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_19" class="md-nav__link">
    <span class="md-ellipsis">
      消息可见性选项
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fan-out" class="md-nav__link">
    <span class="md-ellipsis">
      命令模式（动态路由 / Fan-out）
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_20" class="md-nav__link">
    <span class="md-ellipsis">
      架构设计
    </span>
  </a>
  
    <nav class="md-nav" aria-label="架构设计">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_21" class="md-nav__link">
    <span class="md-ellipsis">
      整体架构
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_22" class="md-nav__link">
    <span class="md-ellipsis">
      核心模块解析
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_23" class="md-nav__link">
    <span class="md-ellipsis">
      执行模型
    </span>
  </a>
  
    <nav class="md-nav" aria-label="执行模型">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_24" class="md-nav__link">
    <span class="md-ellipsis">
      运行态隔离与事件快照
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_25" class="md-nav__link">
    <span class="md-ellipsis">
      执行器配置
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#agent_5" class="md-nav__link">
    <span class="md-ellipsis">
      与多 Agent 系统集成
    </span>
  </a>
  
    <nav class="md-nav" aria-label="与多 Agent 系统集成">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#graphagent-agent" class="md-nav__link">
    <span class="md-ellipsis">
      GraphAgent 作为 Agent
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_26" class="md-nav__link">
    <span class="md-ellipsis">
      高级编排
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agent_6" class="md-nav__link">
    <span class="md-ellipsis">
      在图中嵌入 Agent
    </span>
  </a>
  
    <nav class="md-nav" aria-label="在图中嵌入 Agent">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#last_response-user_input" class="md-nav__link">
    <span class="md-ellipsis">
      只传结果：将 last_response 映射为下游 user_input
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_27" class="md-nav__link">
    <span class="md-ellipsis">
      混合模式示例
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_28" class="md-nav__link">
    <span class="md-ellipsis">
      核心机制详解
    </span>
  </a>
  
    <nav class="md-nav" aria-label="核心机制详解">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#schema-reducer" class="md-nav__link">
    <span class="md-ellipsis">
      状态管理：Schema + Reducer 模式
    </span>
  </a>
  
    <nav class="md-nav" aria-label="状态管理：Schema + Reducer 模式">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_29" class="md-nav__link">
    <span class="md-ellipsis">
      常用键常量参考
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_30" class="md-nav__link">
    <span class="md-ellipsis">
      节点级回调、工具与生成参数
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#call-options-run" class="md-nav__link">
    <span class="md-ellipsis">
      调用级 Call Options（按本次 Run 覆盖）
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#graph-toolset-agent" class="md-nav__link">
    <span class="md-ellipsis">
      Graph 中的 ToolSet 与 Agent 的区别
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llm_2" class="md-nav__link">
    <span class="md-ellipsis">
      LLM 输入规则：三段式设计
    </span>
  </a>
  
    <nav class="md-nav" aria-label="LLM 输入规则：三段式设计">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_31" class="md-nav__link">
    <span class="md-ellipsis">
      指令占位符注入
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_32" class="md-nav__link">
    <span class="md-ellipsis">
      并发执行和状态安全
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#io_1" class="md-nav__link">
    <span class="md-ellipsis">
      节点 I/O 约定与常用键
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#api" class="md-nav__link">
    <span class="md-ellipsis">
      API 速查表
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dot" class="md-nav__link">
    <span class="md-ellipsis">
      可视化导出（DOT/图片）
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_33" class="md-nav__link">
    <span class="md-ellipsis">
      高级特性
    </span>
  </a>
  
    <nav class="md-nav" aria-label="高级特性">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_34" class="md-nav__link">
    <span class="md-ellipsis">
      检查点与恢复
    </span>
  </a>
  
    <nav class="md-nav" aria-label="检查点与恢复">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_35" class="md-nav__link">
    <span class="md-ellipsis">
      检查点管理
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_36" class="md-nav__link">
    <span class="md-ellipsis">
      默认值与注意事项
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_37" class="md-nav__link">
    <span class="md-ellipsis">
      事件速览
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#human-in-the-loop" class="md-nav__link">
    <span class="md-ellipsis">
      Human-in-the-Loop
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Human-in-the-Loop">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#graphagent_1" class="md-nav__link">
    <span class="md-ellipsis">
      嵌套图（子 GraphAgent 中断）
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_38" class="md-nav__link">
    <span class="md-ellipsis">
      事件监控
    </span>
  </a>
  
    <nav class="md-nav" aria-label="事件监控">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#streammode" class="md-nav__link">
    <span class="md-ellipsis">
      StreamMode
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#statedelta_1" class="md-nav__link">
    <span class="md-ellipsis">
      事件元数据（StateDelta）
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_39" class="md-nav__link">
    <span class="md-ellipsis">
      在节点回调中携带业务值
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_40" class="md-nav__link">
    <span class="md-ellipsis">
      常见问题排查
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_41" class="md-nav__link">
    <span class="md-ellipsis">
      实际案例
    </span>
  </a>
  
    <nav class="md-nav" aria-label="实际案例">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_42" class="md-nav__link">
    <span class="md-ellipsis">
      审批工作流
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_43" class="md-nav__link">
    <span class="md-ellipsis">
      总结
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_44" class="md-nav__link">
    <span class="md-ellipsis">
      参考与示例
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
    <a href="https://github.com/trpc-group/trpc-agent-go/edit/main/docs/mkdocs/zh/graph.md" title="编辑此页" class="md-content__button md-icon" rel="edit">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg>
    </a>
  
  
    
      
    
    <a href="https://github.com/trpc-group/trpc-agent-go/raw/main/docs/mkdocs/zh/graph.md" title="查看本页的源代码" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 18c.56 0 1 .44 1 1s-.44 1-1 1-1-.44-1-1 .44-1 1-1m0-3c-2.73 0-5.06 1.66-6 4 .94 2.34 3.27 4 6 4s5.06-1.66 6-4c-.94-2.34-3.27-4-6-4m0 6.5a2.5 2.5 0 0 1-2.5-2.5 2.5 2.5 0 0 1 2.5-2.5 2.5 2.5 0 0 1 2.5 2.5 2.5 2.5 0 0 1-2.5 2.5M9.27 20H6V4h7v5h5v4.07c.7.08 1.36.25 2 .49V8l-6-6H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h4.5a8.2 8.2 0 0 1-1.23-2"/></svg>
    </a>
  


<h1 id="graph">Graph 包使用指南</h1>
<h2 id="_1">概述</h2>
<p>Graph 将可控的工作流编排与可扩展的 Agent 能力结合，适用于：</p>
<ul>
<li>类型安全的状态管理与可预测路由；</li>
<li>LLM 决策、工具调用循环、可选的 Human in the Loop（HITL）；</li>
<li>可复用的组件，既可独立运行，也可作为子 Agent 组合。</li>
</ul>
<p>特点：</p>
<ul>
<li>Schema 驱动的 State 与 Reducer，避免并发分支写入同一字段时的数据竞争；</li>
<li>BSP 风格（计划/执行/合并）的确定性并行；</li>
<li>内置节点类型封装 LLM、工具与 Agent，减少重复代码；</li>
<li>流式事件、检查点与中断，便于观测与恢复。</li>
<li>节点级重试/退避（指数退避与抖动），支持执行器默认重试策略与带重试元数据的事件观测。</li>
<li>节点主动外抛事件（EventEmitter），支持在 NodeFunc 中发射自定义事件、进度更新和流式文本。</li>
</ul>
<h2 id="_2">快速开始</h2>
<h3 id="_3">最小工作流</h3>
<p>下面是一个经典的“prepare → ask LLM → 可能调用工具”的循环，使用 <code>graph.MessagesStateSchema()</code>（已定义 <code>graph.StateKeyMessages</code>、<code>graph.StateKeyUserInput</code>、<code>graph.StateKeyLastResponse</code> 等键）。</p>
<pre class="mermaid"><code>flowchart LR
    START([start]):::startNode --&gt; P[prepare]:::processNode
    P --&gt; A[ask LLM]:::llmNode
    A -. tool_calls .-&gt; T[tools]:::toolNode
    A -- no tool_calls --&gt; F[fallback]:::processNode
    T --&gt; A
    F --&gt; END([finish]):::endNode

    classDef startNode fill:#e1f5e1,stroke:#4caf50,stroke-width:2px
    classDef endNode fill:#ffe1e1,stroke:#f44336,stroke-width:2px
    classDef llmNode fill:#e3f2fd,stroke:#2196f3,stroke-width:2px
    classDef toolNode fill:#fff3e0,stroke:#ff9800,stroke-width:2px
    classDef processNode fill:#f3e5f5,stroke:#9c27b0,stroke-width:2px</code></pre>
<p>Graph 包允许您将复杂的 AI 工作流建模为有向图，其中节点代表处理步骤，边代表数据流和控制流。它特别适合构建需要条件路由、状态管理和多步骤处理的 AI 应用。</p>
<h3 id="_4">使用模式</h3>
<p>Graph 包的使用遵循以下模式：</p>
<ol>
<li><strong>创建 Graph</strong>：使用 <code>StateGraph</code> 构建器定义工作流结构</li>
<li><strong>创建 GraphAgent</strong>：将编译后的 Graph 包装为 Agent</li>
<li><strong>创建 Runner</strong>：使用 Runner 管理会话和执行环境</li>
<li><strong>执行工作流</strong>：通过 Runner 执行工作流并处理结果</li>
</ol>
<p>这种模式提供了：</p>
<ul>
<li><strong>类型安全</strong>：通过状态模式确保数据一致性</li>
<li><strong>会话管理</strong>：支持多用户、多会话的并发执行</li>
<li><strong>事件流</strong>：实时监控工作流执行进度</li>
<li><strong>错误处理</strong>：统一的错误处理和恢复机制</li>
</ul>
<h3 id="agent">Agent 集成</h3>
<p>GraphAgent 实现了 <code>agent.Agent</code> 接口，可以：</p>
<ul>
<li><strong>作为独立 Agent</strong>：通过 Runner 直接执行</li>
<li><strong>作为 SubAgent</strong>：被其他 Agent（如 LLMAgent）作为子 Agent 使用</li>
<li><strong>挂载 SubAgent</strong>：通过 <code>graphagent.WithSubAgents</code> 配置子 Agent，并在图中使用 <code>AddAgentNode</code> 委托执行</li>
</ul>
<p>这种设计使得 GraphAgent 既能接入其他 Agent，也能在自身工作流中灵活调度子 Agent。</p>
<h3 id="_5">主要特性</h3>
<ul>
<li><strong>类型安全的状态管理</strong>：使用 Schema 定义状态结构，支持自定义 Reducer</li>
<li><strong>条件路由</strong>：基于状态动态选择执行路径</li>
<li><strong>LLM 节点集成</strong>：内置对大型语言模型的支持</li>
<li><strong>工具节点</strong>：支持函数调用和外部工具集成</li>
<li><strong>Agent 节点</strong>：通过子 Agent 将其他 Agent 融入图中</li>
<li><strong>流式执行</strong>：支持实时事件流和进度跟踪</li>
<li><strong>并发安全</strong>：线程安全的图执行</li>
<li><strong>基于检查点的时间旅行</strong>：浏览执行历史并恢复之前的状态</li>
<li><strong>人机协作 (HITL)</strong>：支持带有中断和恢复功能的交互式工作流</li>
<li><strong>原子检查点</strong>：原子存储检查点和待写入数据，确保可靠的恢复</li>
<li><strong>检查点谱系</strong>：跟踪形成执行线程的相关检查点及其父子关系</li>
</ul>
<h2 id="_6">核心概念</h2>
<h3 id="1-graph">1. 图 (Graph)</h3>
<p>图是工作流的核心结构，由节点和边组成：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span>
<span class="normal"><a href="#__codelineno-0-2">2</a></span>
<span class="normal"><a href="#__codelineno-0-3">3</a></span>
<span class="normal"><a href="#__codelineno-0-4">4</a></span>
<span class="normal"><a href="#__codelineno-0-5">5</a></span>
<span class="normal"><a href="#__codelineno-0-6">6</a></span>
<span class="normal"><a href="#__codelineno-0-7">7</a></span>
<span class="normal"><a href="#__codelineno-0-8">8</a></span>
<span class="normal"><a href="#__codelineno-0-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="p">)</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4"></a>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="c1">// 创建状态模式</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="nx">schema</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateSchema</span><span class="p">()</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7"></a>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="c1">// 创建图</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="nx">graph</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="nx">schema</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p><strong>虚拟节点</strong>：</p>
<ul>
<li><code>Start</code>：虚拟起始节点，通过 <code>SetEntryPoint()</code> 自动连接</li>
<li><code>End</code>：虚拟结束节点，通过 <code>SetFinishPoint()</code> 自动连接</li>
<li>这些节点不需要显式创建，系统会自动处理连接</li>
</ul>
<h3 id="2-node">2. 节点 (Node)</h3>
<p>节点代表工作流中的一个处理步骤：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-1-10">10</a></span>
<span class="normal"><a href="#__codelineno-1-11">11</a></span>
<span class="normal"><a href="#__codelineno-1-12">12</a></span>
<span class="normal"><a href="#__codelineno-1-13">13</a></span>
<span class="normal"><a href="#__codelineno-1-14">14</a></span>
<span class="normal"><a href="#__codelineno-1-15">15</a></span>
<span class="normal"><a href="#__codelineno-1-16">16</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="w">    </span><span class="s">&quot;context&quot;</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3"></a>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="p">)</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6"></a>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="c1">// 节点函数签名</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="kd">type</span><span class="w"> </span><span class="nx">NodeFunc</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9"></a>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="c1">// 创建节点</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="nx">node</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">graph</span><span class="p">.</span><span class="nx">Node</span><span class="p">{</span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="w">    </span><span class="nx">ID</span><span class="p">:</span><span class="w">          </span><span class="s">&quot;process_data&quot;</span><span class="p">,</span>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="w">    </span><span class="nx">Name</span><span class="p">:</span><span class="w">        </span><span class="s">&quot;数据处理&quot;</span><span class="p">,</span>
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14"></a><span class="w">    </span><span class="nx">Description</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;处理输入数据&quot;</span><span class="p">,</span>
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="w">    </span><span class="nx">Function</span><span class="p">:</span><span class="w">    </span><span class="nx">processDataFunc</span><span class="p">,</span>
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="3-state">3. 状态 (State)</h3>
<p>状态是在节点间传递的数据容器：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-2-10">10</a></span>
<span class="normal"><a href="#__codelineno-2-11">11</a></span>
<span class="normal"><a href="#__codelineno-2-12">12</a></span>
<span class="normal"><a href="#__codelineno-2-13">13</a></span>
<span class="normal"><a href="#__codelineno-2-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="p">)</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4"></a>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="c1">// 状态是一个键值对映射</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="kd">type</span><span class="w"> </span><span class="nx">State</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">any</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7"></a>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="c1">// 用户自定义的状态键</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10"></a><span class="w">    </span><span class="nx">StateKeyInput</span><span class="w">         </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;input&quot;</span><span class="w">          </span><span class="c1">// 输入数据</span>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11"></a><span class="w">    </span><span class="nx">StateKeyResult</span><span class="w">        </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;result&quot;</span><span class="w">         </span><span class="c1">// 处理结果</span>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12"></a><span class="w">    </span><span class="nx">StateKeyProcessedData</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;processed_data&quot;</span><span class="w"> </span><span class="c1">// 处理后的数据</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13"></a><span class="w">    </span><span class="nx">StateKeyStatus</span><span class="w">        </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;status&quot;</span><span class="w">         </span><span class="c1">// 处理状态</span>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14"></a><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p><strong>内置状态键</strong>：</p>
<p>Graph 包提供了一些内置状态键，主要用于系统内部通信：</p>
<p><strong>用户可访问的内置键</strong>：</p>
<ul>
<li><code>StateKeyUserInput</code>：用户输入（一次性，消费后清空，由 LLM 节点自动持久化）</li>
<li><code>StateKeyOneShotMessages</code>：一次性消息（完整覆盖本轮输入，消费后清空）</li>
<li><code>StateKeyLastResponse</code>：最后响应（用于设置最终输出，Executor 会读取此值作为结果）</li>
<li><code>StateKeyLastToolResponse</code>：最近一次工具输出（JSON 字符串，由 Tools 节点写入）</li>
<li><code>StateKeyLastResponseID</code>：最近一次响应标识符（identifier，ID）（由 LLM 节点写入；当
  <code>StateKeyLastResponse</code> 由非模型节点写入时可能为空）</li>
<li><code>StateKeyMessages</code>：消息历史（持久化，支持 append + MessageOp 补丁操作）</li>
<li><code>StateKeyNodeResponses</code>：按节点存储的输出映射。键为节点 ID，值为该
  节点的最终输出。对 LLM / Agent 节点而言是最终文本响应；对 Tools 节
  点而言是工具输出的 JSON 数组字符串（每项包含 <code>tool_id</code>、<code>tool_name</code>
  和 <code>output</code>）。</li>
<li><code>StateKeyMetadata</code>：元数据（用户可用的通用元数据存储）</li>
</ul>
<p><strong>系统内部键</strong>（用户不应直接使用）：</p>
<ul>
<li><code>StateKeySession</code>：会话信息（由 GraphAgent 自动设置）</li>
<li><code>StateKeyExecContext</code>：执行上下文（由 Executor 自动设置）</li>
<li><code>StateKeyToolCallbacks</code>：工具回调（由 Executor 自动设置）</li>
<li><code>StateKeyModelCallbacks</code>：模型回调（由 Executor 自动设置）</li>
</ul>
<p>用户应该使用自定义状态键来存储业务数据，只在必要时使用用户可访问的内置状态键。</p>
<h3 id="4-stateschema">4. 状态模式 (StateSchema)</h3>
<p>状态模式定义状态的结构和行为：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-3-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-3-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-3-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-3-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-3-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-3-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-3-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-3-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-3-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-3-10">10</a></span>
<span class="normal"><a href="#__codelineno-3-11">11</a></span>
<span class="normal"><a href="#__codelineno-3-12">12</a></span>
<span class="normal"><a href="#__codelineno-3-13">13</a></span>
<span class="normal"><a href="#__codelineno-3-14">14</a></span>
<span class="normal"><a href="#__codelineno-3-15">15</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="w">    </span><span class="s">&quot;reflect&quot;</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3"></a>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="p">)</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6"></a>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="c1">// 创建状态模式</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8"></a><span class="nx">schema</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateSchema</span><span class="p">()</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9"></a>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10"></a><span class="c1">// 添加字段定义</span>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11"></a><span class="nx">schema</span><span class="p">.</span><span class="nx">AddField</span><span class="p">(</span><span class="s">&quot;counter&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateField</span><span class="p">{</span>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12"></a><span class="w">    </span><span class="nx">Type</span><span class="p">:</span><span class="w">    </span><span class="nx">reflect</span><span class="p">.</span><span class="nx">TypeOf</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13"></a><span class="w">    </span><span class="nx">Reducer</span><span class="p">:</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">DefaultReducer</span><span class="p">,</span>
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14"></a><span class="w">    </span><span class="nx">Default</span><span class="p">:</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="kt">any</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">},</span>
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15"></a><span class="p">})</span>
</span></code></pre></div></td></tr></table></div>
<h2 id="_7">使用指南</h2>
<h3 id="io">节点 I/O 约定</h3>
<p>节点之间仅通过共享状态 State 传递数据。每个节点返回一个 state delta，按 Schema 的 Reducer 合并到全局 State，下游节点从 State 读取上游产出。</p>
<ul>
<li>
<p>常用内置键（对用户可见）</p>
<ul>
<li><code>user_input</code>：一次性用户输入，被下一个 LLM/Agent 节点消费后清空</li>
<li><code>one_shot_messages</code>：一次性完整消息覆盖，用于下一次 LLM 调用，执行后清空</li>
<li><code>one_shot_messages_by_node</code>：按节点 ID 定向的一次性消息覆盖
  （map[nodeID][]Message）。消费后只清空对应节点的 entry。</li>
<li><code>messages</code>：持久化的消息历史（LLM/Tools 会追加），支持 MessageOp 补丁</li>
<li><code>last_response</code>：最近一次助手文本回复</li>
<li><code>last_response_id</code>：生成 <code>last_response</code> 的最近一次模型响应标识符（identifier，
  ID）。当 <code>last_response</code> 由非模型节点写入时，该值可能为空。</li>
<li><code>node_responses</code>：map[nodeID]any，按节点保存最终文本回复。最近结果用 <code>last_response</code></li>
</ul>
</li>
</ul>
<ul>
<li>
<p>函数节点（Function node）</p>
<ul>
<li>输入：完整 State</li>
<li>输出：返回 <code>graph.State</code> 增量，写入自定义键（需在 Schema 中声明），如 <code>{"parsed_time":"..."}</code></li>
</ul>
</li>
</ul>
<ul>
<li>
<p>LLM 节点</p>
<ul>
<li>输入优先级：<code>one_shot_messages_by_node[&lt;node_id&gt;]</code> →
  <code>one_shot_messages</code> → <code>user_input</code> → <code>messages</code></li>
<li>输出：<ul>
<li>向 <code>messages</code> 追加助手消息</li>
<li>设置 <code>last_response</code></li>
<li>设置 <code>last_response_id</code></li>
<li>设置 <code>node_responses[&lt;llm_node_id&gt;]</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li>
<p>Tools 节点</p>
<ul>
<li>输入：从 <code>messages</code> 中寻找最新的带 <code>tool_calls</code> 的助手消息</li>
<li>输出：向 <code>messages</code> 追加工具返回消息</li>
</ul>
</li>
</ul>
<ul>
<li>Agent 节点（子代理）<ul>
<li>输入：Graph 的 State 通过 <code>Invocation.RunOptions.RuntimeState</code> 传入子代理<ul>
<li>子代理的 Model/Tool 回调可通过 <code>agent.InvocationFromContext(ctx)</code> 访问</li>
</ul>
</li>
<li>结束输出：<ul>
<li>设置 <code>last_response</code></li>
<li>设置 <code>node_responses[&lt;agent_node_id&gt;]</code></li>
<li>清空 <code>user_input</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>推荐用法</p>
<ul>
<li>在 Schema 中声明业务字段（如 <code>parsed_time</code>、<code>final_payload</code>），函数节点写入/读取。</li>
<li>需要给 LLM 节点注入结构化提示时，可在前置节点写入 <code>one_shot_messages</code>
  （例如加入包含解析信息的 system message）。</li>
<li>并行分支：如果多个分支需要为不同的 LLM 节点准备不同的一次性输入，
  不要同时写 <code>one_shot_messages</code>，优先使用 <code>one_shot_messages_by_node</code>。</li>
<li>需要消费上游文本结果时：紧邻下游读取 <code>last_response</code>，或在任意后续节点读取
  <code>node_responses[节点ID]</code>。</li>
<li>如果下游是 Agent 节点，并希望它把上游输出当作自己的输入消息，需要显式把目标值写回
  <code>user_input</code>（例如使用 <code>WithSubgraphInputFromLastResponse()</code> 或前置回调）。</li>
</ul>
<p>按节点 ID 定向的一次性消息覆盖示例：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-4-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-4-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-4-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-4-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-4-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-4-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-4-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-4-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-4-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-4-10">10</a></span>
<span class="normal"><a href="#__codelineno-4-11">11</a></span>
<span class="normal"><a href="#__codelineno-4-12">12</a></span>
<span class="normal"><a href="#__codelineno-4-13">13</a></span>
<span class="normal"><a href="#__codelineno-4-14">14</a></span>
<span class="normal"><a href="#__codelineno-4-15">15</a></span>
<span class="normal"><a href="#__codelineno-4-16">16</a></span>
<span class="normal"><a href="#__codelineno-4-17">17</a></span>
<span class="normal"><a href="#__codelineno-4-18">18</a></span>
<span class="normal"><a href="#__codelineno-4-19">19</a></span>
<span class="normal"><a href="#__codelineno-4-20">20</a></span>
<span class="normal"><a href="#__codelineno-4-21">21</a></span>
<span class="normal"><a href="#__codelineno-4-22">22</a></span>
<span class="normal"><a href="#__codelineno-4-23">23</a></span>
<span class="normal"><a href="#__codelineno-4-24">24</a></span>
<span class="normal"><a href="#__codelineno-4-25">25</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="w">    </span><span class="s">&quot;context&quot;</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3"></a>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/model&quot;</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="p">)</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7"></a>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9"></a><span class="w">    </span><span class="nx">llm1NodeID</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;llm1&quot;</span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10"></a><span class="w">    </span><span class="nx">llm2NodeID</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;llm2&quot;</span>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11"></a><span class="p">)</span>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12"></a>
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13"></a><span class="kd">func</span><span class="w"> </span><span class="nx">prepForLLM1</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14"></a><span class="w">    </span><span class="nx">msgs</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">[]</span><span class="nx">model</span><span class="p">.</span><span class="nx">Message</span><span class="p">{</span>
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15"></a><span class="w">        </span><span class="nx">model</span><span class="p">.</span><span class="nx">NewUserMessage</span><span class="p">(</span><span class="s">&quot;question for llm1&quot;</span><span class="p">),</span>
</span><span id="__span-4-16"><a id="__codelineno-4-16" name="__codelineno-4-16"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-4-17"><a id="__codelineno-4-17" name="__codelineno-4-17"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">SetOneShotMessagesForNode</span><span class="p">(</span><span class="nx">llm1NodeID</span><span class="p">,</span><span class="w"> </span><span class="nx">msgs</span><span class="p">),</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-4-18"><a id="__codelineno-4-18" name="__codelineno-4-18"></a><span class="p">}</span>
</span><span id="__span-4-19"><a id="__codelineno-4-19" name="__codelineno-4-19"></a>
</span><span id="__span-4-20"><a id="__codelineno-4-20" name="__codelineno-4-20"></a><span class="kd">func</span><span class="w"> </span><span class="nx">prepForLLM2</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-21"><a id="__codelineno-4-21" name="__codelineno-4-21"></a><span class="w">    </span><span class="nx">msgs</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">[]</span><span class="nx">model</span><span class="p">.</span><span class="nx">Message</span><span class="p">{</span>
</span><span id="__span-4-22"><a id="__codelineno-4-22" name="__codelineno-4-22"></a><span class="w">        </span><span class="nx">model</span><span class="p">.</span><span class="nx">NewUserMessage</span><span class="p">(</span><span class="s">&quot;question for llm2&quot;</span><span class="p">),</span>
</span><span id="__span-4-23"><a id="__codelineno-4-23" name="__codelineno-4-23"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-4-24"><a id="__codelineno-4-24" name="__codelineno-4-24"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">SetOneShotMessagesForNode</span><span class="p">(</span><span class="nx">llm2NodeID</span><span class="p">,</span><span class="w"> </span><span class="nx">msgs</span><span class="p">),</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-4-25"><a id="__codelineno-4-25" name="__codelineno-4-25"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>在单个上游节点里同时为多个下游节点准备 one-shot：</p>
<p>在 Go 里，<code>map</code> 对同一个 key 的赋值会覆盖旧值。由于
<code>SetOneShotMessagesForNode(...)</code> 每次都会写入同一个顶层 key
（<code>one_shot_messages_by_node</code>），因此不要在一个函数里多次调用它，然后再用
<code>result[k] = v</code> 这种方式去“合并”多个 <code>graph.State</code>（最后一次写入会覆盖前面的）。</p>
<p>推荐做法是：先构造一个 <code>map[nodeID][]model.Message</code>，一次性写入：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-5-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-5-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-5-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-5-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-5-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-5-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-5-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-5-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-5-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-5-10">10</a></span>
<span class="normal"><a href="#__codelineno-5-11">11</a></span>
<span class="normal"><a href="#__codelineno-5-12">12</a></span>
<span class="normal"><a href="#__codelineno-5-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="kd">func</span><span class="w"> </span><span class="nx">preprocess</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="w">    </span><span class="nx">byNode</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">][]</span><span class="nx">model</span><span class="p">.</span><span class="nx">Message</span><span class="p">{</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="w">        </span><span class="nx">llm1NodeID</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="w">            </span><span class="nx">model</span><span class="p">.</span><span class="nx">NewSystemMessage</span><span class="p">(</span><span class="s">&quot;You are llm1.&quot;</span><span class="p">),</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="w">            </span><span class="nx">model</span><span class="p">.</span><span class="nx">NewUserMessage</span><span class="p">(</span><span class="s">&quot;question for llm1&quot;</span><span class="p">),</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6"></a><span class="w">        </span><span class="p">},</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7"></a><span class="w">        </span><span class="nx">llm2NodeID</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8"></a><span class="w">            </span><span class="nx">model</span><span class="p">.</span><span class="nx">NewSystemMessage</span><span class="p">(</span><span class="s">&quot;You are llm2.&quot;</span><span class="p">),</span>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9"></a><span class="w">            </span><span class="nx">model</span><span class="p">.</span><span class="nx">NewUserMessage</span><span class="p">(</span><span class="s">&quot;question for llm2&quot;</span><span class="p">),</span>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10"></a><span class="w">        </span><span class="p">},</span>
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">SetOneShotMessagesByNode</span><span class="p">(</span><span class="nx">byNode</span><span class="p">),</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>另一种写法（不使用辅助函数）：直接返回 State delta map（当你在同一个节点里
还要同时更新其它键时很方便）：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-6-1">1</a></span>
<span class="normal"><a href="#__codelineno-6-2">2</a></span>
<span class="normal"><a href="#__codelineno-6-3">3</a></span>
<span class="normal"><a href="#__codelineno-6-4">4</a></span>
<span class="normal"><a href="#__codelineno-6-5">5</a></span>
<span class="normal"><a href="#__codelineno-6-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="kd">func</span><span class="w"> </span><span class="nx">preprocess</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="w">    </span><span class="c1">// byNode := ...</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyOneShotMessagesByNode</span><span class="p">:</span><span class="w"> </span><span class="nx">byNode</span><span class="p">,</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5"></a><span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>注意：</p>
<ul>
<li><code>llm1NodeID</code> / <code>llm2NodeID</code> 必须与 <code>AddLLMNode</code> 里传入的节点 ID 一致。</li>
<li>每个 LLM 节点只会消费一次 <code>one_shot_messages_by_node[自己的ID]</code>，
  并且只清理自己的 entry。</li>
</ul>
<p>示例：</p>
<ul>
<li><code>examples/graph/io_conventions</code>：函数 + LLM + Agent 的 I/O 演示</li>
<li><code>examples/graph/io_conventions_tools</code>：加入 Tools 节点，展示如何获取工具 JSON 并落入 State</li>
<li><code>examples/graph/oneshot_by_node</code>：按 LLM 节点 ID 定向的一次性输入</li>
<li><code>examples/graph/oneshot_by_node_preprocess</code>：在单个上游节点里为多个 LLM 节点准备 OneShot</li>
<li><code>examples/graph/retry</code>：节点级重试/退避演示</li>
</ul>
<h4 id="_8">状态键常量与来源（可直接引用）</h4>
<ul>
<li>导入包：<code>import "trpc.group/trpc-go/trpc-agent-go/graph"</code></li>
<li>常量定义位置：<code>graph/state.go</code></li>
</ul>
<ul>
<li>
<p>用户可见、常用键</p>
<ul>
<li><code>user_input</code> → 常量 <code>graph.StateKeyUserInput</code></li>
<li><code>one_shot_messages</code> → 常量 <code>graph.StateKeyOneShotMessages</code></li>
<li><code>one_shot_messages_by_node</code> → 常量 <code>graph.StateKeyOneShotMessagesByNode</code></li>
<li><code>messages</code> → 常量 <code>graph.StateKeyMessages</code></li>
<li><code>last_response</code> → 常量 <code>graph.StateKeyLastResponse</code></li>
<li><code>last_response_id</code> → 常量 <code>graph.StateKeyLastResponseID</code></li>
<li><code>node_responses</code> → 常量 <code>graph.StateKeyNodeResponses</code></li>
</ul>
</li>
</ul>
<ul>
<li>
<p>OneShot 辅助函数</p>
<ul>
<li><code>SetOneShotMessagesForNode(nodeID, msgs)</code>：设置单个节点的 OneShot</li>
<li><code>SetOneShotMessagesByNode(byNode)</code>：一次性设置多个节点的 OneShot</li>
<li><code>ClearOneShotMessagesForNode(nodeID)</code>：清理单个节点 entry</li>
<li><code>ClearOneShotMessagesByNode()</code>：清理整个 map</li>
<li><code>GetOneShotMessagesForNode(state, nodeID)</code>：读取单个节点 entry</li>
</ul>
</li>
</ul>
<ul>
<li>其他常用键<ul>
<li><code>session</code> → <code>graph.StateKeySession</code></li>
<li><code>metadata</code> → <code>graph.StateKeyMetadata</code></li>
<li><code>current_node_id</code> → <code>graph.StateKeyCurrentNodeID</code></li>
<li><code>exec_context</code> → <code>graph.StateKeyExecContext</code></li>
<li><code>tool_callbacks</code> → <code>graph.StateKeyToolCallbacks</code></li>
<li><code>model_callbacks</code> → <code>graph.StateKeyModelCallbacks</code></li>
<li><code>agent_callbacks</code> → <code>graph.StateKeyAgentCallbacks</code></li>
<li><code>parent_agent</code> → <code>graph.StateKeyParentAgent</code></li>
</ul>
</li>
</ul>
<p>使用示例：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-7-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-7-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-7-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-7-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-7-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-7-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-7-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-7-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-7-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-7-10">10</a></span>
<span class="normal"><a href="#__codelineno-7-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="w">    </span><span class="s">&quot;context&quot;</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4"></a><span class="p">)</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5"></a>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6"></a><span class="kd">func</span><span class="w"> </span><span class="nx">myNode</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7"></a><span class="w">    </span><span class="c1">// 读取上一节点文本输出</span>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8"></a><span class="w">    </span><span class="nx">last</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">state</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyLastResponse</span><span class="p">].(</span><span class="kt">string</span><span class="p">)</span>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9"></a><span class="w">    </span><span class="c1">// 写入自定义字段</span>
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="s">&quot;my_key&quot;</span><span class="p">:</span><span class="w"> </span><span class="nx">last</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-7-11"><a id="__codelineno-7-11" name="__codelineno-7-11"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<h4 id="statedelta">事件元数据键（StateDelta）</h4>
<ul>
<li>导入包：<code>import "trpc.group/trpc-go/trpc-agent-go/graph"</code></li>
<li>常量定义位置：<code>graph/events.go</code></li>
</ul>
<ul>
<li>模型元数据：<code>_model_metadata</code> → <code>graph.MetadataKeyModel</code>（结构体 <code>graph.ModelExecutionMetadata</code>）</li>
<li>工具元数据：<code>_tool_metadata</code> → <code>graph.MetadataKeyTool</code>（结构体 <code>graph.ToolExecutionMetadata</code>）</li>
<li>节点元数据：<code>_node_metadata</code> → <code>graph.MetadataKeyNode</code>（结构体 <code>graph.NodeExecutionMetadata</code>）。包含重试字段：<code>Attempt</code>、<code>MaxAttempts</code>、<code>NextDelay</code>、<code>Retrying</code> 及时间相关信息。</li>
</ul>
<p>使用示例：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-8-1">1</a></span>
<span class="normal"><a href="#__codelineno-8-2">2</a></span>
<span class="normal"><a href="#__codelineno-8-3">3</a></span>
<span class="normal"><a href="#__codelineno-8-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="k">if</span><span class="w"> </span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">event</span><span class="p">.</span><span class="nx">StateDelta</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">MetadataKeyModel</span><span class="p">];</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">md</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">ModelExecutionMetadata</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="w">    </span><span class="nx">_</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">json</span><span class="p">.</span><span class="nx">Unmarshal</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">md</span><span class="p">)</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<h4 id="eventemitter">节点主动外抛事件（EventEmitter）</h4>
<p>在 NodeFunc 执行过程中，节点可以通过 <code>EventEmitter</code> 主动向外部发射自定义事件，用于实时传递进度、中间结果或自定义业务数据。</p>
<p><strong>获取 EventEmitter</strong></p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-9-1">1</a></span>
<span class="normal"><a href="#__codelineno-9-2">2</a></span>
<span class="normal"><a href="#__codelineno-9-3">3</a></span>
<span class="normal"><a href="#__codelineno-9-4">4</a></span>
<span class="normal"><a href="#__codelineno-9-5">5</a></span>
<span class="normal"><a href="#__codelineno-9-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="kd">func</span><span class="w"> </span><span class="nx">myNode</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2"></a><span class="w">    </span><span class="c1">// 从 State 中获取 EventEmitter</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3"></a><span class="w">    </span><span class="nx">emitter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">GetEventEmitterWithContext</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="p">)</span>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4"></a><span class="w">    </span><span class="c1">// 或直接调用 emitter := graph.GetEventEmitter(state)</span>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">state</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p><strong>EventEmitter 接口</strong></p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-10-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-10-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-10-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-10-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-10-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-10-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-10-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-10-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-10-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-10-10">10</a></span>
<span class="normal"><a href="#__codelineno-10-11">11</a></span>
<span class="normal"><a href="#__codelineno-10-12">12</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="kd">type</span><span class="w"> </span><span class="nx">EventEmitter</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2"></a><span class="w">    </span><span class="c1">// Emit 发射任意事件</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3"></a><span class="w">    </span><span class="nx">Emit</span><span class="p">(</span><span class="nx">evt</span><span class="w"> </span><span class="o">*</span><span class="nx">event</span><span class="p">.</span><span class="nx">Event</span><span class="p">)</span><span class="w"> </span><span class="kt">error</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4"></a><span class="w">    </span><span class="c1">// EmitCustom 发射自定义事件</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5"></a><span class="w">    </span><span class="nx">EmitCustom</span><span class="p">(</span><span class="nx">eventType</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">payload</span><span class="w"> </span><span class="kt">any</span><span class="p">)</span><span class="w"> </span><span class="kt">error</span>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6"></a><span class="w">    </span><span class="c1">// EmitProgress 发射进度事件（progress: 0-100）</span>
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7"></a><span class="w">    </span><span class="nx">EmitProgress</span><span class="p">(</span><span class="nx">progress</span><span class="w"> </span><span class="kt">float64</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="kt">error</span>
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8"></a><span class="w">    </span><span class="c1">// EmitText 发射流式文本事件</span>
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9"></a><span class="w">    </span><span class="nx">EmitText</span><span class="p">(</span><span class="nx">text</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="kt">error</span>
</span><span id="__span-10-10"><a id="__codelineno-10-10" name="__codelineno-10-10"></a><span class="w">    </span><span class="c1">// Context 返回关联的 context</span>
</span><span id="__span-10-11"><a id="__codelineno-10-11" name="__codelineno-10-11"></a><span class="w">    </span><span class="nx">Context</span><span class="p">()</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span>
</span><span id="__span-10-12"><a id="__codelineno-10-12" name="__codelineno-10-12"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p><strong>使用示例</strong></p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-11-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-11-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-11-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-11-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-11-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-11-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-11-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-11-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-11-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-11-10">10</a></span>
<span class="normal"><a href="#__codelineno-11-11">11</a></span>
<span class="normal"><a href="#__codelineno-11-12">12</a></span>
<span class="normal"><a href="#__codelineno-11-13">13</a></span>
<span class="normal"><a href="#__codelineno-11-14">14</a></span>
<span class="normal"><a href="#__codelineno-11-15">15</a></span>
<span class="normal"><a href="#__codelineno-11-16">16</a></span>
<span class="normal"><a href="#__codelineno-11-17">17</a></span>
<span class="normal"><a href="#__codelineno-11-18">18</a></span>
<span class="normal"><a href="#__codelineno-11-19">19</a></span>
<span class="normal"><a href="#__codelineno-11-20">20</a></span>
<span class="normal"><a href="#__codelineno-11-21">21</a></span>
<span class="normal"><a href="#__codelineno-11-22">22</a></span>
<span class="normal"><a href="#__codelineno-11-23">23</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="kd">func</span><span class="w"> </span><span class="nx">dataProcessNode</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2"></a><span class="w">    </span><span class="nx">emitter</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">GetEventEmitter</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3"></a>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4"></a><span class="w">    </span><span class="c1">// 1. 发射自定义事件</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5"></a><span class="w">    </span><span class="nx">emitter</span><span class="p">.</span><span class="nx">EmitCustom</span><span class="p">(</span><span class="s">&quot;data.loaded&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">any</span><span class="p">{</span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6"></a><span class="w">        </span><span class="s">&quot;recordCount&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1000</span><span class="p">,</span>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7"></a><span class="w">        </span><span class="s">&quot;source&quot;</span><span class="p">:</span><span class="w">      </span><span class="s">&quot;database&quot;</span><span class="p">,</span>
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8"></a><span class="w">    </span><span class="p">})</span>
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9"></a>
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10"></a><span class="w">    </span><span class="c1">// 2. 发射进度事件</span>
</span><span id="__span-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11"></a><span class="w">    </span><span class="nx">total</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">100</span>
</span><span id="__span-11-12"><a id="__codelineno-11-12" name="__codelineno-11-12"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">total</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-13"><a id="__codelineno-11-13" name="__codelineno-11-13"></a><span class="w">        </span><span class="nx">processItem</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span>
</span><span id="__span-11-14"><a id="__codelineno-11-14" name="__codelineno-11-14"></a><span class="w">        </span><span class="nx">progress</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">float64</span><span class="p">(</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nb">float64</span><span class="p">(</span><span class="nx">total</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span>
</span><span id="__span-11-15"><a id="__codelineno-11-15" name="__codelineno-11-15"></a><span class="w">        </span><span class="nx">emitter</span><span class="p">.</span><span class="nx">EmitProgress</span><span class="p">(</span><span class="nx">progress</span><span class="p">,</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;Processing %d/%d&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="nx">total</span><span class="p">))</span>
</span><span id="__span-11-16"><a id="__codelineno-11-16" name="__codelineno-11-16"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-11-17"><a id="__codelineno-11-17" name="__codelineno-11-17"></a>
</span><span id="__span-11-18"><a id="__codelineno-11-18" name="__codelineno-11-18"></a><span class="w">    </span><span class="c1">// 3. 发射流式文本</span>
</span><span id="__span-11-19"><a id="__codelineno-11-19" name="__codelineno-11-19"></a><span class="w">    </span><span class="nx">emitter</span><span class="p">.</span><span class="nx">EmitText</span><span class="p">(</span><span class="s">&quot;Processing complete.\n&quot;</span><span class="p">)</span>
</span><span id="__span-11-20"><a id="__codelineno-11-20" name="__codelineno-11-20"></a><span class="w">    </span><span class="nx">emitter</span><span class="p">.</span><span class="nx">EmitText</span><span class="p">(</span><span class="s">&quot;Results: 100 items processed successfully.&quot;</span><span class="p">)</span>
</span><span id="__span-11-21"><a id="__codelineno-11-21" name="__codelineno-11-21"></a>
</span><span id="__span-11-22"><a id="__codelineno-11-22" name="__codelineno-11-22"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">state</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-11-23"><a id="__codelineno-11-23" name="__codelineno-11-23"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p><strong>事件流转流程</strong></p>
<pre class="mermaid"><code>sequenceDiagram
    autonumber
    participant NF as NodeFunc
    participant EE as EventEmitter
    participant EC as EventChan
    participant EX as Executor
    participant TR as AGUI Translator
    participant FE as 客户端

    Note over NF,FE: 事件发射阶段
    NF-&gt;&gt;EE: GetEventEmitter(state)
    EE--&gt;&gt;NF: 返回 EventEmitter 实例

    alt 发射自定义事件
        NF-&gt;&gt;EE: EmitCustom(eventType, payload)
    else 发射进度事件
        NF-&gt;&gt;EE: EmitProgress(progress, message)
    else 发射文本事件
        NF-&gt;&gt;EE: EmitText(text)
    end

    Note over EE: 构建 NodeCustomEventMetadata
    EE-&gt;&gt;EE: 注入 NodeID, InvocationID, Timestamp
    EE-&gt;&gt;EC: 发送 Event 到 Chan

    Note over EC,FE: 事件消费阶段
    EC-&gt;&gt;EX: Executor 接收事件
    EX-&gt;&gt;TR: 传递事件给 Translator

    alt Custom 类型事件
        TR-&gt;&gt;TR: 转换为 AG-UI CustomEvent
    else Progress 类型事件
        TR-&gt;&gt;TR: 转换为 AG-UI CustomEvent (含进度信息)
    else Text 类型事件 (消息上下文)
        TR-&gt;&gt;TR: 转换为 TextMessageContentEvent
    else Text 类型事件 (非消息上下)
        TR-&gt;&gt;TR: 转换为 AG-UI CustomEvent
    end

    TR-&gt;&gt;FE: SSE 推送 AG-UI 事件
    FE-&gt;&gt;FE: 处理并更新 UI</code></pre>
<p><strong>AGUI 事件转换</strong></p>
<p>当使用 AGUI Server 时，节点发射的事件会自动转换为 AG-UI 协议事件：</p>
<table>
<thead>
<tr>
<th>节点事件类型</th>
<th>AG-UI 事件类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>Custom</td>
<td>CustomEvent</td>
<td>自定义事件，payload 在 <code>value</code> 字段</td>
</tr>
<tr>
<td>Progress</td>
<td>CustomEvent</td>
<td>进度事件，包含 <code>progress</code> 和 <code>message</code></td>
</tr>
<tr>
<td>Text（消息上下文中）</td>
<td>TextMessageContentEvent</td>
<td>流式文本追加到当前消息</td>
</tr>
<tr>
<td>Text（非消息上下文）</td>
<td>CustomEvent</td>
<td>包含 <code>nodeId</code> 和 <code>content</code> 字段</td>
</tr>
</tbody>
</table>
<p><strong>注意事项</strong></p>
<ul>
<li><strong>线程安全</strong>：EventEmitter 是线程安全的，可在并发环境中使用</li>
<li><strong>优雅降级</strong>：若 State 中无有效的 ExecutionContext 或 EventChan，<code>GetEventEmitter</code> 返回 no-op emitter，所有操作静默成功</li>
<li><strong>错误处理</strong>：业务实践中建议事件发射失败不要中断节点执行，仅记录警告日志，忽略异常</li>
<li><strong>自定义事件元数据</strong>：<code>_node_custom_metadata</code> → <code>graph.MetadataKeyNodeCustom</code>（结构体 <code>graph.NodeCustomEventMetadata</code>）</li>
</ul>
<h3 id="1-graphagent-runner">1. 创建 GraphAgent 和 Runner</h3>
<p>用户主要通过创建 GraphAgent 然后通过 Runner 来使用 Graph 包。这是推荐的使用模式：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-12-1">  1</a></span>
<span class="normal"><a href="#__codelineno-12-2">  2</a></span>
<span class="normal"><a href="#__codelineno-12-3">  3</a></span>
<span class="normal"><a href="#__codelineno-12-4">  4</a></span>
<span class="normal"><a href="#__codelineno-12-5">  5</a></span>
<span class="normal"><a href="#__codelineno-12-6">  6</a></span>
<span class="normal"><a href="#__codelineno-12-7">  7</a></span>
<span class="normal"><a href="#__codelineno-12-8">  8</a></span>
<span class="normal"><a href="#__codelineno-12-9">  9</a></span>
<span class="normal"><a href="#__codelineno-12-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-12-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-12-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-12-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-12-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-12-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-12-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-12-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-12-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-12-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-12-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-12-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-12-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-12-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-12-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-12-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-12-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-12-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-12-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-12-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-12-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-12-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-12-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-12-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-12-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-12-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-12-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-12-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-12-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-12-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-12-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-12-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-12-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-12-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-12-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-12-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-12-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-12-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-12-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-12-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-12-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-12-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-12-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-12-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-12-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-12-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-12-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-12-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-12-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-12-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-12-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-12-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-12-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-12-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-12-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-12-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-12-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-12-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-12-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-12-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-12-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-12-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-12-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-12-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-12-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-12-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-12-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-12-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-12-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-12-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-12-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-12-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-12-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-12-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-12-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-12-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-12-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-12-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-12-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-12-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-12-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-12-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-12-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-12-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-12-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-12-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-12-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-12-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-12-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-12-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-12-100">100</a></span>
<span class="normal"><a href="#__codelineno-12-101">101</a></span>
<span class="normal"><a href="#__codelineno-12-102">102</a></span>
<span class="normal"><a href="#__codelineno-12-103">103</a></span>
<span class="normal"><a href="#__codelineno-12-104">104</a></span>
<span class="normal"><a href="#__codelineno-12-105">105</a></span>
<span class="normal"><a href="#__codelineno-12-106">106</a></span>
<span class="normal"><a href="#__codelineno-12-107">107</a></span>
<span class="normal"><a href="#__codelineno-12-108">108</a></span>
<span class="normal"><a href="#__codelineno-12-109">109</a></span>
<span class="normal"><a href="#__codelineno-12-110">110</a></span>
<span class="normal"><a href="#__codelineno-12-111">111</a></span>
<span class="normal"><a href="#__codelineno-12-112">112</a></span>
<span class="normal"><a href="#__codelineno-12-113">113</a></span>
<span class="normal"><a href="#__codelineno-12-114">114</a></span>
<span class="normal"><a href="#__codelineno-12-115">115</a></span>
<span class="normal"><a href="#__codelineno-12-116">116</a></span>
<span class="normal"><a href="#__codelineno-12-117">117</a></span>
<span class="normal"><a href="#__codelineno-12-118">118</a></span>
<span class="normal"><a href="#__codelineno-12-119">119</a></span>
<span class="normal"><a href="#__codelineno-12-120">120</a></span>
<span class="normal"><a href="#__codelineno-12-121">121</a></span>
<span class="normal"><a href="#__codelineno-12-122">122</a></span>
<span class="normal"><a href="#__codelineno-12-123">123</a></span>
<span class="normal"><a href="#__codelineno-12-124">124</a></span>
<span class="normal"><a href="#__codelineno-12-125">125</a></span>
<span class="normal"><a href="#__codelineno-12-126">126</a></span>
<span class="normal"><a href="#__codelineno-12-127">127</a></span>
<span class="normal"><a href="#__codelineno-12-128">128</a></span>
<span class="normal"><a href="#__codelineno-12-129">129</a></span>
<span class="normal"><a href="#__codelineno-12-130">130</a></span>
<span class="normal"><a href="#__codelineno-12-131">131</a></span>
<span class="normal"><a href="#__codelineno-12-132">132</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="kn">package</span><span class="w"> </span><span class="nx">main</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2"></a>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4"></a><span class="w">    </span><span class="s">&quot;context&quot;</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5"></a><span class="w">    </span><span class="s">&quot;fmt&quot;</span>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6"></a><span class="w">    </span><span class="s">&quot;time&quot;</span>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7"></a>
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/agent/graphagent&quot;</span>
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/model&quot;</span>
</span><span id="__span-12-11"><a id="__codelineno-12-11" name="__codelineno-12-11"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/runner&quot;</span>
</span><span id="__span-12-12"><a id="__codelineno-12-12" name="__codelineno-12-12"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/session/inmemory&quot;</span>
</span><span id="__span-12-13"><a id="__codelineno-12-13" name="__codelineno-12-13"></a><span class="p">)</span>
</span><span id="__span-12-14"><a id="__codelineno-12-14" name="__codelineno-12-14"></a>
</span><span id="__span-12-15"><a id="__codelineno-12-15" name="__codelineno-12-15"></a><span class="kd">func</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-16"><a id="__codelineno-12-16" name="__codelineno-12-16"></a><span class="w">    </span><span class="c1">// 1. 创建状态模式</span>
</span><span id="__span-12-17"><a id="__codelineno-12-17" name="__codelineno-12-17"></a><span class="w">    </span><span class="nx">schema</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">MessagesStateSchema</span><span class="p">()</span>
</span><span id="__span-12-18"><a id="__codelineno-12-18" name="__codelineno-12-18"></a>
</span><span id="__span-12-19"><a id="__codelineno-12-19" name="__codelineno-12-19"></a><span class="w">    </span><span class="c1">// 2. 创建状态图构建器</span>
</span><span id="__span-12-20"><a id="__codelineno-12-20" name="__codelineno-12-20"></a><span class="w">    </span><span class="nx">stateGraph</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateGraph</span><span class="p">(</span><span class="nx">schema</span><span class="p">)</span>
</span><span id="__span-12-21"><a id="__codelineno-12-21" name="__codelineno-12-21"></a>
</span><span id="__span-12-22"><a id="__codelineno-12-22" name="__codelineno-12-22"></a><span class="w">    </span><span class="c1">// 3. 添加节点</span>
</span><span id="__span-12-23"><a id="__codelineno-12-23" name="__codelineno-12-23"></a><span class="w">    </span><span class="nx">stateGraph</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;start&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">startNodeFunc</span><span class="p">).</span>
</span><span id="__span-12-24"><a id="__codelineno-12-24" name="__codelineno-12-24"></a><span class="w">        </span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;process&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">processNodeFunc</span><span class="p">)</span>
</span><span id="__span-12-25"><a id="__codelineno-12-25" name="__codelineno-12-25"></a>
</span><span id="__span-12-26"><a id="__codelineno-12-26" name="__codelineno-12-26"></a><span class="w">    </span><span class="c1">// 4. 设置边</span>
</span><span id="__span-12-27"><a id="__codelineno-12-27" name="__codelineno-12-27"></a><span class="w">    </span><span class="nx">stateGraph</span><span class="p">.</span><span class="nx">AddEdge</span><span class="p">(</span><span class="s">&quot;start&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;process&quot;</span><span class="p">)</span>
</span><span id="__span-12-28"><a id="__codelineno-12-28" name="__codelineno-12-28"></a>
</span><span id="__span-12-29"><a id="__codelineno-12-29" name="__codelineno-12-29"></a><span class="w">    </span><span class="c1">// 5. 设置入口点和结束点</span>
</span><span id="__span-12-30"><a id="__codelineno-12-30" name="__codelineno-12-30"></a><span class="w">    </span><span class="c1">// SetEntryPoint 会自动创建虚拟 Start 节点到 &quot;start&quot; 节点的边</span>
</span><span id="__span-12-31"><a id="__codelineno-12-31" name="__codelineno-12-31"></a><span class="w">    </span><span class="c1">// SetFinishPoint 会自动创建 &quot;process&quot; 节点到虚拟 End 节点的边</span>
</span><span id="__span-12-32"><a id="__codelineno-12-32" name="__codelineno-12-32"></a><span class="w">    </span><span class="nx">stateGraph</span><span class="p">.</span><span class="nx">SetEntryPoint</span><span class="p">(</span><span class="s">&quot;start&quot;</span><span class="p">).</span>
</span><span id="__span-12-33"><a id="__codelineno-12-33" name="__codelineno-12-33"></a><span class="w">        </span><span class="nx">SetFinishPoint</span><span class="p">(</span><span class="s">&quot;process&quot;</span><span class="p">)</span>
</span><span id="__span-12-34"><a id="__codelineno-12-34" name="__codelineno-12-34"></a>
</span><span id="__span-12-35"><a id="__codelineno-12-35" name="__codelineno-12-35"></a><span class="w">    </span><span class="c1">// 6. 编译图</span>
</span><span id="__span-12-36"><a id="__codelineno-12-36" name="__codelineno-12-36"></a><span class="w">    </span><span class="nx">compiledGraph</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">stateGraph</span><span class="p">.</span><span class="nx">Compile</span><span class="p">()</span>
</span><span id="__span-12-37"><a id="__codelineno-12-37" name="__codelineno-12-37"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-38"><a id="__codelineno-12-38" name="__codelineno-12-38"></a><span class="w">        </span><span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span id="__span-12-39"><a id="__codelineno-12-39" name="__codelineno-12-39"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-12-40"><a id="__codelineno-12-40" name="__codelineno-12-40"></a>
</span><span id="__span-12-41"><a id="__codelineno-12-41" name="__codelineno-12-41"></a><span class="w">    </span><span class="c1">// 7. 创建 GraphAgent</span>
</span><span id="__span-12-42"><a id="__codelineno-12-42" name="__codelineno-12-42"></a><span class="w">    </span><span class="nx">graphAgent</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;simple-workflow&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">compiledGraph</span><span class="p">,</span>
</span><span id="__span-12-43"><a id="__codelineno-12-43" name="__codelineno-12-43"></a><span class="w">        </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithDescription</span><span class="p">(</span><span class="s">&quot;简单的工作流示例&quot;</span><span class="p">),</span>
</span><span id="__span-12-44"><a id="__codelineno-12-44" name="__codelineno-12-44"></a><span class="w">        </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithInitialState</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{}),</span>
</span><span id="__span-12-45"><a id="__codelineno-12-45" name="__codelineno-12-45"></a><span class="w">        </span><span class="c1">// 设置传给模型的消息过滤模式，最终传给模型的消息需同时满足WithMessageTimelineFilterMode与WithMessageBranchFilterMode条件</span>
</span><span id="__span-12-46"><a id="__codelineno-12-46" name="__codelineno-12-46"></a><span class="w">        </span><span class="c1">// 时间维度过滤条件</span>
</span><span id="__span-12-47"><a id="__codelineno-12-47" name="__codelineno-12-47"></a><span class="w">        </span><span class="c1">// 默认值: graphagent.TimelineFilterAll</span>
</span><span id="__span-12-48"><a id="__codelineno-12-48" name="__codelineno-12-48"></a><span class="w">        </span><span class="c1">// 可选值:</span>
</span><span id="__span-12-49"><a id="__codelineno-12-49" name="__codelineno-12-49"></a><span class="w">        </span><span class="c1">//  - graphagent.TimelineFilterAll: 包含历史消息以及当前请求中所生成的消息</span>
</span><span id="__span-12-50"><a id="__codelineno-12-50" name="__codelineno-12-50"></a><span class="w">        </span><span class="c1">//  - graphagent.TimelineFilterCurrentRequest: 仅包含当前请求中所生成的消息</span>
</span><span id="__span-12-51"><a id="__codelineno-12-51" name="__codelineno-12-51"></a><span class="w">        </span><span class="c1">//  - graphagent.TimelineFilterCurrentInvocation: 仅包含当前invocation上下文中生成的消息</span>
</span><span id="__span-12-52"><a id="__codelineno-12-52" name="__codelineno-12-52"></a><span class="w">        </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithMessageTimelineFilterMode</span><span class="p">(</span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">TimelineFilterAll</span><span class="p">),</span>
</span><span id="__span-12-53"><a id="__codelineno-12-53" name="__codelineno-12-53"></a><span class="w">        </span><span class="c1">// 分支维度过滤条件</span>
</span><span id="__span-12-54"><a id="__codelineno-12-54" name="__codelineno-12-54"></a><span class="w">        </span><span class="c1">// 默认值: graphagent.BranchFilterModePrefix</span>
</span><span id="__span-12-55"><a id="__codelineno-12-55" name="__codelineno-12-55"></a><span class="w">        </span><span class="c1">// 可选值:</span>
</span><span id="__span-12-56"><a id="__codelineno-12-56" name="__codelineno-12-56"></a><span class="w">        </span><span class="c1">//  - graphagent.BranchFilterModeAll: 包含所有agent的消息, 当前agent与模型交互时,如需将所有agent生成的有效内容消息同步给模型时可设置该值</span>
</span><span id="__span-12-57"><a id="__codelineno-12-57" name="__codelineno-12-57"></a><span class="w">        </span><span class="c1">//  - graphagent.BranchFilterModePrefix: 通过Event.FilterKey与Invocation.eventFilterKey做前缀匹配过滤消息, 期望将与当前agent以及相关上下游agent生成的消息传递给模型时，可设置该值</span>
</span><span id="__span-12-58"><a id="__codelineno-12-58" name="__codelineno-12-58"></a><span class="w">        </span><span class="c1">//  - graphagent.BranchFilterModeExact: 通过Event.FilterKey==Invocation.eventFilterKey过滤消息，当前agent与模型交互时,仅需使用当前agent生成的消息时可设置该值</span>
</span><span id="__span-12-59"><a id="__codelineno-12-59" name="__codelineno-12-59"></a><span class="w">        </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithMessageBranchFilterMode</span><span class="p">(</span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">BranchFilterModeAll</span><span class="p">),</span>
</span><span id="__span-12-60"><a id="__codelineno-12-60" name="__codelineno-12-60"></a><span class="w">    </span><span class="p">)</span>
</span><span id="__span-12-61"><a id="__codelineno-12-61" name="__codelineno-12-61"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-62"><a id="__codelineno-12-62" name="__codelineno-12-62"></a><span class="w">        </span><span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span id="__span-12-63"><a id="__codelineno-12-63" name="__codelineno-12-63"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-12-64"><a id="__codelineno-12-64" name="__codelineno-12-64"></a>
</span><span id="__span-12-65"><a id="__codelineno-12-65" name="__codelineno-12-65"></a><span class="w">    </span><span class="c1">// 8. 创建会话服务</span>
</span><span id="__span-12-66"><a id="__codelineno-12-66" name="__codelineno-12-66"></a><span class="w">    </span><span class="nx">sessionService</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">inmemory</span><span class="p">.</span><span class="nx">NewSessionService</span><span class="p">()</span>
</span><span id="__span-12-67"><a id="__codelineno-12-67" name="__codelineno-12-67"></a>
</span><span id="__span-12-68"><a id="__codelineno-12-68" name="__codelineno-12-68"></a><span class="w">    </span><span class="c1">// 9. 创建 Runner</span>
</span><span id="__span-12-69"><a id="__codelineno-12-69" name="__codelineno-12-69"></a><span class="w">    </span><span class="nx">appRunner</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">runner</span><span class="p">.</span><span class="nx">NewRunner</span><span class="p">(</span>
</span><span id="__span-12-70"><a id="__codelineno-12-70" name="__codelineno-12-70"></a><span class="w">        </span><span class="s">&quot;simple-app&quot;</span><span class="p">,</span>
</span><span id="__span-12-71"><a id="__codelineno-12-71" name="__codelineno-12-71"></a><span class="w">        </span><span class="nx">graphAgent</span><span class="p">,</span>
</span><span id="__span-12-72"><a id="__codelineno-12-72" name="__codelineno-12-72"></a><span class="w">        </span><span class="nx">runner</span><span class="p">.</span><span class="nx">WithSessionService</span><span class="p">(</span><span class="nx">sessionService</span><span class="p">),</span>
</span><span id="__span-12-73"><a id="__codelineno-12-73" name="__codelineno-12-73"></a><span class="w">    </span><span class="p">)</span>
</span><span id="__span-12-74"><a id="__codelineno-12-74" name="__codelineno-12-74"></a>
</span><span id="__span-12-75"><a id="__codelineno-12-75" name="__codelineno-12-75"></a><span class="w">    </span><span class="c1">// 10. 执行工作流</span>
</span><span id="__span-12-76"><a id="__codelineno-12-76" name="__codelineno-12-76"></a><span class="w">    </span><span class="nx">ctx</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Background</span><span class="p">()</span>
</span><span id="__span-12-77"><a id="__codelineno-12-77" name="__codelineno-12-77"></a><span class="w">    </span><span class="nx">userID</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;user&quot;</span>
</span><span id="__span-12-78"><a id="__codelineno-12-78" name="__codelineno-12-78"></a><span class="w">    </span><span class="nx">sessionID</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;session-%d&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">().</span><span class="nx">Unix</span><span class="p">())</span>
</span><span id="__span-12-79"><a id="__codelineno-12-79" name="__codelineno-12-79"></a>
</span><span id="__span-12-80"><a id="__codelineno-12-80" name="__codelineno-12-80"></a><span class="w">    </span><span class="c1">// 创建用户消息（Runner 会自动将消息内容放入 StateKeyUserInput）</span>
</span><span id="__span-12-81"><a id="__codelineno-12-81" name="__codelineno-12-81"></a><span class="w">    </span><span class="nx">message</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">model</span><span class="p">.</span><span class="nx">NewUserMessage</span><span class="p">(</span><span class="s">&quot;Hello World&quot;</span><span class="p">)</span>
</span><span id="__span-12-82"><a id="__codelineno-12-82" name="__codelineno-12-82"></a>
</span><span id="__span-12-83"><a id="__codelineno-12-83" name="__codelineno-12-83"></a><span class="w">    </span><span class="c1">// 通过 Runner 执行</span>
</span><span id="__span-12-84"><a id="__codelineno-12-84" name="__codelineno-12-84"></a><span class="w">    </span><span class="nx">eventChan</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">appRunner</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">userID</span><span class="p">,</span><span class="w"> </span><span class="nx">sessionID</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="p">)</span>
</span><span id="__span-12-85"><a id="__codelineno-12-85" name="__codelineno-12-85"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-86"><a id="__codelineno-12-86" name="__codelineno-12-86"></a><span class="w">        </span><span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span id="__span-12-87"><a id="__codelineno-12-87" name="__codelineno-12-87"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-12-88"><a id="__codelineno-12-88" name="__codelineno-12-88"></a>
</span><span id="__span-12-89"><a id="__codelineno-12-89" name="__codelineno-12-89"></a><span class="w">    </span><span class="c1">// 处理事件流</span>
</span><span id="__span-12-90"><a id="__codelineno-12-90" name="__codelineno-12-90"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">event</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">eventChan</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-91"><a id="__codelineno-12-91" name="__codelineno-12-91"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">event</span><span class="p">.</span><span class="nx">Error</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-92"><a id="__codelineno-12-92" name="__codelineno-12-92"></a><span class="w">            </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;错误: %s\n&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">event</span><span class="p">.</span><span class="nx">Error</span><span class="p">.</span><span class="nx">Message</span><span class="p">)</span>
</span><span id="__span-12-93"><a id="__codelineno-12-93" name="__codelineno-12-93"></a><span class="w">            </span><span class="k">continue</span>
</span><span id="__span-12-94"><a id="__codelineno-12-94" name="__codelineno-12-94"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-12-95"><a id="__codelineno-12-95" name="__codelineno-12-95"></a>
</span><span id="__span-12-96"><a id="__codelineno-12-96" name="__codelineno-12-96"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">Response</span><span class="p">.</span><span class="nx">Choices</span><span class="p">)</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-97"><a id="__codelineno-12-97" name="__codelineno-12-97"></a><span class="w">            </span><span class="nx">choice</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">event</span><span class="p">.</span><span class="nx">Response</span><span class="p">.</span><span class="nx">Choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="__span-12-98"><a id="__codelineno-12-98" name="__codelineno-12-98"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">choice</span><span class="p">.</span><span class="nx">Delta</span><span class="p">.</span><span class="nx">Content</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-99"><a id="__codelineno-12-99" name="__codelineno-12-99"></a><span class="w">                </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Print</span><span class="p">(</span><span class="nx">choice</span><span class="p">.</span><span class="nx">Delta</span><span class="p">.</span><span class="nx">Content</span><span class="p">)</span>
</span><span id="__span-12-100"><a id="__codelineno-12-100" name="__codelineno-12-100"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-12-101"><a id="__codelineno-12-101" name="__codelineno-12-101"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-12-102"><a id="__codelineno-12-102" name="__codelineno-12-102"></a>
</span><span id="__span-12-103"><a id="__codelineno-12-103" name="__codelineno-12-103"></a><span class="w">        </span><span class="c1">// 推荐：使用 Runner 完成事件作为“流程结束”的信号。</span>
</span><span id="__span-12-104"><a id="__codelineno-12-104" name="__codelineno-12-104"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">event</span><span class="p">.</span><span class="nx">IsRunnerCompletion</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-105"><a id="__codelineno-12-105" name="__codelineno-12-105"></a><span class="w">            </span><span class="k">break</span>
</span><span id="__span-12-106"><a id="__codelineno-12-106" name="__codelineno-12-106"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-12-107"><a id="__codelineno-12-107" name="__codelineno-12-107"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-12-108"><a id="__codelineno-12-108" name="__codelineno-12-108"></a><span class="p">}</span>
</span><span id="__span-12-109"><a id="__codelineno-12-109" name="__codelineno-12-109"></a>
</span><span id="__span-12-110"><a id="__codelineno-12-110" name="__codelineno-12-110"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-12-111"><a id="__codelineno-12-111" name="__codelineno-12-111"></a><span class="w">    </span><span class="nx">stateKeyProcessedData</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;processed_data&quot;</span>
</span><span id="__span-12-112"><a id="__codelineno-12-112" name="__codelineno-12-112"></a><span class="w">    </span><span class="nx">stateKeyResult</span><span class="w">        </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;result&quot;</span>
</span><span id="__span-12-113"><a id="__codelineno-12-113" name="__codelineno-12-113"></a><span class="p">)</span>
</span><span id="__span-12-114"><a id="__codelineno-12-114" name="__codelineno-12-114"></a>
</span><span id="__span-12-115"><a id="__codelineno-12-115" name="__codelineno-12-115"></a><span class="c1">// 起始节点函数实现</span>
</span><span id="__span-12-116"><a id="__codelineno-12-116" name="__codelineno-12-116"></a><span class="kd">func</span><span class="w"> </span><span class="nx">startNodeFunc</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-117"><a id="__codelineno-12-117" name="__codelineno-12-117"></a><span class="w">    </span><span class="c1">// 从内置的 StateKeyUserInput 获取用户输入（由 Runner 自动设置）</span>
</span><span id="__span-12-118"><a id="__codelineno-12-118" name="__codelineno-12-118"></a><span class="w">    </span><span class="nx">input</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">state</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyUserInput</span><span class="p">].(</span><span class="kt">string</span><span class="p">)</span>
</span><span id="__span-12-119"><a id="__codelineno-12-119" name="__codelineno-12-119"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span>
</span><span id="__span-12-120"><a id="__codelineno-12-120" name="__codelineno-12-120"></a><span class="w">        </span><span class="nx">stateKeyProcessedData</span><span class="p">:</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;处理后的: %s&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">input</span><span class="p">),</span>
</span><span id="__span-12-121"><a id="__codelineno-12-121" name="__codelineno-12-121"></a><span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-12-122"><a id="__codelineno-12-122" name="__codelineno-12-122"></a><span class="p">}</span>
</span><span id="__span-12-123"><a id="__codelineno-12-123" name="__codelineno-12-123"></a>
</span><span id="__span-12-124"><a id="__codelineno-12-124" name="__codelineno-12-124"></a><span class="c1">// 处理节点函数实现</span>
</span><span id="__span-12-125"><a id="__codelineno-12-125" name="__codelineno-12-125"></a><span class="kd">func</span><span class="w"> </span><span class="nx">processNodeFunc</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-126"><a id="__codelineno-12-126" name="__codelineno-12-126"></a><span class="w">    </span><span class="nx">processed</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">state</span><span class="p">[</span><span class="nx">stateKeyProcessedData</span><span class="p">].(</span><span class="kt">string</span><span class="p">)</span>
</span><span id="__span-12-127"><a id="__codelineno-12-127" name="__codelineno-12-127"></a><span class="w">    </span><span class="nx">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;结果: %s&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">processed</span><span class="p">)</span>
</span><span id="__span-12-128"><a id="__codelineno-12-128" name="__codelineno-12-128"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span>
</span><span id="__span-12-129"><a id="__codelineno-12-129" name="__codelineno-12-129"></a><span class="w">        </span><span class="nx">stateKeyResult</span><span class="p">:</span><span class="w">             </span><span class="nx">result</span><span class="p">,</span>
</span><span id="__span-12-130"><a id="__codelineno-12-130" name="__codelineno-12-130"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyLastResponse</span><span class="p">:</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;最终结果: %s&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">result</span><span class="p">),</span>
</span><span id="__span-12-131"><a id="__codelineno-12-131" name="__codelineno-12-131"></a><span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-12-132"><a id="__codelineno-12-132" name="__codelineno-12-132"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="2-llm">2. 使用 LLM 节点</h3>
<p>LLM 节点实现了固定的三段式输入规则，无需配置：</p>
<ol>
<li><strong>OneShot 优先</strong>：<ul>
<li>若存在 <code>one_shot_messages_by_node[&lt;node_id&gt;]</code>，以它为本轮输入。</li>
<li>否则若存在 <code>one_shot_messages</code>，以它为本轮输入。</li>
</ul>
</li>
<li><strong>UserInput 其次</strong>：否则若存在 <code>user_input</code>，自动持久化一次。</li>
<li><strong>历史默认</strong>：否则以持久化历史作为输入。</li>
</ol>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-13-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-13-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-13-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-13-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-13-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-13-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-13-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-13-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-13-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-13-10">10</a></span>
<span class="normal"><a href="#__codelineno-13-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="c1">// 创建 LLM 模型</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2"></a><span class="nx">model</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">openai</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;gpt-4&quot;</span><span class="p">)</span>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3"></a>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4"></a><span class="c1">// 添加 LLM 节点</span>
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5"></a><span class="nx">stateGraph</span><span class="p">.</span><span class="nx">AddLLMNode</span><span class="p">(</span><span class="s">&quot;analyze&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">model</span><span class="p">,</span>
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6"></a><span class="w">    </span><span class="s">`你是一个文档分析专家。分析提供的文档并：</span>
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7"></a><span class="s">1. 分类文档类型和复杂度</span>
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8"></a><span class="s">2. 提取关键主题</span>
</span><span id="__span-13-9"><a id="__codelineno-13-9" name="__codelineno-13-9"></a><span class="s">3. 评估内容质量</span>
</span><span id="__span-13-10"><a id="__codelineno-13-10" name="__codelineno-13-10"></a><span class="s">请提供结构化的分析结果。`</span><span class="p">,</span>
</span><span id="__span-13-11"><a id="__codelineno-13-11" name="__codelineno-13-11"></a><span class="w">    </span><span class="kc">nil</span><span class="p">)</span><span class="w"> </span><span class="c1">// 工具映射</span>
</span></code></pre></div></td></tr></table></div>
<p><strong>重要说明</strong>：</p>
<ul>
<li>SystemPrompt 仅用于本次输入，不落持久化状态。</li>
<li>一次性键（<code>user_input</code>/<code>one_shot_messages</code>/<code>one_shot_messages_by_node</code>）
  在成功执行后自动清空。</li>
<li>并行分支：如果需要为不同的 LLM 节点准备不同的一次性输入，优先写
  <code>one_shot_messages_by_node</code>，避免多个分支同时写 <code>one_shot_messages</code>
  互相覆盖/清空。若由单个上游节点同时为多个 LLM 节点准备输入，推荐使用
  <code>graph.SetOneShotMessagesByNode(...)</code> 一次性写入所有 entry。</li>
<li>所有状态更新都是原子性的，确保一致性。</li>
<li>GraphAgent/Runner 仅设置 <code>user_input</code>，不再预先把用户消息写入
  <code>messages</code>。这样可以允许在 LLM 节点之前的任意节点对 <code>user_input</code>
  进行修改，并能在同一轮生效。</li>
<li>Graph 在执行子 Agent 时会保留父调用的 <code>RequestID</code>（请求标识），
  确保当会话历史里已包含本轮用户输入时，不会在提示词中重复插入。</li>
</ul>
<h4 id="vs">事件输出（流式分片 vs 最终消息）</h4>
<p>当大语言模型（Large Language Model，LLM）以流式模式被调用时，一次模型调用可能会产生
多条事件：</p>
<ul>
<li>流式分片：增量文本在 <code>choice.Delta.Content</code></li>
<li>最终消息：完整文本在 <code>choice.Message.Content</code></li>
</ul>
<p>在图式流程里，还存在两层“完成（done）”的含义：</p>
<ul>
<li>模型完成：某一次模型调用结束（通常 <code>Response.Done=true</code>）</li>
<li>流程完成：整个图运行结束（请以 <code>event.IsRunnerCompletion()</code> 为准）</li>
</ul>
<p>默认情况下，Graph 的 LLM 节点只输出流式分片事件，不输出最终 <code>Done=true</code> 的 assistant
消息事件。这样可以避免“中间节点的输出”被当作普通助手回复（例如被 Runner 写入会话
（Session））。</p>
<p>如果你希望 Graph 的 LLM 节点也输出最终 <code>Done=true</code> 的 assistant 消息事件，请在通过
Runner 运行时开启 <code>agent.WithGraphEmitFinalModelResponses(true)</code>。该选项的详细语义、
示例和注意事项请参见 <code>runner.md</code>。</p>
<p>小贴士：如果你通过 Runner 运行，并且主要只关心流式的大语言模型（Large Language
Model，LLM）消息（例如用于用户界面（User Interface，UI）的流式展示），可以使用
<code>agent.WithStreamMode(...)</code> 作为统一开关（见下文“事件监控”）。当选择
<code>agent.StreamModeMessages</code> 时，Runner 会为本次运行自动开启 Graph 的最终响应事件输出。</p>
<h4 id="_9">三种输入范式</h4>
<ul>
<li>
<p>OneShot（<code>StateKeyOneShotMessages</code>）：</p>
<ul>
<li>当该键存在时，本轮仅使用这里提供的 <code>[]model.Message</code> 调用模型，
  通常包含完整的 system prompt 与 user prompt。调用后自动清空。</li>
<li>适用场景：前置节点专门构造 prompt 的工作流，需完全覆盖本轮输入。</li>
<li>并行分支：当多个分支需要为不同的 LLM 节点准备 OneShot 输入时，
  优先使用 <code>StateKeyOneShotMessagesByNode</code>，避免共享键互相覆盖。</li>
<li>若由单个上游节点同时为多个 LLM 节点准备 OneShot 输入，推荐使用
  <code>graph.SetOneShotMessagesByNode(...)</code> 一次性写入。</li>
</ul>
</li>
</ul>
<ul>
<li>
<p>UserInput（<code>StateKeyUserInput</code>）：</p>
<ul>
<li>当 <code>user_input</code> 非空时，LLM 节点会取持久化历史 <code>messages</code>，并将
  本轮的用户输入合并后发起调用。结束后会把用户输入与助手回复通过
  <code>MessageOp</code>（例如 <code>AppendMessages</code>、<code>ReplaceLastUser</code>）原子性写入
  到 <code>messages</code>，并自动清空 <code>user_input</code> 以避免重复追加。</li>
<li>适用场景：普通对话式工作流，允许在前置节点动态调整用户输入。</li>
</ul>
</li>
</ul>
<ul>
<li>Messages only（仅 <code>StateKeyMessages</code>）：<ul>
<li>多用于工具调用回路。当第一轮经由 <code>user_input</code> 发起后，路由到工具
  节点执行，再回到 LLM 节点时，因为 <code>user_input</code> 已被清空，LLM 将走
  “Messages only” 分支，以历史中的 tool 响应继续推理。</li>
</ul>
</li>
</ul>
<h4 id="llm">LLM 指令中的占位符</h4>
<p>LLM 节点的 <code>instruction</code> 支持占位符注入（与 LLMAgent 规则一致）。支持原生 <code>{key}</code> 与 Mustache <code>{{key}}</code> 两种写法（Mustache 会自动规整为原生写法）：</p>
<ul>
<li><code>{key}</code> / <code>{{key}}</code> → 替换为会话状态中键 <code>key</code> 对应的字符串值（可通过 <code>sess.SetState("key", ...)</code> 或 SessionService 写入）</li>
<li><code>{key?}</code> / <code>{{key?}}</code> → 可选，缺失时替换为空</li>
<li><code>{user:subkey}</code>、<code>{app:subkey}</code>、<code>{temp:subkey}</code>（以及其 Mustache 写法）→ 访问用户/应用/临时命名空间（SessionService 会将 app/user 作用域合并到 session，并带上前缀）</li>
<li><code>{invocation:subkey}</code> / <code>{{invocation:subkey}}</code> → 替换为 <code>invocation.state["subkey"]</code>（可通过 <code>invocation.SetState("subkey", v)</code> 设置）</li>
</ul>
<p>说明：</p>
<ul>
<li>GraphAgent 会把当前 <code>*session.Session</code> 写入图状态的 <code>StateKeySession</code>，LLM 节点据此读取注入值</li>
<li><code>{invocation:*}</code> 从本次运行的 <code>*agent.Invocation</code> 读取</li>
<li>无前缀键（如 <code>research_topics</code>）需要直接存在于 <code>session.State</code></li>
</ul>
<p>示例：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-14-1">1</a></span>
<span class="normal"><a href="#__codelineno-14-2">2</a></span>
<span class="normal"><a href="#__codelineno-14-3">3</a></span>
<span class="normal"><a href="#__codelineno-14-4">4</a></span>
<span class="normal"><a href="#__codelineno-14-5">5</a></span>
<span class="normal"><a href="#__codelineno-14-6">6</a></span>
<span class="normal"><a href="#__codelineno-14-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="nx">mdl</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">openai</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="nx">modelName</span><span class="p">)</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2"></a><span class="nx">stateGraph</span><span class="p">.</span><span class="nx">AddLLMNode</span><span class="p">(</span>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3"></a><span class="w">  </span><span class="s">&quot;research&quot;</span><span class="p">,</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4"></a><span class="w">  </span><span class="nx">mdl</span><span class="p">,</span>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5"></a><span class="w">  </span><span class="s">&quot;You are a research assistant. Focus: {research_topics}. User: {user:topics?}. App: {app:banner?}.&quot;</span><span class="p">,</span>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6"></a><span class="w">  </span><span class="kc">nil</span><span class="p">,</span>
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7"></a><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>可参考可运行示例：<code>examples/graph/placeholder</code>。</p>
<p>将检索结果与用户输入注入指令</p>
<ul>
<li>在进入 LLM 节点前的任意节点，将临时值写入会话的 <code>temp:</code>
  命名空间，LLM 指令即可用占位符读取。</li>
<li>示例模式：</li>
</ul>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-15-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-15-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-15-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-15-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-15-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-15-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-15-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-15-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-15-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-15-10">10</a></span>
<span class="normal"><a href="#__codelineno-15-11">11</a></span>
<span class="normal"><a href="#__codelineno-15-12">12</a></span>
<span class="normal"><a href="#__codelineno-15-13">13</a></span>
<span class="normal"><a href="#__codelineno-15-14">14</a></span>
<span class="normal"><a href="#__codelineno-15-15">15</a></span>
<span class="normal"><a href="#__codelineno-15-16">16</a></span>
<span class="normal"><a href="#__codelineno-15-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1"></a><span class="c1">// 在 LLM 节点之前</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2"></a><span class="nx">stateGraph</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;retrieve&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3"></a><span class="w">    </span><span class="c1">// 假设你已经得到检索内容 retrieved，并希望连同当前用户输入一起注入</span>
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4"></a><span class="w">    </span><span class="nx">retrieved</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;• 文档A...\n• 文档B...&quot;</span>
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5"></a><span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">input</span><span class="w"> </span><span class="kt">string</span>
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">v</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">s</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyUserInput</span><span class="p">].(</span><span class="kt">string</span><span class="p">);</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">input</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">v</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">sess</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">s</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeySession</span><span class="p">].(</span><span class="o">*</span><span class="nx">session</span><span class="p">.</span><span class="nx">Session</span><span class="p">);</span><span class="w"> </span><span class="nx">sess</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-8"><a id="__codelineno-15-8" name="__codelineno-15-8"></a><span class="w">        </span><span class="nx">sess</span><span class="p">.</span><span class="nx">SetState</span><span class="p">(</span><span class="nx">session</span><span class="p">.</span><span class="nx">StateTempPrefix</span><span class="o">+</span><span class="s">&quot;retrieved_context&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">retrieved</span><span class="p">))</span>
</span><span id="__span-15-9"><a id="__codelineno-15-9" name="__codelineno-15-9"></a><span class="w">        </span><span class="nx">sess</span><span class="p">.</span><span class="nx">SetState</span><span class="p">(</span><span class="nx">session</span><span class="p">.</span><span class="nx">StateTempPrefix</span><span class="o">+</span><span class="s">&quot;user_input&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">input</span><span class="p">))</span>
</span><span id="__span-15-10"><a id="__codelineno-15-10" name="__codelineno-15-10"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-15-11"><a id="__codelineno-15-11" name="__codelineno-15-11"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-15-12"><a id="__codelineno-15-12" name="__codelineno-15-12"></a><span class="p">})</span>
</span><span id="__span-15-13"><a id="__codelineno-15-13" name="__codelineno-15-13"></a>
</span><span id="__span-15-14"><a id="__codelineno-15-14" name="__codelineno-15-14"></a><span class="c1">// LLM 节点的指令引用 {temp:retrieved_context} 和 {temp:user_input}</span>
</span><span id="__span-15-15"><a id="__codelineno-15-15" name="__codelineno-15-15"></a><span class="nx">stateGraph</span><span class="p">.</span><span class="nx">AddLLMNode</span><span class="p">(</span><span class="s">&quot;answer&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">mdl</span><span class="p">,</span>
</span><span id="__span-15-16"><a id="__codelineno-15-16" name="__codelineno-15-16"></a><span class="w">    </span><span class="s">&quot;请结合上下文回答。\n\n上下文：\n{temp:retrieved_context}\n\n问题：{temp:user_input}&quot;</span><span class="p">,</span>
</span><span id="__span-15-17"><a id="__codelineno-15-17" name="__codelineno-15-17"></a><span class="w">    </span><span class="kc">nil</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>示例：<code>examples/graph/retrieval_placeholder</code>。</p>
<p>占位符与会话状态的最佳实践</p>
<ul>
<li>会话内临时 vs 持久：通常用于提示词组装的临时数据写到 <code>temp:*</code>
  （常见做法是每轮覆盖，建议通过 <code>sess.SetState</code> 写入）；需要跨轮/
  跨会话保留的配置，请通过 SessionService（会话服务）更新
  <code>user:*</code>/<code>app:*</code>。</li>
<li>为什么推荐用 SetState：LLM 节点从图状态里的会话对象读取并展开占位符，使用 <code>sess.SetState</code> 可避免不安全的并发 map 访问。</li>
<li>服务侧护栏：内存实现禁止通过“更新用户态”的接口写 <code>temp:*</code>（以及 <code>app:*</code> via user updater），见 <a href="https://github.com/trpc-group/trpc-agent-go/blob/main/session/inmemory/service.go">session/inmemory/service.go</a>。</li>
<li>并发建议：并行分支不要同时改同一批 <code>session.State</code> 键；建议汇总到单节点合并后一次写入，或先放图状态再一次写到 <code>temp:*</code>。</li>
<li>可观测性：若希望在完成事件中看到摘要，可额外把精简信息放入图状态（如 <code>metadata</code>）；最终事件会序列化非内部的最终状态，见 <a href="https://github.com/trpc-group/trpc-agent-go/blob/main/graph/events.go">graph/events.go</a>。</li>
</ul>
<h4 id="reducer-messageop">通过 Reducer 与 MessageOp 实现的原子更新</h4>
<p>Graph 包的消息状态支持 <code>MessageOp</code> 补丁操作（如 <code>ReplaceLastUser</code>、
<code>AppendMessages</code> 等），由 <code>MessageReducer</code> 实现原子合并。这带来两个
直接收益：</p>
<ul>
<li>允许在 LLM 节点之前修改 <code>user_input</code>，LLM 节点会据此在一次返回中将
  需要的操作（例如替换最后一条用户消息、追加助手消息）以补丁形式返回，
  执行器一次性落库，避免竞态与重复。`</li>
<li>兼容传统的直接 <code>[]Message</code> 追加用法，同时为复杂更新提供更高的表达力。</li>
</ul>
<p>示例：在前置节点修改 <code>user_input</code>，随后进入 LLM 节点。</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-16-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-16-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-16-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-16-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-16-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-16-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-16-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-16-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-16-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-16-10">10</a></span>
<span class="normal"><a href="#__codelineno-16-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1"></a><span class="nx">stateGraph</span><span class="p">.</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2"></a><span class="w">    </span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;prepare_input&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3"></a><span class="w">        </span><span class="c1">// 清洗/改写用户输入，使其在本轮 LLM 中生效。</span>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4"></a><span class="w">        </span><span class="nx">cleaned</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">strings</span><span class="p">.</span><span class="nx">TrimSpace</span><span class="p">(</span><span class="nx">s</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyUserInput</span><span class="p">].(</span><span class="kt">string</span><span class="p">))</span>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyUserInput</span><span class="p">:</span><span class="w"> </span><span class="nx">cleaned</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6"></a><span class="w">    </span><span class="p">}).</span>
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7"></a><span class="w">    </span><span class="nx">AddLLMNode</span><span class="p">(</span><span class="s">&quot;ask&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">modelInstance</span><span class="p">,</span>
</span><span id="__span-16-8"><a id="__codelineno-16-8" name="__codelineno-16-8"></a><span class="w">        </span><span class="s">&quot;你是一个有帮助的助手。请简洁回答。&quot;</span><span class="p">,</span>
</span><span id="__span-16-9"><a id="__codelineno-16-9" name="__codelineno-16-9"></a><span class="w">        </span><span class="kc">nil</span><span class="p">).</span>
</span><span id="__span-16-10"><a id="__codelineno-16-10" name="__codelineno-16-10"></a><span class="w">    </span><span class="nx">SetEntryPoint</span><span class="p">(</span><span class="s">&quot;prepare_input&quot;</span><span class="p">).</span>
</span><span id="__span-16-11"><a id="__codelineno-16-11" name="__codelineno-16-11"></a><span class="w">    </span><span class="nx">SetFinishPoint</span><span class="p">(</span><span class="s">&quot;ask&quot;</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<h4 id="removeallmessages">使用 RemoveAllMessages 清除消息历史</h4>
<p>当多个 LLM 节点串联时，<code>MessageReducer</code> 会累积消息。如果每个 LLM 节点
需要独立的消息上下文（不继承前序节点的对话历史），可以使用
<code>RemoveAllMessages</code> 操作清除之前的消息：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-17-1">1</a></span>
<span class="normal"><a href="#__codelineno-17-2">2</a></span>
<span class="normal"><a href="#__codelineno-17-3">3</a></span>
<span class="normal"><a href="#__codelineno-17-4">4</a></span>
<span class="normal"><a href="#__codelineno-17-5">5</a></span>
<span class="normal"><a href="#__codelineno-17-6">6</a></span>
<span class="normal"><a href="#__codelineno-17-7">7</a></span>
<span class="normal"><a href="#__codelineno-17-8">8</a></span>
<span class="normal"><a href="#__codelineno-17-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1"></a><span class="c1">// 在准备 prompt 的节点中，先清除消息再设置新的 UserInput.</span>
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2"></a><span class="kd">func</span><span class="w"> </span><span class="nx">preparePromptNode</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3"></a><span class="w">    </span><span class="nx">userMessage</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">buildUserMessage</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span>
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5"></a><span class="w">        </span><span class="c1">// 关键：先清除之前的消息，避免累积.</span>
</span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyMessages</span><span class="p">:</span><span class="w">  </span><span class="nx">graph</span><span class="p">.</span><span class="nx">RemoveAllMessages</span><span class="p">{},</span>
</span><span id="__span-17-7"><a id="__codelineno-17-7" name="__codelineno-17-7"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyUserInput</span><span class="p">:</span><span class="w"> </span><span class="nx">userMessage</span><span class="p">,</span>
</span><span id="__span-17-8"><a id="__codelineno-17-8" name="__codelineno-17-8"></a><span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-17-9"><a id="__codelineno-17-9" name="__codelineno-17-9"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p><strong>适用场景</strong>：</p>
<ul>
<li>同一个 Graph 内有多个独立的 LLM 节点，每个节点不需要前序节点的对话历史</li>
<li>循环结构中，每次迭代需要全新的消息上下文</li>
<li>需要完全重建消息列表的场景</li>
</ul>
<p><strong>注意</strong>：</p>
<ul>
<li><code>RemoveAllMessages{}</code> 是一个特殊的 <code>MessageOp</code>，<code>MessageReducer</code> 会
  识别它并清空消息列表</li>
<li>必须在设置 <code>StateKeyUserInput</code> <strong>之前</strong>先设置 <code>RemoveAllMessages{}</code></li>
<li><code>WithSubgraphIsolatedMessages(true)</code> 只对 <code>AddSubgraphNode</code> 有效，
  对 <code>AddLLMNode</code> 无效；如需在 LLM 节点间隔离消息，请使用
  <code>RemoveAllMessages</code></li>
<li>对 Agent 节点来说，<code>WithSubgraphIsolatedMessages(true)</code> 会禁止向子 Agent
  注入会话历史；这也会让子 Agent 看不到工具返回，因此会破坏“工具多轮
  调用”。若子 Agent 需要多轮工具调用，请不要开启该选项，而应通过子 Agent
  的消息过滤能力来实现隔离（见“Agent 节点：隔离与工具多轮”）。</li>
</ul>
<h3 id="3-graphagent">3. GraphAgent 配置选项</h3>
<p>GraphAgent 支持多种配置选项：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-18-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-18-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-18-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-18-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-18-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-18-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-18-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-18-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-18-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-18-10">10</a></span>
<span class="normal"><a href="#__codelineno-18-11">11</a></span>
<span class="normal"><a href="#__codelineno-18-12">12</a></span>
<span class="normal"><a href="#__codelineno-18-13">13</a></span>
<span class="normal"><a href="#__codelineno-18-14">14</a></span>
<span class="normal"><a href="#__codelineno-18-15">15</a></span>
<span class="normal"><a href="#__codelineno-18-16">16</a></span>
<span class="normal"><a href="#__codelineno-18-17">17</a></span>
<span class="normal"><a href="#__codelineno-18-18">18</a></span>
<span class="normal"><a href="#__codelineno-18-19">19</a></span>
<span class="normal"><a href="#__codelineno-18-20">20</a></span>
<span class="normal"><a href="#__codelineno-18-21">21</a></span>
<span class="normal"><a href="#__codelineno-18-22">22</a></span>
<span class="normal"><a href="#__codelineno-18-23">23</a></span>
<span class="normal"><a href="#__codelineno-18-24">24</a></span>
<span class="normal"><a href="#__codelineno-18-25">25</a></span>
<span class="normal"><a href="#__codelineno-18-26">26</a></span>
<span class="normal"><a href="#__codelineno-18-27">27</a></span>
<span class="normal"><a href="#__codelineno-18-28">28</a></span>
<span class="normal"><a href="#__codelineno-18-29">29</a></span>
<span class="normal"><a href="#__codelineno-18-30">30</a></span>
<span class="normal"><a href="#__codelineno-18-31">31</a></span>
<span class="normal"><a href="#__codelineno-18-32">32</a></span>
<span class="normal"><a href="#__codelineno-18-33">33</a></span>
<span class="normal"><a href="#__codelineno-18-34">34</a></span>
<span class="normal"><a href="#__codelineno-18-35">35</a></span>
<span class="normal"><a href="#__codelineno-18-36">36</a></span>
<span class="normal"><a href="#__codelineno-18-37">37</a></span>
<span class="normal"><a href="#__codelineno-18-38">38</a></span>
<span class="normal"><a href="#__codelineno-18-39">39</a></span>
<span class="normal"><a href="#__codelineno-18-40">40</a></span>
<span class="normal"><a href="#__codelineno-18-41">41</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1"></a><span class="c1">// 创建 GraphAgent 时可以使用多种选项</span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2"></a><span class="nx">graphAgent</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span>
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3"></a><span class="w">    </span><span class="s">&quot;workflow-name&quot;</span><span class="p">,</span>
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4"></a><span class="w">    </span><span class="nx">compiledGraph</span><span class="p">,</span>
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithDescription</span><span class="p">(</span><span class="s">&quot;工作流描述&quot;</span><span class="p">),</span>
</span><span id="__span-18-6"><a id="__codelineno-18-6" name="__codelineno-18-6"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithInitialState</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span>
</span><span id="__span-18-7"><a id="__codelineno-18-7" name="__codelineno-18-7"></a><span class="w">        </span><span class="s">&quot;initial_data&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;初始数据&quot;</span><span class="p">,</span>
</span><span id="__span-18-8"><a id="__codelineno-18-8" name="__codelineno-18-8"></a><span class="w">    </span><span class="p">}),</span>
</span><span id="__span-18-9"><a id="__codelineno-18-9" name="__codelineno-18-9"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithChannelBufferSize</span><span class="p">(</span><span class="mi">1024</span><span class="p">),</span><span class="w">            </span><span class="c1">// 调整事件通道缓冲区</span>
</span><span id="__span-18-10"><a id="__codelineno-18-10" name="__codelineno-18-10"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithMaxConcurrency</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w">                  </span><span class="c1">// 限制并行任务数</span>
</span><span id="__span-18-11"><a id="__codelineno-18-11" name="__codelineno-18-11"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithCheckpointSaver</span><span class="p">(</span><span class="nx">memorySaver</span><span class="p">),</span><span class="w">       </span><span class="c1">// 使用持久化检查点</span>
</span><span id="__span-18-12"><a id="__codelineno-18-12" name="__codelineno-18-12"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithSubAgents</span><span class="p">([]</span><span class="nx">agent</span><span class="p">.</span><span class="nx">Agent</span><span class="p">{</span><span class="nx">subAgent</span><span class="p">}),</span><span class="w"> </span><span class="c1">// 配置子 Agent</span>
</span><span id="__span-18-13"><a id="__codelineno-18-13" name="__codelineno-18-13"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithAddSessionSummary</span><span class="p">(</span><span class="kc">true</span><span class="p">),</span><span class="w">            </span><span class="c1">// 将会话摘要注入 system 消息</span>
</span><span id="__span-18-14"><a id="__codelineno-18-14" name="__codelineno-18-14"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithMaxHistoryRuns</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span><span class="w">                  </span><span class="c1">// 未开启摘要时截断历史轮次</span>
</span><span id="__span-18-15"><a id="__codelineno-18-15" name="__codelineno-18-15"></a><span class="w">    </span><span class="c1">// 设置传给模型的消息过滤模式，最终传给模型的消息需同时满足WithMessageTimelineFilterMode与WithMessageBranchFilterMode条件</span>
</span><span id="__span-18-16"><a id="__codelineno-18-16" name="__codelineno-18-16"></a><span class="w">    </span><span class="c1">// 时间维度过滤条件</span>
</span><span id="__span-18-17"><a id="__codelineno-18-17" name="__codelineno-18-17"></a><span class="w">    </span><span class="c1">// 默认值: graphagent.TimelineFilterAll</span>
</span><span id="__span-18-18"><a id="__codelineno-18-18" name="__codelineno-18-18"></a><span class="w">    </span><span class="c1">// 可选值:</span>
</span><span id="__span-18-19"><a id="__codelineno-18-19" name="__codelineno-18-19"></a><span class="w">    </span><span class="c1">//  - graphagent.TimelineFilterAll: 包含历史消息以及当前请求中所生成的消息</span>
</span><span id="__span-18-20"><a id="__codelineno-18-20" name="__codelineno-18-20"></a><span class="w">    </span><span class="c1">//  - graphagent.TimelineFilterCurrentRequest: 仅包含当前请求中所生成的消息</span>
</span><span id="__span-18-21"><a id="__codelineno-18-21" name="__codelineno-18-21"></a><span class="w">    </span><span class="c1">//  - graphagent.TimelineFilterCurrentInvocation: 仅包含当前invocation上下文中生成的消息</span>
</span><span id="__span-18-22"><a id="__codelineno-18-22" name="__codelineno-18-22"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithMessageTimelineFilterMode</span><span class="p">(</span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">BranchFilterModeAll</span><span class="p">),</span>
</span><span id="__span-18-23"><a id="__codelineno-18-23" name="__codelineno-18-23"></a><span class="w">    </span><span class="c1">// 分支维度过滤条件</span>
</span><span id="__span-18-24"><a id="__codelineno-18-24" name="__codelineno-18-24"></a><span class="w">    </span><span class="c1">// 默认值: graphagent.BranchFilterModePrefix</span>
</span><span id="__span-18-25"><a id="__codelineno-18-25" name="__codelineno-18-25"></a><span class="w">    </span><span class="c1">// 可选值:</span>
</span><span id="__span-18-26"><a id="__codelineno-18-26" name="__codelineno-18-26"></a><span class="w">    </span><span class="c1">//  - graphagent.BranchFilterModeAll: 包含所有agent的消息, 当前agent与模型交互时,如需将所有agent生成的有效内容消息同步给模型时可设置该值</span>
</span><span id="__span-18-27"><a id="__codelineno-18-27" name="__codelineno-18-27"></a><span class="w">    </span><span class="c1">//  - graphagent.BranchFilterModePrefix: 通过Event.FilterKey与Invocation.eventFilterKey做前缀匹配过滤消息, 期望将与当前agent以及相关上下游agent生成的消息传递给模型时，可设置该值</span>
</span><span id="__span-18-28"><a id="__codelineno-18-28" name="__codelineno-18-28"></a><span class="w">    </span><span class="c1">//  - graphagent.BranchFilterModeExact: 通过Event.FilterKey==Invocation.eventFilterKey过滤消息，当前agent与模型交互时,仅需使用当前agent生成的消息时可设置该值</span>
</span><span id="__span-18-29"><a id="__codelineno-18-29" name="__codelineno-18-29"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithMessageBranchFilterMode</span><span class="p">(</span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">TimelineFilterAll</span><span class="p">),</span>
</span><span id="__span-18-30"><a id="__codelineno-18-30" name="__codelineno-18-30"></a><span class="w">    </span><span class="c1">// 推理内容模式（DeepSeek 思考模式）</span>
</span><span id="__span-18-31"><a id="__codelineno-18-31" name="__codelineno-18-31"></a><span class="w">    </span><span class="c1">// 默认值: graphagent.ReasoningContentModeDiscardPreviousTurns</span>
</span><span id="__span-18-32"><a id="__codelineno-18-32" name="__codelineno-18-32"></a><span class="w">    </span><span class="c1">// 可选值:</span>
</span><span id="__span-18-33"><a id="__codelineno-18-33" name="__codelineno-18-33"></a><span class="w">    </span><span class="c1">//  - graphagent.ReasoningContentModeDiscardPreviousTurns: 丢弃之前请求轮次的</span>
</span><span id="__span-18-34"><a id="__codelineno-18-34" name="__codelineno-18-34"></a><span class="w">    </span><span class="c1">//    reasoning_content（默认，推荐）</span>
</span><span id="__span-18-35"><a id="__codelineno-18-35" name="__codelineno-18-35"></a><span class="w">    </span><span class="c1">//  - graphagent.ReasoningContentModeKeepAll: 保留所有 reasoning_content</span>
</span><span id="__span-18-36"><a id="__codelineno-18-36" name="__codelineno-18-36"></a><span class="w">    </span><span class="c1">//  - graphagent.ReasoningContentModeDiscardAll: 丢弃所有 reasoning_content</span>
</span><span id="__span-18-37"><a id="__codelineno-18-37" name="__codelineno-18-37"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithReasoningContentMode</span><span class="p">(</span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">ReasoningContentModeDiscardPreviousTurns</span><span class="p">),</span>
</span><span id="__span-18-38"><a id="__codelineno-18-38" name="__codelineno-18-38"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithAgentCallbacks</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">agent</span><span class="p">.</span><span class="nx">Callbacks</span><span class="p">{</span>
</span><span id="__span-18-39"><a id="__codelineno-18-39" name="__codelineno-18-39"></a><span class="w">        </span><span class="c1">// Agent 级回调配置</span>
</span><span id="__span-18-40"><a id="__codelineno-18-40" name="__codelineno-18-40"></a><span class="w">    </span><span class="p">}),</span>
</span><span id="__span-18-41"><a id="__codelineno-18-41" name="__codelineno-18-41"></a><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<blockquote>
<p>模型/工具回调需要在节点级配置，例如 <code>AddLLMNode(..., graph.WithModelCallbacks(...))</code>
或 <code>AddToolsNode(..., graph.WithToolCallbacks(...))</code>。</p>
</blockquote>
<p>使用会话摘要的注意事项：</p>
<ul>
<li><code>WithAddSessionSummary(true)</code> 仅在 <code>Session.Summaries</code> 中已有对应 <code>FilterKey</code> 的摘要时生效。摘要通常由 SessionService + SessionSummarizer 生成，Runner 在落库事件后会自动触发 <code>EnqueueSummaryJob</code>。</li>
<li>GraphAgent 只读取摘要，不生成摘要。如果绕过 Runner，需在写入事件后自行调用 <code>sessionService.CreateSessionSummary</code> 或 <code>EnqueueSummaryJob</code>。</li>
<li>摘要仅在 <code>TimelineFilterAll</code> 下生效。</li>
</ul>
<h4 id="_10">摘要格式自定义</h4>
<p>默认情况下，会话摘要会以包含上下文标签和关于优先考虑当前对话信息的提示进行格式化：</p>
<p><strong>默认格式：</strong></p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-19-1">1</a></span>
<span class="normal"><a href="#__codelineno-19-2">2</a></span>
<span class="normal"><a href="#__codelineno-19-3">3</a></span>
<span class="normal"><a href="#__codelineno-19-4">4</a></span>
<span class="normal"><a href="#__codelineno-19-5">5</a></span>
<span class="normal"><a href="#__codelineno-19-6">6</a></span>
<span class="normal"><a href="#__codelineno-19-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1"></a>Here is a brief summary of your previous interactions:
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2"></a>
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3"></a>&lt;summary_of_previous_interactions&gt;
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4"></a>[摘要内容]
</span><span id="__span-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5"></a>&lt;/summary_of_previous_interactions&gt;
</span><span id="__span-19-6"><a id="__codelineno-19-6" name="__codelineno-19-6"></a>
</span><span id="__span-19-7"><a id="__codelineno-19-7" name="__codelineno-19-7"></a>Note: this information is from previous interactions and may be outdated. You should ALWAYS prefer information from this conversation over the past summary.
</span></code></pre></div></td></tr></table></div>
<p>您可以使用 <code>WithSummaryFormatter</code> 来自定义摘要格式，以更好地匹配您的特定使用场景或模型需求。</p>
<p><strong>自定义格式示例：</strong></p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-20-1">1</a></span>
<span class="normal"><a href="#__codelineno-20-2">2</a></span>
<span class="normal"><a href="#__codelineno-20-3">3</a></span>
<span class="normal"><a href="#__codelineno-20-4">4</a></span>
<span class="normal"><a href="#__codelineno-20-5">5</a></span>
<span class="normal"><a href="#__codelineno-20-6">6</a></span>
<span class="normal"><a href="#__codelineno-20-7">7</a></span>
<span class="normal"><a href="#__codelineno-20-8">8</a></span>
<span class="normal"><a href="#__codelineno-20-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1"></a><span class="c1">// 使用简化格式的自定义格式化器</span>
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2"></a><span class="nx">ga</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span>
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3"></a><span class="w">    </span><span class="s">&quot;my-graph&quot;</span><span class="p">,</span>
</span><span id="__span-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithInitialState</span><span class="p">(</span><span class="nx">initialState</span><span class="p">),</span>
</span><span id="__span-20-5"><a id="__codelineno-20-5" name="__codelineno-20-5"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithAddSessionSummary</span><span class="p">(</span><span class="kc">true</span><span class="p">),</span>
</span><span id="__span-20-6"><a id="__codelineno-20-6" name="__codelineno-20-6"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithSummaryFormatter</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">summary</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-20-7"><a id="__codelineno-20-7" name="__codelineno-20-7"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;## Previous Context\n\n%s&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">summary</span><span class="p">)</span>
</span><span id="__span-20-8"><a id="__codelineno-20-8" name="__codelineno-20-8"></a><span class="w">    </span><span class="p">}),</span>
</span><span id="__span-20-9"><a id="__codelineno-20-9" name="__codelineno-20-9"></a><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p><strong>使用场景：</strong></p>
<ul>
<li><strong>简化格式</strong>：使用简洁的标题和最少的上下文提示来减少 token 消耗</li>
<li><strong>语言本地化</strong>：将上下文提示翻译为目标语言（例如：中文、日语）</li>
<li><strong>角色特定格式</strong>：为不同的 Agent 角色提供不同的格式</li>
<li><strong>模型优化</strong>：根据特定模型的偏好调整格式</li>
</ul>
<p><strong>重要注意事项：</strong></p>
<ul>
<li>格式化函数接收来自会话的原始摘要文本并返回格式化后的字符串</li>
<li>自定义格式化器应确保摘要可与其他消息清楚地区分开</li>
<li>默认格式设计为与大多数模型和使用场景兼容</li>
<li>当使用 <code>WithAddSessionSummary(false)</code> 时，格式化器永远不会被调用</li>
</ul>
<h4 id="_11">并发使用注意事项</h4>
<p>在服务端将 Graph + GraphAgent 部署为长期运行、可并发复用的组件时（例如单个进程内同时处理多路请求），需要注意以下几点：</p>
<ul>
<li>自定义 CheckpointSaver / Cache 必须具备并发安全能力<br />
<code>CheckpointSaver</code> 与 <code>Cache</code> 接口本身是存储无关、线程无状态的抽象，同一个 <code>Executor</code> / <code>GraphAgent</code> 实例在并发执行多次时，会从多个 goroutine 调用它们的方法。如果你提供自定义实现，需要确保：<ul>
<li><code>CheckpointSaver</code> 的 <code>Get</code> / <code>GetTuple</code> / <code>List</code> / <code>Put</code> / <code>PutWrites</code> / <code>PutFull</code> / <code>DeleteLineage</code> 等方法在并发场景下是安全的；</li>
<li><code>Cache</code> 的 <code>Get</code> / <code>Set</code> / <code>Clear</code> 等方法在并发场景下是安全的；</li>
<li>内部使用的 map、连接池、内存缓冲区等都经过适当加锁或使用其它并发原语保护。</li>
</ul>
</li>
</ul>
<ul>
<li>NodeFunc / 工具 / 回调应把传入状态视为“本次调用本节点的局部数据”<br />
  每个节点在执行时会拿到一份针对当前任务的状态副本，这份副本在当前 goroutine 内修改是安全的，但是不建议：<ul>
<li>将该副本（或其中的 map / slice）保存到全局变量，再由其它 goroutine 后续修改；</li>
<li>从状态中取出 <code>StateKeyExecContext</code>（<code>*graph.ExecutionContext</code>）后，绕过内部锁直接读写 <code>execCtx.State</code> 或 <code>execCtx.pendingTasks</code> 等字段。
如果确实需要跨节点或跨调用共享可变数据，请使用你自己的同步手段（例如 <code>sync.Mutex</code> / <code>sync.RWMutex</code>），或者使用外部服务（数据库、缓存等）承载共享状态。</li>
</ul>
</li>
</ul>
<ul>
<li>不要在多个 goroutine 中复用同一个 *agent.Invocation<br />
  框架设计假定每次调用 <code>Run</code>（无论是 GraphAgent、Runner 还是其它 Agent 实现）都使用独立的 <code>*agent.Invocation</code> 实例。如果在多个 goroutine 中复用同一个 <code>*agent.Invocation</code> 并并行调用 <code>Run</code>，会在 <code>Branch</code>、<code>RunOptions</code>、回调状态等字段上产生数据竞争。推荐的做法是：<ul>
<li>每个请求构造一份新的 <code>*agent.Invocation</code>，或者</li>
<li>在需要保持关联时使用 <code>invocation.Clone(...)</code> 从父调用上克隆一份新的 Invocation。</li>
</ul>
</li>
</ul>
<ul>
<li>并行工具调用要求具体工具实现本身支持并发<br />
  当某个 Tools 节点使用 <code>WithEnableParallelTools(true)</code> 配置为“并行工具执行”时，在同一轮 step 内该节点会为每个工具调用起一个 goroutine 并行执行：<ul>
<li>框架保证 <code>tools</code> 映射在执行期间只读访问；</li>
<li>框架也保证传入工具的图状态在工具内部只读使用，状态更新由节点返回的 <code>State</code> 合并完成。
但每个具体的 <code>tool.Tool</code> 实现以及对应的 <code>tool.Callbacks</code> 可能会被多个 goroutine 同时调用，因此需要确保：</li>
<li>工具实现不会在没有加锁的情况下修改共享的全局变量或共享数据结构；</li>
<li>工具内部使用的缓存、HTTP 客户端、连接池等组件本身支持并发访问。</li>
</ul>
</li>
</ul>
<p>这些约束在单进程多请求的高并发场景下尤为重要，可以帮助你安全地复用同一个 <code>Graph</code> / <code>Executor</code> / <code>GraphAgent</code> 实例。</p>
<p>配置了子 Agent 后，可以在图中使用 Agent 节点委托执行：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-21-1">1</a></span>
<span class="normal"><a href="#__codelineno-21-2">2</a></span>
<span class="normal"><a href="#__codelineno-21-3">3</a></span>
<span class="normal"><a href="#__codelineno-21-4">4</a></span>
<span class="normal"><a href="#__codelineno-21-5">5</a></span>
<span class="normal"><a href="#__codelineno-21-6">6</a></span>
<span class="normal"><a href="#__codelineno-21-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1"></a><span class="c1">// 假设 subAgent.Info().Name == &quot;assistant&quot;</span>
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2"></a><span class="nx">stateGraph</span><span class="p">.</span><span class="nx">AddAgentNode</span><span class="p">(</span><span class="s">&quot;assistant&quot;</span><span class="p">,</span>
</span><span id="__span-21-3"><a id="__codelineno-21-3" name="__codelineno-21-3"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithName</span><span class="p">(</span><span class="s">&quot;子 Agent 调度&quot;</span><span class="p">),</span>
</span><span id="__span-21-4"><a id="__codelineno-21-4" name="__codelineno-21-4"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithDescription</span><span class="p">(</span><span class="s">&quot;调用预先注册的 assistant Agent&quot;</span><span class="p">),</span>
</span><span id="__span-21-5"><a id="__codelineno-21-5" name="__codelineno-21-5"></a><span class="p">)</span>
</span><span id="__span-21-6"><a id="__codelineno-21-6" name="__codelineno-21-6"></a>
</span><span id="__span-21-7"><a id="__codelineno-21-7" name="__codelineno-21-7"></a><span class="c1">// 执行时 GraphAgent 会在自身的 SubAgents 中查找同名 Agent 并发起调用</span>
</span></code></pre></div></td></tr></table></div>
<blockquote>
<p>Agent 节点会以节点 ID 作为查找键，因此需确保 <code>AddAgentNode("assistant")</code>
与 <code>subAgent.Info().Name == "assistant"</code> 一致。</p>
</blockquote>
<h4 id="agent-agent">Agent 节点：把上游输出传给下游 Agent</h4>
<p>Agent 节点不会自动把“上游输出”作为“下游输入”。边只负责控制执行顺序；数据必须通过 State
在节点之间显式传递。</p>
<p>默认情况下，Agent 节点会从 <code>state[graph.StateKeyUserInput]</code> 构造子代理的输入消息。
但 <code>user_input</code> 是<strong>一次性</strong>输入：LLM/Agent 节点成功执行后会清空它以避免重复消费。
因此当你写出 <code>A (agent) → B (agent)</code> 这种链路时，很容易出现“ A 有输出，但 B 看起来没拿到输入”的现象。</p>
<p>要让下游 Agent 消费上游结果，需要在下游 Agent 节点执行前，把目标字段写回 <code>user_input</code>：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-22-1">1</a></span>
<span class="normal"><a href="#__codelineno-22-2">2</a></span>
<span class="normal"><a href="#__codelineno-22-3">3</a></span>
<span class="normal"><a href="#__codelineno-22-4">4</a></span>
<span class="normal"><a href="#__codelineno-22-5">5</a></span>
<span class="normal"><a href="#__codelineno-22-6">6</a></span>
<span class="normal"><a href="#__codelineno-22-7">7</a></span>
<span class="normal"><a href="#__codelineno-22-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2"></a><span class="w">    </span><span class="nx">nodeA</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;a&quot;</span>
</span><span id="__span-22-3"><a id="__codelineno-22-3" name="__codelineno-22-3"></a><span class="w">    </span><span class="nx">nodeB</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;b&quot;</span>
</span><span id="__span-22-4"><a id="__codelineno-22-4" name="__codelineno-22-4"></a><span class="p">)</span>
</span><span id="__span-22-5"><a id="__codelineno-22-5" name="__codelineno-22-5"></a>
</span><span id="__span-22-6"><a id="__codelineno-22-6" name="__codelineno-22-6"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddAgentNode</span><span class="p">(</span><span class="nx">nodeA</span><span class="p">)</span>
</span><span id="__span-22-7"><a id="__codelineno-22-7" name="__codelineno-22-7"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddAgentNode</span><span class="p">(</span><span class="nx">nodeB</span><span class="p">,</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithSubgraphInputFromLastResponse</span><span class="p">())</span>
</span><span id="__span-22-8"><a id="__codelineno-22-8" name="__codelineno-22-8"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddEdge</span><span class="p">(</span><span class="nx">nodeA</span><span class="p">,</span><span class="w"> </span><span class="nx">nodeB</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>说明：</p>
<ul>
<li><code>WithSubgraphInputFromLastResponse()</code> 会把当前的 <code>last_response</code> 映射到该 Agent 节点的
  <code>user_input</code>，因此 <code>nodeB</code> 会把 <code>nodeA</code> 的输出当作输入。</li>
<li>如果你需要消费“指定节点”的输出（而不是最近一次），可以通过前置回调从
  <code>node_responses[targetNodeID]</code> 取值并写入 <code>user_input</code>。</li>
</ul>
<h4 id="agent_1">Agent 节点：拼接原始输入与上游输出</h4>
<p>有时下游 Agent 需要同时拿到：</p>
<ul>
<li>上游 Agent 的结果（常见是 <code>state[graph.StateKeyLastResponse]</code>），以及</li>
<li>本次 Run 的“原始用户请求”。</li>
</ul>
<p>由于 <code>user_input</code> 是一次性输入，会在 LLM/Agent 节点成功执行后被清空，你需要把原始输入
<strong>持久化</strong>到一个自定义 state key（例如 <code>original_user_input</code>），再显式拼接并写回
下游的 <code>user_input</code>。</p>
<p>最简单的写法是增加两个 function 节点：</p>
<ol>
<li>在入口处只保存一次初始 <code>user_input</code>；</li>
<li>在下游 Agent 前把 <code>original_user_input + last_response</code> 写回 <code>user_input</code>。</li>
</ol>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-23-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-23-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-23-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-23-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-23-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-23-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-23-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-23-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-23-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-23-10">10</a></span>
<span class="normal"><a href="#__codelineno-23-11">11</a></span>
<span class="normal"><a href="#__codelineno-23-12">12</a></span>
<span class="normal"><a href="#__codelineno-23-13">13</a></span>
<span class="normal"><a href="#__codelineno-23-14">14</a></span>
<span class="normal"><a href="#__codelineno-23-15">15</a></span>
<span class="normal"><a href="#__codelineno-23-16">16</a></span>
<span class="normal"><a href="#__codelineno-23-17">17</a></span>
<span class="normal"><a href="#__codelineno-23-18">18</a></span>
<span class="normal"><a href="#__codelineno-23-19">19</a></span>
<span class="normal"><a href="#__codelineno-23-20">20</a></span>
<span class="normal"><a href="#__codelineno-23-21">21</a></span>
<span class="normal"><a href="#__codelineno-23-22">22</a></span>
<span class="normal"><a href="#__codelineno-23-23">23</a></span>
<span class="normal"><a href="#__codelineno-23-24">24</a></span>
<span class="normal"><a href="#__codelineno-23-25">25</a></span>
<span class="normal"><a href="#__codelineno-23-26">26</a></span>
<span class="normal"><a href="#__codelineno-23-27">27</a></span>
<span class="normal"><a href="#__codelineno-23-28">28</a></span>
<span class="normal"><a href="#__codelineno-23-29">29</a></span>
<span class="normal"><a href="#__codelineno-23-30">30</a></span>
<span class="normal"><a href="#__codelineno-23-31">31</a></span>
<span class="normal"><a href="#__codelineno-23-32">32</a></span>
<span class="normal"><a href="#__codelineno-23-33">33</a></span>
<span class="normal"><a href="#__codelineno-23-34">34</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2"></a><span class="w">    </span><span class="nx">keyOriginalUserInput</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;original_user_input&quot;</span>
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3"></a>
</span><span id="__span-23-4"><a id="__codelineno-23-4" name="__codelineno-23-4"></a><span class="w">    </span><span class="nx">nodeSaveInput</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;save_input&quot;</span>
</span><span id="__span-23-5"><a id="__codelineno-23-5" name="__codelineno-23-5"></a><span class="w">    </span><span class="nx">nodeA</span><span class="w">         </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;a&quot;</span>
</span><span id="__span-23-6"><a id="__codelineno-23-6" name="__codelineno-23-6"></a><span class="w">    </span><span class="nx">nodeCompose</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;compose_input&quot;</span>
</span><span id="__span-23-7"><a id="__codelineno-23-7" name="__codelineno-23-7"></a><span class="w">    </span><span class="nx">nodeB</span><span class="w">         </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;b&quot;</span>
</span><span id="__span-23-8"><a id="__codelineno-23-8" name="__codelineno-23-8"></a><span class="p">)</span>
</span><span id="__span-23-9"><a id="__codelineno-23-9" name="__codelineno-23-9"></a>
</span><span id="__span-23-10"><a id="__codelineno-23-10" name="__codelineno-23-10"></a><span class="kd">func</span><span class="w"> </span><span class="nx">saveOriginalInput</span><span class="p">(</span><span class="nx">_</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-11"><a id="__codelineno-23-11" name="__codelineno-23-11"></a><span class="w">    </span><span class="nx">input</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">s</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyUserInput</span><span class="p">].(</span><span class="kt">string</span><span class="p">)</span>
</span><span id="__span-23-12"><a id="__codelineno-23-12" name="__codelineno-23-12"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">input</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-13"><a id="__codelineno-23-13" name="__codelineno-23-13"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-23-14"><a id="__codelineno-23-14" name="__codelineno-23-14"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-23-15"><a id="__codelineno-23-15" name="__codelineno-23-15"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="nx">keyOriginalUserInput</span><span class="p">:</span><span class="w"> </span><span class="nx">input</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-23-16"><a id="__codelineno-23-16" name="__codelineno-23-16"></a><span class="p">}</span>
</span><span id="__span-23-17"><a id="__codelineno-23-17" name="__codelineno-23-17"></a>
</span><span id="__span-23-18"><a id="__codelineno-23-18" name="__codelineno-23-18"></a><span class="kd">func</span><span class="w"> </span><span class="nx">composeNextInput</span><span class="p">(</span><span class="nx">_</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-19"><a id="__codelineno-23-19" name="__codelineno-23-19"></a><span class="w">    </span><span class="nx">orig</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">s</span><span class="p">[</span><span class="nx">keyOriginalUserInput</span><span class="p">].(</span><span class="kt">string</span><span class="p">)</span>
</span><span id="__span-23-20"><a id="__codelineno-23-20" name="__codelineno-23-20"></a><span class="w">    </span><span class="nx">last</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">s</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyLastResponse</span><span class="p">].(</span><span class="kt">string</span><span class="p">)</span>
</span><span id="__span-23-21"><a id="__codelineno-23-21" name="__codelineno-23-21"></a>
</span><span id="__span-23-22"><a id="__codelineno-23-22" name="__codelineno-23-22"></a><span class="w">    </span><span class="c1">// This becomes nodeB&#39;s Invocation.Message.Content.</span>
</span><span id="__span-23-23"><a id="__codelineno-23-23" name="__codelineno-23-23"></a><span class="w">    </span><span class="nx">combined</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">orig</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;\n\n&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">last</span>
</span><span id="__span-23-24"><a id="__codelineno-23-24" name="__codelineno-23-24"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyUserInput</span><span class="p">:</span><span class="w"> </span><span class="nx">combined</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-23-25"><a id="__codelineno-23-25" name="__codelineno-23-25"></a><span class="p">}</span>
</span><span id="__span-23-26"><a id="__codelineno-23-26" name="__codelineno-23-26"></a>
</span><span id="__span-23-27"><a id="__codelineno-23-27" name="__codelineno-23-27"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="nx">nodeSaveInput</span><span class="p">,</span><span class="w"> </span><span class="nx">saveOriginalInput</span><span class="p">)</span>
</span><span id="__span-23-28"><a id="__codelineno-23-28" name="__codelineno-23-28"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddAgentNode</span><span class="p">(</span><span class="nx">nodeA</span><span class="p">)</span>
</span><span id="__span-23-29"><a id="__codelineno-23-29" name="__codelineno-23-29"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="nx">nodeCompose</span><span class="p">,</span><span class="w"> </span><span class="nx">composeNextInput</span><span class="p">)</span>
</span><span id="__span-23-30"><a id="__codelineno-23-30" name="__codelineno-23-30"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddAgentNode</span><span class="p">(</span><span class="nx">nodeB</span><span class="p">)</span>
</span><span id="__span-23-31"><a id="__codelineno-23-31" name="__codelineno-23-31"></a>
</span><span id="__span-23-32"><a id="__codelineno-23-32" name="__codelineno-23-32"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddEdge</span><span class="p">(</span><span class="nx">nodeSaveInput</span><span class="p">,</span><span class="w"> </span><span class="nx">nodeA</span><span class="p">)</span>
</span><span id="__span-23-33"><a id="__codelineno-23-33" name="__codelineno-23-33"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddEdge</span><span class="p">(</span><span class="nx">nodeA</span><span class="p">,</span><span class="w"> </span><span class="nx">nodeCompose</span><span class="p">)</span>
</span><span id="__span-23-34"><a id="__codelineno-23-34" name="__codelineno-23-34"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddEdge</span><span class="p">(</span><span class="nx">nodeCompose</span><span class="p">,</span><span class="w"> </span><span class="nx">nodeB</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>重要：</p>
<ul>
<li>把 function 节点入参里的 <code>graph.State</code> 当作只读。</li>
<li>返回一个<strong>增量</strong>更新（一个小 <code>graph.State</code>），不要返回或原地修改“完整 state”。
  否则可能会覆盖内部 key（执行上下文、回调、session 等）导致工作流异常。</li>
</ul>
<h4 id="agent_2">Agent 节点：输入/输出映射（进阶）</h4>
<p>Agent 节点支持两个映射器，用于控制父图/子代理之间到底传什么：</p>
<ul>
<li><code>WithSubgraphInputMapper</code>：父 State → 子 RuntimeState（<code>Invocation.RunOptions.RuntimeState</code>）</li>
<li><code>WithSubgraphOutputMapper</code>：子执行结果 → 父 State 更新</li>
</ul>
<p>常见用途：</p>
<ul>
<li><strong>让子代理读取结构化状态</strong>（避免把结构化数据硬塞进 prompt）：通过
  <code>WithSubgraphInputMapper</code> 只传递必要键。可运行示例：
  <code>examples/graph/subagent_runtime_state</code>。</li>
<li><strong>把子图的结构化输出带回父图</strong>：当子代理是 GraphAgent 时，
  <code>SubgraphResult.FinalState</code> 会携带子图最终状态快照，可通过
  <code>WithSubgraphOutputMapper</code> 拷贝到父 State。可运行示例：
  <code>examples/graph/agent_state_handoff</code>。</li>
<li><strong>把子代理最终文本写入自定义键</strong>：<code>SubgraphResult</code> 总会包含 <code>LastResponse</code>，
  因此输出映射对 GraphAgent 与非图 Agent 都可用。</li>
</ul>
<h4 id="agent_3">Agent 节点：隔离与工具多轮</h4>
<p>工具调用通常是“多轮”的：模型（Large Language Model，LLM，大语言模型）
先返回一个工具调用（tool call），框架执行工具并产出结果，然后<strong>下一次</strong>
模型请求必须带上工具返回（一个 <code>role=tool</code> 的消息），模型才能基于工具结果
继续推理与输出。</p>
<p><code>WithSubgraphIsolatedMessages(true)</code> 是一个<strong>强隔离开关</strong>：它会阻止子 Agent
在构建下一轮模型请求时读取任何会话历史（内部等价于为子 Agent 设置
<code>include_contents="none"</code>）。这会让子 Agent 变成“黑盒”（只看本轮
<code>user_input</code>），但也意味着子 Agent 看不到工具返回，因此无法完成工具多轮。</p>
<p>如果子 Agent 需要使用工具，并且需要在工具返回后继续下一轮：</p>
<ul>
<li>不要在该 Agent 节点上开启 <code>WithSubgraphIsolatedMessages(true)</code>。</li>
<li>应保留会话注入，并通过子 Agent 自身的消息过滤把“可见历史”限制在其
  invocation（一次调用链）范围内。对于 <code>LLMAgent</code>，可使用：
  <code>llmagent.WithMessageFilterMode(llmagent.IsolatedInvocation)</code>。</li>
</ul>
<p>常见的错误现象：</p>
<ul>
<li>第二次模型请求与第一次几乎一致（prompt 里看不到工具返回）。</li>
<li>子 Agent 会重复第一轮工具调用，或进入循环，因为它永远“看不到”工具结果。</li>
</ul>
<h4 id="agent_4">Agent 节点：检查点与嵌套中断</h4>
<p>当子 Agent 本身也是 GraphAgent（基于图的 Agent），并且开启了检查点（checkpoint）时，
子图需要使用自己的检查点命名空间（checkpoint namespace）。否则子图可能会误用父图的
检查点进行恢复，导致执行位置与图结构不一致。</p>
<p>对于“Agent 节点调用 GraphAgent”的默认行为：</p>
<ul>
<li>子 GraphAgent 会使用子 Agent 的名称作为检查点命名空间，即使运行时状态是从父态克隆来的。</li>
<li>父图的检查点标识（ID）不会自动透传到子图；如果你需要指定，请通过子图输入映射显式设置。</li>
</ul>
<p>嵌套的人机协作（Human-in-the-Loop (HITL)）中断/恢复：</p>
<ul>
<li>当子 GraphAgent 调用 <code>graph.Interrupt</code> 时，父图也会中断并生成父检查点。</li>
<li>恢复时只需要恢复父检查点；当 Agent 节点再次执行时，会自动恢复子检查点。</li>
</ul>
<p>可运行示例：<code>examples/graph/nested_interrupt</code>。</p>
<h3 id="4">4. 条件路由</h3>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-24-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-24-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-24-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-24-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-24-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-24-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-24-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-24-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-24-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-24-10">10</a></span>
<span class="normal"><a href="#__codelineno-24-11">11</a></span>
<span class="normal"><a href="#__codelineno-24-12">12</a></span>
<span class="normal"><a href="#__codelineno-24-13">13</a></span>
<span class="normal"><a href="#__codelineno-24-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1"></a><span class="c1">// 定义条件函数</span>
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2"></a><span class="kd">func</span><span class="w"> </span><span class="nx">complexityCondition</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-24-3"><a id="__codelineno-24-3" name="__codelineno-24-3"></a><span class="w">    </span><span class="nx">complexity</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">state</span><span class="p">[</span><span class="s">&quot;complexity&quot;</span><span class="p">].(</span><span class="kt">string</span><span class="p">)</span>
</span><span id="__span-24-4"><a id="__codelineno-24-4" name="__codelineno-24-4"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">complexity</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;simple&quot;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-24-5"><a id="__codelineno-24-5" name="__codelineno-24-5"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;simple_process&quot;</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-24-6"><a id="__codelineno-24-6" name="__codelineno-24-6"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-24-7"><a id="__codelineno-24-7" name="__codelineno-24-7"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;complex_process&quot;</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-24-8"><a id="__codelineno-24-8" name="__codelineno-24-8"></a><span class="p">}</span>
</span><span id="__span-24-9"><a id="__codelineno-24-9" name="__codelineno-24-9"></a>
</span><span id="__span-24-10"><a id="__codelineno-24-10" name="__codelineno-24-10"></a><span class="c1">// 添加条件边</span>
</span><span id="__span-24-11"><a id="__codelineno-24-11" name="__codelineno-24-11"></a><span class="nx">stateGraph</span><span class="p">.</span><span class="nx">AddConditionalEdges</span><span class="p">(</span><span class="s">&quot;analyze&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">complexityCondition</span><span class="p">,</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span>
</span><span id="__span-24-12"><a id="__codelineno-24-12" name="__codelineno-24-12"></a><span class="w">    </span><span class="s">&quot;simple_process&quot;</span><span class="p">:</span><span class="w">  </span><span class="s">&quot;simple_node&quot;</span><span class="p">,</span>
</span><span id="__span-24-13"><a id="__codelineno-24-13" name="__codelineno-24-13"></a><span class="w">    </span><span class="s">&quot;complex_process&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;complex_node&quot;</span><span class="p">,</span>
</span><span id="__span-24-14"><a id="__codelineno-24-14" name="__codelineno-24-14"></a><span class="p">})</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="41-ends">4.1 节点命名分支（Ends）</h3>
<p>当一个节点需要把“业务结论”（例如 <code>approve</code>/<code>reject</code>/<code>manual_review</code>）路由到具体的下游节点时，建议在该节点上声明命名分支（Ends）。</p>
<p>作用与优势：</p>
<ul>
<li>在节点本地集中声明“符号名 → 具体目标”的映射，更直观、更易重构；</li>
<li>编译期校验：<code>Compile()</code> 会检查映射中的目标是否存在（或为常量 <code>graph.End</code>）；</li>
<li>路由统一：命令式路由（<code>Command.GoTo</code>）与条件路由都可复用同一份映射；</li>
<li>解耦：节点返回业务语义（例如 <code>GoTo:"approve"</code>），映射负责落地到图结构。</li>
</ul>
<p>API：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-25-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-25-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-25-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-25-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-25-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-25-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-25-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-25-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-25-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-25-10">10</a></span>
<span class="normal"><a href="#__codelineno-25-11">11</a></span>
<span class="normal"><a href="#__codelineno-25-12">12</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1"></a><span class="c1">// 在节点上声明 Ends（符号名到具体目标）</span>
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;decision&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">decideNode</span><span class="p">,</span>
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithEndsMap</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span>
</span><span id="__span-25-4"><a id="__codelineno-25-4" name="__codelineno-25-4"></a><span class="w">        </span><span class="s">&quot;approve&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;approved&quot;</span><span class="p">,</span>
</span><span id="__span-25-5"><a id="__codelineno-25-5" name="__codelineno-25-5"></a><span class="w">        </span><span class="s">&quot;reject&quot;</span><span class="p">:</span><span class="w">  </span><span class="s">&quot;rejected&quot;</span><span class="p">,</span>
</span><span id="__span-25-6"><a id="__codelineno-25-6" name="__codelineno-25-6"></a><span class="w">        </span><span class="c1">// 也可以把某个符号映射到终点</span>
</span><span id="__span-25-7"><a id="__codelineno-25-7" name="__codelineno-25-7"></a><span class="w">        </span><span class="c1">// &quot;drop&quot;:  graph.End,</span>
</span><span id="__span-25-8"><a id="__codelineno-25-8" name="__codelineno-25-8"></a><span class="w">    </span><span class="p">}),</span>
</span><span id="__span-25-9"><a id="__codelineno-25-9" name="__codelineno-25-9"></a><span class="p">)</span>
</span><span id="__span-25-10"><a id="__codelineno-25-10" name="__codelineno-25-10"></a>
</span><span id="__span-25-11"><a id="__codelineno-25-11" name="__codelineno-25-11"></a><span class="c1">// 简写：符号名与目标节点名相同的情况</span>
</span><span id="__span-25-12"><a id="__codelineno-25-12" name="__codelineno-25-12"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;router&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">routerNode</span><span class="p">,</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithEnds</span><span class="p">(</span><span class="s">&quot;nodeB&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;nodeC&quot;</span><span class="p">))</span>
</span></code></pre></div></td></tr></table></div>
<p>命令式路由（Command.GoTo）：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-26-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-26-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-26-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-26-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-26-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-26-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-26-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-26-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-26-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-26-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1"></a><span class="kd">func</span><span class="w"> </span><span class="nx">decideNode</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2"></a><span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="nx">s</span><span class="p">[</span><span class="s">&quot;decision&quot;</span><span class="p">].(</span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-3"><a id="__codelineno-26-3" name="__codelineno-26-3"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s">&quot;approve&quot;</span><span class="p">:</span>
</span><span id="__span-26-4"><a id="__codelineno-26-4" name="__codelineno-26-4"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">graph</span><span class="p">.</span><span class="nx">Command</span><span class="p">{</span><span class="nx">GoTo</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;approve&quot;</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="c1">// 符号名</span>
</span><span id="__span-26-5"><a id="__codelineno-26-5" name="__codelineno-26-5"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s">&quot;reject&quot;</span><span class="p">:</span>
</span><span id="__span-26-6"><a id="__codelineno-26-6" name="__codelineno-26-6"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">graph</span><span class="p">.</span><span class="nx">Command</span><span class="p">{</span><span class="nx">GoTo</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;reject&quot;</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-26-7"><a id="__codelineno-26-7" name="__codelineno-26-7"></a><span class="w">    </span><span class="k">default</span><span class="p">:</span>
</span><span id="__span-26-8"><a id="__codelineno-26-8" name="__codelineno-26-8"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">graph</span><span class="p">.</span><span class="nx">Command</span><span class="p">{</span><span class="nx">GoTo</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;reject&quot;</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-26-9"><a id="__codelineno-26-9" name="__codelineno-26-9"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-26-10"><a id="__codelineno-26-10" name="__codelineno-26-10"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>条件路由复用 Ends：当 <code>AddConditionalEdges(from, condition, pathMap)</code> 的 <code>pathMap</code> 为 <code>nil</code> 或未匹配到键时，执行器会继续使用该节点的 Ends 解析返回值；若仍未匹配，则把返回值当作具体节点 ID。</p>
<p>解析优先级：</p>
<ol>
<li>条件边 <code>pathMap</code> 的显式映射；</li>
<li>当前节点的 Ends 映射（符号名 → 具体目标）；</li>
<li>直接把返回值当作节点 ID。</li>
</ol>
<p>编译期校验：</p>
<ul>
<li><code>WithEndsMap/WithEnds</code> 中声明的目标会在 <code>Compile()</code> 阶段校验；</li>
<li>目标必须存在于图中或为特殊常量 <code>graph.End</code>。</li>
</ul>
<p>注意：</p>
<ul>
<li>请使用常量 <code>graph.End</code> 表示“终点”，不要使用字符串 "END"；</li>
<li>当通过 <code>Command.GoTo</code> 进行路由时，无需额外添加 <code>AddEdge(from, to)</code>；只需保证目标节点存在，若为终点需设置 <code>SetFinishPoint(target)</code>。</li>
</ul>
<p>完整可运行示例：<code>examples/graph/multiends</code>。</p>
<h3 id="42">4.2 多条件扇出（并行）</h3>
<p>当一次决策需要“同时”走多个分支（例如同时做摘要与打标签），可使用
<code>AddMultiConditionalEdges</code>：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-27-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-27-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-27-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-27-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-27-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-27-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-27-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-27-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-27-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-27-10">10</a></span>
<span class="normal"><a href="#__codelineno-27-11">11</a></span>
<span class="normal"><a href="#__codelineno-27-12">12</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1"></a><span class="c1">// 返回多个分支键，每个分支键解析为一个具体目标节点。</span>
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddMultiConditionalEdges</span><span class="p">(</span>
</span><span id="__span-27-3"><a id="__codelineno-27-3" name="__codelineno-27-3"></a><span class="w">    </span><span class="s">&quot;router&quot;</span><span class="p">,</span>
</span><span id="__span-27-4"><a id="__codelineno-27-4" name="__codelineno-27-4"></a><span class="w">    </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">([]</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-27-5"><a id="__codelineno-27-5" name="__codelineno-27-5"></a><span class="w">        </span><span class="c1">// 一次决策，同时走两个分支</span>
</span><span id="__span-27-6"><a id="__codelineno-27-6" name="__codelineno-27-6"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&quot;toA&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;toB&quot;</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-27-7"><a id="__codelineno-27-7" name="__codelineno-27-7"></a><span class="w">    </span><span class="p">},</span>
</span><span id="__span-27-8"><a id="__codelineno-27-8" name="__codelineno-27-8"></a><span class="w">    </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span>
</span><span id="__span-27-9"><a id="__codelineno-27-9" name="__codelineno-27-9"></a><span class="w">        </span><span class="s">&quot;toA&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;A&quot;</span><span class="p">,</span><span class="w"> </span><span class="c1">// 分支键 -&gt; 目标节点</span>
</span><span id="__span-27-10"><a id="__codelineno-27-10" name="__codelineno-27-10"></a><span class="w">        </span><span class="s">&quot;toB&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;B&quot;</span><span class="p">,</span>
</span><span id="__span-27-11"><a id="__codelineno-27-11" name="__codelineno-27-11"></a><span class="w">    </span><span class="p">},</span>
</span><span id="__span-27-12"><a id="__codelineno-27-12" name="__codelineno-27-12"></a><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>说明：</p>
<ul>
<li>返回结果会先去重，同一分支键在同一步内只触发一次；</li>
<li>每个分支键的解析优先级与单条件路由一致：<ol>
<li>条件边 <code>pathMap</code>；2) 节点 Ends；3) 直接当作节点 ID；</li>
</ol>
</li>
<li>可视化：当未提供 <code>pathMap</code> 时，DOT 会回退使用该节点的 Ends 来渲染虚线
  条件边（仅用于可视化，方便理解流程）。</li>
</ul>
<h3 id="5">5. 工具节点集成</h3>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-28-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-28-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-28-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-28-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-28-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-28-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-28-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-28-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-28-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-28-10">10</a></span>
<span class="normal"><a href="#__codelineno-28-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1"></a><span class="c1">// 创建工具</span>
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2"></a><span class="nx">tools</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">tool</span><span class="p">.</span><span class="nx">Tool</span><span class="p">{</span>
</span><span id="__span-28-3"><a id="__codelineno-28-3" name="__codelineno-28-3"></a><span class="w">    </span><span class="s">&quot;calculator&quot;</span><span class="p">:</span><span class="w"> </span><span class="nx">calculatorTool</span><span class="p">,</span>
</span><span id="__span-28-4"><a id="__codelineno-28-4" name="__codelineno-28-4"></a><span class="w">    </span><span class="s">&quot;search&quot;</span><span class="p">:</span><span class="w">     </span><span class="nx">searchTool</span><span class="p">,</span>
</span><span id="__span-28-5"><a id="__codelineno-28-5" name="__codelineno-28-5"></a><span class="p">}</span>
</span><span id="__span-28-6"><a id="__codelineno-28-6" name="__codelineno-28-6"></a>
</span><span id="__span-28-7"><a id="__codelineno-28-7" name="__codelineno-28-7"></a><span class="c1">// 添加工具节点</span>
</span><span id="__span-28-8"><a id="__codelineno-28-8" name="__codelineno-28-8"></a><span class="nx">stateGraph</span><span class="p">.</span><span class="nx">AddToolsNode</span><span class="p">(</span><span class="s">&quot;tools&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">tools</span><span class="p">)</span>
</span><span id="__span-28-9"><a id="__codelineno-28-9" name="__codelineno-28-9"></a>
</span><span id="__span-28-10"><a id="__codelineno-28-10" name="__codelineno-28-10"></a><span class="c1">// 添加 LLM 到工具的条件路由</span>
</span><span id="__span-28-11"><a id="__codelineno-28-11" name="__codelineno-28-11"></a><span class="nx">stateGraph</span><span class="p">.</span><span class="nx">AddToolsConditionalEdges</span><span class="p">(</span><span class="s">&quot;llm_node&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;tools&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;fallback_node&quot;</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>开启工具并行执行（与 LLMAgent 的选项对齐）：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-29-1">1</a></span>
<span class="normal"><a href="#__codelineno-29-2">2</a></span>
<span class="normal"><a href="#__codelineno-29-3">3</a></span>
<span class="normal"><a href="#__codelineno-29-4">4</a></span>
<span class="normal"><a href="#__codelineno-29-5">5</a></span>
<span class="normal"><a href="#__codelineno-29-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1"></a><span class="c1">// 当同一条 assistant 消息包含多个 tool_calls 时，并行执行以加速整体耗时。</span>
</span><span id="__span-29-2"><a id="__codelineno-29-2" name="__codelineno-29-2"></a><span class="nx">stateGraph</span><span class="p">.</span><span class="nx">AddToolsNode</span><span class="p">(</span>
</span><span id="__span-29-3"><a id="__codelineno-29-3" name="__codelineno-29-3"></a><span class="w">    </span><span class="s">&quot;tools&quot;</span><span class="p">,</span>
</span><span id="__span-29-4"><a id="__codelineno-29-4" name="__codelineno-29-4"></a><span class="w">    </span><span class="nx">tools</span><span class="p">,</span>
</span><span id="__span-29-5"><a id="__codelineno-29-5" name="__codelineno-29-5"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithEnableParallelTools</span><span class="p">(</span><span class="kc">true</span><span class="p">),</span><span class="w"> </span><span class="c1">// 可选；默认串行</span>
</span><span id="__span-29-6"><a id="__codelineno-29-6" name="__codelineno-29-6"></a><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p><strong>工具调用配对机制与二次进入 LLM：</strong></p>
<ul>
<li>从 <code>messages</code> 尾部向前扫描最近的 <code>assistant(tool_calls)</code>；遇到 <code>user</code>
  则停止，确保配对正确。</li>
<li>当工具节点完成后返回到 LLM 节点时，<code>user_input</code> 已被清空，LLM 将走
  “Messages only” 分支，以历史中的 tool 响应继续推理。</li>
</ul>
<h3 id="6">6. 节点重试与退避</h3>
<p>为节点配置指数退避的重试策略（可选抖动）。失败的尝试不会产生写入；只有成功的一次才会落库并触发路由。</p>
<ul>
<li>节点级策略（<code>WithRetryPolicy</code>）：</li>
</ul>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-30-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-30-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-30-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-30-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-30-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-30-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-30-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-30-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-30-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-30-10">10</a></span>
<span class="normal"><a href="#__codelineno-30-11">11</a></span>
<span class="normal"><a href="#__codelineno-30-12">12</a></span>
<span class="normal"><a href="#__codelineno-30-13">13</a></span>
<span class="normal"><a href="#__codelineno-30-14">14</a></span>
<span class="normal"><a href="#__codelineno-30-15">15</a></span>
<span class="normal"><a href="#__codelineno-30-16">16</a></span>
<span class="normal"><a href="#__codelineno-30-17">17</a></span>
<span class="normal"><a href="#__codelineno-30-18">18</a></span>
<span class="normal"><a href="#__codelineno-30-19">19</a></span>
<span class="normal"><a href="#__codelineno-30-20">20</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1"></a><span class="c1">// 便捷策略（attempts 含首次尝试）</span>
</span><span id="__span-30-2"><a id="__codelineno-30-2" name="__codelineno-30-2"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;unstable&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">unstableFunc</span><span class="p">,</span>
</span><span id="__span-30-3"><a id="__codelineno-30-3" name="__codelineno-30-3"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithRetryPolicy</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithSimpleRetry</span><span class="p">(</span><span class="mi">3</span><span class="p">)))</span>
</span><span id="__span-30-4"><a id="__codelineno-30-4" name="__codelineno-30-4"></a>
</span><span id="__span-30-5"><a id="__codelineno-30-5" name="__codelineno-30-5"></a><span class="c1">// 完整策略</span>
</span><span id="__span-30-6"><a id="__codelineno-30-6" name="__codelineno-30-6"></a><span class="nx">policy</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">RetryPolicy</span><span class="p">{</span>
</span><span id="__span-30-7"><a id="__codelineno-30-7" name="__codelineno-30-7"></a><span class="w">    </span><span class="nx">MaxAttempts</span><span class="p">:</span><span class="w">     </span><span class="mi">3</span><span class="p">,</span><span class="w">                      </span><span class="c1">// 1 次首试 + 最多 2 次重试</span>
</span><span id="__span-30-8"><a id="__codelineno-30-8" name="__codelineno-30-8"></a><span class="w">    </span><span class="nx">InitialInterval</span><span class="p">:</span><span class="w"> </span><span class="mi">200</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span><span class="p">,</span><span class="w"> </span><span class="c1">// 基础等待</span>
</span><span id="__span-30-9"><a id="__codelineno-30-9" name="__codelineno-30-9"></a><span class="w">    </span><span class="nx">BackoffFactor</span><span class="p">:</span><span class="w">   </span><span class="mf">2.0</span><span class="p">,</span><span class="w">                    </span><span class="c1">// 指数增长</span>
</span><span id="__span-30-10"><a id="__codelineno-30-10" name="__codelineno-30-10"></a><span class="w">    </span><span class="nx">MaxInterval</span><span class="p">:</span><span class="w">     </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">,</span><span class="w">        </span><span class="c1">// 上限</span>
</span><span id="__span-30-11"><a id="__codelineno-30-11" name="__codelineno-30-11"></a><span class="w">    </span><span class="nx">Jitter</span><span class="p">:</span><span class="w">          </span><span class="kc">true</span><span class="p">,</span><span class="w">                   </span><span class="c1">// 抖动</span>
</span><span id="__span-30-12"><a id="__codelineno-30-12" name="__codelineno-30-12"></a><span class="w">    </span><span class="nx">RetryOn</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="nx">graph</span><span class="p">.</span><span class="nx">RetryCondition</span><span class="p">{</span>
</span><span id="__span-30-13"><a id="__codelineno-30-13" name="__codelineno-30-13"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">DefaultTransientCondition</span><span class="p">(),</span><span class="w">   </span><span class="c1">// 截止/网络超时等瞬时错误</span>
</span><span id="__span-30-14"><a id="__codelineno-30-14" name="__codelineno-30-14"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">RetryOnErrors</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">DeadlineExceeded</span><span class="p">),</span>
</span><span id="__span-30-15"><a id="__codelineno-30-15" name="__codelineno-30-15"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">RetryOnPredicate</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">}),</span>
</span><span id="__span-30-16"><a id="__codelineno-30-16" name="__codelineno-30-16"></a><span class="w">    </span><span class="p">},</span>
</span><span id="__span-30-17"><a id="__codelineno-30-17" name="__codelineno-30-17"></a><span class="w">    </span><span class="nx">MaxElapsedTime</span><span class="p">:</span><span class="w">  </span><span class="mi">5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">,</span><span class="w">        </span><span class="c1">// 总重试预算（可选）</span>
</span><span id="__span-30-18"><a id="__codelineno-30-18" name="__codelineno-30-18"></a><span class="w">    </span><span class="c1">// PerAttemptTimeout: 0,                 // 预留；节点超时由执行器控制</span>
</span><span id="__span-30-19"><a id="__codelineno-30-19" name="__codelineno-30-19"></a><span class="p">}</span>
</span><span id="__span-30-20"><a id="__codelineno-30-20" name="__codelineno-30-20"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;unstable&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">unstableFunc</span><span class="p">,</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithRetryPolicy</span><span class="p">(</span><span class="nx">policy</span><span class="p">))</span>
</span></code></pre></div></td></tr></table></div>
<ul>
<li>执行器默认策略（当节点未配置时生效）：</li>
</ul>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-31-1">1</a></span>
<span class="normal"><a href="#__codelineno-31-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1"></a><span class="nx">exec</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewExecutor</span><span class="p">(</span><span class="nx">compiled</span><span class="p">,</span>
</span><span id="__span-31-2"><a id="__codelineno-31-2" name="__codelineno-31-2"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithDefaultRetryPolicy</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithSimpleRetry</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span>
</span></code></pre></div></td></tr></table></div>
<p>注意事项</p>
<ul>
<li>中断（interrupt）不参与重试。</li>
<li>当设置了步骤超时（<code>WithStepTimeout</code>）时，退避时间会被当前步骤的截止时间钳制。</li>
<li>事件会携带重试元数据，便于 CLI/UI 展示进度：</li>
</ul>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-32-1">1</a></span>
<span class="normal"><a href="#__codelineno-32-2">2</a></span>
<span class="normal"><a href="#__codelineno-32-3">3</a></span>
<span class="normal"><a href="#__codelineno-32-4">4</a></span>
<span class="normal"><a href="#__codelineno-32-5">5</a></span>
<span class="normal"><a href="#__codelineno-32-6">6</a></span>
<span class="normal"><a href="#__codelineno-32-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1"></a><span class="k">if</span><span class="w"> </span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">ev</span><span class="p">.</span><span class="nx">StateDelta</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">MetadataKeyNode</span><span class="p">];</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-32-2"><a id="__codelineno-32-2" name="__codelineno-32-2"></a><span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">md</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NodeExecutionMetadata</span>
</span><span id="__span-32-3"><a id="__codelineno-32-3" name="__codelineno-32-3"></a><span class="w">    </span><span class="nx">_</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">json</span><span class="p">.</span><span class="nx">Unmarshal</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">md</span><span class="p">)</span>
</span><span id="__span-32-4"><a id="__codelineno-32-4" name="__codelineno-32-4"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">md</span><span class="p">.</span><span class="nx">Phase</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">ExecutionPhaseError</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">md</span><span class="p">.</span><span class="nx">Retrying</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-32-5"><a id="__codelineno-32-5" name="__codelineno-32-5"></a><span class="w">        </span><span class="c1">// md.Attempt, md.MaxAttempts, md.NextDelay</span>
</span><span id="__span-32-6"><a id="__codelineno-32-6" name="__codelineno-32-6"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-32-7"><a id="__codelineno-32-7" name="__codelineno-32-7"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>示例：<code>examples/graph/retry</code> 展示了一个会先失败后成功的节点，并在成功后进入下游 LLM 输出最终答案。</p>
<h3 id="7-runner">7. Runner 配置</h3>
<p>Runner 提供了会话管理和执行环境：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-33-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-33-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-33-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-33-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-33-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-33-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-33-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-33-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-33-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-33-10">10</a></span>
<span class="normal"><a href="#__codelineno-33-11">11</a></span>
<span class="normal"><a href="#__codelineno-33-12">12</a></span>
<span class="normal"><a href="#__codelineno-33-13">13</a></span>
<span class="normal"><a href="#__codelineno-33-14">14</a></span>
<span class="normal"><a href="#__codelineno-33-15">15</a></span>
<span class="normal"><a href="#__codelineno-33-16">16</a></span>
<span class="normal"><a href="#__codelineno-33-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1"></a><span class="c1">// 创建会话服务</span>
</span><span id="__span-33-2"><a id="__codelineno-33-2" name="__codelineno-33-2"></a><span class="nx">sessionService</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">inmemory</span><span class="p">.</span><span class="nx">NewSessionService</span><span class="p">()</span>
</span><span id="__span-33-3"><a id="__codelineno-33-3" name="__codelineno-33-3"></a><span class="c1">// 或者使用 Redis 会话服务</span>
</span><span id="__span-33-4"><a id="__codelineno-33-4" name="__codelineno-33-4"></a><span class="c1">// sessionService, err := redis.NewService(redis.WithRedisClientURL(&quot;redis://localhost:6379&quot;))</span>
</span><span id="__span-33-5"><a id="__codelineno-33-5" name="__codelineno-33-5"></a>
</span><span id="__span-33-6"><a id="__codelineno-33-6" name="__codelineno-33-6"></a><span class="c1">// 创建 Runner</span>
</span><span id="__span-33-7"><a id="__codelineno-33-7" name="__codelineno-33-7"></a><span class="nx">appRunner</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">runner</span><span class="p">.</span><span class="nx">NewRunner</span><span class="p">(</span>
</span><span id="__span-33-8"><a id="__codelineno-33-8" name="__codelineno-33-8"></a><span class="w">    </span><span class="s">&quot;app-name&quot;</span><span class="p">,</span>
</span><span id="__span-33-9"><a id="__codelineno-33-9" name="__codelineno-33-9"></a><span class="w">    </span><span class="nx">graphAgent</span><span class="p">,</span>
</span><span id="__span-33-10"><a id="__codelineno-33-10" name="__codelineno-33-10"></a><span class="w">    </span><span class="nx">runner</span><span class="p">.</span><span class="nx">WithSessionService</span><span class="p">(</span><span class="nx">sessionService</span><span class="p">),</span>
</span><span id="__span-33-11"><a id="__codelineno-33-11" name="__codelineno-33-11"></a><span class="w">    </span><span class="c1">// 可以添加更多配置选项</span>
</span><span id="__span-33-12"><a id="__codelineno-33-12" name="__codelineno-33-12"></a><span class="p">)</span>
</span><span id="__span-33-13"><a id="__codelineno-33-13" name="__codelineno-33-13"></a>
</span><span id="__span-33-14"><a id="__codelineno-33-14" name="__codelineno-33-14"></a><span class="c1">// 使用 Runner 执行工作流</span>
</span><span id="__span-33-15"><a id="__codelineno-33-15" name="__codelineno-33-15"></a><span class="c1">// Runner 仅设置 StateKeyUserInput，不再预先写入 StateKeyMessages。</span>
</span><span id="__span-33-16"><a id="__codelineno-33-16" name="__codelineno-33-16"></a><span class="nx">message</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">model</span><span class="p">.</span><span class="nx">NewUserMessage</span><span class="p">(</span><span class="s">&quot;用户输入&quot;</span><span class="p">)</span>
</span><span id="__span-33-17"><a id="__codelineno-33-17" name="__codelineno-33-17"></a><span class="nx">eventChan</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">appRunner</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">userID</span><span class="p">,</span><span class="w"> </span><span class="nx">sessionID</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="8">8. 消息状态模式</h3>
<p>对于对话式应用，可以使用预定义的消息状态模式：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-34-1">1</a></span>
<span class="normal"><a href="#__codelineno-34-2">2</a></span>
<span class="normal"><a href="#__codelineno-34-3">3</a></span>
<span class="normal"><a href="#__codelineno-34-4">4</a></span>
<span class="normal"><a href="#__codelineno-34-5">5</a></span>
<span class="normal"><a href="#__codelineno-34-6">6</a></span>
<span class="normal"><a href="#__codelineno-34-7">7</a></span>
<span class="normal"><a href="#__codelineno-34-8">8</a></span>
<span class="normal"><a href="#__codelineno-34-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1"></a><span class="c1">// 使用消息状态模式</span>
</span><span id="__span-34-2"><a id="__codelineno-34-2" name="__codelineno-34-2"></a><span class="nx">schema</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">MessagesStateSchema</span><span class="p">()</span>
</span><span id="__span-34-3"><a id="__codelineno-34-3" name="__codelineno-34-3"></a>
</span><span id="__span-34-4"><a id="__codelineno-34-4" name="__codelineno-34-4"></a><span class="c1">// 这个模式包含：</span>
</span><span id="__span-34-5"><a id="__codelineno-34-5" name="__codelineno-34-5"></a><span class="c1">// - messages: 对话历史（StateKeyMessages）</span>
</span><span id="__span-34-6"><a id="__codelineno-34-6" name="__codelineno-34-6"></a><span class="c1">// - user_input: 用户输入（StateKeyUserInput）</span>
</span><span id="__span-34-7"><a id="__codelineno-34-7" name="__codelineno-34-7"></a><span class="c1">// - last_response: 最后响应（StateKeyLastResponse）</span>
</span><span id="__span-34-8"><a id="__codelineno-34-8" name="__codelineno-34-8"></a><span class="c1">// - node_responses: 节点响应映射（StateKeyNodeResponses）</span>
</span><span id="__span-34-9"><a id="__codelineno-34-9" name="__codelineno-34-9"></a><span class="c1">// - metadata: 元数据（StateKeyMetadata）</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="9">9. 状态键使用场景</h3>
<p><strong>用户自定义状态键</strong>：用于存储业务逻辑数据</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-35-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-35-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-35-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-35-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-35-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-35-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-35-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-35-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-35-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-35-10">10</a></span>
<span class="normal"><a href="#__codelineno-35-11">11</a></span>
<span class="normal"><a href="#__codelineno-35-12">12</a></span>
<span class="normal"><a href="#__codelineno-35-13">13</a></span>
<span class="normal"><a href="#__codelineno-35-14">14</a></span>
<span class="normal"><a href="#__codelineno-35-15">15</a></span>
<span class="normal"><a href="#__codelineno-35-16">16</a></span>
<span class="normal"><a href="#__codelineno-35-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-35-2"><a id="__codelineno-35-2" name="__codelineno-35-2"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-35-3"><a id="__codelineno-35-3" name="__codelineno-35-3"></a><span class="p">)</span>
</span><span id="__span-35-4"><a id="__codelineno-35-4" name="__codelineno-35-4"></a>
</span><span id="__span-35-5"><a id="__codelineno-35-5" name="__codelineno-35-5"></a><span class="c1">// 推荐：使用自定义状态键</span>
</span><span id="__span-35-6"><a id="__codelineno-35-6" name="__codelineno-35-6"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-35-7"><a id="__codelineno-35-7" name="__codelineno-35-7"></a><span class="w">    </span><span class="nx">StateKeyDocumentLength</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;document_length&quot;</span>
</span><span id="__span-35-8"><a id="__codelineno-35-8" name="__codelineno-35-8"></a><span class="w">    </span><span class="nx">StateKeyComplexityLevel</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;complexity_level&quot;</span>
</span><span id="__span-35-9"><a id="__codelineno-35-9" name="__codelineno-35-9"></a><span class="w">    </span><span class="nx">StateKeyProcessingStage</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;processing_stage&quot;</span>
</span><span id="__span-35-10"><a id="__codelineno-35-10" name="__codelineno-35-10"></a><span class="p">)</span>
</span><span id="__span-35-11"><a id="__codelineno-35-11" name="__codelineno-35-11"></a>
</span><span id="__span-35-12"><a id="__codelineno-35-12" name="__codelineno-35-12"></a><span class="c1">// 在节点中使用</span>
</span><span id="__span-35-13"><a id="__codelineno-35-13" name="__codelineno-35-13"></a><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span>
</span><span id="__span-35-14"><a id="__codelineno-35-14" name="__codelineno-35-14"></a><span class="w">    </span><span class="nx">StateKeyDocumentLength</span><span class="p">:</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">input</span><span class="p">),</span>
</span><span id="__span-35-15"><a id="__codelineno-35-15" name="__codelineno-35-15"></a><span class="w">    </span><span class="nx">StateKeyComplexityLevel</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;simple&quot;</span><span class="p">,</span>
</span><span id="__span-35-16"><a id="__codelineno-35-16" name="__codelineno-35-16"></a><span class="w">    </span><span class="nx">StateKeyProcessingStage</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;completed&quot;</span><span class="p">,</span>
</span><span id="__span-35-17"><a id="__codelineno-35-17" name="__codelineno-35-17"></a><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span></code></pre></div></td></tr></table></div>
<p><strong>内置状态键</strong>：用于系统集成</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-36-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-36-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-36-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-36-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-36-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-36-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-36-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-36-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-36-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-36-10">10</a></span>
<span class="normal"><a href="#__codelineno-36-11">11</a></span>
<span class="normal"><a href="#__codelineno-36-12">12</a></span>
<span class="normal"><a href="#__codelineno-36-13">13</a></span>
<span class="normal"><a href="#__codelineno-36-14">14</a></span>
<span class="normal"><a href="#__codelineno-36-15">15</a></span>
<span class="normal"><a href="#__codelineno-36-16">16</a></span>
<span class="normal"><a href="#__codelineno-36-17">17</a></span>
<span class="normal"><a href="#__codelineno-36-18">18</a></span>
<span class="normal"><a href="#__codelineno-36-19">19</a></span>
<span class="normal"><a href="#__codelineno-36-20">20</a></span>
<span class="normal"><a href="#__codelineno-36-21">21</a></span>
<span class="normal"><a href="#__codelineno-36-22">22</a></span>
<span class="normal"><a href="#__codelineno-36-23">23</a></span>
<span class="normal"><a href="#__codelineno-36-24">24</a></span>
<span class="normal"><a href="#__codelineno-36-25">25</a></span>
<span class="normal"><a href="#__codelineno-36-26">26</a></span>
<span class="normal"><a href="#__codelineno-36-27">27</a></span>
<span class="normal"><a href="#__codelineno-36-28">28</a></span>
<span class="normal"><a href="#__codelineno-36-29">29</a></span>
<span class="normal"><a href="#__codelineno-36-30">30</a></span>
<span class="normal"><a href="#__codelineno-36-31">31</a></span>
<span class="normal"><a href="#__codelineno-36-32">32</a></span>
<span class="normal"><a href="#__codelineno-36-33">33</a></span>
<span class="normal"><a href="#__codelineno-36-34">34</a></span>
<span class="normal"><a href="#__codelineno-36-35">35</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-36-2"><a id="__codelineno-36-2" name="__codelineno-36-2"></a><span class="w">    </span><span class="s">&quot;time&quot;</span>
</span><span id="__span-36-3"><a id="__codelineno-36-3" name="__codelineno-36-3"></a>
</span><span id="__span-36-4"><a id="__codelineno-36-4" name="__codelineno-36-4"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-36-5"><a id="__codelineno-36-5" name="__codelineno-36-5"></a><span class="p">)</span>
</span><span id="__span-36-6"><a id="__codelineno-36-6" name="__codelineno-36-6"></a>
</span><span id="__span-36-7"><a id="__codelineno-36-7" name="__codelineno-36-7"></a><span class="c1">// 获取用户输入（由系统自动设置）</span>
</span><span id="__span-36-8"><a id="__codelineno-36-8" name="__codelineno-36-8"></a><span class="nx">userInput</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">state</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyUserInput</span><span class="p">].(</span><span class="kt">string</span><span class="p">)</span>
</span><span id="__span-36-9"><a id="__codelineno-36-9" name="__codelineno-36-9"></a>
</span><span id="__span-36-10"><a id="__codelineno-36-10" name="__codelineno-36-10"></a><span class="c1">// 设置最终输出（系统会读取此值）</span>
</span><span id="__span-36-11"><a id="__codelineno-36-11" name="__codelineno-36-11"></a><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span>
</span><span id="__span-36-12"><a id="__codelineno-36-12" name="__codelineno-36-12"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyLastResponse</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;处理完成&quot;</span><span class="p">,</span>
</span><span id="__span-36-13"><a id="__codelineno-36-13" name="__codelineno-36-13"></a><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-36-14"><a id="__codelineno-36-14" name="__codelineno-36-14"></a>
</span><span id="__span-36-15"><a id="__codelineno-36-15" name="__codelineno-36-15"></a><span class="c1">// 当多个节点（例如并行的 LLM 节点）同时产出结果时，使用按节点响应。</span>
</span><span id="__span-36-16"><a id="__codelineno-36-16" name="__codelineno-36-16"></a><span class="c1">// 该值是 map[nodeID]any，会在执行过程中合并。串行路径使用</span>
</span><span id="__span-36-17"><a id="__codelineno-36-17" name="__codelineno-36-17"></a><span class="c1">// LastResponse；并行节点汇合时使用 NodeResponses。</span>
</span><span id="__span-36-18"><a id="__codelineno-36-18" name="__codelineno-36-18"></a><span class="nx">responses</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">state</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyNodeResponses</span><span class="p">].(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">any</span><span class="p">)</span>
</span><span id="__span-36-19"><a id="__codelineno-36-19" name="__codelineno-36-19"></a><span class="nx">news</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">responses</span><span class="p">[</span><span class="s">&quot;news&quot;</span><span class="p">].(</span><span class="kt">string</span><span class="p">)</span>
</span><span id="__span-36-20"><a id="__codelineno-36-20" name="__codelineno-36-20"></a><span class="nx">dialog</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">responses</span><span class="p">[</span><span class="s">&quot;dialog&quot;</span><span class="p">].(</span><span class="kt">string</span><span class="p">)</span>
</span><span id="__span-36-21"><a id="__codelineno-36-21" name="__codelineno-36-21"></a>
</span><span id="__span-36-22"><a id="__codelineno-36-22" name="__codelineno-36-22"></a><span class="c1">// 分别使用或组合成最终输出。</span>
</span><span id="__span-36-23"><a id="__codelineno-36-23" name="__codelineno-36-23"></a><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span>
</span><span id="__span-36-24"><a id="__codelineno-36-24" name="__codelineno-36-24"></a><span class="w">    </span><span class="s">&quot;news_output&quot;</span><span class="p">:</span><span class="w">   </span><span class="nx">news</span><span class="p">,</span>
</span><span id="__span-36-25"><a id="__codelineno-36-25" name="__codelineno-36-25"></a><span class="w">    </span><span class="s">&quot;dialog_output&quot;</span><span class="p">:</span><span class="w"> </span><span class="nx">dialog</span><span class="p">,</span>
</span><span id="__span-36-26"><a id="__codelineno-36-26" name="__codelineno-36-26"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyLastResponse</span><span class="p">:</span><span class="w"> </span><span class="nx">news</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;\n&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">dialog</span><span class="p">,</span>
</span><span id="__span-36-27"><a id="__codelineno-36-27" name="__codelineno-36-27"></a><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-36-28"><a id="__codelineno-36-28" name="__codelineno-36-28"></a>
</span><span id="__span-36-29"><a id="__codelineno-36-29" name="__codelineno-36-29"></a><span class="c1">// 存储元数据</span>
</span><span id="__span-36-30"><a id="__codelineno-36-30" name="__codelineno-36-30"></a><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span>
</span><span id="__span-36-31"><a id="__codelineno-36-31" name="__codelineno-36-31"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyMetadata</span><span class="p">:</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">any</span><span class="p">{</span>
</span><span id="__span-36-32"><a id="__codelineno-36-32" name="__codelineno-36-32"></a><span class="w">        </span><span class="s">&quot;timestamp&quot;</span><span class="p">:</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">(),</span>
</span><span id="__span-36-33"><a id="__codelineno-36-33" name="__codelineno-36-33"></a><span class="w">        </span><span class="s">&quot;version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1.0&quot;</span><span class="p">,</span>
</span><span id="__span-36-34"><a id="__codelineno-36-34" name="__codelineno-36-34"></a><span class="w">    </span><span class="p">},</span>
</span><span id="__span-36-35"><a id="__codelineno-36-35" name="__codelineno-36-35"></a><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span></code></pre></div></td></tr></table></div>
<h2 id="_12">高级功能</h2>
<h3 id="1">1. 中断和恢复（人机协作）</h3>
<p>Graph 包通过中断和恢复功能支持人机协作 (HITL) 工作流。这使得工作流可以暂停执行，等待人工输入或审批，然后从中断的确切位置恢复。</p>
<h4 id="_13">基本用法</h4>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-37-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-37-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-37-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-37-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-37-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-37-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-37-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-37-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-37-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-37-10">10</a></span>
<span class="normal"><a href="#__codelineno-37-11">11</a></span>
<span class="normal"><a href="#__codelineno-37-12">12</a></span>
<span class="normal"><a href="#__codelineno-37-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-37-1"><a id="__codelineno-37-1" name="__codelineno-37-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-37-2"><a id="__codelineno-37-2" name="__codelineno-37-2"></a><span class="w">    </span><span class="s">&quot;context&quot;</span>
</span><span id="__span-37-3"><a id="__codelineno-37-3" name="__codelineno-37-3"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-37-4"><a id="__codelineno-37-4" name="__codelineno-37-4"></a><span class="p">)</span>
</span><span id="__span-37-5"><a id="__codelineno-37-5" name="__codelineno-37-5"></a>
</span><span id="__span-37-6"><a id="__codelineno-37-6" name="__codelineno-37-6"></a><span class="c1">// 创建一个可以中断执行等待人工输入的节点</span>
</span><span id="__span-37-7"><a id="__codelineno-37-7" name="__codelineno-37-7"></a><span class="nx">b</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;approval_node&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-37-8"><a id="__codelineno-37-8" name="__codelineno-37-8"></a><span class="w">    </span><span class="c1">// 使用 Interrupt 助手函数进行干净的中断/恢复处理</span>
</span><span id="__span-37-9"><a id="__codelineno-37-9" name="__codelineno-37-9"></a><span class="w">    </span><span class="nx">prompt</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">any</span><span class="p">{</span>
</span><span id="__span-37-10"><a id="__codelineno-37-10" name="__codelineno-37-10"></a><span class="w">        </span><span class="s">&quot;message&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;请审批此操作 (yes/no):&quot;</span><span class="p">,</span>
</span><span id="__span-37-11"><a id="__codelineno-37-11" name="__codelineno-37-11"></a><span class="w">        </span><span class="s">&quot;data&quot;</span><span class="p">:</span><span class="w">    </span><span class="nx">s</span><span class="p">[</span><span class="s">&quot;some_data&quot;</span><span class="p">],</span>
</span><span id="__span-37-12"><a id="__codelineno-37-12" name="__codelineno-37-12"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-37-13"><a id="__codelineno-37-13" name="__codelineno-37-13"></a><span class="p">})</span>
</span></code></pre></div></td></tr></table></div>
<p>用代码把这个图变成可运行的工作流：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-38-1">  1</a></span>
<span class="normal"><a href="#__codelineno-38-2">  2</a></span>
<span class="normal"><a href="#__codelineno-38-3">  3</a></span>
<span class="normal"><a href="#__codelineno-38-4">  4</a></span>
<span class="normal"><a href="#__codelineno-38-5">  5</a></span>
<span class="normal"><a href="#__codelineno-38-6">  6</a></span>
<span class="normal"><a href="#__codelineno-38-7">  7</a></span>
<span class="normal"><a href="#__codelineno-38-8">  8</a></span>
<span class="normal"><a href="#__codelineno-38-9">  9</a></span>
<span class="normal"><a href="#__codelineno-38-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-38-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-38-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-38-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-38-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-38-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-38-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-38-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-38-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-38-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-38-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-38-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-38-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-38-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-38-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-38-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-38-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-38-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-38-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-38-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-38-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-38-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-38-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-38-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-38-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-38-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-38-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-38-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-38-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-38-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-38-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-38-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-38-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-38-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-38-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-38-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-38-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-38-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-38-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-38-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-38-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-38-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-38-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-38-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-38-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-38-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-38-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-38-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-38-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-38-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-38-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-38-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-38-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-38-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-38-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-38-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-38-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-38-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-38-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-38-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-38-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-38-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-38-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-38-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-38-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-38-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-38-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-38-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-38-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-38-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-38-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-38-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-38-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-38-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-38-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-38-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-38-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-38-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-38-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-38-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-38-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-38-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-38-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-38-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-38-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-38-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-38-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-38-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-38-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-38-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-38-100">100</a></span>
<span class="normal"><a href="#__codelineno-38-101">101</a></span>
<span class="normal"><a href="#__codelineno-38-102">102</a></span>
<span class="normal"><a href="#__codelineno-38-103">103</a></span>
<span class="normal"><a href="#__codelineno-38-104">104</a></span>
<span class="normal"><a href="#__codelineno-38-105">105</a></span>
<span class="normal"><a href="#__codelineno-38-106">106</a></span>
<span class="normal"><a href="#__codelineno-38-107">107</a></span>
<span class="normal"><a href="#__codelineno-38-108">108</a></span>
<span class="normal"><a href="#__codelineno-38-109">109</a></span>
<span class="normal"><a href="#__codelineno-38-110">110</a></span>
<span class="normal"><a href="#__codelineno-38-111">111</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-38-1"><a id="__codelineno-38-1" name="__codelineno-38-1"></a><span class="kn">package</span><span class="w"> </span><span class="nx">main</span>
</span><span id="__span-38-2"><a id="__codelineno-38-2" name="__codelineno-38-2"></a>
</span><span id="__span-38-3"><a id="__codelineno-38-3" name="__codelineno-38-3"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-38-4"><a id="__codelineno-38-4" name="__codelineno-38-4"></a><span class="w">    </span><span class="s">&quot;context&quot;</span>
</span><span id="__span-38-5"><a id="__codelineno-38-5" name="__codelineno-38-5"></a><span class="w">    </span><span class="s">&quot;fmt&quot;</span>
</span><span id="__span-38-6"><a id="__codelineno-38-6" name="__codelineno-38-6"></a><span class="w">    </span><span class="s">&quot;strings&quot;</span>
</span><span id="__span-38-7"><a id="__codelineno-38-7" name="__codelineno-38-7"></a>
</span><span id="__span-38-8"><a id="__codelineno-38-8" name="__codelineno-38-8"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/agent/graphagent&quot;</span>
</span><span id="__span-38-9"><a id="__codelineno-38-9" name="__codelineno-38-9"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-38-10"><a id="__codelineno-38-10" name="__codelineno-38-10"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/model&quot;</span>
</span><span id="__span-38-11"><a id="__codelineno-38-11" name="__codelineno-38-11"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/model/openai&quot;</span>
</span><span id="__span-38-12"><a id="__codelineno-38-12" name="__codelineno-38-12"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/runner&quot;</span>
</span><span id="__span-38-13"><a id="__codelineno-38-13" name="__codelineno-38-13"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/tool&quot;</span>
</span><span id="__span-38-14"><a id="__codelineno-38-14" name="__codelineno-38-14"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/tool/function&quot;</span>
</span><span id="__span-38-15"><a id="__codelineno-38-15" name="__codelineno-38-15"></a><span class="p">)</span>
</span><span id="__span-38-16"><a id="__codelineno-38-16" name="__codelineno-38-16"></a>
</span><span id="__span-38-17"><a id="__codelineno-38-17" name="__codelineno-38-17"></a><span class="c1">// 非导出常量，避免魔法字符串</span>
</span><span id="__span-38-18"><a id="__codelineno-38-18" name="__codelineno-38-18"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-38-19"><a id="__codelineno-38-19" name="__codelineno-38-19"></a><span class="w">    </span><span class="nx">nodePrepare</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;prepare&quot;</span>
</span><span id="__span-38-20"><a id="__codelineno-38-20" name="__codelineno-38-20"></a><span class="w">    </span><span class="nx">nodeAsk</span><span class="w">       </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;ask&quot;</span>
</span><span id="__span-38-21"><a id="__codelineno-38-21" name="__codelineno-38-21"></a><span class="w">    </span><span class="nx">nodeTools</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;tools&quot;</span>
</span><span id="__span-38-22"><a id="__codelineno-38-22" name="__codelineno-38-22"></a><span class="w">    </span><span class="nx">nodeFallback</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;fallback&quot;</span>
</span><span id="__span-38-23"><a id="__codelineno-38-23" name="__codelineno-38-23"></a><span class="w">    </span><span class="nx">nodeFinish</span><span class="w">    </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;finish&quot;</span>
</span><span id="__span-38-24"><a id="__codelineno-38-24" name="__codelineno-38-24"></a>
</span><span id="__span-38-25"><a id="__codelineno-38-25" name="__codelineno-38-25"></a><span class="w">    </span><span class="nx">modelName</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;gpt-4o-mini&quot;</span>
</span><span id="__span-38-26"><a id="__codelineno-38-26" name="__codelineno-38-26"></a><span class="w">    </span><span class="nx">systemPrompt</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;你是一个谨慎的助手。&quot;</span>
</span><span id="__span-38-27"><a id="__codelineno-38-27" name="__codelineno-38-27"></a><span class="w">    </span><span class="nx">outputKeyFinal</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;final_output&quot;</span>
</span><span id="__span-38-28"><a id="__codelineno-38-28" name="__codelineno-38-28"></a>
</span><span id="__span-38-29"><a id="__codelineno-38-29" name="__codelineno-38-29"></a><span class="w">    </span><span class="nx">toolNameCalculator</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;calculator&quot;</span>
</span><span id="__span-38-30"><a id="__codelineno-38-30" name="__codelineno-38-30"></a>
</span><span id="__span-38-31"><a id="__codelineno-38-31" name="__codelineno-38-31"></a><span class="w">    </span><span class="nx">demoUserID</span><span class="w">    </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;user&quot;</span>
</span><span id="__span-38-32"><a id="__codelineno-38-32" name="__codelineno-38-32"></a><span class="w">    </span><span class="nx">demoSessionID</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;session&quot;</span>
</span><span id="__span-38-33"><a id="__codelineno-38-33" name="__codelineno-38-33"></a><span class="w">    </span><span class="nx">demoQuestion</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;6 * 7 等于多少？&quot;</span>
</span><span id="__span-38-34"><a id="__codelineno-38-34" name="__codelineno-38-34"></a><span class="p">)</span>
</span><span id="__span-38-35"><a id="__codelineno-38-35" name="__codelineno-38-35"></a>
</span><span id="__span-38-36"><a id="__codelineno-38-36" name="__codelineno-38-36"></a><span class="kd">func</span><span class="w"> </span><span class="nx">newCalculator</span><span class="p">()</span><span class="w"> </span><span class="nx">tool</span><span class="p">.</span><span class="nx">Tool</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-38-37"><a id="__codelineno-38-37" name="__codelineno-38-37"></a><span class="w">    </span><span class="kd">type</span><span class="w"> </span><span class="nx">Input</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-38-38"><a id="__codelineno-38-38" name="__codelineno-38-38"></a><span class="w">        </span><span class="nx">Expression</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="s">`json:&quot;expression&quot;`</span>
</span><span id="__span-38-39"><a id="__codelineno-38-39" name="__codelineno-38-39"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-38-40"><a id="__codelineno-38-40" name="__codelineno-38-40"></a><span class="w">    </span><span class="kd">type</span><span class="w"> </span><span class="nx">Output</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-38-41"><a id="__codelineno-38-41" name="__codelineno-38-41"></a><span class="w">        </span><span class="nx">Result</span><span class="w"> </span><span class="kt">float64</span><span class="w"> </span><span class="s">`json:&quot;result&quot;`</span>
</span><span id="__span-38-42"><a id="__codelineno-38-42" name="__codelineno-38-42"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-38-43"><a id="__codelineno-38-43" name="__codelineno-38-43"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">function</span><span class="p">.</span><span class="nx">NewFunctionTool</span><span class="p">[</span><span class="nx">Input</span><span class="p">,</span><span class="w"> </span><span class="nx">Output</span><span class="p">](</span>
</span><span id="__span-38-44"><a id="__codelineno-38-44" name="__codelineno-38-44"></a><span class="w">        </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">in</span><span class="w"> </span><span class="nx">Input</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nx">Output</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-38-45"><a id="__codelineno-38-45" name="__codelineno-38-45"></a><span class="w">            </span><span class="c1">// 在此实现真实计算逻辑</span>
</span><span id="__span-38-46"><a id="__codelineno-38-46" name="__codelineno-38-46"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">Output</span><span class="p">{</span><span class="nx">Result</span><span class="p">:</span><span class="w"> </span><span class="mi">42</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-38-47"><a id="__codelineno-38-47" name="__codelineno-38-47"></a><span class="w">        </span><span class="p">},</span>
</span><span id="__span-38-48"><a id="__codelineno-38-48" name="__codelineno-38-48"></a><span class="w">        </span><span class="nx">function</span><span class="p">.</span><span class="nx">WithName</span><span class="p">(</span><span class="nx">toolNameCalculator</span><span class="p">),</span>
</span><span id="__span-38-49"><a id="__codelineno-38-49" name="__codelineno-38-49"></a><span class="w">        </span><span class="nx">function</span><span class="p">.</span><span class="nx">WithDescription</span><span class="p">(</span><span class="s">&quot;计算数学表达式&quot;</span><span class="p">),</span>
</span><span id="__span-38-50"><a id="__codelineno-38-50" name="__codelineno-38-50"></a><span class="w">    </span><span class="p">)</span>
</span><span id="__span-38-51"><a id="__codelineno-38-51" name="__codelineno-38-51"></a><span class="p">}</span>
</span><span id="__span-38-52"><a id="__codelineno-38-52" name="__codelineno-38-52"></a>
</span><span id="__span-38-53"><a id="__codelineno-38-53" name="__codelineno-38-53"></a><span class="kd">func</span><span class="w"> </span><span class="nx">buildWorkflow</span><span class="p">(</span><span class="nx">m</span><span class="w"> </span><span class="nx">model</span><span class="p">.</span><span class="nx">Model</span><span class="p">,</span><span class="w"> </span><span class="nx">tools</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">tool</span><span class="p">.</span><span class="nx">Tool</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">graph</span><span class="p">.</span><span class="nx">Graph</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-38-54"><a id="__codelineno-38-54" name="__codelineno-38-54"></a><span class="w">    </span><span class="nx">sg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateGraph</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">MessagesStateSchema</span><span class="p">())</span>
</span><span id="__span-38-55"><a id="__codelineno-38-55" name="__codelineno-38-55"></a>
</span><span id="__span-38-56"><a id="__codelineno-38-56" name="__codelineno-38-56"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="nx">nodePrepare</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-38-57"><a id="__codelineno-38-57" name="__codelineno-38-57"></a><span class="w">        </span><span class="nx">raw</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprint</span><span class="p">(</span><span class="nx">s</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyUserInput</span><span class="p">])</span>
</span><span id="__span-38-58"><a id="__codelineno-38-58" name="__codelineno-38-58"></a><span class="w">        </span><span class="nx">cleaned</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">strings</span><span class="p">.</span><span class="nx">TrimSpace</span><span class="p">(</span><span class="nx">raw</span><span class="p">)</span>
</span><span id="__span-38-59"><a id="__codelineno-38-59" name="__codelineno-38-59"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyUserInput</span><span class="p">:</span><span class="w"> </span><span class="nx">cleaned</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-38-60"><a id="__codelineno-38-60" name="__codelineno-38-60"></a><span class="w">    </span><span class="p">})</span>
</span><span id="__span-38-61"><a id="__codelineno-38-61" name="__codelineno-38-61"></a>
</span><span id="__span-38-62"><a id="__codelineno-38-62" name="__codelineno-38-62"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddLLMNode</span><span class="p">(</span><span class="nx">nodeAsk</span><span class="p">,</span><span class="w"> </span><span class="nx">m</span><span class="p">,</span><span class="w"> </span><span class="nx">systemPrompt</span><span class="p">,</span><span class="w"> </span><span class="nx">tools</span><span class="p">)</span>
</span><span id="__span-38-63"><a id="__codelineno-38-63" name="__codelineno-38-63"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddToolsNode</span><span class="p">(</span><span class="nx">nodeTools</span><span class="p">,</span><span class="w"> </span><span class="nx">tools</span><span class="p">)</span>
</span><span id="__span-38-64"><a id="__codelineno-38-64" name="__codelineno-38-64"></a>
</span><span id="__span-38-65"><a id="__codelineno-38-65" name="__codelineno-38-65"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="nx">nodeFallback</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-38-66"><a id="__codelineno-38-66" name="__codelineno-38-66"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyLastResponse</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;无需工具，直接回答&quot;</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-38-67"><a id="__codelineno-38-67" name="__codelineno-38-67"></a><span class="w">    </span><span class="p">})</span>
</span><span id="__span-38-68"><a id="__codelineno-38-68" name="__codelineno-38-68"></a>
</span><span id="__span-38-69"><a id="__codelineno-38-69" name="__codelineno-38-69"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="nx">nodeFinish</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-38-70"><a id="__codelineno-38-70" name="__codelineno-38-70"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="nx">outputKeyFinal</span><span class="p">:</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprint</span><span class="p">(</span><span class="nx">s</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyLastResponse</span><span class="p">])},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-38-71"><a id="__codelineno-38-71" name="__codelineno-38-71"></a><span class="w">    </span><span class="p">})</span>
</span><span id="__span-38-72"><a id="__codelineno-38-72" name="__codelineno-38-72"></a>
</span><span id="__span-38-73"><a id="__codelineno-38-73" name="__codelineno-38-73"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">SetEntryPoint</span><span class="p">(</span><span class="nx">nodePrepare</span><span class="p">)</span>
</span><span id="__span-38-74"><a id="__codelineno-38-74" name="__codelineno-38-74"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddEdge</span><span class="p">(</span><span class="nx">nodePrepare</span><span class="p">,</span><span class="w"> </span><span class="nx">nodeAsk</span><span class="p">)</span>
</span><span id="__span-38-75"><a id="__codelineno-38-75" name="__codelineno-38-75"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddToolsConditionalEdges</span><span class="p">(</span><span class="nx">nodeAsk</span><span class="p">,</span><span class="w"> </span><span class="nx">nodeTools</span><span class="p">,</span><span class="w"> </span><span class="nx">nodeFallback</span><span class="p">)</span>
</span><span id="__span-38-76"><a id="__codelineno-38-76" name="__codelineno-38-76"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddEdge</span><span class="p">(</span><span class="nx">nodeTools</span><span class="p">,</span><span class="w"> </span><span class="nx">nodeAsk</span><span class="p">)</span>
</span><span id="__span-38-77"><a id="__codelineno-38-77" name="__codelineno-38-77"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddEdge</span><span class="p">(</span><span class="nx">nodeFallback</span><span class="p">,</span><span class="w"> </span><span class="nx">nodeFinish</span><span class="p">)</span>
</span><span id="__span-38-78"><a id="__codelineno-38-78" name="__codelineno-38-78"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">SetFinishPoint</span><span class="p">(</span><span class="nx">nodeFinish</span><span class="p">)</span>
</span><span id="__span-38-79"><a id="__codelineno-38-79" name="__codelineno-38-79"></a>
</span><span id="__span-38-80"><a id="__codelineno-38-80" name="__codelineno-38-80"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">sg</span><span class="p">.</span><span class="nx">Compile</span><span class="p">()</span>
</span><span id="__span-38-81"><a id="__codelineno-38-81" name="__codelineno-38-81"></a><span class="p">}</span>
</span><span id="__span-38-82"><a id="__codelineno-38-82" name="__codelineno-38-82"></a>
</span><span id="__span-38-83"><a id="__codelineno-38-83" name="__codelineno-38-83"></a><span class="kd">func</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-38-84"><a id="__codelineno-38-84" name="__codelineno-38-84"></a><span class="w">    </span><span class="nx">mdl</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">openai</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="nx">modelName</span><span class="p">)</span>
</span><span id="__span-38-85"><a id="__codelineno-38-85" name="__codelineno-38-85"></a><span class="w">    </span><span class="nx">tools</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">tool</span><span class="p">.</span><span class="nx">Tool</span><span class="p">{</span><span class="nx">toolNameCalculator</span><span class="p">:</span><span class="w"> </span><span class="nx">newCalculator</span><span class="p">()}</span>
</span><span id="__span-38-86"><a id="__codelineno-38-86" name="__codelineno-38-86"></a>
</span><span id="__span-38-87"><a id="__codelineno-38-87" name="__codelineno-38-87"></a><span class="w">    </span><span class="nx">g</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">buildWorkflow</span><span class="p">(</span><span class="nx">mdl</span><span class="p">,</span><span class="w"> </span><span class="nx">tools</span><span class="p">)</span>
</span><span id="__span-38-88"><a id="__codelineno-38-88" name="__codelineno-38-88"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-38-89"><a id="__codelineno-38-89" name="__codelineno-38-89"></a><span class="w">        </span><span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span id="__span-38-90"><a id="__codelineno-38-90" name="__codelineno-38-90"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-38-91"><a id="__codelineno-38-91" name="__codelineno-38-91"></a>
</span><span id="__span-38-92"><a id="__codelineno-38-92" name="__codelineno-38-92"></a><span class="w">    </span><span class="c1">// 使用 GraphAgent + Runner 运行</span>
</span><span id="__span-38-93"><a id="__codelineno-38-93" name="__codelineno-38-93"></a><span class="w">    </span><span class="nx">ga</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;demo&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">g</span><span class="p">)</span>
</span><span id="__span-38-94"><a id="__codelineno-38-94" name="__codelineno-38-94"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-38-95"><a id="__codelineno-38-95" name="__codelineno-38-95"></a><span class="w">        </span><span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span id="__span-38-96"><a id="__codelineno-38-96" name="__codelineno-38-96"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-38-97"><a id="__codelineno-38-97" name="__codelineno-38-97"></a><span class="w">    </span><span class="nx">app</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">runner</span><span class="p">.</span><span class="nx">NewRunner</span><span class="p">(</span><span class="s">&quot;app&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">ga</span><span class="p">)</span>
</span><span id="__span-38-98"><a id="__codelineno-38-98" name="__codelineno-38-98"></a><span class="w">    </span><span class="nx">events</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">app</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Background</span><span class="p">(),</span><span class="w"> </span><span class="nx">demoUserID</span><span class="p">,</span><span class="w"> </span><span class="nx">demoSessionID</span><span class="p">,</span>
</span><span id="__span-38-99"><a id="__codelineno-38-99" name="__codelineno-38-99"></a><span class="w">        </span><span class="nx">model</span><span class="p">.</span><span class="nx">NewUserMessage</span><span class="p">(</span><span class="nx">demoQuestion</span><span class="p">))</span>
</span><span id="__span-38-100"><a id="__codelineno-38-100" name="__codelineno-38-100"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-38-101"><a id="__codelineno-38-101" name="__codelineno-38-101"></a><span class="w">        </span><span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span id="__span-38-102"><a id="__codelineno-38-102" name="__codelineno-38-102"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-38-103"><a id="__codelineno-38-103" name="__codelineno-38-103"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">ev</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">events</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-38-104"><a id="__codelineno-38-104" name="__codelineno-38-104"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">ev</span><span class="p">.</span><span class="nx">Response</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-38-105"><a id="__codelineno-38-105" name="__codelineno-38-105"></a><span class="w">            </span><span class="k">continue</span>
</span><span id="__span-38-106"><a id="__codelineno-38-106" name="__codelineno-38-106"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-38-107"><a id="__codelineno-38-107" name="__codelineno-38-107"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">ev</span><span class="p">.</span><span class="nx">Author</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">nodeAsk</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">!</span><span class="nx">ev</span><span class="p">.</span><span class="nx">Response</span><span class="p">.</span><span class="nx">IsPartial</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">ev</span><span class="p">.</span><span class="nx">Response</span><span class="p">.</span><span class="nx">Choices</span><span class="p">)</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-38-108"><a id="__codelineno-38-108" name="__codelineno-38-108"></a><span class="w">            </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;LLM:&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">ev</span><span class="p">.</span><span class="nx">Response</span><span class="p">.</span><span class="nx">Choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">Message</span><span class="p">.</span><span class="nx">Content</span><span class="p">)</span>
</span><span id="__span-38-109"><a id="__codelineno-38-109" name="__codelineno-38-109"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-38-110"><a id="__codelineno-38-110" name="__codelineno-38-110"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-38-111"><a id="__codelineno-38-111" name="__codelineno-38-111"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>上面的例子展示了如何声明节点、连边并运行。接下来先介绍执行方式与会话管理，然后进入核心概念与常见用法。</p>
<h3 id="2">2. 静态中断（调试断点）</h3>
<p>静态中断可以理解为“断点”：让图在某些节点执行<strong>前</strong>或执行<strong>后</strong>
暂停。它主要用于调试和逐步观察状态变化，不需要你在节点函数里手动
调用 <code>graph.Interrupt(...)</code>。</p>
<p>与 HITL 中断的区别：</p>
<ul>
<li><strong>HITL 中断</strong>：节点内部调用 <code>graph.Interrupt(ctx, state, key, prompt)</code>，
  恢复时需要为该 <code>key</code> 提供 resume 输入。</li>
<li><strong>静态中断</strong>：在声明节点时附加中断 option。恢复只需要 checkpoint
  坐标（<code>lineage_id</code> + <code>checkpoint_id</code>）。</li>
</ul>
<p>启用静态中断：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-39-1">1</a></span>
<span class="normal"><a href="#__codelineno-39-2">2</a></span>
<span class="normal"><a href="#__codelineno-39-3">3</a></span>
<span class="normal"><a href="#__codelineno-39-4">4</a></span>
<span class="normal"><a href="#__codelineno-39-5">5</a></span>
<span class="normal"><a href="#__codelineno-39-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-39-1"><a id="__codelineno-39-1" name="__codelineno-39-1"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;my_node&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">fn</span><span class="p">,</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithInterruptBefore</span><span class="p">())</span>
</span><span id="__span-39-2"><a id="__codelineno-39-2" name="__codelineno-39-2"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;my_node&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">fn</span><span class="p">,</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithInterruptAfter</span><span class="p">())</span>
</span><span id="__span-39-3"><a id="__codelineno-39-3" name="__codelineno-39-3"></a>
</span><span id="__span-39-4"><a id="__codelineno-39-4" name="__codelineno-39-4"></a><span class="c1">// 也可以在节点都声明完后，按 nodeID 批量开启：</span>
</span><span id="__span-39-5"><a id="__codelineno-39-5" name="__codelineno-39-5"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">WithInterruptBeforeNodes</span><span class="p">(</span><span class="s">&quot;my_node&quot;</span><span class="p">)</span>
</span><span id="__span-39-6"><a id="__codelineno-39-6" name="__codelineno-39-6"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">WithInterruptAfterNodes</span><span class="p">(</span><span class="s">&quot;my_node&quot;</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>当触发静态中断时，执行器会抛出 <code>*graph.InterruptError</code>，并且：</p>
<ul>
<li><code>Key</code> 以 <code>graph.StaticInterruptKeyPrefixBefore</code> 或
  <code>graph.StaticInterruptKeyPrefixAfter</code> 为前缀</li>
<li><code>Value</code> 为 <code>graph.StaticInterruptPayload</code>（包含 <code>phase</code>、<code>nodes</code>、
  <code>activeNodes</code>）</li>
</ul>
<p>恢复方式：</p>
<ul>
<li>用相同的 <code>lineage_id</code> 和中断事件返回的 <code>checkpoint_id</code> 重新运行。</li>
<li>因为节点没有调用 <code>graph.Interrupt(...)</code>，所以不需要 resume 输入。</li>
</ul>
<p>可参考 <code>examples/graph/static_interrupt</code> 的完整可运行示例。</p>
<h3 id="_14">执行方式</h3>
<ul>
<li>用 <code>graphagent.New</code> 包装成通用 <code>agent.Agent</code>，交给 <code>runner.Runner</code> 管理会话与事件流。</li>
</ul>
<p>最小 GraphAgent + Runner 例子：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-40-1">1</a></span>
<span class="normal"><a href="#__codelineno-40-2">2</a></span>
<span class="normal"><a href="#__codelineno-40-3">3</a></span>
<span class="normal"><a href="#__codelineno-40-4">4</a></span>
<span class="normal"><a href="#__codelineno-40-5">5</a></span>
<span class="normal"><a href="#__codelineno-40-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-40-1"><a id="__codelineno-40-1" name="__codelineno-40-1"></a><span class="nx">compiled</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">buildWorkflow</span><span class="p">(</span><span class="nx">openai</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;gpt-4o-mini&quot;</span><span class="p">),</span><span class="w"> </span><span class="kc">nil</span><span class="p">)</span>
</span><span id="__span-40-2"><a id="__codelineno-40-2" name="__codelineno-40-2"></a><span class="nx">ga</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;demo&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">compiled</span><span class="p">)</span>
</span><span id="__span-40-3"><a id="__codelineno-40-3" name="__codelineno-40-3"></a><span class="nx">app</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">runner</span><span class="p">.</span><span class="nx">NewRunner</span><span class="p">(</span><span class="s">&quot;app&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">ga</span><span class="p">)</span>
</span><span id="__span-40-4"><a id="__codelineno-40-4" name="__codelineno-40-4"></a>
</span><span id="__span-40-5"><a id="__codelineno-40-5" name="__codelineno-40-5"></a><span class="nx">events</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">app</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;user&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;session&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">model</span><span class="p">.</span><span class="nx">NewUserMessage</span><span class="p">(</span><span class="s">&quot;hi&quot;</span><span class="p">))</span>
</span><span id="__span-40-6"><a id="__codelineno-40-6" name="__codelineno-40-6"></a><span class="k">for</span><span class="w"> </span><span class="nx">ev</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">events</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* 处理事件 */</span><span class="w"> </span><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>Runner 会话后端可选项：</p>
<ul>
<li>内存：<code>session/inmemory</code>（默认示例使用）</li>
<li>Redis：<code>session/redis</code>（生产更常用）</li>
</ul>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-41-1">1</a></span>
<span class="normal"><a href="#__codelineno-41-2">2</a></span>
<span class="normal"><a href="#__codelineno-41-3">3</a></span>
<span class="normal"><a href="#__codelineno-41-4">4</a></span>
<span class="normal"><a href="#__codelineno-41-5">5</a></span>
<span class="normal"><a href="#__codelineno-41-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-41-1"><a id="__codelineno-41-1" name="__codelineno-41-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-41-2"><a id="__codelineno-41-2" name="__codelineno-41-2"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/session/redis&quot;</span>
</span><span id="__span-41-3"><a id="__codelineno-41-3" name="__codelineno-41-3"></a><span class="p">)</span>
</span><span id="__span-41-4"><a id="__codelineno-41-4" name="__codelineno-41-4"></a>
</span><span id="__span-41-5"><a id="__codelineno-41-5" name="__codelineno-41-5"></a><span class="nx">sess</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">redis</span><span class="p">.</span><span class="nx">NewService</span><span class="p">(</span><span class="nx">redis</span><span class="p">.</span><span class="nx">WithRedisClientURL</span><span class="p">(</span><span class="s">&quot;redis://localhost:6379&quot;</span><span class="p">))</span>
</span><span id="__span-41-6"><a id="__codelineno-41-6" name="__codelineno-41-6"></a><span class="nx">app</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">runner</span><span class="p">.</span><span class="nx">NewRunner</span><span class="p">(</span><span class="s">&quot;app&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">ga</span><span class="p">,</span><span class="w"> </span><span class="nx">runner</span><span class="p">.</span><span class="nx">WithSessionService</span><span class="p">(</span><span class="nx">sess</span><span class="p">))</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="graphagent">GraphAgent 配置选项</h3>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-42-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-42-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-42-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-42-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-42-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-42-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-42-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-42-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-42-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-42-10">10</a></span>
<span class="normal"><a href="#__codelineno-42-11">11</a></span>
<span class="normal"><a href="#__codelineno-42-12">12</a></span>
<span class="normal"><a href="#__codelineno-42-13">13</a></span>
<span class="normal"><a href="#__codelineno-42-14">14</a></span>
<span class="normal"><a href="#__codelineno-42-15">15</a></span>
<span class="normal"><a href="#__codelineno-42-16">16</a></span>
<span class="normal"><a href="#__codelineno-42-17">17</a></span>
<span class="normal"><a href="#__codelineno-42-18">18</a></span>
<span class="normal"><a href="#__codelineno-42-19">19</a></span>
<span class="normal"><a href="#__codelineno-42-20">20</a></span>
<span class="normal"><a href="#__codelineno-42-21">21</a></span>
<span class="normal"><a href="#__codelineno-42-22">22</a></span>
<span class="normal"><a href="#__codelineno-42-23">23</a></span>
<span class="normal"><a href="#__codelineno-42-24">24</a></span>
<span class="normal"><a href="#__codelineno-42-25">25</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-42-1"><a id="__codelineno-42-1" name="__codelineno-42-1"></a><span class="nx">ga</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span>
</span><span id="__span-42-2"><a id="__codelineno-42-2" name="__codelineno-42-2"></a><span class="w">    </span><span class="s">&quot;workflow&quot;</span><span class="p">,</span>
</span><span id="__span-42-3"><a id="__codelineno-42-3" name="__codelineno-42-3"></a><span class="w">    </span><span class="nx">compiledGraph</span><span class="p">,</span>
</span><span id="__span-42-4"><a id="__codelineno-42-4" name="__codelineno-42-4"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithDescription</span><span class="p">(</span><span class="s">&quot;工作流描述&quot;</span><span class="p">),</span>
</span><span id="__span-42-5"><a id="__codelineno-42-5" name="__codelineno-42-5"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithInitialState</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="s">&quot;init&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">}),</span>
</span><span id="__span-42-6"><a id="__codelineno-42-6" name="__codelineno-42-6"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithChannelBufferSize</span><span class="p">(</span><span class="mi">512</span><span class="p">),</span>
</span><span id="__span-42-7"><a id="__codelineno-42-7" name="__codelineno-42-7"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithCheckpointSaver</span><span class="p">(</span><span class="nx">saver</span><span class="p">),</span>
</span><span id="__span-42-8"><a id="__codelineno-42-8" name="__codelineno-42-8"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithSubAgents</span><span class="p">([]</span><span class="nx">agent</span><span class="p">.</span><span class="nx">Agent</span><span class="p">{</span><span class="nx">subAgent</span><span class="p">}),</span><span class="w"> </span><span class="c1">// 配置子 Agent</span>
</span><span id="__span-42-9"><a id="__codelineno-42-9" name="__codelineno-42-9"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithAgentCallbacks</span><span class="p">(</span><span class="nx">agent</span><span class="p">.</span><span class="nx">NewCallbacks</span><span class="p">()),</span><span class="w"> </span><span class="c1">// 注意：结构化回调 API 需要 trpc-agent-go &gt;= 0.6.0</span>
</span><span id="__span-42-10"><a id="__codelineno-42-10" name="__codelineno-42-10"></a><span class="w">    </span><span class="c1">// 设置传给模型的消息过滤模式，最终传给模型的消息需同时满足WithMessageTimelineFilterMode与WithMessageBranchFilterMode条件</span>
</span><span id="__span-42-11"><a id="__codelineno-42-11" name="__codelineno-42-11"></a><span class="w">    </span><span class="c1">// 时间维度过滤条件</span>
</span><span id="__span-42-12"><a id="__codelineno-42-12" name="__codelineno-42-12"></a><span class="w">    </span><span class="c1">// 默认值: graphagent.TimelineFilterAll</span>
</span><span id="__span-42-13"><a id="__codelineno-42-13" name="__codelineno-42-13"></a><span class="w">    </span><span class="c1">// 可选值:</span>
</span><span id="__span-42-14"><a id="__codelineno-42-14" name="__codelineno-42-14"></a><span class="w">    </span><span class="c1">//  - graphagent.TimelineFilterAll: 包含历史消息以及当前请求中所生成的消息</span>
</span><span id="__span-42-15"><a id="__codelineno-42-15" name="__codelineno-42-15"></a><span class="w">    </span><span class="c1">//  - graphagent.TimelineFilterCurrentRequest: 仅包含当前请求中所生成的消息</span>
</span><span id="__span-42-16"><a id="__codelineno-42-16" name="__codelineno-42-16"></a><span class="w">    </span><span class="c1">//  - graphagent.TimelineFilterCurrentInvocation: 仅包含当前invocation上下文中生成的消息</span>
</span><span id="__span-42-17"><a id="__codelineno-42-17" name="__codelineno-42-17"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithMessageTimelineFilterMode</span><span class="p">(</span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">BranchFilterModeAll</span><span class="p">),</span>
</span><span id="__span-42-18"><a id="__codelineno-42-18" name="__codelineno-42-18"></a><span class="w">    </span><span class="c1">// 分支维度过滤条件</span>
</span><span id="__span-42-19"><a id="__codelineno-42-19" name="__codelineno-42-19"></a><span class="w">    </span><span class="c1">// 默认值: graphagent.BranchFilterModePrefix</span>
</span><span id="__span-42-20"><a id="__codelineno-42-20" name="__codelineno-42-20"></a><span class="w">    </span><span class="c1">// 可选值:</span>
</span><span id="__span-42-21"><a id="__codelineno-42-21" name="__codelineno-42-21"></a><span class="w">    </span><span class="c1">//  - graphagent.BranchFilterModeAll: 包含所有agent的消息, 当前agent与模型交互时,如需将所有agent生成的有效内容消息同步给模型时可设置该值</span>
</span><span id="__span-42-22"><a id="__codelineno-42-22" name="__codelineno-42-22"></a><span class="w">    </span><span class="c1">//  - graphagent.BranchFilterModePrefix: 通过Event.FilterKey与Invocation.eventFilterKey做前缀匹配过滤消息, 期望将与当前agent以及相关上下游agent生成的消息传递给模型时，可设置该值</span>
</span><span id="__span-42-23"><a id="__codelineno-42-23" name="__codelineno-42-23"></a><span class="w">    </span><span class="c1">//  - graphagent.BranchFilterModeExact: 通过Event.FilterKey==Invocation.eventFilterKey过滤消息，当前agent与模型交互时,仅需使用当前agent生成的消息时可设置该值</span>
</span><span id="__span-42-24"><a id="__codelineno-42-24" name="__codelineno-42-24"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithMessageBranchFilterMode</span><span class="p">(</span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">TimelineFilterAll</span><span class="p">),</span>
</span><span id="__span-42-25"><a id="__codelineno-42-25" name="__codelineno-42-25"></a><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<h2 id="_15">核心概念</h2>
<h3 id="_16">状态管理</h3>
<p>GraphAgent 采用 Schema + Reducer 模式管理状态。先明确状态结构与合并规则，后续节点输入/输出的 key 就有了清晰来源与生命周期约定。</p>
<h4 id="schema">使用内置 Schema</h4>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-43-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-43-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-43-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-43-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-43-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-43-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-43-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-43-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-43-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-43-10">10</a></span>
<span class="normal"><a href="#__codelineno-43-11">11</a></span>
<span class="normal"><a href="#__codelineno-43-12">12</a></span>
<span class="normal"><a href="#__codelineno-43-13">13</a></span>
<span class="normal"><a href="#__codelineno-43-14">14</a></span>
<span class="normal"><a href="#__codelineno-43-15">15</a></span>
<span class="normal"><a href="#__codelineno-43-16">16</a></span>
<span class="normal"><a href="#__codelineno-43-17">17</a></span>
<span class="normal"><a href="#__codelineno-43-18">18</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-43-1"><a id="__codelineno-43-1" name="__codelineno-43-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-43-2"><a id="__codelineno-43-2" name="__codelineno-43-2"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-43-3"><a id="__codelineno-43-3" name="__codelineno-43-3"></a><span class="p">)</span>
</span><span id="__span-43-4"><a id="__codelineno-43-4" name="__codelineno-43-4"></a>
</span><span id="__span-43-5"><a id="__codelineno-43-5" name="__codelineno-43-5"></a><span class="nx">schema</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">MessagesStateSchema</span><span class="p">()</span>
</span><span id="__span-43-6"><a id="__codelineno-43-6" name="__codelineno-43-6"></a>
</span><span id="__span-43-7"><a id="__codelineno-43-7" name="__codelineno-43-7"></a><span class="c1">// 预定义字段（键名常量）与语义：</span>
</span><span id="__span-43-8"><a id="__codelineno-43-8" name="__codelineno-43-8"></a><span class="c1">// - graph.StateKeyMessages       (&quot;messages&quot;)        对话历史（[]model.Message；MessageReducer + MessageOp 原子合并）</span>
</span><span id="__span-43-9"><a id="__codelineno-43-9" name="__codelineno-43-9"></a><span class="c1">// - graph.StateKeyUserInput      (&quot;user_input&quot;)      用户输入（string；一次性，成功执行后清空）</span>
</span><span id="__span-43-10"><a id="__codelineno-43-10" name="__codelineno-43-10"></a><span class="c1">// - graph.StateKeyLastResponse   (&quot;last_response&quot;)   最后响应（string）</span>
</span><span id="__span-43-11"><a id="__codelineno-43-11" name="__codelineno-43-11"></a><span class="c1">// - graph.StateKeyNodeResponses  (&quot;node_responses&quot;)  各节点输出（map[string]any；并行汇总读取）</span>
</span><span id="__span-43-12"><a id="__codelineno-43-12" name="__codelineno-43-12"></a><span class="c1">// - graph.StateKeyMetadata       (&quot;metadata&quot;)        元数据（map[string]any；MergeReducer 合并）</span>
</span><span id="__span-43-13"><a id="__codelineno-43-13" name="__codelineno-43-13"></a>
</span><span id="__span-43-14"><a id="__codelineno-43-14" name="__codelineno-43-14"></a><span class="c1">// 其他一次性/系统键（按需使用）：</span>
</span><span id="__span-43-15"><a id="__codelineno-43-15" name="__codelineno-43-15"></a><span class="c1">// - graph.StateKeyOneShotMessages (&quot;one_shot_messages&quot;)  一次性覆盖本轮输入（[]model.Message）</span>
</span><span id="__span-43-16"><a id="__codelineno-43-16" name="__codelineno-43-16"></a><span class="c1">// - graph.StateKeyOneShotMessagesByNode (&quot;one_shot_messages_by_node&quot;)  按节点 ID 定向的一次性覆盖（map[string][]model.Message）</span>
</span><span id="__span-43-17"><a id="__codelineno-43-17" name="__codelineno-43-17"></a><span class="c1">// - graph.StateKeySession         (&quot;session&quot;)            会话对象（系统使用）</span>
</span><span id="__span-43-18"><a id="__codelineno-43-18" name="__codelineno-43-18"></a><span class="c1">// - graph.StateKeyExecContext     (&quot;exec_context&quot;)       执行上下文（事件流等，系统使用）</span>
</span></code></pre></div></td></tr></table></div>
<h4 id="schema_1">自定义 Schema</h4>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-44-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-44-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-44-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-44-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-44-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-44-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-44-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-44-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-44-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-44-10">10</a></span>
<span class="normal"><a href="#__codelineno-44-11">11</a></span>
<span class="normal"><a href="#__codelineno-44-12">12</a></span>
<span class="normal"><a href="#__codelineno-44-13">13</a></span>
<span class="normal"><a href="#__codelineno-44-14">14</a></span>
<span class="normal"><a href="#__codelineno-44-15">15</a></span>
<span class="normal"><a href="#__codelineno-44-16">16</a></span>
<span class="normal"><a href="#__codelineno-44-17">17</a></span>
<span class="normal"><a href="#__codelineno-44-18">18</a></span>
<span class="normal"><a href="#__codelineno-44-19">19</a></span>
<span class="normal"><a href="#__codelineno-44-20">20</a></span>
<span class="normal"><a href="#__codelineno-44-21">21</a></span>
<span class="normal"><a href="#__codelineno-44-22">22</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-44-1"><a id="__codelineno-44-1" name="__codelineno-44-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-44-2"><a id="__codelineno-44-2" name="__codelineno-44-2"></a><span class="w">    </span><span class="s">&quot;reflect&quot;</span>
</span><span id="__span-44-3"><a id="__codelineno-44-3" name="__codelineno-44-3"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-44-4"><a id="__codelineno-44-4" name="__codelineno-44-4"></a><span class="p">)</span>
</span><span id="__span-44-5"><a id="__codelineno-44-5" name="__codelineno-44-5"></a>
</span><span id="__span-44-6"><a id="__codelineno-44-6" name="__codelineno-44-6"></a><span class="nx">schema</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateSchema</span><span class="p">()</span>
</span><span id="__span-44-7"><a id="__codelineno-44-7" name="__codelineno-44-7"></a>
</span><span id="__span-44-8"><a id="__codelineno-44-8" name="__codelineno-44-8"></a><span class="c1">// 添加自定义字段</span>
</span><span id="__span-44-9"><a id="__codelineno-44-9" name="__codelineno-44-9"></a><span class="nx">schema</span><span class="p">.</span><span class="nx">AddField</span><span class="p">(</span><span class="s">&quot;counter&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateField</span><span class="p">{</span>
</span><span id="__span-44-10"><a id="__codelineno-44-10" name="__codelineno-44-10"></a><span class="w">    </span><span class="nx">Type</span><span class="p">:</span><span class="w">    </span><span class="nx">reflect</span><span class="p">.</span><span class="nx">TypeOf</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span><span id="__span-44-11"><a id="__codelineno-44-11" name="__codelineno-44-11"></a><span class="w">    </span><span class="nx">Default</span><span class="p">:</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="kt">any</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">},</span>
</span><span id="__span-44-12"><a id="__codelineno-44-12" name="__codelineno-44-12"></a><span class="w">    </span><span class="nx">Reducer</span><span class="p">:</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">old</span><span class="p">,</span><span class="w"> </span><span class="nx">new</span><span class="w"> </span><span class="kt">any</span><span class="p">)</span><span class="w"> </span><span class="kt">any</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-44-13"><a id="__codelineno-44-13" name="__codelineno-44-13"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">old</span><span class="p">.(</span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">new</span><span class="p">.(</span><span class="kt">int</span><span class="p">)</span><span class="w">  </span><span class="c1">// 累加</span>
</span><span id="__span-44-14"><a id="__codelineno-44-14" name="__codelineno-44-14"></a><span class="w">    </span><span class="p">},</span>
</span><span id="__span-44-15"><a id="__codelineno-44-15" name="__codelineno-44-15"></a><span class="p">})</span>
</span><span id="__span-44-16"><a id="__codelineno-44-16" name="__codelineno-44-16"></a>
</span><span id="__span-44-17"><a id="__codelineno-44-17" name="__codelineno-44-17"></a><span class="c1">// 字符串列表使用内置 Reducer</span>
</span><span id="__span-44-18"><a id="__codelineno-44-18" name="__codelineno-44-18"></a><span class="nx">schema</span><span class="p">.</span><span class="nx">AddField</span><span class="p">(</span><span class="s">&quot;items&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateField</span><span class="p">{</span>
</span><span id="__span-44-19"><a id="__codelineno-44-19" name="__codelineno-44-19"></a><span class="w">    </span><span class="nx">Type</span><span class="p">:</span><span class="w">    </span><span class="nx">reflect</span><span class="p">.</span><span class="nx">TypeOf</span><span class="p">([]</span><span class="kt">string</span><span class="p">{}),</span>
</span><span id="__span-44-20"><a id="__codelineno-44-20" name="__codelineno-44-20"></a><span class="w">    </span><span class="nx">Default</span><span class="p">:</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="kt">any</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="p">[]</span><span class="kt">string</span><span class="p">{}</span><span class="w"> </span><span class="p">},</span>
</span><span id="__span-44-21"><a id="__codelineno-44-21" name="__codelineno-44-21"></a><span class="w">    </span><span class="nx">Reducer</span><span class="p">:</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">StringSliceReducer</span><span class="p">,</span>
</span><span id="__span-44-22"><a id="__codelineno-44-22" name="__codelineno-44-22"></a><span class="p">})</span>
</span></code></pre></div></td></tr></table></div>
<p>Reducer 机制确保状态字段按预定义规则安全合并，这在并发执行时尤其重要。</p>
<p>提示：建议为业务键定义常量，避免散落魔法字符串。</p>
<h3 id="_17">节点类型</h3>
<p>GraphAgent 提供了四种内置节点类型：</p>
<h4 id="function">Function 节点</h4>
<p>最基础的节点，执行自定义逻辑：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-45-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-45-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-45-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-45-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-45-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-45-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-45-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-45-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-45-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-45-10">10</a></span>
<span class="normal"><a href="#__codelineno-45-11">11</a></span>
<span class="normal"><a href="#__codelineno-45-12">12</a></span>
<span class="normal"><a href="#__codelineno-45-13">13</a></span>
<span class="normal"><a href="#__codelineno-45-14">14</a></span>
<span class="normal"><a href="#__codelineno-45-15">15</a></span>
<span class="normal"><a href="#__codelineno-45-16">16</a></span>
<span class="normal"><a href="#__codelineno-45-17">17</a></span>
<span class="normal"><a href="#__codelineno-45-18">18</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-45-1"><a id="__codelineno-45-1" name="__codelineno-45-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-45-2"><a id="__codelineno-45-2" name="__codelineno-45-2"></a><span class="w">    </span><span class="s">&quot;context&quot;</span>
</span><span id="__span-45-3"><a id="__codelineno-45-3" name="__codelineno-45-3"></a>
</span><span id="__span-45-4"><a id="__codelineno-45-4" name="__codelineno-45-4"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-45-5"><a id="__codelineno-45-5" name="__codelineno-45-5"></a><span class="p">)</span>
</span><span id="__span-45-6"><a id="__codelineno-45-6" name="__codelineno-45-6"></a>
</span><span id="__span-45-7"><a id="__codelineno-45-7" name="__codelineno-45-7"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-45-8"><a id="__codelineno-45-8" name="__codelineno-45-8"></a><span class="w">    </span><span class="nx">stateKeyInput</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;input&quot;</span>
</span><span id="__span-45-9"><a id="__codelineno-45-9" name="__codelineno-45-9"></a><span class="w">    </span><span class="nx">stateKeyOutput</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;output&quot;</span>
</span><span id="__span-45-10"><a id="__codelineno-45-10" name="__codelineno-45-10"></a><span class="w">    </span><span class="nx">nodeProcess</span><span class="w">    </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;process&quot;</span>
</span><span id="__span-45-11"><a id="__codelineno-45-11" name="__codelineno-45-11"></a><span class="p">)</span>
</span><span id="__span-45-12"><a id="__codelineno-45-12" name="__codelineno-45-12"></a>
</span><span id="__span-45-13"><a id="__codelineno-45-13" name="__codelineno-45-13"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="nx">nodeProcess</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-45-14"><a id="__codelineno-45-14" name="__codelineno-45-14"></a><span class="w">    </span><span class="nx">data</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">state</span><span class="p">[</span><span class="nx">stateKeyInput</span><span class="p">].(</span><span class="kt">string</span><span class="p">)</span>
</span><span id="__span-45-15"><a id="__codelineno-45-15" name="__codelineno-45-15"></a><span class="w">    </span><span class="nx">processed</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">transform</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
</span><span id="__span-45-16"><a id="__codelineno-45-16" name="__codelineno-45-16"></a><span class="w">    </span><span class="c1">// Function 节点需显式指定输出 key</span>
</span><span id="__span-45-17"><a id="__codelineno-45-17" name="__codelineno-45-17"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="nx">stateKeyOutput</span><span class="p">:</span><span class="w"> </span><span class="nx">processed</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-45-18"><a id="__codelineno-45-18" name="__codelineno-45-18"></a><span class="p">})</span>
</span></code></pre></div></td></tr></table></div>
<h4 id="llm_1">LLM 节点</h4>
<p>集成语言模型，自动管理对话历史：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-46-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-46-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-46-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-46-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-46-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-46-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-46-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-46-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-46-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-46-10">10</a></span>
<span class="normal"><a href="#__codelineno-46-11">11</a></span>
<span class="normal"><a href="#__codelineno-46-12">12</a></span>
<span class="normal"><a href="#__codelineno-46-13">13</a></span>
<span class="normal"><a href="#__codelineno-46-14">14</a></span>
<span class="normal"><a href="#__codelineno-46-15">15</a></span>
<span class="normal"><a href="#__codelineno-46-16">16</a></span>
<span class="normal"><a href="#__codelineno-46-17">17</a></span>
<span class="normal"><a href="#__codelineno-46-18">18</a></span>
<span class="normal"><a href="#__codelineno-46-19">19</a></span>
<span class="normal"><a href="#__codelineno-46-20">20</a></span>
<span class="normal"><a href="#__codelineno-46-21">21</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-46-1"><a id="__codelineno-46-1" name="__codelineno-46-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-46-2"><a id="__codelineno-46-2" name="__codelineno-46-2"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-46-3"><a id="__codelineno-46-3" name="__codelineno-46-3"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/model/openai&quot;</span>
</span><span id="__span-46-4"><a id="__codelineno-46-4" name="__codelineno-46-4"></a><span class="p">)</span>
</span><span id="__span-46-5"><a id="__codelineno-46-5" name="__codelineno-46-5"></a>
</span><span id="__span-46-6"><a id="__codelineno-46-6" name="__codelineno-46-6"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-46-7"><a id="__codelineno-46-7" name="__codelineno-46-7"></a><span class="w">    </span><span class="nx">llmModelName</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;gpt-4o-mini&quot;</span>
</span><span id="__span-46-8"><a id="__codelineno-46-8" name="__codelineno-46-8"></a><span class="w">    </span><span class="nx">llmSystemPrompt</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;系统提示词&quot;</span>
</span><span id="__span-46-9"><a id="__codelineno-46-9" name="__codelineno-46-9"></a><span class="w">    </span><span class="nx">llmNodeAssistant</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;assistant&quot;</span>
</span><span id="__span-46-10"><a id="__codelineno-46-10" name="__codelineno-46-10"></a><span class="p">)</span>
</span><span id="__span-46-11"><a id="__codelineno-46-11" name="__codelineno-46-11"></a>
</span><span id="__span-46-12"><a id="__codelineno-46-12" name="__codelineno-46-12"></a><span class="nx">model</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">openai</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="nx">llmModelName</span><span class="p">)</span>
</span><span id="__span-46-13"><a id="__codelineno-46-13" name="__codelineno-46-13"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddLLMNode</span><span class="p">(</span><span class="nx">llmNodeAssistant</span><span class="p">,</span><span class="w"> </span><span class="nx">model</span><span class="p">,</span><span class="w"> </span><span class="nx">llmSystemPrompt</span><span class="p">,</span><span class="w"> </span><span class="nx">tools</span><span class="p">)</span>
</span><span id="__span-46-14"><a id="__codelineno-46-14" name="__codelineno-46-14"></a>
</span><span id="__span-46-15"><a id="__codelineno-46-15" name="__codelineno-46-15"></a><span class="c1">// LLM 节点的输入输出规则：</span>
</span><span id="__span-46-16"><a id="__codelineno-46-16" name="__codelineno-46-16"></a><span class="c1">// 输入优先级:</span>
</span><span id="__span-46-17"><a id="__codelineno-46-17" name="__codelineno-46-17"></a><span class="c1">// graph.StateKeyOneShotMessagesByNode[&lt;node_id&gt;] &gt;</span>
</span><span id="__span-46-18"><a id="__codelineno-46-18" name="__codelineno-46-18"></a><span class="c1">// graph.StateKeyOneShotMessages &gt;</span>
</span><span id="__span-46-19"><a id="__codelineno-46-19" name="__codelineno-46-19"></a><span class="c1">// graph.StateKeyUserInput &gt;</span>
</span><span id="__span-46-20"><a id="__codelineno-46-20" name="__codelineno-46-20"></a><span class="c1">// graph.StateKeyMessages</span>
</span><span id="__span-46-21"><a id="__codelineno-46-21" name="__codelineno-46-21"></a><span class="c1">// 输出: graph.StateKeyLastResponse、graph.StateKeyMessages(原子更新)、graph.StateKeyNodeResponses（包含当前节点输出，便于并行汇总）</span>
</span></code></pre></div></td></tr></table></div>
<h2 id="cache">节点缓存（Cache）</h2>
<p>为“纯函数型”节点开启缓存可以显著减少重复计算开销。Graph 支持图级与节点级缓存策略：</p>
<ul>
<li>图级设置缓存实现与默认策略：<ul>
<li><code>WithCache(cache Cache)</code> 设置缓存后端（默认示例提供内存实现 InMemoryCache）</li>
<li><code>WithCachePolicy(policy *CachePolicy)</code> 设置默认缓存策略（键函数 KeyFunc + 生存时间 Time To Live, TTL）</li>
</ul>
</li>
<li>节点级覆盖策略：<code>WithNodeCachePolicy(policy *CachePolicy)</code>（优先于图级）</li>
<li>清理：<code>ClearCache(nodes ...string)</code> 按节点清理缓存命名空间</li>
</ul>
<p>参考：</p>
<ul>
<li>Graph 接口（缓存与策略的访问/设置）：<a href="https://github.com/trpc-group/trpc-agent-go/blob/main/graph/graph.go">graph/graph.go</a></li>
<li>默认策略与内存后端实现：<ul>
<li>接口/策略与默认键函数（规范化 JSON + SHA‑256）：<a href="https://github.com/trpc-group/trpc-agent-go/blob/main/graph/cache.go">graph/cache.go</a></li>
<li>内存缓存（InMemoryCache）并发安全实现（读写锁 + 深拷贝）：<a href="https://github.com/trpc-group/trpc-agent-go/blob/main/graph/cache.go">graph/cache.go</a></li>
</ul>
</li>
<li>执行器：<ul>
<li>节点执行前尝试 Get，命中则跳过节点函数执行，仅触发 after 回调与写出（Writes）：<a href="https://github.com/trpc-group/trpc-agent-go/blob/main/graph/executor.go">graph/executor.go</a></li>
<li>正常执行成功后写入缓存（Set）：<a href="https://github.com/trpc-group/trpc-agent-go/blob/main/graph/executor.go">graph/executor.go</a></li>
<li>节点完成事件中附带 <code>_cache_hit</code> 观察标记（命中时插入 <code>StateDelta["_cache_hit"]=true</code>）：<a href="https://github.com/trpc-group/trpc-agent-go/blob/main/graph/executor.go">graph/executor.go</a></li>
</ul>
</li>
</ul>
<p>最小用法：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-47-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-47-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-47-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-47-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-47-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-47-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-47-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-47-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-47-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-47-10">10</a></span>
<span class="normal"><a href="#__codelineno-47-11">11</a></span>
<span class="normal"><a href="#__codelineno-47-12">12</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-47-1"><a id="__codelineno-47-1" name="__codelineno-47-1"></a><span class="nx">schema</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateSchema</span><span class="p">()</span>
</span><span id="__span-47-2"><a id="__codelineno-47-2" name="__codelineno-47-2"></a><span class="nx">sg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateGraph</span><span class="p">(</span><span class="nx">schema</span><span class="p">).</span>
</span><span id="__span-47-3"><a id="__codelineno-47-3" name="__codelineno-47-3"></a><span class="w">  </span><span class="nx">WithCache</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewInMemoryCache</span><span class="p">()).</span>
</span><span id="__span-47-4"><a id="__codelineno-47-4" name="__codelineno-47-4"></a><span class="w">  </span><span class="nx">WithCachePolicy</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">DefaultCachePolicy</span><span class="p">())</span>
</span><span id="__span-47-5"><a id="__codelineno-47-5" name="__codelineno-47-5"></a>
</span><span id="__span-47-6"><a id="__codelineno-47-6" name="__codelineno-47-6"></a><span class="c1">// 对某个节点单独设置 TTL 10 分钟</span>
</span><span id="__span-47-7"><a id="__codelineno-47-7" name="__codelineno-47-7"></a><span class="nx">nodePolicy</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">graph</span><span class="p">.</span><span class="nx">CachePolicy</span><span class="p">{</span><span class="nx">KeyFunc</span><span class="p">:</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">DefaultCachePolicy</span><span class="p">().</span><span class="nx">KeyFunc</span><span class="p">,</span><span class="w"> </span><span class="nx">TTL</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span><span class="p">}</span>
</span><span id="__span-47-8"><a id="__codelineno-47-8" name="__codelineno-47-8"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;compute&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">computeFunc</span><span class="p">,</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithNodeCachePolicy</span><span class="p">(</span><span class="nx">nodePolicy</span><span class="p">)).</span>
</span><span id="__span-47-9"><a id="__codelineno-47-9" name="__codelineno-47-9"></a><span class="w">  </span><span class="nx">SetEntryPoint</span><span class="p">(</span><span class="s">&quot;compute&quot;</span><span class="p">).</span>
</span><span id="__span-47-10"><a id="__codelineno-47-10" name="__codelineno-47-10"></a><span class="w">  </span><span class="nx">SetFinishPoint</span><span class="p">(</span><span class="s">&quot;compute&quot;</span><span class="p">)</span>
</span><span id="__span-47-11"><a id="__codelineno-47-11" name="__codelineno-47-11"></a>
</span><span id="__span-47-12"><a id="__codelineno-47-12" name="__codelineno-47-12"></a><span class="nx">compiled</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">sg</span><span class="p">.</span><span class="nx">Compile</span><span class="p">()</span>
</span></code></pre></div></td></tr></table></div>
<p>进阶用法：</p>
<ul>
<li>仅使用部分字段作为键（推荐）</li>
</ul>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-48-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-48-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-48-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-48-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-48-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-48-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-48-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-48-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-48-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-48-10">10</a></span>
<span class="normal"><a href="#__codelineno-48-11">11</a></span>
<span class="normal"><a href="#__codelineno-48-12">12</a></span>
<span class="normal"><a href="#__codelineno-48-13">13</a></span>
<span class="normal"><a href="#__codelineno-48-14">14</a></span>
<span class="normal"><a href="#__codelineno-48-15">15</a></span>
<span class="normal"><a href="#__codelineno-48-16">16</a></span>
<span class="normal"><a href="#__codelineno-48-17">17</a></span>
<span class="normal"><a href="#__codelineno-48-18">18</a></span>
<span class="normal"><a href="#__codelineno-48-19">19</a></span>
<span class="normal"><a href="#__codelineno-48-20">20</a></span>
<span class="normal"><a href="#__codelineno-48-21">21</a></span>
<span class="normal"><a href="#__codelineno-48-22">22</a></span>
<span class="normal"><a href="#__codelineno-48-23">23</a></span>
<span class="normal"><a href="#__codelineno-48-24">24</a></span>
<span class="normal"><a href="#__codelineno-48-25">25</a></span>
<span class="normal"><a href="#__codelineno-48-26">26</a></span>
<span class="normal"><a href="#__codelineno-48-27">27</a></span>
<span class="normal"><a href="#__codelineno-48-28">28</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-48-1"><a id="__codelineno-48-1" name="__codelineno-48-1"></a><span class="kn">package</span><span class="w"> </span><span class="nx">main</span>
</span><span id="__span-48-2"><a id="__codelineno-48-2" name="__codelineno-48-2"></a>
</span><span id="__span-48-3"><a id="__codelineno-48-3" name="__codelineno-48-3"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-48-4"><a id="__codelineno-48-4" name="__codelineno-48-4"></a><span class="w">    </span><span class="s">&quot;context&quot;</span>
</span><span id="__span-48-5"><a id="__codelineno-48-5" name="__codelineno-48-5"></a><span class="w">    </span><span class="s">&quot;time&quot;</span>
</span><span id="__span-48-6"><a id="__codelineno-48-6" name="__codelineno-48-6"></a>
</span><span id="__span-48-7"><a id="__codelineno-48-7" name="__codelineno-48-7"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-48-8"><a id="__codelineno-48-8" name="__codelineno-48-8"></a><span class="p">)</span>
</span><span id="__span-48-9"><a id="__codelineno-48-9" name="__codelineno-48-9"></a>
</span><span id="__span-48-10"><a id="__codelineno-48-10" name="__codelineno-48-10"></a><span class="kd">func</span><span class="w"> </span><span class="nx">build</span><span class="p">()</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">graph</span><span class="p">.</span><span class="nx">Graph</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-48-11"><a id="__codelineno-48-11" name="__codelineno-48-11"></a><span class="w">    </span><span class="nx">schema</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateSchema</span><span class="p">()</span>
</span><span id="__span-48-12"><a id="__codelineno-48-12" name="__codelineno-48-12"></a><span class="w">    </span><span class="nx">sg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateGraph</span><span class="p">(</span><span class="nx">schema</span><span class="p">).</span>
</span><span id="__span-48-13"><a id="__codelineno-48-13" name="__codelineno-48-13"></a><span class="w">        </span><span class="nx">WithCache</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewInMemoryCache</span><span class="p">()).</span>
</span><span id="__span-48-14"><a id="__codelineno-48-14" name="__codelineno-48-14"></a><span class="w">        </span><span class="nx">WithCachePolicy</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">DefaultCachePolicy</span><span class="p">())</span>
</span><span id="__span-48-15"><a id="__codelineno-48-15" name="__codelineno-48-15"></a>
</span><span id="__span-48-16"><a id="__codelineno-48-16" name="__codelineno-48-16"></a><span class="w">    </span><span class="nx">compute</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-48-17"><a id="__codelineno-48-17" name="__codelineno-48-17"></a><span class="w">        </span><span class="c1">// your logic here</span>
</span><span id="__span-48-18"><a id="__codelineno-48-18" name="__codelineno-48-18"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="s">&quot;out&quot;</span><span class="p">:</span><span class="w"> </span><span class="nx">s</span><span class="p">[</span><span class="s">&quot;n&quot;</span><span class="p">].(</span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-48-19"><a id="__codelineno-48-19" name="__codelineno-48-19"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-48-20"><a id="__codelineno-48-20" name="__codelineno-48-20"></a>
</span><span id="__span-48-21"><a id="__codelineno-48-21" name="__codelineno-48-21"></a><span class="w">    </span><span class="c1">// 仅使用 n 与 user_id 两个字段参与键计算（其余字段不会影响命中）</span>
</span><span id="__span-48-22"><a id="__codelineno-48-22" name="__codelineno-48-22"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;compute&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">compute</span><span class="p">,</span>
</span><span id="__span-48-23"><a id="__codelineno-48-23" name="__codelineno-48-23"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithNodeCachePolicy</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">graph</span><span class="p">.</span><span class="nx">CachePolicy</span><span class="p">{</span><span class="nx">KeyFunc</span><span class="p">:</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">DefaultCachePolicy</span><span class="p">().</span><span class="nx">KeyFunc</span><span class="p">,</span><span class="w"> </span><span class="nx">TTL</span><span class="p">:</span><span class="w"> </span><span class="mi">30</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span><span class="p">}),</span>
</span><span id="__span-48-24"><a id="__codelineno-48-24" name="__codelineno-48-24"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithCacheKeyFields</span><span class="p">(</span><span class="s">&quot;n&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;user_id&quot;</span><span class="p">),</span>
</span><span id="__span-48-25"><a id="__codelineno-48-25" name="__codelineno-48-25"></a><span class="w">    </span><span class="p">)</span>
</span><span id="__span-48-26"><a id="__codelineno-48-26" name="__codelineno-48-26"></a>
</span><span id="__span-48-27"><a id="__codelineno-48-27" name="__codelineno-48-27"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">sg</span><span class="p">.</span><span class="nx">Compile</span><span class="p">()</span>
</span><span id="__span-48-28"><a id="__codelineno-48-28" name="__codelineno-48-28"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<ul>
<li>自定义选择器（当字段映射更复杂时）</li>
</ul>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-49-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-49-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-49-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-49-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-49-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-49-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-49-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-49-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-49-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-49-10">10</a></span>
<span class="normal"><a href="#__codelineno-49-11">11</a></span>
<span class="normal"><a href="#__codelineno-49-12">12</a></span>
<span class="normal"><a href="#__codelineno-49-13">13</a></span>
<span class="normal"><a href="#__codelineno-49-14">14</a></span>
<span class="normal"><a href="#__codelineno-49-15">15</a></span>
<span class="normal"><a href="#__codelineno-49-16">16</a></span>
<span class="normal"><a href="#__codelineno-49-17">17</a></span>
<span class="normal"><a href="#__codelineno-49-18">18</a></span>
<span class="normal"><a href="#__codelineno-49-19">19</a></span>
<span class="normal"><a href="#__codelineno-49-20">20</a></span>
<span class="normal"><a href="#__codelineno-49-21">21</a></span>
<span class="normal"><a href="#__codelineno-49-22">22</a></span>
<span class="normal"><a href="#__codelineno-49-23">23</a></span>
<span class="normal"><a href="#__codelineno-49-24">24</a></span>
<span class="normal"><a href="#__codelineno-49-25">25</a></span>
<span class="normal"><a href="#__codelineno-49-26">26</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-49-1"><a id="__codelineno-49-1" name="__codelineno-49-1"></a><span class="kn">package</span><span class="w"> </span><span class="nx">main</span>
</span><span id="__span-49-2"><a id="__codelineno-49-2" name="__codelineno-49-2"></a>
</span><span id="__span-49-3"><a id="__codelineno-49-3" name="__codelineno-49-3"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-49-4"><a id="__codelineno-49-4" name="__codelineno-49-4"></a><span class="w">    </span><span class="s">&quot;context&quot;</span>
</span><span id="__span-49-5"><a id="__codelineno-49-5" name="__codelineno-49-5"></a><span class="w">    </span><span class="s">&quot;time&quot;</span>
</span><span id="__span-49-6"><a id="__codelineno-49-6" name="__codelineno-49-6"></a>
</span><span id="__span-49-7"><a id="__codelineno-49-7" name="__codelineno-49-7"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-49-8"><a id="__codelineno-49-8" name="__codelineno-49-8"></a><span class="p">)</span>
</span><span id="__span-49-9"><a id="__codelineno-49-9" name="__codelineno-49-9"></a>
</span><span id="__span-49-10"><a id="__codelineno-49-10" name="__codelineno-49-10"></a><span class="kd">func</span><span class="w"> </span><span class="nx">build</span><span class="p">()</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">graph</span><span class="p">.</span><span class="nx">Graph</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-49-11"><a id="__codelineno-49-11" name="__codelineno-49-11"></a><span class="w">    </span><span class="nx">schema</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateSchema</span><span class="p">()</span>
</span><span id="__span-49-12"><a id="__codelineno-49-12" name="__codelineno-49-12"></a><span class="w">    </span><span class="nx">sg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateGraph</span><span class="p">(</span><span class="nx">schema</span><span class="p">).</span>
</span><span id="__span-49-13"><a id="__codelineno-49-13" name="__codelineno-49-13"></a><span class="w">        </span><span class="nx">WithCache</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewInMemoryCache</span><span class="p">()).</span>
</span><span id="__span-49-14"><a id="__codelineno-49-14" name="__codelineno-49-14"></a><span class="w">        </span><span class="nx">WithCachePolicy</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">DefaultCachePolicy</span><span class="p">())</span>
</span><span id="__span-49-15"><a id="__codelineno-49-15" name="__codelineno-49-15"></a>
</span><span id="__span-49-16"><a id="__codelineno-49-16" name="__codelineno-49-16"></a><span class="w">    </span><span class="nx">compute</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="s">&quot;out&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">42</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-49-17"><a id="__codelineno-49-17" name="__codelineno-49-17"></a>
</span><span id="__span-49-18"><a id="__codelineno-49-18" name="__codelineno-49-18"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;compute&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">compute</span><span class="p">,</span>
</span><span id="__span-49-19"><a id="__codelineno-49-19" name="__codelineno-49-19"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithNodeCachePolicy</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">graph</span><span class="p">.</span><span class="nx">CachePolicy</span><span class="p">{</span><span class="nx">KeyFunc</span><span class="p">:</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">DefaultCachePolicy</span><span class="p">().</span><span class="nx">KeyFunc</span><span class="p">,</span><span class="w"> </span><span class="nx">TTL</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span><span class="p">}),</span>
</span><span id="__span-49-20"><a id="__codelineno-49-20" name="__codelineno-49-20"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithCacheKeySelector</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">m</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">any</span><span class="p">)</span><span class="w"> </span><span class="kt">any</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-49-21"><a id="__codelineno-49-21" name="__codelineno-49-21"></a><span class="w">            </span><span class="c1">// 仅从净化后的输入中选择 n 与 uid 作为键来源</span>
</span><span id="__span-49-22"><a id="__codelineno-49-22" name="__codelineno-49-22"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">any</span><span class="p">{</span><span class="s">&quot;n&quot;</span><span class="p">:</span><span class="w"> </span><span class="nx">m</span><span class="p">[</span><span class="s">&quot;n&quot;</span><span class="p">],</span><span class="w"> </span><span class="s">&quot;uid&quot;</span><span class="p">:</span><span class="w"> </span><span class="nx">m</span><span class="p">[</span><span class="s">&quot;uid&quot;</span><span class="p">]}</span>
</span><span id="__span-49-23"><a id="__codelineno-49-23" name="__codelineno-49-23"></a><span class="w">        </span><span class="p">}),</span>
</span><span id="__span-49-24"><a id="__codelineno-49-24" name="__codelineno-49-24"></a><span class="w">    </span><span class="p">)</span>
</span><span id="__span-49-25"><a id="__codelineno-49-25" name="__codelineno-49-25"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">sg</span><span class="p">.</span><span class="nx">Compile</span><span class="p">()</span>
</span><span id="__span-49-26"><a id="__codelineno-49-26" name="__codelineno-49-26"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<ul>
<li>版本化命名空间（跨版本防脏缓存）</li>
</ul>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-50-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-50-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-50-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-50-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-50-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-50-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-50-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-50-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-50-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-50-10">10</a></span>
<span class="normal"><a href="#__codelineno-50-11">11</a></span>
<span class="normal"><a href="#__codelineno-50-12">12</a></span>
<span class="normal"><a href="#__codelineno-50-13">13</a></span>
<span class="normal"><a href="#__codelineno-50-14">14</a></span>
<span class="normal"><a href="#__codelineno-50-15">15</a></span>
<span class="normal"><a href="#__codelineno-50-16">16</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-50-1"><a id="__codelineno-50-1" name="__codelineno-50-1"></a><span class="kn">package</span><span class="w"> </span><span class="nx">main</span>
</span><span id="__span-50-2"><a id="__codelineno-50-2" name="__codelineno-50-2"></a>
</span><span id="__span-50-3"><a id="__codelineno-50-3" name="__codelineno-50-3"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-50-4"><a id="__codelineno-50-4" name="__codelineno-50-4"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-50-5"><a id="__codelineno-50-5" name="__codelineno-50-5"></a><span class="p">)</span>
</span><span id="__span-50-6"><a id="__codelineno-50-6" name="__codelineno-50-6"></a>
</span><span id="__span-50-7"><a id="__codelineno-50-7" name="__codelineno-50-7"></a><span class="kd">func</span><span class="w"> </span><span class="nx">build</span><span class="p">()</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">graph</span><span class="p">.</span><span class="nx">Graph</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-50-8"><a id="__codelineno-50-8" name="__codelineno-50-8"></a><span class="w">    </span><span class="nx">schema</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateSchema</span><span class="p">()</span>
</span><span id="__span-50-9"><a id="__codelineno-50-9" name="__codelineno-50-9"></a><span class="w">    </span><span class="nx">sg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateGraph</span><span class="p">(</span><span class="nx">schema</span><span class="p">).</span>
</span><span id="__span-50-10"><a id="__codelineno-50-10" name="__codelineno-50-10"></a><span class="w">        </span><span class="nx">WithGraphVersion</span><span class="p">(</span><span class="s">&quot;v2025.03&quot;</span><span class="p">).</span><span class="w"> </span><span class="c1">// 命名空间变为 __writes__:v2025.03:&lt;node&gt;</span>
</span><span id="__span-50-11"><a id="__codelineno-50-11" name="__codelineno-50-11"></a><span class="w">        </span><span class="nx">WithCache</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewInMemoryCache</span><span class="p">()).</span>
</span><span id="__span-50-12"><a id="__codelineno-50-12" name="__codelineno-50-12"></a><span class="w">        </span><span class="nx">WithCachePolicy</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">DefaultCachePolicy</span><span class="p">())</span>
</span><span id="__span-50-13"><a id="__codelineno-50-13" name="__codelineno-50-13"></a>
</span><span id="__span-50-14"><a id="__codelineno-50-14" name="__codelineno-50-14"></a><span class="w">    </span><span class="c1">// ... AddNode(...)</span>
</span><span id="__span-50-15"><a id="__codelineno-50-15" name="__codelineno-50-15"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">sg</span><span class="p">.</span><span class="nx">Compile</span><span class="p">()</span>
</span><span id="__span-50-16"><a id="__codelineno-50-16" name="__codelineno-50-16"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<ul>
<li>节点级 TTL（Time To Live）</li>
</ul>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-51-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-51-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-51-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-51-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-51-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-51-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-51-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-51-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-51-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-51-10">10</a></span>
<span class="normal"><a href="#__codelineno-51-11">11</a></span>
<span class="normal"><a href="#__codelineno-51-12">12</a></span>
<span class="normal"><a href="#__codelineno-51-13">13</a></span>
<span class="normal"><a href="#__codelineno-51-14">14</a></span>
<span class="normal"><a href="#__codelineno-51-15">15</a></span>
<span class="normal"><a href="#__codelineno-51-16">16</a></span>
<span class="normal"><a href="#__codelineno-51-17">17</a></span>
<span class="normal"><a href="#__codelineno-51-18">18</a></span>
<span class="normal"><a href="#__codelineno-51-19">19</a></span>
<span class="normal"><a href="#__codelineno-51-20">20</a></span>
<span class="normal"><a href="#__codelineno-51-21">21</a></span>
<span class="normal"><a href="#__codelineno-51-22">22</a></span>
<span class="normal"><a href="#__codelineno-51-23">23</a></span>
<span class="normal"><a href="#__codelineno-51-24">24</a></span>
<span class="normal"><a href="#__codelineno-51-25">25</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-51-1"><a id="__codelineno-51-1" name="__codelineno-51-1"></a><span class="kn">package</span><span class="w"> </span><span class="nx">main</span>
</span><span id="__span-51-2"><a id="__codelineno-51-2" name="__codelineno-51-2"></a>
</span><span id="__span-51-3"><a id="__codelineno-51-3" name="__codelineno-51-3"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-51-4"><a id="__codelineno-51-4" name="__codelineno-51-4"></a><span class="w">    </span><span class="s">&quot;context&quot;</span>
</span><span id="__span-51-5"><a id="__codelineno-51-5" name="__codelineno-51-5"></a><span class="w">    </span><span class="s">&quot;time&quot;</span>
</span><span id="__span-51-6"><a id="__codelineno-51-6" name="__codelineno-51-6"></a>
</span><span id="__span-51-7"><a id="__codelineno-51-7" name="__codelineno-51-7"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-51-8"><a id="__codelineno-51-8" name="__codelineno-51-8"></a><span class="p">)</span>
</span><span id="__span-51-9"><a id="__codelineno-51-9" name="__codelineno-51-9"></a>
</span><span id="__span-51-10"><a id="__codelineno-51-10" name="__codelineno-51-10"></a><span class="kd">func</span><span class="w"> </span><span class="nx">build</span><span class="p">()</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">graph</span><span class="p">.</span><span class="nx">Graph</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-51-11"><a id="__codelineno-51-11" name="__codelineno-51-11"></a><span class="w">    </span><span class="nx">schema</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateSchema</span><span class="p">()</span>
</span><span id="__span-51-12"><a id="__codelineno-51-12" name="__codelineno-51-12"></a><span class="w">    </span><span class="nx">sg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateGraph</span><span class="p">(</span><span class="nx">schema</span><span class="p">).</span>
</span><span id="__span-51-13"><a id="__codelineno-51-13" name="__codelineno-51-13"></a><span class="w">        </span><span class="nx">WithCache</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewInMemoryCache</span><span class="p">()).</span>
</span><span id="__span-51-14"><a id="__codelineno-51-14" name="__codelineno-51-14"></a><span class="w">        </span><span class="nx">WithCachePolicy</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">DefaultCachePolicy</span><span class="p">())</span>
</span><span id="__span-51-15"><a id="__codelineno-51-15" name="__codelineno-51-15"></a>
</span><span id="__span-51-16"><a id="__codelineno-51-16" name="__codelineno-51-16"></a><span class="w">    </span><span class="nx">compute</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="s">&quot;out&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">42</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-51-17"><a id="__codelineno-51-17" name="__codelineno-51-17"></a>
</span><span id="__span-51-18"><a id="__codelineno-51-18" name="__codelineno-51-18"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;compute&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">compute</span><span class="p">,</span>
</span><span id="__span-51-19"><a id="__codelineno-51-19" name="__codelineno-51-19"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithNodeCachePolicy</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">graph</span><span class="p">.</span><span class="nx">CachePolicy</span><span class="p">{</span>
</span><span id="__span-51-20"><a id="__codelineno-51-20" name="__codelineno-51-20"></a><span class="w">            </span><span class="nx">KeyFunc</span><span class="p">:</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">DefaultCachePolicy</span><span class="p">().</span><span class="nx">KeyFunc</span><span class="p">,</span>
</span><span id="__span-51-21"><a id="__codelineno-51-21" name="__codelineno-51-21"></a><span class="w">            </span><span class="nx">TTL</span><span class="p">:</span><span class="w">     </span><span class="mi">10</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span><span class="p">,</span>
</span><span id="__span-51-22"><a id="__codelineno-51-22" name="__codelineno-51-22"></a><span class="w">        </span><span class="p">}),</span>
</span><span id="__span-51-23"><a id="__codelineno-51-23" name="__codelineno-51-23"></a><span class="w">    </span><span class="p">)</span>
</span><span id="__span-51-24"><a id="__codelineno-51-24" name="__codelineno-51-24"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">sg</span><span class="p">.</span><span class="nx">Compile</span><span class="p">()</span>
</span><span id="__span-51-25"><a id="__codelineno-51-25" name="__codelineno-51-25"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<ul>
<li>清理缓存（按节点）</li>
</ul>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-52-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-52-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-52-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-52-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-52-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-52-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-52-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-52-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-52-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-52-10">10</a></span>
<span class="normal"><a href="#__codelineno-52-11">11</a></span>
<span class="normal"><a href="#__codelineno-52-12">12</a></span>
<span class="normal"><a href="#__codelineno-52-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-52-1"><a id="__codelineno-52-1" name="__codelineno-52-1"></a><span class="kn">package</span><span class="w"> </span><span class="nx">main</span>
</span><span id="__span-52-2"><a id="__codelineno-52-2" name="__codelineno-52-2"></a>
</span><span id="__span-52-3"><a id="__codelineno-52-3" name="__codelineno-52-3"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-52-4"><a id="__codelineno-52-4" name="__codelineno-52-4"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-52-5"><a id="__codelineno-52-5" name="__codelineno-52-5"></a><span class="p">)</span>
</span><span id="__span-52-6"><a id="__codelineno-52-6" name="__codelineno-52-6"></a>
</span><span id="__span-52-7"><a id="__codelineno-52-7" name="__codelineno-52-7"></a><span class="kd">func</span><span class="w"> </span><span class="nb">clear</span><span class="p">(</span><span class="nx">sg</span><span class="w"> </span><span class="o">*</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateGraph</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-52-8"><a id="__codelineno-52-8" name="__codelineno-52-8"></a><span class="w">    </span><span class="c1">// 清理指定节点</span>
</span><span id="__span-52-9"><a id="__codelineno-52-9" name="__codelineno-52-9"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">ClearCache</span><span class="p">(</span><span class="s">&quot;compute&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;format&quot;</span><span class="p">)</span>
</span><span id="__span-52-10"><a id="__codelineno-52-10" name="__codelineno-52-10"></a>
</span><span id="__span-52-11"><a id="__codelineno-52-11" name="__codelineno-52-11"></a><span class="w">    </span><span class="c1">// 清理图内所有节点（不传参）</span>
</span><span id="__span-52-12"><a id="__codelineno-52-12" name="__codelineno-52-12"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">ClearCache</span><span class="p">()</span>
</span><span id="__span-52-13"><a id="__codelineno-52-13" name="__codelineno-52-13"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<ul>
<li>读取缓存命中标记（_cache_hit）</li>
</ul>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-53-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-53-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-53-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-53-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-53-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-53-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-53-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-53-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-53-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-53-10">10</a></span>
<span class="normal"><a href="#__codelineno-53-11">11</a></span>
<span class="normal"><a href="#__codelineno-53-12">12</a></span>
<span class="normal"><a href="#__codelineno-53-13">13</a></span>
<span class="normal"><a href="#__codelineno-53-14">14</a></span>
<span class="normal"><a href="#__codelineno-53-15">15</a></span>
<span class="normal"><a href="#__codelineno-53-16">16</a></span>
<span class="normal"><a href="#__codelineno-53-17">17</a></span>
<span class="normal"><a href="#__codelineno-53-18">18</a></span>
<span class="normal"><a href="#__codelineno-53-19">19</a></span>
<span class="normal"><a href="#__codelineno-53-20">20</a></span>
<span class="normal"><a href="#__codelineno-53-21">21</a></span>
<span class="normal"><a href="#__codelineno-53-22">22</a></span>
<span class="normal"><a href="#__codelineno-53-23">23</a></span>
<span class="normal"><a href="#__codelineno-53-24">24</a></span>
<span class="normal"><a href="#__codelineno-53-25">25</a></span>
<span class="normal"><a href="#__codelineno-53-26">26</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-53-1"><a id="__codelineno-53-1" name="__codelineno-53-1"></a><span class="kn">package</span><span class="w"> </span><span class="nx">main</span>
</span><span id="__span-53-2"><a id="__codelineno-53-2" name="__codelineno-53-2"></a>
</span><span id="__span-53-3"><a id="__codelineno-53-3" name="__codelineno-53-3"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-53-4"><a id="__codelineno-53-4" name="__codelineno-53-4"></a><span class="w">    </span><span class="s">&quot;context&quot;</span>
</span><span id="__span-53-5"><a id="__codelineno-53-5" name="__codelineno-53-5"></a><span class="w">    </span><span class="s">&quot;fmt&quot;</span>
</span><span id="__span-53-6"><a id="__codelineno-53-6" name="__codelineno-53-6"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/agent&quot;</span>
</span><span id="__span-53-7"><a id="__codelineno-53-7" name="__codelineno-53-7"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/event&quot;</span>
</span><span id="__span-53-8"><a id="__codelineno-53-8" name="__codelineno-53-8"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-53-9"><a id="__codelineno-53-9" name="__codelineno-53-9"></a><span class="p">)</span>
</span><span id="__span-53-10"><a id="__codelineno-53-10" name="__codelineno-53-10"></a>
</span><span id="__span-53-11"><a id="__codelineno-53-11" name="__codelineno-53-11"></a><span class="kd">func</span><span class="w"> </span><span class="nx">runAndReadHits</span><span class="p">(</span><span class="nx">executor</span><span class="w"> </span><span class="o">*</span><span class="nx">graph</span><span class="p">.</span><span class="nx">Executor</span><span class="p">,</span><span class="w"> </span><span class="nx">initial</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-53-12"><a id="__codelineno-53-12" name="__codelineno-53-12"></a><span class="w">    </span><span class="nx">inv</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">agent</span><span class="p">.</span><span class="nx">Invocation</span><span class="p">{</span><span class="nx">InvocationID</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;demo&quot;</span><span class="p">}</span>
</span><span id="__span-53-13"><a id="__codelineno-53-13" name="__codelineno-53-13"></a><span class="w">    </span><span class="nx">ch</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">executor</span><span class="p">.</span><span class="nx">Execute</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Background</span><span class="p">(),</span><span class="w"> </span><span class="nx">initial</span><span class="p">,</span><span class="w"> </span><span class="nx">inv</span><span class="p">)</span>
</span><span id="__span-53-14"><a id="__codelineno-53-14" name="__codelineno-53-14"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-53-15"><a id="__codelineno-53-15" name="__codelineno-53-15"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">e</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">ch</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-53-16"><a id="__codelineno-53-16" name="__codelineno-53-16"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">Response</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">Response</span><span class="p">.</span><span class="nx">Object</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">ObjectTypeGraphNodeComplete</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-53-17"><a id="__codelineno-53-17" name="__codelineno-53-17"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">StateDelta</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-53-18"><a id="__codelineno-53-18" name="__codelineno-53-18"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">StateDelta</span><span class="p">[</span><span class="s">&quot;_cache_hit&quot;</span><span class="p">];</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-53-19"><a id="__codelineno-53-19" name="__codelineno-53-19"></a><span class="w">                    </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;cache hit: skipped node function&quot;</span><span class="p">)</span>
</span><span id="__span-53-20"><a id="__codelineno-53-20" name="__codelineno-53-20"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-53-21"><a id="__codelineno-53-21" name="__codelineno-53-21"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-53-22"><a id="__codelineno-53-22" name="__codelineno-53-22"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-53-23"><a id="__codelineno-53-23" name="__codelineno-53-23"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">Done</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">break</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-53-24"><a id="__codelineno-53-24" name="__codelineno-53-24"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-53-25"><a id="__codelineno-53-25" name="__codelineno-53-25"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-53-26"><a id="__codelineno-53-26" name="__codelineno-53-26"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>注意事项：</p>
<ul>
<li>仅对“纯函数（相同输入 → 相同输出，无外部副作用）”节点开启缓存，避免语义错误。</li>
<li>TTL（Time To Live）为 0 表示不过期，需防止内存增长；生产建议使用持久化后端（如 Redis/SQLite）与定期清理。</li>
<li>键函数会“净化输入”后再规范化序列化，避免把会话、执行上下文等“易变/不可序列化”值纳入键，提升命中率、避免错误（见 <a href="https://github.com/trpc-group/trpc-agent-go/blob/main/graph/cache_key.go">graph/cache_key.go</a>）。</li>
<li>代码更新后可调用 <code>ClearCache("nodeID")</code> 清理旧缓存，或在键/命名空间中引入“函数标识符/版本”维度。</li>
</ul>
<p>Runner + GraphAgent 环境使用示例：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-54-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-54-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-54-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-54-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-54-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-54-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-54-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-54-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-54-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-54-10">10</a></span>
<span class="normal"><a href="#__codelineno-54-11">11</a></span>
<span class="normal"><a href="#__codelineno-54-12">12</a></span>
<span class="normal"><a href="#__codelineno-54-13">13</a></span>
<span class="normal"><a href="#__codelineno-54-14">14</a></span>
<span class="normal"><a href="#__codelineno-54-15">15</a></span>
<span class="normal"><a href="#__codelineno-54-16">16</a></span>
<span class="normal"><a href="#__codelineno-54-17">17</a></span>
<span class="normal"><a href="#__codelineno-54-18">18</a></span>
<span class="normal"><a href="#__codelineno-54-19">19</a></span>
<span class="normal"><a href="#__codelineno-54-20">20</a></span>
<span class="normal"><a href="#__codelineno-54-21">21</a></span>
<span class="normal"><a href="#__codelineno-54-22">22</a></span>
<span class="normal"><a href="#__codelineno-54-23">23</a></span>
<span class="normal"><a href="#__codelineno-54-24">24</a></span>
<span class="normal"><a href="#__codelineno-54-25">25</a></span>
<span class="normal"><a href="#__codelineno-54-26">26</a></span>
<span class="normal"><a href="#__codelineno-54-27">27</a></span>
<span class="normal"><a href="#__codelineno-54-28">28</a></span>
<span class="normal"><a href="#__codelineno-54-29">29</a></span>
<span class="normal"><a href="#__codelineno-54-30">30</a></span>
<span class="normal"><a href="#__codelineno-54-31">31</a></span>
<span class="normal"><a href="#__codelineno-54-32">32</a></span>
<span class="normal"><a href="#__codelineno-54-33">33</a></span>
<span class="normal"><a href="#__codelineno-54-34">34</a></span>
<span class="normal"><a href="#__codelineno-54-35">35</a></span>
<span class="normal"><a href="#__codelineno-54-36">36</a></span>
<span class="normal"><a href="#__codelineno-54-37">37</a></span>
<span class="normal"><a href="#__codelineno-54-38">38</a></span>
<span class="normal"><a href="#__codelineno-54-39">39</a></span>
<span class="normal"><a href="#__codelineno-54-40">40</a></span>
<span class="normal"><a href="#__codelineno-54-41">41</a></span>
<span class="normal"><a href="#__codelineno-54-42">42</a></span>
<span class="normal"><a href="#__codelineno-54-43">43</a></span>
<span class="normal"><a href="#__codelineno-54-44">44</a></span>
<span class="normal"><a href="#__codelineno-54-45">45</a></span>
<span class="normal"><a href="#__codelineno-54-46">46</a></span>
<span class="normal"><a href="#__codelineno-54-47">47</a></span>
<span class="normal"><a href="#__codelineno-54-48">48</a></span>
<span class="normal"><a href="#__codelineno-54-49">49</a></span>
<span class="normal"><a href="#__codelineno-54-50">50</a></span>
<span class="normal"><a href="#__codelineno-54-51">51</a></span>
<span class="normal"><a href="#__codelineno-54-52">52</a></span>
<span class="normal"><a href="#__codelineno-54-53">53</a></span>
<span class="normal"><a href="#__codelineno-54-54">54</a></span>
<span class="normal"><a href="#__codelineno-54-55">55</a></span>
<span class="normal"><a href="#__codelineno-54-56">56</a></span>
<span class="normal"><a href="#__codelineno-54-57">57</a></span>
<span class="normal"><a href="#__codelineno-54-58">58</a></span>
<span class="normal"><a href="#__codelineno-54-59">59</a></span>
<span class="normal"><a href="#__codelineno-54-60">60</a></span>
<span class="normal"><a href="#__codelineno-54-61">61</a></span>
<span class="normal"><a href="#__codelineno-54-62">62</a></span>
<span class="normal"><a href="#__codelineno-54-63">63</a></span>
<span class="normal"><a href="#__codelineno-54-64">64</a></span>
<span class="normal"><a href="#__codelineno-54-65">65</a></span>
<span class="normal"><a href="#__codelineno-54-66">66</a></span>
<span class="normal"><a href="#__codelineno-54-67">67</a></span>
<span class="normal"><a href="#__codelineno-54-68">68</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-54-1"><a id="__codelineno-54-1" name="__codelineno-54-1"></a><span class="kn">package</span><span class="w"> </span><span class="nx">main</span>
</span><span id="__span-54-2"><a id="__codelineno-54-2" name="__codelineno-54-2"></a>
</span><span id="__span-54-3"><a id="__codelineno-54-3" name="__codelineno-54-3"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-54-4"><a id="__codelineno-54-4" name="__codelineno-54-4"></a><span class="w">    </span><span class="s">&quot;bufio&quot;</span>
</span><span id="__span-54-5"><a id="__codelineno-54-5" name="__codelineno-54-5"></a><span class="w">    </span><span class="s">&quot;context&quot;</span>
</span><span id="__span-54-6"><a id="__codelineno-54-6" name="__codelineno-54-6"></a><span class="w">    </span><span class="s">&quot;flag&quot;</span>
</span><span id="__span-54-7"><a id="__codelineno-54-7" name="__codelineno-54-7"></a><span class="w">    </span><span class="s">&quot;fmt&quot;</span>
</span><span id="__span-54-8"><a id="__codelineno-54-8" name="__codelineno-54-8"></a><span class="w">    </span><span class="s">&quot;os&quot;</span>
</span><span id="__span-54-9"><a id="__codelineno-54-9" name="__codelineno-54-9"></a><span class="w">    </span><span class="s">&quot;strings&quot;</span>
</span><span id="__span-54-10"><a id="__codelineno-54-10" name="__codelineno-54-10"></a><span class="w">    </span><span class="s">&quot;time&quot;</span>
</span><span id="__span-54-11"><a id="__codelineno-54-11" name="__codelineno-54-11"></a>
</span><span id="__span-54-12"><a id="__codelineno-54-12" name="__codelineno-54-12"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/agent&quot;</span>
</span><span id="__span-54-13"><a id="__codelineno-54-13" name="__codelineno-54-13"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/agent/graphagent&quot;</span>
</span><span id="__span-54-14"><a id="__codelineno-54-14" name="__codelineno-54-14"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-54-15"><a id="__codelineno-54-15" name="__codelineno-54-15"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/model&quot;</span>
</span><span id="__span-54-16"><a id="__codelineno-54-16" name="__codelineno-54-16"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/runner&quot;</span>
</span><span id="__span-54-17"><a id="__codelineno-54-17" name="__codelineno-54-17"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/session/inmemory&quot;</span>
</span><span id="__span-54-18"><a id="__codelineno-54-18" name="__codelineno-54-18"></a><span class="p">)</span>
</span><span id="__span-54-19"><a id="__codelineno-54-19" name="__codelineno-54-19"></a>
</span><span id="__span-54-20"><a id="__codelineno-54-20" name="__codelineno-54-20"></a><span class="kd">func</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-54-21"><a id="__codelineno-54-21" name="__codelineno-54-21"></a><span class="w">    </span><span class="nx">ttl</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">flag</span><span class="p">.</span><span class="nx">Duration</span><span class="p">(</span><span class="s">&quot;ttl&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;cache ttl&quot;</span><span class="p">)</span>
</span><span id="__span-54-22"><a id="__codelineno-54-22" name="__codelineno-54-22"></a><span class="w">    </span><span class="nx">flag</span><span class="p">.</span><span class="nx">Parse</span><span class="p">()</span>
</span><span id="__span-54-23"><a id="__codelineno-54-23" name="__codelineno-54-23"></a>
</span><span id="__span-54-24"><a id="__codelineno-54-24" name="__codelineno-54-24"></a><span class="w">    </span><span class="c1">// Build graph with cache</span>
</span><span id="__span-54-25"><a id="__codelineno-54-25" name="__codelineno-54-25"></a><span class="w">    </span><span class="nx">schema</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateSchema</span><span class="p">()</span>
</span><span id="__span-54-26"><a id="__codelineno-54-26" name="__codelineno-54-26"></a><span class="w">    </span><span class="nx">sg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateGraph</span><span class="p">(</span><span class="nx">schema</span><span class="p">).</span>
</span><span id="__span-54-27"><a id="__codelineno-54-27" name="__codelineno-54-27"></a><span class="w">        </span><span class="nx">WithCache</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewInMemoryCache</span><span class="p">()).</span>
</span><span id="__span-54-28"><a id="__codelineno-54-28" name="__codelineno-54-28"></a><span class="w">        </span><span class="nx">WithCachePolicy</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">DefaultCachePolicy</span><span class="p">())</span>
</span><span id="__span-54-29"><a id="__codelineno-54-29" name="__codelineno-54-29"></a>
</span><span id="__span-54-30"><a id="__codelineno-54-30" name="__codelineno-54-30"></a><span class="w">    </span><span class="nx">compute</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-54-31"><a id="__codelineno-54-31" name="__codelineno-54-31"></a><span class="w">        </span><span class="nx">n</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">s</span><span class="p">[</span><span class="s">&quot;n&quot;</span><span class="p">].(</span><span class="kt">int</span><span class="p">)</span>
</span><span id="__span-54-32"><a id="__codelineno-54-32" name="__codelineno-54-32"></a><span class="w">        </span><span class="nx">time</span><span class="p">.</span><span class="nx">Sleep</span><span class="p">(</span><span class="mi">200</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span><span class="p">)</span>
</span><span id="__span-54-33"><a id="__codelineno-54-33" name="__codelineno-54-33"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="s">&quot;out&quot;</span><span class="p">:</span><span class="w"> </span><span class="nx">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-54-34"><a id="__codelineno-54-34" name="__codelineno-54-34"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-54-35"><a id="__codelineno-54-35" name="__codelineno-54-35"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;compute&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">compute</span><span class="p">,</span>
</span><span id="__span-54-36"><a id="__codelineno-54-36" name="__codelineno-54-36"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithNodeCachePolicy</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">graph</span><span class="p">.</span><span class="nx">CachePolicy</span><span class="p">{</span><span class="nx">KeyFunc</span><span class="p">:</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">DefaultCachePolicy</span><span class="p">().</span><span class="nx">KeyFunc</span><span class="p">,</span><span class="w"> </span><span class="nx">TTL</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="nx">ttl</span><span class="p">}),</span>
</span><span id="__span-54-37"><a id="__codelineno-54-37" name="__codelineno-54-37"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithCacheKeyFields</span><span class="p">(</span><span class="s">&quot;n&quot;</span><span class="p">),</span>
</span><span id="__span-54-38"><a id="__codelineno-54-38" name="__codelineno-54-38"></a><span class="w">    </span><span class="p">).</span>
</span><span id="__span-54-39"><a id="__codelineno-54-39" name="__codelineno-54-39"></a><span class="w">        </span><span class="nx">SetEntryPoint</span><span class="p">(</span><span class="s">&quot;compute&quot;</span><span class="p">).</span>
</span><span id="__span-54-40"><a id="__codelineno-54-40" name="__codelineno-54-40"></a><span class="w">        </span><span class="nx">SetFinishPoint</span><span class="p">(</span><span class="s">&quot;compute&quot;</span><span class="p">)</span>
</span><span id="__span-54-41"><a id="__codelineno-54-41" name="__codelineno-54-41"></a><span class="w">    </span><span class="nx">g</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">sg</span><span class="p">.</span><span class="nx">Compile</span><span class="p">()</span>
</span><span id="__span-54-42"><a id="__codelineno-54-42" name="__codelineno-54-42"></a>
</span><span id="__span-54-43"><a id="__codelineno-54-43" name="__codelineno-54-43"></a><span class="w">    </span><span class="c1">// GraphAgent + Runner</span>
</span><span id="__span-54-44"><a id="__codelineno-54-44" name="__codelineno-54-44"></a><span class="w">    </span><span class="nx">ga</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;cache-demo&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">g</span><span class="p">,</span><span class="w"> </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithInitialState</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{}))</span>
</span><span id="__span-54-45"><a id="__codelineno-54-45" name="__codelineno-54-45"></a><span class="w">    </span><span class="nx">app</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">runner</span><span class="p">.</span><span class="nx">NewRunner</span><span class="p">(</span><span class="s">&quot;app&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">ga</span><span class="p">,</span><span class="w"> </span><span class="nx">runner</span><span class="p">.</span><span class="nx">WithSessionService</span><span class="p">(</span><span class="nx">inmemory</span><span class="p">.</span><span class="nx">NewSessionService</span><span class="p">()))</span>
</span><span id="__span-54-46"><a id="__codelineno-54-46" name="__codelineno-54-46"></a>
</span><span id="__span-54-47"><a id="__codelineno-54-47" name="__codelineno-54-47"></a><span class="w">    </span><span class="c1">// Interactive</span>
</span><span id="__span-54-48"><a id="__codelineno-54-48" name="__codelineno-54-48"></a><span class="w">    </span><span class="nx">sc</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">bufio</span><span class="p">.</span><span class="nx">NewScanner</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Stdin</span><span class="p">)</span>
</span><span id="__span-54-49"><a id="__codelineno-54-49" name="__codelineno-54-49"></a><span class="w">    </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Enter integers; repeated inputs should hit cache. type &#39;exit&#39; to quit&quot;</span><span class="p">)</span>
</span><span id="__span-54-50"><a id="__codelineno-54-50" name="__codelineno-54-50"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-54-51"><a id="__codelineno-54-51" name="__codelineno-54-51"></a><span class="w">        </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Print</span><span class="p">(</span><span class="s">&quot;&gt; &quot;</span><span class="p">)</span>
</span><span id="__span-54-52"><a id="__codelineno-54-52" name="__codelineno-54-52"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">!</span><span class="nx">sc</span><span class="p">.</span><span class="nx">Scan</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">break</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-54-53"><a id="__codelineno-54-53" name="__codelineno-54-53"></a><span class="w">        </span><span class="nx">txt</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">strings</span><span class="p">.</span><span class="nx">TrimSpace</span><span class="p">(</span><span class="nx">sc</span><span class="p">.</span><span class="nx">Text</span><span class="p">())</span>
</span><span id="__span-54-54"><a id="__codelineno-54-54" name="__codelineno-54-54"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">txt</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;exit&quot;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">break</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-54-55"><a id="__codelineno-54-55" name="__codelineno-54-55"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">txt</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">continue</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-54-56"><a id="__codelineno-54-56" name="__codelineno-54-56"></a><span class="w">        </span><span class="nx">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">model</span><span class="p">.</span><span class="nx">NewUserMessage</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;compute %s&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">txt</span><span class="p">))</span>
</span><span id="__span-54-57"><a id="__codelineno-54-57" name="__codelineno-54-57"></a><span class="w">        </span><span class="nx">evts</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">app</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Background</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;user&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;s-%d&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">().</span><span class="nx">UnixNano</span><span class="p">()),</span><span class="w"> </span><span class="nx">msg</span><span class="p">,</span><span class="w"> </span><span class="nx">agent</span><span class="p">.</span><span class="nx">WithRuntimeState</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="s">&quot;n&quot;</span><span class="p">:</span><span class="w"> </span><span class="nx">atoi</span><span class="p">(</span><span class="nx">txt</span><span class="p">)}))</span>
</span><span id="__span-54-58"><a id="__codelineno-54-58" name="__codelineno-54-58"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;run error:&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">);</span><span class="w"> </span><span class="k">continue</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-54-59"><a id="__codelineno-54-59" name="__codelineno-54-59"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="nx">e</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">evts</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-54-60"><a id="__codelineno-54-60" name="__codelineno-54-60"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">Response</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">Response</span><span class="p">.</span><span class="nx">Object</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">ObjectTypeGraphNodeComplete</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-54-61"><a id="__codelineno-54-61" name="__codelineno-54-61"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">StateDelta</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">StateDelta</span><span class="p">[</span><span class="s">&quot;_cache_hit&quot;</span><span class="p">];</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;cache hit&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-54-62"><a id="__codelineno-54-62" name="__codelineno-54-62"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-54-63"><a id="__codelineno-54-63" name="__codelineno-54-63"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">Done</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">break</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-54-64"><a id="__codelineno-54-64" name="__codelineno-54-64"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-54-65"><a id="__codelineno-54-65" name="__codelineno-54-65"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-54-66"><a id="__codelineno-54-66" name="__codelineno-54-66"></a><span class="p">}</span>
</span><span id="__span-54-67"><a id="__codelineno-54-67" name="__codelineno-54-67"></a>
</span><span id="__span-54-68"><a id="__codelineno-54-68" name="__codelineno-54-68"></a><span class="kd">func</span><span class="w"> </span><span class="nx">atoi</span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="nx">n</span><span class="w"> </span><span class="kt">int</span><span class="p">;</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sscanf</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%d&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">n</span><span class="p">);</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">n</span><span class="w"> </span><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>示例：</p>
<ul>
<li>交互式（Interactive）+ Runner + GraphAgent 演示：<code>examples/graph/nodecache</code>，入口 <a href="https://github.com/trpc-group/trpc-agent-go/blob/main/examples/graph/nodecache/main.go">examples/graph/nodecache/main.go</a></li>
</ul>
<h4 id="tools">Tools 节点</h4>
<p>执行工具调用，注意是<strong>顺序执行</strong>：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-55-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-55-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-55-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-55-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-55-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-55-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-55-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-55-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-55-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-55-10">10</a></span>
<span class="normal"><a href="#__codelineno-55-11">11</a></span>
<span class="normal"><a href="#__codelineno-55-12">12</a></span>
<span class="normal"><a href="#__codelineno-55-13">13</a></span>
<span class="normal"><a href="#__codelineno-55-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-55-1"><a id="__codelineno-55-1" name="__codelineno-55-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-55-2"><a id="__codelineno-55-2" name="__codelineno-55-2"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-55-3"><a id="__codelineno-55-3" name="__codelineno-55-3"></a><span class="p">)</span>
</span><span id="__span-55-4"><a id="__codelineno-55-4" name="__codelineno-55-4"></a>
</span><span id="__span-55-5"><a id="__codelineno-55-5" name="__codelineno-55-5"></a><span class="kd">const</span><span class="w"> </span><span class="nx">nodeTools</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;tools&quot;</span>
</span><span id="__span-55-6"><a id="__codelineno-55-6" name="__codelineno-55-6"></a>
</span><span id="__span-55-7"><a id="__codelineno-55-7" name="__codelineno-55-7"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddToolsNode</span><span class="p">(</span><span class="nx">nodeTools</span><span class="p">,</span><span class="w"> </span><span class="nx">tools</span><span class="p">)</span>
</span><span id="__span-55-8"><a id="__codelineno-55-8" name="__codelineno-55-8"></a><span class="c1">// 多个工具会按 LLM 返回的顺序依次执行</span>
</span><span id="__span-55-9"><a id="__codelineno-55-9" name="__codelineno-55-9"></a><span class="c1">// 如需并行，应该使用多个节点 + 并行边</span>
</span><span id="__span-55-10"><a id="__codelineno-55-10" name="__codelineno-55-10"></a><span class="c1">// 配对规则：从 messages 尾部回溯定位最近的 assistant(tool_calls)</span>
</span><span id="__span-55-11"><a id="__codelineno-55-11" name="__codelineno-55-11"></a><span class="c1">// 消息，遇到新的 user 即停止，确保与本轮工具调用配对。</span>
</span><span id="__span-55-12"><a id="__codelineno-55-12" name="__codelineno-55-12"></a><span class="c1">// 输出：追加工具消息到 graph.StateKeyMessages，设置</span>
</span><span id="__span-55-13"><a id="__codelineno-55-13" name="__codelineno-55-13"></a><span class="c1">// graph.StateKeyLastToolResponse，并将</span>
</span><span id="__span-55-14"><a id="__codelineno-55-14" name="__codelineno-55-14"></a><span class="c1">// graph.StateKeyNodeResponses[nodeTools] 写为 JSON 数组字符串。</span>
</span></code></pre></div></td></tr></table></div>
<h4 id="state">将工具结果写入 State</h4>
<p>Tools 节点已直接暴露输出：</p>
<ul>
<li><code>graph.StateKeyLastToolResponse</code>：本次节点执行中最后一个工具输出的 JSON 字符串</li>
<li><code>graph.StateKeyNodeResponses[&lt;tools_node_id&gt;]</code>：本次节点执行的所有工具输出（JSON 数组字符串）</li>
</ul>
<p>在 Tools 节点之后，添加一个函数节点，从 <code>graph.StateKeyMessages</code> 汇总工具结果并写入结构化 State：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-56-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-56-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-56-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-56-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-56-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-56-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-56-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-56-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-56-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-56-10">10</a></span>
<span class="normal"><a href="#__codelineno-56-11">11</a></span>
<span class="normal"><a href="#__codelineno-56-12">12</a></span>
<span class="normal"><a href="#__codelineno-56-13">13</a></span>
<span class="normal"><a href="#__codelineno-56-14">14</a></span>
<span class="normal"><a href="#__codelineno-56-15">15</a></span>
<span class="normal"><a href="#__codelineno-56-16">16</a></span>
<span class="normal"><a href="#__codelineno-56-17">17</a></span>
<span class="normal"><a href="#__codelineno-56-18">18</a></span>
<span class="normal"><a href="#__codelineno-56-19">19</a></span>
<span class="normal"><a href="#__codelineno-56-20">20</a></span>
<span class="normal"><a href="#__codelineno-56-21">21</a></span>
<span class="normal"><a href="#__codelineno-56-22">22</a></span>
<span class="normal"><a href="#__codelineno-56-23">23</a></span>
<span class="normal"><a href="#__codelineno-56-24">24</a></span>
<span class="normal"><a href="#__codelineno-56-25">25</a></span>
<span class="normal"><a href="#__codelineno-56-26">26</a></span>
<span class="normal"><a href="#__codelineno-56-27">27</a></span>
<span class="normal"><a href="#__codelineno-56-28">28</a></span>
<span class="normal"><a href="#__codelineno-56-29">29</a></span>
<span class="normal"><a href="#__codelineno-56-30">30</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-56-1"><a id="__codelineno-56-1" name="__codelineno-56-1"></a><span class="kd">const</span><span class="w"> </span><span class="nx">stateKeyToolResults</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;tool_results&quot;</span>
</span><span id="__span-56-2"><a id="__codelineno-56-2" name="__codelineno-56-2"></a>
</span><span id="__span-56-3"><a id="__codelineno-56-3" name="__codelineno-56-3"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;collect_tool_results&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-56-4"><a id="__codelineno-56-4" name="__codelineno-56-4"></a><span class="w">    </span><span class="nx">msgs</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">s</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyMessages</span><span class="p">].([]</span><span class="nx">model</span><span class="p">.</span><span class="nx">Message</span><span class="p">)</span>
</span><span id="__span-56-5"><a id="__codelineno-56-5" name="__codelineno-56-5"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">msgs</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-56-6"><a id="__codelineno-56-6" name="__codelineno-56-6"></a>
</span><span id="__span-56-7"><a id="__codelineno-56-7" name="__codelineno-56-7"></a><span class="w">    </span><span class="c1">// 定位本轮 assistant(tool_calls)</span>
</span><span id="__span-56-8"><a id="__codelineno-56-8" name="__codelineno-56-8"></a><span class="w">    </span><span class="nx">i</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">msgs</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-56-9"><a id="__codelineno-56-9" name="__codelineno-56-9"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">!(</span><span class="nx">msgs</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">Role</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">model</span><span class="p">.</span><span class="nx">RoleAssistant</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">msgs</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">ToolCalls</span><span class="p">)</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-56-10"><a id="__codelineno-56-10" name="__codelineno-56-10"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">msgs</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">Role</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">model</span><span class="p">.</span><span class="nx">RoleUser</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// 新一轮，停止</span>
</span><span id="__span-56-11"><a id="__codelineno-56-11" name="__codelineno-56-11"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-56-12"><a id="__codelineno-56-12" name="__codelineno-56-12"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-56-13"><a id="__codelineno-56-13" name="__codelineno-56-13"></a><span class="w">        </span><span class="nx">i</span><span class="o">--</span>
</span><span id="__span-56-14"><a id="__codelineno-56-14" name="__codelineno-56-14"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-56-15"><a id="__codelineno-56-15" name="__codelineno-56-15"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-56-16"><a id="__codelineno-56-16" name="__codelineno-56-16"></a>
</span><span id="__span-56-17"><a id="__codelineno-56-17" name="__codelineno-56-17"></a><span class="w">    </span><span class="c1">// 收集匹配的工具回复（按 ToolID 配对）</span>
</span><span id="__span-56-18"><a id="__codelineno-56-18" name="__codelineno-56-18"></a><span class="w">    </span><span class="nx">idset</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">bool</span><span class="p">{}</span>
</span><span id="__span-56-19"><a id="__codelineno-56-19" name="__codelineno-56-19"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">tc</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">msgs</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">ToolCalls</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">idset</span><span class="p">[</span><span class="nx">tc</span><span class="p">.</span><span class="nx">ID</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-56-20"><a id="__codelineno-56-20" name="__codelineno-56-20"></a><span class="w">    </span><span class="nx">results</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{}</span>
</span><span id="__span-56-21"><a id="__codelineno-56-21" name="__codelineno-56-21"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">j</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="nx">j</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">msgs</span><span class="p">);</span><span class="w"> </span><span class="nx">j</span><span class="o">++</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-56-22"><a id="__codelineno-56-22" name="__codelineno-56-22"></a><span class="w">        </span><span class="nx">m</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">msgs</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span>
</span><span id="__span-56-23"><a id="__codelineno-56-23" name="__codelineno-56-23"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">m</span><span class="p">.</span><span class="nx">Role</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">model</span><span class="p">.</span><span class="nx">RoleTool</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">idset</span><span class="p">[</span><span class="nx">m</span><span class="p">.</span><span class="nx">ToolID</span><span class="p">]</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-56-24"><a id="__codelineno-56-24" name="__codelineno-56-24"></a><span class="w">            </span><span class="nx">results</span><span class="p">[</span><span class="nx">m</span><span class="p">.</span><span class="nx">ToolName</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">m</span><span class="p">.</span><span class="nx">Content</span><span class="w"> </span><span class="c1">// 内容可能为 JSON/文本，依工具定义决定</span>
</span><span id="__span-56-25"><a id="__codelineno-56-25" name="__codelineno-56-25"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-56-26"><a id="__codelineno-56-26" name="__codelineno-56-26"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">m</span><span class="p">.</span><span class="nx">Role</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">model</span><span class="p">.</span><span class="nx">RoleUser</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">break</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-56-27"><a id="__codelineno-56-27" name="__codelineno-56-27"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-56-28"><a id="__codelineno-56-28" name="__codelineno-56-28"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">results</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-56-29"><a id="__codelineno-56-29" name="__codelineno-56-29"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="nx">stateKeyToolResults</span><span class="p">:</span><span class="w"> </span><span class="nx">results</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-56-30"><a id="__codelineno-56-30" name="__codelineno-56-30"></a><span class="p">})</span>
</span></code></pre></div></td></tr></table></div>
<p>参考示例：<code>examples/graph/io_conventions_tools</code>。</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-57-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-57-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-57-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-57-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-57-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-57-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-57-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-57-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-57-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-57-10">10</a></span>
<span class="normal"><a href="#__codelineno-57-11">11</a></span>
<span class="normal"><a href="#__codelineno-57-12">12</a></span>
<span class="normal"><a href="#__codelineno-57-13">13</a></span>
<span class="normal"><a href="#__codelineno-57-14">14</a></span>
<span class="normal"><a href="#__codelineno-57-15">15</a></span>
<span class="normal"><a href="#__codelineno-57-16">16</a></span>
<span class="normal"><a href="#__codelineno-57-17">17</a></span>
<span class="normal"><a href="#__codelineno-57-18">18</a></span>
<span class="normal"><a href="#__codelineno-57-19">19</a></span>
<span class="normal"><a href="#__codelineno-57-20">20</a></span>
<span class="normal"><a href="#__codelineno-57-21">21</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-57-1"><a id="__codelineno-57-1" name="__codelineno-57-1"></a>#### Agent 节点
</span><span id="__span-57-2"><a id="__codelineno-57-2" name="__codelineno-57-2"></a>嵌入子 Agent，实现多 Agent 协作：
</span><span id="__span-57-3"><a id="__codelineno-57-3" name="__codelineno-57-3"></a>
</span><span id="__span-57-4"><a id="__codelineno-57-4" name="__codelineno-57-4"></a>```go
</span><span id="__span-57-5"><a id="__codelineno-57-5" name="__codelineno-57-5"></a>import (
</span><span id="__span-57-6"><a id="__codelineno-57-6" name="__codelineno-57-6"></a>    &quot;trpc.group/trpc-go/trpc-agent-go/agent&quot;
</span><span id="__span-57-7"><a id="__codelineno-57-7" name="__codelineno-57-7"></a>    &quot;trpc.group/trpc-go/trpc-agent-go/agent/graphagent&quot;
</span><span id="__span-57-8"><a id="__codelineno-57-8" name="__codelineno-57-8"></a>)
</span><span id="__span-57-9"><a id="__codelineno-57-9" name="__codelineno-57-9"></a>
</span><span id="__span-57-10"><a id="__codelineno-57-10" name="__codelineno-57-10"></a>const (
</span><span id="__span-57-11"><a id="__codelineno-57-11" name="__codelineno-57-11"></a>    subAgentNameAnalyzer = &quot;analyzer&quot;
</span><span id="__span-57-12"><a id="__codelineno-57-12" name="__codelineno-57-12"></a>    graphAgentNameMain   = &quot;main&quot;
</span><span id="__span-57-13"><a id="__codelineno-57-13" name="__codelineno-57-13"></a>)
</span><span id="__span-57-14"><a id="__codelineno-57-14" name="__codelineno-57-14"></a>
</span><span id="__span-57-15"><a id="__codelineno-57-15" name="__codelineno-57-15"></a>// 重要：节点 ID 必须与子 Agent 名称一致
</span><span id="__span-57-16"><a id="__codelineno-57-16" name="__codelineno-57-16"></a>sg.AddAgentNode(subAgentNameAnalyzer)
</span><span id="__span-57-17"><a id="__codelineno-57-17" name="__codelineno-57-17"></a>
</span><span id="__span-57-18"><a id="__codelineno-57-18" name="__codelineno-57-18"></a>// Agent 实例在 GraphAgent 创建时注入
</span><span id="__span-57-19"><a id="__codelineno-57-19" name="__codelineno-57-19"></a>analyzer := createAnalyzer()  // 内部 Agent 名称必须是 &quot;analyzer&quot;
</span><span id="__span-57-20"><a id="__codelineno-57-20" name="__codelineno-57-20"></a>graphAgent, _ := graphagent.New(graphAgentNameMain, g,
</span><span id="__span-57-21"><a id="__codelineno-57-21" name="__codelineno-57-21"></a>    graphagent.WithSubAgents([]agent.Agent{analyzer}))
</span></code></pre></div></td></tr></table></div>
<h3 id="_18">边与路由</h3>
<p>边定义了节点间的执行流转：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-58-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-58-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-58-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-58-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-58-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-58-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-58-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-58-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-58-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-58-10">10</a></span>
<span class="normal"><a href="#__codelineno-58-11">11</a></span>
<span class="normal"><a href="#__codelineno-58-12">12</a></span>
<span class="normal"><a href="#__codelineno-58-13">13</a></span>
<span class="normal"><a href="#__codelineno-58-14">14</a></span>
<span class="normal"><a href="#__codelineno-58-15">15</a></span>
<span class="normal"><a href="#__codelineno-58-16">16</a></span>
<span class="normal"><a href="#__codelineno-58-17">17</a></span>
<span class="normal"><a href="#__codelineno-58-18">18</a></span>
<span class="normal"><a href="#__codelineno-58-19">19</a></span>
<span class="normal"><a href="#__codelineno-58-20">20</a></span>
<span class="normal"><a href="#__codelineno-58-21">21</a></span>
<span class="normal"><a href="#__codelineno-58-22">22</a></span>
<span class="normal"><a href="#__codelineno-58-23">23</a></span>
<span class="normal"><a href="#__codelineno-58-24">24</a></span>
<span class="normal"><a href="#__codelineno-58-25">25</a></span>
<span class="normal"><a href="#__codelineno-58-26">26</a></span>
<span class="normal"><a href="#__codelineno-58-27">27</a></span>
<span class="normal"><a href="#__codelineno-58-28">28</a></span>
<span class="normal"><a href="#__codelineno-58-29">29</a></span>
<span class="normal"><a href="#__codelineno-58-30">30</a></span>
<span class="normal"><a href="#__codelineno-58-31">31</a></span>
<span class="normal"><a href="#__codelineno-58-32">32</a></span>
<span class="normal"><a href="#__codelineno-58-33">33</a></span>
<span class="normal"><a href="#__codelineno-58-34">34</a></span>
<span class="normal"><a href="#__codelineno-58-35">35</a></span>
<span class="normal"><a href="#__codelineno-58-36">36</a></span>
<span class="normal"><a href="#__codelineno-58-37">37</a></span>
<span class="normal"><a href="#__codelineno-58-38">38</a></span>
<span class="normal"><a href="#__codelineno-58-39">39</a></span>
<span class="normal"><a href="#__codelineno-58-40">40</a></span>
<span class="normal"><a href="#__codelineno-58-41">41</a></span>
<span class="normal"><a href="#__codelineno-58-42">42</a></span>
<span class="normal"><a href="#__codelineno-58-43">43</a></span>
<span class="normal"><a href="#__codelineno-58-44">44</a></span>
<span class="normal"><a href="#__codelineno-58-45">45</a></span>
<span class="normal"><a href="#__codelineno-58-46">46</a></span>
<span class="normal"><a href="#__codelineno-58-47">47</a></span>
<span class="normal"><a href="#__codelineno-58-48">48</a></span>
<span class="normal"><a href="#__codelineno-58-49">49</a></span>
<span class="normal"><a href="#__codelineno-58-50">50</a></span>
<span class="normal"><a href="#__codelineno-58-51">51</a></span>
<span class="normal"><a href="#__codelineno-58-52">52</a></span>
<span class="normal"><a href="#__codelineno-58-53">53</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-58-1"><a id="__codelineno-58-1" name="__codelineno-58-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-58-2"><a id="__codelineno-58-2" name="__codelineno-58-2"></a><span class="w">    </span><span class="s">&quot;context&quot;</span>
</span><span id="__span-58-3"><a id="__codelineno-58-3" name="__codelineno-58-3"></a>
</span><span id="__span-58-4"><a id="__codelineno-58-4" name="__codelineno-58-4"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-58-5"><a id="__codelineno-58-5" name="__codelineno-58-5"></a><span class="p">)</span>
</span><span id="__span-58-6"><a id="__codelineno-58-6" name="__codelineno-58-6"></a>
</span><span id="__span-58-7"><a id="__codelineno-58-7" name="__codelineno-58-7"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-58-8"><a id="__codelineno-58-8" name="__codelineno-58-8"></a><span class="w">    </span><span class="nx">nodeA</span><span class="w">         </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;nodeA&quot;</span>
</span><span id="__span-58-9"><a id="__codelineno-58-9" name="__codelineno-58-9"></a><span class="w">    </span><span class="nx">nodeB</span><span class="w">         </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;nodeB&quot;</span>
</span><span id="__span-58-10"><a id="__codelineno-58-10" name="__codelineno-58-10"></a><span class="w">    </span><span class="nx">nodeDecision</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;decision&quot;</span>
</span><span id="__span-58-11"><a id="__codelineno-58-11" name="__codelineno-58-11"></a><span class="w">    </span><span class="nx">nodePathA</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;pathA&quot;</span>
</span><span id="__span-58-12"><a id="__codelineno-58-12" name="__codelineno-58-12"></a><span class="w">    </span><span class="nx">nodePathB</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;pathB&quot;</span>
</span><span id="__span-58-13"><a id="__codelineno-58-13" name="__codelineno-58-13"></a>
</span><span id="__span-58-14"><a id="__codelineno-58-14" name="__codelineno-58-14"></a><span class="w">    </span><span class="nx">routeToPathA</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;route_to_pathA&quot;</span>
</span><span id="__span-58-15"><a id="__codelineno-58-15" name="__codelineno-58-15"></a><span class="w">    </span><span class="nx">routeToPathB</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;route_to_pathB&quot;</span>
</span><span id="__span-58-16"><a id="__codelineno-58-16" name="__codelineno-58-16"></a><span class="w">    </span><span class="nx">stateKeyFlag</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;flag&quot;</span>
</span><span id="__span-58-17"><a id="__codelineno-58-17" name="__codelineno-58-17"></a><span class="p">)</span>
</span><span id="__span-58-18"><a id="__codelineno-58-18" name="__codelineno-58-18"></a>
</span><span id="__span-58-19"><a id="__codelineno-58-19" name="__codelineno-58-19"></a><span class="c1">// 普通边：顺序执行</span>
</span><span id="__span-58-20"><a id="__codelineno-58-20" name="__codelineno-58-20"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddEdge</span><span class="p">(</span><span class="nx">nodeA</span><span class="p">,</span><span class="w"> </span><span class="nx">nodeB</span><span class="p">)</span>
</span><span id="__span-58-21"><a id="__codelineno-58-21" name="__codelineno-58-21"></a>
</span><span id="__span-58-22"><a id="__codelineno-58-22" name="__codelineno-58-22"></a><span class="c1">// 条件边：动态路由（第三个参数为路径映射，建议显式提供以做静态校验）</span>
</span><span id="__span-58-23"><a id="__codelineno-58-23" name="__codelineno-58-23"></a><span class="c1">// 先定义目标节点</span>
</span><span id="__span-58-24"><a id="__codelineno-58-24" name="__codelineno-58-24"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="nx">nodePathA</span><span class="p">,</span><span class="w"> </span><span class="nx">handlerA</span><span class="p">)</span>
</span><span id="__span-58-25"><a id="__codelineno-58-25" name="__codelineno-58-25"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="nx">nodePathB</span><span class="p">,</span><span class="w"> </span><span class="nx">handlerB</span><span class="p">)</span>
</span><span id="__span-58-26"><a id="__codelineno-58-26" name="__codelineno-58-26"></a><span class="c1">// 再添加条件路由</span>
</span><span id="__span-58-27"><a id="__codelineno-58-27" name="__codelineno-58-27"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddConditionalEdges</span><span class="p">(</span><span class="nx">nodeDecision</span><span class="p">,</span>
</span><span id="__span-58-28"><a id="__codelineno-58-28" name="__codelineno-58-28"></a><span class="w">    </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-58-29"><a id="__codelineno-58-29" name="__codelineno-58-29"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">s</span><span class="p">[</span><span class="nx">stateKeyFlag</span><span class="p">].(</span><span class="kt">bool</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-58-30"><a id="__codelineno-58-30" name="__codelineno-58-30"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">routeToPathA</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-58-31"><a id="__codelineno-58-31" name="__codelineno-58-31"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-58-32"><a id="__codelineno-58-32" name="__codelineno-58-32"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">routeToPathB</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-58-33"><a id="__codelineno-58-33" name="__codelineno-58-33"></a><span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span>
</span><span id="__span-58-34"><a id="__codelineno-58-34" name="__codelineno-58-34"></a><span class="w">        </span><span class="nx">routeToPathA</span><span class="p">:</span><span class="w"> </span><span class="nx">nodePathA</span><span class="p">,</span>
</span><span id="__span-58-35"><a id="__codelineno-58-35" name="__codelineno-58-35"></a><span class="w">        </span><span class="nx">routeToPathB</span><span class="p">:</span><span class="w"> </span><span class="nx">nodePathB</span><span class="p">,</span>
</span><span id="__span-58-36"><a id="__codelineno-58-36" name="__codelineno-58-36"></a><span class="w">    </span><span class="p">})</span>
</span><span id="__span-58-37"><a id="__codelineno-58-37" name="__codelineno-58-37"></a>
</span><span id="__span-58-38"><a id="__codelineno-58-38" name="__codelineno-58-38"></a><span class="c1">// 工具条件边：处理 LLM 工具调用</span>
</span><span id="__span-58-39"><a id="__codelineno-58-39" name="__codelineno-58-39"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-58-40"><a id="__codelineno-58-40" name="__codelineno-58-40"></a><span class="w">    </span><span class="nx">nodeLLM</span><span class="w">      </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;llm&quot;</span>
</span><span id="__span-58-41"><a id="__codelineno-58-41" name="__codelineno-58-41"></a><span class="w">    </span><span class="nx">nodeToolsUse</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;tools&quot;</span>
</span><span id="__span-58-42"><a id="__codelineno-58-42" name="__codelineno-58-42"></a><span class="w">    </span><span class="nx">nodeFallback</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;fallback&quot;</span>
</span><span id="__span-58-43"><a id="__codelineno-58-43" name="__codelineno-58-43"></a><span class="p">)</span>
</span><span id="__span-58-44"><a id="__codelineno-58-44" name="__codelineno-58-44"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddToolsConditionalEdges</span><span class="p">(</span><span class="nx">nodeLLM</span><span class="p">,</span><span class="w"> </span><span class="nx">nodeToolsUse</span><span class="p">,</span><span class="w"> </span><span class="nx">nodeFallback</span><span class="p">)</span>
</span><span id="__span-58-45"><a id="__codelineno-58-45" name="__codelineno-58-45"></a>
</span><span id="__span-58-46"><a id="__codelineno-58-46" name="__codelineno-58-46"></a><span class="c1">// 并行边：自动并行执行</span>
</span><span id="__span-58-47"><a id="__codelineno-58-47" name="__codelineno-58-47"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-58-48"><a id="__codelineno-58-48" name="__codelineno-58-48"></a><span class="w">    </span><span class="nx">nodeSplit</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;split&quot;</span>
</span><span id="__span-58-49"><a id="__codelineno-58-49" name="__codelineno-58-49"></a><span class="w">    </span><span class="nx">nodeBranch1</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;branch1&quot;</span>
</span><span id="__span-58-50"><a id="__codelineno-58-50" name="__codelineno-58-50"></a><span class="w">    </span><span class="nx">nodeBranch2</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;branch2&quot;</span>
</span><span id="__span-58-51"><a id="__codelineno-58-51" name="__codelineno-58-51"></a><span class="p">)</span>
</span><span id="__span-58-52"><a id="__codelineno-58-52" name="__codelineno-58-52"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddEdge</span><span class="p">(</span><span class="nx">nodeSplit</span><span class="p">,</span><span class="w"> </span><span class="nx">nodeBranch1</span><span class="p">)</span>
</span><span id="__span-58-53"><a id="__codelineno-58-53" name="__codelineno-58-53"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddEdge</span><span class="p">(</span><span class="nx">nodeSplit</span><span class="p">,</span><span class="w"> </span><span class="nx">nodeBranch2</span><span class="p">)</span><span class="w">  </span><span class="c1">// branch1 和 branch2 会并行执行</span>
</span></code></pre></div></td></tr></table></div>
<h4 id="join">Join（等待所有分支的汇聚）</h4>
<p>当一个节点有多个并行上游分支时，普通 <code>AddEdge(from, to)</code> 的语义是：只要任意
一个上游节点更新了对应的边通道（Channel），<code>to</code> 就会被触发。这很适合增量/
流式场景，但也意味着 <code>to</code> 可能会执行多次。</p>
<p>如果你需要经典的 “等待所有分支都完成后再执行下游节点” 的 fan-in（汇聚）
语义，可以使用 <code>AddJoinEdge</code>：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-59-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-59-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-59-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-59-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-59-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-59-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-59-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-59-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-59-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-59-10">10</a></span>
<span class="normal"><a href="#__codelineno-59-11">11</a></span>
<span class="normal"><a href="#__codelineno-59-12">12</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-59-1"><a id="__codelineno-59-1" name="__codelineno-59-1"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-59-2"><a id="__codelineno-59-2" name="__codelineno-59-2"></a><span class="w">    </span><span class="nx">nodeSplit</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;split&quot;</span>
</span><span id="__span-59-3"><a id="__codelineno-59-3" name="__codelineno-59-3"></a><span class="w">    </span><span class="nx">nodeA</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;branch_a&quot;</span>
</span><span id="__span-59-4"><a id="__codelineno-59-4" name="__codelineno-59-4"></a><span class="w">    </span><span class="nx">nodeB</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;branch_b&quot;</span>
</span><span id="__span-59-5"><a id="__codelineno-59-5" name="__codelineno-59-5"></a><span class="w">    </span><span class="nx">nodeJoin</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;join&quot;</span>
</span><span id="__span-59-6"><a id="__codelineno-59-6" name="__codelineno-59-6"></a><span class="p">)</span>
</span><span id="__span-59-7"><a id="__codelineno-59-7" name="__codelineno-59-7"></a>
</span><span id="__span-59-8"><a id="__codelineno-59-8" name="__codelineno-59-8"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddEdge</span><span class="p">(</span><span class="nx">nodeSplit</span><span class="p">,</span><span class="w"> </span><span class="nx">nodeA</span><span class="p">)</span>
</span><span id="__span-59-9"><a id="__codelineno-59-9" name="__codelineno-59-9"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddEdge</span><span class="p">(</span><span class="nx">nodeSplit</span><span class="p">,</span><span class="w"> </span><span class="nx">nodeB</span><span class="p">)</span>
</span><span id="__span-59-10"><a id="__codelineno-59-10" name="__codelineno-59-10"></a>
</span><span id="__span-59-11"><a id="__codelineno-59-11" name="__codelineno-59-11"></a><span class="c1">// 等待 A 和 B 都完成后再执行 join。</span>
</span><span id="__span-59-12"><a id="__codelineno-59-12" name="__codelineno-59-12"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddJoinEdge</span><span class="p">([]</span><span class="kt">string</span><span class="p">{</span><span class="nx">nodeA</span><span class="p">,</span><span class="w"> </span><span class="nx">nodeB</span><span class="p">},</span><span class="w"> </span><span class="nx">nodeJoin</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p><code>AddJoinEdge</code> 会创建一个内部 barrier（屏障）通道，只有当上游节点列表里的每个
节点都“报到”后才触发 <code>to</code>。触发后屏障会重置，因此在循环图里可以再次汇聚。</p>
<p>参考示例：<code>examples/graph/join_edge</code>。</p>
<p>提示：设置入口与结束点时，会隐式连接到虚拟的 Start/End 节点：</p>
<ul>
<li><code>SetEntryPoint("first")</code> 等效于创建 <code>Start -&gt; first</code> 的连边；</li>
<li><code>SetFinishPoint("last")</code> 等效于创建 <code>last -&gt; End</code> 的连边。
  无需显式添加这两条边。</li>
</ul>
<p>常量名：<code>graph.Start == "__start__"</code>，<code>graph.End == "__end__"</code>。</p>
<h3 id="_19">消息可见性选项</h3>
<p>当前Agent可在需要时根据不同场景控制其对其他Agent生成的消息以及历史会话消息的可见性进行管理，可通过相关选项配置进行管理。
在与model交互时仅将可见的内容输入给模型。 </p>
<p>TIPS:
 - 不同sessionID的消息在任何场景下都是互不可见的，以下管控策略均针对同一个sessionID的消息
 - Invocation.Message在任何场景下均可见
 - 相关配置仅控制State[graph.StateKeyMessages]的初始值
 - Agent node生成的消息filterKey为subAgent name, 因此使用<code>IsolatedRequest</code>或<code>IsolatedInvocation</code>过滤时对当前graphAgent不可见
 - 未配置选项时，默认值为FullContext</p>
<p>配置:
- <code>graphagent.WithMessageFilterMode(MessageFilterMode)</code>:
  - <code>FullContext</code>: 所有能通过filterKey做前缀匹配的消息
  - <code>RequestContext</code>: 仅包含当前请求周期内通过filterKey前缀匹配的消息
  - <code>IsolatedRequest</code>: 仅包含当前请求周期内通过filterKey完全匹配的消息
  - <code>IsolatedInvocation</code>: 仅包含当前invocation周期内通过filterKey完全匹配的消息</p>
<p>推荐用法示例（该用法仅基于高阶用法基础之上做了配置简化）: </p>
<p>案例1: 对graphAgent消息可见性控制
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-60-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-60-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-60-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-60-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-60-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-60-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-60-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-60-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-60-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-60-10">10</a></span>
<span class="normal"><a href="#__codelineno-60-11">11</a></span>
<span class="normal"><a href="#__codelineno-60-12">12</a></span>
<span class="normal"><a href="#__codelineno-60-13">13</a></span>
<span class="normal"><a href="#__codelineno-60-14">14</a></span>
<span class="normal"><a href="#__codelineno-60-15">15</a></span>
<span class="normal"><a href="#__codelineno-60-16">16</a></span>
<span class="normal"><a href="#__codelineno-60-17">17</a></span>
<span class="normal"><a href="#__codelineno-60-18">18</a></span>
<span class="normal"><a href="#__codelineno-60-19">19</a></span>
<span class="normal"><a href="#__codelineno-60-20">20</a></span>
<span class="normal"><a href="#__codelineno-60-21">21</a></span>
<span class="normal"><a href="#__codelineno-60-22">22</a></span>
<span class="normal"><a href="#__codelineno-60-23">23</a></span>
<span class="normal"><a href="#__codelineno-60-24">24</a></span>
<span class="normal"><a href="#__codelineno-60-25">25</a></span>
<span class="normal"><a href="#__codelineno-60-26">26</a></span>
<span class="normal"><a href="#__codelineno-60-27">27</a></span>
<span class="normal"><a href="#__codelineno-60-28">28</a></span>
<span class="normal"><a href="#__codelineno-60-29">29</a></span>
<span class="normal"><a href="#__codelineno-60-30">30</a></span>
<span class="normal"><a href="#__codelineno-60-31">31</a></span>
<span class="normal"><a href="#__codelineno-60-32">32</a></span>
<span class="normal"><a href="#__codelineno-60-33">33</a></span>
<span class="normal"><a href="#__codelineno-60-34">34</a></span>
<span class="normal"><a href="#__codelineno-60-35">35</a></span>
<span class="normal"><a href="#__codelineno-60-36">36</a></span>
<span class="normal"><a href="#__codelineno-60-37">37</a></span>
<span class="normal"><a href="#__codelineno-60-38">38</a></span>
<span class="normal"><a href="#__codelineno-60-39">39</a></span>
<span class="normal"><a href="#__codelineno-60-40">40</a></span>
<span class="normal"><a href="#__codelineno-60-41">41</a></span>
<span class="normal"><a href="#__codelineno-60-42">42</a></span>
<span class="normal"><a href="#__codelineno-60-43">43</a></span>
<span class="normal"><a href="#__codelineno-60-44">44</a></span>
<span class="normal"><a href="#__codelineno-60-45">45</a></span>
<span class="normal"><a href="#__codelineno-60-46">46</a></span>
<span class="normal"><a href="#__codelineno-60-47">47</a></span>
<span class="normal"><a href="#__codelineno-60-48">48</a></span>
<span class="normal"><a href="#__codelineno-60-49">49</a></span>
<span class="normal"><a href="#__codelineno-60-50">50</a></span>
<span class="normal"><a href="#__codelineno-60-51">51</a></span>
<span class="normal"><a href="#__codelineno-60-52">52</a></span>
<span class="normal"><a href="#__codelineno-60-53">53</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-60-1"><a id="__codelineno-60-1" name="__codelineno-60-1"></a><span class="nx">subgraphAgentA</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span>
</span><span id="__span-60-2"><a id="__codelineno-60-2" name="__codelineno-60-2"></a><span class="w">    </span><span class="s">&quot;subgraphA&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">subgraph</span><span class="p">,</span>
</span><span id="__span-60-3"><a id="__codelineno-60-3" name="__codelineno-60-3"></a><span class="w">    </span><span class="c1">// 对parentAgent、subgraphAgentA、subgraphAgentB(包含task1、task2分别生成的消息) 生成的所有消息可见（包含同一sessionID的历史会话消息）</span>
</span><span id="__span-60-4"><a id="__codelineno-60-4" name="__codelineno-60-4"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithMessageFilterMode</span><span class="p">(</span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">FullContext</span><span class="p">),</span>
</span><span id="__span-60-5"><a id="__codelineno-60-5" name="__codelineno-60-5"></a><span class="w">    </span><span class="c1">// 对parentAgent、subgraphAgentA、subgraphAgentB(包含task1、task2分别生成的消息) 当前runner.Run期间生成的所有消息可见（不包含历史会话消息）</span>
</span><span id="__span-60-6"><a id="__codelineno-60-6" name="__codelineno-60-6"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithMessageFilterMode</span><span class="p">(</span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">RequestContext</span><span class="p">),</span>
</span><span id="__span-60-7"><a id="__codelineno-60-7" name="__codelineno-60-7"></a><span class="w">    </span><span class="c1">// 仅对subgraphAgentA 当前runner.Run期间生成的消息可见（不包含自己的历史会话消息）</span>
</span><span id="__span-60-8"><a id="__codelineno-60-8" name="__codelineno-60-8"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithMessageFilterMode</span><span class="p">(</span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">IsolatedRequest</span><span class="p">),</span>
</span><span id="__span-60-9"><a id="__codelineno-60-9" name="__codelineno-60-9"></a><span class="w">    </span><span class="c1">// 仅对subgraphAgentA当前invocation期间生成的消息可见(此示例中subgraphAgentA仅执行一次， 效果等价于graphagent.IsolatedRequest)</span>
</span><span id="__span-60-10"><a id="__codelineno-60-10" name="__codelineno-60-10"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithMessageFilterMode</span><span class="p">(</span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">IsolatedInvocation</span><span class="p">),</span>
</span><span id="__span-60-11"><a id="__codelineno-60-11" name="__codelineno-60-11"></a><span class="p">)</span>
</span><span id="__span-60-12"><a id="__codelineno-60-12" name="__codelineno-60-12"></a>
</span><span id="__span-60-13"><a id="__codelineno-60-13" name="__codelineno-60-13"></a><span class="nx">subgraphAgentB</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span>
</span><span id="__span-60-14"><a id="__codelineno-60-14" name="__codelineno-60-14"></a><span class="w">    </span><span class="s">&quot;subgraphB&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">subgraph</span><span class="p">,</span>
</span><span id="__span-60-15"><a id="__codelineno-60-15" name="__codelineno-60-15"></a><span class="w">    </span><span class="c1">// 对parentAgent、subgraphAgentA、subgraphAgentB(包含task1、task2分别生成的消息) 生成的所有消息可见（包含同一sessionID的历史会话消息）</span>
</span><span id="__span-60-16"><a id="__codelineno-60-16" name="__codelineno-60-16"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithMessageFilterMode</span><span class="p">(</span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">FullContext</span><span class="p">),</span>
</span><span id="__span-60-17"><a id="__codelineno-60-17" name="__codelineno-60-17"></a><span class="w">    </span><span class="c1">// 对parentAgent、subgraphAgentA、subgraphAgentB(包含task1、task2分别生成的消息) 当前runner.Run期间生成的所有消息可见（不包含历史会话消息）</span>
</span><span id="__span-60-18"><a id="__codelineno-60-18" name="__codelineno-60-18"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithMessageFilterMode</span><span class="p">(</span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">RequestContext</span><span class="p">),</span>
</span><span id="__span-60-19"><a id="__codelineno-60-19" name="__codelineno-60-19"></a><span class="w">    </span><span class="c1">// 仅对subgraphAgentB（包含task1、task2分别生成的消息）当前runner.Run期间生成的消息可见（不包含自己的历史会话消息）</span>
</span><span id="__span-60-20"><a id="__codelineno-60-20" name="__codelineno-60-20"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithMessageFilterMode</span><span class="p">(</span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">IsolatedRequest</span><span class="p">),</span>
</span><span id="__span-60-21"><a id="__codelineno-60-21" name="__codelineno-60-21"></a><span class="w">    </span><span class="c1">// 仅对subgraphAgentB 当前Invocation中生成的消息可见，不包含历史消息（task1与task2执行期间生成的消息互不可见）。</span>
</span><span id="__span-60-22"><a id="__codelineno-60-22" name="__codelineno-60-22"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithMessageFilterMode</span><span class="p">(</span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">IsolatedInvocation</span><span class="p">),</span>
</span><span id="__span-60-23"><a id="__codelineno-60-23" name="__codelineno-60-23"></a><span class="p">)</span>
</span><span id="__span-60-24"><a id="__codelineno-60-24" name="__codelineno-60-24"></a>
</span><span id="__span-60-25"><a id="__codelineno-60-25" name="__codelineno-60-25"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddAgentNode</span><span class="p">(</span><span class="s">&quot;subgraphA&quot;</span><span class="p">)</span>
</span><span id="__span-60-26"><a id="__codelineno-60-26" name="__codelineno-60-26"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;fanout&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-60-27"><a id="__codelineno-60-27" name="__codelineno-60-27"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">[]</span><span class="o">*</span><span class="nx">graph</span><span class="p">.</span><span class="nx">Command</span><span class="p">{</span>
</span><span id="__span-60-28"><a id="__codelineno-60-28" name="__codelineno-60-28"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-60-29"><a id="__codelineno-60-29" name="__codelineno-60-29"></a><span class="w">            </span><span class="nx">GoTo</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;subgraph&quot;</span><span class="p">,</span>
</span><span id="__span-60-30"><a id="__codelineno-60-30" name="__codelineno-60-30"></a><span class="w">            </span><span class="nx">Update</span><span class="p">:</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span>
</span><span id="__span-60-31"><a id="__codelineno-60-31" name="__codelineno-60-31"></a><span class="w">                </span><span class="s">&quot;task&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;task 1&quot;</span>
</span><span id="__span-60-32"><a id="__codelineno-60-32" name="__codelineno-60-32"></a><span class="w">            </span><span class="p">},</span>
</span><span id="__span-60-33"><a id="__codelineno-60-33" name="__codelineno-60-33"></a><span class="w">        </span><span class="p">},</span>
</span><span id="__span-60-34"><a id="__codelineno-60-34" name="__codelineno-60-34"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-60-35"><a id="__codelineno-60-35" name="__codelineno-60-35"></a><span class="w">            </span><span class="nx">GoTo</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;subgraph&quot;</span><span class="p">,</span>
</span><span id="__span-60-36"><a id="__codelineno-60-36" name="__codelineno-60-36"></a><span class="w">            </span><span class="nx">Update</span><span class="p">:</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span>
</span><span id="__span-60-37"><a id="__codelineno-60-37" name="__codelineno-60-37"></a><span class="w">                </span><span class="s">&quot;task&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;task 2&quot;</span>
</span><span id="__span-60-38"><a id="__codelineno-60-38" name="__codelineno-60-38"></a><span class="w">            </span><span class="p">},</span>
</span><span id="__span-60-39"><a id="__codelineno-60-39" name="__codelineno-60-39"></a><span class="w">        </span><span class="p">},</span>
</span><span id="__span-60-40"><a id="__codelineno-60-40" name="__codelineno-60-40"></a><span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-60-41"><a id="__codelineno-60-41" name="__codelineno-60-41"></a><span class="p">})</span>
</span><span id="__span-60-42"><a id="__codelineno-60-42" name="__codelineno-60-42"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddAgentNode</span><span class="p">(</span><span class="s">&quot;subgraphB&quot;</span><span class="p">)</span>
</span><span id="__span-60-43"><a id="__codelineno-60-43" name="__codelineno-60-43"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddEdge</span><span class="p">(</span><span class="s">&quot;subgraphA&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;fanout&quot;</span><span class="p">)</span>
</span><span id="__span-60-44"><a id="__codelineno-60-44" name="__codelineno-60-44"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">SetEntryPoint</span><span class="p">(</span><span class="nx">subgraphA</span><span class="p">)</span>
</span><span id="__span-60-45"><a id="__codelineno-60-45" name="__codelineno-60-45"></a><span class="nx">graph</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">sg</span><span class="p">.</span><span class="nx">Compile</span><span class="p">()</span>
</span><span id="__span-60-46"><a id="__codelineno-60-46" name="__codelineno-60-46"></a><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-60-47"><a id="__codelineno-60-47" name="__codelineno-60-47"></a><span class="w">    </span><span class="nx">log</span><span class="p">.</span><span class="nx">Fatalf</span><span class="p">(</span><span class="s">&quot;Failed to Compile state graph, err: %w&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
</span><span id="__span-60-48"><a id="__codelineno-60-48" name="__codelineno-60-48"></a><span class="p">}</span>
</span><span id="__span-60-49"><a id="__codelineno-60-49" name="__codelineno-60-49"></a><span class="nx">parentAgent</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span>
</span><span id="__span-60-50"><a id="__codelineno-60-50" name="__codelineno-60-50"></a><span class="w">    </span><span class="s">&quot;subgraph&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">graph</span><span class="p">,</span>
</span><span id="__span-60-51"><a id="__codelineno-60-51" name="__codelineno-60-51"></a><span class="w">    </span><span class="c1">// subagent</span>
</span><span id="__span-60-52"><a id="__codelineno-60-52" name="__codelineno-60-52"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithSubAgents</span><span class="p">(</span><span class="nx">subgraphAgent</span><span class="p">)</span>
</span><span id="__span-60-53"><a id="__codelineno-60-53" name="__codelineno-60-53"></a><span class="p">)</span>
</span></code></pre></div></td></tr></table></div></p>
<p>案例2: 对节点Agent消息可见性控制
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-61-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-61-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-61-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-61-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-61-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-61-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-61-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-61-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-61-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-61-10">10</a></span>
<span class="normal"><a href="#__codelineno-61-11">11</a></span>
<span class="normal"><a href="#__codelineno-61-12">12</a></span>
<span class="normal"><a href="#__codelineno-61-13">13</a></span>
<span class="normal"><a href="#__codelineno-61-14">14</a></span>
<span class="normal"><a href="#__codelineno-61-15">15</a></span>
<span class="normal"><a href="#__codelineno-61-16">16</a></span>
<span class="normal"><a href="#__codelineno-61-17">17</a></span>
<span class="normal"><a href="#__codelineno-61-18">18</a></span>
<span class="normal"><a href="#__codelineno-61-19">19</a></span>
<span class="normal"><a href="#__codelineno-61-20">20</a></span>
<span class="normal"><a href="#__codelineno-61-21">21</a></span>
<span class="normal"><a href="#__codelineno-61-22">22</a></span>
<span class="normal"><a href="#__codelineno-61-23">23</a></span>
<span class="normal"><a href="#__codelineno-61-24">24</a></span>
<span class="normal"><a href="#__codelineno-61-25">25</a></span>
<span class="normal"><a href="#__codelineno-61-26">26</a></span>
<span class="normal"><a href="#__codelineno-61-27">27</a></span>
<span class="normal"><a href="#__codelineno-61-28">28</a></span>
<span class="normal"><a href="#__codelineno-61-29">29</a></span>
<span class="normal"><a href="#__codelineno-61-30">30</a></span>
<span class="normal"><a href="#__codelineno-61-31">31</a></span>
<span class="normal"><a href="#__codelineno-61-32">32</a></span>
<span class="normal"><a href="#__codelineno-61-33">33</a></span>
<span class="normal"><a href="#__codelineno-61-34">34</a></span>
<span class="normal"><a href="#__codelineno-61-35">35</a></span>
<span class="normal"><a href="#__codelineno-61-36">36</a></span>
<span class="normal"><a href="#__codelineno-61-37">37</a></span>
<span class="normal"><a href="#__codelineno-61-38">38</a></span>
<span class="normal"><a href="#__codelineno-61-39">39</a></span>
<span class="normal"><a href="#__codelineno-61-40">40</a></span>
<span class="normal"><a href="#__codelineno-61-41">41</a></span>
<span class="normal"><a href="#__codelineno-61-42">42</a></span>
<span class="normal"><a href="#__codelineno-61-43">43</a></span>
<span class="normal"><a href="#__codelineno-61-44">44</a></span>
<span class="normal"><a href="#__codelineno-61-45">45</a></span>
<span class="normal"><a href="#__codelineno-61-46">46</a></span>
<span class="normal"><a href="#__codelineno-61-47">47</a></span>
<span class="normal"><a href="#__codelineno-61-48">48</a></span>
<span class="normal"><a href="#__codelineno-61-49">49</a></span>
<span class="normal"><a href="#__codelineno-61-50">50</a></span>
<span class="normal"><a href="#__codelineno-61-51">51</a></span>
<span class="normal"><a href="#__codelineno-61-52">52</a></span>
<span class="normal"><a href="#__codelineno-61-53">53</a></span>
<span class="normal"><a href="#__codelineno-61-54">54</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-61-1"><a id="__codelineno-61-1" name="__codelineno-61-1"></a><span class="nx">taskagentA</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">llmagent</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span>
</span><span id="__span-61-2"><a id="__codelineno-61-2" name="__codelineno-61-2"></a><span class="w">  </span><span class="s">&quot;taskagentA&quot;</span><span class="p">,</span>
</span><span id="__span-61-3"><a id="__codelineno-61-3" name="__codelineno-61-3"></a><span class="w">  </span><span class="nx">llmagent</span><span class="p">.</span><span class="nx">WithModel</span><span class="p">(</span><span class="nx">modelInstance</span><span class="p">),</span>
</span><span id="__span-61-4"><a id="__codelineno-61-4" name="__codelineno-61-4"></a><span class="w">  </span><span class="c1">// 对taskagentA、taskagentB生成的所有消息可见（包含同一sessionID的历史会话消息）</span>
</span><span id="__span-61-5"><a id="__codelineno-61-5" name="__codelineno-61-5"></a><span class="w">  </span><span class="nx">llmagent</span><span class="p">.</span><span class="nx">WithMessageFilterMode</span><span class="p">(</span><span class="nx">llmagent</span><span class="p">.</span><span class="nx">FullContext</span><span class="p">),</span>
</span><span id="__span-61-6"><a id="__codelineno-61-6" name="__codelineno-61-6"></a><span class="w">  </span><span class="c1">// 对taskagentA、taskagentB当前runner.Run期间生成的所有消息可见（不包含历史会话消息）</span>
</span><span id="__span-61-7"><a id="__codelineno-61-7" name="__codelineno-61-7"></a><span class="w">  </span><span class="nx">llmagent</span><span class="p">.</span><span class="nx">WithMessageFilterMode</span><span class="p">(</span><span class="nx">llmagent</span><span class="p">.</span><span class="nx">RequestContext</span><span class="p">),</span>
</span><span id="__span-61-8"><a id="__codelineno-61-8" name="__codelineno-61-8"></a><span class="w">  </span><span class="c1">// 仅对taskagentA当前runner.Run期间生成的消息可见（不包含自己的历史会话消息）</span>
</span><span id="__span-61-9"><a id="__codelineno-61-9" name="__codelineno-61-9"></a><span class="w">  </span><span class="nx">llmagent</span><span class="p">.</span><span class="nx">WithMessageFilterMode</span><span class="p">(</span><span class="nx">llmagent</span><span class="p">.</span><span class="nx">IsolatedRequest</span><span class="p">),</span>
</span><span id="__span-61-10"><a id="__codelineno-61-10" name="__codelineno-61-10"></a><span class="w">  </span><span class="c1">// agent执性顺序：taskagentA-invocation1 -&gt; taskagentB-invocation2 -&gt; taskagentA-invocation3(当前执行阶段)</span>
</span><span id="__span-61-11"><a id="__codelineno-61-11" name="__codelineno-61-11"></a><span class="w">  </span><span class="c1">// 仅对taskagentA当前taskagentA-invocation3期间生成的消息可见（不包含自己的历史会话消息以及taskagentA-invocation1期间生成的消息）</span>
</span><span id="__span-61-12"><a id="__codelineno-61-12" name="__codelineno-61-12"></a><span class="w">  </span><span class="nx">llmagent</span><span class="p">.</span><span class="nx">WithMessageFilterMode</span><span class="p">(</span><span class="nx">llmagent</span><span class="p">.</span><span class="nx">IsolatedInvocation</span><span class="p">),</span>
</span><span id="__span-61-13"><a id="__codelineno-61-13" name="__codelineno-61-13"></a><span class="p">)</span>
</span><span id="__span-61-14"><a id="__codelineno-61-14" name="__codelineno-61-14"></a>
</span><span id="__span-61-15"><a id="__codelineno-61-15" name="__codelineno-61-15"></a><span class="nx">taskagentB</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">llmagent</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span>
</span><span id="__span-61-16"><a id="__codelineno-61-16" name="__codelineno-61-16"></a><span class="w">  </span><span class="s">&quot;taskagentB&quot;</span><span class="p">,</span>
</span><span id="__span-61-17"><a id="__codelineno-61-17" name="__codelineno-61-17"></a><span class="w">  </span><span class="nx">llmagent</span><span class="p">.</span><span class="nx">WithModel</span><span class="p">(</span><span class="nx">modelInstance</span><span class="p">),</span>
</span><span id="__span-61-18"><a id="__codelineno-61-18" name="__codelineno-61-18"></a><span class="w">  </span><span class="c1">// 对taskagentA、taskagentB生成的所有消息可见（包含同一sessionID的历史会话消息）</span>
</span><span id="__span-61-19"><a id="__codelineno-61-19" name="__codelineno-61-19"></a><span class="w">  </span><span class="nx">llmagent</span><span class="p">.</span><span class="nx">WithMessageFilterMode</span><span class="p">(</span><span class="nx">llmagent</span><span class="p">.</span><span class="nx">FullContext</span><span class="p">),</span>
</span><span id="__span-61-20"><a id="__codelineno-61-20" name="__codelineno-61-20"></a><span class="w">  </span><span class="c1">// 对taskagentA、taskagentB当前runner.Run期间生成的所有消息可见（不包含历史会话消息）</span>
</span><span id="__span-61-21"><a id="__codelineno-61-21" name="__codelineno-61-21"></a><span class="w">  </span><span class="nx">llmagent</span><span class="p">.</span><span class="nx">WithMessageFilterMode</span><span class="p">(</span><span class="nx">llmagent</span><span class="p">.</span><span class="nx">RequestContext</span><span class="p">),</span>
</span><span id="__span-61-22"><a id="__codelineno-61-22" name="__codelineno-61-22"></a><span class="w">  </span><span class="c1">// 仅对taskagentB当前runner.Run期间生成的消息可见（不包含自己的历史会话消息）</span>
</span><span id="__span-61-23"><a id="__codelineno-61-23" name="__codelineno-61-23"></a><span class="w">  </span><span class="nx">llmagent</span><span class="p">.</span><span class="nx">WithMessageFilterMode</span><span class="p">(</span><span class="nx">llmagent</span><span class="p">.</span><span class="nx">IsolatedRequest</span><span class="p">),</span>
</span><span id="__span-61-24"><a id="__codelineno-61-24" name="__codelineno-61-24"></a><span class="w">  </span><span class="c1">// agent执性顺序：taskagentA-invocation1 -&gt; taskagentB-invocation2 -&gt; taskagentA-invocation3 -&gt; taskagentB-invocation4(当前执行阶段)</span>
</span><span id="__span-61-25"><a id="__codelineno-61-25" name="__codelineno-61-25"></a><span class="w">  </span><span class="c1">// 仅对taskagentB当前taskagentB-invocation4期间生成的消息可见（不包含自己的历史会话消息以及taskagentB-invocation2期间生成的消息）</span>
</span><span id="__span-61-26"><a id="__codelineno-61-26" name="__codelineno-61-26"></a><span class="w">  </span><span class="nx">llmagent</span><span class="p">.</span><span class="nx">WithMessageFilterMode</span><span class="p">(</span><span class="nx">llmagent</span><span class="p">.</span><span class="nx">IsolatedInvocation</span><span class="p">),</span>
</span><span id="__span-61-27"><a id="__codelineno-61-27" name="__codelineno-61-27"></a><span class="p">)</span>
</span><span id="__span-61-28"><a id="__codelineno-61-28" name="__codelineno-61-28"></a>
</span><span id="__span-61-29"><a id="__codelineno-61-29" name="__codelineno-61-29"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddAgentNode</span><span class="p">(</span><span class="s">&quot;taskagentA&quot;</span><span class="p">)</span>
</span><span id="__span-61-30"><a id="__codelineno-61-30" name="__codelineno-61-30"></a><span class="c1">// 同一个并行执行多个任务</span>
</span><span id="__span-61-31"><a id="__codelineno-61-31" name="__codelineno-61-31"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;fanout&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-32"><a id="__codelineno-61-32" name="__codelineno-61-32"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">[]</span><span class="o">*</span><span class="nx">graph</span><span class="p">.</span><span class="nx">Command</span><span class="p">{</span>
</span><span id="__span-61-33"><a id="__codelineno-61-33" name="__codelineno-61-33"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-61-34"><a id="__codelineno-61-34" name="__codelineno-61-34"></a><span class="w">            </span><span class="nx">GoTo</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;taskB&quot;</span><span class="p">,</span>
</span><span id="__span-61-35"><a id="__codelineno-61-35" name="__codelineno-61-35"></a><span class="w">            </span><span class="nx">Update</span><span class="p">:</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span>
</span><span id="__span-61-36"><a id="__codelineno-61-36" name="__codelineno-61-36"></a><span class="w">                </span><span class="s">&quot;task&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;task 1&quot;</span>
</span><span id="__span-61-37"><a id="__codelineno-61-37" name="__codelineno-61-37"></a><span class="w">            </span><span class="p">},</span>
</span><span id="__span-61-38"><a id="__codelineno-61-38" name="__codelineno-61-38"></a><span class="w">        </span><span class="p">},</span>
</span><span id="__span-61-39"><a id="__codelineno-61-39" name="__codelineno-61-39"></a><span class="w">        </span><span class="p">{</span>
</span><span id="__span-61-40"><a id="__codelineno-61-40" name="__codelineno-61-40"></a><span class="w">            </span><span class="nx">GoTo</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;taskB&quot;</span><span class="p">,</span>
</span><span id="__span-61-41"><a id="__codelineno-61-41" name="__codelineno-61-41"></a><span class="w">            </span><span class="nx">Update</span><span class="p">:</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span>
</span><span id="__span-61-42"><a id="__codelineno-61-42" name="__codelineno-61-42"></a><span class="w">                </span><span class="s">&quot;task&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;task 2&quot;</span>
</span><span id="__span-61-43"><a id="__codelineno-61-43" name="__codelineno-61-43"></a><span class="w">            </span><span class="p">},</span>
</span><span id="__span-61-44"><a id="__codelineno-61-44" name="__codelineno-61-44"></a><span class="w">        </span><span class="p">},</span>
</span><span id="__span-61-45"><a id="__codelineno-61-45" name="__codelineno-61-45"></a><span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-61-46"><a id="__codelineno-61-46" name="__codelineno-61-46"></a><span class="p">})</span>
</span><span id="__span-61-47"><a id="__codelineno-61-47" name="__codelineno-61-47"></a><span class="c1">// 可将taskagentB的消息过滤模式设置为llmagent.IsolatedInvocation 以此来隔离多任务的上下文会话信息</span>
</span><span id="__span-61-48"><a id="__codelineno-61-48" name="__codelineno-61-48"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;taskB&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">){</span>
</span><span id="__span-61-49"><a id="__codelineno-61-49" name="__codelineno-61-49"></a><span class="w">    </span><span class="nx">task</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">state</span><span class="p">[</span><span class="s">&quot;task-id&quot;</span><span class="p">]</span>
</span><span id="__span-61-50"><a id="__codelineno-61-50" name="__codelineno-61-50"></a><span class="w">    </span><span class="nx">inv</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">agent</span><span class="p">.</span><span class="nx">InvocationFromContext</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</span><span id="__span-61-51"><a id="__codelineno-61-51" name="__codelineno-61-51"></a><span class="w">    </span><span class="nx">inv</span><span class="p">.</span><span class="nx">Message</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">model</span><span class="p">.</span><span class="nx">NewUserMessage</span><span class="p">(</span><span class="nx">task</span><span class="p">)</span>
</span><span id="__span-61-52"><a id="__codelineno-61-52" name="__codelineno-61-52"></a><span class="w">    </span><span class="kd">chan</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">taskagentB</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">inv</span><span class="p">)</span>
</span><span id="__span-61-53"><a id="__codelineno-61-53" name="__codelineno-61-53"></a><span class="w">    </span><span class="c1">// do any thing</span>
</span><span id="__span-61-54"><a id="__codelineno-61-54" name="__codelineno-61-54"></a><span class="p">})</span>
</span></code></pre></div></td></tr></table></div></p>
<p>高阶用法示例：
可以单独通过 <code>WithMessageTimelineFilterMode</code>、<code>WithMessageBranchFilterMode</code>控制当前agent对历史消息与其他agent生成的消息可见性。
当前agent在与模型交互时，最终将同时满足两个条件的消息输入给模型。</p>
<p><code>配置:</code>
- <code>WithMessageTimelineFilterMode</code>: 时间维度可见性控制
  - <code>TimelineFilterAll</code>: 包含历史消息以及当前请求中所生成的消息
  - <code>TimelineFilterCurrentRequest</code>: 仅包含当前请求(一次runner.Run为一次请求)中所生成的消息
  - <code>TimelineFilterCurrentInvocation</code>: 仅包含当前invocation上下文中生成的消息
- <code>WithMessageBranchFilterMode</code>: 分支维度可见性控制（用于控制对其他agent生成消息的可见性）
  - <code>BranchFilterModePrefix</code>: 通过Event.FilterKey与Invocation.eventFilterKey做前缀匹配
  - <code>BranchFilterModeAll</code>: 所有agent的均消息
  - <code>BranchFilterModeExact</code>: 仅自己生成的消息可见</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-62-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-62-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-62-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-62-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-62-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-62-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-62-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-62-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-62-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-62-10">10</a></span>
<span class="normal"><a href="#__codelineno-62-11">11</a></span>
<span class="normal"><a href="#__codelineno-62-12">12</a></span>
<span class="normal"><a href="#__codelineno-62-13">13</a></span>
<span class="normal"><a href="#__codelineno-62-14">14</a></span>
<span class="normal"><a href="#__codelineno-62-15">15</a></span>
<span class="normal"><a href="#__codelineno-62-16">16</a></span>
<span class="normal"><a href="#__codelineno-62-17">17</a></span>
<span class="normal"><a href="#__codelineno-62-18">18</a></span>
<span class="normal"><a href="#__codelineno-62-19">19</a></span>
<span class="normal"><a href="#__codelineno-62-20">20</a></span>
<span class="normal"><a href="#__codelineno-62-21">21</a></span>
<span class="normal"><a href="#__codelineno-62-22">22</a></span>
<span class="normal"><a href="#__codelineno-62-23">23</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-62-1"><a id="__codelineno-62-1" name="__codelineno-62-1"></a><span class="nx">llmAgent</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">llmagent</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span>
</span><span id="__span-62-2"><a id="__codelineno-62-2" name="__codelineno-62-2"></a><span class="w">    </span><span class="s">&quot;demo-agent&quot;</span><span class="p">,</span><span class="w">                      </span><span class="c1">// Agent 名称</span>
</span><span id="__span-62-3"><a id="__codelineno-62-3" name="__codelineno-62-3"></a><span class="w">    </span><span class="nx">llmagent</span><span class="p">.</span><span class="nx">WithModel</span><span class="p">(</span><span class="nx">modelInstance</span><span class="p">),</span><span class="w"> </span><span class="c1">// 设置模型</span>
</span><span id="__span-62-4"><a id="__codelineno-62-4" name="__codelineno-62-4"></a><span class="w">    </span><span class="nx">llmagent</span><span class="p">.</span><span class="nx">WithDescription</span><span class="p">(</span><span class="s">&quot;A helpful AI assistant for demonstrations&quot;</span><span class="p">),</span><span class="w">              </span><span class="c1">// 设置描述</span>
</span><span id="__span-62-5"><a id="__codelineno-62-5" name="__codelineno-62-5"></a><span class="w">    </span><span class="nx">llmagent</span><span class="p">.</span><span class="nx">WithInstruction</span><span class="p">(</span><span class="s">&quot;Be helpful, concise, and informative in your responses&quot;</span><span class="p">),</span><span class="w"> </span><span class="c1">// 设置指令</span>
</span><span id="__span-62-6"><a id="__codelineno-62-6" name="__codelineno-62-6"></a><span class="w">    </span><span class="nx">llmagent</span><span class="p">.</span><span class="nx">WithGenerationConfig</span><span class="p">(</span><span class="nx">genConfig</span><span class="p">),</span><span class="w">                                           </span><span class="c1">// 设置生成参数</span>
</span><span id="__span-62-7"><a id="__codelineno-62-7" name="__codelineno-62-7"></a>
</span><span id="__span-62-8"><a id="__codelineno-62-8" name="__codelineno-62-8"></a><span class="w">    </span><span class="c1">// 设置传给模型的消息过滤模式，最终传给模型的消息需同时满足WithMessageTimelineFilterMode与WithMessageBranchFilterMode条件</span>
</span><span id="__span-62-9"><a id="__codelineno-62-9" name="__codelineno-62-9"></a><span class="w">    </span><span class="c1">// 时间维度过滤条件</span>
</span><span id="__span-62-10"><a id="__codelineno-62-10" name="__codelineno-62-10"></a><span class="w">    </span><span class="c1">// 默认值: llmagent.TimelineFilterAll</span>
</span><span id="__span-62-11"><a id="__codelineno-62-11" name="__codelineno-62-11"></a><span class="w">    </span><span class="c1">// 可选值:</span>
</span><span id="__span-62-12"><a id="__codelineno-62-12" name="__codelineno-62-12"></a><span class="w">    </span><span class="c1">//  - llmagent.TimelineFilterAll: 包含历史消息以及当前请求中所生成的消息</span>
</span><span id="__span-62-13"><a id="__codelineno-62-13" name="__codelineno-62-13"></a><span class="w">    </span><span class="c1">//  - llmagent.TimelineFilterCurrentRequest: 仅包含当前请求中所生成的消息</span>
</span><span id="__span-62-14"><a id="__codelineno-62-14" name="__codelineno-62-14"></a><span class="w">    </span><span class="c1">//  - llmagent.TimelineFilterCurrentInvocation: 仅包含当前invocation上下文中生成的消息</span>
</span><span id="__span-62-15"><a id="__codelineno-62-15" name="__codelineno-62-15"></a><span class="w">    </span><span class="nx">llmagent</span><span class="p">.</span><span class="nx">WithMessageTimelineFilterMode</span><span class="p">(</span><span class="nx">llmagent</span><span class="p">.</span><span class="nx">BranchFilterModeAll</span><span class="p">),</span>
</span><span id="__span-62-16"><a id="__codelineno-62-16" name="__codelineno-62-16"></a><span class="w">    </span><span class="c1">// 分支维度过滤条件</span>
</span><span id="__span-62-17"><a id="__codelineno-62-17" name="__codelineno-62-17"></a><span class="w">    </span><span class="c1">// 默认值: llmagent.BranchFilterModePrefix</span>
</span><span id="__span-62-18"><a id="__codelineno-62-18" name="__codelineno-62-18"></a><span class="w">    </span><span class="c1">// 可选值:</span>
</span><span id="__span-62-19"><a id="__codelineno-62-19" name="__codelineno-62-19"></a><span class="w">    </span><span class="c1">//  - llmagent.BranchFilterModeAll: 包含所有agent的消息, 当前agent与模型交互时,如需将所有agent生成的有效内容消息同步给模型时可设置该值</span>
</span><span id="__span-62-20"><a id="__codelineno-62-20" name="__codelineno-62-20"></a><span class="w">    </span><span class="c1">//  - llmagent.BranchFilterModePrefix: 通过Event.FilterKey与Invocation.eventFilterKey做前缀匹配过滤消息, 期望将与当前agent以及相关上下游agent生成的消息传递给模型时，可设置该值</span>
</span><span id="__span-62-21"><a id="__codelineno-62-21" name="__codelineno-62-21"></a><span class="w">    </span><span class="c1">//  - llmagent.BranchFilterModeExact: 通过Event.FilterKey==Invocation.eventFilterKey过滤消息，当前agent与模型交互时,仅需使用当前agent生成的消息时可设置该值</span>
</span><span id="__span-62-22"><a id="__codelineno-62-22" name="__codelineno-62-22"></a><span class="w">    </span><span class="nx">llmagent</span><span class="p">.</span><span class="nx">WithMessageBranchFilterMode</span><span class="p">(</span><span class="nx">llmagent</span><span class="p">.</span><span class="nx">TimelineFilterAll</span><span class="p">),</span>
</span><span id="__span-62-23"><a id="__codelineno-62-23" name="__codelineno-62-23"></a><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="fan-out">命令模式（动态路由 / Fan-out）</h3>
<p>节点除返回 <code>graph.State</code> 外，也可以返回 <code>*graph.Command</code> 或 <code>[]*graph.Command</code>，以同时更新状态并指定下一跳：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-63-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-63-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-63-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-63-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-63-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-63-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-63-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-63-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-63-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-63-10">10</a></span>
<span class="normal"><a href="#__codelineno-63-11">11</a></span>
<span class="normal"><a href="#__codelineno-63-12">12</a></span>
<span class="normal"><a href="#__codelineno-63-13">13</a></span>
<span class="normal"><a href="#__codelineno-63-14">14</a></span>
<span class="normal"><a href="#__codelineno-63-15">15</a></span>
<span class="normal"><a href="#__codelineno-63-16">16</a></span>
<span class="normal"><a href="#__codelineno-63-17">17</a></span>
<span class="normal"><a href="#__codelineno-63-18">18</a></span>
<span class="normal"><a href="#__codelineno-63-19">19</a></span>
<span class="normal"><a href="#__codelineno-63-20">20</a></span>
<span class="normal"><a href="#__codelineno-63-21">21</a></span>
<span class="normal"><a href="#__codelineno-63-22">22</a></span>
<span class="normal"><a href="#__codelineno-63-23">23</a></span>
<span class="normal"><a href="#__codelineno-63-24">24</a></span>
<span class="normal"><a href="#__codelineno-63-25">25</a></span>
<span class="normal"><a href="#__codelineno-63-26">26</a></span>
<span class="normal"><a href="#__codelineno-63-27">27</a></span>
<span class="normal"><a href="#__codelineno-63-28">28</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-63-1"><a id="__codelineno-63-1" name="__codelineno-63-1"></a><span class="c1">// 动态路由到 A 或 B，并写入状态</span>
</span><span id="__span-63-2"><a id="__codelineno-63-2" name="__codelineno-63-2"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-63-3"><a id="__codelineno-63-3" name="__codelineno-63-3"></a><span class="w">    </span><span class="nx">nodeDecide</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;decide&quot;</span>
</span><span id="__span-63-4"><a id="__codelineno-63-4" name="__codelineno-63-4"></a><span class="w">    </span><span class="nx">nodeA</span><span class="w">        </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;A&quot;</span>
</span><span id="__span-63-5"><a id="__codelineno-63-5" name="__codelineno-63-5"></a><span class="w">    </span><span class="nx">nodeB</span><span class="w">        </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;B&quot;</span>
</span><span id="__span-63-6"><a id="__codelineno-63-6" name="__codelineno-63-6"></a><span class="w">    </span><span class="nx">stateKeyFlag</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;flag&quot;</span>
</span><span id="__span-63-7"><a id="__codelineno-63-7" name="__codelineno-63-7"></a><span class="p">)</span>
</span><span id="__span-63-8"><a id="__codelineno-63-8" name="__codelineno-63-8"></a>
</span><span id="__span-63-9"><a id="__codelineno-63-9" name="__codelineno-63-9"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="nx">nodeDecide</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-63-10"><a id="__codelineno-63-10" name="__codelineno-63-10"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">s</span><span class="p">[</span><span class="nx">stateKeyFlag</span><span class="p">].(</span><span class="kt">bool</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-63-11"><a id="__codelineno-63-11" name="__codelineno-63-11"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">graph</span><span class="p">.</span><span class="nx">Command</span><span class="p">{</span><span class="nx">Update</span><span class="p">:</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="s">&quot;routed&quot;</span><span class="p">:</span><span class="w"> </span><span class="nx">nodeA</span><span class="p">},</span><span class="w"> </span><span class="nx">GoTo</span><span class="p">:</span><span class="w"> </span><span class="nx">nodeA</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-63-12"><a id="__codelineno-63-12" name="__codelineno-63-12"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-63-13"><a id="__codelineno-63-13" name="__codelineno-63-13"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">graph</span><span class="p">.</span><span class="nx">Command</span><span class="p">{</span><span class="nx">Update</span><span class="p">:</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="s">&quot;routed&quot;</span><span class="p">:</span><span class="w"> </span><span class="nx">nodeB</span><span class="p">},</span><span class="w"> </span><span class="nx">GoTo</span><span class="p">:</span><span class="w"> </span><span class="nx">nodeB</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-63-14"><a id="__codelineno-63-14" name="__codelineno-63-14"></a><span class="p">})</span>
</span><span id="__span-63-15"><a id="__codelineno-63-15" name="__codelineno-63-15"></a>
</span><span id="__span-63-16"><a id="__codelineno-63-16" name="__codelineno-63-16"></a><span class="c1">// Fan-out：并行派发多个任务到同一 worker</span>
</span><span id="__span-63-17"><a id="__codelineno-63-17" name="__codelineno-63-17"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-63-18"><a id="__codelineno-63-18" name="__codelineno-63-18"></a><span class="w">    </span><span class="nx">nodeFanout</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;fanout&quot;</span>
</span><span id="__span-63-19"><a id="__codelineno-63-19" name="__codelineno-63-19"></a><span class="w">    </span><span class="nx">nodeWorker</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;worker&quot;</span>
</span><span id="__span-63-20"><a id="__codelineno-63-20" name="__codelineno-63-20"></a><span class="p">)</span>
</span><span id="__span-63-21"><a id="__codelineno-63-21" name="__codelineno-63-21"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="nx">nodeFanout</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-63-22"><a id="__codelineno-63-22" name="__codelineno-63-22"></a><span class="w">    </span><span class="nx">cmds</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">[]</span><span class="o">*</span><span class="nx">graph</span><span class="p">.</span><span class="nx">Command</span><span class="p">{</span>
</span><span id="__span-63-23"><a id="__codelineno-63-23" name="__codelineno-63-23"></a><span class="w">        </span><span class="p">{</span><span class="nx">Update</span><span class="p">:</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="s">&quot;param&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;A&quot;</span><span class="p">},</span><span class="w"> </span><span class="nx">GoTo</span><span class="p">:</span><span class="w"> </span><span class="nx">nodeWorker</span><span class="p">},</span>
</span><span id="__span-63-24"><a id="__codelineno-63-24" name="__codelineno-63-24"></a><span class="w">        </span><span class="p">{</span><span class="nx">Update</span><span class="p">:</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="s">&quot;param&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;B&quot;</span><span class="p">},</span><span class="w"> </span><span class="nx">GoTo</span><span class="p">:</span><span class="w"> </span><span class="nx">nodeWorker</span><span class="p">},</span>
</span><span id="__span-63-25"><a id="__codelineno-63-25" name="__codelineno-63-25"></a><span class="w">        </span><span class="p">{</span><span class="nx">Update</span><span class="p">:</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="s">&quot;param&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;C&quot;</span><span class="p">},</span><span class="w"> </span><span class="nx">GoTo</span><span class="p">:</span><span class="w"> </span><span class="nx">nodeWorker</span><span class="p">},</span>
</span><span id="__span-63-26"><a id="__codelineno-63-26" name="__codelineno-63-26"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-63-27"><a id="__codelineno-63-27" name="__codelineno-63-27"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">cmds</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-63-28"><a id="__codelineno-63-28" name="__codelineno-63-28"></a><span class="p">})</span>
</span></code></pre></div></td></tr></table></div>
<p>使用命令模式进行路由时，无需为 <code>GoTo</code> 目标添加显式静态边；仅需保证目标节点存在，并在需要作为终点时设置 <code>SetFinishPoint</code>。</p>
<h2 id="_20">架构设计</h2>
<h3 id="_21">整体架构</h3>
<p>GraphAgent 的架构设计体现了我们对复杂系统的理解：通过清晰的分层来管理复杂性。每一层都有明确的职责，层与层之间通过标准接口通信。</p>
<pre class="mermaid"><code>flowchart TB
    subgraph "Runner Layer"
        R[Runner]:::runnerClass
        S[Session Service]:::sessionClass
    end

    subgraph "GraphAgent"
        GA[GraphAgent Wrapper]:::agentClass
        CB[Callbacks]:::callbackClass
    end

    subgraph "Graph Engine"
        SG[StateGraph Builder]:::builderClass
        G[Graph]:::graphClass
        E[Executor]:::executorClass
    end

    subgraph "Execution Components"
        P[Planning]:::phaseClass
        EX[Execution]:::phaseClass
        U[Update]:::phaseClass
    end

    subgraph "Storage"
        CP[Checkpoint]:::storageClass
        ST[State Store]:::storageClass
    end

    R --&gt; GA
    GA --&gt; G
    G --&gt; E
    E --&gt; P
    E --&gt; EX
    E --&gt; U
    E --&gt; CP

    classDef runnerClass fill:#e8f5e9,stroke:#43a047,stroke-width:2px
    classDef sessionClass fill:#f3e5f5,stroke:#8e24aa,stroke-width:2px
    classDef agentClass fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    classDef callbackClass fill:#fce4ec,stroke:#c2185b,stroke-width:2px
    classDef builderClass fill:#fff8e1,stroke:#f57c00,stroke-width:2px
    classDef graphClass fill:#f1f8e9,stroke:#689f38,stroke-width:2px
    classDef executorClass fill:#e0f2f1,stroke:#00796b,stroke-width:2px
    classDef phaseClass fill:#ede7f6,stroke:#512da8,stroke-width:2px
    classDef storageClass fill:#efebe9,stroke:#5d4037,stroke-width:2px</code></pre>
<h3 id="_22">核心模块解析</h3>
<p>核心组件一览：</p>
<p><strong><code>graph/state_graph.go</code></strong> - StateGraph 构建器<br />
提供链式声明式 Go API 来构建图结构，通过 fluent 方法链（AddNode → AddEdge → Compile）定义节点、边和条件路由。</p>
<p><strong><code>graph/graph.go</code></strong> - 编译后的运行时<br />
实现基于通道（Channel）的事件触发式执行机制。节点执行结果合并入 State；通道仅用于触发路由，写入哨兵值（sentinel value）而非业务数据。</p>
<p><strong><code>graph/executor.go</code></strong> - BSP 执行器<br />
这是系统心脏，借鉴了 <a href="https://research.google/pubs/pub37252/">Google Pregel</a> 论文。实现 BSP（Bulk Synchronous Parallel）风格的三阶段循环：Planning → Execution → Update。</p>
<p><strong><code>graph/checkpoint/*</code></strong> - 检查点和恢复机制<br />
提供可选的检查点持久化（如 sqlite），原子保存状态与待写入动作，支持按谱系/检查点恢复。</p>
<p><strong><code>agent/graphagent/graph_agent.go</code></strong> - Graph 与 Agent 的桥梁<br />
将编译后的 Graph 适配为通用 Agent，可复用会话、回调与事件流。</p>
<h3 id="_23">执行模型</h3>
<p>GraphAgent 借鉴了 Google Pregel 的 BSP（Bulk Synchronous Parallel）模型，但适配到了单进程环境；在此基础上还支持检查点、HITL 中断/恢复与时间旅行：</p>
<pre class="mermaid"><code>sequenceDiagram
    autonumber
    participant R as Runner
    participant GA as GraphAgent
    participant EX as Executor
    participant CK as Checkpoint Saver
    participant DB as Storage
    participant H as Human

    R-&gt;&gt;GA: Run(invocation)
    GA-&gt;&gt;EX: Execute(graph, state, options)
    GA--&gt;&gt;R: Stream node/tool/model events

    loop 每个超级步 (BSP)
        EX-&gt;&gt;EX: Planning — 计算前沿(Frontier)
        par 并行执行节点
            EX-&gt;&gt;EX: 执行节点 i（状态浅拷贝）
            EX--&gt;&gt;GA: 节点开始事件(author=nodeID)
        and
            EX-&gt;&gt;EX: 执行节点 j（状态浅拷贝）
            EX--&gt;&gt;GA: 节点开始事件
        end

        alt 节点触发 Interrupt(key,prompt)
            EX-&gt;&gt;CK: Save checkpoint(state,frontier,
            EX-&gt;&gt;CK: pending_writes,versions_seen,reason=interrupt)
            CK-&gt;&gt;DB: 原子提交
            EX--&gt;&gt;GA: interrupt 事件(checkpoint_id,prompt)
            GA--&gt;&gt;R: 转发中断事件并暂停
            R-&gt;&gt;H: 请求人工输入/审批
            H--&gt;&gt;R: 提交决策/值
            R-&gt;&gt;GA: Run(resume) runtime_state{
            R-&gt;&gt;GA: checkpoint_id,resume_map}
            GA-&gt;&gt;EX: ResumeFromCheckpoint(checkpoint_id,resume_map)
            EX-&gt;&gt;CK: Load checkpoint
            CK-&gt;&gt;EX: state/frontier/pending_writes/versions_seen
            EX-&gt;&gt;EX: 重建前沿并应用恢复值
        else 正常执行
            EX--&gt;&gt;GA: 节点完成事件（含 tool/model 事件）
            EX-&gt;&gt;EX: Update — Reducer 合并状态
            EX-&gt;&gt;CK: Save checkpoint(state,frontier,
            EX-&gt;&gt;CK: pending_writes,versions_seen)
            CK-&gt;&gt;DB: 原子提交
        end
    end

    Note over EX,CK: versions_seen 避免重复执行；
    Note over EX,CK: pending_writes 重建通道；
    Note over EX,CK: parent_id 形成谱系以支持时间旅行

    opt 时间旅行（回溯/分支）
        R-&gt;&gt;GA: Run(runtime_state{checkpoint_id})
        GA-&gt;&gt;EX: ResumeFromCheckpoint(checkpoint_id)
        EX-&gt;&gt;CK: Load checkpoint + lineage
        CK-&gt;&gt;EX: 恢复状态并可创建新 lineage_id
    end

    EX--&gt;&gt;GA: done 事件（last_response）
    GA--&gt;&gt;R: 输出最终消息</code></pre>
<pre class="mermaid"><code>flowchart TB
    %% 执行全景图（精简连线）
    subgraph Client
        R[Runner]:::runner --&gt; GA[GraphAgent]:::agent
    end

    subgraph Engine[Graph Engine]
        GA --&gt; EX[Executor]:::executor
        subgraph BSP["BSP Superstep"]
            P[Planning]:::phase --&gt; X[Execution]:::phase --&gt; U[Update]:::phase
        end
    end

    N[Nodes: LLM / Tools / Function / Agent]:::process
    CK[(Checkpoint)]:::storage
    H[Human]:::human

    EX --&gt; BSP
    EX --&gt; N
    EX -.-&gt; CK
    GA &lt;--&gt; H
    GA --&gt; R

    classDef runner fill:#e8f5e9,stroke:#43a047,stroke-width:2px
    classDef agent fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    classDef executor fill:#e0f2f1,stroke:#00796b,stroke-width:2px
    classDef phase fill:#ede7f6,stroke:#512da8,stroke-width:2px
    classDef process fill:#f3e5f5,stroke:#9c27b0,stroke-width:2px
    classDef storage fill:#efebe9,stroke:#6d4c41,stroke-width:2px
    classDef human fill:#e8f5e9,stroke:#43a047,stroke-width:2px</code></pre>
<p>执行过程的关键点：</p>
<ol>
<li><strong>Planning Phase</strong>: 基于通道状态确定本步要执行的节点</li>
<li><strong>Execution Phase</strong>: 每个节点获得状态的浅拷贝（maps.Copy），并行执行</li>
<li><strong>Update Phase</strong>: 通过 Reducer 合并各节点的状态更新，保证并发安全</li>
</ol>
<p>这种设计让每一步都能被清晰观测、安全中断和恢复。</p>
<h4 id="_24">运行态隔离与事件快照</h4>
<ul>
<li>执行器（Executor）可复用且并发安全，单次运行态存放于 <code>ExecutionContext</code>，包括通道版本、待写（pending writes）、最近检查点等。</li>
<li>事件的 <code>StateDelta</code> 使用深拷贝快照，只包含可序列化且允许的键；内部键（如执行上下文、回调等）会被过滤，便于带外观测与持久化。</li>
</ul>
<h3 id="_25">执行器配置</h3>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-64-1">1</a></span>
<span class="normal"><a href="#__codelineno-64-2">2</a></span>
<span class="normal"><a href="#__codelineno-64-3">3</a></span>
<span class="normal"><a href="#__codelineno-64-4">4</a></span>
<span class="normal"><a href="#__codelineno-64-5">5</a></span>
<span class="normal"><a href="#__codelineno-64-6">6</a></span>
<span class="normal"><a href="#__codelineno-64-7">7</a></span>
<span class="normal"><a href="#__codelineno-64-8">8</a></span>
<span class="normal"><a href="#__codelineno-64-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-64-1"><a id="__codelineno-64-1" name="__codelineno-64-1"></a><span class="nx">exec</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewExecutor</span><span class="p">(</span><span class="nx">g</span><span class="p">,</span>
</span><span id="__span-64-2"><a id="__codelineno-64-2" name="__codelineno-64-2"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithChannelBufferSize</span><span class="p">(</span><span class="mi">1024</span><span class="p">),</span><span class="w">              </span><span class="c1">// 事件通道缓冲</span>
</span><span id="__span-64-3"><a id="__codelineno-64-3" name="__codelineno-64-3"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithMaxSteps</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span><span class="w">                          </span><span class="c1">// 最大步数</span>
</span><span id="__span-64-4"><a id="__codelineno-64-4" name="__codelineno-64-4"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithMaxConcurrency</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="w">                     </span><span class="c1">// 并行任务数</span>
</span><span id="__span-64-5"><a id="__codelineno-64-5" name="__codelineno-64-5"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithStepTimeout</span><span class="p">(</span><span class="mi">5</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span><span class="p">),</span><span class="w">            </span><span class="c1">// 步骤超时</span>
</span><span id="__span-64-6"><a id="__codelineno-64-6" name="__codelineno-64-6"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithNodeTimeout</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span><span class="p">),</span><span class="w">            </span><span class="c1">// 节点超时</span>
</span><span id="__span-64-7"><a id="__codelineno-64-7" name="__codelineno-64-7"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithCheckpointSaver</span><span class="p">(</span><span class="nx">saver</span><span class="p">),</span><span class="w">                </span><span class="c1">// 开启检查点（如 sqlite/inmemory）</span>
</span><span id="__span-64-8"><a id="__codelineno-64-8" name="__codelineno-64-8"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithCheckpointSaveTimeout</span><span class="p">(</span><span class="mi">30</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">),</span><span class="w"> </span><span class="c1">// 检查点保存超时</span>
</span><span id="__span-64-9"><a id="__codelineno-64-9" name="__codelineno-64-9"></a><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<h2 id="agent_5">与多 Agent 系统集成</h2>
<p>GraphAgent 的设计初衷就是成为 tRPC-Agent-Go 多 Agent 生态的一部分，而不是独立存在。它实现了标准的 Agent 接口，可以和其他 Agent 类型无缝协作。</p>
<h3 id="graphagent-agent">GraphAgent 作为 Agent</h3>
<p>GraphAgent 实现了标准 Agent 接口：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-65-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-65-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-65-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-65-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-65-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-65-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-65-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-65-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-65-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-65-10">10</a></span>
<span class="normal"><a href="#__codelineno-65-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-65-1"><a id="__codelineno-65-1" name="__codelineno-65-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-65-2"><a id="__codelineno-65-2" name="__codelineno-65-2"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/agent&quot;</span>
</span><span id="__span-65-3"><a id="__codelineno-65-3" name="__codelineno-65-3"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/agent/chainagent&quot;</span>
</span><span id="__span-65-4"><a id="__codelineno-65-4" name="__codelineno-65-4"></a><span class="p">)</span>
</span><span id="__span-65-5"><a id="__codelineno-65-5" name="__codelineno-65-5"></a>
</span><span id="__span-65-6"><a id="__codelineno-65-6" name="__codelineno-65-6"></a><span class="c1">// 可以直接在 ChainAgent, ParallelAgent, CycleAgent 中使用</span>
</span><span id="__span-65-7"><a id="__codelineno-65-7" name="__codelineno-65-7"></a><span class="nx">chain</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">chainagent</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;chain&quot;</span><span class="p">,</span>
</span><span id="__span-65-8"><a id="__codelineno-65-8" name="__codelineno-65-8"></a><span class="w">    </span><span class="nx">chainagent</span><span class="p">.</span><span class="nx">WithSubAgents</span><span class="p">([]</span><span class="nx">agent</span><span class="p">.</span><span class="nx">Agent</span><span class="p">{</span>
</span><span id="__span-65-9"><a id="__codelineno-65-9" name="__codelineno-65-9"></a><span class="w">        </span><span class="nx">graphAgent1</span><span class="p">,</span><span class="w">  </span><span class="c1">// 结构化流程1</span>
</span><span id="__span-65-10"><a id="__codelineno-65-10" name="__codelineno-65-10"></a><span class="w">        </span><span class="nx">graphAgent2</span><span class="p">,</span><span class="w">  </span><span class="c1">// 结构化流程2</span>
</span><span id="__span-65-11"><a id="__codelineno-65-11" name="__codelineno-65-11"></a><span class="w">    </span><span class="p">}))</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="_26">高级编排</h3>
<p>下图展示复杂业务编排：入口清洗 → 智能路由 → 多子编队（Email、Weather、Research）→ 并行 fanout/聚合 → 最终合成与发布。</p>
<pre class="mermaid"><code>flowchart LR
    %% Layout
    subgraph UE["User &amp; Entry"]
        U((User)):::human --&gt; IN["entry&lt;br/&gt;normalize"]:::process
    end

    subgraph FAB["Graph Orchestration"]
        Rtr["where_to_go&lt;br/&gt;router"]:::router
        Compose["compose&lt;br/&gt;LLM"]:::llm
    end

    IN --&gt; Rtr

    %% Email Agent (expanded)
    subgraph EC["Email Agent"]
        direction LR
        CE["classifier&lt;br/&gt;LLM"]:::llm --&gt; WE["writer&lt;br/&gt;LLM"]:::llm
    end

    %% Weather Agent (expanded)
    subgraph WA["Weather Agent"]
        direction LR
        LE["locate&lt;br/&gt;LLM"]:::llm --&gt; WT["weather tool"]:::tool
    end

    %% Routing from router to pods
    Rtr -- email --&gt; CE
    Rtr -- weather --&gt; LE
    Rtr -- other --&gt; REPLY["reply&lt;br/&gt;LLM"]:::llm

    %% Fanout Pipeline (fanout → workers → aggregate)
    subgraph FP["Fanout Pipeline"]
        direction LR
        Fan["plan_fanout"]:::process --&gt; W1["worker A"]:::process
        Fan --&gt; W2["worker B"]:::process
        Fan --&gt; W3["worker C"]:::process
        W1 --&gt; Agg["aggregate"]:::process
        W2 --&gt; Agg
        W3 --&gt; Agg
    end
    Rtr -- research --&gt; Fan

    %% Human-in-the-loop (optional)
    Compose -. review .- HG["human&lt;br/&gt;review"]:::human

    %% Compose final (minimal wiring)
    Agg --&gt; Compose
    WE --&gt; Compose
    WT --&gt; Compose
    REPLY --&gt; Compose
    Compose --&gt; END([END]):::terminal

    %% Styles
    classDef router fill:#fff7e0,stroke:#f5a623,stroke-width:2px
    classDef llm fill:#e3f2fd,stroke:#1e88e5,stroke-width:2px
    classDef tool fill:#fff3e0,stroke:#fb8c00,stroke-width:2px
    classDef process fill:#f3e5f5,stroke:#8e24aa,stroke-width:2px
    classDef human fill:#e8f5e9,stroke:#43a047,stroke-width:2px
    classDef terminal fill:#ffebee,stroke:#e53935,stroke-width:2px</code></pre>
<p>要点：</p>
<ul>
<li>智能路由 where_to_go 可由 LLM 决策或函数节点实现（条件边）。</li>
<li>Fanout Pipeline 使用 Command GoTo 进行运行时 fanout，三路并行后在 aggregate 节点聚合。</li>
<li>可选的人机把关位于聚合之后，确保关键输出经人工确认。</li>
<li>仅在 Compose 处展示一次保存检查点，既不喧宾夺主，又能体现可恢复能力。</li>
</ul>
<h3 id="agent_6">在图中嵌入 Agent</h3>
<p>在图内部，我们也可以把已有的子 Agent 作为一个节点来调用。下面的示例展示了如何创建子 Agent、声明对应节点，并在 GraphAgent 构造时注入。</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-66-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-66-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-66-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-66-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-66-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-66-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-66-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-66-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-66-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-66-10">10</a></span>
<span class="normal"><a href="#__codelineno-66-11">11</a></span>
<span class="normal"><a href="#__codelineno-66-12">12</a></span>
<span class="normal"><a href="#__codelineno-66-13">13</a></span>
<span class="normal"><a href="#__codelineno-66-14">14</a></span>
<span class="normal"><a href="#__codelineno-66-15">15</a></span>
<span class="normal"><a href="#__codelineno-66-16">16</a></span>
<span class="normal"><a href="#__codelineno-66-17">17</a></span>
<span class="normal"><a href="#__codelineno-66-18">18</a></span>
<span class="normal"><a href="#__codelineno-66-19">19</a></span>
<span class="normal"><a href="#__codelineno-66-20">20</a></span>
<span class="normal"><a href="#__codelineno-66-21">21</a></span>
<span class="normal"><a href="#__codelineno-66-22">22</a></span>
<span class="normal"><a href="#__codelineno-66-23">23</a></span>
<span class="normal"><a href="#__codelineno-66-24">24</a></span>
<span class="normal"><a href="#__codelineno-66-25">25</a></span>
<span class="normal"><a href="#__codelineno-66-26">26</a></span>
<span class="normal"><a href="#__codelineno-66-27">27</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-66-1"><a id="__codelineno-66-1" name="__codelineno-66-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-66-2"><a id="__codelineno-66-2" name="__codelineno-66-2"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/agent&quot;</span>
</span><span id="__span-66-3"><a id="__codelineno-66-3" name="__codelineno-66-3"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/agent/graphagent&quot;</span>
</span><span id="__span-66-4"><a id="__codelineno-66-4" name="__codelineno-66-4"></a><span class="p">)</span>
</span><span id="__span-66-5"><a id="__codelineno-66-5" name="__codelineno-66-5"></a>
</span><span id="__span-66-6"><a id="__codelineno-66-6" name="__codelineno-66-6"></a><span class="c1">// 创建子 Agent</span>
</span><span id="__span-66-7"><a id="__codelineno-66-7" name="__codelineno-66-7"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-66-8"><a id="__codelineno-66-8" name="__codelineno-66-8"></a><span class="w">    </span><span class="nx">subAgentAnalyzer</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;analyzer&quot;</span>
</span><span id="__span-66-9"><a id="__codelineno-66-9" name="__codelineno-66-9"></a><span class="w">    </span><span class="nx">subAgentReviewer</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;reviewer&quot;</span>
</span><span id="__span-66-10"><a id="__codelineno-66-10" name="__codelineno-66-10"></a><span class="p">)</span>
</span><span id="__span-66-11"><a id="__codelineno-66-11" name="__codelineno-66-11"></a><span class="nx">analyzer</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">createAnalyzer</span><span class="p">()</span><span class="w">  </span><span class="c1">// 名称必须是 &quot;analyzer&quot;</span>
</span><span id="__span-66-12"><a id="__codelineno-66-12" name="__codelineno-66-12"></a><span class="nx">reviewer</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">createReviewer</span><span class="p">()</span><span class="w">  </span><span class="c1">// 名称必须是 &quot;reviewer&quot;</span>
</span><span id="__span-66-13"><a id="__codelineno-66-13" name="__codelineno-66-13"></a>
</span><span id="__span-66-14"><a id="__codelineno-66-14" name="__codelineno-66-14"></a><span class="c1">// 在图中声明 Agent 节点</span>
</span><span id="__span-66-15"><a id="__codelineno-66-15" name="__codelineno-66-15"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddAgentNode</span><span class="p">(</span><span class="nx">subAgentAnalyzer</span><span class="p">)</span>
</span><span id="__span-66-16"><a id="__codelineno-66-16" name="__codelineno-66-16"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddAgentNode</span><span class="p">(</span><span class="nx">subAgentReviewer</span><span class="p">)</span>
</span><span id="__span-66-17"><a id="__codelineno-66-17" name="__codelineno-66-17"></a>
</span><span id="__span-66-18"><a id="__codelineno-66-18" name="__codelineno-66-18"></a><span class="c1">// 创建 GraphAgent 时注入子 Agent</span>
</span><span id="__span-66-19"><a id="__codelineno-66-19" name="__codelineno-66-19"></a><span class="nx">graphAgent</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;workflow&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">g</span><span class="p">,</span>
</span><span id="__span-66-20"><a id="__codelineno-66-20" name="__codelineno-66-20"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithSubAgents</span><span class="p">([]</span><span class="nx">agent</span><span class="p">.</span><span class="nx">Agent</span><span class="p">{</span>
</span><span id="__span-66-21"><a id="__codelineno-66-21" name="__codelineno-66-21"></a><span class="w">        </span><span class="nx">analyzer</span><span class="p">,</span>
</span><span id="__span-66-22"><a id="__codelineno-66-22" name="__codelineno-66-22"></a><span class="w">        </span><span class="nx">reviewer</span><span class="p">,</span>
</span><span id="__span-66-23"><a id="__codelineno-66-23" name="__codelineno-66-23"></a><span class="w">    </span><span class="p">}))</span>
</span><span id="__span-66-24"><a id="__codelineno-66-24" name="__codelineno-66-24"></a>
</span><span id="__span-66-25"><a id="__codelineno-66-25" name="__codelineno-66-25"></a><span class="c1">// I/O：子 Agent 既会把 graph.StateKeyUserInput 作为消息传入，也能通过</span>
</span><span id="__span-66-26"><a id="__codelineno-66-26" name="__codelineno-66-26"></a><span class="c1">// inv.RunOptions.RuntimeState 读取完整图状态；完成后会更新</span>
</span><span id="__span-66-27"><a id="__codelineno-66-27" name="__codelineno-66-27"></a><span class="c1">// graph.StateKeyLastResponse 以及 graph.StateKeyNodeResponses[nodeID]</span>
</span></code></pre></div></td></tr></table></div>
<h4 id="last_response-user_input">只传结果：将 last_response 映射为下游 user_input</h4>
<blockquote>
<p>场景：A → B → C 互为黑盒，不希望下游读取完整会话，只需要上游的“结果文本”作为本轮输入。</p>
</blockquote>
<ul>
<li>方式一（无需依赖，推荐通用）：在目标 Agent 节点添加前置回调，把父态 <code>last_response</code> 写入 <code>user_input</code>，必要时开启“消息隔离”。</li>
</ul>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-67-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-67-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-67-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-67-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-67-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-67-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-67-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-67-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-67-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-67-10">10</a></span>
<span class="normal"><a href="#__codelineno-67-11">11</a></span>
<span class="normal"><a href="#__codelineno-67-12">12</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-67-1"><a id="__codelineno-67-1" name="__codelineno-67-1"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddAgentNode</span><span class="p">(</span><span class="s">&quot;orchestrator&quot;</span><span class="p">,</span>
</span><span id="__span-67-2"><a id="__codelineno-67-2" name="__codelineno-67-2"></a><span class="w">    </span><span class="c1">// 将上游 last_response 设置为本轮 user_input</span>
</span><span id="__span-67-3"><a id="__codelineno-67-3" name="__codelineno-67-3"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithPreNodeCallback</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">cb</span><span class="w"> </span><span class="o">*</span><span class="nx">graph</span><span class="p">.</span><span class="nx">NodeCallbackContext</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-67-4"><a id="__codelineno-67-4" name="__codelineno-67-4"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">v</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">s</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyLastResponse</span><span class="p">].(</span><span class="kt">string</span><span class="p">);</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">v</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-67-5"><a id="__codelineno-67-5" name="__codelineno-67-5"></a><span class="w">            </span><span class="nx">s</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyUserInput</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">v</span>
</span><span id="__span-67-6"><a id="__codelineno-67-6" name="__codelineno-67-6"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-67-7"><a id="__codelineno-67-7" name="__codelineno-67-7"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-67-8"><a id="__codelineno-67-8" name="__codelineno-67-8"></a><span class="w">    </span><span class="p">}),</span>
</span><span id="__span-67-9"><a id="__codelineno-67-9" name="__codelineno-67-9"></a><span class="w">    </span><span class="c1">// 可选：隔离子 Agent 的会话注入，仅消费本轮 user_input。</span>
</span><span id="__span-67-10"><a id="__codelineno-67-10" name="__codelineno-67-10"></a><span class="w">    </span><span class="c1">// 仅在子 Agent 单轮即可完成（不需要工具多轮）时使用。</span>
</span><span id="__span-67-11"><a id="__codelineno-67-11" name="__codelineno-67-11"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithSubgraphIsolatedMessages</span><span class="p">(</span><span class="kc">true</span><span class="p">),</span>
</span><span id="__span-67-12"><a id="__codelineno-67-12" name="__codelineno-67-12"></a><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<ul>
<li>方式二（使用增强选项，更简洁）：</li>
</ul>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-68-1">1</a></span>
<span class="normal"><a href="#__codelineno-68-2">2</a></span>
<span class="normal"><a href="#__codelineno-68-3">3</a></span>
<span class="normal"><a href="#__codelineno-68-4">4</a></span>
<span class="normal"><a href="#__codelineno-68-5">5</a></span>
<span class="normal"><a href="#__codelineno-68-6">6</a></span>
<span class="normal"><a href="#__codelineno-68-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-68-1"><a id="__codelineno-68-1" name="__codelineno-68-1"></a><span class="c1">// 框架提供声明式 Option，自动执行 last_response → user_input 的映射</span>
</span><span id="__span-68-2"><a id="__codelineno-68-2" name="__codelineno-68-2"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddAgentNode</span><span class="p">(</span><span class="s">&quot;orchestrator&quot;</span><span class="p">,</span>
</span><span id="__span-68-3"><a id="__codelineno-68-3" name="__codelineno-68-3"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithSubgraphInputFromLastResponse</span><span class="p">(),</span>
</span><span id="__span-68-4"><a id="__codelineno-68-4" name="__codelineno-68-4"></a><span class="w">    </span><span class="c1">// 可选：配合隔离达到“只传结果”。</span>
</span><span id="__span-68-5"><a id="__codelineno-68-5" name="__codelineno-68-5"></a><span class="w">    </span><span class="c1">// 仅在子 Agent 单轮即可完成（不需要工具多轮）时使用。</span>
</span><span id="__span-68-6"><a id="__codelineno-68-6" name="__codelineno-68-6"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithSubgraphIsolatedMessages</span><span class="p">(</span><span class="kc">true</span><span class="p">),</span>
</span><span id="__span-68-7"><a id="__codelineno-68-7" name="__codelineno-68-7"></a><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>说明：以上两种方式都能让 B 仅看到 A 的结果、C 仅看到 B 的结果；方式二更简洁，方式一零依赖、到处可用。</p>
<h3 id="_27">混合模式示例</h3>
<p>结构化流程中嵌入动态决策：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-69-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-69-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-69-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-69-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-69-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-69-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-69-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-69-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-69-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-69-10">10</a></span>
<span class="normal"><a href="#__codelineno-69-11">11</a></span>
<span class="normal"><a href="#__codelineno-69-12">12</a></span>
<span class="normal"><a href="#__codelineno-69-13">13</a></span>
<span class="normal"><a href="#__codelineno-69-14">14</a></span>
<span class="normal"><a href="#__codelineno-69-15">15</a></span>
<span class="normal"><a href="#__codelineno-69-16">16</a></span>
<span class="normal"><a href="#__codelineno-69-17">17</a></span>
<span class="normal"><a href="#__codelineno-69-18">18</a></span>
<span class="normal"><a href="#__codelineno-69-19">19</a></span>
<span class="normal"><a href="#__codelineno-69-20">20</a></span>
<span class="normal"><a href="#__codelineno-69-21">21</a></span>
<span class="normal"><a href="#__codelineno-69-22">22</a></span>
<span class="normal"><a href="#__codelineno-69-23">23</a></span>
<span class="normal"><a href="#__codelineno-69-24">24</a></span>
<span class="normal"><a href="#__codelineno-69-25">25</a></span>
<span class="normal"><a href="#__codelineno-69-26">26</a></span>
<span class="normal"><a href="#__codelineno-69-27">27</a></span>
<span class="normal"><a href="#__codelineno-69-28">28</a></span>
<span class="normal"><a href="#__codelineno-69-29">29</a></span>
<span class="normal"><a href="#__codelineno-69-30">30</a></span>
<span class="normal"><a href="#__codelineno-69-31">31</a></span>
<span class="normal"><a href="#__codelineno-69-32">32</a></span>
<span class="normal"><a href="#__codelineno-69-33">33</a></span>
<span class="normal"><a href="#__codelineno-69-34">34</a></span>
<span class="normal"><a href="#__codelineno-69-35">35</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-69-1"><a id="__codelineno-69-1" name="__codelineno-69-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-69-2"><a id="__codelineno-69-2" name="__codelineno-69-2"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/agent&quot;</span>
</span><span id="__span-69-3"><a id="__codelineno-69-3" name="__codelineno-69-3"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/agent/chainagent&quot;</span>
</span><span id="__span-69-4"><a id="__codelineno-69-4" name="__codelineno-69-4"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/agent/graphagent&quot;</span>
</span><span id="__span-69-5"><a id="__codelineno-69-5" name="__codelineno-69-5"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-69-6"><a id="__codelineno-69-6" name="__codelineno-69-6"></a><span class="p">)</span>
</span><span id="__span-69-7"><a id="__codelineno-69-7" name="__codelineno-69-7"></a>
</span><span id="__span-69-8"><a id="__codelineno-69-8" name="__codelineno-69-8"></a><span class="nx">sg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateGraph</span><span class="p">(</span><span class="nx">schema</span><span class="p">)</span>
</span><span id="__span-69-9"><a id="__codelineno-69-9" name="__codelineno-69-9"></a>
</span><span id="__span-69-10"><a id="__codelineno-69-10" name="__codelineno-69-10"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-69-11"><a id="__codelineno-69-11" name="__codelineno-69-11"></a><span class="w">    </span><span class="nx">nodePrepare</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;prepare&quot;</span>
</span><span id="__span-69-12"><a id="__codelineno-69-12" name="__codelineno-69-12"></a><span class="w">    </span><span class="nx">nodeAnalyzer</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;analyzer&quot;</span>
</span><span id="__span-69-13"><a id="__codelineno-69-13" name="__codelineno-69-13"></a><span class="w">    </span><span class="nx">nodeFinalize</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;finalize&quot;</span>
</span><span id="__span-69-14"><a id="__codelineno-69-14" name="__codelineno-69-14"></a><span class="p">)</span>
</span><span id="__span-69-15"><a id="__codelineno-69-15" name="__codelineno-69-15"></a>
</span><span id="__span-69-16"><a id="__codelineno-69-16" name="__codelineno-69-16"></a><span class="c1">// 结构化的数据准备</span>
</span><span id="__span-69-17"><a id="__codelineno-69-17" name="__codelineno-69-17"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="nx">nodePrepare</span><span class="p">,</span><span class="w"> </span><span class="nx">prepareData</span><span class="p">)</span>
</span><span id="__span-69-18"><a id="__codelineno-69-18" name="__codelineno-69-18"></a>
</span><span id="__span-69-19"><a id="__codelineno-69-19" name="__codelineno-69-19"></a><span class="c1">// 动态决策点 - 使用 ChainAgent</span>
</span><span id="__span-69-20"><a id="__codelineno-69-20" name="__codelineno-69-20"></a><span class="nx">dynamicAgent</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">chainagent</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="nx">nodeAnalyzer</span><span class="p">,</span>
</span><span id="__span-69-21"><a id="__codelineno-69-21" name="__codelineno-69-21"></a><span class="w">    </span><span class="nx">chainagent</span><span class="p">.</span><span class="nx">WithSubAgents</span><span class="p">([]</span><span class="nx">agent</span><span class="p">.</span><span class="nx">Agent</span><span class="p">{</span><span class="o">...</span><span class="p">}))</span>
</span><span id="__span-69-22"><a id="__codelineno-69-22" name="__codelineno-69-22"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddAgentNode</span><span class="p">(</span><span class="nx">nodeAnalyzer</span><span class="p">)</span>
</span><span id="__span-69-23"><a id="__codelineno-69-23" name="__codelineno-69-23"></a>
</span><span id="__span-69-24"><a id="__codelineno-69-24" name="__codelineno-69-24"></a><span class="c1">// 继续结构化流程</span>
</span><span id="__span-69-25"><a id="__codelineno-69-25" name="__codelineno-69-25"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="nx">nodeFinalize</span><span class="p">,</span><span class="w"> </span><span class="nx">finalizeResults</span><span class="p">)</span>
</span><span id="__span-69-26"><a id="__codelineno-69-26" name="__codelineno-69-26"></a>
</span><span id="__span-69-27"><a id="__codelineno-69-27" name="__codelineno-69-27"></a><span class="c1">// 连接流程</span>
</span><span id="__span-69-28"><a id="__codelineno-69-28" name="__codelineno-69-28"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">SetEntryPoint</span><span class="p">(</span><span class="nx">nodePrepare</span><span class="p">)</span>
</span><span id="__span-69-29"><a id="__codelineno-69-29" name="__codelineno-69-29"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddEdge</span><span class="p">(</span><span class="nx">nodePrepare</span><span class="p">,</span><span class="w"> </span><span class="nx">nodeAnalyzer</span><span class="p">)</span><span class="w">     </span><span class="c1">// 交给动态 Agent</span>
</span><span id="__span-69-30"><a id="__codelineno-69-30" name="__codelineno-69-30"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddEdge</span><span class="p">(</span><span class="nx">nodeAnalyzer</span><span class="p">,</span><span class="w"> </span><span class="nx">nodeFinalize</span><span class="p">)</span><span class="w">    </span><span class="c1">// 回到结构化流程</span>
</span><span id="__span-69-31"><a id="__codelineno-69-31" name="__codelineno-69-31"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">SetFinishPoint</span><span class="p">(</span><span class="nx">nodeFinalize</span><span class="p">)</span>
</span><span id="__span-69-32"><a id="__codelineno-69-32" name="__codelineno-69-32"></a>
</span><span id="__span-69-33"><a id="__codelineno-69-33" name="__codelineno-69-33"></a><span class="c1">// 创建时注入</span>
</span><span id="__span-69-34"><a id="__codelineno-69-34" name="__codelineno-69-34"></a><span class="nx">graphAgent</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;hybrid&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">g</span><span class="p">,</span>
</span><span id="__span-69-35"><a id="__codelineno-69-35" name="__codelineno-69-35"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithSubAgents</span><span class="p">([]</span><span class="nx">agent</span><span class="p">.</span><span class="nx">Agent</span><span class="p">{</span><span class="nx">dynamicAgent</span><span class="p">}))</span>
</span></code></pre></div></td></tr></table></div>
<h2 id="_28">核心机制详解</h2>
<h3 id="schema-reducer">状态管理：Schema + Reducer 模式</h3>
<p>状态管理是图工作流的核心挑战之一。我们设计了一套基于 Schema + Reducer 的状态管理机制，既保证了类型安全，又支持高并发的原子更新。</p>
<pre class="mermaid"><code>flowchart LR
    subgraph "State Schema"
        MS[messages: MessageList]:::schemaClass
        UI[user_input: string]:::schemaClass
        LR[last_response: string]:::schemaClass
        NR[node_responses: Map]:::schemaClass
    end

    subgraph "State Operations"
        R1[MessageReducer]:::reducerClass
        R2[AppendReducer]:::reducerClass
        R3[DefaultReducer]:::reducerClass
    end

    subgraph "Concurrent Updates"
        N1[Node 1 Output]:::nodeOutputClass
        N2[Node 2 Output]:::nodeOutputClass
        N3[Node 3 Output]:::nodeOutputClass
    end

    N1 --&gt; R1
    N2 --&gt; R2
    N3 --&gt; R3
    R1 --&gt; MS
    R2 --&gt; NR
    R3 --&gt; LR

    classDef schemaClass fill:#e3f2fd,stroke:#1565c0,stroke-width:2px
    classDef reducerClass fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    classDef nodeOutputClass fill:#fff8e1,stroke:#f57f17,stroke-width:2px</code></pre>
<p>Graph 的状态底层是 <code>map[string]any</code>，通过 <code>StateSchema</code> 提供运行时类型校验和字段验证。Reducer 机制确保状态字段按预定义规则安全合并，避免并发更新冲突。</p>
<h4 id="_29">常用键常量参考</h4>
<ul>
<li>用户可见：<code>graph.StateKeyUserInput</code>、<code>graph.StateKeyOneShotMessages</code>、
  <code>graph.StateKeyOneShotMessagesByNode</code>、<code>graph.StateKeyMessages</code>、
  <code>graph.StateKeyLastResponse</code>、<code>graph.StateKeyLastResponseID</code>、
  <code>graph.StateKeyNodeResponses</code>、<code>graph.StateKeyMetadata</code></li>
<li>系统内部：<code>session</code>、<code>exec_context</code>、<code>tool_callbacks</code>、<code>model_callbacks</code>、<code>agent_callbacks</code>、<code>current_node_id</code>、<code>parent_agent</code></li>
<li>命令/恢复：<code>__command__</code>、<code>__resume_map__</code></li>
</ul>
<p>常量均定义在 <code>graph/state.go</code> 与 <code>graph/keys.go</code>，建议通过常量引用，避免硬编码。</p>
<h4 id="_30">节点级回调、工具与生成参数</h4>
<p>节点可通过可选项注册回调或参数（见 <code>graph/state_graph.go</code>）：</p>
<ul>
<li><code>graph.WithPreNodeCallback</code> / <code>graph.WithPostNodeCallback</code> / <code>graph.WithNodeErrorCallback</code></li>
<li>LLM 节点可用 <code>graph.WithGenerationConfig</code>、<code>graph.WithModelCallbacks</code></li>
<li>工具相关：<code>graph.WithToolCallbacks</code>、<code>graph.WithToolSets</code>（除 <code>tools []tool.Tool</code> 外，再额外提供 ToolSet<code>）、</code>graph.WithRefreshToolSetsOnRun`（在每次运行时从 ToolSet 重新构造工具列表，适合 MCP 等动态工具源）</li>
<li>Agent 节点可用 <code>graph.WithAgentNodeEventCallback</code></li>
</ul>
<h4 id="call-options-run">调用级 Call Options（按本次 Run 覆盖）</h4>
<p><code>graph.WithGenerationConfig(...)</code> 是<strong>构图期</strong>配置：你在构建图时设置它。
但在真实业务里，经常需要<strong>运行时</strong>控制：同一张图，不同请求用不同的采样
策略（比如 temperature / max_tokens），并且还能精确打到某个节点或子图里。</p>
<p>Graph 通过 <strong>call options</strong> 支持这件事：它们会被挂到
<code>Invocation.RunOptions</code> 上，并且在 GraphAgent 调用子 GraphAgent（Agent 节点）
时自动向下传递。</p>
<p>典型场景：</p>
<ul>
<li>请求 A 希望更保守（低 temperature），请求 B 希望更发散（高 temperature）。</li>
<li>同一张图里有多个 LLM 节点，需要不同节点使用不同参数。</li>
<li>父图通过 Agent 节点调用子图，希望覆盖只在子图内部生效。</li>
</ul>
<p>API：</p>
<ul>
<li><code>graph.WithCallOptions(...)</code>：把 call options 绑定到本次运行。</li>
<li><code>graph.WithCallGenerationConfigPatch(...)</code>：在当前图作用域内，对 LLM 节点的
  <code>model.GenerationConfig</code> 做“按字段覆盖”。</li>
<li><code>graph.DesignateNode(nodeID, ...)</code>：把覆盖精确打到当前图中的某个节点。<ul>
<li>对 LLM 节点：影响该节点的模型调用。</li>
<li>对 Agent 节点（子图）：影响子 Invocation，因此会成为子图的默认覆盖。</li>
</ul>
</li>
<li><code>graph.DesignateNodeWithPath(graph.NodePath{...}, ...)</code>：把覆盖打到嵌套子图
  内部的某个节点（path 的每一段都是节点 ID）。</li>
</ul>
<p>Patch 说明：</p>
<ul>
<li>使用 <code>model.GenerationConfigPatch</code>，只设置你想覆盖的字段即可。</li>
<li>指针字段用 <code>nil</code> 表示“不覆盖”，一般用 <code>model.Float64Ptr</code>、<code>model.IntPtr</code>
  等辅助函数来创建指针。</li>
<li><code>Stop</code>：<code>nil</code> 表示“不覆盖”；空 slice 表示清空 stop sequences。</li>
</ul>
<p>示例：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-70-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-70-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-70-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-70-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-70-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-70-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-70-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-70-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-70-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-70-10">10</a></span>
<span class="normal"><a href="#__codelineno-70-11">11</a></span>
<span class="normal"><a href="#__codelineno-70-12">12</a></span>
<span class="normal"><a href="#__codelineno-70-13">13</a></span>
<span class="normal"><a href="#__codelineno-70-14">14</a></span>
<span class="normal"><a href="#__codelineno-70-15">15</a></span>
<span class="normal"><a href="#__codelineno-70-16">16</a></span>
<span class="normal"><a href="#__codelineno-70-17">17</a></span>
<span class="normal"><a href="#__codelineno-70-18">18</a></span>
<span class="normal"><a href="#__codelineno-70-19">19</a></span>
<span class="normal"><a href="#__codelineno-70-20">20</a></span>
<span class="normal"><a href="#__codelineno-70-21">21</a></span>
<span class="normal"><a href="#__codelineno-70-22">22</a></span>
<span class="normal"><a href="#__codelineno-70-23">23</a></span>
<span class="normal"><a href="#__codelineno-70-24">24</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-70-1"><a id="__codelineno-70-1" name="__codelineno-70-1"></a><span class="nx">runOpts</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithCallOptions</span><span class="p">(</span>
</span><span id="__span-70-2"><a id="__codelineno-70-2" name="__codelineno-70-2"></a><span class="w">    </span><span class="c1">// 本次运行的全局覆盖（影响当前图内所有 LLM 节点）。</span>
</span><span id="__span-70-3"><a id="__codelineno-70-3" name="__codelineno-70-3"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithCallGenerationConfigPatch</span><span class="p">(</span><span class="nx">model</span><span class="p">.</span><span class="nx">GenerationConfigPatch</span><span class="p">{</span>
</span><span id="__span-70-4"><a id="__codelineno-70-4" name="__codelineno-70-4"></a><span class="w">        </span><span class="nx">Temperature</span><span class="p">:</span><span class="w"> </span><span class="nx">model</span><span class="p">.</span><span class="nx">Float64Ptr</span><span class="p">(</span><span class="mf">0.2</span><span class="p">),</span>
</span><span id="__span-70-5"><a id="__codelineno-70-5" name="__codelineno-70-5"></a><span class="w">    </span><span class="p">}),</span>
</span><span id="__span-70-6"><a id="__codelineno-70-6" name="__codelineno-70-6"></a>
</span><span id="__span-70-7"><a id="__codelineno-70-7" name="__codelineno-70-7"></a><span class="w">    </span><span class="c1">// 只覆盖当前图里的某个 LLM 节点。</span>
</span><span id="__span-70-8"><a id="__codelineno-70-8" name="__codelineno-70-8"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">DesignateNode</span><span class="p">(</span><span class="s">&quot;final_answer&quot;</span><span class="p">,</span>
</span><span id="__span-70-9"><a id="__codelineno-70-9" name="__codelineno-70-9"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithCallGenerationConfigPatch</span><span class="p">(</span><span class="nx">model</span><span class="p">.</span><span class="nx">GenerationConfigPatch</span><span class="p">{</span>
</span><span id="__span-70-10"><a id="__codelineno-70-10" name="__codelineno-70-10"></a><span class="w">            </span><span class="nx">MaxTokens</span><span class="p">:</span><span class="w"> </span><span class="nx">model</span><span class="p">.</span><span class="nx">IntPtr</span><span class="p">(</span><span class="mi">256</span><span class="p">),</span>
</span><span id="__span-70-11"><a id="__codelineno-70-11" name="__codelineno-70-11"></a><span class="w">        </span><span class="p">}),</span>
</span><span id="__span-70-12"><a id="__codelineno-70-12" name="__codelineno-70-12"></a><span class="w">    </span><span class="p">),</span>
</span><span id="__span-70-13"><a id="__codelineno-70-13" name="__codelineno-70-13"></a>
</span><span id="__span-70-14"><a id="__codelineno-70-14" name="__codelineno-70-14"></a><span class="w">    </span><span class="c1">// 覆盖嵌套子图里的某个节点：</span>
</span><span id="__span-70-15"><a id="__codelineno-70-15" name="__codelineno-70-15"></a><span class="w">    </span><span class="c1">// 节点 &quot;child_agent&quot;（Agent 节点）-&gt; 节点 &quot;llm&quot;（子图内部节点）。</span>
</span><span id="__span-70-16"><a id="__codelineno-70-16" name="__codelineno-70-16"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">DesignateNodeWithPath</span><span class="p">(</span>
</span><span id="__span-70-17"><a id="__codelineno-70-17" name="__codelineno-70-17"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NodePath</span><span class="p">{</span><span class="s">&quot;child_agent&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;llm&quot;</span><span class="p">},</span>
</span><span id="__span-70-18"><a id="__codelineno-70-18" name="__codelineno-70-18"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithCallGenerationConfigPatch</span><span class="p">(</span><span class="nx">model</span><span class="p">.</span><span class="nx">GenerationConfigPatch</span><span class="p">{</span>
</span><span id="__span-70-19"><a id="__codelineno-70-19" name="__codelineno-70-19"></a><span class="w">            </span><span class="nx">Temperature</span><span class="p">:</span><span class="w"> </span><span class="nx">model</span><span class="p">.</span><span class="nx">Float64Ptr</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span><span id="__span-70-20"><a id="__codelineno-70-20" name="__codelineno-70-20"></a><span class="w">        </span><span class="p">}),</span>
</span><span id="__span-70-21"><a id="__codelineno-70-21" name="__codelineno-70-21"></a><span class="w">    </span><span class="p">),</span>
</span><span id="__span-70-22"><a id="__codelineno-70-22" name="__codelineno-70-22"></a><span class="p">)</span>
</span><span id="__span-70-23"><a id="__codelineno-70-23" name="__codelineno-70-23"></a>
</span><span id="__span-70-24"><a id="__codelineno-70-24" name="__codelineno-70-24"></a><span class="nx">ch</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">userID</span><span class="p">,</span><span class="w"> </span><span class="nx">sessionID</span><span class="p">,</span><span class="w"> </span><span class="nx">msg</span><span class="p">,</span><span class="w"> </span><span class="nx">runOpts</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>可直接运行示例：<code>examples/graph/call_options_generation_config</code>。</p>
<h4 id="graph-toolset-agent">Graph 中的 ToolSet 与 Agent 的区别</h4>
<p><code>graph.WithToolSets</code> 是<strong>节点级、构图期</strong>配置：在构建图时，把一个或多个 <code>tool.ToolSet</code> 绑定到特定的 LLM 节点，例如：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-71-1">1</a></span>
<span class="normal"><a href="#__codelineno-71-2">2</a></span>
<span class="normal"><a href="#__codelineno-71-3">3</a></span>
<span class="normal"><a href="#__codelineno-71-4">4</a></span>
<span class="normal"><a href="#__codelineno-71-5">5</a></span>
<span class="normal"><a href="#__codelineno-71-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-71-1"><a id="__codelineno-71-1" name="__codelineno-71-1"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddLLMNode</span><span class="p">(</span><span class="s">&quot;llm&quot;</span><span class="p">,</span>
</span><span id="__span-71-2"><a id="__codelineno-71-2" name="__codelineno-71-2"></a><span class="w">    </span><span class="nx">model</span><span class="p">,</span>
</span><span id="__span-71-3"><a id="__codelineno-71-3" name="__codelineno-71-3"></a><span class="w">    </span><span class="s">&quot;inst&quot;</span><span class="p">,</span>
</span><span id="__span-71-4"><a id="__codelineno-71-4" name="__codelineno-71-4"></a><span class="w">    </span><span class="nx">tools</span><span class="p">,</span>
</span><span id="__span-71-5"><a id="__codelineno-71-5" name="__codelineno-71-5"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithToolSets</span><span class="p">([]</span><span class="nx">tool</span><span class="p">.</span><span class="nx">ToolSet</span><span class="p">{</span><span class="nx">mcpToolSet</span><span class="p">,</span><span class="w"> </span><span class="nx">fileToolSet</span><span class="p">}),</span>
</span><span id="__span-71-6"><a id="__codelineno-71-6" name="__codelineno-71-6"></a><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>需要注意：</p>
<ul>
<li>Graph 一旦 <code>Compile()</code>，结构（包括节点绑定的 ToolSet）就是<strong>不可变的</strong>。如果要调整某个节点的 ToolSet，需要重新构图或创建新的 <code>GraphAgent</code>。</li>
<li>运行时希望动态增删 ToolSet，应该在 Agent 层处理（例如使用 <code>llmagent.AddToolSet</code>、<code>llmagent.RemoveToolSet</code>、<code>llmagent.SetToolSets</code>），或者替换 Graph 中 Agent 节点所使用的下游 Agent。</li>
</ul>
<p>此外，<code>graph.WithName</code>/<code>graph.WithDescription</code> 可为节点添加友好的名称与描述；<code>graph.WithDestinations</code> 可声明潜在动态路由目标（仅用于静态校验/可视化）。</p>
<h3 id="llm_2">LLM 输入规则：三段式设计</h3>
<p>LLM 节点的输入处理是我们花了很多时间打磨的功能。看起来简单的三段式规则，实际上解决了 AI 应用中最常见的上下文管理问题。</p>
<p>LLM 节点内置了一套固定的输入选择逻辑（无需额外配置）：</p>
<ol>
<li><strong>优先用 <code>graph.StateKeyOneShotMessages</code></strong>：完全覆盖本轮输入（含 system/user），执行后清空</li>
<li><strong>其次用 <code>graph.StateKeyUserInput</code></strong>：在 <code>graph.StateKeyMessages</code> 基础上追加本轮 user，再把 assistant 回答一起原子写回，随后清空 <code>graph.StateKeyUserInput</code></li>
<li><strong>否则仅用 <code>graph.StateKeyMessages</code></strong>：常见于工具回路二次进 LLM（<code>graph.StateKeyUserInput</code> 已被清空）</li>
</ol>
<p>这套规则的精妙之处在于，它既保证了"预处理节点可以改写 <code>graph.StateKeyUserInput</code> 并在同一轮生效"，又与工具循环（tool_calls → tools → LLM）自然衔接。</p>
<p>示例（技术解析级别的小片段，演示三种输入路径）：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-72-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-72-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-72-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-72-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-72-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-72-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-72-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-72-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-72-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-72-10">10</a></span>
<span class="normal"><a href="#__codelineno-72-11">11</a></span>
<span class="normal"><a href="#__codelineno-72-12">12</a></span>
<span class="normal"><a href="#__codelineno-72-13">13</a></span>
<span class="normal"><a href="#__codelineno-72-14">14</a></span>
<span class="normal"><a href="#__codelineno-72-15">15</a></span>
<span class="normal"><a href="#__codelineno-72-16">16</a></span>
<span class="normal"><a href="#__codelineno-72-17">17</a></span>
<span class="normal"><a href="#__codelineno-72-18">18</a></span>
<span class="normal"><a href="#__codelineno-72-19">19</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-72-1"><a id="__codelineno-72-1" name="__codelineno-72-1"></a><span class="c1">// OneShot（graph.StateKeyOneShotMessages）：完全覆盖本轮输入（包含 system/user），适合“前置节点构造完整 prompt”</span>
</span><span id="__span-72-2"><a id="__codelineno-72-2" name="__codelineno-72-2"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-72-3"><a id="__codelineno-72-3" name="__codelineno-72-3"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-72-4"><a id="__codelineno-72-4" name="__codelineno-72-4"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/model&quot;</span>
</span><span id="__span-72-5"><a id="__codelineno-72-5" name="__codelineno-72-5"></a><span class="p">)</span>
</span><span id="__span-72-6"><a id="__codelineno-72-6" name="__codelineno-72-6"></a>
</span><span id="__span-72-7"><a id="__codelineno-72-7" name="__codelineno-72-7"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-72-8"><a id="__codelineno-72-8" name="__codelineno-72-8"></a><span class="w">    </span><span class="nx">systemPrompt</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;你是审慎可靠的助手&quot;</span>
</span><span id="__span-72-9"><a id="__codelineno-72-9" name="__codelineno-72-9"></a><span class="w">    </span><span class="nx">userPrompt</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;请用要点总结这段文本&quot;</span>
</span><span id="__span-72-10"><a id="__codelineno-72-10" name="__codelineno-72-10"></a><span class="p">)</span>
</span><span id="__span-72-11"><a id="__codelineno-72-11" name="__codelineno-72-11"></a>
</span><span id="__span-72-12"><a id="__codelineno-72-12" name="__codelineno-72-12"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;prepare_prompt&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-72-13"><a id="__codelineno-72-13" name="__codelineno-72-13"></a><span class="w">    </span><span class="nx">oneShot</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">[]</span><span class="nx">model</span><span class="p">.</span><span class="nx">Message</span><span class="p">{</span>
</span><span id="__span-72-14"><a id="__codelineno-72-14" name="__codelineno-72-14"></a><span class="w">        </span><span class="nx">model</span><span class="p">.</span><span class="nx">NewSystemMessage</span><span class="p">(</span><span class="nx">systemPrompt</span><span class="p">),</span>
</span><span id="__span-72-15"><a id="__codelineno-72-15" name="__codelineno-72-15"></a><span class="w">        </span><span class="nx">model</span><span class="p">.</span><span class="nx">NewUserMessage</span><span class="p">(</span><span class="nx">userPrompt</span><span class="p">),</span>
</span><span id="__span-72-16"><a id="__codelineno-72-16" name="__codelineno-72-16"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-72-17"><a id="__codelineno-72-17" name="__codelineno-72-17"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyOneShotMessages</span><span class="p">:</span><span class="w"> </span><span class="nx">oneShot</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-72-18"><a id="__codelineno-72-18" name="__codelineno-72-18"></a><span class="p">})</span>
</span><span id="__span-72-19"><a id="__codelineno-72-19" name="__codelineno-72-19"></a><span class="c1">// 后续进入 LLM 节点时将仅使用 graph.StateKeyOneShotMessages，并在执行后清空</span>
</span></code></pre></div></td></tr></table></div>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-73-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-73-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-73-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-73-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-73-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-73-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-73-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-73-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-73-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-73-10">10</a></span>
<span class="normal"><a href="#__codelineno-73-11">11</a></span>
<span class="normal"><a href="#__codelineno-73-12">12</a></span>
<span class="normal"><a href="#__codelineno-73-13">13</a></span>
<span class="normal"><a href="#__codelineno-73-14">14</a></span>
<span class="normal"><a href="#__codelineno-73-15">15</a></span>
<span class="normal"><a href="#__codelineno-73-16">16</a></span>
<span class="normal"><a href="#__codelineno-73-17">17</a></span>
<span class="normal"><a href="#__codelineno-73-18">18</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-73-1"><a id="__codelineno-73-1" name="__codelineno-73-1"></a><span class="c1">// UserInput（graph.StateKeyUserInput）：在历史 graph.StateKeyMessages 基础上附加本轮用户输入</span>
</span><span id="__span-73-2"><a id="__codelineno-73-2" name="__codelineno-73-2"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-73-3"><a id="__codelineno-73-3" name="__codelineno-73-3"></a><span class="w">    </span><span class="s">&quot;strings&quot;</span>
</span><span id="__span-73-4"><a id="__codelineno-73-4" name="__codelineno-73-4"></a>
</span><span id="__span-73-5"><a id="__codelineno-73-5" name="__codelineno-73-5"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-73-6"><a id="__codelineno-73-6" name="__codelineno-73-6"></a><span class="p">)</span>
</span><span id="__span-73-7"><a id="__codelineno-73-7" name="__codelineno-73-7"></a>
</span><span id="__span-73-8"><a id="__codelineno-73-8" name="__codelineno-73-8"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-73-9"><a id="__codelineno-73-9" name="__codelineno-73-9"></a><span class="w">    </span><span class="nx">stateKeyCleanedInput</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;cleaned_input&quot;</span>
</span><span id="__span-73-10"><a id="__codelineno-73-10" name="__codelineno-73-10"></a><span class="p">)</span>
</span><span id="__span-73-11"><a id="__codelineno-73-11" name="__codelineno-73-11"></a>
</span><span id="__span-73-12"><a id="__codelineno-73-12" name="__codelineno-73-12"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;clean_input&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-73-13"><a id="__codelineno-73-13" name="__codelineno-73-13"></a><span class="w">    </span><span class="nx">in</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">strings</span><span class="p">.</span><span class="nx">TrimSpace</span><span class="p">(</span><span class="nx">s</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyUserInput</span><span class="p">].(</span><span class="kt">string</span><span class="p">))</span>
</span><span id="__span-73-14"><a id="__codelineno-73-14" name="__codelineno-73-14"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span>
</span><span id="__span-73-15"><a id="__codelineno-73-15" name="__codelineno-73-15"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyUserInput</span><span class="p">:</span><span class="w"> </span><span class="nx">in</span><span class="p">,</span><span class="w">                </span><span class="c1">// 将清洗后的输入写回，LLM 节点会把 user+assistant 原子写入 messages</span>
</span><span id="__span-73-16"><a id="__codelineno-73-16" name="__codelineno-73-16"></a><span class="w">        </span><span class="nx">stateKeyCleanedInput</span><span class="p">:</span><span class="w">    </span><span class="nx">in</span><span class="p">,</span><span class="w">                </span><span class="c1">// 同时保留业务自定义键</span>
</span><span id="__span-73-17"><a id="__codelineno-73-17" name="__codelineno-73-17"></a><span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-73-18"><a id="__codelineno-73-18" name="__codelineno-73-18"></a><span class="p">})</span>
</span></code></pre></div></td></tr></table></div>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-74-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-74-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-74-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-74-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-74-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-74-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-74-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-74-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-74-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-74-10">10</a></span>
<span class="normal"><a href="#__codelineno-74-11">11</a></span>
<span class="normal"><a href="#__codelineno-74-12">12</a></span>
<span class="normal"><a href="#__codelineno-74-13">13</a></span>
<span class="normal"><a href="#__codelineno-74-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-74-1"><a id="__codelineno-74-1" name="__codelineno-74-1"></a><span class="c1">// Messages-only（graph.StateKeyMessages）：工具回路返回后，graph.StateKeyUserInput 已清空；LLM 仅基于 graph.StateKeyMessages（含 tool 响应）继续推理</span>
</span><span id="__span-74-2"><a id="__codelineno-74-2" name="__codelineno-74-2"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-74-3"><a id="__codelineno-74-3" name="__codelineno-74-3"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-74-4"><a id="__codelineno-74-4" name="__codelineno-74-4"></a><span class="p">)</span>
</span><span id="__span-74-5"><a id="__codelineno-74-5" name="__codelineno-74-5"></a>
</span><span id="__span-74-6"><a id="__codelineno-74-6" name="__codelineno-74-6"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-74-7"><a id="__codelineno-74-7" name="__codelineno-74-7"></a><span class="w">    </span><span class="nx">nodeAsk</span><span class="w">       </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;ask&quot;</span>
</span><span id="__span-74-8"><a id="__codelineno-74-8" name="__codelineno-74-8"></a><span class="w">    </span><span class="nx">nodeExecTools</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;exec_tools&quot;</span>
</span><span id="__span-74-9"><a id="__codelineno-74-9" name="__codelineno-74-9"></a><span class="w">    </span><span class="nx">nodeFallback</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;fallback&quot;</span>
</span><span id="__span-74-10"><a id="__codelineno-74-10" name="__codelineno-74-10"></a><span class="p">)</span>
</span><span id="__span-74-11"><a id="__codelineno-74-11" name="__codelineno-74-11"></a>
</span><span id="__span-74-12"><a id="__codelineno-74-12" name="__codelineno-74-12"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddToolsNode</span><span class="p">(</span><span class="nx">nodeExecTools</span><span class="p">,</span><span class="w"> </span><span class="nx">tools</span><span class="p">)</span>
</span><span id="__span-74-13"><a id="__codelineno-74-13" name="__codelineno-74-13"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddToolsConditionalEdges</span><span class="p">(</span><span class="nx">nodeAsk</span><span class="p">,</span><span class="w"> </span><span class="nx">nodeExecTools</span><span class="p">,</span><span class="w"> </span><span class="nx">nodeFallback</span><span class="p">)</span>
</span><span id="__span-74-14"><a id="__codelineno-74-14" name="__codelineno-74-14"></a><span class="c1">// 再次回到 nodeAsk（或下游 LLM 节点）时，由于 graph.StateKeyUserInput 已清空，将走 messages-only 分支</span>
</span></code></pre></div></td></tr></table></div>
<h4 id="_31">指令占位符注入</h4>
<p><code>AddLLMNode</code> 的 <code>instruction</code> 支持占位符，语法与 <code>llmagent</code> 一致：</p>
<ul>
<li><code>{key}</code> / <code>{key?}</code>：从会话 <code>session.State</code> 读取键值，可选后缀 <code>?</code> 缺失时为空；</li>
<li><code>{user:subkey}</code>、<code>{app:subkey}</code>、<code>{temp:subkey}</code>：按命名空间读取。</li>
</ul>
<p>GraphAgent 会把当前 <code>*session.Session</code> 放入状态（<code>graph.StateKeySession</code> 键），LLM 节点会在执行前对指令进行占位符展开。</p>
<p>提示：GraphAgent 会从会话事件播种 <code>graph.StateKeyMessages</code> 以保证多轮连贯；从检查点恢复时，若用户消息仅为 "resume"，不会注入到 <code>graph.StateKeyUserInput</code>，以避免干扰已恢复的状态。</p>
<h3 id="_32">并发执行和状态安全</h3>
<p>当一个节点有多条出边时，会自动触发并行执行：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-75-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-75-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-75-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-75-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-75-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-75-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-75-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-75-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-75-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-75-10">10</a></span>
<span class="normal"><a href="#__codelineno-75-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-75-1"><a id="__codelineno-75-1" name="__codelineno-75-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-75-2"><a id="__codelineno-75-2" name="__codelineno-75-2"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-75-3"><a id="__codelineno-75-3" name="__codelineno-75-3"></a><span class="p">)</span>
</span><span id="__span-75-4"><a id="__codelineno-75-4" name="__codelineno-75-4"></a>
</span><span id="__span-75-5"><a id="__codelineno-75-5" name="__codelineno-75-5"></a><span class="c1">// 这样的图结构会自动并行执行</span>
</span><span id="__span-75-6"><a id="__codelineno-75-6" name="__codelineno-75-6"></a><span class="nx">stateGraph</span><span class="p">.</span>
</span><span id="__span-75-7"><a id="__codelineno-75-7" name="__codelineno-75-7"></a><span class="w">    </span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;analyze&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">analyzeData</span><span class="p">).</span>
</span><span id="__span-75-8"><a id="__codelineno-75-8" name="__codelineno-75-8"></a><span class="w">    </span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;generate_report&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">generateReport</span><span class="p">).</span>
</span><span id="__span-75-9"><a id="__codelineno-75-9" name="__codelineno-75-9"></a><span class="w">    </span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;call_external_api&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">callAPI</span><span class="p">).</span>
</span><span id="__span-75-10"><a id="__codelineno-75-10" name="__codelineno-75-10"></a><span class="w">    </span><span class="nx">AddEdge</span><span class="p">(</span><span class="s">&quot;analyze&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;generate_report&quot;</span><span class="p">).</span><span class="w">    </span><span class="c1">// 这两个会并行执行</span>
</span><span id="__span-75-11"><a id="__codelineno-75-11" name="__codelineno-75-11"></a><span class="w">    </span><span class="nx">AddEdge</span><span class="p">(</span><span class="s">&quot;analyze&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;call_external_api&quot;</span><span class="p">)</span><span class="w">   </span><span class="c1">//</span>
</span></code></pre></div></td></tr></table></div>
<p>内部实现保证了并发安全：执行器为每个任务构造浅拷贝（maps.Copy）并在合并时加锁，同时通过 Reducer 机制来安全地合并并发更新。</p>
<h3 id="io_1">节点 I/O 约定与常用键</h3>
<p>节点之间仅通过共享 <code>State</code> 传递数据，节点函数返回的增量由 Schema 的 Reducer 合并。</p>
<ul>
<li>
<p>函数节点（Function）</p>
<ul>
<li>输入：完整 <code>State</code>（按 Schema 声明读取）</li>
<li>输出：只写业务键（例如 <code>{"parsed_time":"..."}</code>），不要写内部键</li>
</ul>
</li>
</ul>
<ul>
<li>
<p>LLM 节点</p>
<ul>
<li>输入优先级：
  <code>graph.StateKeyOneShotMessagesByNode[&lt;node_id&gt;]</code> →
  <code>graph.StateKeyOneShotMessages</code> →
  <code>graph.StateKeyUserInput</code> →
  <code>graph.StateKeyMessages</code></li>
<li>输出：原子写回 <code>graph.StateKeyMessages</code>、设置 <code>graph.StateKeyLastResponse</code>、设置 <code>graph.StateKeyNodeResponses[&lt;llm_node_id&gt;]</code></li>
</ul>
</li>
</ul>
<ul>
<li>
<p>工具节点（Tools）</p>
<ul>
<li>自 <code>graph.StateKeyMessages</code> 尾部配对当前轮的 <code>assistant(tool_calls)</code>，按顺序追加工具返回到 <code>graph.StateKeyMessages</code></li>
<li>输出：设置 <code>graph.StateKeyLastToolResponse</code>，并写入 <code>graph.StateKeyNodeResponses[&lt;tools_node_id&gt;]</code>（JSON 数组字符串）</li>
<li>多个工具按 LLM 返回顺序顺序执行</li>
</ul>
</li>
</ul>
<ul>
<li>Agent 节点<ul>
<li>通过 <code>Invocation.RunOptions.RuntimeState</code> 接收 Graph 的 <code>State</code></li>
<li>输出：设置 <code>graph.StateKeyLastResponse</code> 与 <code>graph.StateKeyNodeResponses[&lt;agent_node_id&gt;]</code>；执行成功后会清空 <code>graph.StateKeyUserInput</code></li>
</ul>
</li>
</ul>
<p>实践建议：</p>
<ul>
<li>串行读取：紧邻下游直接读取 <code>graph.StateKeyLastResponse</code>；</li>
<li>并行/汇合读取：从 <code>graph.StateKeyNodeResponses[&lt;nodeID&gt;]</code> 读取指定节点输出；</li>
<li>为业务键在 Schema 中声明合适的 Reducer，避免并发写入冲突。</li>
</ul>
<h3 id="api">API 速查表</h3>
<ul>
<li>
<p>构图</p>
<ul>
<li><code>graph.NewStateGraph(schema)</code> → 构建器</li>
<li><code>AddNode(id, func, ...opts)</code> / <code>AddLLMNode(id, model, instruction, tools, ...opts)</code></li>
<li><code>AddToolsNode(id, tools, ...opts)</code> / <code>AddAgentNode(id, ...opts)</code></li>
<li><code>AddEdge(from, to)</code> / <code>AddConditionalEdges(from, condition, pathMap)</code></li>
<li><code>AddToolsConditionalEdges(llmNode, toolsNode, fallback)</code></li>
<li><code>SetEntryPoint(nodeID)</code> / <code>SetFinishPoint(nodeID)</code> / <code>Compile()</code></li>
</ul>
</li>
</ul>
<ul>
<li>
<p>常用 State 键（用户可见）</p>
<ul>
<li><code>graph.StateKeyUserInput</code>、<code>graph.StateKeyOneShotMessages</code>、<code>graph.StateKeyMessages</code>、<code>graph.StateKeyLastResponse</code>、<code>graph.StateKeyLastToolResponse</code>、<code>graph.StateKeyNodeResponses</code>、<code>graph.StateKeyMetadata</code></li>
</ul>
</li>
</ul>
<ul>
<li>
<p>节点级可选项</p>
<ul>
<li>LLM / 工具相关：<ul>
<li><code>graph.WithGenerationConfig</code>、<code>graph.WithModelCallbacks</code></li>
<li><code>graph.WithToolCallbacks</code>、<code>graph.WithToolSets</code></li>
</ul>
</li>
<li>回调相关：<ul>
<li><code>graph.WithPreNodeCallback</code>、<code>graph.WithPostNodeCallback</code>、<code>graph.WithNodeErrorCallback</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li>执行<ul>
<li><code>graphagent.New(name, compiledGraph, ...opts)</code> → <code>runner.NewRunner(app, agent)</code> → <code>Run(...)</code></li>
</ul>
</li>
</ul>
<p>更多端到端用法见 <code>examples/graph</code>（基础/并行/多轮/中断/嵌套中断/静态中断/工具/占位符）。</p>
<h2 id="dot">可视化导出（DOT/图片）</h2>
<p>Graph 支持直接导出 Graphviz（图形可视化软件，Graph Visualization）<code>DOT</code>（Graphviz 的描述语言，Directed Graph Language）文本，以及通过系统安装的 <code>dot</code>（Graphviz 命令行工具 <code>dot</code> 是 Graphviz 的布局引擎之一，用于渲染 DOT 文件）渲染 <code>PNG</code>（Portable Network Graphics，便携式网络图形格式）/<code>SVG</code>（Scalable Vector Graphics，可缩放矢量图形）。</p>
<ul>
<li><code>WithDestinations</code>（在节点上声明潜在动态去向）会以虚线（dotted、灰色）显示，仅用于静态检查与可视化，不影响运行时路由。</li>
<li>条件边（Conditional edges）会以虚线（dashed、灰色）并标注分支键值。</li>
<li>常规边（AddEdge）为实线。</li>
<li>虚拟 <code>Start</code>/<code>End</code> 节点可通过选项打开/隐藏。</li>
</ul>
<p>示例：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-76-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-76-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-76-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-76-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-76-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-76-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-76-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-76-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-76-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-76-10">10</a></span>
<span class="normal"><a href="#__codelineno-76-11">11</a></span>
<span class="normal"><a href="#__codelineno-76-12">12</a></span>
<span class="normal"><a href="#__codelineno-76-13">13</a></span>
<span class="normal"><a href="#__codelineno-76-14">14</a></span>
<span class="normal"><a href="#__codelineno-76-15">15</a></span>
<span class="normal"><a href="#__codelineno-76-16">16</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-76-1"><a id="__codelineno-76-1" name="__codelineno-76-1"></a><span class="nx">g</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">sg</span><span class="p">.</span><span class="nx">MustCompile</span><span class="p">()</span>
</span><span id="__span-76-2"><a id="__codelineno-76-2" name="__codelineno-76-2"></a>
</span><span id="__span-76-3"><a id="__codelineno-76-3" name="__codelineno-76-3"></a><span class="c1">// 生成 DOT 文本</span>
</span><span id="__span-76-4"><a id="__codelineno-76-4" name="__codelineno-76-4"></a><span class="nx">dot</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">DOT</span><span class="p">(</span>
</span><span id="__span-76-5"><a id="__codelineno-76-5" name="__codelineno-76-5"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithRankDir</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">RankDirLR</span><span class="p">),</span><span class="w">     </span><span class="c1">// 左→右布局（或 graph.RankDirTB）</span>
</span><span id="__span-76-6"><a id="__codelineno-76-6" name="__codelineno-76-6"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithIncludeDestinations</span><span class="p">(</span><span class="kc">true</span><span class="p">),</span><span class="w">    </span><span class="c1">// 显示 WithDestinations 声明</span>
</span><span id="__span-76-7"><a id="__codelineno-76-7" name="__codelineno-76-7"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithGraphLabel</span><span class="p">(</span><span class="s">&quot;My Workflow&quot;</span><span class="p">),</span><span class="w">   </span><span class="c1">// 图标题</span>
</span><span id="__span-76-8"><a id="__codelineno-76-8" name="__codelineno-76-8"></a><span class="p">)</span>
</span><span id="__span-76-9"><a id="__codelineno-76-9" name="__codelineno-76-9"></a>
</span><span id="__span-76-10"><a id="__codelineno-76-10" name="__codelineno-76-10"></a><span class="c1">// 渲染 PNG （需要已安装 Graphviz 的 dot）</span>
</span><span id="__span-76-11"><a id="__codelineno-76-11" name="__codelineno-76-11"></a><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">RenderImage</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Background</span><span class="p">(),</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">ImageFormatPNG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;workflow.png&quot;</span><span class="p">,</span>
</span><span id="__span-76-12"><a id="__codelineno-76-12" name="__codelineno-76-12"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithRankDir</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">RankDirLR</span><span class="p">),</span>
</span><span id="__span-76-13"><a id="__codelineno-76-13" name="__codelineno-76-13"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithIncludeDestinations</span><span class="p">(</span><span class="kc">true</span><span class="p">),</span>
</span><span id="__span-76-14"><a id="__codelineno-76-14" name="__codelineno-76-14"></a><span class="p">);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-76-15"><a id="__codelineno-76-15" name="__codelineno-76-15"></a><span class="w">    </span><span class="c1">// 未安装 Graphviz 时这里会返回错误，可忽略或提示安装</span>
</span><span id="__span-76-16"><a id="__codelineno-76-16" name="__codelineno-76-16"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>API 参考：</p>
<ul>
<li><code>g.DOT(...)</code> / <code>g.WriteDOT(w, ...)</code>：导出 DOT 文本</li>
<li><code>g.RenderImage(ctx, format, outputPath, ...)</code>：调用 <code>dot</code> 渲染图片（<code>png</code>/<code>svg</code> 等）</li>
<li>选项：<code>WithRankDir(graph.RankDirLR|graph.RankDirTB)</code>、<code>WithIncludeDestinations(bool)</code>、<code>WithIncludeStartEnd(bool)</code>、<code>WithGraphLabel(string)</code></li>
</ul>
<p>完整示例见：<code>examples/graph/visualization</code></p>
<h2 id="_33">高级特性</h2>
<h3 id="_34">检查点与恢复</h3>
<p>为了支持时间旅行与可靠恢复，可以为执行器或 GraphAgent 配置检查点保存器。下面演示使用 SQLite/Redis Saver 持久化检查点并从特定检查点恢复。</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-77-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-77-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-77-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-77-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-77-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-77-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-77-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-77-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-77-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-77-10">10</a></span>
<span class="normal"><a href="#__codelineno-77-11">11</a></span>
<span class="normal"><a href="#__codelineno-77-12">12</a></span>
<span class="normal"><a href="#__codelineno-77-13">13</a></span>
<span class="normal"><a href="#__codelineno-77-14">14</a></span>
<span class="normal"><a href="#__codelineno-77-15">15</a></span>
<span class="normal"><a href="#__codelineno-77-16">16</a></span>
<span class="normal"><a href="#__codelineno-77-17">17</a></span>
<span class="normal"><a href="#__codelineno-77-18">18</a></span>
<span class="normal"><a href="#__codelineno-77-19">19</a></span>
<span class="normal"><a href="#__codelineno-77-20">20</a></span>
<span class="normal"><a href="#__codelineno-77-21">21</a></span>
<span class="normal"><a href="#__codelineno-77-22">22</a></span>
<span class="normal"><a href="#__codelineno-77-23">23</a></span>
<span class="normal"><a href="#__codelineno-77-24">24</a></span>
<span class="normal"><a href="#__codelineno-77-25">25</a></span>
<span class="normal"><a href="#__codelineno-77-26">26</a></span>
<span class="normal"><a href="#__codelineno-77-27">27</a></span>
<span class="normal"><a href="#__codelineno-77-28">28</a></span>
<span class="normal"><a href="#__codelineno-77-29">29</a></span>
<span class="normal"><a href="#__codelineno-77-30">30</a></span>
<span class="normal"><a href="#__codelineno-77-31">31</a></span>
<span class="normal"><a href="#__codelineno-77-32">32</a></span>
<span class="normal"><a href="#__codelineno-77-33">33</a></span>
<span class="normal"><a href="#__codelineno-77-34">34</a></span>
<span class="normal"><a href="#__codelineno-77-35">35</a></span>
<span class="normal"><a href="#__codelineno-77-36">36</a></span>
<span class="normal"><a href="#__codelineno-77-37">37</a></span>
<span class="normal"><a href="#__codelineno-77-38">38</a></span>
<span class="normal"><a href="#__codelineno-77-39">39</a></span>
<span class="normal"><a href="#__codelineno-77-40">40</a></span>
<span class="normal"><a href="#__codelineno-77-41">41</a></span>
<span class="normal"><a href="#__codelineno-77-42">42</a></span>
<span class="normal"><a href="#__codelineno-77-43">43</a></span>
<span class="normal"><a href="#__codelineno-77-44">44</a></span>
<span class="normal"><a href="#__codelineno-77-45">45</a></span>
<span class="normal"><a href="#__codelineno-77-46">46</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-77-1"><a id="__codelineno-77-1" name="__codelineno-77-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-77-2"><a id="__codelineno-77-2" name="__codelineno-77-2"></a><span class="w">    </span><span class="s">&quot;database/sql&quot;</span>
</span><span id="__span-77-3"><a id="__codelineno-77-3" name="__codelineno-77-3"></a>
</span><span id="__span-77-4"><a id="__codelineno-77-4" name="__codelineno-77-4"></a><span class="w">    </span><span class="nx">_</span><span class="w"> </span><span class="s">&quot;github.com/mattn/go-sqlite3&quot;</span>
</span><span id="__span-77-5"><a id="__codelineno-77-5" name="__codelineno-77-5"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/agent&quot;</span>
</span><span id="__span-77-6"><a id="__codelineno-77-6" name="__codelineno-77-6"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/agent/graphagent&quot;</span>
</span><span id="__span-77-7"><a id="__codelineno-77-7" name="__codelineno-77-7"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-77-8"><a id="__codelineno-77-8" name="__codelineno-77-8"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph/checkpoint/sqlite&quot;</span>
</span><span id="__span-77-9"><a id="__codelineno-77-9" name="__codelineno-77-9"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph/checkpoint/redis&quot;</span>
</span><span id="__span-77-10"><a id="__codelineno-77-10" name="__codelineno-77-10"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/model&quot;</span>
</span><span id="__span-77-11"><a id="__codelineno-77-11" name="__codelineno-77-11"></a><span class="p">)</span>
</span><span id="__span-77-12"><a id="__codelineno-77-12" name="__codelineno-77-12"></a>
</span><span id="__span-77-13"><a id="__codelineno-77-13" name="__codelineno-77-13"></a><span class="c1">// 配置检查点</span>
</span><span id="__span-77-14"><a id="__codelineno-77-14" name="__codelineno-77-14"></a><span class="nx">db</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">sql</span><span class="p">.</span><span class="nx">Open</span><span class="p">(</span><span class="s">&quot;sqlite3&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;./checkpoints.db&quot;</span><span class="p">)</span>
</span><span id="__span-77-15"><a id="__codelineno-77-15" name="__codelineno-77-15"></a><span class="nx">saver</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">sqlite</span><span class="p">.</span><span class="nx">NewSaver</span><span class="p">(</span><span class="nx">db</span><span class="p">)</span>
</span><span id="__span-77-16"><a id="__codelineno-77-16" name="__codelineno-77-16"></a>
</span><span id="__span-77-17"><a id="__codelineno-77-17" name="__codelineno-77-17"></a><span class="nx">graphAgent</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;workflow&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">g</span><span class="p">,</span>
</span><span id="__span-77-18"><a id="__codelineno-77-18" name="__codelineno-77-18"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithCheckpointSaver</span><span class="p">(</span><span class="nx">saver</span><span class="p">))</span>
</span><span id="__span-77-19"><a id="__codelineno-77-19" name="__codelineno-77-19"></a>
</span><span id="__span-77-20"><a id="__codelineno-77-20" name="__codelineno-77-20"></a><span class="c1">// 执行时自动保存检查点（默认每步保存）</span>
</span><span id="__span-77-21"><a id="__codelineno-77-21" name="__codelineno-77-21"></a>
</span><span id="__span-77-22"><a id="__codelineno-77-22" name="__codelineno-77-22"></a><span class="c1">// 从检查点恢复</span>
</span><span id="__span-77-23"><a id="__codelineno-77-23" name="__codelineno-77-23"></a><span class="nx">eventCh</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">userID</span><span class="p">,</span><span class="w"> </span><span class="nx">sessionID</span><span class="p">,</span>
</span><span id="__span-77-24"><a id="__codelineno-77-24" name="__codelineno-77-24"></a><span class="w">    </span><span class="nx">model</span><span class="p">.</span><span class="nx">NewUserMessage</span><span class="p">(</span><span class="s">&quot;resume&quot;</span><span class="p">),</span>
</span><span id="__span-77-25"><a id="__codelineno-77-25" name="__codelineno-77-25"></a><span class="w">    </span><span class="nx">agent</span><span class="p">.</span><span class="nx">WithRuntimeState</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">any</span><span class="p">{</span>
</span><span id="__span-77-26"><a id="__codelineno-77-26" name="__codelineno-77-26"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">CfgKeyLineageID</span><span class="p">:</span><span class="w">    </span><span class="nx">lineageID</span><span class="p">,</span>
</span><span id="__span-77-27"><a id="__codelineno-77-27" name="__codelineno-77-27"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">CfgKeyCheckpointID</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ckpt-123&quot;</span><span class="p">,</span>
</span><span id="__span-77-28"><a id="__codelineno-77-28" name="__codelineno-77-28"></a><span class="w">    </span><span class="p">}),</span>
</span><span id="__span-77-29"><a id="__codelineno-77-29" name="__codelineno-77-29"></a><span class="p">)</span>
</span><span id="__span-77-30"><a id="__codelineno-77-30" name="__codelineno-77-30"></a>
</span><span id="__span-77-31"><a id="__codelineno-77-31" name="__codelineno-77-31"></a><span class="c1">// 配置redis检查点</span>
</span><span id="__span-77-32"><a id="__codelineno-77-32" name="__codelineno-77-32"></a><span class="nx">redisSaver</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">redis</span><span class="p">.</span><span class="nx">NewSaver</span><span class="p">(</span><span class="nx">redis</span><span class="p">.</span><span class="nx">WithRedisClientURL</span><span class="p">(</span><span class="s">&quot;redis://[username:password@]host:port[/database]&quot;</span><span class="p">))</span>
</span><span id="__span-77-33"><a id="__codelineno-77-33" name="__codelineno-77-33"></a>
</span><span id="__span-77-34"><a id="__codelineno-77-34" name="__codelineno-77-34"></a><span class="nx">graphAgent</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;workflow&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">g</span><span class="p">,</span>
</span><span id="__span-77-35"><a id="__codelineno-77-35" name="__codelineno-77-35"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithCheckpointSaver</span><span class="p">(</span><span class="nx">redisSaver</span><span class="p">))</span>
</span><span id="__span-77-36"><a id="__codelineno-77-36" name="__codelineno-77-36"></a>
</span><span id="__span-77-37"><a id="__codelineno-77-37" name="__codelineno-77-37"></a><span class="c1">// 执行时自动保存检查点（默认每步保存）</span>
</span><span id="__span-77-38"><a id="__codelineno-77-38" name="__codelineno-77-38"></a>
</span><span id="__span-77-39"><a id="__codelineno-77-39" name="__codelineno-77-39"></a><span class="c1">// 从检查点恢复</span>
</span><span id="__span-77-40"><a id="__codelineno-77-40" name="__codelineno-77-40"></a><span class="nx">eventCh</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">userID</span><span class="p">,</span><span class="w"> </span><span class="nx">sessionID</span><span class="p">,</span>
</span><span id="__span-77-41"><a id="__codelineno-77-41" name="__codelineno-77-41"></a><span class="w">    </span><span class="nx">model</span><span class="p">.</span><span class="nx">NewUserMessage</span><span class="p">(</span><span class="s">&quot;resume&quot;</span><span class="p">),</span>
</span><span id="__span-77-42"><a id="__codelineno-77-42" name="__codelineno-77-42"></a><span class="w">    </span><span class="nx">agent</span><span class="p">.</span><span class="nx">WithRuntimeState</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">any</span><span class="p">{</span>
</span><span id="__span-77-43"><a id="__codelineno-77-43" name="__codelineno-77-43"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">CfgKeyLineageID</span><span class="p">:</span><span class="w">    </span><span class="nx">lineageID</span><span class="p">,</span>
</span><span id="__span-77-44"><a id="__codelineno-77-44" name="__codelineno-77-44"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">CfgKeyCheckpointID</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ckpt-123&quot;</span><span class="p">,</span>
</span><span id="__span-77-45"><a id="__codelineno-77-45" name="__codelineno-77-45"></a><span class="w">    </span><span class="p">}),</span>
</span><span id="__span-77-46"><a id="__codelineno-77-46" name="__codelineno-77-46"></a><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<h4 id="_35">检查点管理</h4>
<p>使用管理器可以便捷地浏览、查询与删除检查点：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-78-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-78-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-78-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-78-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-78-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-78-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-78-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-78-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-78-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-78-10">10</a></span>
<span class="normal"><a href="#__codelineno-78-11">11</a></span>
<span class="normal"><a href="#__codelineno-78-12">12</a></span>
<span class="normal"><a href="#__codelineno-78-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-78-1"><a id="__codelineno-78-1" name="__codelineno-78-1"></a><span class="nx">cm</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewCheckpointManager</span><span class="p">(</span><span class="nx">saver</span><span class="p">)</span>
</span><span id="__span-78-2"><a id="__codelineno-78-2" name="__codelineno-78-2"></a>
</span><span id="__span-78-3"><a id="__codelineno-78-3" name="__codelineno-78-3"></a><span class="c1">// 最新检查点（可按 namespace 过滤；空字符串代表跨命名空间）</span>
</span><span id="__span-78-4"><a id="__codelineno-78-4" name="__codelineno-78-4"></a><span class="nx">latest</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">cm</span><span class="p">.</span><span class="nx">Latest</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">lineageID</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">)</span>
</span><span id="__span-78-5"><a id="__codelineno-78-5" name="__codelineno-78-5"></a>
</span><span id="__span-78-6"><a id="__codelineno-78-6" name="__codelineno-78-6"></a><span class="c1">// 列表（按时间倒序）</span>
</span><span id="__span-78-7"><a id="__codelineno-78-7" name="__codelineno-78-7"></a><span class="nx">tuples</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">cm</span><span class="p">.</span><span class="nx">ListCheckpoints</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewCheckpointConfig</span><span class="p">(</span><span class="nx">lineageID</span><span class="p">).</span><span class="nx">ToMap</span><span class="p">(),</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">graph</span><span class="p">.</span><span class="nx">CheckpointFilter</span><span class="p">{</span><span class="nx">Limit</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="p">})</span>
</span><span id="__span-78-8"><a id="__codelineno-78-8" name="__codelineno-78-8"></a>
</span><span id="__span-78-9"><a id="__codelineno-78-9" name="__codelineno-78-9"></a><span class="c1">// 获取具体检查点元组（含 pending writes）</span>
</span><span id="__span-78-10"><a id="__codelineno-78-10" name="__codelineno-78-10"></a><span class="nx">tuple</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">cm</span><span class="p">.</span><span class="nx">GetTuple</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">CreateCheckpointConfig</span><span class="p">(</span><span class="nx">lineageID</span><span class="p">,</span><span class="w"> </span><span class="nx">checkpointID</span><span class="p">,</span><span class="w"> </span><span class="nx">namespace</span><span class="p">))</span>
</span><span id="__span-78-11"><a id="__codelineno-78-11" name="__codelineno-78-11"></a>
</span><span id="__span-78-12"><a id="__codelineno-78-12" name="__codelineno-78-12"></a><span class="c1">// 删除谱系</span>
</span><span id="__span-78-13"><a id="__codelineno-78-13" name="__codelineno-78-13"></a><span class="nx">_</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">cm</span><span class="p">.</span><span class="nx">DeleteLineage</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">lineageID</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>建议在生产中为 <code>namespace</code> 使用稳定的业务标识（如 <code>svc:prod:flowX</code>），便于审计与对账。</p>
<h3 id="_36">默认值与注意事项</h3>
<ul>
<li>
<p>默认值（Executor）</p>
<ul>
<li><code>ChannelBufferSize = 256</code>、<code>MaxSteps = 100</code>、<code>MaxConcurrency = GOMAXPROCS(0)</code>、<code>CheckpointSaveTimeout = 10s</code></li>
<li>步/节点超时可通过 <code>Executor</code> 的 <code>WithStepTimeout</code> / <code>WithNodeTimeout</code> 配置（目前 GraphAgent 选项未直接暴露）</li>
</ul>
</li>
</ul>
<ul>
<li>会话<ul>
<li>生产环境优先使用 Redis Session；设置合理 TTL 与清理策略</li>
</ul>
</li>
<li>Runner 会自动从会话事件播种多轮 <code>graph.StateKeyMessages</code></li>
</ul>
<ul>
<li>
<p>检查点</p>
<ul>
<li>采用稳定的 <code>namespace</code> 命名（如 <code>svc:prod:flowX</code>）；使用 <code>CheckpointManager</code> 按谱系审计与清理</li>
</ul>
</li>
</ul>
<ul>
<li>
<p>事件与背压</p>
<ul>
<li>调整 <code>WithChannelBufferSize</code>；用 <code>WithMaxConcurrency</code> 限制并行任务数</li>
<li>按 <code>author</code>/<code>object</code> 过滤事件降低噪音</li>
</ul>
</li>
</ul>
<ul>
<li>
<p>命名与键</p>
<ul>
<li>节点/路由标签/状态键使用常量；为需要合并的键声明 Reducer</li>
</ul>
</li>
</ul>
<ul>
<li>治理与合规</li>
<li>关键路径引入 HITL；敏感信息优先落到 <code>graph.StateKeyMetadata</code>，避免混入 <code>graph.StateKeyMessages</code></li>
</ul>
<h3 id="_37">事件速览</h3>
<ul>
<li>
<p>Author 约定</p>
<ul>
<li>节点级：节点 ID（无法获取时为 <code>graph.AuthorGraphNode</code>）</li>
<li>Pregel 阶段：<code>graph.AuthorGraphPregel</code></li>
<li>执行器/系统：<code>graph.AuthorGraphExecutor</code></li>
<li>用户输入：<code>user</code>（未导出常量）</li>
</ul>
</li>
</ul>
<ul>
<li>对象类型（子集）<ul>
<li>节点：<code>graph.ObjectTypeGraphNodeStart | graph.ObjectTypeGraphNodeComplete | graph.ObjectTypeGraphNodeError</code></li>
<li>Pregel：<code>graph.ObjectTypeGraphPregelPlanning | graph.ObjectTypeGraphPregelExecution | graph.ObjectTypeGraphPregelUpdate</code></li>
<li>通道/状态：<code>graph.ObjectTypeGraphChannelUpdate</code> / <code>graph.ObjectTypeGraphStateUpdate</code></li>
<li>检查点：<code>graph.ObjectTypeGraphCheckpoint</code>、<code>graph.ObjectTypeGraphCheckpointCreated</code>、<code>graph.ObjectTypeGraphCheckpointCommitted</code>、<code>graph.ObjectTypeGraphCheckpointInterrupt</code></li>
</ul>
</li>
</ul>
<p>更多示例见下文“事件监控”。</p>
<h3 id="human-in-the-loop">Human-in-the-Loop</h3>
<p>在关键路径上引入人工确认（HITL）能够显著提升可控性。下面的示例展示一个“中断—恢复”的基本流程：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-79-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-79-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-79-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-79-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-79-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-79-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-79-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-79-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-79-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-79-10">10</a></span>
<span class="normal"><a href="#__codelineno-79-11">11</a></span>
<span class="normal"><a href="#__codelineno-79-12">12</a></span>
<span class="normal"><a href="#__codelineno-79-13">13</a></span>
<span class="normal"><a href="#__codelineno-79-14">14</a></span>
<span class="normal"><a href="#__codelineno-79-15">15</a></span>
<span class="normal"><a href="#__codelineno-79-16">16</a></span>
<span class="normal"><a href="#__codelineno-79-17">17</a></span>
<span class="normal"><a href="#__codelineno-79-18">18</a></span>
<span class="normal"><a href="#__codelineno-79-19">19</a></span>
<span class="normal"><a href="#__codelineno-79-20">20</a></span>
<span class="normal"><a href="#__codelineno-79-21">21</a></span>
<span class="normal"><a href="#__codelineno-79-22">22</a></span>
<span class="normal"><a href="#__codelineno-79-23">23</a></span>
<span class="normal"><a href="#__codelineno-79-24">24</a></span>
<span class="normal"><a href="#__codelineno-79-25">25</a></span>
<span class="normal"><a href="#__codelineno-79-26">26</a></span>
<span class="normal"><a href="#__codelineno-79-27">27</a></span>
<span class="normal"><a href="#__codelineno-79-28">28</a></span>
<span class="normal"><a href="#__codelineno-79-29">29</a></span>
<span class="normal"><a href="#__codelineno-79-30">30</a></span>
<span class="normal"><a href="#__codelineno-79-31">31</a></span>
<span class="normal"><a href="#__codelineno-79-32">32</a></span>
<span class="normal"><a href="#__codelineno-79-33">33</a></span>
<span class="normal"><a href="#__codelineno-79-34">34</a></span>
<span class="normal"><a href="#__codelineno-79-35">35</a></span>
<span class="normal"><a href="#__codelineno-79-36">36</a></span>
<span class="normal"><a href="#__codelineno-79-37">37</a></span>
<span class="normal"><a href="#__codelineno-79-38">38</a></span>
<span class="normal"><a href="#__codelineno-79-39">39</a></span>
<span class="normal"><a href="#__codelineno-79-40">40</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-79-1"><a id="__codelineno-79-1" name="__codelineno-79-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-79-2"><a id="__codelineno-79-2" name="__codelineno-79-2"></a><span class="w">    </span><span class="s">&quot;context&quot;</span>
</span><span id="__span-79-3"><a id="__codelineno-79-3" name="__codelineno-79-3"></a><span class="w">    </span><span class="s">&quot;fmt&quot;</span>
</span><span id="__span-79-4"><a id="__codelineno-79-4" name="__codelineno-79-4"></a>
</span><span id="__span-79-5"><a id="__codelineno-79-5" name="__codelineno-79-5"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/agent&quot;</span>
</span><span id="__span-79-6"><a id="__codelineno-79-6" name="__codelineno-79-6"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-79-7"><a id="__codelineno-79-7" name="__codelineno-79-7"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/model&quot;</span>
</span><span id="__span-79-8"><a id="__codelineno-79-8" name="__codelineno-79-8"></a><span class="p">)</span>
</span><span id="__span-79-9"><a id="__codelineno-79-9" name="__codelineno-79-9"></a>
</span><span id="__span-79-10"><a id="__codelineno-79-10" name="__codelineno-79-10"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-79-11"><a id="__codelineno-79-11" name="__codelineno-79-11"></a><span class="w">    </span><span class="nx">stateKeyContent</span><span class="w">    </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;content&quot;</span>
</span><span id="__span-79-12"><a id="__codelineno-79-12" name="__codelineno-79-12"></a><span class="w">    </span><span class="nx">stateKeyDecision</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;decision&quot;</span>
</span><span id="__span-79-13"><a id="__codelineno-79-13" name="__codelineno-79-13"></a><span class="w">    </span><span class="nx">interruptKeyReview</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;review_key&quot;</span>
</span><span id="__span-79-14"><a id="__codelineno-79-14" name="__codelineno-79-14"></a><span class="w">    </span><span class="nx">nodeReview</span><span class="w">         </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;review&quot;</span>
</span><span id="__span-79-15"><a id="__codelineno-79-15" name="__codelineno-79-15"></a><span class="p">)</span>
</span><span id="__span-79-16"><a id="__codelineno-79-16" name="__codelineno-79-16"></a>
</span><span id="__span-79-17"><a id="__codelineno-79-17" name="__codelineno-79-17"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="nx">nodeReview</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-79-18"><a id="__codelineno-79-18" name="__codelineno-79-18"></a><span class="w">    </span><span class="nx">content</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">s</span><span class="p">[</span><span class="nx">stateKeyContent</span><span class="p">].(</span><span class="kt">string</span><span class="p">)</span>
</span><span id="__span-79-19"><a id="__codelineno-79-19" name="__codelineno-79-19"></a>
</span><span id="__span-79-20"><a id="__codelineno-79-20" name="__codelineno-79-20"></a><span class="w">    </span><span class="c1">// 中断并等待人工输入</span>
</span><span id="__span-79-21"><a id="__codelineno-79-21" name="__codelineno-79-21"></a><span class="w">    </span><span class="nx">result</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">Interrupt</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="p">,</span><span class="w"> </span><span class="nx">interruptKeyReview</span><span class="p">,</span>
</span><span id="__span-79-22"><a id="__codelineno-79-22" name="__codelineno-79-22"></a><span class="w">        </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;请审核: %s&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">content</span><span class="p">))</span>
</span><span id="__span-79-23"><a id="__codelineno-79-23" name="__codelineno-79-23"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-79-24"><a id="__codelineno-79-24" name="__codelineno-79-24"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
</span><span id="__span-79-25"><a id="__codelineno-79-25" name="__codelineno-79-25"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-79-26"><a id="__codelineno-79-26" name="__codelineno-79-26"></a>
</span><span id="__span-79-27"><a id="__codelineno-79-27" name="__codelineno-79-27"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="nx">stateKeyDecision</span><span class="p">:</span><span class="w"> </span><span class="nx">result</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-79-28"><a id="__codelineno-79-28" name="__codelineno-79-28"></a><span class="p">})</span>
</span><span id="__span-79-29"><a id="__codelineno-79-29" name="__codelineno-79-29"></a>
</span><span id="__span-79-30"><a id="__codelineno-79-30" name="__codelineno-79-30"></a><span class="c1">// 恢复执行（需要 import agent 包）</span>
</span><span id="__span-79-31"><a id="__codelineno-79-31" name="__codelineno-79-31"></a><span class="nx">eventCh</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">userID</span><span class="p">,</span><span class="w"> </span><span class="nx">sessionID</span><span class="p">,</span>
</span><span id="__span-79-32"><a id="__codelineno-79-32" name="__codelineno-79-32"></a><span class="w">    </span><span class="nx">model</span><span class="p">.</span><span class="nx">NewUserMessage</span><span class="p">(</span><span class="s">&quot;resume&quot;</span><span class="p">),</span>
</span><span id="__span-79-33"><a id="__codelineno-79-33" name="__codelineno-79-33"></a><span class="w">    </span><span class="nx">agent</span><span class="p">.</span><span class="nx">WithRuntimeState</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">any</span><span class="p">{</span>
</span><span id="__span-79-34"><a id="__codelineno-79-34" name="__codelineno-79-34"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">CfgKeyLineageID</span><span class="p">:</span><span class="w">    </span><span class="nx">lineageID</span><span class="p">,</span>
</span><span id="__span-79-35"><a id="__codelineno-79-35" name="__codelineno-79-35"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">CfgKeyCheckpointID</span><span class="p">:</span><span class="w"> </span><span class="nx">checkpointID</span><span class="p">,</span>
</span><span id="__span-79-36"><a id="__codelineno-79-36" name="__codelineno-79-36"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyResumeMap</span><span class="p">:</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">any</span><span class="p">{</span>
</span><span id="__span-79-37"><a id="__codelineno-79-37" name="__codelineno-79-37"></a><span class="w">            </span><span class="s">&quot;review_key&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;approved&quot;</span><span class="p">,</span>
</span><span id="__span-79-38"><a id="__codelineno-79-38" name="__codelineno-79-38"></a><span class="w">        </span><span class="p">},</span>
</span><span id="__span-79-39"><a id="__codelineno-79-39" name="__codelineno-79-39"></a><span class="w">    </span><span class="p">}),</span>
</span><span id="__span-79-40"><a id="__codelineno-79-40" name="__codelineno-79-40"></a><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<h4 id="graphagent_1">嵌套图（子 GraphAgent 中断）</h4>
<p>如果父图通过 Agent 节点调用子 GraphAgent（<code>AddAgentNode</code> / <code>AddSubgraphNode</code>），
子图同样可以通过 <code>graph.Interrupt</code> 触发中断，并且父图会一起中断。</p>
<p>恢复时仍然只需要恢复父图的检查点；当 Agent 节点再次执行时，会自动恢复子图的检查点。</p>
<p>可运行示例：<code>examples/graph/nested_interrupt</code>。</p>
<p>该示例支持通过 <code>-depth</code> 参数模拟多级嵌套。</p>
<p>关键点：<code>graph.Interrupt(ctx, state, key, prompt)</code> 里的 <code>key</code> 会作为 <code>ResumeMap</code>
的路由 key。也就是说，恢复时 <code>ResumeMap</code> 的 map key 必须与这里的 <code>key</code> 一致。</p>
<p>你会看到两个不同的标识：</p>
<ul>
<li>节点标识（Node Identifier (Node ID)）：当前这张图暂停的位置（在嵌套图里，
  通常是父图的 Agent 节点）。</li>
<li>任务标识（Task Identifier (Task ID)）：用于 <code>ResumeMap</code> 路由的中断 key。
  对 <code>graph.Interrupt</code> 而言，Task ID 等于传入的 <code>key</code> 参数。</li>
</ul>
<p>如果你不想在代码里写死中断 key，可以从“中断检查点”里取出 Task ID，并用它作为
<code>ResumeMap</code> 的 key：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-80-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-80-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-80-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-80-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-80-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-80-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-80-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-80-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-80-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-80-10">10</a></span>
<span class="normal"><a href="#__codelineno-80-11">11</a></span>
<span class="normal"><a href="#__codelineno-80-12">12</a></span>
<span class="normal"><a href="#__codelineno-80-13">13</a></span>
<span class="normal"><a href="#__codelineno-80-14">14</a></span>
<span class="normal"><a href="#__codelineno-80-15">15</a></span>
<span class="normal"><a href="#__codelineno-80-16">16</a></span>
<span class="normal"><a href="#__codelineno-80-17">17</a></span>
<span class="normal"><a href="#__codelineno-80-18">18</a></span>
<span class="normal"><a href="#__codelineno-80-19">19</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-80-1"><a id="__codelineno-80-1" name="__codelineno-80-1"></a><span class="c1">// cm 是 graph.CheckpointManager。如果你使用 GraphAgent，可以通过</span>
</span><span id="__span-80-2"><a id="__codelineno-80-2" name="__codelineno-80-2"></a><span class="c1">// ga.Executor().CheckpointManager() 获取。</span>
</span><span id="__span-80-3"><a id="__codelineno-80-3" name="__codelineno-80-3"></a><span class="nx">latest</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">cm</span><span class="p">.</span><span class="nx">Latest</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">lineageID</span><span class="p">,</span><span class="w"> </span><span class="nx">namespace</span><span class="p">)</span>
</span><span id="__span-80-4"><a id="__codelineno-80-4" name="__codelineno-80-4"></a><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">latest</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">latest</span><span class="p">.</span><span class="nx">Checkpoint</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-80-5"><a id="__codelineno-80-5" name="__codelineno-80-5"></a><span class="w">    </span><span class="c1">// handle error</span>
</span><span id="__span-80-6"><a id="__codelineno-80-6" name="__codelineno-80-6"></a><span class="p">}</span>
</span><span id="__span-80-7"><a id="__codelineno-80-7" name="__codelineno-80-7"></a><span class="nx">taskID</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">latest</span><span class="p">.</span><span class="nx">Checkpoint</span><span class="p">.</span><span class="nx">InterruptState</span><span class="p">.</span><span class="nx">TaskID</span>
</span><span id="__span-80-8"><a id="__codelineno-80-8" name="__codelineno-80-8"></a>
</span><span id="__span-80-9"><a id="__codelineno-80-9" name="__codelineno-80-9"></a><span class="nx">cmd</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewResumeCommand</span><span class="p">().</span>
</span><span id="__span-80-10"><a id="__codelineno-80-10" name="__codelineno-80-10"></a><span class="w">    </span><span class="nx">AddResumeValue</span><span class="p">(</span><span class="nx">taskID</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;approved&quot;</span><span class="p">)</span>
</span><span id="__span-80-11"><a id="__codelineno-80-11" name="__codelineno-80-11"></a>
</span><span id="__span-80-12"><a id="__codelineno-80-12" name="__codelineno-80-12"></a><span class="nx">events</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">userID</span><span class="p">,</span><span class="w"> </span><span class="nx">sessionID</span><span class="p">,</span>
</span><span id="__span-80-13"><a id="__codelineno-80-13" name="__codelineno-80-13"></a><span class="w">    </span><span class="nx">model</span><span class="p">.</span><span class="nx">NewUserMessage</span><span class="p">(</span><span class="s">&quot;resume&quot;</span><span class="p">),</span>
</span><span id="__span-80-14"><a id="__codelineno-80-14" name="__codelineno-80-14"></a><span class="w">    </span><span class="nx">agent</span><span class="p">.</span><span class="nx">WithRuntimeState</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">any</span><span class="p">{</span>
</span><span id="__span-80-15"><a id="__codelineno-80-15" name="__codelineno-80-15"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">CfgKeyLineageID</span><span class="p">:</span><span class="w">    </span><span class="nx">lineageID</span><span class="p">,</span>
</span><span id="__span-80-16"><a id="__codelineno-80-16" name="__codelineno-80-16"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">CfgKeyCheckpointID</span><span class="p">:</span><span class="w"> </span><span class="nx">latest</span><span class="p">.</span><span class="nx">Checkpoint</span><span class="p">.</span><span class="nx">ID</span><span class="p">,</span>
</span><span id="__span-80-17"><a id="__codelineno-80-17" name="__codelineno-80-17"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyCommand</span><span class="p">:</span><span class="w">    </span><span class="nx">cmd</span><span class="p">,</span>
</span><span id="__span-80-18"><a id="__codelineno-80-18" name="__codelineno-80-18"></a><span class="w">    </span><span class="p">}),</span>
</span><span id="__span-80-19"><a id="__codelineno-80-19" name="__codelineno-80-19"></a><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>多级嵌套的语义是一样的：只需要恢复父图检查点，框架会自动逐层恢复每一层子图。</p>
<p>恢复辅助函数：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-81-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-81-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-81-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-81-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-81-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-81-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-81-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-81-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-81-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-81-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-81-1"><a id="__codelineno-81-1" name="__codelineno-81-1"></a><span class="c1">// 带类型的恢复值读取</span>
</span><span id="__span-81-2"><a id="__codelineno-81-2" name="__codelineno-81-2"></a><span class="k">if</span><span class="w"> </span><span class="nx">v</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">ResumeValue</span><span class="p">[</span><span class="kt">string</span><span class="p">](</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;approval&quot;</span><span class="p">);</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* 使用 v */</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-81-3"><a id="__codelineno-81-3" name="__codelineno-81-3"></a>
</span><span id="__span-81-4"><a id="__codelineno-81-4" name="__codelineno-81-4"></a><span class="c1">// 带默认值</span>
</span><span id="__span-81-5"><a id="__codelineno-81-5" name="__codelineno-81-5"></a><span class="nx">v</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">ResumeValueOrDefault</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;approval&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;no&quot;</span><span class="p">)</span>
</span><span id="__span-81-6"><a id="__codelineno-81-6" name="__codelineno-81-6"></a>
</span><span id="__span-81-7"><a id="__codelineno-81-7" name="__codelineno-81-7"></a><span class="c1">// 判断/清理</span>
</span><span id="__span-81-8"><a id="__codelineno-81-8" name="__codelineno-81-8"></a><span class="nx">_</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">HasResumeValue</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;approval&quot;</span><span class="p">)</span>
</span><span id="__span-81-9"><a id="__codelineno-81-9" name="__codelineno-81-9"></a><span class="nx">graph</span><span class="p">.</span><span class="nx">ClearResumeValue</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;approval&quot;</span><span class="p">)</span>
</span><span id="__span-81-10"><a id="__codelineno-81-10" name="__codelineno-81-10"></a><span class="nx">graph</span><span class="p">.</span><span class="nx">ClearAllResumeValues</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>也可以在执行入口通过命令注入恢复值（无需提前到特定节点）。使用 Runner 传入 <code>RuntimeState</code> 即可：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-82-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-82-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-82-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-82-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-82-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-82-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-82-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-82-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-82-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-82-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-82-1"><a id="__codelineno-82-1" name="__codelineno-82-1"></a><span class="nx">cmd</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewResumeCommand</span><span class="p">().</span>
</span><span id="__span-82-2"><a id="__codelineno-82-2" name="__codelineno-82-2"></a><span class="w">    </span><span class="nx">WithResumeMap</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">any</span><span class="p">{</span><span class="s">&quot;approval&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span><span class="p">})</span>
</span><span id="__span-82-3"><a id="__codelineno-82-3" name="__codelineno-82-3"></a>
</span><span id="__span-82-4"><a id="__codelineno-82-4" name="__codelineno-82-4"></a><span class="c1">// 通过 RuntimeState 注入 __command__ 到初始状态</span>
</span><span id="__span-82-5"><a id="__codelineno-82-5" name="__codelineno-82-5"></a><span class="nx">events</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">userID</span><span class="p">,</span><span class="w"> </span><span class="nx">sessionID</span><span class="p">,</span>
</span><span id="__span-82-6"><a id="__codelineno-82-6" name="__codelineno-82-6"></a><span class="w">    </span><span class="nx">model</span><span class="p">.</span><span class="nx">NewUserMessage</span><span class="p">(</span><span class="s">&quot;resume&quot;</span><span class="p">),</span>
</span><span id="__span-82-7"><a id="__codelineno-82-7" name="__codelineno-82-7"></a><span class="w">    </span><span class="nx">agent</span><span class="p">.</span><span class="nx">WithRuntimeState</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">any</span><span class="p">{</span>
</span><span id="__span-82-8"><a id="__codelineno-82-8" name="__codelineno-82-8"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyCommand</span><span class="p">:</span><span class="w"> </span><span class="nx">cmd</span><span class="p">,</span>
</span><span id="__span-82-9"><a id="__codelineno-82-9" name="__codelineno-82-9"></a><span class="w">    </span><span class="p">}),</span>
</span><span id="__span-82-10"><a id="__codelineno-82-10" name="__codelineno-82-10"></a><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="_38">事件监控</h3>
<p>事件流承载了整个图的执行过程与增量输出。下面的示例展示了如何遍历事件并区分图事件与模型增量：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-83-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-83-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-83-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-83-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-83-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-83-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-83-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-83-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-83-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-83-10">10</a></span>
<span class="normal"><a href="#__codelineno-83-11">11</a></span>
<span class="normal"><a href="#__codelineno-83-12">12</a></span>
<span class="normal"><a href="#__codelineno-83-13">13</a></span>
<span class="normal"><a href="#__codelineno-83-14">14</a></span>
<span class="normal"><a href="#__codelineno-83-15">15</a></span>
<span class="normal"><a href="#__codelineno-83-16">16</a></span>
<span class="normal"><a href="#__codelineno-83-17">17</a></span>
<span class="normal"><a href="#__codelineno-83-18">18</a></span>
<span class="normal"><a href="#__codelineno-83-19">19</a></span>
<span class="normal"><a href="#__codelineno-83-20">20</a></span>
<span class="normal"><a href="#__codelineno-83-21">21</a></span>
<span class="normal"><a href="#__codelineno-83-22">22</a></span>
<span class="normal"><a href="#__codelineno-83-23">23</a></span>
<span class="normal"><a href="#__codelineno-83-24">24</a></span>
<span class="normal"><a href="#__codelineno-83-25">25</a></span>
<span class="normal"><a href="#__codelineno-83-26">26</a></span>
<span class="normal"><a href="#__codelineno-83-27">27</a></span>
<span class="normal"><a href="#__codelineno-83-28">28</a></span>
<span class="normal"><a href="#__codelineno-83-29">29</a></span>
<span class="normal"><a href="#__codelineno-83-30">30</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-83-1"><a id="__codelineno-83-1" name="__codelineno-83-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-83-2"><a id="__codelineno-83-2" name="__codelineno-83-2"></a><span class="w">    </span><span class="s">&quot;fmt&quot;</span>
</span><span id="__span-83-3"><a id="__codelineno-83-3" name="__codelineno-83-3"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-83-4"><a id="__codelineno-83-4" name="__codelineno-83-4"></a><span class="p">)</span>
</span><span id="__span-83-5"><a id="__codelineno-83-5" name="__codelineno-83-5"></a>
</span><span id="__span-83-6"><a id="__codelineno-83-6" name="__codelineno-83-6"></a><span class="k">for</span><span class="w"> </span><span class="nx">ev</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">eventCh</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-83-7"><a id="__codelineno-83-7" name="__codelineno-83-7"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">ev</span><span class="p">.</span><span class="nx">Response</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-83-8"><a id="__codelineno-83-8" name="__codelineno-83-8"></a><span class="w">        </span><span class="k">continue</span>
</span><span id="__span-83-9"><a id="__codelineno-83-9" name="__codelineno-83-9"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-83-10"><a id="__codelineno-83-10" name="__codelineno-83-10"></a><span class="w">    </span><span class="c1">// 按对象类型分流（Graph 扩展事件类型见 graph/events.go）</span>
</span><span id="__span-83-11"><a id="__codelineno-83-11" name="__codelineno-83-11"></a><span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="nx">ev</span><span class="p">.</span><span class="nx">Response</span><span class="p">.</span><span class="nx">Object</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-83-12"><a id="__codelineno-83-12" name="__codelineno-83-12"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">ObjectTypeGraphNodeStart</span><span class="p">:</span>
</span><span id="__span-83-13"><a id="__codelineno-83-13" name="__codelineno-83-13"></a><span class="w">        </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;节点开始&quot;</span><span class="p">)</span>
</span><span id="__span-83-14"><a id="__codelineno-83-14" name="__codelineno-83-14"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">ObjectTypeGraphNodeComplete</span><span class="p">:</span>
</span><span id="__span-83-15"><a id="__codelineno-83-15" name="__codelineno-83-15"></a><span class="w">        </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;节点完成&quot;</span><span class="p">)</span>
</span><span id="__span-83-16"><a id="__codelineno-83-16" name="__codelineno-83-16"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">ObjectTypeGraphChannelUpdate</span><span class="p">:</span>
</span><span id="__span-83-17"><a id="__codelineno-83-17" name="__codelineno-83-17"></a><span class="w">        </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;通道更新&quot;</span><span class="p">)</span>
</span><span id="__span-83-18"><a id="__codelineno-83-18" name="__codelineno-83-18"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">ObjectTypeGraphCheckpoint</span><span class="p">,</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">ObjectTypeGraphCheckpointCommitted</span><span class="p">:</span>
</span><span id="__span-83-19"><a id="__codelineno-83-19" name="__codelineno-83-19"></a><span class="w">        </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;检查点事件&quot;</span><span class="p">)</span>
</span><span id="__span-83-20"><a id="__codelineno-83-20" name="__codelineno-83-20"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-83-21"><a id="__codelineno-83-21" name="__codelineno-83-21"></a><span class="w">    </span><span class="c1">// 同时处理模型增量/最终输出</span>
</span><span id="__span-83-22"><a id="__codelineno-83-22" name="__codelineno-83-22"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">ev</span><span class="p">.</span><span class="nx">Response</span><span class="p">.</span><span class="nx">Choices</span><span class="p">)</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-83-23"><a id="__codelineno-83-23" name="__codelineno-83-23"></a><span class="w">        </span><span class="nx">ch</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">ev</span><span class="p">.</span><span class="nx">Response</span><span class="p">.</span><span class="nx">Choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="__span-83-24"><a id="__codelineno-83-24" name="__codelineno-83-24"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">ev</span><span class="p">.</span><span class="nx">Response</span><span class="p">.</span><span class="nx">IsPartial</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">ch</span><span class="p">.</span><span class="nx">Delta</span><span class="p">.</span><span class="nx">Content</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-83-25"><a id="__codelineno-83-25" name="__codelineno-83-25"></a><span class="w">            </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Print</span><span class="p">(</span><span class="nx">ch</span><span class="p">.</span><span class="nx">Delta</span><span class="p">.</span><span class="nx">Content</span><span class="p">)</span>
</span><span id="__span-83-26"><a id="__codelineno-83-26" name="__codelineno-83-26"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">!</span><span class="nx">ev</span><span class="p">.</span><span class="nx">Response</span><span class="p">.</span><span class="nx">IsPartial</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">ch</span><span class="p">.</span><span class="nx">Message</span><span class="p">.</span><span class="nx">Content</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-83-27"><a id="__codelineno-83-27" name="__codelineno-83-27"></a><span class="w">            </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;\n输出:&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">ch</span><span class="p">.</span><span class="nx">Message</span><span class="p">.</span><span class="nx">Content</span><span class="p">)</span>
</span><span id="__span-83-28"><a id="__codelineno-83-28" name="__codelineno-83-28"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-83-29"><a id="__codelineno-83-29" name="__codelineno-83-29"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-83-30"><a id="__codelineno-83-30" name="__codelineno-83-30"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>在实际使用中，建议结合 Event 的 <code>Author</code> 字段进行过滤：</p>
<ul>
<li>节点级事件（模型、工具、节点起止）：<code>Author = &lt;nodeID&gt;</code>（若无法获取 nodeID，则为 <code>graph-node</code>）</li>
<li>Pregel（规划/执行/更新/错误）：<code>Author = graph.AuthorGraphPregel</code></li>
<li>执行器级别事件（状态更新/检查点等）：<code>Author = graph.AuthorGraphExecutor</code></li>
<li>用户输入事件（Runner 写入）：<code>Author = user</code></li>
</ul>
<p>利用这一约定，你可以精准订阅某个节点的流式输出，而无需在节点之间传递流式上下文（流式由事件通道统一承载，状态仍按 LangGraph 风格以结构化 State 传递）。</p>
<p>示例：仅消费节点 <code>ask</code> 的流式输出，并在完成时打印最终消息。</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-84-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-84-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-84-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-84-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-84-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-84-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-84-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-84-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-84-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-84-10">10</a></span>
<span class="normal"><a href="#__codelineno-84-11">11</a></span>
<span class="normal"><a href="#__codelineno-84-12">12</a></span>
<span class="normal"><a href="#__codelineno-84-13">13</a></span>
<span class="normal"><a href="#__codelineno-84-14">14</a></span>
<span class="normal"><a href="#__codelineno-84-15">15</a></span>
<span class="normal"><a href="#__codelineno-84-16">16</a></span>
<span class="normal"><a href="#__codelineno-84-17">17</a></span>
<span class="normal"><a href="#__codelineno-84-18">18</a></span>
<span class="normal"><a href="#__codelineno-84-19">19</a></span>
<span class="normal"><a href="#__codelineno-84-20">20</a></span>
<span class="normal"><a href="#__codelineno-84-21">21</a></span>
<span class="normal"><a href="#__codelineno-84-22">22</a></span>
<span class="normal"><a href="#__codelineno-84-23">23</a></span>
<span class="normal"><a href="#__codelineno-84-24">24</a></span>
<span class="normal"><a href="#__codelineno-84-25">25</a></span>
<span class="normal"><a href="#__codelineno-84-26">26</a></span>
<span class="normal"><a href="#__codelineno-84-27">27</a></span>
<span class="normal"><a href="#__codelineno-84-28">28</a></span>
<span class="normal"><a href="#__codelineno-84-29">29</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-84-1"><a id="__codelineno-84-1" name="__codelineno-84-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-84-2"><a id="__codelineno-84-2" name="__codelineno-84-2"></a><span class="w">    </span><span class="s">&quot;fmt&quot;</span>
</span><span id="__span-84-3"><a id="__codelineno-84-3" name="__codelineno-84-3"></a>
</span><span id="__span-84-4"><a id="__codelineno-84-4" name="__codelineno-84-4"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-84-5"><a id="__codelineno-84-5" name="__codelineno-84-5"></a><span class="p">)</span>
</span><span id="__span-84-6"><a id="__codelineno-84-6" name="__codelineno-84-6"></a>
</span><span id="__span-84-7"><a id="__codelineno-84-7" name="__codelineno-84-7"></a><span class="kd">const</span><span class="w"> </span><span class="nx">nodeIDWatch</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;ask&quot;</span>
</span><span id="__span-84-8"><a id="__codelineno-84-8" name="__codelineno-84-8"></a>
</span><span id="__span-84-9"><a id="__codelineno-84-9" name="__codelineno-84-9"></a><span class="k">for</span><span class="w"> </span><span class="nx">ev</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">eventCh</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-84-10"><a id="__codelineno-84-10" name="__codelineno-84-10"></a><span class="w">    </span><span class="c1">// 仅关注来自指定节点的事件</span>
</span><span id="__span-84-11"><a id="__codelineno-84-11" name="__codelineno-84-11"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">ev</span><span class="p">.</span><span class="nx">Author</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">nodeIDWatch</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-84-12"><a id="__codelineno-84-12" name="__codelineno-84-12"></a><span class="w">        </span><span class="k">continue</span>
</span><span id="__span-84-13"><a id="__codelineno-84-13" name="__codelineno-84-13"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-84-14"><a id="__codelineno-84-14" name="__codelineno-84-14"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">ev</span><span class="p">.</span><span class="nx">Response</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">ev</span><span class="p">.</span><span class="nx">Response</span><span class="p">.</span><span class="nx">Choices</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-84-15"><a id="__codelineno-84-15" name="__codelineno-84-15"></a><span class="w">        </span><span class="k">continue</span>
</span><span id="__span-84-16"><a id="__codelineno-84-16" name="__codelineno-84-16"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-84-17"><a id="__codelineno-84-17" name="__codelineno-84-17"></a><span class="w">    </span><span class="nx">choice</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">ev</span><span class="p">.</span><span class="nx">Response</span><span class="p">.</span><span class="nx">Choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="__span-84-18"><a id="__codelineno-84-18" name="__codelineno-84-18"></a>
</span><span id="__span-84-19"><a id="__codelineno-84-19" name="__codelineno-84-19"></a><span class="w">    </span><span class="c1">// 节点的流式增量（Delta）</span>
</span><span id="__span-84-20"><a id="__codelineno-84-20" name="__codelineno-84-20"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">ev</span><span class="p">.</span><span class="nx">Response</span><span class="p">.</span><span class="nx">IsPartial</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">choice</span><span class="p">.</span><span class="nx">Delta</span><span class="p">.</span><span class="nx">Content</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-84-21"><a id="__codelineno-84-21" name="__codelineno-84-21"></a><span class="w">        </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Print</span><span class="p">(</span><span class="nx">choice</span><span class="p">.</span><span class="nx">Delta</span><span class="p">.</span><span class="nx">Content</span><span class="p">)</span>
</span><span id="__span-84-22"><a id="__codelineno-84-22" name="__codelineno-84-22"></a><span class="w">        </span><span class="k">continue</span>
</span><span id="__span-84-23"><a id="__codelineno-84-23" name="__codelineno-84-23"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-84-24"><a id="__codelineno-84-24" name="__codelineno-84-24"></a>
</span><span id="__span-84-25"><a id="__codelineno-84-25" name="__codelineno-84-25"></a><span class="w">    </span><span class="c1">// 节点的最终完整消息</span>
</span><span id="__span-84-26"><a id="__codelineno-84-26" name="__codelineno-84-26"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">!</span><span class="nx">ev</span><span class="p">.</span><span class="nx">Response</span><span class="p">.</span><span class="nx">IsPartial</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">choice</span><span class="p">.</span><span class="nx">Message</span><span class="p">.</span><span class="nx">Content</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-84-27"><a id="__codelineno-84-27" name="__codelineno-84-27"></a><span class="w">        </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;\n[ask] 最终输出:&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">choice</span><span class="p">.</span><span class="nx">Message</span><span class="p">.</span><span class="nx">Content</span><span class="p">)</span>
</span><span id="__span-84-28"><a id="__codelineno-84-28" name="__codelineno-84-28"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-84-29"><a id="__codelineno-84-29" name="__codelineno-84-29"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<h4 id="streammode">StreamMode</h4>
<p>Runner 可以在事件到达你的业务代码之前先做一次过滤，这样你只会收到你关心的一小类事件
（例如只关心模型输出用于流式展示）。</p>
<p>使用 <code>agent.WithStreamMode(...)</code>：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-85-1">1</a></span>
<span class="normal"><a href="#__codelineno-85-2">2</a></span>
<span class="normal"><a href="#__codelineno-85-3">3</a></span>
<span class="normal"><a href="#__codelineno-85-4">4</a></span>
<span class="normal"><a href="#__codelineno-85-5">5</a></span>
<span class="normal"><a href="#__codelineno-85-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-85-1"><a id="__codelineno-85-1" name="__codelineno-85-1"></a><span class="nx">eventCh</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">userID</span><span class="p">,</span><span class="w"> </span><span class="nx">sessionID</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="p">,</span>
</span><span id="__span-85-2"><a id="__codelineno-85-2" name="__codelineno-85-2"></a><span class="w">    </span><span class="nx">agent</span><span class="p">.</span><span class="nx">WithStreamMode</span><span class="p">(</span>
</span><span id="__span-85-3"><a id="__codelineno-85-3" name="__codelineno-85-3"></a><span class="w">        </span><span class="nx">agent</span><span class="p">.</span><span class="nx">StreamModeMessages</span><span class="p">,</span>
</span><span id="__span-85-4"><a id="__codelineno-85-4" name="__codelineno-85-4"></a><span class="w">        </span><span class="nx">agent</span><span class="p">.</span><span class="nx">StreamModeCustom</span><span class="p">,</span>
</span><span id="__span-85-5"><a id="__codelineno-85-5" name="__codelineno-85-5"></a><span class="w">    </span><span class="p">),</span>
</span><span id="__span-85-6"><a id="__codelineno-85-6" name="__codelineno-85-6"></a><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>支持的模式（图式工作流）：</p>
<ul>
<li><code>messages</code>：模型输出事件（例如 <code>chat.completion.chunk</code>）</li>
<li><code>updates</code>：<code>graph.state.update</code> / <code>graph.channel.update</code> / <code>graph.execution</code></li>
<li><code>checkpoints</code>：<code>graph.checkpoint.*</code></li>
<li><code>tasks</code>：任务生命周期事件（<code>graph.node.*</code>、<code>graph.pregel.*</code>）</li>
<li><code>debug</code>：等价于 <code>checkpoints</code> + <code>tasks</code></li>
<li><code>custom</code>：节点主动发出的自定义事件（<code>graph.node.custom</code>）</li>
</ul>
<p>注意事项：</p>
<ul>
<li>当选择 <code>agent.StreamModeMessages</code> 时，Runner 会为本次运行自动开启 Graph 的最终响应事件
  输出。若你需要关闭该行为，请在 <code>agent.WithStreamMode(...)</code> 之后调用
  <code>agent.WithGraphEmitFinalModelResponses(false)</code> 覆盖。</li>
<li>StreamMode 只影响 Runner 向你的 <code>eventCh</code> 转发哪些事件；Runner 内部仍会处理并持久化
  所有事件。</li>
<li>对于图式工作流，部分事件类型（例如 <code>graph.checkpoint.*</code>）只会在选择对应模式时才会产生。</li>
<li>Runner 总会额外发出一条 <code>runner.completion</code> 完成事件。</li>
</ul>
<h4 id="statedelta_1">事件元数据（StateDelta）</h4>
<p>每个事件还携带 <code>StateDelta</code>，可读取模型/工具等执行元数据：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-86-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-86-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-86-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-86-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-86-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-86-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-86-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-86-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-86-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-86-10">10</a></span>
<span class="normal"><a href="#__codelineno-86-11">11</a></span>
<span class="normal"><a href="#__codelineno-86-12">12</a></span>
<span class="normal"><a href="#__codelineno-86-13">13</a></span>
<span class="normal"><a href="#__codelineno-86-14">14</a></span>
<span class="normal"><a href="#__codelineno-86-15">15</a></span>
<span class="normal"><a href="#__codelineno-86-16">16</a></span>
<span class="normal"><a href="#__codelineno-86-17">17</a></span>
<span class="normal"><a href="#__codelineno-86-18">18</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-86-1"><a id="__codelineno-86-1" name="__codelineno-86-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-86-2"><a id="__codelineno-86-2" name="__codelineno-86-2"></a><span class="w">    </span><span class="s">&quot;encoding/json&quot;</span>
</span><span id="__span-86-3"><a id="__codelineno-86-3" name="__codelineno-86-3"></a>
</span><span id="__span-86-4"><a id="__codelineno-86-4" name="__codelineno-86-4"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-86-5"><a id="__codelineno-86-5" name="__codelineno-86-5"></a><span class="p">)</span>
</span><span id="__span-86-6"><a id="__codelineno-86-6" name="__codelineno-86-6"></a>
</span><span id="__span-86-7"><a id="__codelineno-86-7" name="__codelineno-86-7"></a><span class="k">for</span><span class="w"> </span><span class="nx">ev</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">events</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-86-8"><a id="__codelineno-86-8" name="__codelineno-86-8"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">ev</span><span class="p">.</span><span class="nx">StateDelta</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">continue</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-86-9"><a id="__codelineno-86-9" name="__codelineno-86-9"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">ev</span><span class="p">.</span><span class="nx">StateDelta</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">MetadataKeyModel</span><span class="p">];</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-86-10"><a id="__codelineno-86-10" name="__codelineno-86-10"></a><span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="nx">md</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">ModelExecutionMetadata</span>
</span><span id="__span-86-11"><a id="__codelineno-86-11" name="__codelineno-86-11"></a><span class="w">        </span><span class="nx">_</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">json</span><span class="p">.</span><span class="nx">Unmarshal</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">md</span><span class="p">)</span>
</span><span id="__span-86-12"><a id="__codelineno-86-12" name="__codelineno-86-12"></a><span class="w">        </span><span class="c1">// 使用 md.Input / md.Output / md.Duration 等</span>
</span><span id="__span-86-13"><a id="__codelineno-86-13" name="__codelineno-86-13"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-86-14"><a id="__codelineno-86-14" name="__codelineno-86-14"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">ev</span><span class="p">.</span><span class="nx">StateDelta</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">MetadataKeyTool</span><span class="p">];</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-86-15"><a id="__codelineno-86-15" name="__codelineno-86-15"></a><span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="nx">td</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">ToolExecutionMetadata</span>
</span><span id="__span-86-16"><a id="__codelineno-86-16" name="__codelineno-86-16"></a><span class="w">        </span><span class="nx">_</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">json</span><span class="p">.</span><span class="nx">Unmarshal</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">td</span><span class="p">)</span>
</span><span id="__span-86-17"><a id="__codelineno-86-17" name="__codelineno-86-17"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-86-18"><a id="__codelineno-86-18" name="__codelineno-86-18"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<h4 id="_39">在节点回调中携带业务值</h4>
<p>默认情况下，中途事件（如 <code>graph.state.update</code>）只会上报“更新了哪些键”，不携带值；最终完成事件（<code>graph.execution</code>）的 <code>StateDelta</code> 才包含“最终状态快照”。如果仅需在“某个节点”完成后，将其返回的部分键值即时发给上游服务，可在该节点的 After 回调中构造并发送一条自定义事件：</p>
<p>实现步骤：</p>
<ul>
<li>在节点上注册 <code>WithPostNodeCallback</code>；</li>
<li>在回调的 <code>result any</code> 中读取该节点返回的 <code>graph.State</code>（state delta）；</li>
<li>选择需要的键值，序列化后放入自定义事件的 <code>StateDelta</code>；</li>
<li>通过 <code>agent.EmitEvent</code> 发送到事件通道。</li>
</ul>
<p>示例：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-87-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-87-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-87-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-87-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-87-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-87-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-87-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-87-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-87-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-87-10">10</a></span>
<span class="normal"><a href="#__codelineno-87-11">11</a></span>
<span class="normal"><a href="#__codelineno-87-12">12</a></span>
<span class="normal"><a href="#__codelineno-87-13">13</a></span>
<span class="normal"><a href="#__codelineno-87-14">14</a></span>
<span class="normal"><a href="#__codelineno-87-15">15</a></span>
<span class="normal"><a href="#__codelineno-87-16">16</a></span>
<span class="normal"><a href="#__codelineno-87-17">17</a></span>
<span class="normal"><a href="#__codelineno-87-18">18</a></span>
<span class="normal"><a href="#__codelineno-87-19">19</a></span>
<span class="normal"><a href="#__codelineno-87-20">20</a></span>
<span class="normal"><a href="#__codelineno-87-21">21</a></span>
<span class="normal"><a href="#__codelineno-87-22">22</a></span>
<span class="normal"><a href="#__codelineno-87-23">23</a></span>
<span class="normal"><a href="#__codelineno-87-24">24</a></span>
<span class="normal"><a href="#__codelineno-87-25">25</a></span>
<span class="normal"><a href="#__codelineno-87-26">26</a></span>
<span class="normal"><a href="#__codelineno-87-27">27</a></span>
<span class="normal"><a href="#__codelineno-87-28">28</a></span>
<span class="normal"><a href="#__codelineno-87-29">29</a></span>
<span class="normal"><a href="#__codelineno-87-30">30</a></span>
<span class="normal"><a href="#__codelineno-87-31">31</a></span>
<span class="normal"><a href="#__codelineno-87-32">32</a></span>
<span class="normal"><a href="#__codelineno-87-33">33</a></span>
<span class="normal"><a href="#__codelineno-87-34">34</a></span>
<span class="normal"><a href="#__codelineno-87-35">35</a></span>
<span class="normal"><a href="#__codelineno-87-36">36</a></span>
<span class="normal"><a href="#__codelineno-87-37">37</a></span>
<span class="normal"><a href="#__codelineno-87-38">38</a></span>
<span class="normal"><a href="#__codelineno-87-39">39</a></span>
<span class="normal"><a href="#__codelineno-87-40">40</a></span>
<span class="normal"><a href="#__codelineno-87-41">41</a></span>
<span class="normal"><a href="#__codelineno-87-42">42</a></span>
<span class="normal"><a href="#__codelineno-87-43">43</a></span>
<span class="normal"><a href="#__codelineno-87-44">44</a></span>
<span class="normal"><a href="#__codelineno-87-45">45</a></span>
<span class="normal"><a href="#__codelineno-87-46">46</a></span>
<span class="normal"><a href="#__codelineno-87-47">47</a></span>
<span class="normal"><a href="#__codelineno-87-48">48</a></span>
<span class="normal"><a href="#__codelineno-87-49">49</a></span>
<span class="normal"><a href="#__codelineno-87-50">50</a></span>
<span class="normal"><a href="#__codelineno-87-51">51</a></span>
<span class="normal"><a href="#__codelineno-87-52">52</a></span>
<span class="normal"><a href="#__codelineno-87-53">53</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-87-1"><a id="__codelineno-87-1" name="__codelineno-87-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-87-2"><a id="__codelineno-87-2" name="__codelineno-87-2"></a><span class="w">    </span><span class="s">&quot;context&quot;</span>
</span><span id="__span-87-3"><a id="__codelineno-87-3" name="__codelineno-87-3"></a><span class="w">    </span><span class="s">&quot;encoding/json&quot;</span>
</span><span id="__span-87-4"><a id="__codelineno-87-4" name="__codelineno-87-4"></a>
</span><span id="__span-87-5"><a id="__codelineno-87-5" name="__codelineno-87-5"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/agent&quot;</span>
</span><span id="__span-87-6"><a id="__codelineno-87-6" name="__codelineno-87-6"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-87-7"><a id="__codelineno-87-7" name="__codelineno-87-7"></a><span class="p">)</span>
</span><span id="__span-87-8"><a id="__codelineno-87-8" name="__codelineno-87-8"></a>
</span><span id="__span-87-9"><a id="__codelineno-87-9" name="__codelineno-87-9"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-87-10"><a id="__codelineno-87-10" name="__codelineno-87-10"></a><span class="w">    </span><span class="nx">nodeParse</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;parse&quot;</span>
</span><span id="__span-87-11"><a id="__codelineno-87-11" name="__codelineno-87-11"></a><span class="w">    </span><span class="nx">stateKeyOut</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;parsed_value&quot;</span><span class="w"> </span><span class="c1">// 仅输出所需键</span>
</span><span id="__span-87-12"><a id="__codelineno-87-12" name="__codelineno-87-12"></a><span class="p">)</span>
</span><span id="__span-87-13"><a id="__codelineno-87-13" name="__codelineno-87-13"></a>
</span><span id="__span-87-14"><a id="__codelineno-87-14" name="__codelineno-87-14"></a><span class="kd">func</span><span class="w"> </span><span class="nx">parseNode</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-87-15"><a id="__codelineno-87-15" name="__codelineno-87-15"></a><span class="w">    </span><span class="c1">// ...业务处理...</span>
</span><span id="__span-87-16"><a id="__codelineno-87-16" name="__codelineno-87-16"></a><span class="w">    </span><span class="nx">val</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">any</span><span class="p">{</span><span class="s">&quot;ok&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;score&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.97</span><span class="p">}</span>
</span><span id="__span-87-17"><a id="__codelineno-87-17" name="__codelineno-87-17"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="nx">stateKeyOut</span><span class="p">:</span><span class="w"> </span><span class="nx">val</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-87-18"><a id="__codelineno-87-18" name="__codelineno-87-18"></a><span class="p">}</span>
</span><span id="__span-87-19"><a id="__codelineno-87-19" name="__codelineno-87-19"></a>
</span><span id="__span-87-20"><a id="__codelineno-87-20" name="__codelineno-87-20"></a><span class="kd">func</span><span class="w"> </span><span class="nx">buildGraph</span><span class="p">()</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">graph</span><span class="p">.</span><span class="nx">Graph</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-87-21"><a id="__codelineno-87-21" name="__codelineno-87-21"></a><span class="w">    </span><span class="nx">sg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateGraph</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">MessagesStateSchema</span><span class="p">())</span>
</span><span id="__span-87-22"><a id="__codelineno-87-22" name="__codelineno-87-22"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="nx">nodeParse</span><span class="p">,</span><span class="w"> </span><span class="nx">parseNode</span><span class="p">,</span>
</span><span id="__span-87-23"><a id="__codelineno-87-23" name="__codelineno-87-23"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithPostNodeCallback</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span>
</span><span id="__span-87-24"><a id="__codelineno-87-24" name="__codelineno-87-24"></a><span class="w">            </span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span>
</span><span id="__span-87-25"><a id="__codelineno-87-25" name="__codelineno-87-25"></a><span class="w">            </span><span class="nx">cb</span><span class="w"> </span><span class="o">*</span><span class="nx">graph</span><span class="p">.</span><span class="nx">NodeCallbackContext</span><span class="p">,</span>
</span><span id="__span-87-26"><a id="__codelineno-87-26" name="__codelineno-87-26"></a><span class="w">            </span><span class="nx">st</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">,</span>
</span><span id="__span-87-27"><a id="__codelineno-87-27" name="__codelineno-87-27"></a><span class="w">            </span><span class="nx">result</span><span class="w"> </span><span class="kt">any</span><span class="p">,</span>
</span><span id="__span-87-28"><a id="__codelineno-87-28" name="__codelineno-87-28"></a><span class="w">            </span><span class="nx">nodeErr</span><span class="w"> </span><span class="kt">error</span><span class="p">,</span>
</span><span id="__span-87-29"><a id="__codelineno-87-29" name="__codelineno-87-29"></a><span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-87-30"><a id="__codelineno-87-30" name="__codelineno-87-30"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">nodeErr</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-87-31"><a id="__codelineno-87-31" name="__codelineno-87-31"></a><span class="w">            </span><span class="nx">inv</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">agent</span><span class="p">.</span><span class="nx">InvocationFromContext</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</span><span id="__span-87-32"><a id="__codelineno-87-32" name="__codelineno-87-32"></a><span class="w">            </span><span class="nx">execCtx</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">st</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyExecContext</span><span class="p">].(</span><span class="o">*</span><span class="nx">graph</span><span class="p">.</span><span class="nx">ExecutionContext</span><span class="p">)</span>
</span><span id="__span-87-33"><a id="__codelineno-87-33" name="__codelineno-87-33"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">delta</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">result</span><span class="p">.(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">);</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-87-34"><a id="__codelineno-87-34" name="__codelineno-87-34"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="nx">v</span><span class="p">,</span><span class="w"> </span><span class="nx">exists</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">delta</span><span class="p">[</span><span class="nx">stateKeyOut</span><span class="p">];</span><span class="w"> </span><span class="nx">exists</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">execCtx</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-87-35"><a id="__codelineno-87-35" name="__codelineno-87-35"></a><span class="w">                    </span><span class="nx">evt</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewGraphEvent</span><span class="p">(</span>
</span><span id="__span-87-36"><a id="__codelineno-87-36" name="__codelineno-87-36"></a><span class="w">                        </span><span class="nx">inv</span><span class="p">.</span><span class="nx">InvocationID</span><span class="p">,</span>
</span><span id="__span-87-37"><a id="__codelineno-87-37" name="__codelineno-87-37"></a><span class="w">                        </span><span class="nx">cb</span><span class="p">.</span><span class="nx">NodeID</span><span class="p">,</span>
</span><span id="__span-87-38"><a id="__codelineno-87-38" name="__codelineno-87-38"></a><span class="w">                        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">ObjectTypeGraphNodeExecution</span><span class="p">,</span>
</span><span id="__span-87-39"><a id="__codelineno-87-39" name="__codelineno-87-39"></a><span class="w">                    </span><span class="p">)</span>
</span><span id="__span-87-40"><a id="__codelineno-87-40" name="__codelineno-87-40"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="nx">evt</span><span class="p">.</span><span class="nx">StateDelta</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">evt</span><span class="p">.</span><span class="nx">StateDelta</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">][]</span><span class="kt">byte</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-87-41"><a id="__codelineno-87-41" name="__codelineno-87-41"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">json</span><span class="p">.</span><span class="nx">Marshal</span><span class="p">(</span><span class="nx">v</span><span class="p">);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-87-42"><a id="__codelineno-87-42" name="__codelineno-87-42"></a><span class="w">                        </span><span class="nx">evt</span><span class="p">.</span><span class="nx">StateDelta</span><span class="p">[</span><span class="nx">stateKeyOut</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">b</span>
</span><span id="__span-87-43"><a id="__codelineno-87-43" name="__codelineno-87-43"></a><span class="w">                        </span><span class="nx">_</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">agent</span><span class="p">.</span><span class="nx">EmitEvent</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">inv</span><span class="p">,</span><span class="w"> </span><span class="nx">execCtx</span><span class="p">.</span><span class="nx">EventChan</span><span class="p">,</span><span class="w"> </span><span class="nx">evt</span><span class="p">)</span>
</span><span id="__span-87-44"><a id="__codelineno-87-44" name="__codelineno-87-44"></a><span class="w">                    </span><span class="p">}</span>
</span><span id="__span-87-45"><a id="__codelineno-87-45" name="__codelineno-87-45"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-87-46"><a id="__codelineno-87-46" name="__codelineno-87-46"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-87-47"><a id="__codelineno-87-47" name="__codelineno-87-47"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-87-48"><a id="__codelineno-87-48" name="__codelineno-87-48"></a><span class="w">        </span><span class="p">}),</span>
</span><span id="__span-87-49"><a id="__codelineno-87-49" name="__codelineno-87-49"></a><span class="w">    </span><span class="p">).</span>
</span><span id="__span-87-50"><a id="__codelineno-87-50" name="__codelineno-87-50"></a><span class="w">        </span><span class="nx">SetEntryPoint</span><span class="p">(</span><span class="nx">nodeParse</span><span class="p">).</span>
</span><span id="__span-87-51"><a id="__codelineno-87-51" name="__codelineno-87-51"></a><span class="w">        </span><span class="nx">SetFinishPoint</span><span class="p">(</span><span class="nx">nodeParse</span><span class="p">)</span>
</span><span id="__span-87-52"><a id="__codelineno-87-52" name="__codelineno-87-52"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">sg</span><span class="p">.</span><span class="nx">Compile</span><span class="p">()</span>
</span><span id="__span-87-53"><a id="__codelineno-87-53" name="__codelineno-87-53"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>建议：</p>
<ul>
<li>仅输出必要键，控制负载与敏感信息；</li>
<li>内部/易变键不会被序列化到最终快照，亦不建议外发（参考 <a href="https://github.com/trpc-group/trpc-agent-go/blob/main/graph/internal_keys.go#L16">graph/internal_keys.go:16</a>）；</li>
<li>文本类中间结果优先复用模型流式事件（<code>choice.Delta.Content</code>）。</li>
</ul>
<p>也可以在 Agent 级别配置回调：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-88-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-88-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-88-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-88-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-88-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-88-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-88-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-88-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-88-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-88-10">10</a></span>
<span class="normal"><a href="#__codelineno-88-11">11</a></span>
<span class="normal"><a href="#__codelineno-88-12">12</a></span>
<span class="normal"><a href="#__codelineno-88-13">13</a></span>
<span class="normal"><a href="#__codelineno-88-14">14</a></span>
<span class="normal"><a href="#__codelineno-88-15">15</a></span>
<span class="normal"><a href="#__codelineno-88-16">16</a></span>
<span class="normal"><a href="#__codelineno-88-17">17</a></span>
<span class="normal"><a href="#__codelineno-88-18">18</a></span>
<span class="normal"><a href="#__codelineno-88-19">19</a></span>
<span class="normal"><a href="#__codelineno-88-20">20</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-88-1"><a id="__codelineno-88-1" name="__codelineno-88-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-88-2"><a id="__codelineno-88-2" name="__codelineno-88-2"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/agent&quot;</span>
</span><span id="__span-88-3"><a id="__codelineno-88-3" name="__codelineno-88-3"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/model&quot;</span>
</span><span id="__span-88-4"><a id="__codelineno-88-4" name="__codelineno-88-4"></a><span class="p">)</span>
</span><span id="__span-88-5"><a id="__codelineno-88-5" name="__codelineno-88-5"></a>
</span><span id="__span-88-6"><a id="__codelineno-88-6" name="__codelineno-88-6"></a><span class="c1">// 方式一：构造回调并注册（推荐）</span>
</span><span id="__span-88-7"><a id="__codelineno-88-7" name="__codelineno-88-7"></a><span class="c1">// 注意：结构化回调 API 需要 trpc-agent-go &gt;= 0.6.0</span>
</span><span id="__span-88-8"><a id="__codelineno-88-8" name="__codelineno-88-8"></a><span class="nx">cb</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">agent</span><span class="p">.</span><span class="nx">NewCallbacks</span><span class="p">().</span>
</span><span id="__span-88-9"><a id="__codelineno-88-9" name="__codelineno-88-9"></a><span class="w">    </span><span class="nx">RegisterBeforeAgent</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">args</span><span class="w"> </span><span class="o">*</span><span class="nx">agent</span><span class="p">.</span><span class="nx">BeforeAgentArgs</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">agent</span><span class="p">.</span><span class="nx">BeforeAgentResult</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-88-10"><a id="__codelineno-88-10" name="__codelineno-88-10"></a><span class="w">        </span><span class="c1">// 返回非空 CustomResponse 可直接短路此轮执行</span>
</span><span id="__span-88-11"><a id="__codelineno-88-11" name="__codelineno-88-11"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-88-12"><a id="__codelineno-88-12" name="__codelineno-88-12"></a><span class="w">    </span><span class="p">}).</span>
</span><span id="__span-88-13"><a id="__codelineno-88-13" name="__codelineno-88-13"></a><span class="w">    </span><span class="nx">RegisterAfterAgent</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">args</span><span class="w"> </span><span class="o">*</span><span class="nx">agent</span><span class="p">.</span><span class="nx">AfterAgentArgs</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">agent</span><span class="p">.</span><span class="nx">AfterAgentResult</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-88-14"><a id="__codelineno-88-14" name="__codelineno-88-14"></a><span class="w">        </span><span class="c1">// 可对最终响应做统一修改/替换</span>
</span><span id="__span-88-15"><a id="__codelineno-88-15" name="__codelineno-88-15"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-88-16"><a id="__codelineno-88-16" name="__codelineno-88-16"></a><span class="w">    </span><span class="p">})</span>
</span><span id="__span-88-17"><a id="__codelineno-88-17" name="__codelineno-88-17"></a>
</span><span id="__span-88-18"><a id="__codelineno-88-18" name="__codelineno-88-18"></a><span class="nx">graphAgent</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;workflow&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">g</span><span class="p">,</span>
</span><span id="__span-88-19"><a id="__codelineno-88-19" name="__codelineno-88-19"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithAgentCallbacks</span><span class="p">(</span><span class="nx">cb</span><span class="p">),</span>
</span><span id="__span-88-20"><a id="__codelineno-88-20" name="__codelineno-88-20"></a><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<h2 id="_40">常见问题排查</h2>
<p><strong>Q1: 报错 "graph must have an entry point"</strong></p>
<ul>
<li>未设置入口点。调用 <code>SetEntryPoint()</code>，并确保目标节点已定义。</li>
</ul>
<p><strong>Q2: 报错目标/源节点不存在</strong></p>
<ul>
<li>在连边/条件路由前先定义节点；条件路由的 <code>pathMap</code> 目标也需存在。</li>
</ul>
<p><strong>Q3: 工具未执行</strong></p>
<ul>
<li>确认 LLM 返回了 <code>tool_calls</code>，并使用了 <code>AddToolsConditionalEdges(ask, tools, fallback)</code>；</li>
<li>工具名需与模型声明一致；</li>
<li>配对规则是从最近一次 <code>assistant(tool_calls)</code> 回溯到下一个 <code>user</code>，检查消息顺序。</li>
</ul>
<p><strong>Q4: LLM 返回 tool_calls 但工具节点未执行（永远路由到 fallback）</strong></p>
<ul>
<li><strong>根本原因</strong>：使用了 <code>NewStateSchema()</code> 而非 <code>MessagesStateSchema()</code>。</li>
<li><code>AddToolsConditionalEdges</code> 内部检查 <code>state[StateKeyMessages].([]model.Message)</code> 来判断是否有工具调用。</li>
<li>如果 Schema 中没有 <code>StateKeyMessages</code> 字段，<code>MessageReducer</code> 不会被应用，LLM 节点返回的是 <code>[]graph.MessageOp</code> 类型而非 <code>[]model.Message</code>，导致类型断言失败，永远路由到 <code>fallbackNode</code>。</li>
<li><strong>解决方案</strong>：将 <code>graph.NewStateSchema()</code> 改为 <code>graph.MessagesStateSchema()</code>，然后在其基础上添加业务字段：
  <div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-89-1">1</a></span>
<span class="normal"><a href="#__codelineno-89-2">2</a></span>
<span class="normal"><a href="#__codelineno-89-3">3</a></span>
<span class="normal"><a href="#__codelineno-89-4">4</a></span>
<span class="normal"><a href="#__codelineno-89-5">5</a></span>
<span class="normal"><a href="#__codelineno-89-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-89-1"><a id="__codelineno-89-1" name="__codelineno-89-1"></a><span class="c1">// 错误写法</span>
</span><span id="__span-89-2"><a id="__codelineno-89-2" name="__codelineno-89-2"></a><span class="nx">schema</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateSchema</span><span class="p">()</span>
</span><span id="__span-89-3"><a id="__codelineno-89-3" name="__codelineno-89-3"></a>
</span><span id="__span-89-4"><a id="__codelineno-89-4" name="__codelineno-89-4"></a><span class="c1">// 正确写法</span>
</span><span id="__span-89-5"><a id="__codelineno-89-5" name="__codelineno-89-5"></a><span class="nx">schema</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">MessagesStateSchema</span><span class="p">()</span>
</span><span id="__span-89-6"><a id="__codelineno-89-6" name="__codelineno-89-6"></a><span class="nx">schema</span><span class="p">.</span><span class="nx">AddField</span><span class="p">(</span><span class="s">&quot;my_field&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateField</span><span class="p">{</span><span class="o">...</span><span class="p">})</span>
</span></code></pre></div></td></tr></table></div></li>
</ul>
<p><strong>Q5: 没有观察到流式事件</strong></p>
<ul>
<li>调大 <code>WithChannelBufferSize</code> 并按 <code>Author</code>/对象类型过滤；</li>
<li>确认从 <code>Runner.Run(...)</code> 消费事件。</li>
</ul>
<p><strong>Q6: 从检查点恢复未按预期继续</strong></p>
<ul>
<li>通过 <code>agent.WithRuntimeState(map[string]any{ graph.CfgKeyLineageID: "...", graph.CfgKeyCheckpointID: "..." })</code> 传入；</li>
<li>HITL 恢复时提供 <code>ResumeMap</code>；纯 "resume" 文本不会注入到 <code>graph.StateKeyUserInput</code>。</li>
</ul>
<p><strong>Q7: 并行下状态冲突</strong></p>
<ul>
<li>为列表/映射等声明合并型 Reducer（如 <code>StringSliceReducer</code>、<code>MergeReducer</code>），避免多个分支覆盖同一键。</li>
</ul>
<p><strong>Q8: AddLLMNode 的 tools 参数起什么作用？工具何时被调用？</strong></p>
<ul>
<li><strong>tools 参数是声明性的</strong>：传给 <code>AddLLMNode</code> 的 tools 会被放入 <code>model.Request.Tools</code> 字段，告诉 LLM 有哪些工具可用。</li>
<li><strong>LLM 决定是否调用工具</strong>：LLM 根据 tools 声明和用户输入，决定是否在响应中返回 <code>tool_calls</code>。</li>
<li><strong>tools 不会自动执行</strong>：<code>AddLLMNode</code> 只负责声明工具、发送请求给 LLM，不会执行工具。</li>
<li><strong>工具执行需要配合 AddToolsNode + AddToolsConditionalEdges</strong>：
  <div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-90-1">1</a></span>
<span class="normal"><a href="#__codelineno-90-2">2</a></span>
<span class="normal"><a href="#__codelineno-90-3">3</a></span>
<span class="normal"><a href="#__codelineno-90-4">4</a></span>
<span class="normal"><a href="#__codelineno-90-5">5</a></span>
<span class="normal"><a href="#__codelineno-90-6">6</a></span>
<span class="normal"><a href="#__codelineno-90-7">7</a></span>
<span class="normal"><a href="#__codelineno-90-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-90-1"><a id="__codelineno-90-1" name="__codelineno-90-1"></a><span class="c1">// 1. LLM 节点声明工具（告诉 LLM 有哪些工具可用）</span>
</span><span id="__span-90-2"><a id="__codelineno-90-2" name="__codelineno-90-2"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddLLMNode</span><span class="p">(</span><span class="s">&quot;ask&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">model</span><span class="p">,</span><span class="w"> </span><span class="nx">systemPrompt</span><span class="p">,</span><span class="w"> </span><span class="nx">tools</span><span class="p">)</span>
</span><span id="__span-90-3"><a id="__codelineno-90-3" name="__codelineno-90-3"></a>
</span><span id="__span-90-4"><a id="__codelineno-90-4" name="__codelineno-90-4"></a><span class="c1">// 2. 工具节点负责执行工具（根据 LLM 返回的 tool_calls）</span>
</span><span id="__span-90-5"><a id="__codelineno-90-5" name="__codelineno-90-5"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddToolsNode</span><span class="p">(</span><span class="s">&quot;tools&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">tools</span><span class="p">)</span>
</span><span id="__span-90-6"><a id="__codelineno-90-6" name="__codelineno-90-6"></a>
</span><span id="__span-90-7"><a id="__codelineno-90-7" name="__codelineno-90-7"></a><span class="c1">// 3. 条件边根据 LLM 响应路由（有 tool_calls 则路由到工具节点）</span>
</span><span id="__span-90-8"><a id="__codelineno-90-8" name="__codelineno-90-8"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddToolsConditionalEdges</span><span class="p">(</span><span class="s">&quot;ask&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;tools&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;fallback&quot;</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div></li>
<li><strong>调用时机</strong>：当 <code>AddToolsConditionalEdges</code> 检测到 LLM 响应中包含 <code>tool_calls</code> 时，会路由到 <code>AddToolsNode</code>，由工具节点执行实际调用。</li>
</ul>
<p><strong>Q9: 多个 LLM 节点串联时，req.Messages 中消息被重复追加</strong></p>
<ul>
<li><strong>问题现象</strong>：同一个用户输入在 <code>req.Messages</code> 中出现多次。</li>
<li><strong>根本原因</strong>：使用 <code>MessagesStateSchema()</code> 时，<code>MessageReducer</code> 会累积消息。每个 LLM 节点执行时，如果 <code>StateKeyUserInput</code> 不为空，会追加新的 user message。当存在循环（如工具调用循环）或多个 LLM 节点串联时，消息会不断累积。</li>
<li><strong>解决方案</strong>：在设置新的 <code>StateKeyUserInput</code> 之前，使用 <code>RemoveAllMessages</code> 清除之前的消息：
  <div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-91-1">1</a></span>
<span class="normal"><a href="#__codelineno-91-2">2</a></span>
<span class="normal"><a href="#__codelineno-91-3">3</a></span>
<span class="normal"><a href="#__codelineno-91-4">4</a></span>
<span class="normal"><a href="#__codelineno-91-5">5</a></span>
<span class="normal"><a href="#__codelineno-91-6">6</a></span>
<span class="normal"><a href="#__codelineno-91-7">7</a></span>
<span class="normal"><a href="#__codelineno-91-8">8</a></span>
<span class="normal"><a href="#__codelineno-91-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-91-1"><a id="__codelineno-91-1" name="__codelineno-91-1"></a><span class="c1">// 在准备 prompt 的节点中</span>
</span><span id="__span-91-2"><a id="__codelineno-91-2" name="__codelineno-91-2"></a><span class="kd">func</span><span class="w"> </span><span class="nx">preparePromptNode</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-91-3"><a id="__codelineno-91-3" name="__codelineno-91-3"></a><span class="w">    </span><span class="nx">userMessage</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">buildUserMessage</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</span><span id="__span-91-4"><a id="__codelineno-91-4" name="__codelineno-91-4"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span>
</span><span id="__span-91-5"><a id="__codelineno-91-5" name="__codelineno-91-5"></a><span class="w">        </span><span class="c1">// 关键：先清除之前的消息，避免累积</span>
</span><span id="__span-91-6"><a id="__codelineno-91-6" name="__codelineno-91-6"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyMessages</span><span class="p">:</span><span class="w">  </span><span class="nx">graph</span><span class="p">.</span><span class="nx">RemoveAllMessages</span><span class="p">{},</span>
</span><span id="__span-91-7"><a id="__codelineno-91-7" name="__codelineno-91-7"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyUserInput</span><span class="p">:</span><span class="w"> </span><span class="nx">userMessage</span><span class="p">,</span>
</span><span id="__span-91-8"><a id="__codelineno-91-8" name="__codelineno-91-8"></a><span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-91-9"><a id="__codelineno-91-9" name="__codelineno-91-9"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div></li>
<li><strong>注意</strong>：<code>WithSubgraphIsolatedMessages(true)</code> 只对 <code>AddSubgraphNode</code> 有效，对 <code>AddLLMNode</code> 无效。</li>
</ul>
<p><strong>Q10: 下游 Agent 节点拿到的输入是空的</strong></p>
<ul>
<li><strong>问题现象</strong>：<code>A (agent) → B (agent)</code> 串联时，B 能执行但看起来没拿到 A 的输出
  （<code>Invocation.Message.Content</code> 为空，或行为像“没输入”）。</li>
<li><strong>根本原因</strong>：Agent 节点把 <code>user_input</code> 当作输入消息，并在成功执行后清空它；
  边不会自动把上游输出“管道式”传下去。</li>
<li><strong>解决方案</strong>：在下游 Agent 执行前显式把目标值写入 <code>user_input</code>：
  <div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-92-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-92-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-92-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-92-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-92-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-92-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-92-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-92-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-92-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-92-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-92-1"><a id="__codelineno-92-1" name="__codelineno-92-1"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddAgentNode</span><span class="p">(</span><span class="s">&quot;B&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithSubgraphInputFromLastResponse</span><span class="p">())</span>
</span><span id="__span-92-2"><a id="__codelineno-92-2" name="__codelineno-92-2"></a><span class="c1">// 或：</span>
</span><span id="__span-92-3"><a id="__codelineno-92-3" name="__codelineno-92-3"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddAgentNode</span><span class="p">(</span><span class="s">&quot;B&quot;</span><span class="p">,</span>
</span><span id="__span-92-4"><a id="__codelineno-92-4" name="__codelineno-92-4"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithPreNodeCallback</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">cb</span><span class="w"> </span><span class="o">*</span><span class="nx">graph</span><span class="p">.</span><span class="nx">NodeCallbackContext</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-92-5"><a id="__codelineno-92-5" name="__codelineno-92-5"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">v</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">s</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyLastResponse</span><span class="p">].(</span><span class="kt">string</span><span class="p">);</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-92-6"><a id="__codelineno-92-6" name="__codelineno-92-6"></a><span class="w">            </span><span class="nx">s</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyUserInput</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">v</span>
</span><span id="__span-92-7"><a id="__codelineno-92-7" name="__codelineno-92-7"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-92-8"><a id="__codelineno-92-8" name="__codelineno-92-8"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-92-9"><a id="__codelineno-92-9" name="__codelineno-92-9"></a><span class="w">    </span><span class="p">}),</span>
</span><span id="__span-92-10"><a id="__codelineno-92-10" name="__codelineno-92-10"></a><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
  如果你需要消费“指定节点”的输出，可从 <code>node_responses[targetNodeID]</code> 取值并写入 <code>user_input</code>。</li>
</ul>
<p><strong>Q11: 下游 Agent 既要原始输入也要上游输出</strong></p>
<ul>
<li><strong>问题现象</strong>：你使用 <code>WithSubgraphInputFromLastResponse()</code> 让下游 Agent 把
  <code>last_response</code> 当作当前输入，但你还希望它同时拿到本次 Run 的原始用户请求。</li>
<li><strong>解决方案</strong>：把原始 <code>user_input</code> 持久化到自定义 state key（例如
  <code>original_user_input</code>），并在下游 Agent 节点执行前用 function 节点把
  <code>original + upstream</code> 显式拼接写回 <code>user_input</code>。
  见“Agent 节点：拼接原始输入与上游输出”。</li>
</ul>
<h2 id="_41">实际案例</h2>
<h3 id="_42">审批工作流</h3>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-93-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-93-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-93-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-93-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-93-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-93-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-93-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-93-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-93-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-93-10">10</a></span>
<span class="normal"><a href="#__codelineno-93-11">11</a></span>
<span class="normal"><a href="#__codelineno-93-12">12</a></span>
<span class="normal"><a href="#__codelineno-93-13">13</a></span>
<span class="normal"><a href="#__codelineno-93-14">14</a></span>
<span class="normal"><a href="#__codelineno-93-15">15</a></span>
<span class="normal"><a href="#__codelineno-93-16">16</a></span>
<span class="normal"><a href="#__codelineno-93-17">17</a></span>
<span class="normal"><a href="#__codelineno-93-18">18</a></span>
<span class="normal"><a href="#__codelineno-93-19">19</a></span>
<span class="normal"><a href="#__codelineno-93-20">20</a></span>
<span class="normal"><a href="#__codelineno-93-21">21</a></span>
<span class="normal"><a href="#__codelineno-93-22">22</a></span>
<span class="normal"><a href="#__codelineno-93-23">23</a></span>
<span class="normal"><a href="#__codelineno-93-24">24</a></span>
<span class="normal"><a href="#__codelineno-93-25">25</a></span>
<span class="normal"><a href="#__codelineno-93-26">26</a></span>
<span class="normal"><a href="#__codelineno-93-27">27</a></span>
<span class="normal"><a href="#__codelineno-93-28">28</a></span>
<span class="normal"><a href="#__codelineno-93-29">29</a></span>
<span class="normal"><a href="#__codelineno-93-30">30</a></span>
<span class="normal"><a href="#__codelineno-93-31">31</a></span>
<span class="normal"><a href="#__codelineno-93-32">32</a></span>
<span class="normal"><a href="#__codelineno-93-33">33</a></span>
<span class="normal"><a href="#__codelineno-93-34">34</a></span>
<span class="normal"><a href="#__codelineno-93-35">35</a></span>
<span class="normal"><a href="#__codelineno-93-36">36</a></span>
<span class="normal"><a href="#__codelineno-93-37">37</a></span>
<span class="normal"><a href="#__codelineno-93-38">38</a></span>
<span class="normal"><a href="#__codelineno-93-39">39</a></span>
<span class="normal"><a href="#__codelineno-93-40">40</a></span>
<span class="normal"><a href="#__codelineno-93-41">41</a></span>
<span class="normal"><a href="#__codelineno-93-42">42</a></span>
<span class="normal"><a href="#__codelineno-93-43">43</a></span>
<span class="normal"><a href="#__codelineno-93-44">44</a></span>
<span class="normal"><a href="#__codelineno-93-45">45</a></span>
<span class="normal"><a href="#__codelineno-93-46">46</a></span>
<span class="normal"><a href="#__codelineno-93-47">47</a></span>
<span class="normal"><a href="#__codelineno-93-48">48</a></span>
<span class="normal"><a href="#__codelineno-93-49">49</a></span>
<span class="normal"><a href="#__codelineno-93-50">50</a></span>
<span class="normal"><a href="#__codelineno-93-51">51</a></span>
<span class="normal"><a href="#__codelineno-93-52">52</a></span>
<span class="normal"><a href="#__codelineno-93-53">53</a></span>
<span class="normal"><a href="#__codelineno-93-54">54</a></span>
<span class="normal"><a href="#__codelineno-93-55">55</a></span>
<span class="normal"><a href="#__codelineno-93-56">56</a></span>
<span class="normal"><a href="#__codelineno-93-57">57</a></span>
<span class="normal"><a href="#__codelineno-93-58">58</a></span>
<span class="normal"><a href="#__codelineno-93-59">59</a></span>
<span class="normal"><a href="#__codelineno-93-60">60</a></span>
<span class="normal"><a href="#__codelineno-93-61">61</a></span>
<span class="normal"><a href="#__codelineno-93-62">62</a></span>
<span class="normal"><a href="#__codelineno-93-63">63</a></span>
<span class="normal"><a href="#__codelineno-93-64">64</a></span>
<span class="normal"><a href="#__codelineno-93-65">65</a></span>
<span class="normal"><a href="#__codelineno-93-66">66</a></span>
<span class="normal"><a href="#__codelineno-93-67">67</a></span>
<span class="normal"><a href="#__codelineno-93-68">68</a></span>
<span class="normal"><a href="#__codelineno-93-69">69</a></span>
<span class="normal"><a href="#__codelineno-93-70">70</a></span>
<span class="normal"><a href="#__codelineno-93-71">71</a></span>
<span class="normal"><a href="#__codelineno-93-72">72</a></span>
<span class="normal"><a href="#__codelineno-93-73">73</a></span>
<span class="normal"><a href="#__codelineno-93-74">74</a></span>
<span class="normal"><a href="#__codelineno-93-75">75</a></span>
<span class="normal"><a href="#__codelineno-93-76">76</a></span>
<span class="normal"><a href="#__codelineno-93-77">77</a></span>
<span class="normal"><a href="#__codelineno-93-78">78</a></span>
<span class="normal"><a href="#__codelineno-93-79">79</a></span>
<span class="normal"><a href="#__codelineno-93-80">80</a></span>
<span class="normal"><a href="#__codelineno-93-81">81</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-93-1"><a id="__codelineno-93-1" name="__codelineno-93-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-93-2"><a id="__codelineno-93-2" name="__codelineno-93-2"></a><span class="w">    </span><span class="s">&quot;context&quot;</span>
</span><span id="__span-93-3"><a id="__codelineno-93-3" name="__codelineno-93-3"></a><span class="w">    </span><span class="s">&quot;fmt&quot;</span>
</span><span id="__span-93-4"><a id="__codelineno-93-4" name="__codelineno-93-4"></a><span class="w">    </span><span class="s">&quot;strings&quot;</span>
</span><span id="__span-93-5"><a id="__codelineno-93-5" name="__codelineno-93-5"></a>
</span><span id="__span-93-6"><a id="__codelineno-93-6" name="__codelineno-93-6"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-93-7"><a id="__codelineno-93-7" name="__codelineno-93-7"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/model/openai&quot;</span>
</span><span id="__span-93-8"><a id="__codelineno-93-8" name="__codelineno-93-8"></a><span class="p">)</span>
</span><span id="__span-93-9"><a id="__codelineno-93-9" name="__codelineno-93-9"></a>
</span><span id="__span-93-10"><a id="__codelineno-93-10" name="__codelineno-93-10"></a><span class="kd">func</span><span class="w"> </span><span class="nx">buildApprovalWorkflow</span><span class="p">()</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">graph</span><span class="p">.</span><span class="nx">Graph</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-93-11"><a id="__codelineno-93-11" name="__codelineno-93-11"></a><span class="w">    </span><span class="nx">sg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateGraph</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">MessagesStateSchema</span><span class="p">())</span>
</span><span id="__span-93-12"><a id="__codelineno-93-12" name="__codelineno-93-12"></a>
</span><span id="__span-93-13"><a id="__codelineno-93-13" name="__codelineno-93-13"></a><span class="w">    </span><span class="c1">// AI 初审（定义 LLM 模型）</span>
</span><span id="__span-93-14"><a id="__codelineno-93-14" name="__codelineno-93-14"></a><span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-93-15"><a id="__codelineno-93-15" name="__codelineno-93-15"></a><span class="w">        </span><span class="nx">modelNameApprove</span><span class="w">      </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;gpt-4o-mini&quot;</span>
</span><span id="__span-93-16"><a id="__codelineno-93-16" name="__codelineno-93-16"></a><span class="w">        </span><span class="nx">promptApproveDecision</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;判断申请是否符合要求，回复 approve 或 reject&quot;</span>
</span><span id="__span-93-17"><a id="__codelineno-93-17" name="__codelineno-93-17"></a>
</span><span id="__span-93-18"><a id="__codelineno-93-18" name="__codelineno-93-18"></a><span class="w">        </span><span class="nx">nodeAIReview</span><span class="w">    </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;ai_review&quot;</span>
</span><span id="__span-93-19"><a id="__codelineno-93-19" name="__codelineno-93-19"></a><span class="w">        </span><span class="nx">nodeHumanReview</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;human_review&quot;</span>
</span><span id="__span-93-20"><a id="__codelineno-93-20" name="__codelineno-93-20"></a><span class="w">        </span><span class="nx">nodeApprove</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;approve&quot;</span>
</span><span id="__span-93-21"><a id="__codelineno-93-21" name="__codelineno-93-21"></a><span class="w">        </span><span class="nx">nodeReject</span><span class="w">      </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;reject&quot;</span>
</span><span id="__span-93-22"><a id="__codelineno-93-22" name="__codelineno-93-22"></a>
</span><span id="__span-93-23"><a id="__codelineno-93-23" name="__codelineno-93-23"></a><span class="w">        </span><span class="nx">routeHumanReview</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;route_human_review&quot;</span>
</span><span id="__span-93-24"><a id="__codelineno-93-24" name="__codelineno-93-24"></a><span class="w">        </span><span class="nx">routeReject</span><span class="w">      </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;route_reject&quot;</span>
</span><span id="__span-93-25"><a id="__codelineno-93-25" name="__codelineno-93-25"></a><span class="w">        </span><span class="nx">routeApprove</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;route_approve&quot;</span>
</span><span id="__span-93-26"><a id="__codelineno-93-26" name="__codelineno-93-26"></a>
</span><span id="__span-93-27"><a id="__codelineno-93-27" name="__codelineno-93-27"></a><span class="w">        </span><span class="nx">stateKeyApplication</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;application&quot;</span>
</span><span id="__span-93-28"><a id="__codelineno-93-28" name="__codelineno-93-28"></a><span class="w">        </span><span class="nx">stateKeyDecision</span><span class="w">    </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;decision&quot;</span>
</span><span id="__span-93-29"><a id="__codelineno-93-29" name="__codelineno-93-29"></a><span class="w">    </span><span class="p">)</span>
</span><span id="__span-93-30"><a id="__codelineno-93-30" name="__codelineno-93-30"></a>
</span><span id="__span-93-31"><a id="__codelineno-93-31" name="__codelineno-93-31"></a><span class="w">    </span><span class="nx">llm</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">openai</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="nx">modelNameApprove</span><span class="p">)</span>
</span><span id="__span-93-32"><a id="__codelineno-93-32" name="__codelineno-93-32"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddLLMNode</span><span class="p">(</span><span class="nx">nodeAIReview</span><span class="p">,</span><span class="w"> </span><span class="nx">llm</span><span class="p">,</span><span class="w"> </span><span class="nx">promptApproveDecision</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span><span class="p">)</span>
</span><span id="__span-93-33"><a id="__codelineno-93-33" name="__codelineno-93-33"></a>
</span><span id="__span-93-34"><a id="__codelineno-93-34" name="__codelineno-93-34"></a><span class="w">    </span><span class="c1">// 条件路由到人工审核或拒绝</span>
</span><span id="__span-93-35"><a id="__codelineno-93-35" name="__codelineno-93-35"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddConditionalEdges</span><span class="p">(</span><span class="nx">nodeAIReview</span><span class="p">,</span>
</span><span id="__span-93-36"><a id="__codelineno-93-36" name="__codelineno-93-36"></a><span class="w">        </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-93-37"><a id="__codelineno-93-37" name="__codelineno-93-37"></a><span class="w">            </span><span class="nx">resp</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">s</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyLastResponse</span><span class="p">].(</span><span class="kt">string</span><span class="p">)</span>
</span><span id="__span-93-38"><a id="__codelineno-93-38" name="__codelineno-93-38"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">strings</span><span class="p">.</span><span class="nx">Contains</span><span class="p">(</span><span class="nx">resp</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;approve&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-93-39"><a id="__codelineno-93-39" name="__codelineno-93-39"></a><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nx">routeHumanReview</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-93-40"><a id="__codelineno-93-40" name="__codelineno-93-40"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-93-41"><a id="__codelineno-93-41" name="__codelineno-93-41"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">routeReject</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-93-42"><a id="__codelineno-93-42" name="__codelineno-93-42"></a><span class="w">        </span><span class="p">},</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span>
</span><span id="__span-93-43"><a id="__codelineno-93-43" name="__codelineno-93-43"></a><span class="w">            </span><span class="nx">routeHumanReview</span><span class="p">:</span><span class="w"> </span><span class="nx">nodeHumanReview</span><span class="p">,</span>
</span><span id="__span-93-44"><a id="__codelineno-93-44" name="__codelineno-93-44"></a><span class="w">            </span><span class="nx">routeReject</span><span class="p">:</span><span class="w">      </span><span class="nx">nodeReject</span><span class="p">,</span>
</span><span id="__span-93-45"><a id="__codelineno-93-45" name="__codelineno-93-45"></a><span class="w">        </span><span class="p">})</span>
</span><span id="__span-93-46"><a id="__codelineno-93-46" name="__codelineno-93-46"></a>
</span><span id="__span-93-47"><a id="__codelineno-93-47" name="__codelineno-93-47"></a><span class="w">    </span><span class="c1">// 人工审核节点</span>
</span><span id="__span-93-48"><a id="__codelineno-93-48" name="__codelineno-93-48"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="nx">nodeHumanReview</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-93-49"><a id="__codelineno-93-49" name="__codelineno-93-49"></a><span class="w">        </span><span class="nx">app</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">s</span><span class="p">[</span><span class="nx">stateKeyApplication</span><span class="p">].(</span><span class="kt">string</span><span class="p">)</span>
</span><span id="__span-93-50"><a id="__codelineno-93-50" name="__codelineno-93-50"></a><span class="w">        </span><span class="nx">decision</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">Interrupt</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;approval&quot;</span><span class="p">,</span>
</span><span id="__span-93-51"><a id="__codelineno-93-51" name="__codelineno-93-51"></a><span class="w">            </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;请审批: %s&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">app</span><span class="p">))</span>
</span><span id="__span-93-52"><a id="__codelineno-93-52" name="__codelineno-93-52"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-93-53"><a id="__codelineno-93-53" name="__codelineno-93-53"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
</span><span id="__span-93-54"><a id="__codelineno-93-54" name="__codelineno-93-54"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-93-55"><a id="__codelineno-93-55" name="__codelineno-93-55"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="nx">stateKeyDecision</span><span class="p">:</span><span class="w"> </span><span class="nx">decision</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-93-56"><a id="__codelineno-93-56" name="__codelineno-93-56"></a><span class="w">    </span><span class="p">})</span>
</span><span id="__span-93-57"><a id="__codelineno-93-57" name="__codelineno-93-57"></a>
</span><span id="__span-93-58"><a id="__codelineno-93-58" name="__codelineno-93-58"></a><span class="w">    </span><span class="c1">// 结果处理</span>
</span><span id="__span-93-59"><a id="__codelineno-93-59" name="__codelineno-93-59"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="nx">nodeApprove</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-93-60"><a id="__codelineno-93-60" name="__codelineno-93-60"></a><span class="w">        </span><span class="c1">// 执行批准逻辑</span>
</span><span id="__span-93-61"><a id="__codelineno-93-61" name="__codelineno-93-61"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="s">&quot;status&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;approved&quot;</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-93-62"><a id="__codelineno-93-62" name="__codelineno-93-62"></a><span class="w">    </span><span class="p">})</span>
</span><span id="__span-93-63"><a id="__codelineno-93-63" name="__codelineno-93-63"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="nx">nodeReject</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-93-64"><a id="__codelineno-93-64" name="__codelineno-93-64"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="s">&quot;status&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;rejected&quot;</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-93-65"><a id="__codelineno-93-65" name="__codelineno-93-65"></a><span class="w">    </span><span class="p">})</span>
</span><span id="__span-93-66"><a id="__codelineno-93-66" name="__codelineno-93-66"></a>
</span><span id="__span-93-67"><a id="__codelineno-93-67" name="__codelineno-93-67"></a><span class="w">    </span><span class="c1">// 配置流程</span>
</span><span id="__span-93-68"><a id="__codelineno-93-68" name="__codelineno-93-68"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">SetEntryPoint</span><span class="p">(</span><span class="nx">nodeAIReview</span><span class="p">)</span>
</span><span id="__span-93-69"><a id="__codelineno-93-69" name="__codelineno-93-69"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddConditionalEdges</span><span class="p">(</span><span class="nx">nodeHumanReview</span><span class="p">,</span>
</span><span id="__span-93-70"><a id="__codelineno-93-70" name="__codelineno-93-70"></a><span class="w">        </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-93-71"><a id="__codelineno-93-71" name="__codelineno-93-71"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">s</span><span class="p">[</span><span class="nx">stateKeyDecision</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;approve&quot;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-93-72"><a id="__codelineno-93-72" name="__codelineno-93-72"></a><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nx">routeApprove</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-93-73"><a id="__codelineno-93-73" name="__codelineno-93-73"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-93-74"><a id="__codelineno-93-74" name="__codelineno-93-74"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">routeReject</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-93-75"><a id="__codelineno-93-75" name="__codelineno-93-75"></a><span class="w">        </span><span class="p">},</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span>
</span><span id="__span-93-76"><a id="__codelineno-93-76" name="__codelineno-93-76"></a><span class="w">            </span><span class="nx">routeApprove</span><span class="p">:</span><span class="w"> </span><span class="nx">nodeApprove</span><span class="p">,</span>
</span><span id="__span-93-77"><a id="__codelineno-93-77" name="__codelineno-93-77"></a><span class="w">            </span><span class="nx">routeReject</span><span class="p">:</span><span class="w">  </span><span class="nx">nodeReject</span><span class="p">,</span>
</span><span id="__span-93-78"><a id="__codelineno-93-78" name="__codelineno-93-78"></a><span class="w">        </span><span class="p">})</span>
</span><span id="__span-93-79"><a id="__codelineno-93-79" name="__codelineno-93-79"></a>
</span><span id="__span-93-80"><a id="__codelineno-93-80" name="__codelineno-93-80"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">sg</span><span class="p">.</span><span class="nx">Compile</span><span class="p">()</span>
</span><span id="__span-93-81"><a id="__codelineno-93-81" name="__codelineno-93-81"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<h2 id="_43">总结</h2>
<p>本文介绍了 <code>graph</code> 包与 GraphAgent 的核心用法：如何声明节点与路由、如何通过 Schema 与 Reducer 安全合并状态、以及如何利用事件、检查点与中断实现可观测与可恢复。对于结构化流程（审批、内容审核、分步数据处理等），Graph 提供稳定、可审计的执行路径；对于需要智能决策的环节，可通过 LLM 节点与子 Agent 灵活扩展。</p>
<h2 id="_44">参考与示例</h2>
<ul>
<li>代码仓库: https://github.com/trpc-group/trpc-agent-go</li>
<li>Graph 示例: <code>examples/graph</code> 目录（基础/并行/多轮/中断与恢复等）<ul>
<li>I/O 约定：<code>io_conventions</code>、<code>io_conventions_tools</code></li>
<li>并行 / 扇出：<code>parallel</code>、<code>fanout</code>、<code>diamond</code></li>
<li>占位符：<code>placeholder</code></li>
<li>检查点 / 中断：<code>checkpoint</code>、<code>interrupt</code>、<code>nested_interrupt</code>、<code>static_interrupt</code></li>
</ul>
</li>
<li>进一步阅读：<code>graph/state_graph.go</code>、<code>graph/executor.go</code>、<code>agent/graphagent</code></li>
</ul>







  
    
  
  
    
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="最后更新">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_datetime" title="2026年1月17日 13:05:53 UTC">2026-01-17 13:05:53</span>
  </span>

    
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="创建日期">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_datetime" title="2025年8月25日 07:06:16 UTC">2025-08-25 07:06:16</span>
  </span>

    
    
    
  </aside>


  



  <form class="md-feedback" name="feedback" hidden>
    <fieldset>
      <legend class="md-feedback__title">
        Was this page helpful?
      </legend>
      <div class="md-feedback__inner">
        <div class="md-feedback__list">
          
            <button class="md-feedback__icon md-icon" type="submit" title="This page was helpful" data-md-value="1">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m7 0c0 .8-.7 1.5-1.5 1.5S14 10.3 14 9.5 14.7 8 15.5 8s1.5.7 1.5 1.5m-5 7.73c-1.75 0-3.29-.73-4.19-1.81L9.23 14c.45.72 1.52 1.23 2.77 1.23s2.32-.51 2.77-1.23l1.42 1.42c-.9 1.08-2.44 1.81-4.19 1.81"/></svg>
            </button>
          
            <button class="md-feedback__icon md-icon" type="submit" title="This page could be improved" data-md-value="0">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10m-6.5-4c.8 0 1.5.7 1.5 1.5s-.7 1.5-1.5 1.5-1.5-.7-1.5-1.5.7-1.5 1.5-1.5M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m2 4.5c1.75 0 3.29.72 4.19 1.81l-1.42 1.42C14.32 16.5 13.25 16 12 16s-2.32.5-2.77 1.23l-1.42-1.42C8.71 14.72 10.25 14 12 14"/></svg>
            </button>
          
        </div>
        <div class="md-feedback__note">
          
            <div data-md-value="1" hidden>
              
              
                
              
              
              
                
                
              
              Thanks for your feedback!
            </div>
          
            <div data-md-value="0" hidden>
              
              
                
              
              
              
                
                
              
              Thanks for your feedback!<br>Please help us improve by opening an <a href="https://github.com/trpc-group/trpc-agent-go/issues/new" target="_blank" rel="noopener">issue</a>.
            </div>
          
        </div>
      </div>
    </fieldset>
  </form>


                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="页脚" >
        
          
          <a href="../team/" class="md-footer__link md-footer__link--prev" aria-label="上一页: Team">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                上一页
              </span>
              <div class="md-ellipsis">
                Team
              </div>
            </div>
          </a>
        
        
          
          <a href="../custom-agent/" class="md-footer__link md-footer__link--next" aria-label="下一页: 自定义 Agent">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                下一页
              </span>
              <div class="md-ellipsis">
                自定义 Agent
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["content.code.copy", "navigation.footer", "navigation.tabs", "search.suggest", "search.share", "content.action.edit", "content.action.view"], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.92b07e13.min.js"></script>
      
    
  </body>
</html>