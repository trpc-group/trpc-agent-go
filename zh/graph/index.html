
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://trpc-group.github.io/trpc-agent-go/zh/graph/">
      
      
        <link rel="prev" href="../planner/">
      
      
        <link rel="next" href="../event/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.17">
    
    
      
        <title>Graph Agent - tRPC-Agent-Go</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.7e37652d.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config",""),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#graph" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../" title="tRPC-Agent-Go" class="md-header__button md-logo" aria-label="tRPC-Agent-Go" data-md-component="logo">
      
  <img src="../../assets/img/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            tRPC-Agent-Go
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Graph Agent
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
      <div class="md-header__option">
  <div class="md-select">
    
    <button class="md-header__button md-icon" aria-label="选择当前语言">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m12.87 15.07-2.54-2.51.03-.03A17.5 17.5 0 0 0 14.07 6H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2zm-2.62 7 1.62-4.33L19.12 17z"/></svg>
    </button>
    <div class="md-select__inner">
      <ul class="md-select__list">
        
          <li class="md-select__item">
            <a href="../../graph/" hreflang="en" class="md-select__link">
              English
            </a>
          </li>
        
          <li class="md-select__item">
            <a href="./" hreflang="zh" class="md-select__link">
              中文
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</div>
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="分享" aria-label="分享" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/trpc-group/trpc-agent-go" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    trpc-group/trpc-agent-go
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../" class="md-tabs__link">
        
  
  
    
  
  概览

      </a>
    </li>
  

      
        
  
  
  
    
  
  
    
    
      
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../agent/" class="md-tabs__link">
          
  
  
  组件

        </a>
      </li>
    
  

    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../debugserver/" class="md-tabs__link">
          
  
  
  服务

        </a>
      </li>
    
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../observability/" class="md-tabs__link">
        
  
  
    
  
  可观测

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../ecosystem/" class="md-tabs__link">
        
  
  
    
  
  生态

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../" title="tRPC-Agent-Go" class="md-nav__button md-logo" aria-label="tRPC-Agent-Go" data-md-component="logo">
      
  <img src="../../assets/img/logo.png" alt="logo">

    </a>
    tRPC-Agent-Go
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/trpc-group/trpc-agent-go" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    trpc-group/trpc-agent-go
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    概览
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    组件
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            组件
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1" checked>
        
          
          <label class="md-nav__link" for="__nav_2_1" id="__nav_2_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Agent
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_1">
            <span class="md-nav__icon md-icon"></span>
            Agent
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Agent
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../multiagent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Multi Agent
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Graph Agent
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Graph Agent
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      概述
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      快速开始
    </span>
  </a>
  
    <nav class="md-nav" aria-label="快速开始">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      最小工作流
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      使用模式
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agent" class="md-nav__link">
    <span class="md-ellipsis">
      Agent 集成
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      主要特性
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      核心概念
    </span>
  </a>
  
    <nav class="md-nav" aria-label="核心概念">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-graph" class="md-nav__link">
    <span class="md-ellipsis">
      1. 图 (Graph)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-node" class="md-nav__link">
    <span class="md-ellipsis">
      2. 节点 (Node)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-state" class="md-nav__link">
    <span class="md-ellipsis">
      3. 状态 (State)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-stateschema" class="md-nav__link">
    <span class="md-ellipsis">
      4. 状态模式 (StateSchema)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      使用指南
    </span>
  </a>
  
    <nav class="md-nav" aria-label="使用指南">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#io" class="md-nav__link">
    <span class="md-ellipsis">
      节点 I/O 约定
    </span>
  </a>
  
    <nav class="md-nav" aria-label="节点 I/O 约定">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      状态键常量与来源（可直接引用）
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#statedelta" class="md-nav__link">
    <span class="md-ellipsis">
      事件元数据键（StateDelta）
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1-graphagent-runner" class="md-nav__link">
    <span class="md-ellipsis">
      1. 创建 GraphAgent 和 Runner
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-llm" class="md-nav__link">
    <span class="md-ellipsis">
      2. 使用 LLM 节点
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. 使用 LLM 节点">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      三种输入范式
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llm" class="md-nav__link">
    <span class="md-ellipsis">
      LLM 指令中的占位符
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reducer-messageop" class="md-nav__link">
    <span class="md-ellipsis">
      通过 Reducer 与 MessageOp 实现的原子更新
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-graphagent" class="md-nav__link">
    <span class="md-ellipsis">
      3. GraphAgent 配置选项
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4" class="md-nav__link">
    <span class="md-ellipsis">
      4. 条件路由
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#41-ends" class="md-nav__link">
    <span class="md-ellipsis">
      4.1 节点命名分支（Ends）
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5" class="md-nav__link">
    <span class="md-ellipsis">
      5. 工具节点集成
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6" class="md-nav__link">
    <span class="md-ellipsis">
      6. 节点重试与退避
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#7-runner" class="md-nav__link">
    <span class="md-ellipsis">
      7. Runner 配置
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#8" class="md-nav__link">
    <span class="md-ellipsis">
      8. 消息状态模式
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#9" class="md-nav__link">
    <span class="md-ellipsis">
      9. 状态键使用场景
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      高级功能
    </span>
  </a>
  
    <nav class="md-nav" aria-label="高级功能">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    <span class="md-ellipsis">
      1. 中断和恢复（人机协作）
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1. 中断和恢复（人机协作）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    <span class="md-ellipsis">
      基本用法
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    <span class="md-ellipsis">
      执行方式
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#graphagent" class="md-nav__link">
    <span class="md-ellipsis">
      GraphAgent 配置选项
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    <span class="md-ellipsis">
      核心概念
    </span>
  </a>
  
    <nav class="md-nav" aria-label="核心概念">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    <span class="md-ellipsis">
      状态管理
    </span>
  </a>
  
    <nav class="md-nav" aria-label="状态管理">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#schema" class="md-nav__link">
    <span class="md-ellipsis">
      使用内置 Schema
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#schema_1" class="md-nav__link">
    <span class="md-ellipsis">
      自定义 Schema
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_15" class="md-nav__link">
    <span class="md-ellipsis">
      节点类型
    </span>
  </a>
  
    <nav class="md-nav" aria-label="节点类型">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#function" class="md-nav__link">
    <span class="md-ellipsis">
      Function 节点
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llm_1" class="md-nav__link">
    <span class="md-ellipsis">
      LLM 节点
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cache" class="md-nav__link">
    <span class="md-ellipsis">
      节点缓存（Cache）
    </span>
  </a>
  
    <nav class="md-nav" aria-label="节点缓存（Cache）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tools" class="md-nav__link">
    <span class="md-ellipsis">
      Tools 节点
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#state" class="md-nav__link">
    <span class="md-ellipsis">
      将工具结果写入 State
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_16" class="md-nav__link">
    <span class="md-ellipsis">
      边与路由
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fan-out" class="md-nav__link">
    <span class="md-ellipsis">
      命令模式（动态路由 / Fan-out）
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_17" class="md-nav__link">
    <span class="md-ellipsis">
      架构设计
    </span>
  </a>
  
    <nav class="md-nav" aria-label="架构设计">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_18" class="md-nav__link">
    <span class="md-ellipsis">
      整体架构
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_19" class="md-nav__link">
    <span class="md-ellipsis">
      核心模块解析
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_20" class="md-nav__link">
    <span class="md-ellipsis">
      执行模型
    </span>
  </a>
  
    <nav class="md-nav" aria-label="执行模型">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_21" class="md-nav__link">
    <span class="md-ellipsis">
      运行态隔离与事件快照
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_22" class="md-nav__link">
    <span class="md-ellipsis">
      执行器配置
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#agent_1" class="md-nav__link">
    <span class="md-ellipsis">
      与多 Agent 系统集成
    </span>
  </a>
  
    <nav class="md-nav" aria-label="与多 Agent 系统集成">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#graphagent-agent" class="md-nav__link">
    <span class="md-ellipsis">
      GraphAgent 作为 Agent
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_23" class="md-nav__link">
    <span class="md-ellipsis">
      高级编排
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agent_2" class="md-nav__link">
    <span class="md-ellipsis">
      在图中嵌入 Agent
    </span>
  </a>
  
    <nav class="md-nav" aria-label="在图中嵌入 Agent">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#last_response-user_input" class="md-nav__link">
    <span class="md-ellipsis">
      只传结果：将 last_response 映射为下游 user_input
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_24" class="md-nav__link">
    <span class="md-ellipsis">
      混合模式示例
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_25" class="md-nav__link">
    <span class="md-ellipsis">
      核心机制详解
    </span>
  </a>
  
    <nav class="md-nav" aria-label="核心机制详解">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#schema-reducer" class="md-nav__link">
    <span class="md-ellipsis">
      状态管理：Schema + Reducer 模式
    </span>
  </a>
  
    <nav class="md-nav" aria-label="状态管理：Schema + Reducer 模式">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_26" class="md-nav__link">
    <span class="md-ellipsis">
      常用键常量参考
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_27" class="md-nav__link">
    <span class="md-ellipsis">
      节点级回调与生成参数
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llm_2" class="md-nav__link">
    <span class="md-ellipsis">
      LLM 输入规则：三段式设计
    </span>
  </a>
  
    <nav class="md-nav" aria-label="LLM 输入规则：三段式设计">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_28" class="md-nav__link">
    <span class="md-ellipsis">
      指令占位符注入
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_29" class="md-nav__link">
    <span class="md-ellipsis">
      并发执行和状态安全
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#io_1" class="md-nav__link">
    <span class="md-ellipsis">
      节点 I/O 约定与常用键
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#api" class="md-nav__link">
    <span class="md-ellipsis">
      API 速查表
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dot" class="md-nav__link">
    <span class="md-ellipsis">
      可视化导出（DOT/图片）
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_30" class="md-nav__link">
    <span class="md-ellipsis">
      高级特性
    </span>
  </a>
  
    <nav class="md-nav" aria-label="高级特性">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_31" class="md-nav__link">
    <span class="md-ellipsis">
      检查点与恢复
    </span>
  </a>
  
    <nav class="md-nav" aria-label="检查点与恢复">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_32" class="md-nav__link">
    <span class="md-ellipsis">
      检查点管理
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_33" class="md-nav__link">
    <span class="md-ellipsis">
      默认值与注意事项
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_34" class="md-nav__link">
    <span class="md-ellipsis">
      事件速览
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#human-in-the-loop" class="md-nav__link">
    <span class="md-ellipsis">
      Human-in-the-Loop
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_35" class="md-nav__link">
    <span class="md-ellipsis">
      事件监控
    </span>
  </a>
  
    <nav class="md-nav" aria-label="事件监控">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#statedelta_1" class="md-nav__link">
    <span class="md-ellipsis">
      事件元数据（StateDelta）
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_36" class="md-nav__link">
    <span class="md-ellipsis">
      在节点回调中携带业务值
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_37" class="md-nav__link">
    <span class="md-ellipsis">
      常见问题排查
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_38" class="md-nav__link">
    <span class="md-ellipsis">
      实际案例
    </span>
  </a>
  
    <nav class="md-nav" aria-label="实际案例">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_39" class="md-nav__link">
    <span class="md-ellipsis">
      审批工作流
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_40" class="md-nav__link">
    <span class="md-ellipsis">
      总结
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_41" class="md-nav__link">
    <span class="md-ellipsis">
      参考与示例
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../custom-agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    自定义 Agent
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../runner/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Runner
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../model/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Model
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../callbacks/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Callbacks
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../memory/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Memory
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../artifact/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Artifact
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tool/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Tool
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../session/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Session
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../knowledge/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Knowledge
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../planner/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Planner
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Graph Agent
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Graph Agent
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      概述
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      快速开始
    </span>
  </a>
  
    <nav class="md-nav" aria-label="快速开始">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      最小工作流
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      使用模式
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agent" class="md-nav__link">
    <span class="md-ellipsis">
      Agent 集成
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      主要特性
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      核心概念
    </span>
  </a>
  
    <nav class="md-nav" aria-label="核心概念">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-graph" class="md-nav__link">
    <span class="md-ellipsis">
      1. 图 (Graph)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-node" class="md-nav__link">
    <span class="md-ellipsis">
      2. 节点 (Node)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-state" class="md-nav__link">
    <span class="md-ellipsis">
      3. 状态 (State)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-stateschema" class="md-nav__link">
    <span class="md-ellipsis">
      4. 状态模式 (StateSchema)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      使用指南
    </span>
  </a>
  
    <nav class="md-nav" aria-label="使用指南">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#io" class="md-nav__link">
    <span class="md-ellipsis">
      节点 I/O 约定
    </span>
  </a>
  
    <nav class="md-nav" aria-label="节点 I/O 约定">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      状态键常量与来源（可直接引用）
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#statedelta" class="md-nav__link">
    <span class="md-ellipsis">
      事件元数据键（StateDelta）
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1-graphagent-runner" class="md-nav__link">
    <span class="md-ellipsis">
      1. 创建 GraphAgent 和 Runner
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-llm" class="md-nav__link">
    <span class="md-ellipsis">
      2. 使用 LLM 节点
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. 使用 LLM 节点">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      三种输入范式
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llm" class="md-nav__link">
    <span class="md-ellipsis">
      LLM 指令中的占位符
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reducer-messageop" class="md-nav__link">
    <span class="md-ellipsis">
      通过 Reducer 与 MessageOp 实现的原子更新
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-graphagent" class="md-nav__link">
    <span class="md-ellipsis">
      3. GraphAgent 配置选项
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4" class="md-nav__link">
    <span class="md-ellipsis">
      4. 条件路由
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#41-ends" class="md-nav__link">
    <span class="md-ellipsis">
      4.1 节点命名分支（Ends）
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5" class="md-nav__link">
    <span class="md-ellipsis">
      5. 工具节点集成
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6" class="md-nav__link">
    <span class="md-ellipsis">
      6. 节点重试与退避
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#7-runner" class="md-nav__link">
    <span class="md-ellipsis">
      7. Runner 配置
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#8" class="md-nav__link">
    <span class="md-ellipsis">
      8. 消息状态模式
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#9" class="md-nav__link">
    <span class="md-ellipsis">
      9. 状态键使用场景
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      高级功能
    </span>
  </a>
  
    <nav class="md-nav" aria-label="高级功能">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    <span class="md-ellipsis">
      1. 中断和恢复（人机协作）
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1. 中断和恢复（人机协作）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    <span class="md-ellipsis">
      基本用法
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    <span class="md-ellipsis">
      执行方式
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#graphagent" class="md-nav__link">
    <span class="md-ellipsis">
      GraphAgent 配置选项
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    <span class="md-ellipsis">
      核心概念
    </span>
  </a>
  
    <nav class="md-nav" aria-label="核心概念">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    <span class="md-ellipsis">
      状态管理
    </span>
  </a>
  
    <nav class="md-nav" aria-label="状态管理">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#schema" class="md-nav__link">
    <span class="md-ellipsis">
      使用内置 Schema
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#schema_1" class="md-nav__link">
    <span class="md-ellipsis">
      自定义 Schema
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_15" class="md-nav__link">
    <span class="md-ellipsis">
      节点类型
    </span>
  </a>
  
    <nav class="md-nav" aria-label="节点类型">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#function" class="md-nav__link">
    <span class="md-ellipsis">
      Function 节点
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llm_1" class="md-nav__link">
    <span class="md-ellipsis">
      LLM 节点
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cache" class="md-nav__link">
    <span class="md-ellipsis">
      节点缓存（Cache）
    </span>
  </a>
  
    <nav class="md-nav" aria-label="节点缓存（Cache）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tools" class="md-nav__link">
    <span class="md-ellipsis">
      Tools 节点
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#state" class="md-nav__link">
    <span class="md-ellipsis">
      将工具结果写入 State
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_16" class="md-nav__link">
    <span class="md-ellipsis">
      边与路由
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fan-out" class="md-nav__link">
    <span class="md-ellipsis">
      命令模式（动态路由 / Fan-out）
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_17" class="md-nav__link">
    <span class="md-ellipsis">
      架构设计
    </span>
  </a>
  
    <nav class="md-nav" aria-label="架构设计">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_18" class="md-nav__link">
    <span class="md-ellipsis">
      整体架构
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_19" class="md-nav__link">
    <span class="md-ellipsis">
      核心模块解析
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_20" class="md-nav__link">
    <span class="md-ellipsis">
      执行模型
    </span>
  </a>
  
    <nav class="md-nav" aria-label="执行模型">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_21" class="md-nav__link">
    <span class="md-ellipsis">
      运行态隔离与事件快照
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_22" class="md-nav__link">
    <span class="md-ellipsis">
      执行器配置
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#agent_1" class="md-nav__link">
    <span class="md-ellipsis">
      与多 Agent 系统集成
    </span>
  </a>
  
    <nav class="md-nav" aria-label="与多 Agent 系统集成">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#graphagent-agent" class="md-nav__link">
    <span class="md-ellipsis">
      GraphAgent 作为 Agent
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_23" class="md-nav__link">
    <span class="md-ellipsis">
      高级编排
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agent_2" class="md-nav__link">
    <span class="md-ellipsis">
      在图中嵌入 Agent
    </span>
  </a>
  
    <nav class="md-nav" aria-label="在图中嵌入 Agent">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#last_response-user_input" class="md-nav__link">
    <span class="md-ellipsis">
      只传结果：将 last_response 映射为下游 user_input
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_24" class="md-nav__link">
    <span class="md-ellipsis">
      混合模式示例
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_25" class="md-nav__link">
    <span class="md-ellipsis">
      核心机制详解
    </span>
  </a>
  
    <nav class="md-nav" aria-label="核心机制详解">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#schema-reducer" class="md-nav__link">
    <span class="md-ellipsis">
      状态管理：Schema + Reducer 模式
    </span>
  </a>
  
    <nav class="md-nav" aria-label="状态管理：Schema + Reducer 模式">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_26" class="md-nav__link">
    <span class="md-ellipsis">
      常用键常量参考
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_27" class="md-nav__link">
    <span class="md-ellipsis">
      节点级回调与生成参数
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llm_2" class="md-nav__link">
    <span class="md-ellipsis">
      LLM 输入规则：三段式设计
    </span>
  </a>
  
    <nav class="md-nav" aria-label="LLM 输入规则：三段式设计">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_28" class="md-nav__link">
    <span class="md-ellipsis">
      指令占位符注入
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_29" class="md-nav__link">
    <span class="md-ellipsis">
      并发执行和状态安全
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#io_1" class="md-nav__link">
    <span class="md-ellipsis">
      节点 I/O 约定与常用键
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#api" class="md-nav__link">
    <span class="md-ellipsis">
      API 速查表
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dot" class="md-nav__link">
    <span class="md-ellipsis">
      可视化导出（DOT/图片）
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_30" class="md-nav__link">
    <span class="md-ellipsis">
      高级特性
    </span>
  </a>
  
    <nav class="md-nav" aria-label="高级特性">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_31" class="md-nav__link">
    <span class="md-ellipsis">
      检查点与恢复
    </span>
  </a>
  
    <nav class="md-nav" aria-label="检查点与恢复">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_32" class="md-nav__link">
    <span class="md-ellipsis">
      检查点管理
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_33" class="md-nav__link">
    <span class="md-ellipsis">
      默认值与注意事项
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_34" class="md-nav__link">
    <span class="md-ellipsis">
      事件速览
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#human-in-the-loop" class="md-nav__link">
    <span class="md-ellipsis">
      Human-in-the-Loop
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_35" class="md-nav__link">
    <span class="md-ellipsis">
      事件监控
    </span>
  </a>
  
    <nav class="md-nav" aria-label="事件监控">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#statedelta_1" class="md-nav__link">
    <span class="md-ellipsis">
      事件元数据（StateDelta）
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_36" class="md-nav__link">
    <span class="md-ellipsis">
      在节点回调中携带业务值
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_37" class="md-nav__link">
    <span class="md-ellipsis">
      常见问题排查
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_38" class="md-nav__link">
    <span class="md-ellipsis">
      实际案例
    </span>
  </a>
  
    <nav class="md-nav" aria-label="实际案例">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_39" class="md-nav__link">
    <span class="md-ellipsis">
      审批工作流
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_40" class="md-nav__link">
    <span class="md-ellipsis">
      总结
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_41" class="md-nav__link">
    <span class="md-ellipsis">
      参考与示例
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../event/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Event
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    服务
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            服务
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../debugserver/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    调试
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../agui/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    AG-UI
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../a2a/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    A2A
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../observability/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    可观测
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../ecosystem/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    生态
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      概述
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      快速开始
    </span>
  </a>
  
    <nav class="md-nav" aria-label="快速开始">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      最小工作流
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      使用模式
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agent" class="md-nav__link">
    <span class="md-ellipsis">
      Agent 集成
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      主要特性
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      核心概念
    </span>
  </a>
  
    <nav class="md-nav" aria-label="核心概念">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-graph" class="md-nav__link">
    <span class="md-ellipsis">
      1. 图 (Graph)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-node" class="md-nav__link">
    <span class="md-ellipsis">
      2. 节点 (Node)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-state" class="md-nav__link">
    <span class="md-ellipsis">
      3. 状态 (State)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-stateschema" class="md-nav__link">
    <span class="md-ellipsis">
      4. 状态模式 (StateSchema)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      使用指南
    </span>
  </a>
  
    <nav class="md-nav" aria-label="使用指南">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#io" class="md-nav__link">
    <span class="md-ellipsis">
      节点 I/O 约定
    </span>
  </a>
  
    <nav class="md-nav" aria-label="节点 I/O 约定">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      状态键常量与来源（可直接引用）
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#statedelta" class="md-nav__link">
    <span class="md-ellipsis">
      事件元数据键（StateDelta）
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1-graphagent-runner" class="md-nav__link">
    <span class="md-ellipsis">
      1. 创建 GraphAgent 和 Runner
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-llm" class="md-nav__link">
    <span class="md-ellipsis">
      2. 使用 LLM 节点
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. 使用 LLM 节点">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      三种输入范式
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llm" class="md-nav__link">
    <span class="md-ellipsis">
      LLM 指令中的占位符
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#reducer-messageop" class="md-nav__link">
    <span class="md-ellipsis">
      通过 Reducer 与 MessageOp 实现的原子更新
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-graphagent" class="md-nav__link">
    <span class="md-ellipsis">
      3. GraphAgent 配置选项
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4" class="md-nav__link">
    <span class="md-ellipsis">
      4. 条件路由
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#41-ends" class="md-nav__link">
    <span class="md-ellipsis">
      4.1 节点命名分支（Ends）
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5" class="md-nav__link">
    <span class="md-ellipsis">
      5. 工具节点集成
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6" class="md-nav__link">
    <span class="md-ellipsis">
      6. 节点重试与退避
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#7-runner" class="md-nav__link">
    <span class="md-ellipsis">
      7. Runner 配置
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#8" class="md-nav__link">
    <span class="md-ellipsis">
      8. 消息状态模式
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#9" class="md-nav__link">
    <span class="md-ellipsis">
      9. 状态键使用场景
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    <span class="md-ellipsis">
      高级功能
    </span>
  </a>
  
    <nav class="md-nav" aria-label="高级功能">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    <span class="md-ellipsis">
      1. 中断和恢复（人机协作）
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1. 中断和恢复（人机协作）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    <span class="md-ellipsis">
      基本用法
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    <span class="md-ellipsis">
      执行方式
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#graphagent" class="md-nav__link">
    <span class="md-ellipsis">
      GraphAgent 配置选项
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    <span class="md-ellipsis">
      核心概念
    </span>
  </a>
  
    <nav class="md-nav" aria-label="核心概念">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    <span class="md-ellipsis">
      状态管理
    </span>
  </a>
  
    <nav class="md-nav" aria-label="状态管理">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#schema" class="md-nav__link">
    <span class="md-ellipsis">
      使用内置 Schema
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#schema_1" class="md-nav__link">
    <span class="md-ellipsis">
      自定义 Schema
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_15" class="md-nav__link">
    <span class="md-ellipsis">
      节点类型
    </span>
  </a>
  
    <nav class="md-nav" aria-label="节点类型">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#function" class="md-nav__link">
    <span class="md-ellipsis">
      Function 节点
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llm_1" class="md-nav__link">
    <span class="md-ellipsis">
      LLM 节点
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cache" class="md-nav__link">
    <span class="md-ellipsis">
      节点缓存（Cache）
    </span>
  </a>
  
    <nav class="md-nav" aria-label="节点缓存（Cache）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#tools" class="md-nav__link">
    <span class="md-ellipsis">
      Tools 节点
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#state" class="md-nav__link">
    <span class="md-ellipsis">
      将工具结果写入 State
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_16" class="md-nav__link">
    <span class="md-ellipsis">
      边与路由
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fan-out" class="md-nav__link">
    <span class="md-ellipsis">
      命令模式（动态路由 / Fan-out）
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_17" class="md-nav__link">
    <span class="md-ellipsis">
      架构设计
    </span>
  </a>
  
    <nav class="md-nav" aria-label="架构设计">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_18" class="md-nav__link">
    <span class="md-ellipsis">
      整体架构
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_19" class="md-nav__link">
    <span class="md-ellipsis">
      核心模块解析
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_20" class="md-nav__link">
    <span class="md-ellipsis">
      执行模型
    </span>
  </a>
  
    <nav class="md-nav" aria-label="执行模型">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_21" class="md-nav__link">
    <span class="md-ellipsis">
      运行态隔离与事件快照
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_22" class="md-nav__link">
    <span class="md-ellipsis">
      执行器配置
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#agent_1" class="md-nav__link">
    <span class="md-ellipsis">
      与多 Agent 系统集成
    </span>
  </a>
  
    <nav class="md-nav" aria-label="与多 Agent 系统集成">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#graphagent-agent" class="md-nav__link">
    <span class="md-ellipsis">
      GraphAgent 作为 Agent
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_23" class="md-nav__link">
    <span class="md-ellipsis">
      高级编排
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agent_2" class="md-nav__link">
    <span class="md-ellipsis">
      在图中嵌入 Agent
    </span>
  </a>
  
    <nav class="md-nav" aria-label="在图中嵌入 Agent">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#last_response-user_input" class="md-nav__link">
    <span class="md-ellipsis">
      只传结果：将 last_response 映射为下游 user_input
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_24" class="md-nav__link">
    <span class="md-ellipsis">
      混合模式示例
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_25" class="md-nav__link">
    <span class="md-ellipsis">
      核心机制详解
    </span>
  </a>
  
    <nav class="md-nav" aria-label="核心机制详解">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#schema-reducer" class="md-nav__link">
    <span class="md-ellipsis">
      状态管理：Schema + Reducer 模式
    </span>
  </a>
  
    <nav class="md-nav" aria-label="状态管理：Schema + Reducer 模式">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_26" class="md-nav__link">
    <span class="md-ellipsis">
      常用键常量参考
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_27" class="md-nav__link">
    <span class="md-ellipsis">
      节点级回调与生成参数
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#llm_2" class="md-nav__link">
    <span class="md-ellipsis">
      LLM 输入规则：三段式设计
    </span>
  </a>
  
    <nav class="md-nav" aria-label="LLM 输入规则：三段式设计">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_28" class="md-nav__link">
    <span class="md-ellipsis">
      指令占位符注入
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_29" class="md-nav__link">
    <span class="md-ellipsis">
      并发执行和状态安全
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#io_1" class="md-nav__link">
    <span class="md-ellipsis">
      节点 I/O 约定与常用键
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#api" class="md-nav__link">
    <span class="md-ellipsis">
      API 速查表
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dot" class="md-nav__link">
    <span class="md-ellipsis">
      可视化导出（DOT/图片）
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_30" class="md-nav__link">
    <span class="md-ellipsis">
      高级特性
    </span>
  </a>
  
    <nav class="md-nav" aria-label="高级特性">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_31" class="md-nav__link">
    <span class="md-ellipsis">
      检查点与恢复
    </span>
  </a>
  
    <nav class="md-nav" aria-label="检查点与恢复">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_32" class="md-nav__link">
    <span class="md-ellipsis">
      检查点管理
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_33" class="md-nav__link">
    <span class="md-ellipsis">
      默认值与注意事项
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_34" class="md-nav__link">
    <span class="md-ellipsis">
      事件速览
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#human-in-the-loop" class="md-nav__link">
    <span class="md-ellipsis">
      Human-in-the-Loop
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_35" class="md-nav__link">
    <span class="md-ellipsis">
      事件监控
    </span>
  </a>
  
    <nav class="md-nav" aria-label="事件监控">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#statedelta_1" class="md-nav__link">
    <span class="md-ellipsis">
      事件元数据（StateDelta）
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_36" class="md-nav__link">
    <span class="md-ellipsis">
      在节点回调中携带业务值
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_37" class="md-nav__link">
    <span class="md-ellipsis">
      常见问题排查
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_38" class="md-nav__link">
    <span class="md-ellipsis">
      实际案例
    </span>
  </a>
  
    <nav class="md-nav" aria-label="实际案例">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_39" class="md-nav__link">
    <span class="md-ellipsis">
      审批工作流
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_40" class="md-nav__link">
    <span class="md-ellipsis">
      总结
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_41" class="md-nav__link">
    <span class="md-ellipsis">
      参考与示例
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
    <a href="https://github.com/trpc-group/trpc-agent-go/edit/main/docs/mkdocs/zh/graph.md" title="编辑此页" class="md-content__button md-icon" rel="edit">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg>
    </a>
  
  
    
      
    
    <a href="https://github.com/trpc-group/trpc-agent-go/raw/main/docs/mkdocs/zh/graph.md" title="查看本页的源代码" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 18c.56 0 1 .44 1 1s-.44 1-1 1-1-.44-1-1 .44-1 1-1m0-3c-2.73 0-5.06 1.66-6 4 .94 2.34 3.27 4 6 4s5.06-1.66 6-4c-.94-2.34-3.27-4-6-4m0 6.5a2.5 2.5 0 0 1-2.5-2.5 2.5 2.5 0 0 1 2.5-2.5 2.5 2.5 0 0 1 2.5 2.5 2.5 2.5 0 0 1-2.5 2.5M9.27 20H6V4h7v5h5v4.07c.7.08 1.36.25 2 .49V8l-6-6H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h4.5a8.2 8.2 0 0 1-1.23-2"/></svg>
    </a>
  


<h1 id="graph">Graph 包使用指南</h1>
<h2 id="_1">概述</h2>
<p>Graph 将可控的工作流编排与可扩展的 Agent 能力结合，适用于：
- 类型安全的状态管理与可预测路由；
- LLM 决策、工具调用循环、可选的 Human in the Loop（HITL）；
- 可复用的组件，既可独立运行，也可作为子 Agent 组合。</p>
<p>特点：
- Schema 驱动的 State 与 Reducer，避免并发分支写入同一字段时的数据竞争；
- BSP 风格（计划/执行/合并）的确定性并行；
- 内置节点类型封装 LLM、工具与 Agent，减少重复代码；
- 流式事件、检查点与中断，便于观测与恢复。
- 节点级重试/退避（指数退避与抖动），支持执行器默认重试策略与带重试元数据的事件观测。</p>
<h2 id="_2">快速开始</h2>
<h3 id="_3">最小工作流</h3>
<p>下面是一个经典的“prepare → ask LLM → 可能调用工具”的循环，使用 <code>graph.MessagesStateSchema()</code>（已定义 <code>graph.StateKeyMessages</code>、<code>graph.StateKeyUserInput</code>、<code>graph.StateKeyLastResponse</code> 等键）。</p>
<pre class="mermaid"><code>flowchart LR
    START([start]):::startNode --&gt; P[prepare]:::processNode
    P --&gt; A[ask LLM]:::llmNode
    A -. tool_calls .-&gt; T[tools]:::toolNode
    A -- no tool_calls --&gt; F[fallback]:::processNode
    T --&gt; A
    F --&gt; END([finish]):::endNode

    classDef startNode fill:#e1f5e1,stroke:#4caf50,stroke-width:2px
    classDef endNode fill:#ffe1e1,stroke:#f44336,stroke-width:2px
    classDef llmNode fill:#e3f2fd,stroke:#2196f3,stroke-width:2px
    classDef toolNode fill:#fff3e0,stroke:#ff9800,stroke-width:2px
    classDef processNode fill:#f3e5f5,stroke:#9c27b0,stroke-width:2px</code></pre>
<p>Graph 包允许您将复杂的 AI 工作流建模为有向图，其中节点代表处理步骤，边代表数据流和控制流。它特别适合构建需要条件路由、状态管理和多步骤处理的 AI 应用。</p>
<h3 id="_4">使用模式</h3>
<p>Graph 包的使用遵循以下模式：</p>
<ol>
<li><strong>创建 Graph</strong>：使用 <code>StateGraph</code> 构建器定义工作流结构</li>
<li><strong>创建 GraphAgent</strong>：将编译后的 Graph 包装为 Agent</li>
<li><strong>创建 Runner</strong>：使用 Runner 管理会话和执行环境</li>
<li><strong>执行工作流</strong>：通过 Runner 执行工作流并处理结果</li>
</ol>
<p>这种模式提供了：</p>
<ul>
<li><strong>类型安全</strong>：通过状态模式确保数据一致性</li>
<li><strong>会话管理</strong>：支持多用户、多会话的并发执行</li>
<li><strong>事件流</strong>：实时监控工作流执行进度</li>
<li><strong>错误处理</strong>：统一的错误处理和恢复机制</li>
</ul>
<h3 id="agent">Agent 集成</h3>
<p>GraphAgent 实现了 <code>agent.Agent</code> 接口，可以：</p>
<ul>
<li><strong>作为独立 Agent</strong>：通过 Runner 直接执行</li>
<li><strong>作为 SubAgent</strong>：被其他 Agent（如 LLMAgent）作为子 Agent 使用</li>
<li><strong>挂载 SubAgent</strong>：通过 <code>graphagent.WithSubAgents</code> 配置子 Agent，并在图中使用 <code>AddAgentNode</code> 委托执行</li>
</ul>
<p>这种设计使得 GraphAgent 既能接入其他 Agent，也能在自身工作流中灵活调度子 Agent。</p>
<h3 id="_5">主要特性</h3>
<ul>
<li><strong>类型安全的状态管理</strong>：使用 Schema 定义状态结构，支持自定义 Reducer</li>
<li><strong>条件路由</strong>：基于状态动态选择执行路径</li>
<li><strong>LLM 节点集成</strong>：内置对大型语言模型的支持</li>
<li><strong>工具节点</strong>：支持函数调用和外部工具集成</li>
<li><strong>Agent 节点</strong>：通过子 Agent 将其他 Agent 融入图中</li>
<li><strong>流式执行</strong>：支持实时事件流和进度跟踪</li>
<li><strong>并发安全</strong>：线程安全的图执行</li>
<li><strong>基于检查点的时间旅行</strong>：浏览执行历史并恢复之前的状态</li>
<li><strong>人机协作 (HITL)</strong>：支持带有中断和恢复功能的交互式工作流</li>
<li><strong>原子检查点</strong>：原子存储检查点和待写入数据，确保可靠的恢复</li>
<li><strong>检查点谱系</strong>：跟踪形成执行线程的相关检查点及其父子关系</li>
</ul>
<h2 id="_6">核心概念</h2>
<h3 id="1-graph">1. 图 (Graph)</h3>
<p>图是工作流的核心结构，由节点和边组成：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span>
<span class="normal"><a href="#__codelineno-0-2">2</a></span>
<span class="normal"><a href="#__codelineno-0-3">3</a></span>
<span class="normal"><a href="#__codelineno-0-4">4</a></span>
<span class="normal"><a href="#__codelineno-0-5">5</a></span>
<span class="normal"><a href="#__codelineno-0-6">6</a></span>
<span class="normal"><a href="#__codelineno-0-7">7</a></span>
<span class="normal"><a href="#__codelineno-0-8">8</a></span>
<span class="normal"><a href="#__codelineno-0-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3"></a><span class="p">)</span>
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4"></a>
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5"></a><span class="c1">// 创建状态模式</span>
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6"></a><span class="nx">schema</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateSchema</span><span class="p">()</span>
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7"></a>
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8"></a><span class="c1">// 创建图</span>
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9"></a><span class="nx">graph</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="nx">schema</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p><strong>虚拟节点</strong>：</p>
<ul>
<li><code>Start</code>：虚拟起始节点，通过 <code>SetEntryPoint()</code> 自动连接</li>
<li><code>End</code>：虚拟结束节点，通过 <code>SetFinishPoint()</code> 自动连接</li>
<li>这些节点不需要显式创建，系统会自动处理连接</li>
</ul>
<h3 id="2-node">2. 节点 (Node)</h3>
<p>节点代表工作流中的一个处理步骤：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-1-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-1-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-1-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-1-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-1-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-1-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-1-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-1-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-1-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-1-10">10</a></span>
<span class="normal"><a href="#__codelineno-1-11">11</a></span>
<span class="normal"><a href="#__codelineno-1-12">12</a></span>
<span class="normal"><a href="#__codelineno-1-13">13</a></span>
<span class="normal"><a href="#__codelineno-1-14">14</a></span>
<span class="normal"><a href="#__codelineno-1-15">15</a></span>
<span class="normal"><a href="#__codelineno-1-16">16</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="w">    </span><span class="s">&quot;context&quot;</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3"></a>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="p">)</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6"></a>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="c1">// 节点函数签名</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="kd">type</span><span class="w"> </span><span class="nx">NodeFunc</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9"></a>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="c1">// 创建节点</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11"></a><span class="nx">node</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">graph</span><span class="p">.</span><span class="nx">Node</span><span class="p">{</span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12"></a><span class="w">    </span><span class="nx">ID</span><span class="p">:</span><span class="w">          </span><span class="s">&quot;process_data&quot;</span><span class="p">,</span>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13"></a><span class="w">    </span><span class="nx">Name</span><span class="p">:</span><span class="w">        </span><span class="s">&quot;数据处理&quot;</span><span class="p">,</span>
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14"></a><span class="w">    </span><span class="nx">Description</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;处理输入数据&quot;</span><span class="p">,</span>
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15"></a><span class="w">    </span><span class="nx">Function</span><span class="p">:</span><span class="w">    </span><span class="nx">processDataFunc</span><span class="p">,</span>
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="3-state">3. 状态 (State)</h3>
<p>状态是在节点间传递的数据容器：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-2-10">10</a></span>
<span class="normal"><a href="#__codelineno-2-11">11</a></span>
<span class="normal"><a href="#__codelineno-2-12">12</a></span>
<span class="normal"><a href="#__codelineno-2-13">13</a></span>
<span class="normal"><a href="#__codelineno-2-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="p">)</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4"></a>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="c1">// 状态是一个键值对映射</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6"></a><span class="kd">type</span><span class="w"> </span><span class="nx">State</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">any</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7"></a>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8"></a><span class="c1">// 用户自定义的状态键</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10"></a><span class="w">    </span><span class="nx">StateKeyInput</span><span class="w">         </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;input&quot;</span><span class="w">          </span><span class="c1">// 输入数据</span>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11"></a><span class="w">    </span><span class="nx">StateKeyResult</span><span class="w">        </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;result&quot;</span><span class="w">         </span><span class="c1">// 处理结果</span>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12"></a><span class="w">    </span><span class="nx">StateKeyProcessedData</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;processed_data&quot;</span><span class="w"> </span><span class="c1">// 处理后的数据</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13"></a><span class="w">    </span><span class="nx">StateKeyStatus</span><span class="w">        </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;status&quot;</span><span class="w">         </span><span class="c1">// 处理状态</span>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14"></a><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p><strong>内置状态键</strong>：</p>
<p>Graph 包提供了一些内置状态键，主要用于系统内部通信：</p>
<p><strong>用户可访问的内置键</strong>：</p>
<ul>
<li><code>StateKeyUserInput</code>：用户输入（一次性，消费后清空，由 LLM 节点自动持久化）</li>
<li><code>StateKeyOneShotMessages</code>：一次性消息（完整覆盖本轮输入，消费后清空）</li>
<li><code>StateKeyLastResponse</code>：最后响应（用于设置最终输出，Executor 会读取此值作为结果）</li>
<li><code>StateKeyMessages</code>：消息历史（持久化，支持 append + MessageOp 补丁操作）</li>
<li><code>StateKeyNodeResponses</code>：按节点存储的响应映射。键为节点 ID，值为该
  节点的最终文本响应。<code>StateKeyLastResponse</code> 用于串行路径上的最终输
  出；当多个并行节点在某处汇合时，应从 <code>StateKeyNodeResponses</code> 中按节
  点读取各自的输出。</li>
<li><code>StateKeyMetadata</code>：元数据（用户可用的通用元数据存储）</li>
</ul>
<p><strong>系统内部键</strong>（用户不应直接使用）：</p>
<ul>
<li><code>StateKeySession</code>：会话信息（由 GraphAgent 自动设置）</li>
<li><code>StateKeyExecContext</code>：执行上下文（由 Executor 自动设置）</li>
<li><code>StateKeyToolCallbacks</code>：工具回调（由 Executor 自动设置）</li>
<li><code>StateKeyModelCallbacks</code>：模型回调（由 Executor 自动设置）</li>
</ul>
<p>用户应该使用自定义状态键来存储业务数据，只在必要时使用用户可访问的内置状态键。</p>
<h3 id="4-stateschema">4. 状态模式 (StateSchema)</h3>
<p>状态模式定义状态的结构和行为：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-3-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-3-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-3-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-3-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-3-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-3-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-3-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-3-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-3-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-3-10">10</a></span>
<span class="normal"><a href="#__codelineno-3-11">11</a></span>
<span class="normal"><a href="#__codelineno-3-12">12</a></span>
<span class="normal"><a href="#__codelineno-3-13">13</a></span>
<span class="normal"><a href="#__codelineno-3-14">14</a></span>
<span class="normal"><a href="#__codelineno-3-15">15</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="w">    </span><span class="s">&quot;reflect&quot;</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3"></a>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="p">)</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6"></a>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="c1">// 创建状态模式</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8"></a><span class="nx">schema</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateSchema</span><span class="p">()</span>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9"></a>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10"></a><span class="c1">// 添加字段定义</span>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11"></a><span class="nx">schema</span><span class="p">.</span><span class="nx">AddField</span><span class="p">(</span><span class="s">&quot;counter&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateField</span><span class="p">{</span>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12"></a><span class="w">    </span><span class="nx">Type</span><span class="p">:</span><span class="w">    </span><span class="nx">reflect</span><span class="p">.</span><span class="nx">TypeOf</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span><span id="__span-3-13"><a id="__codelineno-3-13" name="__codelineno-3-13"></a><span class="w">    </span><span class="nx">Reducer</span><span class="p">:</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">DefaultReducer</span><span class="p">,</span>
</span><span id="__span-3-14"><a id="__codelineno-3-14" name="__codelineno-3-14"></a><span class="w">    </span><span class="nx">Default</span><span class="p">:</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="kt">any</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">},</span>
</span><span id="__span-3-15"><a id="__codelineno-3-15" name="__codelineno-3-15"></a><span class="p">})</span>
</span></code></pre></div></td></tr></table></div>
<h2 id="_7">使用指南</h2>
<h3 id="io">节点 I/O 约定</h3>
<p>节点之间仅通过共享状态 State 传递数据。每个节点返回一个 state delta，按 Schema 的 Reducer 合并到全局 State，下游节点从 State 读取上游产出。</p>
<ul>
<li>常用内置键（对用户可见）<ul>
<li><code>user_input</code>：一次性用户输入，被下一个 LLM/Agent 节点消费后清空</li>
<li><code>one_shot_messages</code>：一次性完整消息覆盖，用于下一次 LLM 调用，执行后清空</li>
<li><code>messages</code>：持久化的消息历史（LLM/Tools 会追加），支持 MessageOp 补丁</li>
<li><code>last_response</code>：最近一次助手文本回复</li>
<li><code>node_responses</code>：map[nodeID]any，按节点保存最终文本回复。最近结果用 <code>last_response</code></li>
</ul>
</li>
</ul>
<ul>
<li>函数节点（Function node）<ul>
<li>输入：完整 State</li>
<li>输出：返回 <code>graph.State</code> 增量，写入自定义键（需在 Schema 中声明），如 <code>{"parsed_time":"..."}</code></li>
</ul>
</li>
</ul>
<ul>
<li>LLM 节点<ul>
<li>输入优先级：<code>one_shot_messages</code> → <code>user_input</code> → <code>messages</code></li>
<li>输出：<ul>
<li>向 <code>messages</code> 追加助手消息</li>
<li>设置 <code>last_response</code></li>
<li>设置 <code>node_responses[&lt;llm_node_id&gt;]</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li>Tools 节点<ul>
<li>输入：从 <code>messages</code> 中寻找最新的带 <code>tool_calls</code> 的助手消息</li>
<li>输出：向 <code>messages</code> 追加工具返回消息</li>
</ul>
</li>
</ul>
<ul>
<li>Agent 节点（子代理）<ul>
<li>输入：Graph 的 State 通过 <code>Invocation.RunOptions.RuntimeState</code> 传入子代理<ul>
<li>子代理的 Model/Tool 回调可通过 <code>agent.InvocationFromContext(ctx)</code> 访问</li>
</ul>
</li>
<li>结束输出：<ul>
<li>设置 <code>last_response</code></li>
<li>设置 <code>node_responses[&lt;agent_node_id&gt;]</code></li>
<li>清空 <code>user_input</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>推荐用法</p>
<ul>
<li>在 Schema 中声明业务字段（如 <code>parsed_time</code>、<code>final_payload</code>），函数节点写入/读取。</li>
<li>需要给 LLM 节点注入结构化提示时，可在前置节点写入 <code>one_shot_messages</code>（例如加入包含解析信息的 system message）。</li>
<li>需要消费上游文本结果时：紧邻下游读取 <code>last_response</code>，或在任意后续节点读取 <code>node_responses[节点ID]</code>。</li>
</ul>
<p>示例：</p>
<ul>
<li><code>examples/graph/io_conventions</code>：函数 + LLM + Agent 的 I/O 演示</li>
<li><code>examples/graph/io_conventions_tools</code>：加入 Tools 节点，展示如何获取工具 JSON 并落入 State</li>
<li><code>examples/graph/retry</code>：节点级重试/退避演示</li>
</ul>
<h4 id="_8">状态键常量与来源（可直接引用）</h4>
<ul>
<li>导入包：<code>import "trpc.group/trpc-go/trpc-agent-go/graph"</code></li>
<li>常量定义位置：<code>graph/state.go</code></li>
</ul>
<ul>
<li>用户可见、常用键<ul>
<li><code>user_input</code> → 常量 <code>graph.StateKeyUserInput</code></li>
<li><code>one_shot_messages</code> → 常量 <code>graph.StateKeyOneShotMessages</code></li>
<li><code>messages</code> → 常量 <code>graph.StateKeyMessages</code></li>
<li><code>last_response</code> → 常量 <code>graph.StateKeyLastResponse</code></li>
<li><code>node_responses</code> → 常量 <code>graph.StateKeyNodeResponses</code></li>
</ul>
</li>
</ul>
<ul>
<li>其他常用键<ul>
<li><code>session</code> → <code>graph.StateKeySession</code></li>
<li><code>metadata</code> → <code>graph.StateKeyMetadata</code></li>
<li><code>current_node_id</code> → <code>graph.StateKeyCurrentNodeID</code></li>
<li><code>exec_context</code> → <code>graph.StateKeyExecContext</code></li>
<li><code>tool_callbacks</code> → <code>graph.StateKeyToolCallbacks</code></li>
<li><code>model_callbacks</code> → <code>graph.StateKeyModelCallbacks</code></li>
<li><code>agent_callbacks</code> → <code>graph.StateKeyAgentCallbacks</code></li>
<li><code>parent_agent</code> → <code>graph.StateKeyParentAgent</code></li>
</ul>
</li>
</ul>
<p>使用示例：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-4-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-4-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-4-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-4-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-4-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-4-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-4-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-4-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-4-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-4-10">10</a></span>
<span class="normal"><a href="#__codelineno-4-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="w">    </span><span class="s">&quot;context&quot;</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4"></a><span class="p">)</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5"></a>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="kd">func</span><span class="w"> </span><span class="nx">myNode</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7"></a><span class="w">    </span><span class="c1">// 读取上一节点文本输出</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8"></a><span class="w">    </span><span class="nx">last</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">state</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyLastResponse</span><span class="p">].(</span><span class="kt">string</span><span class="p">)</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9"></a><span class="w">    </span><span class="c1">// 写入自定义字段</span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="s">&quot;my_key&quot;</span><span class="p">:</span><span class="w"> </span><span class="nx">last</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<h4 id="statedelta">事件元数据键（StateDelta）</h4>
<ul>
<li>导入包：<code>import "trpc.group/trpc-go/trpc-agent-go/graph"</code></li>
<li>常量定义位置：<code>graph/events.go</code></li>
</ul>
<ul>
<li>模型元数据：<code>_model_metadata</code> → <code>graph.MetadataKeyModel</code>（结构体 <code>graph.ModelExecutionMetadata</code>）</li>
<li>工具元数据：<code>_tool_metadata</code> → <code>graph.MetadataKeyTool</code>（结构体 <code>graph.ToolExecutionMetadata</code>）</li>
<li>节点元数据：<code>_node_metadata</code> → <code>graph.MetadataKeyNode</code>（结构体 <code>graph.NodeExecutionMetadata</code>）。包含重试字段：<code>Attempt</code>、<code>MaxAttempts</code>、<code>NextDelay</code>、<code>Retrying</code> 及时间相关信息。</li>
</ul>
<p>使用示例：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-5-1">1</a></span>
<span class="normal"><a href="#__codelineno-5-2">2</a></span>
<span class="normal"><a href="#__codelineno-5-3">3</a></span>
<span class="normal"><a href="#__codelineno-5-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="k">if</span><span class="w"> </span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">event</span><span class="p">.</span><span class="nx">StateDelta</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">MetadataKeyModel</span><span class="p">];</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">md</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">ModelExecutionMetadata</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="w">    </span><span class="nx">_</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">json</span><span class="p">.</span><span class="nx">Unmarshal</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">md</span><span class="p">)</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="1-graphagent-runner">1. 创建 GraphAgent 和 Runner</h3>
<p>用户主要通过创建 GraphAgent 然后通过 Runner 来使用 Graph 包。这是推荐的使用模式：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-6-1">  1</a></span>
<span class="normal"><a href="#__codelineno-6-2">  2</a></span>
<span class="normal"><a href="#__codelineno-6-3">  3</a></span>
<span class="normal"><a href="#__codelineno-6-4">  4</a></span>
<span class="normal"><a href="#__codelineno-6-5">  5</a></span>
<span class="normal"><a href="#__codelineno-6-6">  6</a></span>
<span class="normal"><a href="#__codelineno-6-7">  7</a></span>
<span class="normal"><a href="#__codelineno-6-8">  8</a></span>
<span class="normal"><a href="#__codelineno-6-9">  9</a></span>
<span class="normal"><a href="#__codelineno-6-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-6-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-6-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-6-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-6-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-6-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-6-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-6-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-6-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-6-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-6-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-6-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-6-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-6-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-6-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-6-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-6-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-6-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-6-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-6-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-6-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-6-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-6-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-6-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-6-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-6-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-6-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-6-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-6-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-6-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-6-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-6-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-6-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-6-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-6-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-6-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-6-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-6-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-6-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-6-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-6-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-6-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-6-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-6-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-6-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-6-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-6-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-6-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-6-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-6-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-6-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-6-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-6-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-6-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-6-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-6-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-6-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-6-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-6-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-6-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-6-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-6-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-6-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-6-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-6-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-6-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-6-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-6-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-6-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-6-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-6-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-6-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-6-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-6-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-6-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-6-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-6-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-6-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-6-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-6-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-6-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-6-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-6-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-6-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-6-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-6-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-6-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-6-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-6-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-6-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-6-100">100</a></span>
<span class="normal"><a href="#__codelineno-6-101">101</a></span>
<span class="normal"><a href="#__codelineno-6-102">102</a></span>
<span class="normal"><a href="#__codelineno-6-103">103</a></span>
<span class="normal"><a href="#__codelineno-6-104">104</a></span>
<span class="normal"><a href="#__codelineno-6-105">105</a></span>
<span class="normal"><a href="#__codelineno-6-106">106</a></span>
<span class="normal"><a href="#__codelineno-6-107">107</a></span>
<span class="normal"><a href="#__codelineno-6-108">108</a></span>
<span class="normal"><a href="#__codelineno-6-109">109</a></span>
<span class="normal"><a href="#__codelineno-6-110">110</a></span>
<span class="normal"><a href="#__codelineno-6-111">111</a></span>
<span class="normal"><a href="#__codelineno-6-112">112</a></span>
<span class="normal"><a href="#__codelineno-6-113">113</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="kn">package</span><span class="w"> </span><span class="nx">main</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2"></a>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4"></a><span class="w">    </span><span class="s">&quot;context&quot;</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5"></a><span class="w">    </span><span class="s">&quot;fmt&quot;</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6"></a><span class="w">    </span><span class="s">&quot;time&quot;</span>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7"></a>
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/agent/graphagent&quot;</span>
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/event&quot;</span>
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-6-11"><a id="__codelineno-6-11" name="__codelineno-6-11"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/model&quot;</span>
</span><span id="__span-6-12"><a id="__codelineno-6-12" name="__codelineno-6-12"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/runner&quot;</span>
</span><span id="__span-6-13"><a id="__codelineno-6-13" name="__codelineno-6-13"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/session/inmemory&quot;</span>
</span><span id="__span-6-14"><a id="__codelineno-6-14" name="__codelineno-6-14"></a><span class="p">)</span>
</span><span id="__span-6-15"><a id="__codelineno-6-15" name="__codelineno-6-15"></a>
</span><span id="__span-6-16"><a id="__codelineno-6-16" name="__codelineno-6-16"></a><span class="kd">func</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-6-17"><a id="__codelineno-6-17" name="__codelineno-6-17"></a><span class="w">    </span><span class="c1">// 1. 创建状态模式</span>
</span><span id="__span-6-18"><a id="__codelineno-6-18" name="__codelineno-6-18"></a><span class="w">    </span><span class="nx">schema</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">MessagesStateSchema</span><span class="p">()</span>
</span><span id="__span-6-19"><a id="__codelineno-6-19" name="__codelineno-6-19"></a>
</span><span id="__span-6-20"><a id="__codelineno-6-20" name="__codelineno-6-20"></a><span class="w">    </span><span class="c1">// 2. 创建状态图构建器</span>
</span><span id="__span-6-21"><a id="__codelineno-6-21" name="__codelineno-6-21"></a><span class="w">    </span><span class="nx">stateGraph</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateGraph</span><span class="p">(</span><span class="nx">schema</span><span class="p">)</span>
</span><span id="__span-6-22"><a id="__codelineno-6-22" name="__codelineno-6-22"></a>
</span><span id="__span-6-23"><a id="__codelineno-6-23" name="__codelineno-6-23"></a><span class="w">    </span><span class="c1">// 3. 添加节点</span>
</span><span id="__span-6-24"><a id="__codelineno-6-24" name="__codelineno-6-24"></a><span class="w">    </span><span class="nx">stateGraph</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;start&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">startNodeFunc</span><span class="p">).</span>
</span><span id="__span-6-25"><a id="__codelineno-6-25" name="__codelineno-6-25"></a><span class="w">        </span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;process&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">processNodeFunc</span><span class="p">)</span>
</span><span id="__span-6-26"><a id="__codelineno-6-26" name="__codelineno-6-26"></a>
</span><span id="__span-6-27"><a id="__codelineno-6-27" name="__codelineno-6-27"></a><span class="w">    </span><span class="c1">// 4. 设置边</span>
</span><span id="__span-6-28"><a id="__codelineno-6-28" name="__codelineno-6-28"></a><span class="w">    </span><span class="nx">stateGraph</span><span class="p">.</span><span class="nx">AddEdge</span><span class="p">(</span><span class="s">&quot;start&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;process&quot;</span><span class="p">)</span>
</span><span id="__span-6-29"><a id="__codelineno-6-29" name="__codelineno-6-29"></a>
</span><span id="__span-6-30"><a id="__codelineno-6-30" name="__codelineno-6-30"></a><span class="w">    </span><span class="c1">// 5. 设置入口点和结束点</span>
</span><span id="__span-6-31"><a id="__codelineno-6-31" name="__codelineno-6-31"></a><span class="w">    </span><span class="c1">// SetEntryPoint 会自动创建虚拟 Start 节点到 &quot;start&quot; 节点的边</span>
</span><span id="__span-6-32"><a id="__codelineno-6-32" name="__codelineno-6-32"></a><span class="w">    </span><span class="c1">// SetFinishPoint 会自动创建 &quot;process&quot; 节点到虚拟 End 节点的边</span>
</span><span id="__span-6-33"><a id="__codelineno-6-33" name="__codelineno-6-33"></a><span class="w">    </span><span class="nx">stateGraph</span><span class="p">.</span><span class="nx">SetEntryPoint</span><span class="p">(</span><span class="s">&quot;start&quot;</span><span class="p">).</span>
</span><span id="__span-6-34"><a id="__codelineno-6-34" name="__codelineno-6-34"></a><span class="w">        </span><span class="nx">SetFinishPoint</span><span class="p">(</span><span class="s">&quot;process&quot;</span><span class="p">)</span>
</span><span id="__span-6-35"><a id="__codelineno-6-35" name="__codelineno-6-35"></a>
</span><span id="__span-6-36"><a id="__codelineno-6-36" name="__codelineno-6-36"></a><span class="w">    </span><span class="c1">// 6. 编译图</span>
</span><span id="__span-6-37"><a id="__codelineno-6-37" name="__codelineno-6-37"></a><span class="w">    </span><span class="nx">compiledGraph</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">stateGraph</span><span class="p">.</span><span class="nx">Compile</span><span class="p">()</span>
</span><span id="__span-6-38"><a id="__codelineno-6-38" name="__codelineno-6-38"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-6-39"><a id="__codelineno-6-39" name="__codelineno-6-39"></a><span class="w">        </span><span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span id="__span-6-40"><a id="__codelineno-6-40" name="__codelineno-6-40"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-6-41"><a id="__codelineno-6-41" name="__codelineno-6-41"></a>
</span><span id="__span-6-42"><a id="__codelineno-6-42" name="__codelineno-6-42"></a><span class="w">    </span><span class="c1">// 7. 创建 GraphAgent</span>
</span><span id="__span-6-43"><a id="__codelineno-6-43" name="__codelineno-6-43"></a><span class="w">    </span><span class="nx">graphAgent</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;simple-workflow&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">compiledGraph</span><span class="p">,</span>
</span><span id="__span-6-44"><a id="__codelineno-6-44" name="__codelineno-6-44"></a><span class="w">        </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithDescription</span><span class="p">(</span><span class="s">&quot;简单的工作流示例&quot;</span><span class="p">),</span>
</span><span id="__span-6-45"><a id="__codelineno-6-45" name="__codelineno-6-45"></a><span class="w">        </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithInitialState</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{}),</span>
</span><span id="__span-6-46"><a id="__codelineno-6-46" name="__codelineno-6-46"></a><span class="w">    </span><span class="p">)</span>
</span><span id="__span-6-47"><a id="__codelineno-6-47" name="__codelineno-6-47"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-6-48"><a id="__codelineno-6-48" name="__codelineno-6-48"></a><span class="w">        </span><span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span id="__span-6-49"><a id="__codelineno-6-49" name="__codelineno-6-49"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-6-50"><a id="__codelineno-6-50" name="__codelineno-6-50"></a>
</span><span id="__span-6-51"><a id="__codelineno-6-51" name="__codelineno-6-51"></a><span class="w">    </span><span class="c1">// 8. 创建会话服务</span>
</span><span id="__span-6-52"><a id="__codelineno-6-52" name="__codelineno-6-52"></a><span class="w">    </span><span class="nx">sessionService</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">inmemory</span><span class="p">.</span><span class="nx">NewSessionService</span><span class="p">()</span>
</span><span id="__span-6-53"><a id="__codelineno-6-53" name="__codelineno-6-53"></a>
</span><span id="__span-6-54"><a id="__codelineno-6-54" name="__codelineno-6-54"></a><span class="w">    </span><span class="c1">// 9. 创建 Runner</span>
</span><span id="__span-6-55"><a id="__codelineno-6-55" name="__codelineno-6-55"></a><span class="w">    </span><span class="nx">appRunner</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">runner</span><span class="p">.</span><span class="nx">NewRunner</span><span class="p">(</span>
</span><span id="__span-6-56"><a id="__codelineno-6-56" name="__codelineno-6-56"></a><span class="w">        </span><span class="s">&quot;simple-app&quot;</span><span class="p">,</span>
</span><span id="__span-6-57"><a id="__codelineno-6-57" name="__codelineno-6-57"></a><span class="w">        </span><span class="nx">graphAgent</span><span class="p">,</span>
</span><span id="__span-6-58"><a id="__codelineno-6-58" name="__codelineno-6-58"></a><span class="w">        </span><span class="nx">runner</span><span class="p">.</span><span class="nx">WithSessionService</span><span class="p">(</span><span class="nx">sessionService</span><span class="p">),</span>
</span><span id="__span-6-59"><a id="__codelineno-6-59" name="__codelineno-6-59"></a><span class="w">    </span><span class="p">)</span>
</span><span id="__span-6-60"><a id="__codelineno-6-60" name="__codelineno-6-60"></a>
</span><span id="__span-6-61"><a id="__codelineno-6-61" name="__codelineno-6-61"></a><span class="w">    </span><span class="c1">// 10. 执行工作流</span>
</span><span id="__span-6-62"><a id="__codelineno-6-62" name="__codelineno-6-62"></a><span class="w">    </span><span class="nx">ctx</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Background</span><span class="p">()</span>
</span><span id="__span-6-63"><a id="__codelineno-6-63" name="__codelineno-6-63"></a><span class="w">    </span><span class="nx">userID</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;user&quot;</span>
</span><span id="__span-6-64"><a id="__codelineno-6-64" name="__codelineno-6-64"></a><span class="w">    </span><span class="nx">sessionID</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;session-%d&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">().</span><span class="nx">Unix</span><span class="p">())</span>
</span><span id="__span-6-65"><a id="__codelineno-6-65" name="__codelineno-6-65"></a>
</span><span id="__span-6-66"><a id="__codelineno-6-66" name="__codelineno-6-66"></a><span class="w">    </span><span class="c1">// 创建用户消息（Runner 会自动将消息内容放入 StateKeyUserInput）</span>
</span><span id="__span-6-67"><a id="__codelineno-6-67" name="__codelineno-6-67"></a><span class="w">    </span><span class="nx">message</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">model</span><span class="p">.</span><span class="nx">NewUserMessage</span><span class="p">(</span><span class="s">&quot;Hello World&quot;</span><span class="p">)</span>
</span><span id="__span-6-68"><a id="__codelineno-6-68" name="__codelineno-6-68"></a>
</span><span id="__span-6-69"><a id="__codelineno-6-69" name="__codelineno-6-69"></a><span class="w">    </span><span class="c1">// 通过 Runner 执行</span>
</span><span id="__span-6-70"><a id="__codelineno-6-70" name="__codelineno-6-70"></a><span class="w">    </span><span class="nx">eventChan</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">appRunner</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">userID</span><span class="p">,</span><span class="w"> </span><span class="nx">sessionID</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="p">)</span>
</span><span id="__span-6-71"><a id="__codelineno-6-71" name="__codelineno-6-71"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-6-72"><a id="__codelineno-6-72" name="__codelineno-6-72"></a><span class="w">        </span><span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span id="__span-6-73"><a id="__codelineno-6-73" name="__codelineno-6-73"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-6-74"><a id="__codelineno-6-74" name="__codelineno-6-74"></a>
</span><span id="__span-6-75"><a id="__codelineno-6-75" name="__codelineno-6-75"></a><span class="w">    </span><span class="c1">// 处理事件流</span>
</span><span id="__span-6-76"><a id="__codelineno-6-76" name="__codelineno-6-76"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">event</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">eventChan</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-6-77"><a id="__codelineno-6-77" name="__codelineno-6-77"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">event</span><span class="p">.</span><span class="nx">Error</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-6-78"><a id="__codelineno-6-78" name="__codelineno-6-78"></a><span class="w">            </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;错误: %s\n&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">event</span><span class="p">.</span><span class="nx">Error</span><span class="p">.</span><span class="nx">Message</span><span class="p">)</span>
</span><span id="__span-6-79"><a id="__codelineno-6-79" name="__codelineno-6-79"></a><span class="w">            </span><span class="k">continue</span>
</span><span id="__span-6-80"><a id="__codelineno-6-80" name="__codelineno-6-80"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-6-81"><a id="__codelineno-6-81" name="__codelineno-6-81"></a>
</span><span id="__span-6-82"><a id="__codelineno-6-82" name="__codelineno-6-82"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">Response</span><span class="p">.</span><span class="nx">Choices</span><span class="p">)</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-6-83"><a id="__codelineno-6-83" name="__codelineno-6-83"></a><span class="w">            </span><span class="nx">choice</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">event</span><span class="p">.</span><span class="nx">Response</span><span class="p">.</span><span class="nx">Choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="__span-6-84"><a id="__codelineno-6-84" name="__codelineno-6-84"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">choice</span><span class="p">.</span><span class="nx">Delta</span><span class="p">.</span><span class="nx">Content</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-6-85"><a id="__codelineno-6-85" name="__codelineno-6-85"></a><span class="w">                </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Print</span><span class="p">(</span><span class="nx">choice</span><span class="p">.</span><span class="nx">Delta</span><span class="p">.</span><span class="nx">Content</span><span class="p">)</span>
</span><span id="__span-6-86"><a id="__codelineno-6-86" name="__codelineno-6-86"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-6-87"><a id="__codelineno-6-87" name="__codelineno-6-87"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-6-88"><a id="__codelineno-6-88" name="__codelineno-6-88"></a>
</span><span id="__span-6-89"><a id="__codelineno-6-89" name="__codelineno-6-89"></a><span class="w">        </span><span class="c1">// 推荐：使用 Runner 完成事件作为“流程结束”的信号。</span>
</span><span id="__span-6-90"><a id="__codelineno-6-90" name="__codelineno-6-90"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">event</span><span class="p">.</span><span class="nx">IsRunnerCompletion</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-6-91"><a id="__codelineno-6-91" name="__codelineno-6-91"></a><span class="w">            </span><span class="k">break</span>
</span><span id="__span-6-92"><a id="__codelineno-6-92" name="__codelineno-6-92"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-6-93"><a id="__codelineno-6-93" name="__codelineno-6-93"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-6-94"><a id="__codelineno-6-94" name="__codelineno-6-94"></a><span class="p">}</span>
</span><span id="__span-6-95"><a id="__codelineno-6-95" name="__codelineno-6-95"></a>
</span><span id="__span-6-96"><a id="__codelineno-6-96" name="__codelineno-6-96"></a><span class="c1">// 节点函数实现</span>
</span><span id="__span-6-97"><a id="__codelineno-6-97" name="__codelineno-6-97"></a><span class="kd">func</span><span class="w"> </span><span class="nx">startNodeFunc</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-6-98"><a id="__codelineno-6-98" name="__codelineno-6-98"></a><span class="w">    </span><span class="c1">// 从内置的 StateKeyUserInput 获取用户输入（由 Runner 自动设置）</span>
</span><span id="__span-6-99"><a id="__codelineno-6-99" name="__codelineno-6-99"></a><span class="w">    </span><span class="nx">input</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">state</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyUserInput</span><span class="p">].(</span><span class="kt">string</span><span class="p">)</span>
</span><span id="__span-6-100"><a id="__codelineno-6-100" name="__codelineno-6-100"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span>
</span><span id="__span-6-101"><a id="__codelineno-6-101" name="__codelineno-6-101"></a><span class="w">        </span><span class="nx">StateKeyProcessedData</span><span class="p">:</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;处理后的: %s&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">input</span><span class="p">),</span>
</span><span id="__span-6-102"><a id="__codelineno-6-102" name="__codelineno-6-102"></a><span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-6-103"><a id="__codelineno-6-103" name="__codelineno-6-103"></a><span class="p">}</span>
</span><span id="__span-6-104"><a id="__codelineno-6-104" name="__codelineno-6-104"></a>
</span><span id="__span-6-105"><a id="__codelineno-6-105" name="__codelineno-6-105"></a><span class="kd">func</span><span class="w"> </span><span class="nx">processNodeFunc</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-6-106"><a id="__codelineno-6-106" name="__codelineno-6-106"></a><span class="w">    </span><span class="nx">processed</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">state</span><span class="p">[</span><span class="nx">StateKeyProcessedData</span><span class="p">].(</span><span class="kt">string</span><span class="p">)</span>
</span><span id="__span-6-107"><a id="__codelineno-6-107" name="__codelineno-6-107"></a><span class="w">    </span><span class="nx">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;结果: %s&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">processed</span><span class="p">)</span>
</span><span id="__span-6-108"><a id="__codelineno-6-108" name="__codelineno-6-108"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span>
</span><span id="__span-6-109"><a id="__codelineno-6-109" name="__codelineno-6-109"></a><span class="w">        </span><span class="nx">StateKeyResult</span><span class="p">:</span><span class="w"> </span><span class="nx">result</span><span class="p">,</span>
</span><span id="__span-6-110"><a id="__codelineno-6-110" name="__codelineno-6-110"></a><span class="w">        </span><span class="c1">// 使用内置的 StateKeyLastResponse 来设置最终输出</span>
</span><span id="__span-6-111"><a id="__codelineno-6-111" name="__codelineno-6-111"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyLastResponse</span><span class="p">:</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;最终结果: %s&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">result</span><span class="p">),</span>
</span><span id="__span-6-112"><a id="__codelineno-6-112" name="__codelineno-6-112"></a><span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-6-113"><a id="__codelineno-6-113" name="__codelineno-6-113"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="2-llm">2. 使用 LLM 节点</h3>
<p>LLM 节点实现了固定的三段式输入规则，无需配置：</p>
<ol>
<li><strong>OneShot 优先</strong>：若存在 <code>one_shot_messages</code>，以它为本轮输入。</li>
<li><strong>UserInput 其次</strong>：否则若存在 <code>user_input</code>，自动持久化一次。</li>
<li><strong>历史默认</strong>：否则以持久化历史作为输入。</li>
</ol>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-7-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-7-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-7-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-7-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-7-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-7-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-7-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-7-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-7-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-7-10">10</a></span>
<span class="normal"><a href="#__codelineno-7-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="c1">// 创建 LLM 模型</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="nx">model</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">openai</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;gpt-4&quot;</span><span class="p">)</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3"></a>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4"></a><span class="c1">// 添加 LLM 节点</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5"></a><span class="nx">stateGraph</span><span class="p">.</span><span class="nx">AddLLMNode</span><span class="p">(</span><span class="s">&quot;analyze&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">model</span><span class="p">,</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6"></a><span class="w">    </span><span class="s">`你是一个文档分析专家。分析提供的文档并：</span>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7"></a><span class="s">1. 分类文档类型和复杂度</span>
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8"></a><span class="s">2. 提取关键主题</span>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9"></a><span class="s">3. 评估内容质量</span>
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10"></a><span class="s">请提供结构化的分析结果。`</span><span class="p">,</span>
</span><span id="__span-7-11"><a id="__codelineno-7-11" name="__codelineno-7-11"></a><span class="w">    </span><span class="kc">nil</span><span class="p">)</span><span class="w"> </span><span class="c1">// 工具映射</span>
</span></code></pre></div></td></tr></table></div>
<p><strong>重要说明</strong>：</p>
<ul>
<li>SystemPrompt 仅用于本次输入，不落持久化状态。</li>
<li>一次性键（<code>user_input</code>/<code>one_shot_messages</code>）在成功执行后自动清空。</li>
<li>所有状态更新都是原子性的，确保一致性。</li>
<li>GraphAgent/Runner 仅设置 <code>user_input</code>，不再预先把用户消息写入
  <code>messages</code>。这样可以允许在 LLM 节点之前的任意节点对 <code>user_input</code>
  进行修改，并能在同一轮生效。</li>
</ul>
<h4 id="_9">三种输入范式</h4>
<ul>
<li>
<p>OneShot（<code>StateKeyOneShotMessages</code>）：</p>
<ul>
<li>当该键存在时，本轮仅使用这里提供的 <code>[]model.Message</code> 调用模型，
  通常包含完整的 system prompt 与 user prompt。调用后自动清空。</li>
<li>适用场景：前置节点专门构造 prompt 的工作流，需完全覆盖本轮输入。</li>
</ul>
</li>
</ul>
<ul>
<li>
<p>UserInput（<code>StateKeyUserInput</code>）：</p>
<ul>
<li>当 <code>user_input</code> 非空时，LLM 节点会取持久化历史 <code>messages</code>，并将
  本轮的用户输入合并后发起调用。结束后会把用户输入与助手回复通过
  <code>MessageOp</code>（例如 <code>AppendMessages</code>、<code>ReplaceLastUser</code>）原子性写入
  到 <code>messages</code>，并自动清空 <code>user_input</code> 以避免重复追加。</li>
<li>适用场景：普通对话式工作流，允许在前置节点动态调整用户输入。</li>
</ul>
</li>
</ul>
<ul>
<li>Messages only（仅 <code>StateKeyMessages</code>）：<ul>
<li>多用于工具调用回路。当第一轮经由 <code>user_input</code> 发起后，路由到工具
  节点执行，再回到 LLM 节点时，因为 <code>user_input</code> 已被清空，LLM 将走
  “Messages only” 分支，以历史中的 tool 响应继续推理。</li>
</ul>
</li>
</ul>
<h4 id="llm">LLM 指令中的占位符</h4>
<p>LLM 节点的 <code>instruction</code> 支持占位符注入（与 LLMAgent 规则一致）。支持原生 <code>{key}</code> 与 Mustache <code>{{key}}</code> 两种写法（Mustache 会自动规整为原生写法）：</p>
<ul>
<li><code>{key}</code> / <code>{{key}}</code> → 替换为 <code>session.State["key"]</code></li>
<li><code>{key?}</code> / <code>{{key?}}</code> → 可选，缺失时替换为空</li>
<li><code>{user:subkey}</code>、<code>{app:subkey}</code>、<code>{temp:subkey}</code>（以及其 Mustache 写法）→ 访问用户/应用/临时命名空间（SessionService 会将 app/user 作用域合并到 session，并带上前缀）</li>
</ul>
<p>说明：</p>
<ul>
<li>GraphAgent 会把当前 <code>*session.Session</code> 写入图状态的 <code>StateKeySession</code>，LLM 节点据此读取注入值</li>
<li>无前缀键（如 <code>research_topics</code>）需要直接存在于 <code>session.State</code></li>
</ul>
<p>示例：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-8-1">1</a></span>
<span class="normal"><a href="#__codelineno-8-2">2</a></span>
<span class="normal"><a href="#__codelineno-8-3">3</a></span>
<span class="normal"><a href="#__codelineno-8-4">4</a></span>
<span class="normal"><a href="#__codelineno-8-5">5</a></span>
<span class="normal"><a href="#__codelineno-8-6">6</a></span>
<span class="normal"><a href="#__codelineno-8-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="nx">mdl</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">openai</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="nx">modelName</span><span class="p">)</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="nx">stateGraph</span><span class="p">.</span><span class="nx">AddLLMNode</span><span class="p">(</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="w">  </span><span class="s">&quot;research&quot;</span><span class="p">,</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4"></a><span class="w">  </span><span class="nx">mdl</span><span class="p">,</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5"></a><span class="w">  </span><span class="s">&quot;You are a research assistant. Focus: {research_topics}. User: {user:topics?}. App: {app:banner?}.&quot;</span><span class="p">,</span>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6"></a><span class="w">  </span><span class="kc">nil</span><span class="p">,</span>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7"></a><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>可参考可运行示例：<code>examples/graph/placeholder</code>。</p>
<p>将检索结果与用户输入注入指令</p>
<ul>
<li>在进入 LLM 节点前的任意节点，将临时值写入会话的 <code>temp:</code> 命名空间，LLM 指令即可用占位符读取。</li>
<li>示例模式：</li>
</ul>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-9-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-9-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-9-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-9-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-9-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-9-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-9-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-9-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-9-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-9-10">10</a></span>
<span class="normal"><a href="#__codelineno-9-11">11</a></span>
<span class="normal"><a href="#__codelineno-9-12">12</a></span>
<span class="normal"><a href="#__codelineno-9-13">13</a></span>
<span class="normal"><a href="#__codelineno-9-14">14</a></span>
<span class="normal"><a href="#__codelineno-9-15">15</a></span>
<span class="normal"><a href="#__codelineno-9-16">16</a></span>
<span class="normal"><a href="#__codelineno-9-17">17</a></span>
<span class="normal"><a href="#__codelineno-9-18">18</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="c1">// 在 LLM 节点之前</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2"></a><span class="nx">stateGraph</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;retrieve&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3"></a><span class="w">    </span><span class="c1">// 假设你已经得到检索内容 retrieved，并希望连同当前用户输入一起注入</span>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4"></a><span class="w">    </span><span class="nx">retrieved</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;• 文档A...\n• 文档B...&quot;</span>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5"></a><span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">input</span><span class="w"> </span><span class="kt">string</span>
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">v</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">s</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyUserInput</span><span class="p">].(</span><span class="kt">string</span><span class="p">);</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">input</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">v</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">sess</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">s</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeySession</span><span class="p">].(</span><span class="o">*</span><span class="nx">session</span><span class="p">.</span><span class="nx">Session</span><span class="p">);</span><span class="w"> </span><span class="nx">sess</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-9-8"><a id="__codelineno-9-8" name="__codelineno-9-8"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">sess</span><span class="p">.</span><span class="nx">State</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">sess</span><span class="p">.</span><span class="nx">State</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="nx">session</span><span class="p">.</span><span class="nx">StateMap</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-9-9"><a id="__codelineno-9-9" name="__codelineno-9-9"></a><span class="w">        </span><span class="nx">sess</span><span class="p">.</span><span class="nx">State</span><span class="p">[</span><span class="nx">session</span><span class="p">.</span><span class="nx">StateTempPrefix</span><span class="o">+</span><span class="s">&quot;retrieved_context&quot;</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">retrieved</span><span class="p">)</span>
</span><span id="__span-9-10"><a id="__codelineno-9-10" name="__codelineno-9-10"></a><span class="w">        </span><span class="nx">sess</span><span class="p">.</span><span class="nx">State</span><span class="p">[</span><span class="nx">session</span><span class="p">.</span><span class="nx">StateTempPrefix</span><span class="o">+</span><span class="s">&quot;user_input&quot;</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">input</span><span class="p">)</span>
</span><span id="__span-9-11"><a id="__codelineno-9-11" name="__codelineno-9-11"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-9-12"><a id="__codelineno-9-12" name="__codelineno-9-12"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-9-13"><a id="__codelineno-9-13" name="__codelineno-9-13"></a><span class="p">})</span>
</span><span id="__span-9-14"><a id="__codelineno-9-14" name="__codelineno-9-14"></a>
</span><span id="__span-9-15"><a id="__codelineno-9-15" name="__codelineno-9-15"></a><span class="c1">// LLM 节点的指令引用 {temp:retrieved_context} 和 {temp:user_input}</span>
</span><span id="__span-9-16"><a id="__codelineno-9-16" name="__codelineno-9-16"></a><span class="nx">stateGraph</span><span class="p">.</span><span class="nx">AddLLMNode</span><span class="p">(</span><span class="s">&quot;answer&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">mdl</span><span class="p">,</span>
</span><span id="__span-9-17"><a id="__codelineno-9-17" name="__codelineno-9-17"></a><span class="w">    </span><span class="s">&quot;请结合上下文回答。\n\n上下文：\n{temp:retrieved_context}\n\n问题：{temp:user_input}&quot;</span><span class="p">,</span>
</span><span id="__span-9-18"><a id="__codelineno-9-18" name="__codelineno-9-18"></a><span class="w">    </span><span class="kc">nil</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>示例：<code>examples/graph/retrieval_placeholder</code>。</p>
<p>占位符与会话状态的最佳实践</p>
<ul>
<li>短期 vs 持久：只用于本轮提示词组装的数据写到 <code>session.State</code> 的 <code>temp:*</code>；需要跨轮/跨会话保留的配置，请通过 SessionService（会话服务）更新 <code>user:*</code>/<code>app:*</code>。</li>
<li>为什么可以直接写：LLM 节点从图状态里的会话对象读取并展开占位符，见 <a href="https://github.com/trpc-group/trpc-agent-go/blob/main/graph/state_graph.go">graph/state_graph.go</a>；GraphAgent 在启动时把会话对象放入图状态，见 <a href="https://github.com/trpc-group/trpc-agent-go/blob/main/agent/graphagent/graph_agent.go">agent/graphagent/graph_agent.go</a>。</li>
<li>服务侧护栏：内存实现禁止通过“更新用户态”的接口写 <code>temp:*</code>（以及 <code>app:*</code> via user updater），见 <a href="https://github.com/trpc-group/trpc-agent-go/blob/main/session/inmemory/service.go">session/inmemory/service.go</a>。</li>
<li>并发建议：并行分支不要同时改同一批 <code>session.State</code> 键；建议汇总到单节点合并后一次写入，或先放图状态再一次写到 <code>temp:*</code>。</li>
<li>可观测性：若希望在完成事件中看到摘要，可额外把精简信息放入图状态（如 <code>metadata</code>）；最终事件会序列化非内部的最终状态，见 <a href="https://github.com/trpc-group/trpc-agent-go/blob/main/graph/events.go">graph/events.go</a>。</li>
</ul>
<h4 id="reducer-messageop">通过 Reducer 与 MessageOp 实现的原子更新</h4>
<p>Graph 包的消息状态支持 <code>MessageOp</code> 补丁操作（如 <code>ReplaceLastUser</code>、
<code>AppendMessages</code> 等），由 <code>MessageReducer</code> 实现原子合并。这带来两个
直接收益：</p>
<ul>
<li>允许在 LLM 节点之前修改 <code>user_input</code>，LLM 节点会据此在一次返回中将
  需要的操作（例如替换最后一条用户消息、追加助手消息）以补丁形式返回，
  执行器一次性落库，避免竞态与重复。`</li>
<li>兼容传统的直接 <code>[]Message</code> 追加用法，同时为复杂更新提供更高的表达力。</li>
</ul>
<p>示例：在前置节点修改 <code>user_input</code>，随后进入 LLM 节点。</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-10-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-10-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-10-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-10-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-10-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-10-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-10-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-10-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-10-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-10-10">10</a></span>
<span class="normal"><a href="#__codelineno-10-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="nx">stateGraph</span><span class="p">.</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2"></a><span class="w">    </span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;prepare_input&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3"></a><span class="w">        </span><span class="c1">// 清洗/改写用户输入，使其在本轮 LLM 中生效。</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4"></a><span class="w">        </span><span class="nx">cleaned</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">strings</span><span class="p">.</span><span class="nx">TrimSpace</span><span class="p">(</span><span class="nx">s</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyUserInput</span><span class="p">].(</span><span class="kt">string</span><span class="p">))</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyUserInput</span><span class="p">:</span><span class="w"> </span><span class="nx">cleaned</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6"></a><span class="w">    </span><span class="p">}).</span>
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7"></a><span class="w">    </span><span class="nx">AddLLMNode</span><span class="p">(</span><span class="s">&quot;ask&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">modelInstance</span><span class="p">,</span>
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8"></a><span class="w">        </span><span class="s">&quot;你是一个有帮助的助手。请简洁回答。&quot;</span><span class="p">,</span>
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9"></a><span class="w">        </span><span class="kc">nil</span><span class="p">).</span>
</span><span id="__span-10-10"><a id="__codelineno-10-10" name="__codelineno-10-10"></a><span class="w">    </span><span class="nx">SetEntryPoint</span><span class="p">(</span><span class="s">&quot;prepare_input&quot;</span><span class="p">).</span>
</span><span id="__span-10-11"><a id="__codelineno-10-11" name="__codelineno-10-11"></a><span class="w">    </span><span class="nx">SetFinishPoint</span><span class="p">(</span><span class="s">&quot;ask&quot;</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="3-graphagent">3. GraphAgent 配置选项</h3>
<p>GraphAgent 支持多种配置选项：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-11-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-11-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-11-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-11-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-11-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-11-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-11-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-11-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-11-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-11-10">10</a></span>
<span class="normal"><a href="#__codelineno-11-11">11</a></span>
<span class="normal"><a href="#__codelineno-11-12">12</a></span>
<span class="normal"><a href="#__codelineno-11-13">13</a></span>
<span class="normal"><a href="#__codelineno-11-14">14</a></span>
<span class="normal"><a href="#__codelineno-11-15">15</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="c1">// 创建 GraphAgent 时可以使用多种选项</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2"></a><span class="nx">graphAgent</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3"></a><span class="w">    </span><span class="s">&quot;workflow-name&quot;</span><span class="p">,</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4"></a><span class="w">    </span><span class="nx">compiledGraph</span><span class="p">,</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithDescription</span><span class="p">(</span><span class="s">&quot;工作流描述&quot;</span><span class="p">),</span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithInitialState</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7"></a><span class="w">        </span><span class="s">&quot;initial_data&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;初始数据&quot;</span><span class="p">,</span>
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8"></a><span class="w">    </span><span class="p">}),</span>
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithChannelBufferSize</span><span class="p">(</span><span class="mi">1024</span><span class="p">),</span><span class="w">           </span><span class="c1">// 调整事件通道缓冲区</span>
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithCheckpointSaver</span><span class="p">(</span><span class="nx">memorySaver</span><span class="p">),</span><span class="w">      </span><span class="c1">// 使用持久化检查点</span>
</span><span id="__span-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithSubAgents</span><span class="p">([]</span><span class="nx">agent</span><span class="p">.</span><span class="nx">Agent</span><span class="p">{</span><span class="nx">subAgent</span><span class="p">}),</span><span class="w"> </span><span class="c1">// 配置子 Agent</span>
</span><span id="__span-11-12"><a id="__codelineno-11-12" name="__codelineno-11-12"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithAgentCallbacks</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">agent</span><span class="p">.</span><span class="nx">Callbacks</span><span class="p">{</span>
</span><span id="__span-11-13"><a id="__codelineno-11-13" name="__codelineno-11-13"></a><span class="w">        </span><span class="c1">// Agent 级回调配置</span>
</span><span id="__span-11-14"><a id="__codelineno-11-14" name="__codelineno-11-14"></a><span class="w">    </span><span class="p">}),</span>
</span><span id="__span-11-15"><a id="__codelineno-11-15" name="__codelineno-11-15"></a><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<blockquote>
<p>模型/工具回调需要在节点级配置，例如 <code>AddLLMNode(..., graph.WithModelCallbacks(...))</code>
或 <code>AddToolsNode(..., graph.WithToolCallbacks(...))</code>。</p>
</blockquote>
<p>配置了子 Agent 后，可以在图中使用 Agent 节点委托执行：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-12-1">1</a></span>
<span class="normal"><a href="#__codelineno-12-2">2</a></span>
<span class="normal"><a href="#__codelineno-12-3">3</a></span>
<span class="normal"><a href="#__codelineno-12-4">4</a></span>
<span class="normal"><a href="#__codelineno-12-5">5</a></span>
<span class="normal"><a href="#__codelineno-12-6">6</a></span>
<span class="normal"><a href="#__codelineno-12-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="c1">// 假设 subAgent.Info().Name == &quot;assistant&quot;</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2"></a><span class="nx">stateGraph</span><span class="p">.</span><span class="nx">AddAgentNode</span><span class="p">(</span><span class="s">&quot;assistant&quot;</span><span class="p">,</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithName</span><span class="p">(</span><span class="s">&quot;子 Agent 调度&quot;</span><span class="p">),</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithDescription</span><span class="p">(</span><span class="s">&quot;调用预先注册的 assistant Agent&quot;</span><span class="p">),</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5"></a><span class="p">)</span>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6"></a>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7"></a><span class="c1">// 执行时 GraphAgent 会在自身的 SubAgents 中查找同名 Agent 并发起调用</span>
</span></code></pre></div></td></tr></table></div>
<blockquote>
<p>Agent 节点会以节点 ID 作为查找键，因此需确保 <code>AddAgentNode("assistant")</code>
与 <code>subAgent.Info().Name == "assistant"</code> 一致。</p>
</blockquote>
<h3 id="4">4. 条件路由</h3>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-13-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-13-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-13-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-13-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-13-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-13-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-13-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-13-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-13-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-13-10">10</a></span>
<span class="normal"><a href="#__codelineno-13-11">11</a></span>
<span class="normal"><a href="#__codelineno-13-12">12</a></span>
<span class="normal"><a href="#__codelineno-13-13">13</a></span>
<span class="normal"><a href="#__codelineno-13-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="c1">// 定义条件函数</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2"></a><span class="kd">func</span><span class="w"> </span><span class="nx">complexityCondition</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3"></a><span class="w">    </span><span class="nx">complexity</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">state</span><span class="p">[</span><span class="s">&quot;complexity&quot;</span><span class="p">].(</span><span class="kt">string</span><span class="p">)</span>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">complexity</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;simple&quot;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;simple_process&quot;</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;complex_process&quot;</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8"></a><span class="p">}</span>
</span><span id="__span-13-9"><a id="__codelineno-13-9" name="__codelineno-13-9"></a>
</span><span id="__span-13-10"><a id="__codelineno-13-10" name="__codelineno-13-10"></a><span class="c1">// 添加条件边</span>
</span><span id="__span-13-11"><a id="__codelineno-13-11" name="__codelineno-13-11"></a><span class="nx">stateGraph</span><span class="p">.</span><span class="nx">AddConditionalEdges</span><span class="p">(</span><span class="s">&quot;analyze&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">complexityCondition</span><span class="p">,</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span>
</span><span id="__span-13-12"><a id="__codelineno-13-12" name="__codelineno-13-12"></a><span class="w">    </span><span class="s">&quot;simple_process&quot;</span><span class="p">:</span><span class="w">  </span><span class="s">&quot;simple_node&quot;</span><span class="p">,</span>
</span><span id="__span-13-13"><a id="__codelineno-13-13" name="__codelineno-13-13"></a><span class="w">    </span><span class="s">&quot;complex_process&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;complex_node&quot;</span><span class="p">,</span>
</span><span id="__span-13-14"><a id="__codelineno-13-14" name="__codelineno-13-14"></a><span class="p">})</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="41-ends">4.1 节点命名分支（Ends）</h3>
<p>当一个节点需要把“业务结论”（例如 <code>approve</code>/<code>reject</code>/<code>manual_review</code>）路由到具体的下游节点时，建议在该节点上声明命名分支（Ends）。</p>
<p>作用与优势：
- 在节点本地集中声明“符号名 → 具体目标”的映射，更直观、更易重构；
- 编译期校验：<code>Compile()</code> 会检查映射中的目标是否存在（或为常量 <code>graph.End</code>）；
- 路由统一：命令式路由（<code>Command.GoTo</code>）与条件路由都可复用同一份映射；
- 解耦：节点返回业务语义（例如 <code>GoTo:"approve"</code>），映射负责落地到图结构。</p>
<p>API：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-14-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-14-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-14-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-14-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-14-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-14-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-14-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-14-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-14-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-14-10">10</a></span>
<span class="normal"><a href="#__codelineno-14-11">11</a></span>
<span class="normal"><a href="#__codelineno-14-12">12</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="c1">// 在节点上声明 Ends（符号名到具体目标）</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;decision&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">decideNode</span><span class="p">,</span>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithEndsMap</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4"></a><span class="w">        </span><span class="s">&quot;approve&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;approved&quot;</span><span class="p">,</span>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5"></a><span class="w">        </span><span class="s">&quot;reject&quot;</span><span class="p">:</span><span class="w">  </span><span class="s">&quot;rejected&quot;</span><span class="p">,</span>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6"></a><span class="w">        </span><span class="c1">// 也可以把某个符号映射到终点</span>
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7"></a><span class="w">        </span><span class="c1">// &quot;drop&quot;:  graph.End,</span>
</span><span id="__span-14-8"><a id="__codelineno-14-8" name="__codelineno-14-8"></a><span class="w">    </span><span class="p">}),</span>
</span><span id="__span-14-9"><a id="__codelineno-14-9" name="__codelineno-14-9"></a><span class="p">)</span>
</span><span id="__span-14-10"><a id="__codelineno-14-10" name="__codelineno-14-10"></a>
</span><span id="__span-14-11"><a id="__codelineno-14-11" name="__codelineno-14-11"></a><span class="c1">// 简写：符号名与目标节点名相同的情况</span>
</span><span id="__span-14-12"><a id="__codelineno-14-12" name="__codelineno-14-12"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;router&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">routerNode</span><span class="p">,</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithEnds</span><span class="p">(</span><span class="s">&quot;nodeB&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;nodeC&quot;</span><span class="p">))</span>
</span></code></pre></div></td></tr></table></div>
<p>命令式路由（Command.GoTo）：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-15-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-15-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-15-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-15-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-15-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-15-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-15-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-15-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-15-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-15-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1"></a><span class="kd">func</span><span class="w"> </span><span class="nx">decideNode</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2"></a><span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="nx">s</span><span class="p">[</span><span class="s">&quot;decision&quot;</span><span class="p">].(</span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s">&quot;approve&quot;</span><span class="p">:</span>
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">graph</span><span class="p">.</span><span class="nx">Command</span><span class="p">{</span><span class="nx">GoTo</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;approve&quot;</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="c1">// 符号名</span>
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s">&quot;reject&quot;</span><span class="p">:</span>
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">graph</span><span class="p">.</span><span class="nx">Command</span><span class="p">{</span><span class="nx">GoTo</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;reject&quot;</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7"></a><span class="w">    </span><span class="k">default</span><span class="p">:</span>
</span><span id="__span-15-8"><a id="__codelineno-15-8" name="__codelineno-15-8"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">graph</span><span class="p">.</span><span class="nx">Command</span><span class="p">{</span><span class="nx">GoTo</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;reject&quot;</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-15-9"><a id="__codelineno-15-9" name="__codelineno-15-9"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-15-10"><a id="__codelineno-15-10" name="__codelineno-15-10"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>条件路由复用 Ends：当 <code>AddConditionalEdges(from, condition, pathMap)</code> 的 <code>pathMap</code> 为 <code>nil</code> 或未匹配到键时，执行器会继续使用该节点的 Ends 解析返回值；若仍未匹配，则把返回值当作具体节点 ID。</p>
<p>解析优先级：
1. 条件边 <code>pathMap</code> 的显式映射；
2. 当前节点的 Ends 映射（符号名 → 具体目标）；
3. 直接把返回值当作节点 ID。</p>
<p>编译期校验：
- <code>WithEndsMap/WithEnds</code> 中声明的目标会在 <code>Compile()</code> 阶段校验；
- 目标必须存在于图中或为特殊常量 <code>graph.End</code>。</p>
<p>注意：
- 请使用常量 <code>graph.End</code> 表示“终点”，不要使用字符串 "END"；
- 当通过 <code>Command.GoTo</code> 进行路由时，无需额外添加 <code>AddEdge(from, to)</code>；只需保证目标节点存在，若为终点需设置 <code>SetFinishPoint(target)</code>。</p>
<p>完整可运行示例：<code>examples/graph/multiends</code>。</p>
<h3 id="5">5. 工具节点集成</h3>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-16-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-16-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-16-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-16-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-16-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-16-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-16-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-16-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-16-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-16-10">10</a></span>
<span class="normal"><a href="#__codelineno-16-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1"></a><span class="c1">// 创建工具</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2"></a><span class="nx">tools</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">tool</span><span class="p">.</span><span class="nx">Tool</span><span class="p">{</span>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3"></a><span class="w">    </span><span class="s">&quot;calculator&quot;</span><span class="p">:</span><span class="w"> </span><span class="nx">calculatorTool</span><span class="p">,</span>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4"></a><span class="w">    </span><span class="s">&quot;search&quot;</span><span class="p">:</span><span class="w">     </span><span class="nx">searchTool</span><span class="p">,</span>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5"></a><span class="p">}</span>
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6"></a>
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7"></a><span class="c1">// 添加工具节点</span>
</span><span id="__span-16-8"><a id="__codelineno-16-8" name="__codelineno-16-8"></a><span class="nx">stateGraph</span><span class="p">.</span><span class="nx">AddToolsNode</span><span class="p">(</span><span class="s">&quot;tools&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">tools</span><span class="p">)</span>
</span><span id="__span-16-9"><a id="__codelineno-16-9" name="__codelineno-16-9"></a>
</span><span id="__span-16-10"><a id="__codelineno-16-10" name="__codelineno-16-10"></a><span class="c1">// 添加 LLM 到工具的条件路由</span>
</span><span id="__span-16-11"><a id="__codelineno-16-11" name="__codelineno-16-11"></a><span class="nx">stateGraph</span><span class="p">.</span><span class="nx">AddToolsConditionalEdges</span><span class="p">(</span><span class="s">&quot;llm_node&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;tools&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;fallback_node&quot;</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p><strong>工具调用配对机制与二次进入 LLM：</strong></p>
<ul>
<li>从 <code>messages</code> 尾部向前扫描最近的 <code>assistant(tool_calls)</code>；遇到 <code>user</code>
  则停止，确保配对正确。</li>
<li>当工具节点完成后返回到 LLM 节点时，<code>user_input</code> 已被清空，LLM 将走
  “Messages only” 分支，以历史中的 tool 响应继续推理。</li>
</ul>
<h3 id="6">6. 节点重试与退避</h3>
<p>为节点配置指数退避的重试策略（可选抖动）。失败的尝试不会产生写入；只有成功的一次才会落库并触发路由。</p>
<ul>
<li>节点级策略（<code>WithRetryPolicy</code>）：</li>
</ul>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-17-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-17-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-17-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-17-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-17-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-17-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-17-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-17-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-17-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-17-10">10</a></span>
<span class="normal"><a href="#__codelineno-17-11">11</a></span>
<span class="normal"><a href="#__codelineno-17-12">12</a></span>
<span class="normal"><a href="#__codelineno-17-13">13</a></span>
<span class="normal"><a href="#__codelineno-17-14">14</a></span>
<span class="normal"><a href="#__codelineno-17-15">15</a></span>
<span class="normal"><a href="#__codelineno-17-16">16</a></span>
<span class="normal"><a href="#__codelineno-17-17">17</a></span>
<span class="normal"><a href="#__codelineno-17-18">18</a></span>
<span class="normal"><a href="#__codelineno-17-19">19</a></span>
<span class="normal"><a href="#__codelineno-17-20">20</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1"></a><span class="c1">// 便捷策略（attempts 含首次尝试）</span>
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;unstable&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">unstableFunc</span><span class="p">,</span>
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithRetryPolicy</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithSimpleRetry</span><span class="p">(</span><span class="mi">3</span><span class="p">)))</span>
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4"></a>
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5"></a><span class="c1">// 完整策略</span>
</span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6"></a><span class="nx">policy</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">RetryPolicy</span><span class="p">{</span>
</span><span id="__span-17-7"><a id="__codelineno-17-7" name="__codelineno-17-7"></a><span class="w">    </span><span class="nx">MaxAttempts</span><span class="p">:</span><span class="w">     </span><span class="mi">3</span><span class="p">,</span><span class="w">                      </span><span class="c1">// 1 次首试 + 最多 2 次重试</span>
</span><span id="__span-17-8"><a id="__codelineno-17-8" name="__codelineno-17-8"></a><span class="w">    </span><span class="nx">InitialInterval</span><span class="p">:</span><span class="w"> </span><span class="mi">200</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span><span class="p">,</span><span class="w"> </span><span class="c1">// 基础等待</span>
</span><span id="__span-17-9"><a id="__codelineno-17-9" name="__codelineno-17-9"></a><span class="w">    </span><span class="nx">BackoffFactor</span><span class="p">:</span><span class="w">   </span><span class="mf">2.0</span><span class="p">,</span><span class="w">                    </span><span class="c1">// 指数增长</span>
</span><span id="__span-17-10"><a id="__codelineno-17-10" name="__codelineno-17-10"></a><span class="w">    </span><span class="nx">MaxInterval</span><span class="p">:</span><span class="w">     </span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">,</span><span class="w">        </span><span class="c1">// 上限</span>
</span><span id="__span-17-11"><a id="__codelineno-17-11" name="__codelineno-17-11"></a><span class="w">    </span><span class="nx">Jitter</span><span class="p">:</span><span class="w">          </span><span class="kc">true</span><span class="p">,</span><span class="w">                   </span><span class="c1">// 抖动</span>
</span><span id="__span-17-12"><a id="__codelineno-17-12" name="__codelineno-17-12"></a><span class="w">    </span><span class="nx">RetryOn</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="nx">graph</span><span class="p">.</span><span class="nx">RetryCondition</span><span class="p">{</span>
</span><span id="__span-17-13"><a id="__codelineno-17-13" name="__codelineno-17-13"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">DefaultTransientCondition</span><span class="p">(),</span><span class="w">   </span><span class="c1">// 截止/网络超时等瞬时错误</span>
</span><span id="__span-17-14"><a id="__codelineno-17-14" name="__codelineno-17-14"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">RetryOnErrors</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">DeadlineExceeded</span><span class="p">),</span>
</span><span id="__span-17-15"><a id="__codelineno-17-15" name="__codelineno-17-15"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">RetryOnPredicate</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">}),</span>
</span><span id="__span-17-16"><a id="__codelineno-17-16" name="__codelineno-17-16"></a><span class="w">    </span><span class="p">},</span>
</span><span id="__span-17-17"><a id="__codelineno-17-17" name="__codelineno-17-17"></a><span class="w">    </span><span class="nx">MaxElapsedTime</span><span class="p">:</span><span class="w">  </span><span class="mi">5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">,</span><span class="w">        </span><span class="c1">// 总重试预算（可选）</span>
</span><span id="__span-17-18"><a id="__codelineno-17-18" name="__codelineno-17-18"></a><span class="w">    </span><span class="c1">// PerAttemptTimeout: 0,                 // 预留；节点超时由执行器控制</span>
</span><span id="__span-17-19"><a id="__codelineno-17-19" name="__codelineno-17-19"></a><span class="p">}</span>
</span><span id="__span-17-20"><a id="__codelineno-17-20" name="__codelineno-17-20"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;unstable&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">unstableFunc</span><span class="p">,</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithRetryPolicy</span><span class="p">(</span><span class="nx">policy</span><span class="p">))</span>
</span></code></pre></div></td></tr></table></div>
<ul>
<li>执行器默认策略（当节点未配置时生效）：</li>
</ul>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-18-1">1</a></span>
<span class="normal"><a href="#__codelineno-18-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1"></a><span class="nx">exec</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewExecutor</span><span class="p">(</span><span class="nx">compiled</span><span class="p">,</span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithDefaultRetryPolicy</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithSimpleRetry</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span>
</span></code></pre></div></td></tr></table></div>
<p>注意事项
- 中断（interrupt）不参与重试。
- 当设置了步骤超时（<code>WithStepTimeout</code>）时，退避时间会被当前步骤的截止时间钳制。
- 事件会携带重试元数据，便于 CLI/UI 展示进度：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-19-1">1</a></span>
<span class="normal"><a href="#__codelineno-19-2">2</a></span>
<span class="normal"><a href="#__codelineno-19-3">3</a></span>
<span class="normal"><a href="#__codelineno-19-4">4</a></span>
<span class="normal"><a href="#__codelineno-19-5">5</a></span>
<span class="normal"><a href="#__codelineno-19-6">6</a></span>
<span class="normal"><a href="#__codelineno-19-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1"></a><span class="k">if</span><span class="w"> </span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">ev</span><span class="p">.</span><span class="nx">StateDelta</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">MetadataKeyNode</span><span class="p">];</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2"></a><span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">md</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NodeExecutionMetadata</span>
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3"></a><span class="w">    </span><span class="nx">_</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">json</span><span class="p">.</span><span class="nx">Unmarshal</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">md</span><span class="p">)</span>
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">md</span><span class="p">.</span><span class="nx">Phase</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">ExecutionPhaseError</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">md</span><span class="p">.</span><span class="nx">Retrying</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5"></a><span class="w">        </span><span class="c1">// md.Attempt, md.MaxAttempts, md.NextDelay</span>
</span><span id="__span-19-6"><a id="__codelineno-19-6" name="__codelineno-19-6"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-19-7"><a id="__codelineno-19-7" name="__codelineno-19-7"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>示例：<code>examples/graph/retry</code> 展示了一个会先失败后成功的节点，并在成功后进入下游 LLM 输出最终答案。</p>
<h3 id="7-runner">7. Runner 配置</h3>
<p>Runner 提供了会话管理和执行环境：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-20-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-20-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-20-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-20-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-20-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-20-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-20-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-20-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-20-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-20-10">10</a></span>
<span class="normal"><a href="#__codelineno-20-11">11</a></span>
<span class="normal"><a href="#__codelineno-20-12">12</a></span>
<span class="normal"><a href="#__codelineno-20-13">13</a></span>
<span class="normal"><a href="#__codelineno-20-14">14</a></span>
<span class="normal"><a href="#__codelineno-20-15">15</a></span>
<span class="normal"><a href="#__codelineno-20-16">16</a></span>
<span class="normal"><a href="#__codelineno-20-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1"></a><span class="c1">// 创建会话服务</span>
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2"></a><span class="nx">sessionService</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">inmemory</span><span class="p">.</span><span class="nx">NewSessionService</span><span class="p">()</span>
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3"></a><span class="c1">// 或者使用 Redis 会话服务</span>
</span><span id="__span-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4"></a><span class="c1">// sessionService, err := redis.NewService(redis.WithRedisClientURL(&quot;redis://localhost:6379&quot;))</span>
</span><span id="__span-20-5"><a id="__codelineno-20-5" name="__codelineno-20-5"></a>
</span><span id="__span-20-6"><a id="__codelineno-20-6" name="__codelineno-20-6"></a><span class="c1">// 创建 Runner</span>
</span><span id="__span-20-7"><a id="__codelineno-20-7" name="__codelineno-20-7"></a><span class="nx">appRunner</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">runner</span><span class="p">.</span><span class="nx">NewRunner</span><span class="p">(</span>
</span><span id="__span-20-8"><a id="__codelineno-20-8" name="__codelineno-20-8"></a><span class="w">    </span><span class="s">&quot;app-name&quot;</span><span class="p">,</span>
</span><span id="__span-20-9"><a id="__codelineno-20-9" name="__codelineno-20-9"></a><span class="w">    </span><span class="nx">graphAgent</span><span class="p">,</span>
</span><span id="__span-20-10"><a id="__codelineno-20-10" name="__codelineno-20-10"></a><span class="w">    </span><span class="nx">runner</span><span class="p">.</span><span class="nx">WithSessionService</span><span class="p">(</span><span class="nx">sessionService</span><span class="p">),</span>
</span><span id="__span-20-11"><a id="__codelineno-20-11" name="__codelineno-20-11"></a><span class="w">    </span><span class="c1">// 可以添加更多配置选项</span>
</span><span id="__span-20-12"><a id="__codelineno-20-12" name="__codelineno-20-12"></a><span class="p">)</span>
</span><span id="__span-20-13"><a id="__codelineno-20-13" name="__codelineno-20-13"></a>
</span><span id="__span-20-14"><a id="__codelineno-20-14" name="__codelineno-20-14"></a><span class="c1">// 使用 Runner 执行工作流</span>
</span><span id="__span-20-15"><a id="__codelineno-20-15" name="__codelineno-20-15"></a><span class="c1">// Runner 仅设置 StateKeyUserInput，不再预先写入 StateKeyMessages。</span>
</span><span id="__span-20-16"><a id="__codelineno-20-16" name="__codelineno-20-16"></a><span class="nx">message</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">model</span><span class="p">.</span><span class="nx">NewUserMessage</span><span class="p">(</span><span class="s">&quot;用户输入&quot;</span><span class="p">)</span>
</span><span id="__span-20-17"><a id="__codelineno-20-17" name="__codelineno-20-17"></a><span class="nx">eventChan</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">appRunner</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">userID</span><span class="p">,</span><span class="w"> </span><span class="nx">sessionID</span><span class="p">,</span><span class="w"> </span><span class="nx">message</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="8">8. 消息状态模式</h3>
<p>对于对话式应用，可以使用预定义的消息状态模式：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-21-1">1</a></span>
<span class="normal"><a href="#__codelineno-21-2">2</a></span>
<span class="normal"><a href="#__codelineno-21-3">3</a></span>
<span class="normal"><a href="#__codelineno-21-4">4</a></span>
<span class="normal"><a href="#__codelineno-21-5">5</a></span>
<span class="normal"><a href="#__codelineno-21-6">6</a></span>
<span class="normal"><a href="#__codelineno-21-7">7</a></span>
<span class="normal"><a href="#__codelineno-21-8">8</a></span>
<span class="normal"><a href="#__codelineno-21-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1"></a><span class="c1">// 使用消息状态模式</span>
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2"></a><span class="nx">schema</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">MessagesStateSchema</span><span class="p">()</span>
</span><span id="__span-21-3"><a id="__codelineno-21-3" name="__codelineno-21-3"></a>
</span><span id="__span-21-4"><a id="__codelineno-21-4" name="__codelineno-21-4"></a><span class="c1">// 这个模式包含：</span>
</span><span id="__span-21-5"><a id="__codelineno-21-5" name="__codelineno-21-5"></a><span class="c1">// - messages: 对话历史（StateKeyMessages）</span>
</span><span id="__span-21-6"><a id="__codelineno-21-6" name="__codelineno-21-6"></a><span class="c1">// - user_input: 用户输入（StateKeyUserInput）</span>
</span><span id="__span-21-7"><a id="__codelineno-21-7" name="__codelineno-21-7"></a><span class="c1">// - last_response: 最后响应（StateKeyLastResponse）</span>
</span><span id="__span-21-8"><a id="__codelineno-21-8" name="__codelineno-21-8"></a><span class="c1">// - node_responses: 节点响应映射（StateKeyNodeResponses）</span>
</span><span id="__span-21-9"><a id="__codelineno-21-9" name="__codelineno-21-9"></a><span class="c1">// - metadata: 元数据（StateKeyMetadata）</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="9">9. 状态键使用场景</h3>
<p><strong>用户自定义状态键</strong>：用于存储业务逻辑数据</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-22-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-22-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-22-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-22-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-22-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-22-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-22-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-22-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-22-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-22-10">10</a></span>
<span class="normal"><a href="#__codelineno-22-11">11</a></span>
<span class="normal"><a href="#__codelineno-22-12">12</a></span>
<span class="normal"><a href="#__codelineno-22-13">13</a></span>
<span class="normal"><a href="#__codelineno-22-14">14</a></span>
<span class="normal"><a href="#__codelineno-22-15">15</a></span>
<span class="normal"><a href="#__codelineno-22-16">16</a></span>
<span class="normal"><a href="#__codelineno-22-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-22-3"><a id="__codelineno-22-3" name="__codelineno-22-3"></a><span class="p">)</span>
</span><span id="__span-22-4"><a id="__codelineno-22-4" name="__codelineno-22-4"></a>
</span><span id="__span-22-5"><a id="__codelineno-22-5" name="__codelineno-22-5"></a><span class="c1">// 推荐：使用自定义状态键</span>
</span><span id="__span-22-6"><a id="__codelineno-22-6" name="__codelineno-22-6"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-22-7"><a id="__codelineno-22-7" name="__codelineno-22-7"></a><span class="w">    </span><span class="nx">StateKeyDocumentLength</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;document_length&quot;</span>
</span><span id="__span-22-8"><a id="__codelineno-22-8" name="__codelineno-22-8"></a><span class="w">    </span><span class="nx">StateKeyComplexityLevel</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;complexity_level&quot;</span>
</span><span id="__span-22-9"><a id="__codelineno-22-9" name="__codelineno-22-9"></a><span class="w">    </span><span class="nx">StateKeyProcessingStage</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;processing_stage&quot;</span>
</span><span id="__span-22-10"><a id="__codelineno-22-10" name="__codelineno-22-10"></a><span class="p">)</span>
</span><span id="__span-22-11"><a id="__codelineno-22-11" name="__codelineno-22-11"></a>
</span><span id="__span-22-12"><a id="__codelineno-22-12" name="__codelineno-22-12"></a><span class="c1">// 在节点中使用</span>
</span><span id="__span-22-13"><a id="__codelineno-22-13" name="__codelineno-22-13"></a><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span>
</span><span id="__span-22-14"><a id="__codelineno-22-14" name="__codelineno-22-14"></a><span class="w">    </span><span class="nx">StateKeyDocumentLength</span><span class="p">:</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">input</span><span class="p">),</span>
</span><span id="__span-22-15"><a id="__codelineno-22-15" name="__codelineno-22-15"></a><span class="w">    </span><span class="nx">StateKeyComplexityLevel</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;simple&quot;</span><span class="p">,</span>
</span><span id="__span-22-16"><a id="__codelineno-22-16" name="__codelineno-22-16"></a><span class="w">    </span><span class="nx">StateKeyProcessingStage</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;completed&quot;</span><span class="p">,</span>
</span><span id="__span-22-17"><a id="__codelineno-22-17" name="__codelineno-22-17"></a><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span></code></pre></div></td></tr></table></div>
<p><strong>内置状态键</strong>：用于系统集成</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-23-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-23-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-23-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-23-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-23-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-23-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-23-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-23-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-23-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-23-10">10</a></span>
<span class="normal"><a href="#__codelineno-23-11">11</a></span>
<span class="normal"><a href="#__codelineno-23-12">12</a></span>
<span class="normal"><a href="#__codelineno-23-13">13</a></span>
<span class="normal"><a href="#__codelineno-23-14">14</a></span>
<span class="normal"><a href="#__codelineno-23-15">15</a></span>
<span class="normal"><a href="#__codelineno-23-16">16</a></span>
<span class="normal"><a href="#__codelineno-23-17">17</a></span>
<span class="normal"><a href="#__codelineno-23-18">18</a></span>
<span class="normal"><a href="#__codelineno-23-19">19</a></span>
<span class="normal"><a href="#__codelineno-23-20">20</a></span>
<span class="normal"><a href="#__codelineno-23-21">21</a></span>
<span class="normal"><a href="#__codelineno-23-22">22</a></span>
<span class="normal"><a href="#__codelineno-23-23">23</a></span>
<span class="normal"><a href="#__codelineno-23-24">24</a></span>
<span class="normal"><a href="#__codelineno-23-25">25</a></span>
<span class="normal"><a href="#__codelineno-23-26">26</a></span>
<span class="normal"><a href="#__codelineno-23-27">27</a></span>
<span class="normal"><a href="#__codelineno-23-28">28</a></span>
<span class="normal"><a href="#__codelineno-23-29">29</a></span>
<span class="normal"><a href="#__codelineno-23-30">30</a></span>
<span class="normal"><a href="#__codelineno-23-31">31</a></span>
<span class="normal"><a href="#__codelineno-23-32">32</a></span>
<span class="normal"><a href="#__codelineno-23-33">33</a></span>
<span class="normal"><a href="#__codelineno-23-34">34</a></span>
<span class="normal"><a href="#__codelineno-23-35">35</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2"></a><span class="w">    </span><span class="s">&quot;time&quot;</span>
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3"></a>
</span><span id="__span-23-4"><a id="__codelineno-23-4" name="__codelineno-23-4"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-23-5"><a id="__codelineno-23-5" name="__codelineno-23-5"></a><span class="p">)</span>
</span><span id="__span-23-6"><a id="__codelineno-23-6" name="__codelineno-23-6"></a>
</span><span id="__span-23-7"><a id="__codelineno-23-7" name="__codelineno-23-7"></a><span class="c1">// 获取用户输入（由系统自动设置）</span>
</span><span id="__span-23-8"><a id="__codelineno-23-8" name="__codelineno-23-8"></a><span class="nx">userInput</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">state</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyUserInput</span><span class="p">].(</span><span class="kt">string</span><span class="p">)</span>
</span><span id="__span-23-9"><a id="__codelineno-23-9" name="__codelineno-23-9"></a>
</span><span id="__span-23-10"><a id="__codelineno-23-10" name="__codelineno-23-10"></a><span class="c1">// 设置最终输出（系统会读取此值）</span>
</span><span id="__span-23-11"><a id="__codelineno-23-11" name="__codelineno-23-11"></a><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span>
</span><span id="__span-23-12"><a id="__codelineno-23-12" name="__codelineno-23-12"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyLastResponse</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;处理完成&quot;</span><span class="p">,</span>
</span><span id="__span-23-13"><a id="__codelineno-23-13" name="__codelineno-23-13"></a><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-23-14"><a id="__codelineno-23-14" name="__codelineno-23-14"></a>
</span><span id="__span-23-15"><a id="__codelineno-23-15" name="__codelineno-23-15"></a><span class="c1">// 当多个节点（例如并行的 LLM 节点）同时产出结果时，使用按节点响应。</span>
</span><span id="__span-23-16"><a id="__codelineno-23-16" name="__codelineno-23-16"></a><span class="c1">// 该值是 map[nodeID]any，会在执行过程中合并。串行路径使用</span>
</span><span id="__span-23-17"><a id="__codelineno-23-17" name="__codelineno-23-17"></a><span class="c1">// LastResponse；并行节点汇合时使用 NodeResponses。</span>
</span><span id="__span-23-18"><a id="__codelineno-23-18" name="__codelineno-23-18"></a><span class="nx">responses</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">state</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyNodeResponses</span><span class="p">].(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">any</span><span class="p">)</span>
</span><span id="__span-23-19"><a id="__codelineno-23-19" name="__codelineno-23-19"></a><span class="nx">news</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">responses</span><span class="p">[</span><span class="s">&quot;news&quot;</span><span class="p">].(</span><span class="kt">string</span><span class="p">)</span>
</span><span id="__span-23-20"><a id="__codelineno-23-20" name="__codelineno-23-20"></a><span class="nx">dialog</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">responses</span><span class="p">[</span><span class="s">&quot;dialog&quot;</span><span class="p">].(</span><span class="kt">string</span><span class="p">)</span>
</span><span id="__span-23-21"><a id="__codelineno-23-21" name="__codelineno-23-21"></a>
</span><span id="__span-23-22"><a id="__codelineno-23-22" name="__codelineno-23-22"></a><span class="c1">// 分别使用或组合成最终输出。</span>
</span><span id="__span-23-23"><a id="__codelineno-23-23" name="__codelineno-23-23"></a><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span>
</span><span id="__span-23-24"><a id="__codelineno-23-24" name="__codelineno-23-24"></a><span class="w">    </span><span class="s">&quot;news_output&quot;</span><span class="p">:</span><span class="w">   </span><span class="nx">news</span><span class="p">,</span>
</span><span id="__span-23-25"><a id="__codelineno-23-25" name="__codelineno-23-25"></a><span class="w">    </span><span class="s">&quot;dialog_output&quot;</span><span class="p">:</span><span class="w"> </span><span class="nx">dialog</span><span class="p">,</span>
</span><span id="__span-23-26"><a id="__codelineno-23-26" name="__codelineno-23-26"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyLastResponse</span><span class="p">:</span><span class="w"> </span><span class="nx">news</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;\n&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">dialog</span><span class="p">,</span>
</span><span id="__span-23-27"><a id="__codelineno-23-27" name="__codelineno-23-27"></a><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-23-28"><a id="__codelineno-23-28" name="__codelineno-23-28"></a>
</span><span id="__span-23-29"><a id="__codelineno-23-29" name="__codelineno-23-29"></a><span class="c1">// 存储元数据</span>
</span><span id="__span-23-30"><a id="__codelineno-23-30" name="__codelineno-23-30"></a><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span>
</span><span id="__span-23-31"><a id="__codelineno-23-31" name="__codelineno-23-31"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyMetadata</span><span class="p">:</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">any</span><span class="p">{</span>
</span><span id="__span-23-32"><a id="__codelineno-23-32" name="__codelineno-23-32"></a><span class="w">        </span><span class="s">&quot;timestamp&quot;</span><span class="p">:</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">(),</span>
</span><span id="__span-23-33"><a id="__codelineno-23-33" name="__codelineno-23-33"></a><span class="w">        </span><span class="s">&quot;version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1.0&quot;</span><span class="p">,</span>
</span><span id="__span-23-34"><a id="__codelineno-23-34" name="__codelineno-23-34"></a><span class="w">    </span><span class="p">},</span>
</span><span id="__span-23-35"><a id="__codelineno-23-35" name="__codelineno-23-35"></a><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span></code></pre></div></td></tr></table></div>
<h2 id="_10">高级功能</h2>
<h3 id="1">1. 中断和恢复（人机协作）</h3>
<p>Graph 包通过中断和恢复功能支持人机协作 (HITL) 工作流。这使得工作流可以暂停执行，等待人工输入或审批，然后从中断的确切位置恢复。</p>
<h4 id="_11">基本用法</h4>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-24-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-24-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-24-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-24-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-24-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-24-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-24-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-24-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-24-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-24-10">10</a></span>
<span class="normal"><a href="#__codelineno-24-11">11</a></span>
<span class="normal"><a href="#__codelineno-24-12">12</a></span>
<span class="normal"><a href="#__codelineno-24-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2"></a><span class="w">    </span><span class="s">&quot;context&quot;</span>
</span><span id="__span-24-3"><a id="__codelineno-24-3" name="__codelineno-24-3"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-24-4"><a id="__codelineno-24-4" name="__codelineno-24-4"></a><span class="p">)</span>
</span><span id="__span-24-5"><a id="__codelineno-24-5" name="__codelineno-24-5"></a>
</span><span id="__span-24-6"><a id="__codelineno-24-6" name="__codelineno-24-6"></a><span class="c1">// 创建一个可以中断执行等待人工输入的节点</span>
</span><span id="__span-24-7"><a id="__codelineno-24-7" name="__codelineno-24-7"></a><span class="nx">b</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;approval_node&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-24-8"><a id="__codelineno-24-8" name="__codelineno-24-8"></a><span class="w">    </span><span class="c1">// 使用 Interrupt 助手函数进行干净的中断/恢复处理</span>
</span><span id="__span-24-9"><a id="__codelineno-24-9" name="__codelineno-24-9"></a><span class="w">    </span><span class="nx">prompt</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">any</span><span class="p">{</span>
</span><span id="__span-24-10"><a id="__codelineno-24-10" name="__codelineno-24-10"></a><span class="w">        </span><span class="s">&quot;message&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;请审批此操作 (yes/no):&quot;</span><span class="p">,</span>
</span><span id="__span-24-11"><a id="__codelineno-24-11" name="__codelineno-24-11"></a><span class="w">        </span><span class="s">&quot;data&quot;</span><span class="p">:</span><span class="w">    </span><span class="nx">s</span><span class="p">[</span><span class="s">&quot;some_data&quot;</span><span class="p">],</span>
</span><span id="__span-24-12"><a id="__codelineno-24-12" name="__codelineno-24-12"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-24-13"><a id="__codelineno-24-13" name="__codelineno-24-13"></a><span class="p">})</span>
</span></code></pre></div></td></tr></table></div>
<p>用代码把这个图变成可运行的工作流：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-25-1">  1</a></span>
<span class="normal"><a href="#__codelineno-25-2">  2</a></span>
<span class="normal"><a href="#__codelineno-25-3">  3</a></span>
<span class="normal"><a href="#__codelineno-25-4">  4</a></span>
<span class="normal"><a href="#__codelineno-25-5">  5</a></span>
<span class="normal"><a href="#__codelineno-25-6">  6</a></span>
<span class="normal"><a href="#__codelineno-25-7">  7</a></span>
<span class="normal"><a href="#__codelineno-25-8">  8</a></span>
<span class="normal"><a href="#__codelineno-25-9">  9</a></span>
<span class="normal"><a href="#__codelineno-25-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-25-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-25-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-25-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-25-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-25-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-25-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-25-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-25-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-25-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-25-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-25-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-25-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-25-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-25-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-25-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-25-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-25-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-25-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-25-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-25-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-25-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-25-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-25-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-25-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-25-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-25-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-25-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-25-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-25-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-25-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-25-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-25-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-25-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-25-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-25-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-25-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-25-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-25-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-25-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-25-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-25-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-25-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-25-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-25-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-25-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-25-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-25-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-25-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-25-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-25-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-25-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-25-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-25-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-25-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-25-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-25-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-25-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-25-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-25-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-25-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-25-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-25-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-25-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-25-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-25-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-25-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-25-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-25-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-25-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-25-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-25-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-25-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-25-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-25-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-25-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-25-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-25-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-25-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-25-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-25-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-25-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-25-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-25-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-25-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-25-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-25-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-25-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-25-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-25-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-25-100">100</a></span>
<span class="normal"><a href="#__codelineno-25-101">101</a></span>
<span class="normal"><a href="#__codelineno-25-102">102</a></span>
<span class="normal"><a href="#__codelineno-25-103">103</a></span>
<span class="normal"><a href="#__codelineno-25-104">104</a></span>
<span class="normal"><a href="#__codelineno-25-105">105</a></span>
<span class="normal"><a href="#__codelineno-25-106">106</a></span>
<span class="normal"><a href="#__codelineno-25-107">107</a></span>
<span class="normal"><a href="#__codelineno-25-108">108</a></span>
<span class="normal"><a href="#__codelineno-25-109">109</a></span>
<span class="normal"><a href="#__codelineno-25-110">110</a></span>
<span class="normal"><a href="#__codelineno-25-111">111</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1"></a><span class="kn">package</span><span class="w"> </span><span class="nx">main</span>
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2"></a>
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-25-4"><a id="__codelineno-25-4" name="__codelineno-25-4"></a><span class="w">    </span><span class="s">&quot;context&quot;</span>
</span><span id="__span-25-5"><a id="__codelineno-25-5" name="__codelineno-25-5"></a><span class="w">    </span><span class="s">&quot;fmt&quot;</span>
</span><span id="__span-25-6"><a id="__codelineno-25-6" name="__codelineno-25-6"></a><span class="w">    </span><span class="s">&quot;strings&quot;</span>
</span><span id="__span-25-7"><a id="__codelineno-25-7" name="__codelineno-25-7"></a>
</span><span id="__span-25-8"><a id="__codelineno-25-8" name="__codelineno-25-8"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/agent/graphagent&quot;</span>
</span><span id="__span-25-9"><a id="__codelineno-25-9" name="__codelineno-25-9"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-25-10"><a id="__codelineno-25-10" name="__codelineno-25-10"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/model&quot;</span>
</span><span id="__span-25-11"><a id="__codelineno-25-11" name="__codelineno-25-11"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/model/openai&quot;</span>
</span><span id="__span-25-12"><a id="__codelineno-25-12" name="__codelineno-25-12"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/runner&quot;</span>
</span><span id="__span-25-13"><a id="__codelineno-25-13" name="__codelineno-25-13"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/tool&quot;</span>
</span><span id="__span-25-14"><a id="__codelineno-25-14" name="__codelineno-25-14"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/tool/function&quot;</span>
</span><span id="__span-25-15"><a id="__codelineno-25-15" name="__codelineno-25-15"></a><span class="p">)</span>
</span><span id="__span-25-16"><a id="__codelineno-25-16" name="__codelineno-25-16"></a>
</span><span id="__span-25-17"><a id="__codelineno-25-17" name="__codelineno-25-17"></a><span class="c1">// 非导出常量，避免魔法字符串</span>
</span><span id="__span-25-18"><a id="__codelineno-25-18" name="__codelineno-25-18"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-25-19"><a id="__codelineno-25-19" name="__codelineno-25-19"></a><span class="w">    </span><span class="nx">nodePrepare</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;prepare&quot;</span>
</span><span id="__span-25-20"><a id="__codelineno-25-20" name="__codelineno-25-20"></a><span class="w">    </span><span class="nx">nodeAsk</span><span class="w">       </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;ask&quot;</span>
</span><span id="__span-25-21"><a id="__codelineno-25-21" name="__codelineno-25-21"></a><span class="w">    </span><span class="nx">nodeTools</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;tools&quot;</span>
</span><span id="__span-25-22"><a id="__codelineno-25-22" name="__codelineno-25-22"></a><span class="w">    </span><span class="nx">nodeFallback</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;fallback&quot;</span>
</span><span id="__span-25-23"><a id="__codelineno-25-23" name="__codelineno-25-23"></a><span class="w">    </span><span class="nx">nodeFinish</span><span class="w">    </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;finish&quot;</span>
</span><span id="__span-25-24"><a id="__codelineno-25-24" name="__codelineno-25-24"></a>
</span><span id="__span-25-25"><a id="__codelineno-25-25" name="__codelineno-25-25"></a><span class="w">    </span><span class="nx">modelName</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;gpt-4o-mini&quot;</span>
</span><span id="__span-25-26"><a id="__codelineno-25-26" name="__codelineno-25-26"></a><span class="w">    </span><span class="nx">systemPrompt</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;你是一个谨慎的助手。&quot;</span>
</span><span id="__span-25-27"><a id="__codelineno-25-27" name="__codelineno-25-27"></a><span class="w">    </span><span class="nx">outputKeyFinal</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;final_output&quot;</span>
</span><span id="__span-25-28"><a id="__codelineno-25-28" name="__codelineno-25-28"></a>
</span><span id="__span-25-29"><a id="__codelineno-25-29" name="__codelineno-25-29"></a><span class="w">    </span><span class="nx">toolNameCalculator</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;calculator&quot;</span>
</span><span id="__span-25-30"><a id="__codelineno-25-30" name="__codelineno-25-30"></a>
</span><span id="__span-25-31"><a id="__codelineno-25-31" name="__codelineno-25-31"></a><span class="w">    </span><span class="nx">demoUserID</span><span class="w">    </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;user&quot;</span>
</span><span id="__span-25-32"><a id="__codelineno-25-32" name="__codelineno-25-32"></a><span class="w">    </span><span class="nx">demoSessionID</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;session&quot;</span>
</span><span id="__span-25-33"><a id="__codelineno-25-33" name="__codelineno-25-33"></a><span class="w">    </span><span class="nx">demoQuestion</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;6 * 7 等于多少？&quot;</span>
</span><span id="__span-25-34"><a id="__codelineno-25-34" name="__codelineno-25-34"></a><span class="p">)</span>
</span><span id="__span-25-35"><a id="__codelineno-25-35" name="__codelineno-25-35"></a>
</span><span id="__span-25-36"><a id="__codelineno-25-36" name="__codelineno-25-36"></a><span class="kd">func</span><span class="w"> </span><span class="nx">newCalculator</span><span class="p">()</span><span class="w"> </span><span class="nx">tool</span><span class="p">.</span><span class="nx">Tool</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-37"><a id="__codelineno-25-37" name="__codelineno-25-37"></a><span class="w">    </span><span class="kd">type</span><span class="w"> </span><span class="nx">Input</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-38"><a id="__codelineno-25-38" name="__codelineno-25-38"></a><span class="w">        </span><span class="nx">Expression</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="s">`json:&quot;expression&quot;`</span>
</span><span id="__span-25-39"><a id="__codelineno-25-39" name="__codelineno-25-39"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-25-40"><a id="__codelineno-25-40" name="__codelineno-25-40"></a><span class="w">    </span><span class="kd">type</span><span class="w"> </span><span class="nx">Output</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-41"><a id="__codelineno-25-41" name="__codelineno-25-41"></a><span class="w">        </span><span class="nx">Result</span><span class="w"> </span><span class="kt">float64</span><span class="w"> </span><span class="s">`json:&quot;result&quot;`</span>
</span><span id="__span-25-42"><a id="__codelineno-25-42" name="__codelineno-25-42"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-25-43"><a id="__codelineno-25-43" name="__codelineno-25-43"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">function</span><span class="p">.</span><span class="nx">NewFunctionTool</span><span class="p">[</span><span class="nx">Input</span><span class="p">,</span><span class="w"> </span><span class="nx">Output</span><span class="p">](</span>
</span><span id="__span-25-44"><a id="__codelineno-25-44" name="__codelineno-25-44"></a><span class="w">        </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">in</span><span class="w"> </span><span class="nx">Input</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nx">Output</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-45"><a id="__codelineno-25-45" name="__codelineno-25-45"></a><span class="w">            </span><span class="c1">// 在此实现真实计算逻辑</span>
</span><span id="__span-25-46"><a id="__codelineno-25-46" name="__codelineno-25-46"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">Output</span><span class="p">{</span><span class="nx">Result</span><span class="p">:</span><span class="w"> </span><span class="mi">42</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-25-47"><a id="__codelineno-25-47" name="__codelineno-25-47"></a><span class="w">        </span><span class="p">},</span>
</span><span id="__span-25-48"><a id="__codelineno-25-48" name="__codelineno-25-48"></a><span class="w">        </span><span class="nx">function</span><span class="p">.</span><span class="nx">WithName</span><span class="p">(</span><span class="nx">toolNameCalculator</span><span class="p">),</span>
</span><span id="__span-25-49"><a id="__codelineno-25-49" name="__codelineno-25-49"></a><span class="w">        </span><span class="nx">function</span><span class="p">.</span><span class="nx">WithDescription</span><span class="p">(</span><span class="s">&quot;计算数学表达式&quot;</span><span class="p">),</span>
</span><span id="__span-25-50"><a id="__codelineno-25-50" name="__codelineno-25-50"></a><span class="w">    </span><span class="p">)</span>
</span><span id="__span-25-51"><a id="__codelineno-25-51" name="__codelineno-25-51"></a><span class="p">}</span>
</span><span id="__span-25-52"><a id="__codelineno-25-52" name="__codelineno-25-52"></a>
</span><span id="__span-25-53"><a id="__codelineno-25-53" name="__codelineno-25-53"></a><span class="kd">func</span><span class="w"> </span><span class="nx">buildWorkflow</span><span class="p">(</span><span class="nx">m</span><span class="w"> </span><span class="nx">model</span><span class="p">.</span><span class="nx">Model</span><span class="p">,</span><span class="w"> </span><span class="nx">tools</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">tool</span><span class="p">.</span><span class="nx">Tool</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">graph</span><span class="p">.</span><span class="nx">Graph</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-54"><a id="__codelineno-25-54" name="__codelineno-25-54"></a><span class="w">    </span><span class="nx">sg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateGraph</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">MessagesStateSchema</span><span class="p">())</span>
</span><span id="__span-25-55"><a id="__codelineno-25-55" name="__codelineno-25-55"></a>
</span><span id="__span-25-56"><a id="__codelineno-25-56" name="__codelineno-25-56"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="nx">nodePrepare</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-57"><a id="__codelineno-25-57" name="__codelineno-25-57"></a><span class="w">        </span><span class="nx">raw</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprint</span><span class="p">(</span><span class="nx">s</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyUserInput</span><span class="p">])</span>
</span><span id="__span-25-58"><a id="__codelineno-25-58" name="__codelineno-25-58"></a><span class="w">        </span><span class="nx">cleaned</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">strings</span><span class="p">.</span><span class="nx">TrimSpace</span><span class="p">(</span><span class="nx">raw</span><span class="p">)</span>
</span><span id="__span-25-59"><a id="__codelineno-25-59" name="__codelineno-25-59"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyUserInput</span><span class="p">:</span><span class="w"> </span><span class="nx">cleaned</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-25-60"><a id="__codelineno-25-60" name="__codelineno-25-60"></a><span class="w">    </span><span class="p">})</span>
</span><span id="__span-25-61"><a id="__codelineno-25-61" name="__codelineno-25-61"></a>
</span><span id="__span-25-62"><a id="__codelineno-25-62" name="__codelineno-25-62"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddLLMNode</span><span class="p">(</span><span class="nx">nodeAsk</span><span class="p">,</span><span class="w"> </span><span class="nx">m</span><span class="p">,</span><span class="w"> </span><span class="nx">systemPrompt</span><span class="p">,</span><span class="w"> </span><span class="nx">tools</span><span class="p">)</span>
</span><span id="__span-25-63"><a id="__codelineno-25-63" name="__codelineno-25-63"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddToolsNode</span><span class="p">(</span><span class="nx">nodeTools</span><span class="p">,</span><span class="w"> </span><span class="nx">tools</span><span class="p">)</span>
</span><span id="__span-25-64"><a id="__codelineno-25-64" name="__codelineno-25-64"></a>
</span><span id="__span-25-65"><a id="__codelineno-25-65" name="__codelineno-25-65"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="nx">nodeFallback</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-66"><a id="__codelineno-25-66" name="__codelineno-25-66"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyLastResponse</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;无需工具，直接回答&quot;</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-25-67"><a id="__codelineno-25-67" name="__codelineno-25-67"></a><span class="w">    </span><span class="p">})</span>
</span><span id="__span-25-68"><a id="__codelineno-25-68" name="__codelineno-25-68"></a>
</span><span id="__span-25-69"><a id="__codelineno-25-69" name="__codelineno-25-69"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="nx">nodeFinish</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-70"><a id="__codelineno-25-70" name="__codelineno-25-70"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="nx">outputKeyFinal</span><span class="p">:</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprint</span><span class="p">(</span><span class="nx">s</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyLastResponse</span><span class="p">])},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-25-71"><a id="__codelineno-25-71" name="__codelineno-25-71"></a><span class="w">    </span><span class="p">})</span>
</span><span id="__span-25-72"><a id="__codelineno-25-72" name="__codelineno-25-72"></a>
</span><span id="__span-25-73"><a id="__codelineno-25-73" name="__codelineno-25-73"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">SetEntryPoint</span><span class="p">(</span><span class="nx">nodePrepare</span><span class="p">)</span>
</span><span id="__span-25-74"><a id="__codelineno-25-74" name="__codelineno-25-74"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddEdge</span><span class="p">(</span><span class="nx">nodePrepare</span><span class="p">,</span><span class="w"> </span><span class="nx">nodeAsk</span><span class="p">)</span>
</span><span id="__span-25-75"><a id="__codelineno-25-75" name="__codelineno-25-75"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddToolsConditionalEdges</span><span class="p">(</span><span class="nx">nodeAsk</span><span class="p">,</span><span class="w"> </span><span class="nx">nodeTools</span><span class="p">,</span><span class="w"> </span><span class="nx">nodeFallback</span><span class="p">)</span>
</span><span id="__span-25-76"><a id="__codelineno-25-76" name="__codelineno-25-76"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddEdge</span><span class="p">(</span><span class="nx">nodeTools</span><span class="p">,</span><span class="w"> </span><span class="nx">nodeAsk</span><span class="p">)</span>
</span><span id="__span-25-77"><a id="__codelineno-25-77" name="__codelineno-25-77"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddEdge</span><span class="p">(</span><span class="nx">nodeFallback</span><span class="p">,</span><span class="w"> </span><span class="nx">nodeFinish</span><span class="p">)</span>
</span><span id="__span-25-78"><a id="__codelineno-25-78" name="__codelineno-25-78"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">SetFinishPoint</span><span class="p">(</span><span class="nx">nodeFinish</span><span class="p">)</span>
</span><span id="__span-25-79"><a id="__codelineno-25-79" name="__codelineno-25-79"></a>
</span><span id="__span-25-80"><a id="__codelineno-25-80" name="__codelineno-25-80"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">sg</span><span class="p">.</span><span class="nx">Compile</span><span class="p">()</span>
</span><span id="__span-25-81"><a id="__codelineno-25-81" name="__codelineno-25-81"></a><span class="p">}</span>
</span><span id="__span-25-82"><a id="__codelineno-25-82" name="__codelineno-25-82"></a>
</span><span id="__span-25-83"><a id="__codelineno-25-83" name="__codelineno-25-83"></a><span class="kd">func</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-84"><a id="__codelineno-25-84" name="__codelineno-25-84"></a><span class="w">    </span><span class="nx">mdl</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">openai</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="nx">modelName</span><span class="p">)</span>
</span><span id="__span-25-85"><a id="__codelineno-25-85" name="__codelineno-25-85"></a><span class="w">    </span><span class="nx">tools</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">tool</span><span class="p">.</span><span class="nx">Tool</span><span class="p">{</span><span class="nx">toolNameCalculator</span><span class="p">:</span><span class="w"> </span><span class="nx">newCalculator</span><span class="p">()}</span>
</span><span id="__span-25-86"><a id="__codelineno-25-86" name="__codelineno-25-86"></a>
</span><span id="__span-25-87"><a id="__codelineno-25-87" name="__codelineno-25-87"></a><span class="w">    </span><span class="nx">g</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">buildWorkflow</span><span class="p">(</span><span class="nx">mdl</span><span class="p">,</span><span class="w"> </span><span class="nx">tools</span><span class="p">)</span>
</span><span id="__span-25-88"><a id="__codelineno-25-88" name="__codelineno-25-88"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-89"><a id="__codelineno-25-89" name="__codelineno-25-89"></a><span class="w">        </span><span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span id="__span-25-90"><a id="__codelineno-25-90" name="__codelineno-25-90"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-25-91"><a id="__codelineno-25-91" name="__codelineno-25-91"></a>
</span><span id="__span-25-92"><a id="__codelineno-25-92" name="__codelineno-25-92"></a><span class="w">    </span><span class="c1">// 使用 GraphAgent + Runner 运行</span>
</span><span id="__span-25-93"><a id="__codelineno-25-93" name="__codelineno-25-93"></a><span class="w">    </span><span class="nx">ga</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;demo&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">g</span><span class="p">)</span>
</span><span id="__span-25-94"><a id="__codelineno-25-94" name="__codelineno-25-94"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-95"><a id="__codelineno-25-95" name="__codelineno-25-95"></a><span class="w">        </span><span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span id="__span-25-96"><a id="__codelineno-25-96" name="__codelineno-25-96"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-25-97"><a id="__codelineno-25-97" name="__codelineno-25-97"></a><span class="w">    </span><span class="nx">app</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">runner</span><span class="p">.</span><span class="nx">NewRunner</span><span class="p">(</span><span class="s">&quot;app&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">ga</span><span class="p">)</span>
</span><span id="__span-25-98"><a id="__codelineno-25-98" name="__codelineno-25-98"></a><span class="w">    </span><span class="nx">events</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">app</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Background</span><span class="p">(),</span><span class="w"> </span><span class="nx">demoUserID</span><span class="p">,</span><span class="w"> </span><span class="nx">demoSessionID</span><span class="p">,</span>
</span><span id="__span-25-99"><a id="__codelineno-25-99" name="__codelineno-25-99"></a><span class="w">        </span><span class="nx">model</span><span class="p">.</span><span class="nx">NewUserMessage</span><span class="p">(</span><span class="nx">demoQuestion</span><span class="p">))</span>
</span><span id="__span-25-100"><a id="__codelineno-25-100" name="__codelineno-25-100"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-101"><a id="__codelineno-25-101" name="__codelineno-25-101"></a><span class="w">        </span><span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span><span id="__span-25-102"><a id="__codelineno-25-102" name="__codelineno-25-102"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-25-103"><a id="__codelineno-25-103" name="__codelineno-25-103"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">ev</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">events</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-104"><a id="__codelineno-25-104" name="__codelineno-25-104"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">ev</span><span class="p">.</span><span class="nx">Response</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-105"><a id="__codelineno-25-105" name="__codelineno-25-105"></a><span class="w">            </span><span class="k">continue</span>
</span><span id="__span-25-106"><a id="__codelineno-25-106" name="__codelineno-25-106"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-25-107"><a id="__codelineno-25-107" name="__codelineno-25-107"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">ev</span><span class="p">.</span><span class="nx">Author</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">nodeAsk</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">!</span><span class="nx">ev</span><span class="p">.</span><span class="nx">Response</span><span class="p">.</span><span class="nx">IsPartial</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">ev</span><span class="p">.</span><span class="nx">Response</span><span class="p">.</span><span class="nx">Choices</span><span class="p">)</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-108"><a id="__codelineno-25-108" name="__codelineno-25-108"></a><span class="w">            </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;LLM:&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">ev</span><span class="p">.</span><span class="nx">Response</span><span class="p">.</span><span class="nx">Choices</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">Message</span><span class="p">.</span><span class="nx">Content</span><span class="p">)</span>
</span><span id="__span-25-109"><a id="__codelineno-25-109" name="__codelineno-25-109"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-25-110"><a id="__codelineno-25-110" name="__codelineno-25-110"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-25-111"><a id="__codelineno-25-111" name="__codelineno-25-111"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>上面的例子展示了如何声明节点、连边并运行。接下来先介绍执行方式与会话管理，然后进入核心概念与常见用法。</p>
<h3 id="_12">执行方式</h3>
<ul>
<li>用 <code>graphagent.New</code> 包装成通用 <code>agent.Agent</code>，交给 <code>runner.Runner</code> 管理会话与事件流。</li>
</ul>
<p>最小 GraphAgent + Runner 例子：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-26-1">1</a></span>
<span class="normal"><a href="#__codelineno-26-2">2</a></span>
<span class="normal"><a href="#__codelineno-26-3">3</a></span>
<span class="normal"><a href="#__codelineno-26-4">4</a></span>
<span class="normal"><a href="#__codelineno-26-5">5</a></span>
<span class="normal"><a href="#__codelineno-26-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1"></a><span class="nx">compiled</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">buildWorkflow</span><span class="p">(</span><span class="nx">openai</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;gpt-4o-mini&quot;</span><span class="p">),</span><span class="w"> </span><span class="kc">nil</span><span class="p">)</span>
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2"></a><span class="nx">ga</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;demo&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">compiled</span><span class="p">)</span>
</span><span id="__span-26-3"><a id="__codelineno-26-3" name="__codelineno-26-3"></a><span class="nx">app</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">runner</span><span class="p">.</span><span class="nx">NewRunner</span><span class="p">(</span><span class="s">&quot;app&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">ga</span><span class="p">)</span>
</span><span id="__span-26-4"><a id="__codelineno-26-4" name="__codelineno-26-4"></a>
</span><span id="__span-26-5"><a id="__codelineno-26-5" name="__codelineno-26-5"></a><span class="nx">events</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">app</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;user&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;session&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">model</span><span class="p">.</span><span class="nx">NewUserMessage</span><span class="p">(</span><span class="s">&quot;hi&quot;</span><span class="p">))</span>
</span><span id="__span-26-6"><a id="__codelineno-26-6" name="__codelineno-26-6"></a><span class="k">for</span><span class="w"> </span><span class="nx">ev</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">events</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* 处理事件 */</span><span class="w"> </span><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>Runner 会话后端可选项：
- 内存：<code>session/inmemory</code>（默认示例使用）
- Redis：<code>session/redis</code>（生产更常用）</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-27-1">1</a></span>
<span class="normal"><a href="#__codelineno-27-2">2</a></span>
<span class="normal"><a href="#__codelineno-27-3">3</a></span>
<span class="normal"><a href="#__codelineno-27-4">4</a></span>
<span class="normal"><a href="#__codelineno-27-5">5</a></span>
<span class="normal"><a href="#__codelineno-27-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/session/redis&quot;</span>
</span><span id="__span-27-3"><a id="__codelineno-27-3" name="__codelineno-27-3"></a><span class="p">)</span>
</span><span id="__span-27-4"><a id="__codelineno-27-4" name="__codelineno-27-4"></a>
</span><span id="__span-27-5"><a id="__codelineno-27-5" name="__codelineno-27-5"></a><span class="nx">sess</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">redis</span><span class="p">.</span><span class="nx">NewService</span><span class="p">(</span><span class="nx">redis</span><span class="p">.</span><span class="nx">WithRedisClientURL</span><span class="p">(</span><span class="s">&quot;redis://localhost:6379&quot;</span><span class="p">))</span>
</span><span id="__span-27-6"><a id="__codelineno-27-6" name="__codelineno-27-6"></a><span class="nx">app</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">runner</span><span class="p">.</span><span class="nx">NewRunner</span><span class="p">(</span><span class="s">&quot;app&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">ga</span><span class="p">,</span><span class="w"> </span><span class="nx">runner</span><span class="p">.</span><span class="nx">WithSessionService</span><span class="p">(</span><span class="nx">sess</span><span class="p">))</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="graphagent">GraphAgent 配置选项</h3>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-28-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-28-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-28-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-28-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-28-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-28-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-28-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-28-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-28-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-28-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1"></a><span class="nx">ga</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span>
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2"></a><span class="w">    </span><span class="s">&quot;workflow&quot;</span><span class="p">,</span>
</span><span id="__span-28-3"><a id="__codelineno-28-3" name="__codelineno-28-3"></a><span class="w">    </span><span class="nx">compiledGraph</span><span class="p">,</span>
</span><span id="__span-28-4"><a id="__codelineno-28-4" name="__codelineno-28-4"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithDescription</span><span class="p">(</span><span class="s">&quot;工作流描述&quot;</span><span class="p">),</span>
</span><span id="__span-28-5"><a id="__codelineno-28-5" name="__codelineno-28-5"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithInitialState</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="s">&quot;init&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">}),</span>
</span><span id="__span-28-6"><a id="__codelineno-28-6" name="__codelineno-28-6"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithChannelBufferSize</span><span class="p">(</span><span class="mi">512</span><span class="p">),</span>
</span><span id="__span-28-7"><a id="__codelineno-28-7" name="__codelineno-28-7"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithCheckpointSaver</span><span class="p">(</span><span class="nx">saver</span><span class="p">),</span>
</span><span id="__span-28-8"><a id="__codelineno-28-8" name="__codelineno-28-8"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithSubAgents</span><span class="p">([]</span><span class="nx">agent</span><span class="p">.</span><span class="nx">Agent</span><span class="p">{</span><span class="nx">subAgent</span><span class="p">}),</span>
</span><span id="__span-28-9"><a id="__codelineno-28-9" name="__codelineno-28-9"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithAgentCallbacks</span><span class="p">(</span><span class="nx">agent</span><span class="p">.</span><span class="nx">NewCallbacks</span><span class="p">()),</span>
</span><span id="__span-28-10"><a id="__codelineno-28-10" name="__codelineno-28-10"></a><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<h2 id="_13">核心概念</h2>
<h3 id="_14">状态管理</h3>
<p>GraphAgent 采用 Schema + Reducer 模式管理状态。先明确状态结构与合并规则，后续节点输入/输出的 key 就有了清晰来源与生命周期约定。</p>
<h4 id="schema">使用内置 Schema</h4>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-29-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-29-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-29-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-29-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-29-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-29-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-29-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-29-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-29-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-29-10">10</a></span>
<span class="normal"><a href="#__codelineno-29-11">11</a></span>
<span class="normal"><a href="#__codelineno-29-12">12</a></span>
<span class="normal"><a href="#__codelineno-29-13">13</a></span>
<span class="normal"><a href="#__codelineno-29-14">14</a></span>
<span class="normal"><a href="#__codelineno-29-15">15</a></span>
<span class="normal"><a href="#__codelineno-29-16">16</a></span>
<span class="normal"><a href="#__codelineno-29-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-29-2"><a id="__codelineno-29-2" name="__codelineno-29-2"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-29-3"><a id="__codelineno-29-3" name="__codelineno-29-3"></a><span class="p">)</span>
</span><span id="__span-29-4"><a id="__codelineno-29-4" name="__codelineno-29-4"></a>
</span><span id="__span-29-5"><a id="__codelineno-29-5" name="__codelineno-29-5"></a><span class="nx">schema</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">MessagesStateSchema</span><span class="p">()</span>
</span><span id="__span-29-6"><a id="__codelineno-29-6" name="__codelineno-29-6"></a>
</span><span id="__span-29-7"><a id="__codelineno-29-7" name="__codelineno-29-7"></a><span class="c1">// 预定义字段（键名常量）与语义：</span>
</span><span id="__span-29-8"><a id="__codelineno-29-8" name="__codelineno-29-8"></a><span class="c1">// - graph.StateKeyMessages       (&quot;messages&quot;)        对话历史（[]model.Message；MessageReducer + MessageOp 原子合并）</span>
</span><span id="__span-29-9"><a id="__codelineno-29-9" name="__codelineno-29-9"></a><span class="c1">// - graph.StateKeyUserInput      (&quot;user_input&quot;)      用户输入（string；一次性，成功执行后清空）</span>
</span><span id="__span-29-10"><a id="__codelineno-29-10" name="__codelineno-29-10"></a><span class="c1">// - graph.StateKeyLastResponse   (&quot;last_response&quot;)   最后响应（string）</span>
</span><span id="__span-29-11"><a id="__codelineno-29-11" name="__codelineno-29-11"></a><span class="c1">// - graph.StateKeyNodeResponses  (&quot;node_responses&quot;)  各节点输出（map[string]any；并行汇总读取）</span>
</span><span id="__span-29-12"><a id="__codelineno-29-12" name="__codelineno-29-12"></a><span class="c1">// - graph.StateKeyMetadata       (&quot;metadata&quot;)        元数据（map[string]any；MergeReducer 合并）</span>
</span><span id="__span-29-13"><a id="__codelineno-29-13" name="__codelineno-29-13"></a>
</span><span id="__span-29-14"><a id="__codelineno-29-14" name="__codelineno-29-14"></a><span class="c1">// 其他一次性/系统键（按需使用）：</span>
</span><span id="__span-29-15"><a id="__codelineno-29-15" name="__codelineno-29-15"></a><span class="c1">// - graph.StateKeyOneShotMessages (&quot;one_shot_messages&quot;)  一次性覆盖本轮输入（[]model.Message）</span>
</span><span id="__span-29-16"><a id="__codelineno-29-16" name="__codelineno-29-16"></a><span class="c1">// - graph.StateKeySession         (&quot;session&quot;)            会话对象（系统使用）</span>
</span><span id="__span-29-17"><a id="__codelineno-29-17" name="__codelineno-29-17"></a><span class="c1">// - graph.StateKeyExecContext     (&quot;exec_context&quot;)       执行上下文（事件流等，系统使用）</span>
</span></code></pre></div></td></tr></table></div>
<h4 id="schema_1">自定义 Schema</h4>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-30-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-30-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-30-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-30-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-30-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-30-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-30-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-30-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-30-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-30-10">10</a></span>
<span class="normal"><a href="#__codelineno-30-11">11</a></span>
<span class="normal"><a href="#__codelineno-30-12">12</a></span>
<span class="normal"><a href="#__codelineno-30-13">13</a></span>
<span class="normal"><a href="#__codelineno-30-14">14</a></span>
<span class="normal"><a href="#__codelineno-30-15">15</a></span>
<span class="normal"><a href="#__codelineno-30-16">16</a></span>
<span class="normal"><a href="#__codelineno-30-17">17</a></span>
<span class="normal"><a href="#__codelineno-30-18">18</a></span>
<span class="normal"><a href="#__codelineno-30-19">19</a></span>
<span class="normal"><a href="#__codelineno-30-20">20</a></span>
<span class="normal"><a href="#__codelineno-30-21">21</a></span>
<span class="normal"><a href="#__codelineno-30-22">22</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-30-2"><a id="__codelineno-30-2" name="__codelineno-30-2"></a><span class="w">    </span><span class="s">&quot;reflect&quot;</span>
</span><span id="__span-30-3"><a id="__codelineno-30-3" name="__codelineno-30-3"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-30-4"><a id="__codelineno-30-4" name="__codelineno-30-4"></a><span class="p">)</span>
</span><span id="__span-30-5"><a id="__codelineno-30-5" name="__codelineno-30-5"></a>
</span><span id="__span-30-6"><a id="__codelineno-30-6" name="__codelineno-30-6"></a><span class="nx">schema</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateSchema</span><span class="p">()</span>
</span><span id="__span-30-7"><a id="__codelineno-30-7" name="__codelineno-30-7"></a>
</span><span id="__span-30-8"><a id="__codelineno-30-8" name="__codelineno-30-8"></a><span class="c1">// 添加自定义字段</span>
</span><span id="__span-30-9"><a id="__codelineno-30-9" name="__codelineno-30-9"></a><span class="nx">schema</span><span class="p">.</span><span class="nx">AddField</span><span class="p">(</span><span class="s">&quot;counter&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateField</span><span class="p">{</span>
</span><span id="__span-30-10"><a id="__codelineno-30-10" name="__codelineno-30-10"></a><span class="w">    </span><span class="nx">Type</span><span class="p">:</span><span class="w">    </span><span class="nx">reflect</span><span class="p">.</span><span class="nx">TypeOf</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span><span id="__span-30-11"><a id="__codelineno-30-11" name="__codelineno-30-11"></a><span class="w">    </span><span class="nx">Default</span><span class="p">:</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="kt">any</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">},</span>
</span><span id="__span-30-12"><a id="__codelineno-30-12" name="__codelineno-30-12"></a><span class="w">    </span><span class="nx">Reducer</span><span class="p">:</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">old</span><span class="p">,</span><span class="w"> </span><span class="nx">new</span><span class="w"> </span><span class="kt">any</span><span class="p">)</span><span class="w"> </span><span class="kt">any</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-30-13"><a id="__codelineno-30-13" name="__codelineno-30-13"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">old</span><span class="p">.(</span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">new</span><span class="p">.(</span><span class="kt">int</span><span class="p">)</span><span class="w">  </span><span class="c1">// 累加</span>
</span><span id="__span-30-14"><a id="__codelineno-30-14" name="__codelineno-30-14"></a><span class="w">    </span><span class="p">},</span>
</span><span id="__span-30-15"><a id="__codelineno-30-15" name="__codelineno-30-15"></a><span class="p">})</span>
</span><span id="__span-30-16"><a id="__codelineno-30-16" name="__codelineno-30-16"></a>
</span><span id="__span-30-17"><a id="__codelineno-30-17" name="__codelineno-30-17"></a><span class="c1">// 字符串列表使用内置 Reducer</span>
</span><span id="__span-30-18"><a id="__codelineno-30-18" name="__codelineno-30-18"></a><span class="nx">schema</span><span class="p">.</span><span class="nx">AddField</span><span class="p">(</span><span class="s">&quot;items&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateField</span><span class="p">{</span>
</span><span id="__span-30-19"><a id="__codelineno-30-19" name="__codelineno-30-19"></a><span class="w">    </span><span class="nx">Type</span><span class="p">:</span><span class="w">    </span><span class="nx">reflect</span><span class="p">.</span><span class="nx">TypeOf</span><span class="p">([]</span><span class="kt">string</span><span class="p">{}),</span>
</span><span id="__span-30-20"><a id="__codelineno-30-20" name="__codelineno-30-20"></a><span class="w">    </span><span class="nx">Default</span><span class="p">:</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="kt">any</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="p">[]</span><span class="kt">string</span><span class="p">{}</span><span class="w"> </span><span class="p">},</span>
</span><span id="__span-30-21"><a id="__codelineno-30-21" name="__codelineno-30-21"></a><span class="w">    </span><span class="nx">Reducer</span><span class="p">:</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">StringSliceReducer</span><span class="p">,</span>
</span><span id="__span-30-22"><a id="__codelineno-30-22" name="__codelineno-30-22"></a><span class="p">})</span>
</span></code></pre></div></td></tr></table></div>
<p>Reducer 机制确保状态字段按预定义规则安全合并，这在并发执行时尤其重要。</p>
<p>提示：建议为业务键定义常量，避免散落魔法字符串。</p>
<h3 id="_15">节点类型</h3>
<p>GraphAgent 提供了四种内置节点类型：</p>
<h4 id="function">Function 节点</h4>
<p>最基础的节点，执行自定义逻辑：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-31-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-31-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-31-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-31-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-31-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-31-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-31-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-31-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-31-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-31-10">10</a></span>
<span class="normal"><a href="#__codelineno-31-11">11</a></span>
<span class="normal"><a href="#__codelineno-31-12">12</a></span>
<span class="normal"><a href="#__codelineno-31-13">13</a></span>
<span class="normal"><a href="#__codelineno-31-14">14</a></span>
<span class="normal"><a href="#__codelineno-31-15">15</a></span>
<span class="normal"><a href="#__codelineno-31-16">16</a></span>
<span class="normal"><a href="#__codelineno-31-17">17</a></span>
<span class="normal"><a href="#__codelineno-31-18">18</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-31-2"><a id="__codelineno-31-2" name="__codelineno-31-2"></a><span class="w">    </span><span class="s">&quot;context&quot;</span>
</span><span id="__span-31-3"><a id="__codelineno-31-3" name="__codelineno-31-3"></a>
</span><span id="__span-31-4"><a id="__codelineno-31-4" name="__codelineno-31-4"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-31-5"><a id="__codelineno-31-5" name="__codelineno-31-5"></a><span class="p">)</span>
</span><span id="__span-31-6"><a id="__codelineno-31-6" name="__codelineno-31-6"></a>
</span><span id="__span-31-7"><a id="__codelineno-31-7" name="__codelineno-31-7"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-31-8"><a id="__codelineno-31-8" name="__codelineno-31-8"></a><span class="w">    </span><span class="nx">stateKeyInput</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;input&quot;</span>
</span><span id="__span-31-9"><a id="__codelineno-31-9" name="__codelineno-31-9"></a><span class="w">    </span><span class="nx">stateKeyOutput</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;output&quot;</span>
</span><span id="__span-31-10"><a id="__codelineno-31-10" name="__codelineno-31-10"></a><span class="w">    </span><span class="nx">nodeProcess</span><span class="w">    </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;process&quot;</span>
</span><span id="__span-31-11"><a id="__codelineno-31-11" name="__codelineno-31-11"></a><span class="p">)</span>
</span><span id="__span-31-12"><a id="__codelineno-31-12" name="__codelineno-31-12"></a>
</span><span id="__span-31-13"><a id="__codelineno-31-13" name="__codelineno-31-13"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="nx">nodeProcess</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-31-14"><a id="__codelineno-31-14" name="__codelineno-31-14"></a><span class="w">    </span><span class="nx">data</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">state</span><span class="p">[</span><span class="nx">stateKeyInput</span><span class="p">].(</span><span class="kt">string</span><span class="p">)</span>
</span><span id="__span-31-15"><a id="__codelineno-31-15" name="__codelineno-31-15"></a><span class="w">    </span><span class="nx">processed</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">transform</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
</span><span id="__span-31-16"><a id="__codelineno-31-16" name="__codelineno-31-16"></a><span class="w">    </span><span class="c1">// Function 节点需显式指定输出 key</span>
</span><span id="__span-31-17"><a id="__codelineno-31-17" name="__codelineno-31-17"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="nx">stateKeyOutput</span><span class="p">:</span><span class="w"> </span><span class="nx">processed</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-31-18"><a id="__codelineno-31-18" name="__codelineno-31-18"></a><span class="p">})</span>
</span></code></pre></div></td></tr></table></div>
<h4 id="llm_1">LLM 节点</h4>
<p>集成语言模型，自动管理对话历史：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-32-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-32-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-32-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-32-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-32-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-32-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-32-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-32-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-32-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-32-10">10</a></span>
<span class="normal"><a href="#__codelineno-32-11">11</a></span>
<span class="normal"><a href="#__codelineno-32-12">12</a></span>
<span class="normal"><a href="#__codelineno-32-13">13</a></span>
<span class="normal"><a href="#__codelineno-32-14">14</a></span>
<span class="normal"><a href="#__codelineno-32-15">15</a></span>
<span class="normal"><a href="#__codelineno-32-16">16</a></span>
<span class="normal"><a href="#__codelineno-32-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-32-2"><a id="__codelineno-32-2" name="__codelineno-32-2"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-32-3"><a id="__codelineno-32-3" name="__codelineno-32-3"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/model/openai&quot;</span>
</span><span id="__span-32-4"><a id="__codelineno-32-4" name="__codelineno-32-4"></a><span class="p">)</span>
</span><span id="__span-32-5"><a id="__codelineno-32-5" name="__codelineno-32-5"></a>
</span><span id="__span-32-6"><a id="__codelineno-32-6" name="__codelineno-32-6"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-32-7"><a id="__codelineno-32-7" name="__codelineno-32-7"></a><span class="w">    </span><span class="nx">llmModelName</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;gpt-4o-mini&quot;</span>
</span><span id="__span-32-8"><a id="__codelineno-32-8" name="__codelineno-32-8"></a><span class="w">    </span><span class="nx">llmSystemPrompt</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;系统提示词&quot;</span>
</span><span id="__span-32-9"><a id="__codelineno-32-9" name="__codelineno-32-9"></a><span class="w">    </span><span class="nx">llmNodeAssistant</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;assistant&quot;</span>
</span><span id="__span-32-10"><a id="__codelineno-32-10" name="__codelineno-32-10"></a><span class="p">)</span>
</span><span id="__span-32-11"><a id="__codelineno-32-11" name="__codelineno-32-11"></a>
</span><span id="__span-32-12"><a id="__codelineno-32-12" name="__codelineno-32-12"></a><span class="nx">model</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">openai</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="nx">llmModelName</span><span class="p">)</span>
</span><span id="__span-32-13"><a id="__codelineno-32-13" name="__codelineno-32-13"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddLLMNode</span><span class="p">(</span><span class="nx">llmNodeAssistant</span><span class="p">,</span><span class="w"> </span><span class="nx">model</span><span class="p">,</span><span class="w"> </span><span class="nx">llmSystemPrompt</span><span class="p">,</span><span class="w"> </span><span class="nx">tools</span><span class="p">)</span>
</span><span id="__span-32-14"><a id="__codelineno-32-14" name="__codelineno-32-14"></a>
</span><span id="__span-32-15"><a id="__codelineno-32-15" name="__codelineno-32-15"></a><span class="c1">// LLM 节点的输入输出规则：</span>
</span><span id="__span-32-16"><a id="__codelineno-32-16" name="__codelineno-32-16"></a><span class="c1">// 输入优先级: graph.StateKeyOneShotMessages &gt; graph.StateKeyUserInput &gt; graph.StateKeyMessages</span>
</span><span id="__span-32-17"><a id="__codelineno-32-17" name="__codelineno-32-17"></a><span class="c1">// 输出: graph.StateKeyLastResponse、graph.StateKeyMessages(原子更新)、graph.StateKeyNodeResponses（包含当前节点输出，便于并行汇总）</span>
</span></code></pre></div></td></tr></table></div>
<h2 id="cache">节点缓存（Cache）</h2>
<p>为“纯函数型”节点开启缓存可以显著减少重复计算开销。Graph 支持图级与节点级缓存策略：</p>
<ul>
<li>图级设置缓存实现与默认策略：<ul>
<li><code>WithCache(cache Cache)</code> 设置缓存后端（默认示例提供内存实现 InMemoryCache）</li>
<li><code>WithCachePolicy(policy *CachePolicy)</code> 设置默认缓存策略（键函数 KeyFunc + 生存时间 Time To Live, TTL）</li>
</ul>
</li>
<li>节点级覆盖策略：<code>WithNodeCachePolicy(policy *CachePolicy)</code>（优先于图级）</li>
<li>清理：<code>ClearCache(nodes ...string)</code> 按节点清理缓存命名空间</li>
</ul>
<p>参考：
- Graph 接口（缓存与策略的访问/设置）：<a href="https://github.com/trpc-group/trpc-agent-go/blob/main/graph/graph.go">graph/graph.go</a>
- 默认策略与内存后端实现：
  - 接口/策略与默认键函数（规范化 JSON + SHA‑256）：<a href="https://github.com/trpc-group/trpc-agent-go/blob/main/graph/cache.go">graph/cache.go</a>
  - 内存缓存（InMemoryCache）并发安全实现（读写锁 + 深拷贝）：<a href="https://github.com/trpc-group/trpc-agent-go/blob/main/graph/cache.go">graph/cache.go</a>
- 执行器：
  - 节点执行前尝试 Get，命中则跳过节点函数执行，仅触发 after 回调与写出（Writes）：<a href="https://github.com/trpc-group/trpc-agent-go/blob/main/graph/executor.go">graph/executor.go</a>
  - 正常执行成功后写入缓存（Set）：<a href="https://github.com/trpc-group/trpc-agent-go/blob/main/graph/executor.go">graph/executor.go</a>
  - 节点完成事件中附带 <code>_cache_hit</code> 观察标记（命中时插入 <code>StateDelta["_cache_hit"]=true</code>）：<a href="https://github.com/trpc-group/trpc-agent-go/blob/main/graph/executor.go">graph/executor.go</a></p>
<p>最小用法：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-33-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-33-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-33-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-33-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-33-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-33-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-33-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-33-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-33-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-33-10">10</a></span>
<span class="normal"><a href="#__codelineno-33-11">11</a></span>
<span class="normal"><a href="#__codelineno-33-12">12</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1"></a><span class="nx">schema</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateSchema</span><span class="p">()</span>
</span><span id="__span-33-2"><a id="__codelineno-33-2" name="__codelineno-33-2"></a><span class="nx">sg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateGraph</span><span class="p">(</span><span class="nx">schema</span><span class="p">).</span>
</span><span id="__span-33-3"><a id="__codelineno-33-3" name="__codelineno-33-3"></a><span class="w">  </span><span class="nx">WithCache</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewInMemoryCache</span><span class="p">()).</span>
</span><span id="__span-33-4"><a id="__codelineno-33-4" name="__codelineno-33-4"></a><span class="w">  </span><span class="nx">WithCachePolicy</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">DefaultCachePolicy</span><span class="p">())</span>
</span><span id="__span-33-5"><a id="__codelineno-33-5" name="__codelineno-33-5"></a>
</span><span id="__span-33-6"><a id="__codelineno-33-6" name="__codelineno-33-6"></a><span class="c1">// 对某个节点单独设置 TTL 10 分钟</span>
</span><span id="__span-33-7"><a id="__codelineno-33-7" name="__codelineno-33-7"></a><span class="nx">nodePolicy</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">graph</span><span class="p">.</span><span class="nx">CachePolicy</span><span class="p">{</span><span class="nx">KeyFunc</span><span class="p">:</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">DefaultCachePolicy</span><span class="p">().</span><span class="nx">KeyFunc</span><span class="p">,</span><span class="w"> </span><span class="nx">TTL</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span><span class="p">}</span>
</span><span id="__span-33-8"><a id="__codelineno-33-8" name="__codelineno-33-8"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;compute&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">computeFunc</span><span class="p">,</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithNodeCachePolicy</span><span class="p">(</span><span class="nx">nodePolicy</span><span class="p">)).</span>
</span><span id="__span-33-9"><a id="__codelineno-33-9" name="__codelineno-33-9"></a><span class="w">  </span><span class="nx">SetEntryPoint</span><span class="p">(</span><span class="s">&quot;compute&quot;</span><span class="p">).</span>
</span><span id="__span-33-10"><a id="__codelineno-33-10" name="__codelineno-33-10"></a><span class="w">  </span><span class="nx">SetFinishPoint</span><span class="p">(</span><span class="s">&quot;compute&quot;</span><span class="p">)</span>
</span><span id="__span-33-11"><a id="__codelineno-33-11" name="__codelineno-33-11"></a>
</span><span id="__span-33-12"><a id="__codelineno-33-12" name="__codelineno-33-12"></a><span class="nx">compiled</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">sg</span><span class="p">.</span><span class="nx">Compile</span><span class="p">()</span>
</span></code></pre></div></td></tr></table></div>
<p>进阶用法：
- 仅使用部分字段作为键（推荐）</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-34-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-34-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-34-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-34-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-34-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-34-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-34-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-34-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-34-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-34-10">10</a></span>
<span class="normal"><a href="#__codelineno-34-11">11</a></span>
<span class="normal"><a href="#__codelineno-34-12">12</a></span>
<span class="normal"><a href="#__codelineno-34-13">13</a></span>
<span class="normal"><a href="#__codelineno-34-14">14</a></span>
<span class="normal"><a href="#__codelineno-34-15">15</a></span>
<span class="normal"><a href="#__codelineno-34-16">16</a></span>
<span class="normal"><a href="#__codelineno-34-17">17</a></span>
<span class="normal"><a href="#__codelineno-34-18">18</a></span>
<span class="normal"><a href="#__codelineno-34-19">19</a></span>
<span class="normal"><a href="#__codelineno-34-20">20</a></span>
<span class="normal"><a href="#__codelineno-34-21">21</a></span>
<span class="normal"><a href="#__codelineno-34-22">22</a></span>
<span class="normal"><a href="#__codelineno-34-23">23</a></span>
<span class="normal"><a href="#__codelineno-34-24">24</a></span>
<span class="normal"><a href="#__codelineno-34-25">25</a></span>
<span class="normal"><a href="#__codelineno-34-26">26</a></span>
<span class="normal"><a href="#__codelineno-34-27">27</a></span>
<span class="normal"><a href="#__codelineno-34-28">28</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1"></a><span class="kn">package</span><span class="w"> </span><span class="nx">main</span>
</span><span id="__span-34-2"><a id="__codelineno-34-2" name="__codelineno-34-2"></a>
</span><span id="__span-34-3"><a id="__codelineno-34-3" name="__codelineno-34-3"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-34-4"><a id="__codelineno-34-4" name="__codelineno-34-4"></a><span class="w">    </span><span class="s">&quot;context&quot;</span>
</span><span id="__span-34-5"><a id="__codelineno-34-5" name="__codelineno-34-5"></a><span class="w">    </span><span class="s">&quot;time&quot;</span>
</span><span id="__span-34-6"><a id="__codelineno-34-6" name="__codelineno-34-6"></a>
</span><span id="__span-34-7"><a id="__codelineno-34-7" name="__codelineno-34-7"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-34-8"><a id="__codelineno-34-8" name="__codelineno-34-8"></a><span class="p">)</span>
</span><span id="__span-34-9"><a id="__codelineno-34-9" name="__codelineno-34-9"></a>
</span><span id="__span-34-10"><a id="__codelineno-34-10" name="__codelineno-34-10"></a><span class="kd">func</span><span class="w"> </span><span class="nx">build</span><span class="p">()</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">graph</span><span class="p">.</span><span class="nx">Graph</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-34-11"><a id="__codelineno-34-11" name="__codelineno-34-11"></a><span class="w">    </span><span class="nx">schema</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateSchema</span><span class="p">()</span>
</span><span id="__span-34-12"><a id="__codelineno-34-12" name="__codelineno-34-12"></a><span class="w">    </span><span class="nx">sg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateGraph</span><span class="p">(</span><span class="nx">schema</span><span class="p">).</span>
</span><span id="__span-34-13"><a id="__codelineno-34-13" name="__codelineno-34-13"></a><span class="w">        </span><span class="nx">WithCache</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewInMemoryCache</span><span class="p">()).</span>
</span><span id="__span-34-14"><a id="__codelineno-34-14" name="__codelineno-34-14"></a><span class="w">        </span><span class="nx">WithCachePolicy</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">DefaultCachePolicy</span><span class="p">())</span>
</span><span id="__span-34-15"><a id="__codelineno-34-15" name="__codelineno-34-15"></a>
</span><span id="__span-34-16"><a id="__codelineno-34-16" name="__codelineno-34-16"></a><span class="w">    </span><span class="nx">compute</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-34-17"><a id="__codelineno-34-17" name="__codelineno-34-17"></a><span class="w">        </span><span class="c1">// your logic here</span>
</span><span id="__span-34-18"><a id="__codelineno-34-18" name="__codelineno-34-18"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="s">&quot;out&quot;</span><span class="p">:</span><span class="w"> </span><span class="nx">s</span><span class="p">[</span><span class="s">&quot;n&quot;</span><span class="p">].(</span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-34-19"><a id="__codelineno-34-19" name="__codelineno-34-19"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-34-20"><a id="__codelineno-34-20" name="__codelineno-34-20"></a>
</span><span id="__span-34-21"><a id="__codelineno-34-21" name="__codelineno-34-21"></a><span class="w">    </span><span class="c1">// 仅使用 n 与 user_id 两个字段参与键计算（其余字段不会影响命中）</span>
</span><span id="__span-34-22"><a id="__codelineno-34-22" name="__codelineno-34-22"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;compute&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">compute</span><span class="p">,</span>
</span><span id="__span-34-23"><a id="__codelineno-34-23" name="__codelineno-34-23"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithNodeCachePolicy</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">graph</span><span class="p">.</span><span class="nx">CachePolicy</span><span class="p">{</span><span class="nx">KeyFunc</span><span class="p">:</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">DefaultCachePolicy</span><span class="p">().</span><span class="nx">KeyFunc</span><span class="p">,</span><span class="w"> </span><span class="nx">TTL</span><span class="p">:</span><span class="w"> </span><span class="mi">30</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span><span class="p">}),</span>
</span><span id="__span-34-24"><a id="__codelineno-34-24" name="__codelineno-34-24"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithCacheKeyFields</span><span class="p">(</span><span class="s">&quot;n&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;user_id&quot;</span><span class="p">),</span>
</span><span id="__span-34-25"><a id="__codelineno-34-25" name="__codelineno-34-25"></a><span class="w">    </span><span class="p">)</span>
</span><span id="__span-34-26"><a id="__codelineno-34-26" name="__codelineno-34-26"></a>
</span><span id="__span-34-27"><a id="__codelineno-34-27" name="__codelineno-34-27"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">sg</span><span class="p">.</span><span class="nx">Compile</span><span class="p">()</span>
</span><span id="__span-34-28"><a id="__codelineno-34-28" name="__codelineno-34-28"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<ul>
<li>自定义选择器（当字段映射更复杂时）</li>
</ul>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-35-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-35-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-35-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-35-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-35-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-35-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-35-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-35-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-35-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-35-10">10</a></span>
<span class="normal"><a href="#__codelineno-35-11">11</a></span>
<span class="normal"><a href="#__codelineno-35-12">12</a></span>
<span class="normal"><a href="#__codelineno-35-13">13</a></span>
<span class="normal"><a href="#__codelineno-35-14">14</a></span>
<span class="normal"><a href="#__codelineno-35-15">15</a></span>
<span class="normal"><a href="#__codelineno-35-16">16</a></span>
<span class="normal"><a href="#__codelineno-35-17">17</a></span>
<span class="normal"><a href="#__codelineno-35-18">18</a></span>
<span class="normal"><a href="#__codelineno-35-19">19</a></span>
<span class="normal"><a href="#__codelineno-35-20">20</a></span>
<span class="normal"><a href="#__codelineno-35-21">21</a></span>
<span class="normal"><a href="#__codelineno-35-22">22</a></span>
<span class="normal"><a href="#__codelineno-35-23">23</a></span>
<span class="normal"><a href="#__codelineno-35-24">24</a></span>
<span class="normal"><a href="#__codelineno-35-25">25</a></span>
<span class="normal"><a href="#__codelineno-35-26">26</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1"></a><span class="kn">package</span><span class="w"> </span><span class="nx">main</span>
</span><span id="__span-35-2"><a id="__codelineno-35-2" name="__codelineno-35-2"></a>
</span><span id="__span-35-3"><a id="__codelineno-35-3" name="__codelineno-35-3"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-35-4"><a id="__codelineno-35-4" name="__codelineno-35-4"></a><span class="w">    </span><span class="s">&quot;context&quot;</span>
</span><span id="__span-35-5"><a id="__codelineno-35-5" name="__codelineno-35-5"></a><span class="w">    </span><span class="s">&quot;time&quot;</span>
</span><span id="__span-35-6"><a id="__codelineno-35-6" name="__codelineno-35-6"></a>
</span><span id="__span-35-7"><a id="__codelineno-35-7" name="__codelineno-35-7"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-35-8"><a id="__codelineno-35-8" name="__codelineno-35-8"></a><span class="p">)</span>
</span><span id="__span-35-9"><a id="__codelineno-35-9" name="__codelineno-35-9"></a>
</span><span id="__span-35-10"><a id="__codelineno-35-10" name="__codelineno-35-10"></a><span class="kd">func</span><span class="w"> </span><span class="nx">build</span><span class="p">()</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">graph</span><span class="p">.</span><span class="nx">Graph</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-35-11"><a id="__codelineno-35-11" name="__codelineno-35-11"></a><span class="w">    </span><span class="nx">schema</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateSchema</span><span class="p">()</span>
</span><span id="__span-35-12"><a id="__codelineno-35-12" name="__codelineno-35-12"></a><span class="w">    </span><span class="nx">sg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateGraph</span><span class="p">(</span><span class="nx">schema</span><span class="p">).</span>
</span><span id="__span-35-13"><a id="__codelineno-35-13" name="__codelineno-35-13"></a><span class="w">        </span><span class="nx">WithCache</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewInMemoryCache</span><span class="p">()).</span>
</span><span id="__span-35-14"><a id="__codelineno-35-14" name="__codelineno-35-14"></a><span class="w">        </span><span class="nx">WithCachePolicy</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">DefaultCachePolicy</span><span class="p">())</span>
</span><span id="__span-35-15"><a id="__codelineno-35-15" name="__codelineno-35-15"></a>
</span><span id="__span-35-16"><a id="__codelineno-35-16" name="__codelineno-35-16"></a><span class="w">    </span><span class="nx">compute</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="s">&quot;out&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">42</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-35-17"><a id="__codelineno-35-17" name="__codelineno-35-17"></a>
</span><span id="__span-35-18"><a id="__codelineno-35-18" name="__codelineno-35-18"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;compute&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">compute</span><span class="p">,</span>
</span><span id="__span-35-19"><a id="__codelineno-35-19" name="__codelineno-35-19"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithNodeCachePolicy</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">graph</span><span class="p">.</span><span class="nx">CachePolicy</span><span class="p">{</span><span class="nx">KeyFunc</span><span class="p">:</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">DefaultCachePolicy</span><span class="p">().</span><span class="nx">KeyFunc</span><span class="p">,</span><span class="w"> </span><span class="nx">TTL</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span><span class="p">}),</span>
</span><span id="__span-35-20"><a id="__codelineno-35-20" name="__codelineno-35-20"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithCacheKeySelector</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">m</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">any</span><span class="p">)</span><span class="w"> </span><span class="kt">any</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-35-21"><a id="__codelineno-35-21" name="__codelineno-35-21"></a><span class="w">            </span><span class="c1">// 仅从净化后的输入中选择 n 与 uid 作为键来源</span>
</span><span id="__span-35-22"><a id="__codelineno-35-22" name="__codelineno-35-22"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">any</span><span class="p">{</span><span class="s">&quot;n&quot;</span><span class="p">:</span><span class="w"> </span><span class="nx">m</span><span class="p">[</span><span class="s">&quot;n&quot;</span><span class="p">],</span><span class="w"> </span><span class="s">&quot;uid&quot;</span><span class="p">:</span><span class="w"> </span><span class="nx">m</span><span class="p">[</span><span class="s">&quot;uid&quot;</span><span class="p">]}</span>
</span><span id="__span-35-23"><a id="__codelineno-35-23" name="__codelineno-35-23"></a><span class="w">        </span><span class="p">}),</span>
</span><span id="__span-35-24"><a id="__codelineno-35-24" name="__codelineno-35-24"></a><span class="w">    </span><span class="p">)</span>
</span><span id="__span-35-25"><a id="__codelineno-35-25" name="__codelineno-35-25"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">sg</span><span class="p">.</span><span class="nx">Compile</span><span class="p">()</span>
</span><span id="__span-35-26"><a id="__codelineno-35-26" name="__codelineno-35-26"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<ul>
<li>版本化命名空间（跨版本防脏缓存）</li>
</ul>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-36-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-36-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-36-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-36-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-36-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-36-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-36-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-36-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-36-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-36-10">10</a></span>
<span class="normal"><a href="#__codelineno-36-11">11</a></span>
<span class="normal"><a href="#__codelineno-36-12">12</a></span>
<span class="normal"><a href="#__codelineno-36-13">13</a></span>
<span class="normal"><a href="#__codelineno-36-14">14</a></span>
<span class="normal"><a href="#__codelineno-36-15">15</a></span>
<span class="normal"><a href="#__codelineno-36-16">16</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1"></a><span class="kn">package</span><span class="w"> </span><span class="nx">main</span>
</span><span id="__span-36-2"><a id="__codelineno-36-2" name="__codelineno-36-2"></a>
</span><span id="__span-36-3"><a id="__codelineno-36-3" name="__codelineno-36-3"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-36-4"><a id="__codelineno-36-4" name="__codelineno-36-4"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-36-5"><a id="__codelineno-36-5" name="__codelineno-36-5"></a><span class="p">)</span>
</span><span id="__span-36-6"><a id="__codelineno-36-6" name="__codelineno-36-6"></a>
</span><span id="__span-36-7"><a id="__codelineno-36-7" name="__codelineno-36-7"></a><span class="kd">func</span><span class="w"> </span><span class="nx">build</span><span class="p">()</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">graph</span><span class="p">.</span><span class="nx">Graph</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-36-8"><a id="__codelineno-36-8" name="__codelineno-36-8"></a><span class="w">    </span><span class="nx">schema</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateSchema</span><span class="p">()</span>
</span><span id="__span-36-9"><a id="__codelineno-36-9" name="__codelineno-36-9"></a><span class="w">    </span><span class="nx">sg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateGraph</span><span class="p">(</span><span class="nx">schema</span><span class="p">).</span>
</span><span id="__span-36-10"><a id="__codelineno-36-10" name="__codelineno-36-10"></a><span class="w">        </span><span class="nx">WithGraphVersion</span><span class="p">(</span><span class="s">&quot;v2025.03&quot;</span><span class="p">).</span><span class="w"> </span><span class="c1">// 命名空间变为 __writes__:v2025.03:&lt;node&gt;</span>
</span><span id="__span-36-11"><a id="__codelineno-36-11" name="__codelineno-36-11"></a><span class="w">        </span><span class="nx">WithCache</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewInMemoryCache</span><span class="p">()).</span>
</span><span id="__span-36-12"><a id="__codelineno-36-12" name="__codelineno-36-12"></a><span class="w">        </span><span class="nx">WithCachePolicy</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">DefaultCachePolicy</span><span class="p">())</span>
</span><span id="__span-36-13"><a id="__codelineno-36-13" name="__codelineno-36-13"></a>
</span><span id="__span-36-14"><a id="__codelineno-36-14" name="__codelineno-36-14"></a><span class="w">    </span><span class="c1">// ... AddNode(...)</span>
</span><span id="__span-36-15"><a id="__codelineno-36-15" name="__codelineno-36-15"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">sg</span><span class="p">.</span><span class="nx">Compile</span><span class="p">()</span>
</span><span id="__span-36-16"><a id="__codelineno-36-16" name="__codelineno-36-16"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<ul>
<li>节点级 TTL（Time To Live）</li>
</ul>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-37-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-37-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-37-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-37-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-37-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-37-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-37-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-37-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-37-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-37-10">10</a></span>
<span class="normal"><a href="#__codelineno-37-11">11</a></span>
<span class="normal"><a href="#__codelineno-37-12">12</a></span>
<span class="normal"><a href="#__codelineno-37-13">13</a></span>
<span class="normal"><a href="#__codelineno-37-14">14</a></span>
<span class="normal"><a href="#__codelineno-37-15">15</a></span>
<span class="normal"><a href="#__codelineno-37-16">16</a></span>
<span class="normal"><a href="#__codelineno-37-17">17</a></span>
<span class="normal"><a href="#__codelineno-37-18">18</a></span>
<span class="normal"><a href="#__codelineno-37-19">19</a></span>
<span class="normal"><a href="#__codelineno-37-20">20</a></span>
<span class="normal"><a href="#__codelineno-37-21">21</a></span>
<span class="normal"><a href="#__codelineno-37-22">22</a></span>
<span class="normal"><a href="#__codelineno-37-23">23</a></span>
<span class="normal"><a href="#__codelineno-37-24">24</a></span>
<span class="normal"><a href="#__codelineno-37-25">25</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-37-1"><a id="__codelineno-37-1" name="__codelineno-37-1"></a><span class="kn">package</span><span class="w"> </span><span class="nx">main</span>
</span><span id="__span-37-2"><a id="__codelineno-37-2" name="__codelineno-37-2"></a>
</span><span id="__span-37-3"><a id="__codelineno-37-3" name="__codelineno-37-3"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-37-4"><a id="__codelineno-37-4" name="__codelineno-37-4"></a><span class="w">    </span><span class="s">&quot;context&quot;</span>
</span><span id="__span-37-5"><a id="__codelineno-37-5" name="__codelineno-37-5"></a><span class="w">    </span><span class="s">&quot;time&quot;</span>
</span><span id="__span-37-6"><a id="__codelineno-37-6" name="__codelineno-37-6"></a>
</span><span id="__span-37-7"><a id="__codelineno-37-7" name="__codelineno-37-7"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-37-8"><a id="__codelineno-37-8" name="__codelineno-37-8"></a><span class="p">)</span>
</span><span id="__span-37-9"><a id="__codelineno-37-9" name="__codelineno-37-9"></a>
</span><span id="__span-37-10"><a id="__codelineno-37-10" name="__codelineno-37-10"></a><span class="kd">func</span><span class="w"> </span><span class="nx">build</span><span class="p">()</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">graph</span><span class="p">.</span><span class="nx">Graph</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-37-11"><a id="__codelineno-37-11" name="__codelineno-37-11"></a><span class="w">    </span><span class="nx">schema</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateSchema</span><span class="p">()</span>
</span><span id="__span-37-12"><a id="__codelineno-37-12" name="__codelineno-37-12"></a><span class="w">    </span><span class="nx">sg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateGraph</span><span class="p">(</span><span class="nx">schema</span><span class="p">).</span>
</span><span id="__span-37-13"><a id="__codelineno-37-13" name="__codelineno-37-13"></a><span class="w">        </span><span class="nx">WithCache</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewInMemoryCache</span><span class="p">()).</span>
</span><span id="__span-37-14"><a id="__codelineno-37-14" name="__codelineno-37-14"></a><span class="w">        </span><span class="nx">WithCachePolicy</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">DefaultCachePolicy</span><span class="p">())</span>
</span><span id="__span-37-15"><a id="__codelineno-37-15" name="__codelineno-37-15"></a>
</span><span id="__span-37-16"><a id="__codelineno-37-16" name="__codelineno-37-16"></a><span class="w">    </span><span class="nx">compute</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="s">&quot;out&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">42</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-37-17"><a id="__codelineno-37-17" name="__codelineno-37-17"></a>
</span><span id="__span-37-18"><a id="__codelineno-37-18" name="__codelineno-37-18"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;compute&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">compute</span><span class="p">,</span>
</span><span id="__span-37-19"><a id="__codelineno-37-19" name="__codelineno-37-19"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithNodeCachePolicy</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">graph</span><span class="p">.</span><span class="nx">CachePolicy</span><span class="p">{</span>
</span><span id="__span-37-20"><a id="__codelineno-37-20" name="__codelineno-37-20"></a><span class="w">            </span><span class="nx">KeyFunc</span><span class="p">:</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">DefaultCachePolicy</span><span class="p">().</span><span class="nx">KeyFunc</span><span class="p">,</span>
</span><span id="__span-37-21"><a id="__codelineno-37-21" name="__codelineno-37-21"></a><span class="w">            </span><span class="nx">TTL</span><span class="p">:</span><span class="w">     </span><span class="mi">10</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span><span class="p">,</span>
</span><span id="__span-37-22"><a id="__codelineno-37-22" name="__codelineno-37-22"></a><span class="w">        </span><span class="p">}),</span>
</span><span id="__span-37-23"><a id="__codelineno-37-23" name="__codelineno-37-23"></a><span class="w">    </span><span class="p">)</span>
</span><span id="__span-37-24"><a id="__codelineno-37-24" name="__codelineno-37-24"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">sg</span><span class="p">.</span><span class="nx">Compile</span><span class="p">()</span>
</span><span id="__span-37-25"><a id="__codelineno-37-25" name="__codelineno-37-25"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<ul>
<li>清理缓存（按节点）</li>
</ul>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-38-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-38-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-38-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-38-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-38-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-38-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-38-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-38-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-38-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-38-10">10</a></span>
<span class="normal"><a href="#__codelineno-38-11">11</a></span>
<span class="normal"><a href="#__codelineno-38-12">12</a></span>
<span class="normal"><a href="#__codelineno-38-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-38-1"><a id="__codelineno-38-1" name="__codelineno-38-1"></a><span class="kn">package</span><span class="w"> </span><span class="nx">main</span>
</span><span id="__span-38-2"><a id="__codelineno-38-2" name="__codelineno-38-2"></a>
</span><span id="__span-38-3"><a id="__codelineno-38-3" name="__codelineno-38-3"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-38-4"><a id="__codelineno-38-4" name="__codelineno-38-4"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-38-5"><a id="__codelineno-38-5" name="__codelineno-38-5"></a><span class="p">)</span>
</span><span id="__span-38-6"><a id="__codelineno-38-6" name="__codelineno-38-6"></a>
</span><span id="__span-38-7"><a id="__codelineno-38-7" name="__codelineno-38-7"></a><span class="kd">func</span><span class="w"> </span><span class="nb">clear</span><span class="p">(</span><span class="nx">sg</span><span class="w"> </span><span class="o">*</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateGraph</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-38-8"><a id="__codelineno-38-8" name="__codelineno-38-8"></a><span class="w">    </span><span class="c1">// 清理指定节点</span>
</span><span id="__span-38-9"><a id="__codelineno-38-9" name="__codelineno-38-9"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">ClearCache</span><span class="p">(</span><span class="s">&quot;compute&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;format&quot;</span><span class="p">)</span>
</span><span id="__span-38-10"><a id="__codelineno-38-10" name="__codelineno-38-10"></a>
</span><span id="__span-38-11"><a id="__codelineno-38-11" name="__codelineno-38-11"></a><span class="w">    </span><span class="c1">// 清理图内所有节点（不传参）</span>
</span><span id="__span-38-12"><a id="__codelineno-38-12" name="__codelineno-38-12"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">ClearCache</span><span class="p">()</span>
</span><span id="__span-38-13"><a id="__codelineno-38-13" name="__codelineno-38-13"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<ul>
<li>读取缓存命中标记（_cache_hit）</li>
</ul>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-39-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-39-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-39-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-39-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-39-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-39-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-39-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-39-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-39-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-39-10">10</a></span>
<span class="normal"><a href="#__codelineno-39-11">11</a></span>
<span class="normal"><a href="#__codelineno-39-12">12</a></span>
<span class="normal"><a href="#__codelineno-39-13">13</a></span>
<span class="normal"><a href="#__codelineno-39-14">14</a></span>
<span class="normal"><a href="#__codelineno-39-15">15</a></span>
<span class="normal"><a href="#__codelineno-39-16">16</a></span>
<span class="normal"><a href="#__codelineno-39-17">17</a></span>
<span class="normal"><a href="#__codelineno-39-18">18</a></span>
<span class="normal"><a href="#__codelineno-39-19">19</a></span>
<span class="normal"><a href="#__codelineno-39-20">20</a></span>
<span class="normal"><a href="#__codelineno-39-21">21</a></span>
<span class="normal"><a href="#__codelineno-39-22">22</a></span>
<span class="normal"><a href="#__codelineno-39-23">23</a></span>
<span class="normal"><a href="#__codelineno-39-24">24</a></span>
<span class="normal"><a href="#__codelineno-39-25">25</a></span>
<span class="normal"><a href="#__codelineno-39-26">26</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-39-1"><a id="__codelineno-39-1" name="__codelineno-39-1"></a><span class="kn">package</span><span class="w"> </span><span class="nx">main</span>
</span><span id="__span-39-2"><a id="__codelineno-39-2" name="__codelineno-39-2"></a>
</span><span id="__span-39-3"><a id="__codelineno-39-3" name="__codelineno-39-3"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-39-4"><a id="__codelineno-39-4" name="__codelineno-39-4"></a><span class="w">    </span><span class="s">&quot;context&quot;</span>
</span><span id="__span-39-5"><a id="__codelineno-39-5" name="__codelineno-39-5"></a><span class="w">    </span><span class="s">&quot;fmt&quot;</span>
</span><span id="__span-39-6"><a id="__codelineno-39-6" name="__codelineno-39-6"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/agent&quot;</span>
</span><span id="__span-39-7"><a id="__codelineno-39-7" name="__codelineno-39-7"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/event&quot;</span>
</span><span id="__span-39-8"><a id="__codelineno-39-8" name="__codelineno-39-8"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-39-9"><a id="__codelineno-39-9" name="__codelineno-39-9"></a><span class="p">)</span>
</span><span id="__span-39-10"><a id="__codelineno-39-10" name="__codelineno-39-10"></a>
</span><span id="__span-39-11"><a id="__codelineno-39-11" name="__codelineno-39-11"></a><span class="kd">func</span><span class="w"> </span><span class="nx">runAndReadHits</span><span class="p">(</span><span class="nx">executor</span><span class="w"> </span><span class="o">*</span><span class="nx">graph</span><span class="p">.</span><span class="nx">Executor</span><span class="p">,</span><span class="w"> </span><span class="nx">initial</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-12"><a id="__codelineno-39-12" name="__codelineno-39-12"></a><span class="w">    </span><span class="nx">inv</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">agent</span><span class="p">.</span><span class="nx">Invocation</span><span class="p">{</span><span class="nx">InvocationID</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;demo&quot;</span><span class="p">}</span>
</span><span id="__span-39-13"><a id="__codelineno-39-13" name="__codelineno-39-13"></a><span class="w">    </span><span class="nx">ch</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">executor</span><span class="p">.</span><span class="nx">Execute</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Background</span><span class="p">(),</span><span class="w"> </span><span class="nx">initial</span><span class="p">,</span><span class="w"> </span><span class="nx">inv</span><span class="p">)</span>
</span><span id="__span-39-14"><a id="__codelineno-39-14" name="__codelineno-39-14"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-39-15"><a id="__codelineno-39-15" name="__codelineno-39-15"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">e</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">ch</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-16"><a id="__codelineno-39-16" name="__codelineno-39-16"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">Response</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">Response</span><span class="p">.</span><span class="nx">Object</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">ObjectTypeGraphNodeComplete</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-17"><a id="__codelineno-39-17" name="__codelineno-39-17"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">StateDelta</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-18"><a id="__codelineno-39-18" name="__codelineno-39-18"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">StateDelta</span><span class="p">[</span><span class="s">&quot;_cache_hit&quot;</span><span class="p">];</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-19"><a id="__codelineno-39-19" name="__codelineno-39-19"></a><span class="w">                    </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;cache hit: skipped node function&quot;</span><span class="p">)</span>
</span><span id="__span-39-20"><a id="__codelineno-39-20" name="__codelineno-39-20"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-39-21"><a id="__codelineno-39-21" name="__codelineno-39-21"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-39-22"><a id="__codelineno-39-22" name="__codelineno-39-22"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-39-23"><a id="__codelineno-39-23" name="__codelineno-39-23"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">Done</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">break</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-39-24"><a id="__codelineno-39-24" name="__codelineno-39-24"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-39-25"><a id="__codelineno-39-25" name="__codelineno-39-25"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-39-26"><a id="__codelineno-39-26" name="__codelineno-39-26"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>注意事项：
- 仅对“纯函数（相同输入→相同输出，无外部副作用）”节点开启缓存，避免语义错误。
- TTL（Time To Live）为 0 表示不过期，需防止内存增长；生产建议使用持久化后端（如 Redis/SQLite）与定期清理。
- 键函数会“净化输入”后再规范化序列化，避免把会话、执行上下文等“易变/不可序列化”值纳入键，提升命中率、避免错误（见 <a href="https://github.com/trpc-group/trpc-agent-go/blob/main/graph/cache_key.go">graph/cache_key.go</a>）。
- 代码更新后可调用 <code>ClearCache("nodeID")</code> 清理旧缓存，或在键/命名空间中引入“函数标识符/版本”维度。</p>
<p>Runner + GraphAgent 环境使用示例：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-40-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-40-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-40-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-40-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-40-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-40-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-40-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-40-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-40-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-40-10">10</a></span>
<span class="normal"><a href="#__codelineno-40-11">11</a></span>
<span class="normal"><a href="#__codelineno-40-12">12</a></span>
<span class="normal"><a href="#__codelineno-40-13">13</a></span>
<span class="normal"><a href="#__codelineno-40-14">14</a></span>
<span class="normal"><a href="#__codelineno-40-15">15</a></span>
<span class="normal"><a href="#__codelineno-40-16">16</a></span>
<span class="normal"><a href="#__codelineno-40-17">17</a></span>
<span class="normal"><a href="#__codelineno-40-18">18</a></span>
<span class="normal"><a href="#__codelineno-40-19">19</a></span>
<span class="normal"><a href="#__codelineno-40-20">20</a></span>
<span class="normal"><a href="#__codelineno-40-21">21</a></span>
<span class="normal"><a href="#__codelineno-40-22">22</a></span>
<span class="normal"><a href="#__codelineno-40-23">23</a></span>
<span class="normal"><a href="#__codelineno-40-24">24</a></span>
<span class="normal"><a href="#__codelineno-40-25">25</a></span>
<span class="normal"><a href="#__codelineno-40-26">26</a></span>
<span class="normal"><a href="#__codelineno-40-27">27</a></span>
<span class="normal"><a href="#__codelineno-40-28">28</a></span>
<span class="normal"><a href="#__codelineno-40-29">29</a></span>
<span class="normal"><a href="#__codelineno-40-30">30</a></span>
<span class="normal"><a href="#__codelineno-40-31">31</a></span>
<span class="normal"><a href="#__codelineno-40-32">32</a></span>
<span class="normal"><a href="#__codelineno-40-33">33</a></span>
<span class="normal"><a href="#__codelineno-40-34">34</a></span>
<span class="normal"><a href="#__codelineno-40-35">35</a></span>
<span class="normal"><a href="#__codelineno-40-36">36</a></span>
<span class="normal"><a href="#__codelineno-40-37">37</a></span>
<span class="normal"><a href="#__codelineno-40-38">38</a></span>
<span class="normal"><a href="#__codelineno-40-39">39</a></span>
<span class="normal"><a href="#__codelineno-40-40">40</a></span>
<span class="normal"><a href="#__codelineno-40-41">41</a></span>
<span class="normal"><a href="#__codelineno-40-42">42</a></span>
<span class="normal"><a href="#__codelineno-40-43">43</a></span>
<span class="normal"><a href="#__codelineno-40-44">44</a></span>
<span class="normal"><a href="#__codelineno-40-45">45</a></span>
<span class="normal"><a href="#__codelineno-40-46">46</a></span>
<span class="normal"><a href="#__codelineno-40-47">47</a></span>
<span class="normal"><a href="#__codelineno-40-48">48</a></span>
<span class="normal"><a href="#__codelineno-40-49">49</a></span>
<span class="normal"><a href="#__codelineno-40-50">50</a></span>
<span class="normal"><a href="#__codelineno-40-51">51</a></span>
<span class="normal"><a href="#__codelineno-40-52">52</a></span>
<span class="normal"><a href="#__codelineno-40-53">53</a></span>
<span class="normal"><a href="#__codelineno-40-54">54</a></span>
<span class="normal"><a href="#__codelineno-40-55">55</a></span>
<span class="normal"><a href="#__codelineno-40-56">56</a></span>
<span class="normal"><a href="#__codelineno-40-57">57</a></span>
<span class="normal"><a href="#__codelineno-40-58">58</a></span>
<span class="normal"><a href="#__codelineno-40-59">59</a></span>
<span class="normal"><a href="#__codelineno-40-60">60</a></span>
<span class="normal"><a href="#__codelineno-40-61">61</a></span>
<span class="normal"><a href="#__codelineno-40-62">62</a></span>
<span class="normal"><a href="#__codelineno-40-63">63</a></span>
<span class="normal"><a href="#__codelineno-40-64">64</a></span>
<span class="normal"><a href="#__codelineno-40-65">65</a></span>
<span class="normal"><a href="#__codelineno-40-66">66</a></span>
<span class="normal"><a href="#__codelineno-40-67">67</a></span>
<span class="normal"><a href="#__codelineno-40-68">68</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-40-1"><a id="__codelineno-40-1" name="__codelineno-40-1"></a><span class="kn">package</span><span class="w"> </span><span class="nx">main</span>
</span><span id="__span-40-2"><a id="__codelineno-40-2" name="__codelineno-40-2"></a>
</span><span id="__span-40-3"><a id="__codelineno-40-3" name="__codelineno-40-3"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-40-4"><a id="__codelineno-40-4" name="__codelineno-40-4"></a><span class="w">    </span><span class="s">&quot;bufio&quot;</span>
</span><span id="__span-40-5"><a id="__codelineno-40-5" name="__codelineno-40-5"></a><span class="w">    </span><span class="s">&quot;context&quot;</span>
</span><span id="__span-40-6"><a id="__codelineno-40-6" name="__codelineno-40-6"></a><span class="w">    </span><span class="s">&quot;flag&quot;</span>
</span><span id="__span-40-7"><a id="__codelineno-40-7" name="__codelineno-40-7"></a><span class="w">    </span><span class="s">&quot;fmt&quot;</span>
</span><span id="__span-40-8"><a id="__codelineno-40-8" name="__codelineno-40-8"></a><span class="w">    </span><span class="s">&quot;os&quot;</span>
</span><span id="__span-40-9"><a id="__codelineno-40-9" name="__codelineno-40-9"></a><span class="w">    </span><span class="s">&quot;strings&quot;</span>
</span><span id="__span-40-10"><a id="__codelineno-40-10" name="__codelineno-40-10"></a><span class="w">    </span><span class="s">&quot;time&quot;</span>
</span><span id="__span-40-11"><a id="__codelineno-40-11" name="__codelineno-40-11"></a>
</span><span id="__span-40-12"><a id="__codelineno-40-12" name="__codelineno-40-12"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/agent&quot;</span>
</span><span id="__span-40-13"><a id="__codelineno-40-13" name="__codelineno-40-13"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/agent/graphagent&quot;</span>
</span><span id="__span-40-14"><a id="__codelineno-40-14" name="__codelineno-40-14"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-40-15"><a id="__codelineno-40-15" name="__codelineno-40-15"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/model&quot;</span>
</span><span id="__span-40-16"><a id="__codelineno-40-16" name="__codelineno-40-16"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/runner&quot;</span>
</span><span id="__span-40-17"><a id="__codelineno-40-17" name="__codelineno-40-17"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/session/inmemory&quot;</span>
</span><span id="__span-40-18"><a id="__codelineno-40-18" name="__codelineno-40-18"></a><span class="p">)</span>
</span><span id="__span-40-19"><a id="__codelineno-40-19" name="__codelineno-40-19"></a>
</span><span id="__span-40-20"><a id="__codelineno-40-20" name="__codelineno-40-20"></a><span class="kd">func</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-40-21"><a id="__codelineno-40-21" name="__codelineno-40-21"></a><span class="w">    </span><span class="nx">ttl</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">flag</span><span class="p">.</span><span class="nx">Duration</span><span class="p">(</span><span class="s">&quot;ttl&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;cache ttl&quot;</span><span class="p">)</span>
</span><span id="__span-40-22"><a id="__codelineno-40-22" name="__codelineno-40-22"></a><span class="w">    </span><span class="nx">flag</span><span class="p">.</span><span class="nx">Parse</span><span class="p">()</span>
</span><span id="__span-40-23"><a id="__codelineno-40-23" name="__codelineno-40-23"></a>
</span><span id="__span-40-24"><a id="__codelineno-40-24" name="__codelineno-40-24"></a><span class="w">    </span><span class="c1">// Build graph with cache</span>
</span><span id="__span-40-25"><a id="__codelineno-40-25" name="__codelineno-40-25"></a><span class="w">    </span><span class="nx">schema</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateSchema</span><span class="p">()</span>
</span><span id="__span-40-26"><a id="__codelineno-40-26" name="__codelineno-40-26"></a><span class="w">    </span><span class="nx">sg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateGraph</span><span class="p">(</span><span class="nx">schema</span><span class="p">).</span>
</span><span id="__span-40-27"><a id="__codelineno-40-27" name="__codelineno-40-27"></a><span class="w">        </span><span class="nx">WithCache</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewInMemoryCache</span><span class="p">()).</span>
</span><span id="__span-40-28"><a id="__codelineno-40-28" name="__codelineno-40-28"></a><span class="w">        </span><span class="nx">WithCachePolicy</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">DefaultCachePolicy</span><span class="p">())</span>
</span><span id="__span-40-29"><a id="__codelineno-40-29" name="__codelineno-40-29"></a>
</span><span id="__span-40-30"><a id="__codelineno-40-30" name="__codelineno-40-30"></a><span class="w">    </span><span class="nx">compute</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-40-31"><a id="__codelineno-40-31" name="__codelineno-40-31"></a><span class="w">        </span><span class="nx">n</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">s</span><span class="p">[</span><span class="s">&quot;n&quot;</span><span class="p">].(</span><span class="kt">int</span><span class="p">)</span>
</span><span id="__span-40-32"><a id="__codelineno-40-32" name="__codelineno-40-32"></a><span class="w">        </span><span class="nx">time</span><span class="p">.</span><span class="nx">Sleep</span><span class="p">(</span><span class="mi">200</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span><span class="p">)</span>
</span><span id="__span-40-33"><a id="__codelineno-40-33" name="__codelineno-40-33"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="s">&quot;out&quot;</span><span class="p">:</span><span class="w"> </span><span class="nx">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-40-34"><a id="__codelineno-40-34" name="__codelineno-40-34"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-40-35"><a id="__codelineno-40-35" name="__codelineno-40-35"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;compute&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">compute</span><span class="p">,</span>
</span><span id="__span-40-36"><a id="__codelineno-40-36" name="__codelineno-40-36"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithNodeCachePolicy</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">graph</span><span class="p">.</span><span class="nx">CachePolicy</span><span class="p">{</span><span class="nx">KeyFunc</span><span class="p">:</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">DefaultCachePolicy</span><span class="p">().</span><span class="nx">KeyFunc</span><span class="p">,</span><span class="w"> </span><span class="nx">TTL</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="nx">ttl</span><span class="p">}),</span>
</span><span id="__span-40-37"><a id="__codelineno-40-37" name="__codelineno-40-37"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithCacheKeyFields</span><span class="p">(</span><span class="s">&quot;n&quot;</span><span class="p">),</span>
</span><span id="__span-40-38"><a id="__codelineno-40-38" name="__codelineno-40-38"></a><span class="w">    </span><span class="p">).</span>
</span><span id="__span-40-39"><a id="__codelineno-40-39" name="__codelineno-40-39"></a><span class="w">        </span><span class="nx">SetEntryPoint</span><span class="p">(</span><span class="s">&quot;compute&quot;</span><span class="p">).</span>
</span><span id="__span-40-40"><a id="__codelineno-40-40" name="__codelineno-40-40"></a><span class="w">        </span><span class="nx">SetFinishPoint</span><span class="p">(</span><span class="s">&quot;compute&quot;</span><span class="p">)</span>
</span><span id="__span-40-41"><a id="__codelineno-40-41" name="__codelineno-40-41"></a><span class="w">    </span><span class="nx">g</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">sg</span><span class="p">.</span><span class="nx">Compile</span><span class="p">()</span>
</span><span id="__span-40-42"><a id="__codelineno-40-42" name="__codelineno-40-42"></a>
</span><span id="__span-40-43"><a id="__codelineno-40-43" name="__codelineno-40-43"></a><span class="w">    </span><span class="c1">// GraphAgent + Runner</span>
</span><span id="__span-40-44"><a id="__codelineno-40-44" name="__codelineno-40-44"></a><span class="w">    </span><span class="nx">ga</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;cache-demo&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">g</span><span class="p">,</span><span class="w"> </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithInitialState</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{}))</span>
</span><span id="__span-40-45"><a id="__codelineno-40-45" name="__codelineno-40-45"></a><span class="w">    </span><span class="nx">app</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">runner</span><span class="p">.</span><span class="nx">NewRunner</span><span class="p">(</span><span class="s">&quot;app&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">ga</span><span class="p">,</span><span class="w"> </span><span class="nx">runner</span><span class="p">.</span><span class="nx">WithSessionService</span><span class="p">(</span><span class="nx">inmemory</span><span class="p">.</span><span class="nx">NewSessionService</span><span class="p">()))</span>
</span><span id="__span-40-46"><a id="__codelineno-40-46" name="__codelineno-40-46"></a>
</span><span id="__span-40-47"><a id="__codelineno-40-47" name="__codelineno-40-47"></a><span class="w">    </span><span class="c1">// Interactive</span>
</span><span id="__span-40-48"><a id="__codelineno-40-48" name="__codelineno-40-48"></a><span class="w">    </span><span class="nx">sc</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">bufio</span><span class="p">.</span><span class="nx">NewScanner</span><span class="p">(</span><span class="nx">os</span><span class="p">.</span><span class="nx">Stdin</span><span class="p">)</span>
</span><span id="__span-40-49"><a id="__codelineno-40-49" name="__codelineno-40-49"></a><span class="w">    </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Enter integers; repeated inputs should hit cache. type &#39;exit&#39; to quit&quot;</span><span class="p">)</span>
</span><span id="__span-40-50"><a id="__codelineno-40-50" name="__codelineno-40-50"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-40-51"><a id="__codelineno-40-51" name="__codelineno-40-51"></a><span class="w">        </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Print</span><span class="p">(</span><span class="s">&quot;&gt; &quot;</span><span class="p">)</span>
</span><span id="__span-40-52"><a id="__codelineno-40-52" name="__codelineno-40-52"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">!</span><span class="nx">sc</span><span class="p">.</span><span class="nx">Scan</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">break</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-40-53"><a id="__codelineno-40-53" name="__codelineno-40-53"></a><span class="w">        </span><span class="nx">txt</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">strings</span><span class="p">.</span><span class="nx">TrimSpace</span><span class="p">(</span><span class="nx">sc</span><span class="p">.</span><span class="nx">Text</span><span class="p">())</span>
</span><span id="__span-40-54"><a id="__codelineno-40-54" name="__codelineno-40-54"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">txt</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;exit&quot;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">break</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-40-55"><a id="__codelineno-40-55" name="__codelineno-40-55"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">txt</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">continue</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-40-56"><a id="__codelineno-40-56" name="__codelineno-40-56"></a><span class="w">        </span><span class="nx">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">model</span><span class="p">.</span><span class="nx">NewUserMessage</span><span class="p">(</span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;compute %s&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">txt</span><span class="p">))</span>
</span><span id="__span-40-57"><a id="__codelineno-40-57" name="__codelineno-40-57"></a><span class="w">        </span><span class="nx">evts</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">app</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Background</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;user&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;s-%d&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">().</span><span class="nx">UnixNano</span><span class="p">()),</span><span class="w"> </span><span class="nx">msg</span><span class="p">,</span><span class="w"> </span><span class="nx">agent</span><span class="p">.</span><span class="nx">WithRuntimeState</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="s">&quot;n&quot;</span><span class="p">:</span><span class="w"> </span><span class="nx">atoi</span><span class="p">(</span><span class="nx">txt</span><span class="p">)}))</span>
</span><span id="__span-40-58"><a id="__codelineno-40-58" name="__codelineno-40-58"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;run error:&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">);</span><span class="w"> </span><span class="k">continue</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-40-59"><a id="__codelineno-40-59" name="__codelineno-40-59"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="nx">e</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">evts</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-40-60"><a id="__codelineno-40-60" name="__codelineno-40-60"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">Response</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">Response</span><span class="p">.</span><span class="nx">Object</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">ObjectTypeGraphNodeComplete</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-40-61"><a id="__codelineno-40-61" name="__codelineno-40-61"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">StateDelta</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">StateDelta</span><span class="p">[</span><span class="s">&quot;_cache_hit&quot;</span><span class="p">];</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;cache hit&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-40-62"><a id="__codelineno-40-62" name="__codelineno-40-62"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-40-63"><a id="__codelineno-40-63" name="__codelineno-40-63"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">e</span><span class="p">.</span><span class="nx">Done</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">break</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-40-64"><a id="__codelineno-40-64" name="__codelineno-40-64"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-40-65"><a id="__codelineno-40-65" name="__codelineno-40-65"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-40-66"><a id="__codelineno-40-66" name="__codelineno-40-66"></a><span class="p">}</span>
</span><span id="__span-40-67"><a id="__codelineno-40-67" name="__codelineno-40-67"></a>
</span><span id="__span-40-68"><a id="__codelineno-40-68" name="__codelineno-40-68"></a><span class="kd">func</span><span class="w"> </span><span class="nx">atoi</span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="nx">n</span><span class="w"> </span><span class="kt">int</span><span class="p">;</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sscanf</span><span class="p">(</span><span class="nx">s</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;%d&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">n</span><span class="p">);</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">n</span><span class="w"> </span><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>示例：
- 交互式（Interactive）+ Runner + GraphAgent 演示：<code>examples/graph/nodecache</code>，入口 <a href="https://github.com/trpc-group/trpc-agent-go/blob/main/examples/graph/nodecache/main.go">examples/graph/nodecache/main.go</a></p>
<h4 id="tools">Tools 节点</h4>
<p>执行工具调用，注意是<strong>顺序执行</strong>：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-41-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-41-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-41-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-41-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-41-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-41-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-41-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-41-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-41-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-41-10">10</a></span>
<span class="normal"><a href="#__codelineno-41-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-41-1"><a id="__codelineno-41-1" name="__codelineno-41-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-41-2"><a id="__codelineno-41-2" name="__codelineno-41-2"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-41-3"><a id="__codelineno-41-3" name="__codelineno-41-3"></a><span class="p">)</span>
</span><span id="__span-41-4"><a id="__codelineno-41-4" name="__codelineno-41-4"></a>
</span><span id="__span-41-5"><a id="__codelineno-41-5" name="__codelineno-41-5"></a><span class="kd">const</span><span class="w"> </span><span class="nx">nodeTools</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;tools&quot;</span>
</span><span id="__span-41-6"><a id="__codelineno-41-6" name="__codelineno-41-6"></a>
</span><span id="__span-41-7"><a id="__codelineno-41-7" name="__codelineno-41-7"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddToolsNode</span><span class="p">(</span><span class="nx">nodeTools</span><span class="p">,</span><span class="w"> </span><span class="nx">tools</span><span class="p">)</span>
</span><span id="__span-41-8"><a id="__codelineno-41-8" name="__codelineno-41-8"></a><span class="c1">// 多个工具会按 LLM 返回的顺序依次执行</span>
</span><span id="__span-41-9"><a id="__codelineno-41-9" name="__codelineno-41-9"></a><span class="c1">// 如需并行，应该使用多个节点 + 并行边</span>
</span><span id="__span-41-10"><a id="__codelineno-41-10" name="__codelineno-41-10"></a><span class="c1">// 配对规则：从 messages 尾部回溯定位最近的 assistant(tool_calls)</span>
</span><span id="__span-41-11"><a id="__codelineno-41-11" name="__codelineno-41-11"></a><span class="c1">// 消息，遇到新的 user 即停止，确保与本轮工具调用配对。</span>
</span></code></pre></div></td></tr></table></div>
<h4 id="state">将工具结果写入 State</h4>
<p>在 Tools 节点之后，添加一个函数节点，从 <code>graph.StateKeyMessages</code> 汇总工具结果并写入结构化 State：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-42-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-42-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-42-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-42-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-42-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-42-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-42-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-42-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-42-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-42-10">10</a></span>
<span class="normal"><a href="#__codelineno-42-11">11</a></span>
<span class="normal"><a href="#__codelineno-42-12">12</a></span>
<span class="normal"><a href="#__codelineno-42-13">13</a></span>
<span class="normal"><a href="#__codelineno-42-14">14</a></span>
<span class="normal"><a href="#__codelineno-42-15">15</a></span>
<span class="normal"><a href="#__codelineno-42-16">16</a></span>
<span class="normal"><a href="#__codelineno-42-17">17</a></span>
<span class="normal"><a href="#__codelineno-42-18">18</a></span>
<span class="normal"><a href="#__codelineno-42-19">19</a></span>
<span class="normal"><a href="#__codelineno-42-20">20</a></span>
<span class="normal"><a href="#__codelineno-42-21">21</a></span>
<span class="normal"><a href="#__codelineno-42-22">22</a></span>
<span class="normal"><a href="#__codelineno-42-23">23</a></span>
<span class="normal"><a href="#__codelineno-42-24">24</a></span>
<span class="normal"><a href="#__codelineno-42-25">25</a></span>
<span class="normal"><a href="#__codelineno-42-26">26</a></span>
<span class="normal"><a href="#__codelineno-42-27">27</a></span>
<span class="normal"><a href="#__codelineno-42-28">28</a></span>
<span class="normal"><a href="#__codelineno-42-29">29</a></span>
<span class="normal"><a href="#__codelineno-42-30">30</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-42-1"><a id="__codelineno-42-1" name="__codelineno-42-1"></a><span class="kd">const</span><span class="w"> </span><span class="nx">stateKeyToolResults</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;tool_results&quot;</span>
</span><span id="__span-42-2"><a id="__codelineno-42-2" name="__codelineno-42-2"></a>
</span><span id="__span-42-3"><a id="__codelineno-42-3" name="__codelineno-42-3"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;collect_tool_results&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-42-4"><a id="__codelineno-42-4" name="__codelineno-42-4"></a><span class="w">    </span><span class="nx">msgs</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">s</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyMessages</span><span class="p">].([]</span><span class="nx">model</span><span class="p">.</span><span class="nx">Message</span><span class="p">)</span>
</span><span id="__span-42-5"><a id="__codelineno-42-5" name="__codelineno-42-5"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">msgs</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-42-6"><a id="__codelineno-42-6" name="__codelineno-42-6"></a>
</span><span id="__span-42-7"><a id="__codelineno-42-7" name="__codelineno-42-7"></a><span class="w">    </span><span class="c1">// 定位本轮 assistant(tool_calls)</span>
</span><span id="__span-42-8"><a id="__codelineno-42-8" name="__codelineno-42-8"></a><span class="w">    </span><span class="nx">i</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">msgs</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-42-9"><a id="__codelineno-42-9" name="__codelineno-42-9"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">!(</span><span class="nx">msgs</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">Role</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">model</span><span class="p">.</span><span class="nx">RoleAssistant</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">msgs</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">ToolCalls</span><span class="p">)</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-42-10"><a id="__codelineno-42-10" name="__codelineno-42-10"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">msgs</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">Role</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">model</span><span class="p">.</span><span class="nx">RoleUser</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// 新一轮，停止</span>
</span><span id="__span-42-11"><a id="__codelineno-42-11" name="__codelineno-42-11"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-42-12"><a id="__codelineno-42-12" name="__codelineno-42-12"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-42-13"><a id="__codelineno-42-13" name="__codelineno-42-13"></a><span class="w">        </span><span class="nx">i</span><span class="o">--</span>
</span><span id="__span-42-14"><a id="__codelineno-42-14" name="__codelineno-42-14"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-42-15"><a id="__codelineno-42-15" name="__codelineno-42-15"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-42-16"><a id="__codelineno-42-16" name="__codelineno-42-16"></a>
</span><span id="__span-42-17"><a id="__codelineno-42-17" name="__codelineno-42-17"></a><span class="w">    </span><span class="c1">// 收集匹配的工具回复（按 ToolID 配对）</span>
</span><span id="__span-42-18"><a id="__codelineno-42-18" name="__codelineno-42-18"></a><span class="w">    </span><span class="nx">idset</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">bool</span><span class="p">{}</span>
</span><span id="__span-42-19"><a id="__codelineno-42-19" name="__codelineno-42-19"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">tc</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">msgs</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">ToolCalls</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">idset</span><span class="p">[</span><span class="nx">tc</span><span class="p">.</span><span class="nx">ID</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-42-20"><a id="__codelineno-42-20" name="__codelineno-42-20"></a><span class="w">    </span><span class="nx">results</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{}</span>
</span><span id="__span-42-21"><a id="__codelineno-42-21" name="__codelineno-42-21"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">j</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="nx">j</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">msgs</span><span class="p">);</span><span class="w"> </span><span class="nx">j</span><span class="o">++</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-42-22"><a id="__codelineno-42-22" name="__codelineno-42-22"></a><span class="w">        </span><span class="nx">m</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">msgs</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span>
</span><span id="__span-42-23"><a id="__codelineno-42-23" name="__codelineno-42-23"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">m</span><span class="p">.</span><span class="nx">Role</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">model</span><span class="p">.</span><span class="nx">RoleTool</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">idset</span><span class="p">[</span><span class="nx">m</span><span class="p">.</span><span class="nx">ToolID</span><span class="p">]</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-42-24"><a id="__codelineno-42-24" name="__codelineno-42-24"></a><span class="w">            </span><span class="nx">results</span><span class="p">[</span><span class="nx">m</span><span class="p">.</span><span class="nx">ToolName</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">m</span><span class="p">.</span><span class="nx">Content</span><span class="w"> </span><span class="c1">// 内容可能为 JSON/文本，依工具定义决定</span>
</span><span id="__span-42-25"><a id="__codelineno-42-25" name="__codelineno-42-25"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-42-26"><a id="__codelineno-42-26" name="__codelineno-42-26"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">m</span><span class="p">.</span><span class="nx">Role</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">model</span><span class="p">.</span><span class="nx">RoleUser</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">break</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-42-27"><a id="__codelineno-42-27" name="__codelineno-42-27"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-42-28"><a id="__codelineno-42-28" name="__codelineno-42-28"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">results</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-42-29"><a id="__codelineno-42-29" name="__codelineno-42-29"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="nx">stateKeyToolResults</span><span class="p">:</span><span class="w"> </span><span class="nx">results</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-42-30"><a id="__codelineno-42-30" name="__codelineno-42-30"></a><span class="p">})</span>
</span></code></pre></div></td></tr></table></div>
<p>参考示例：<code>examples/graph/io_conventions_tools</code>。
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-43-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-43-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-43-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-43-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-43-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-43-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-43-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-43-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-43-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-43-10">10</a></span>
<span class="normal"><a href="#__codelineno-43-11">11</a></span>
<span class="normal"><a href="#__codelineno-43-12">12</a></span>
<span class="normal"><a href="#__codelineno-43-13">13</a></span>
<span class="normal"><a href="#__codelineno-43-14">14</a></span>
<span class="normal"><a href="#__codelineno-43-15">15</a></span>
<span class="normal"><a href="#__codelineno-43-16">16</a></span>
<span class="normal"><a href="#__codelineno-43-17">17</a></span>
<span class="normal"><a href="#__codelineno-43-18">18</a></span>
<span class="normal"><a href="#__codelineno-43-19">19</a></span>
<span class="normal"><a href="#__codelineno-43-20">20</a></span>
<span class="normal"><a href="#__codelineno-43-21">21</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-43-1"><a id="__codelineno-43-1" name="__codelineno-43-1"></a>#### Agent 节点
</span><span id="__span-43-2"><a id="__codelineno-43-2" name="__codelineno-43-2"></a>嵌入子 Agent，实现多 Agent 协作：
</span><span id="__span-43-3"><a id="__codelineno-43-3" name="__codelineno-43-3"></a>
</span><span id="__span-43-4"><a id="__codelineno-43-4" name="__codelineno-43-4"></a>```go
</span><span id="__span-43-5"><a id="__codelineno-43-5" name="__codelineno-43-5"></a>import (
</span><span id="__span-43-6"><a id="__codelineno-43-6" name="__codelineno-43-6"></a>    &quot;trpc.group/trpc-go/trpc-agent-go/agent&quot;
</span><span id="__span-43-7"><a id="__codelineno-43-7" name="__codelineno-43-7"></a>    &quot;trpc.group/trpc-go/trpc-agent-go/agent/graphagent&quot;
</span><span id="__span-43-8"><a id="__codelineno-43-8" name="__codelineno-43-8"></a>)
</span><span id="__span-43-9"><a id="__codelineno-43-9" name="__codelineno-43-9"></a>
</span><span id="__span-43-10"><a id="__codelineno-43-10" name="__codelineno-43-10"></a>const (
</span><span id="__span-43-11"><a id="__codelineno-43-11" name="__codelineno-43-11"></a>    subAgentNameAnalyzer = &quot;analyzer&quot;
</span><span id="__span-43-12"><a id="__codelineno-43-12" name="__codelineno-43-12"></a>    graphAgentNameMain   = &quot;main&quot;
</span><span id="__span-43-13"><a id="__codelineno-43-13" name="__codelineno-43-13"></a>)
</span><span id="__span-43-14"><a id="__codelineno-43-14" name="__codelineno-43-14"></a>
</span><span id="__span-43-15"><a id="__codelineno-43-15" name="__codelineno-43-15"></a>// 重要：节点 ID 必须与子 Agent 名称一致
</span><span id="__span-43-16"><a id="__codelineno-43-16" name="__codelineno-43-16"></a>sg.AddAgentNode(subAgentNameAnalyzer)
</span><span id="__span-43-17"><a id="__codelineno-43-17" name="__codelineno-43-17"></a>
</span><span id="__span-43-18"><a id="__codelineno-43-18" name="__codelineno-43-18"></a>// Agent 实例在 GraphAgent 创建时注入
</span><span id="__span-43-19"><a id="__codelineno-43-19" name="__codelineno-43-19"></a>analyzer := createAnalyzer()  // 内部 Agent 名称必须是 &quot;analyzer&quot;
</span><span id="__span-43-20"><a id="__codelineno-43-20" name="__codelineno-43-20"></a>graphAgent, _ := graphagent.New(graphAgentNameMain, g,
</span><span id="__span-43-21"><a id="__codelineno-43-21" name="__codelineno-43-21"></a>    graphagent.WithSubAgents([]agent.Agent{analyzer}))
</span></code></pre></div></td></tr></table></div></p>
<h3 id="_16">边与路由</h3>
<p>边定义了节点间的执行流转：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-44-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-44-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-44-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-44-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-44-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-44-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-44-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-44-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-44-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-44-10">10</a></span>
<span class="normal"><a href="#__codelineno-44-11">11</a></span>
<span class="normal"><a href="#__codelineno-44-12">12</a></span>
<span class="normal"><a href="#__codelineno-44-13">13</a></span>
<span class="normal"><a href="#__codelineno-44-14">14</a></span>
<span class="normal"><a href="#__codelineno-44-15">15</a></span>
<span class="normal"><a href="#__codelineno-44-16">16</a></span>
<span class="normal"><a href="#__codelineno-44-17">17</a></span>
<span class="normal"><a href="#__codelineno-44-18">18</a></span>
<span class="normal"><a href="#__codelineno-44-19">19</a></span>
<span class="normal"><a href="#__codelineno-44-20">20</a></span>
<span class="normal"><a href="#__codelineno-44-21">21</a></span>
<span class="normal"><a href="#__codelineno-44-22">22</a></span>
<span class="normal"><a href="#__codelineno-44-23">23</a></span>
<span class="normal"><a href="#__codelineno-44-24">24</a></span>
<span class="normal"><a href="#__codelineno-44-25">25</a></span>
<span class="normal"><a href="#__codelineno-44-26">26</a></span>
<span class="normal"><a href="#__codelineno-44-27">27</a></span>
<span class="normal"><a href="#__codelineno-44-28">28</a></span>
<span class="normal"><a href="#__codelineno-44-29">29</a></span>
<span class="normal"><a href="#__codelineno-44-30">30</a></span>
<span class="normal"><a href="#__codelineno-44-31">31</a></span>
<span class="normal"><a href="#__codelineno-44-32">32</a></span>
<span class="normal"><a href="#__codelineno-44-33">33</a></span>
<span class="normal"><a href="#__codelineno-44-34">34</a></span>
<span class="normal"><a href="#__codelineno-44-35">35</a></span>
<span class="normal"><a href="#__codelineno-44-36">36</a></span>
<span class="normal"><a href="#__codelineno-44-37">37</a></span>
<span class="normal"><a href="#__codelineno-44-38">38</a></span>
<span class="normal"><a href="#__codelineno-44-39">39</a></span>
<span class="normal"><a href="#__codelineno-44-40">40</a></span>
<span class="normal"><a href="#__codelineno-44-41">41</a></span>
<span class="normal"><a href="#__codelineno-44-42">42</a></span>
<span class="normal"><a href="#__codelineno-44-43">43</a></span>
<span class="normal"><a href="#__codelineno-44-44">44</a></span>
<span class="normal"><a href="#__codelineno-44-45">45</a></span>
<span class="normal"><a href="#__codelineno-44-46">46</a></span>
<span class="normal"><a href="#__codelineno-44-47">47</a></span>
<span class="normal"><a href="#__codelineno-44-48">48</a></span>
<span class="normal"><a href="#__codelineno-44-49">49</a></span>
<span class="normal"><a href="#__codelineno-44-50">50</a></span>
<span class="normal"><a href="#__codelineno-44-51">51</a></span>
<span class="normal"><a href="#__codelineno-44-52">52</a></span>
<span class="normal"><a href="#__codelineno-44-53">53</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-44-1"><a id="__codelineno-44-1" name="__codelineno-44-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-44-2"><a id="__codelineno-44-2" name="__codelineno-44-2"></a><span class="w">    </span><span class="s">&quot;context&quot;</span>
</span><span id="__span-44-3"><a id="__codelineno-44-3" name="__codelineno-44-3"></a>
</span><span id="__span-44-4"><a id="__codelineno-44-4" name="__codelineno-44-4"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-44-5"><a id="__codelineno-44-5" name="__codelineno-44-5"></a><span class="p">)</span>
</span><span id="__span-44-6"><a id="__codelineno-44-6" name="__codelineno-44-6"></a>
</span><span id="__span-44-7"><a id="__codelineno-44-7" name="__codelineno-44-7"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-44-8"><a id="__codelineno-44-8" name="__codelineno-44-8"></a><span class="w">    </span><span class="nx">nodeA</span><span class="w">         </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;nodeA&quot;</span>
</span><span id="__span-44-9"><a id="__codelineno-44-9" name="__codelineno-44-9"></a><span class="w">    </span><span class="nx">nodeB</span><span class="w">         </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;nodeB&quot;</span>
</span><span id="__span-44-10"><a id="__codelineno-44-10" name="__codelineno-44-10"></a><span class="w">    </span><span class="nx">nodeDecision</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;decision&quot;</span>
</span><span id="__span-44-11"><a id="__codelineno-44-11" name="__codelineno-44-11"></a><span class="w">    </span><span class="nx">nodePathA</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;pathA&quot;</span>
</span><span id="__span-44-12"><a id="__codelineno-44-12" name="__codelineno-44-12"></a><span class="w">    </span><span class="nx">nodePathB</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;pathB&quot;</span>
</span><span id="__span-44-13"><a id="__codelineno-44-13" name="__codelineno-44-13"></a>
</span><span id="__span-44-14"><a id="__codelineno-44-14" name="__codelineno-44-14"></a><span class="w">    </span><span class="nx">routeToPathA</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;route_to_pathA&quot;</span>
</span><span id="__span-44-15"><a id="__codelineno-44-15" name="__codelineno-44-15"></a><span class="w">    </span><span class="nx">routeToPathB</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;route_to_pathB&quot;</span>
</span><span id="__span-44-16"><a id="__codelineno-44-16" name="__codelineno-44-16"></a><span class="w">    </span><span class="nx">stateKeyFlag</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;flag&quot;</span>
</span><span id="__span-44-17"><a id="__codelineno-44-17" name="__codelineno-44-17"></a><span class="p">)</span>
</span><span id="__span-44-18"><a id="__codelineno-44-18" name="__codelineno-44-18"></a>
</span><span id="__span-44-19"><a id="__codelineno-44-19" name="__codelineno-44-19"></a><span class="c1">// 普通边：顺序执行</span>
</span><span id="__span-44-20"><a id="__codelineno-44-20" name="__codelineno-44-20"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddEdge</span><span class="p">(</span><span class="nx">nodeA</span><span class="p">,</span><span class="w"> </span><span class="nx">nodeB</span><span class="p">)</span>
</span><span id="__span-44-21"><a id="__codelineno-44-21" name="__codelineno-44-21"></a>
</span><span id="__span-44-22"><a id="__codelineno-44-22" name="__codelineno-44-22"></a><span class="c1">// 条件边：动态路由（第三个参数为路径映射，建议显式提供以做静态校验）</span>
</span><span id="__span-44-23"><a id="__codelineno-44-23" name="__codelineno-44-23"></a><span class="c1">// 先定义目标节点</span>
</span><span id="__span-44-24"><a id="__codelineno-44-24" name="__codelineno-44-24"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="nx">nodePathA</span><span class="p">,</span><span class="w"> </span><span class="nx">handlerA</span><span class="p">)</span>
</span><span id="__span-44-25"><a id="__codelineno-44-25" name="__codelineno-44-25"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="nx">nodePathB</span><span class="p">,</span><span class="w"> </span><span class="nx">handlerB</span><span class="p">)</span>
</span><span id="__span-44-26"><a id="__codelineno-44-26" name="__codelineno-44-26"></a><span class="c1">// 再添加条件路由</span>
</span><span id="__span-44-27"><a id="__codelineno-44-27" name="__codelineno-44-27"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddConditionalEdges</span><span class="p">(</span><span class="nx">nodeDecision</span><span class="p">,</span><span class="w"> </span>
</span><span id="__span-44-28"><a id="__codelineno-44-28" name="__codelineno-44-28"></a><span class="w">    </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-44-29"><a id="__codelineno-44-29" name="__codelineno-44-29"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">s</span><span class="p">[</span><span class="nx">stateKeyFlag</span><span class="p">].(</span><span class="kt">bool</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-44-30"><a id="__codelineno-44-30" name="__codelineno-44-30"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">routeToPathA</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-44-31"><a id="__codelineno-44-31" name="__codelineno-44-31"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-44-32"><a id="__codelineno-44-32" name="__codelineno-44-32"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">routeToPathB</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-44-33"><a id="__codelineno-44-33" name="__codelineno-44-33"></a><span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span>
</span><span id="__span-44-34"><a id="__codelineno-44-34" name="__codelineno-44-34"></a><span class="w">        </span><span class="nx">routeToPathA</span><span class="p">:</span><span class="w"> </span><span class="nx">nodePathA</span><span class="p">,</span>
</span><span id="__span-44-35"><a id="__codelineno-44-35" name="__codelineno-44-35"></a><span class="w">        </span><span class="nx">routeToPathB</span><span class="p">:</span><span class="w"> </span><span class="nx">nodePathB</span><span class="p">,</span>
</span><span id="__span-44-36"><a id="__codelineno-44-36" name="__codelineno-44-36"></a><span class="w">    </span><span class="p">})</span>
</span><span id="__span-44-37"><a id="__codelineno-44-37" name="__codelineno-44-37"></a>
</span><span id="__span-44-38"><a id="__codelineno-44-38" name="__codelineno-44-38"></a><span class="c1">// 工具条件边：处理 LLM 工具调用</span>
</span><span id="__span-44-39"><a id="__codelineno-44-39" name="__codelineno-44-39"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-44-40"><a id="__codelineno-44-40" name="__codelineno-44-40"></a><span class="w">    </span><span class="nx">nodeLLM</span><span class="w">      </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;llm&quot;</span>
</span><span id="__span-44-41"><a id="__codelineno-44-41" name="__codelineno-44-41"></a><span class="w">    </span><span class="nx">nodeToolsUse</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;tools&quot;</span>
</span><span id="__span-44-42"><a id="__codelineno-44-42" name="__codelineno-44-42"></a><span class="w">    </span><span class="nx">nodeFallback</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;fallback&quot;</span>
</span><span id="__span-44-43"><a id="__codelineno-44-43" name="__codelineno-44-43"></a><span class="p">)</span>
</span><span id="__span-44-44"><a id="__codelineno-44-44" name="__codelineno-44-44"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddToolsConditionalEdges</span><span class="p">(</span><span class="nx">nodeLLM</span><span class="p">,</span><span class="w"> </span><span class="nx">nodeToolsUse</span><span class="p">,</span><span class="w"> </span><span class="nx">nodeFallback</span><span class="p">)</span>
</span><span id="__span-44-45"><a id="__codelineno-44-45" name="__codelineno-44-45"></a>
</span><span id="__span-44-46"><a id="__codelineno-44-46" name="__codelineno-44-46"></a><span class="c1">// 并行边：自动并行执行</span>
</span><span id="__span-44-47"><a id="__codelineno-44-47" name="__codelineno-44-47"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-44-48"><a id="__codelineno-44-48" name="__codelineno-44-48"></a><span class="w">    </span><span class="nx">nodeSplit</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;split&quot;</span>
</span><span id="__span-44-49"><a id="__codelineno-44-49" name="__codelineno-44-49"></a><span class="w">    </span><span class="nx">nodeBranch1</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;branch1&quot;</span>
</span><span id="__span-44-50"><a id="__codelineno-44-50" name="__codelineno-44-50"></a><span class="w">    </span><span class="nx">nodeBranch2</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;branch2&quot;</span>
</span><span id="__span-44-51"><a id="__codelineno-44-51" name="__codelineno-44-51"></a><span class="p">)</span>
</span><span id="__span-44-52"><a id="__codelineno-44-52" name="__codelineno-44-52"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddEdge</span><span class="p">(</span><span class="nx">nodeSplit</span><span class="p">,</span><span class="w"> </span><span class="nx">nodeBranch1</span><span class="p">)</span>
</span><span id="__span-44-53"><a id="__codelineno-44-53" name="__codelineno-44-53"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddEdge</span><span class="p">(</span><span class="nx">nodeSplit</span><span class="p">,</span><span class="w"> </span><span class="nx">nodeBranch2</span><span class="p">)</span><span class="w">  </span><span class="c1">// branch1 和 branch2 会并行执行</span>
</span></code></pre></div></td></tr></table></div>
<p>提示：设置入口与结束点时，会隐式连接到虚拟的 Start/End 节点：
- <code>SetEntryPoint("first")</code> 等效于创建 <code>Start -&gt; first</code> 的连边；
- <code>SetFinishPoint("last")</code> 等效于创建 <code>last -&gt; End</code> 的连边。
无需显式添加这两条边。</p>
<p>常量名：<code>graph.Start == "__start__"</code>，<code>graph.End == "__end__"</code>。</p>
<h3 id="fan-out">命令模式（动态路由 / Fan-out）</h3>
<p>节点除返回 <code>graph.State</code> 外，也可以返回 <code>*graph.Command</code> 或 <code>[]*graph.Command</code>，以同时更新状态并指定下一跳：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-45-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-45-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-45-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-45-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-45-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-45-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-45-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-45-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-45-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-45-10">10</a></span>
<span class="normal"><a href="#__codelineno-45-11">11</a></span>
<span class="normal"><a href="#__codelineno-45-12">12</a></span>
<span class="normal"><a href="#__codelineno-45-13">13</a></span>
<span class="normal"><a href="#__codelineno-45-14">14</a></span>
<span class="normal"><a href="#__codelineno-45-15">15</a></span>
<span class="normal"><a href="#__codelineno-45-16">16</a></span>
<span class="normal"><a href="#__codelineno-45-17">17</a></span>
<span class="normal"><a href="#__codelineno-45-18">18</a></span>
<span class="normal"><a href="#__codelineno-45-19">19</a></span>
<span class="normal"><a href="#__codelineno-45-20">20</a></span>
<span class="normal"><a href="#__codelineno-45-21">21</a></span>
<span class="normal"><a href="#__codelineno-45-22">22</a></span>
<span class="normal"><a href="#__codelineno-45-23">23</a></span>
<span class="normal"><a href="#__codelineno-45-24">24</a></span>
<span class="normal"><a href="#__codelineno-45-25">25</a></span>
<span class="normal"><a href="#__codelineno-45-26">26</a></span>
<span class="normal"><a href="#__codelineno-45-27">27</a></span>
<span class="normal"><a href="#__codelineno-45-28">28</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-45-1"><a id="__codelineno-45-1" name="__codelineno-45-1"></a><span class="c1">// 动态路由到 A 或 B，并写入状态</span>
</span><span id="__span-45-2"><a id="__codelineno-45-2" name="__codelineno-45-2"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-45-3"><a id="__codelineno-45-3" name="__codelineno-45-3"></a><span class="w">    </span><span class="nx">nodeDecide</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;decide&quot;</span>
</span><span id="__span-45-4"><a id="__codelineno-45-4" name="__codelineno-45-4"></a><span class="w">    </span><span class="nx">nodeA</span><span class="w">        </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;A&quot;</span>
</span><span id="__span-45-5"><a id="__codelineno-45-5" name="__codelineno-45-5"></a><span class="w">    </span><span class="nx">nodeB</span><span class="w">        </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;B&quot;</span>
</span><span id="__span-45-6"><a id="__codelineno-45-6" name="__codelineno-45-6"></a><span class="w">    </span><span class="nx">stateKeyFlag</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;flag&quot;</span>
</span><span id="__span-45-7"><a id="__codelineno-45-7" name="__codelineno-45-7"></a><span class="p">)</span>
</span><span id="__span-45-8"><a id="__codelineno-45-8" name="__codelineno-45-8"></a>
</span><span id="__span-45-9"><a id="__codelineno-45-9" name="__codelineno-45-9"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="nx">nodeDecide</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-45-10"><a id="__codelineno-45-10" name="__codelineno-45-10"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">s</span><span class="p">[</span><span class="nx">stateKeyFlag</span><span class="p">].(</span><span class="kt">bool</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-45-11"><a id="__codelineno-45-11" name="__codelineno-45-11"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">graph</span><span class="p">.</span><span class="nx">Command</span><span class="p">{</span><span class="nx">Update</span><span class="p">:</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="s">&quot;routed&quot;</span><span class="p">:</span><span class="w"> </span><span class="nx">nodeA</span><span class="p">},</span><span class="w"> </span><span class="nx">GoTo</span><span class="p">:</span><span class="w"> </span><span class="nx">nodeA</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-45-12"><a id="__codelineno-45-12" name="__codelineno-45-12"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-45-13"><a id="__codelineno-45-13" name="__codelineno-45-13"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">graph</span><span class="p">.</span><span class="nx">Command</span><span class="p">{</span><span class="nx">Update</span><span class="p">:</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="s">&quot;routed&quot;</span><span class="p">:</span><span class="w"> </span><span class="nx">nodeB</span><span class="p">},</span><span class="w"> </span><span class="nx">GoTo</span><span class="p">:</span><span class="w"> </span><span class="nx">nodeB</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-45-14"><a id="__codelineno-45-14" name="__codelineno-45-14"></a><span class="p">})</span>
</span><span id="__span-45-15"><a id="__codelineno-45-15" name="__codelineno-45-15"></a>
</span><span id="__span-45-16"><a id="__codelineno-45-16" name="__codelineno-45-16"></a><span class="c1">// Fan-out：并行派发多个任务到同一 worker</span>
</span><span id="__span-45-17"><a id="__codelineno-45-17" name="__codelineno-45-17"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-45-18"><a id="__codelineno-45-18" name="__codelineno-45-18"></a><span class="w">    </span><span class="nx">nodeFanout</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;fanout&quot;</span>
</span><span id="__span-45-19"><a id="__codelineno-45-19" name="__codelineno-45-19"></a><span class="w">    </span><span class="nx">nodeWorker</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;worker&quot;</span>
</span><span id="__span-45-20"><a id="__codelineno-45-20" name="__codelineno-45-20"></a><span class="p">)</span>
</span><span id="__span-45-21"><a id="__codelineno-45-21" name="__codelineno-45-21"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="nx">nodeFanout</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-45-22"><a id="__codelineno-45-22" name="__codelineno-45-22"></a><span class="w">    </span><span class="nx">cmds</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">[]</span><span class="o">*</span><span class="nx">graph</span><span class="p">.</span><span class="nx">Command</span><span class="p">{</span>
</span><span id="__span-45-23"><a id="__codelineno-45-23" name="__codelineno-45-23"></a><span class="w">        </span><span class="p">{</span><span class="nx">Update</span><span class="p">:</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="s">&quot;param&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;A&quot;</span><span class="p">},</span><span class="w"> </span><span class="nx">GoTo</span><span class="p">:</span><span class="w"> </span><span class="nx">nodeWorker</span><span class="p">},</span>
</span><span id="__span-45-24"><a id="__codelineno-45-24" name="__codelineno-45-24"></a><span class="w">        </span><span class="p">{</span><span class="nx">Update</span><span class="p">:</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="s">&quot;param&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;B&quot;</span><span class="p">},</span><span class="w"> </span><span class="nx">GoTo</span><span class="p">:</span><span class="w"> </span><span class="nx">nodeWorker</span><span class="p">},</span>
</span><span id="__span-45-25"><a id="__codelineno-45-25" name="__codelineno-45-25"></a><span class="w">        </span><span class="p">{</span><span class="nx">Update</span><span class="p">:</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="s">&quot;param&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;C&quot;</span><span class="p">},</span><span class="w"> </span><span class="nx">GoTo</span><span class="p">:</span><span class="w"> </span><span class="nx">nodeWorker</span><span class="p">},</span>
</span><span id="__span-45-26"><a id="__codelineno-45-26" name="__codelineno-45-26"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-45-27"><a id="__codelineno-45-27" name="__codelineno-45-27"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">cmds</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-45-28"><a id="__codelineno-45-28" name="__codelineno-45-28"></a><span class="p">})</span>
</span></code></pre></div></td></tr></table></div>
<p>使用命令模式进行路由时，无需为 <code>GoTo</code> 目标添加显式静态边；仅需保证目标节点存在，并在需要作为终点时设置 <code>SetFinishPoint</code>。</p>
<h2 id="_17">架构设计</h2>
<h3 id="_18">整体架构</h3>
<p>GraphAgent 的架构设计体现了我们对复杂系统的理解：通过清晰的分层来管理复杂性。每一层都有明确的职责，层与层之间通过标准接口通信。</p>
<pre class="mermaid"><code>flowchart TB
    subgraph "Runner Layer"
        R[Runner]:::runnerClass
        S[Session Service]:::sessionClass
    end

    subgraph "GraphAgent"
        GA[GraphAgent Wrapper]:::agentClass
        CB[Callbacks]:::callbackClass
    end

    subgraph "Graph Engine"
        SG[StateGraph Builder]:::builderClass
        G[Graph]:::graphClass
        E[Executor]:::executorClass
    end

    subgraph "Execution Components"
        P[Planning]:::phaseClass
        EX[Execution]:::phaseClass
        U[Update]:::phaseClass
    end

    subgraph "Storage"
        CP[Checkpoint]:::storageClass
        ST[State Store]:::storageClass
    end

    R --&gt; GA
    GA --&gt; G
    G --&gt; E
    E --&gt; P
    E --&gt; EX
    E --&gt; U
    E --&gt; CP

    classDef runnerClass fill:#e8f5e9,stroke:#43a047,stroke-width:2px
    classDef sessionClass fill:#f3e5f5,stroke:#8e24aa,stroke-width:2px
    classDef agentClass fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    classDef callbackClass fill:#fce4ec,stroke:#c2185b,stroke-width:2px
    classDef builderClass fill:#fff8e1,stroke:#f57c00,stroke-width:2px
    classDef graphClass fill:#f1f8e9,stroke:#689f38,stroke-width:2px
    classDef executorClass fill:#e0f2f1,stroke:#00796b,stroke-width:2px
    classDef phaseClass fill:#ede7f6,stroke:#512da8,stroke-width:2px
    classDef storageClass fill:#efebe9,stroke:#5d4037,stroke-width:2px</code></pre>
<h3 id="_19">核心模块解析</h3>
<p>核心组件一览：</p>
<p><strong><code>graph/state_graph.go</code></strong> - StateGraph 构建器<br />
提供链式声明式 Go API 来构建图结构，通过 fluent 方法链（AddNode → AddEdge → Compile）定义节点、边和条件路由。</p>
<p><strong><code>graph/graph.go</code></strong> - 编译后的运行时<br />
实现基于通道（Channel）的事件触发式执行机制。节点执行结果合并入 State；通道仅用于触发路由，写入哨兵值（sentinel value）而非业务数据。</p>
<p><strong><code>graph/executor.go</code></strong> - BSP 执行器<br />
这是系统心脏，借鉴了 <a href="https://research.google/pubs/pub37252/">Google Pregel</a> 论文。实现 BSP（Bulk Synchronous Parallel）风格的三阶段循环：Planning → Execution → Update。</p>
<p><strong><code>graph/checkpoint/*</code></strong> - 检查点和恢复机制<br />
提供可选的检查点持久化（如 sqlite），原子保存状态与待写入动作，支持按谱系/检查点恢复。</p>
<p><strong><code>agent/graphagent/graph_agent.go</code></strong> - Graph 与 Agent 的桥梁<br />
将编译后的 Graph 适配为通用 Agent，可复用会话、回调与事件流。</p>
<h3 id="_20">执行模型</h3>
<p>GraphAgent 借鉴了 Google Pregel 的 BSP（Bulk Synchronous Parallel）模型，但适配到了单进程环境；在此基础上还支持检查点、HITL 中断/恢复与时间旅行：</p>
<pre class="mermaid"><code>sequenceDiagram
    autonumber
    participant R as Runner
    participant GA as GraphAgent
    participant EX as Executor
    participant CK as Checkpoint Saver
    participant DB as Storage
    participant H as Human

    R-&gt;&gt;GA: Run(invocation)
    GA-&gt;&gt;EX: Execute(graph, state, options)
    GA--&gt;&gt;R: Stream node/tool/model events

    loop 每个超级步 (BSP)
        EX-&gt;&gt;EX: Planning — 计算前沿(Frontier)
        par 并行执行节点
            EX-&gt;&gt;EX: 执行节点 i（状态浅拷贝）
            EX--&gt;&gt;GA: 节点开始事件(author=nodeID)
        and
            EX-&gt;&gt;EX: 执行节点 j（状态浅拷贝）
            EX--&gt;&gt;GA: 节点开始事件
        end

        alt 节点触发 Interrupt(key,prompt)
            EX-&gt;&gt;CK: Save checkpoint(state,frontier,
            EX-&gt;&gt;CK: pending_writes,versions_seen,reason=interrupt)
            CK-&gt;&gt;DB: 原子提交
            EX--&gt;&gt;GA: interrupt 事件(checkpoint_id,prompt)
            GA--&gt;&gt;R: 转发中断事件并暂停
            R-&gt;&gt;H: 请求人工输入/审批
            H--&gt;&gt;R: 提交决策/值
            R-&gt;&gt;GA: Run(resume) runtime_state{
            R-&gt;&gt;GA: checkpoint_id,resume_map}
            GA-&gt;&gt;EX: ResumeFromCheckpoint(checkpoint_id,resume_map)
            EX-&gt;&gt;CK: Load checkpoint
            CK-&gt;&gt;EX: state/frontier/pending_writes/versions_seen
            EX-&gt;&gt;EX: 重建前沿并应用恢复值
        else 正常执行
            EX--&gt;&gt;GA: 节点完成事件（含 tool/model 事件）
            EX-&gt;&gt;EX: Update — Reducer 合并状态
            EX-&gt;&gt;CK: Save checkpoint(state,frontier,
            EX-&gt;&gt;CK: pending_writes,versions_seen)
            CK-&gt;&gt;DB: 原子提交
        end
    end

    Note over EX,CK: versions_seen 避免重复执行；
    Note over EX,CK: pending_writes 重建通道；
    Note over EX,CK: parent_id 形成谱系以支持时间旅行

    opt 时间旅行（回溯/分支）
        R-&gt;&gt;GA: Run(runtime_state{checkpoint_id})
        GA-&gt;&gt;EX: ResumeFromCheckpoint(checkpoint_id)
        EX-&gt;&gt;CK: Load checkpoint + lineage
        CK-&gt;&gt;EX: 恢复状态并可创建新 lineage_id
    end

    EX--&gt;&gt;GA: done 事件（last_response）
    GA--&gt;&gt;R: 输出最终消息</code></pre>
<pre class="mermaid"><code>flowchart TB
    %% 执行全景图（精简连线）
    subgraph Client
        R[Runner]:::runner --&gt; GA[GraphAgent]:::agent
    end

    subgraph Engine[Graph Engine]
        GA --&gt; EX[Executor]:::executor
        subgraph BSP["BSP Superstep"]
            P[Planning]:::phase --&gt; X[Execution]:::phase --&gt; U[Update]:::phase
        end
    end

    N[Nodes: LLM / Tools / Function / Agent]:::process
    CK[(Checkpoint)]:::storage
    H[Human]:::human

    EX --&gt; BSP
    EX --&gt; N
    EX -.-&gt; CK
    GA &lt;--&gt; H
    GA --&gt; R

    classDef runner fill:#e8f5e9,stroke:#43a047,stroke-width:2px
    classDef agent fill:#e3f2fd,stroke:#1976d2,stroke-width:2px
    classDef executor fill:#e0f2f1,stroke:#00796b,stroke-width:2px
    classDef phase fill:#ede7f6,stroke:#512da8,stroke-width:2px
    classDef process fill:#f3e5f5,stroke:#9c27b0,stroke-width:2px
    classDef storage fill:#efebe9,stroke:#6d4c41,stroke-width:2px
    classDef human fill:#e8f5e9,stroke:#43a047,stroke-width:2px</code></pre>
<p>执行过程的关键点：</p>
<ol>
<li><strong>Planning Phase</strong>: 基于通道状态确定本步要执行的节点</li>
<li><strong>Execution Phase</strong>: 每个节点获得状态的浅拷贝（maps.Copy），并行执行</li>
<li><strong>Update Phase</strong>: 通过 Reducer 合并各节点的状态更新，保证并发安全</li>
</ol>
<p>这种设计让每一步都能被清晰观测、安全中断和恢复。</p>
<h4 id="_21">运行态隔离与事件快照</h4>
<ul>
<li>执行器（Executor）可复用且并发安全，单次运行态存放于 <code>ExecutionContext</code>，包括通道版本、待写（pending writes）、最近检查点等。</li>
<li>事件的 <code>StateDelta</code> 使用深拷贝快照，只包含可序列化且允许的键；内部键（如执行上下文、回调等）会被过滤，便于带外观测与持久化。</li>
</ul>
<h3 id="_22">执行器配置</h3>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-46-1">1</a></span>
<span class="normal"><a href="#__codelineno-46-2">2</a></span>
<span class="normal"><a href="#__codelineno-46-3">3</a></span>
<span class="normal"><a href="#__codelineno-46-4">4</a></span>
<span class="normal"><a href="#__codelineno-46-5">5</a></span>
<span class="normal"><a href="#__codelineno-46-6">6</a></span>
<span class="normal"><a href="#__codelineno-46-7">7</a></span>
<span class="normal"><a href="#__codelineno-46-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-46-1"><a id="__codelineno-46-1" name="__codelineno-46-1"></a><span class="nx">exec</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewExecutor</span><span class="p">(</span><span class="nx">g</span><span class="p">,</span>
</span><span id="__span-46-2"><a id="__codelineno-46-2" name="__codelineno-46-2"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithChannelBufferSize</span><span class="p">(</span><span class="mi">1024</span><span class="p">),</span><span class="w">              </span><span class="c1">// 事件通道缓冲</span>
</span><span id="__span-46-3"><a id="__codelineno-46-3" name="__codelineno-46-3"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithMaxSteps</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span><span class="w">                          </span><span class="c1">// 最大步数</span>
</span><span id="__span-46-4"><a id="__codelineno-46-4" name="__codelineno-46-4"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithStepTimeout</span><span class="p">(</span><span class="mi">5</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span><span class="p">),</span><span class="w">            </span><span class="c1">// 步骤超时</span>
</span><span id="__span-46-5"><a id="__codelineno-46-5" name="__codelineno-46-5"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithNodeTimeout</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span><span class="p">),</span><span class="w">            </span><span class="c1">// 节点超时</span>
</span><span id="__span-46-6"><a id="__codelineno-46-6" name="__codelineno-46-6"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithCheckpointSaver</span><span class="p">(</span><span class="nx">saver</span><span class="p">),</span><span class="w">                </span><span class="c1">// 开启检查点（如 sqlite/inmemory）</span>
</span><span id="__span-46-7"><a id="__codelineno-46-7" name="__codelineno-46-7"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithCheckpointSaveTimeout</span><span class="p">(</span><span class="mi">30</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">),</span><span class="w"> </span><span class="c1">// 检查点保存超时</span>
</span><span id="__span-46-8"><a id="__codelineno-46-8" name="__codelineno-46-8"></a><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<h2 id="agent_1">与多 Agent 系统集成</h2>
<p>GraphAgent 的设计初衷就是成为 tRPC-Agent-Go 多 Agent 生态的一部分，而不是独立存在。它实现了标准的 Agent 接口，可以和其他 Agent 类型无缝协作。</p>
<h3 id="graphagent-agent">GraphAgent 作为 Agent</h3>
<p>GraphAgent 实现了标准 Agent 接口：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-47-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-47-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-47-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-47-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-47-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-47-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-47-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-47-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-47-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-47-10">10</a></span>
<span class="normal"><a href="#__codelineno-47-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-47-1"><a id="__codelineno-47-1" name="__codelineno-47-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-47-2"><a id="__codelineno-47-2" name="__codelineno-47-2"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/agent&quot;</span>
</span><span id="__span-47-3"><a id="__codelineno-47-3" name="__codelineno-47-3"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/agent/chainagent&quot;</span>
</span><span id="__span-47-4"><a id="__codelineno-47-4" name="__codelineno-47-4"></a><span class="p">)</span>
</span><span id="__span-47-5"><a id="__codelineno-47-5" name="__codelineno-47-5"></a>
</span><span id="__span-47-6"><a id="__codelineno-47-6" name="__codelineno-47-6"></a><span class="c1">// 可以直接在 ChainAgent, ParallelAgent, CycleAgent 中使用</span>
</span><span id="__span-47-7"><a id="__codelineno-47-7" name="__codelineno-47-7"></a><span class="nx">chain</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">chainagent</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;chain&quot;</span><span class="p">,</span>
</span><span id="__span-47-8"><a id="__codelineno-47-8" name="__codelineno-47-8"></a><span class="w">    </span><span class="nx">chainagent</span><span class="p">.</span><span class="nx">WithSubAgents</span><span class="p">([]</span><span class="nx">agent</span><span class="p">.</span><span class="nx">Agent</span><span class="p">{</span>
</span><span id="__span-47-9"><a id="__codelineno-47-9" name="__codelineno-47-9"></a><span class="w">        </span><span class="nx">graphAgent1</span><span class="p">,</span><span class="w">  </span><span class="c1">// 结构化流程1</span>
</span><span id="__span-47-10"><a id="__codelineno-47-10" name="__codelineno-47-10"></a><span class="w">        </span><span class="nx">graphAgent2</span><span class="p">,</span><span class="w">  </span><span class="c1">// 结构化流程2</span>
</span><span id="__span-47-11"><a id="__codelineno-47-11" name="__codelineno-47-11"></a><span class="w">    </span><span class="p">}))</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="_23">高级编排</h3>
<p>下图展示复杂业务编排：入口清洗 → 智能路由 → 多子编队（Email、Weather、Research）→ 并行 fanout/聚合 → 最终合成与发布。</p>
<pre class="mermaid"><code>flowchart LR
    %% Layout
    subgraph UE["User &amp; Entry"]
        U((User)):::human --&gt; IN["entry&lt;br/&gt;normalize"]:::process
    end

    subgraph FAB["Graph Orchestration"]
        Rtr["where_to_go&lt;br/&gt;router"]:::router
        Compose["compose&lt;br/&gt;LLM"]:::llm
    end

    IN --&gt; Rtr

    %% Email Agent (expanded)
    subgraph EC["Email Agent"]
        direction LR
        CE["classifier&lt;br/&gt;LLM"]:::llm --&gt; WE["writer&lt;br/&gt;LLM"]:::llm
    end

    %% Weather Agent (expanded)
    subgraph WA["Weather Agent"]
        direction LR
        LE["locate&lt;br/&gt;LLM"]:::llm --&gt; WT["weather tool"]:::tool
    end

    %% Routing from router to pods
    Rtr -- email --&gt; CE
    Rtr -- weather --&gt; LE
    Rtr -- other --&gt; REPLY["reply&lt;br/&gt;LLM"]:::llm

    %% Fanout Pipeline (fanout → workers → aggregate)
    subgraph FP["Fanout Pipeline"]
        direction LR
        Fan["plan_fanout"]:::process --&gt; W1["worker A"]:::process
        Fan --&gt; W2["worker B"]:::process
        Fan --&gt; W3["worker C"]:::process
        W1 --&gt; Agg["aggregate"]:::process
        W2 --&gt; Agg
        W3 --&gt; Agg
    end
    Rtr -- research --&gt; Fan

    %% Human-in-the-loop (optional)
    Compose -. review .- HG["human&lt;br/&gt;review"]:::human

    %% Compose final (minimal wiring)
    Agg --&gt; Compose
    WE --&gt; Compose
    WT --&gt; Compose
    REPLY --&gt; Compose
    Compose --&gt; END([END]):::terminal

    %% Styles
    classDef router fill:#fff7e0,stroke:#f5a623,stroke-width:2px
    classDef llm fill:#e3f2fd,stroke:#1e88e5,stroke-width:2px
    classDef tool fill:#fff3e0,stroke:#fb8c00,stroke-width:2px
    classDef process fill:#f3e5f5,stroke:#8e24aa,stroke-width:2px
    classDef human fill:#e8f5e9,stroke:#43a047,stroke-width:2px
    classDef terminal fill:#ffebee,stroke:#e53935,stroke-width:2px</code></pre>
<p>要点：
- 智能路由 where_to_go 可由 LLM 决策或函数节点实现（条件边）。
- Fanout Pipeline 使用 Command GoTo 进行运行时 fanout，三路并行后在 aggregate 节点聚合。
- 可选的人机把关位于聚合之后，确保关键输出经人工确认。
- 仅在 Compose 处展示一次保存检查点，既不喧宾夺主，又能体现可恢复能力。</p>
<h3 id="agent_2">在图中嵌入 Agent</h3>
<p>在图内部，我们也可以把已有的子 Agent 作为一个节点来调用。下面的示例展示了如何创建子 Agent、声明对应节点，并在 GraphAgent 构造时注入。</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-48-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-48-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-48-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-48-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-48-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-48-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-48-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-48-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-48-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-48-10">10</a></span>
<span class="normal"><a href="#__codelineno-48-11">11</a></span>
<span class="normal"><a href="#__codelineno-48-12">12</a></span>
<span class="normal"><a href="#__codelineno-48-13">13</a></span>
<span class="normal"><a href="#__codelineno-48-14">14</a></span>
<span class="normal"><a href="#__codelineno-48-15">15</a></span>
<span class="normal"><a href="#__codelineno-48-16">16</a></span>
<span class="normal"><a href="#__codelineno-48-17">17</a></span>
<span class="normal"><a href="#__codelineno-48-18">18</a></span>
<span class="normal"><a href="#__codelineno-48-19">19</a></span>
<span class="normal"><a href="#__codelineno-48-20">20</a></span>
<span class="normal"><a href="#__codelineno-48-21">21</a></span>
<span class="normal"><a href="#__codelineno-48-22">22</a></span>
<span class="normal"><a href="#__codelineno-48-23">23</a></span>
<span class="normal"><a href="#__codelineno-48-24">24</a></span>
<span class="normal"><a href="#__codelineno-48-25">25</a></span>
<span class="normal"><a href="#__codelineno-48-26">26</a></span>
<span class="normal"><a href="#__codelineno-48-27">27</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-48-1"><a id="__codelineno-48-1" name="__codelineno-48-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-48-2"><a id="__codelineno-48-2" name="__codelineno-48-2"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/agent&quot;</span>
</span><span id="__span-48-3"><a id="__codelineno-48-3" name="__codelineno-48-3"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/agent/graphagent&quot;</span>
</span><span id="__span-48-4"><a id="__codelineno-48-4" name="__codelineno-48-4"></a><span class="p">)</span>
</span><span id="__span-48-5"><a id="__codelineno-48-5" name="__codelineno-48-5"></a>
</span><span id="__span-48-6"><a id="__codelineno-48-6" name="__codelineno-48-6"></a><span class="c1">// 创建子 Agent</span>
</span><span id="__span-48-7"><a id="__codelineno-48-7" name="__codelineno-48-7"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-48-8"><a id="__codelineno-48-8" name="__codelineno-48-8"></a><span class="w">    </span><span class="nx">subAgentAnalyzer</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;analyzer&quot;</span>
</span><span id="__span-48-9"><a id="__codelineno-48-9" name="__codelineno-48-9"></a><span class="w">    </span><span class="nx">subAgentReviewer</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;reviewer&quot;</span>
</span><span id="__span-48-10"><a id="__codelineno-48-10" name="__codelineno-48-10"></a><span class="p">)</span>
</span><span id="__span-48-11"><a id="__codelineno-48-11" name="__codelineno-48-11"></a><span class="nx">analyzer</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">createAnalyzer</span><span class="p">()</span><span class="w">  </span><span class="c1">// 名称必须是 &quot;analyzer&quot;</span>
</span><span id="__span-48-12"><a id="__codelineno-48-12" name="__codelineno-48-12"></a><span class="nx">reviewer</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">createReviewer</span><span class="p">()</span><span class="w">  </span><span class="c1">// 名称必须是 &quot;reviewer&quot;</span>
</span><span id="__span-48-13"><a id="__codelineno-48-13" name="__codelineno-48-13"></a>
</span><span id="__span-48-14"><a id="__codelineno-48-14" name="__codelineno-48-14"></a><span class="c1">// 在图中声明 Agent 节点</span>
</span><span id="__span-48-15"><a id="__codelineno-48-15" name="__codelineno-48-15"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddAgentNode</span><span class="p">(</span><span class="nx">subAgentAnalyzer</span><span class="p">)</span>
</span><span id="__span-48-16"><a id="__codelineno-48-16" name="__codelineno-48-16"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddAgentNode</span><span class="p">(</span><span class="nx">subAgentReviewer</span><span class="p">)</span>
</span><span id="__span-48-17"><a id="__codelineno-48-17" name="__codelineno-48-17"></a>
</span><span id="__span-48-18"><a id="__codelineno-48-18" name="__codelineno-48-18"></a><span class="c1">// 创建 GraphAgent 时注入子 Agent</span>
</span><span id="__span-48-19"><a id="__codelineno-48-19" name="__codelineno-48-19"></a><span class="nx">graphAgent</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;workflow&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">g</span><span class="p">,</span>
</span><span id="__span-48-20"><a id="__codelineno-48-20" name="__codelineno-48-20"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithSubAgents</span><span class="p">([]</span><span class="nx">agent</span><span class="p">.</span><span class="nx">Agent</span><span class="p">{</span>
</span><span id="__span-48-21"><a id="__codelineno-48-21" name="__codelineno-48-21"></a><span class="w">        </span><span class="nx">analyzer</span><span class="p">,</span>
</span><span id="__span-48-22"><a id="__codelineno-48-22" name="__codelineno-48-22"></a><span class="w">        </span><span class="nx">reviewer</span><span class="p">,</span>
</span><span id="__span-48-23"><a id="__codelineno-48-23" name="__codelineno-48-23"></a><span class="w">    </span><span class="p">}))</span>
</span><span id="__span-48-24"><a id="__codelineno-48-24" name="__codelineno-48-24"></a>
</span><span id="__span-48-25"><a id="__codelineno-48-25" name="__codelineno-48-25"></a><span class="c1">// I/O：子 Agent 既会把 graph.StateKeyUserInput 作为消息传入，也能通过</span>
</span><span id="__span-48-26"><a id="__codelineno-48-26" name="__codelineno-48-26"></a><span class="c1">// inv.RunOptions.RuntimeState 读取完整图状态；完成后会更新</span>
</span><span id="__span-48-27"><a id="__codelineno-48-27" name="__codelineno-48-27"></a><span class="c1">// graph.StateKeyLastResponse 以及 graph.StateKeyNodeResponses[nodeID]</span>
</span></code></pre></div></td></tr></table></div>
<h4 id="last_response-user_input">只传结果：将 last_response 映射为下游 user_input</h4>
<blockquote>
<p>场景：A → B → C 互为黑盒，不希望下游读取完整会话，只需要上游的“结果文本”作为本轮输入。</p>
</blockquote>
<ul>
<li>方式一（无需依赖，推荐通用）：在目标 Agent 节点添加前置回调，把父态 <code>last_response</code> 写入 <code>user_input</code>，必要时开启“消息隔离”。</li>
</ul>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-49-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-49-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-49-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-49-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-49-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-49-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-49-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-49-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-49-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-49-10">10</a></span>
<span class="normal"><a href="#__codelineno-49-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-49-1"><a id="__codelineno-49-1" name="__codelineno-49-1"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddAgentNode</span><span class="p">(</span><span class="s">&quot;orchestrator&quot;</span><span class="p">,</span>
</span><span id="__span-49-2"><a id="__codelineno-49-2" name="__codelineno-49-2"></a><span class="w">    </span><span class="c1">// 将上游 last_response 设置为本轮 user_input</span>
</span><span id="__span-49-3"><a id="__codelineno-49-3" name="__codelineno-49-3"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithPreNodeCallback</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">cb</span><span class="w"> </span><span class="o">*</span><span class="nx">graph</span><span class="p">.</span><span class="nx">NodeCallbackContext</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-49-4"><a id="__codelineno-49-4" name="__codelineno-49-4"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">v</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">s</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyLastResponse</span><span class="p">].(</span><span class="kt">string</span><span class="p">);</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">v</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-49-5"><a id="__codelineno-49-5" name="__codelineno-49-5"></a><span class="w">            </span><span class="nx">s</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyUserInput</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">v</span>
</span><span id="__span-49-6"><a id="__codelineno-49-6" name="__codelineno-49-6"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-49-7"><a id="__codelineno-49-7" name="__codelineno-49-7"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-49-8"><a id="__codelineno-49-8" name="__codelineno-49-8"></a><span class="w">    </span><span class="p">}),</span>
</span><span id="__span-49-9"><a id="__codelineno-49-9" name="__codelineno-49-9"></a><span class="w">    </span><span class="c1">// 可选：隔离子 Agent 的会话注入，仅消费本轮 user_input</span>
</span><span id="__span-49-10"><a id="__codelineno-49-10" name="__codelineno-49-10"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithSubgraphIsolatedMessages</span><span class="p">(</span><span class="kc">true</span><span class="p">),</span>
</span><span id="__span-49-11"><a id="__codelineno-49-11" name="__codelineno-49-11"></a><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<ul>
<li>方式二（使用增强选项，更简洁）：</li>
</ul>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-50-1">1</a></span>
<span class="normal"><a href="#__codelineno-50-2">2</a></span>
<span class="normal"><a href="#__codelineno-50-3">3</a></span>
<span class="normal"><a href="#__codelineno-50-4">4</a></span>
<span class="normal"><a href="#__codelineno-50-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-50-1"><a id="__codelineno-50-1" name="__codelineno-50-1"></a><span class="c1">// 框架提供声明式 Option，自动执行 last_response → user_input 的映射</span>
</span><span id="__span-50-2"><a id="__codelineno-50-2" name="__codelineno-50-2"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddAgentNode</span><span class="p">(</span><span class="s">&quot;orchestrator&quot;</span><span class="p">,</span>
</span><span id="__span-50-3"><a id="__codelineno-50-3" name="__codelineno-50-3"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithSubgraphInputFromLastResponse</span><span class="p">(),</span>
</span><span id="__span-50-4"><a id="__codelineno-50-4" name="__codelineno-50-4"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithSubgraphIsolatedMessages</span><span class="p">(</span><span class="kc">true</span><span class="p">),</span><span class="w"> </span><span class="c1">// 可选，配合隔离达到“只传结果”</span>
</span><span id="__span-50-5"><a id="__codelineno-50-5" name="__codelineno-50-5"></a><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>说明：以上两种方式都能让 B 仅看到 A 的结果、C 仅看到 B 的结果；方式二更简洁，方式一零依赖、到处可用。</p>
<h3 id="_24">混合模式示例</h3>
<p>结构化流程中嵌入动态决策：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-51-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-51-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-51-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-51-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-51-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-51-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-51-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-51-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-51-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-51-10">10</a></span>
<span class="normal"><a href="#__codelineno-51-11">11</a></span>
<span class="normal"><a href="#__codelineno-51-12">12</a></span>
<span class="normal"><a href="#__codelineno-51-13">13</a></span>
<span class="normal"><a href="#__codelineno-51-14">14</a></span>
<span class="normal"><a href="#__codelineno-51-15">15</a></span>
<span class="normal"><a href="#__codelineno-51-16">16</a></span>
<span class="normal"><a href="#__codelineno-51-17">17</a></span>
<span class="normal"><a href="#__codelineno-51-18">18</a></span>
<span class="normal"><a href="#__codelineno-51-19">19</a></span>
<span class="normal"><a href="#__codelineno-51-20">20</a></span>
<span class="normal"><a href="#__codelineno-51-21">21</a></span>
<span class="normal"><a href="#__codelineno-51-22">22</a></span>
<span class="normal"><a href="#__codelineno-51-23">23</a></span>
<span class="normal"><a href="#__codelineno-51-24">24</a></span>
<span class="normal"><a href="#__codelineno-51-25">25</a></span>
<span class="normal"><a href="#__codelineno-51-26">26</a></span>
<span class="normal"><a href="#__codelineno-51-27">27</a></span>
<span class="normal"><a href="#__codelineno-51-28">28</a></span>
<span class="normal"><a href="#__codelineno-51-29">29</a></span>
<span class="normal"><a href="#__codelineno-51-30">30</a></span>
<span class="normal"><a href="#__codelineno-51-31">31</a></span>
<span class="normal"><a href="#__codelineno-51-32">32</a></span>
<span class="normal"><a href="#__codelineno-51-33">33</a></span>
<span class="normal"><a href="#__codelineno-51-34">34</a></span>
<span class="normal"><a href="#__codelineno-51-35">35</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-51-1"><a id="__codelineno-51-1" name="__codelineno-51-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-51-2"><a id="__codelineno-51-2" name="__codelineno-51-2"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/agent&quot;</span>
</span><span id="__span-51-3"><a id="__codelineno-51-3" name="__codelineno-51-3"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/agent/chainagent&quot;</span>
</span><span id="__span-51-4"><a id="__codelineno-51-4" name="__codelineno-51-4"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/agent/graphagent&quot;</span>
</span><span id="__span-51-5"><a id="__codelineno-51-5" name="__codelineno-51-5"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-51-6"><a id="__codelineno-51-6" name="__codelineno-51-6"></a><span class="p">)</span>
</span><span id="__span-51-7"><a id="__codelineno-51-7" name="__codelineno-51-7"></a>
</span><span id="__span-51-8"><a id="__codelineno-51-8" name="__codelineno-51-8"></a><span class="nx">sg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateGraph</span><span class="p">(</span><span class="nx">schema</span><span class="p">)</span>
</span><span id="__span-51-9"><a id="__codelineno-51-9" name="__codelineno-51-9"></a>
</span><span id="__span-51-10"><a id="__codelineno-51-10" name="__codelineno-51-10"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-51-11"><a id="__codelineno-51-11" name="__codelineno-51-11"></a><span class="w">    </span><span class="nx">nodePrepare</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;prepare&quot;</span>
</span><span id="__span-51-12"><a id="__codelineno-51-12" name="__codelineno-51-12"></a><span class="w">    </span><span class="nx">nodeAnalyzer</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;analyzer&quot;</span>
</span><span id="__span-51-13"><a id="__codelineno-51-13" name="__codelineno-51-13"></a><span class="w">    </span><span class="nx">nodeFinalize</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;finalize&quot;</span>
</span><span id="__span-51-14"><a id="__codelineno-51-14" name="__codelineno-51-14"></a><span class="p">)</span>
</span><span id="__span-51-15"><a id="__codelineno-51-15" name="__codelineno-51-15"></a>
</span><span id="__span-51-16"><a id="__codelineno-51-16" name="__codelineno-51-16"></a><span class="c1">// 结构化的数据准备</span>
</span><span id="__span-51-17"><a id="__codelineno-51-17" name="__codelineno-51-17"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="nx">nodePrepare</span><span class="p">,</span><span class="w"> </span><span class="nx">prepareData</span><span class="p">)</span>
</span><span id="__span-51-18"><a id="__codelineno-51-18" name="__codelineno-51-18"></a>
</span><span id="__span-51-19"><a id="__codelineno-51-19" name="__codelineno-51-19"></a><span class="c1">// 动态决策点 - 使用 ChainAgent</span>
</span><span id="__span-51-20"><a id="__codelineno-51-20" name="__codelineno-51-20"></a><span class="nx">dynamicAgent</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">chainagent</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="nx">nodeAnalyzer</span><span class="p">,</span>
</span><span id="__span-51-21"><a id="__codelineno-51-21" name="__codelineno-51-21"></a><span class="w">    </span><span class="nx">chainagent</span><span class="p">.</span><span class="nx">WithSubAgents</span><span class="p">([]</span><span class="nx">agent</span><span class="p">.</span><span class="nx">Agent</span><span class="p">{</span><span class="o">...</span><span class="p">}))</span>
</span><span id="__span-51-22"><a id="__codelineno-51-22" name="__codelineno-51-22"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddAgentNode</span><span class="p">(</span><span class="nx">nodeAnalyzer</span><span class="p">)</span>
</span><span id="__span-51-23"><a id="__codelineno-51-23" name="__codelineno-51-23"></a>
</span><span id="__span-51-24"><a id="__codelineno-51-24" name="__codelineno-51-24"></a><span class="c1">// 继续结构化流程</span>
</span><span id="__span-51-25"><a id="__codelineno-51-25" name="__codelineno-51-25"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="nx">nodeFinalize</span><span class="p">,</span><span class="w"> </span><span class="nx">finalizeResults</span><span class="p">)</span>
</span><span id="__span-51-26"><a id="__codelineno-51-26" name="__codelineno-51-26"></a>
</span><span id="__span-51-27"><a id="__codelineno-51-27" name="__codelineno-51-27"></a><span class="c1">// 连接流程</span>
</span><span id="__span-51-28"><a id="__codelineno-51-28" name="__codelineno-51-28"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">SetEntryPoint</span><span class="p">(</span><span class="nx">nodePrepare</span><span class="p">)</span>
</span><span id="__span-51-29"><a id="__codelineno-51-29" name="__codelineno-51-29"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddEdge</span><span class="p">(</span><span class="nx">nodePrepare</span><span class="p">,</span><span class="w"> </span><span class="nx">nodeAnalyzer</span><span class="p">)</span><span class="w">     </span><span class="c1">// 交给动态 Agent</span>
</span><span id="__span-51-30"><a id="__codelineno-51-30" name="__codelineno-51-30"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddEdge</span><span class="p">(</span><span class="nx">nodeAnalyzer</span><span class="p">,</span><span class="w"> </span><span class="nx">nodeFinalize</span><span class="p">)</span><span class="w">    </span><span class="c1">// 回到结构化流程</span>
</span><span id="__span-51-31"><a id="__codelineno-51-31" name="__codelineno-51-31"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">SetFinishPoint</span><span class="p">(</span><span class="nx">nodeFinalize</span><span class="p">)</span>
</span><span id="__span-51-32"><a id="__codelineno-51-32" name="__codelineno-51-32"></a>
</span><span id="__span-51-33"><a id="__codelineno-51-33" name="__codelineno-51-33"></a><span class="c1">// 创建时注入</span>
</span><span id="__span-51-34"><a id="__codelineno-51-34" name="__codelineno-51-34"></a><span class="nx">graphAgent</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;hybrid&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">g</span><span class="p">,</span>
</span><span id="__span-51-35"><a id="__codelineno-51-35" name="__codelineno-51-35"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithSubAgents</span><span class="p">([]</span><span class="nx">agent</span><span class="p">.</span><span class="nx">Agent</span><span class="p">{</span><span class="nx">dynamicAgent</span><span class="p">}))</span>
</span></code></pre></div></td></tr></table></div>
<h2 id="_25">核心机制详解</h2>
<h3 id="schema-reducer">状态管理：Schema + Reducer 模式</h3>
<p>状态管理是图工作流的核心挑战之一。我们设计了一套基于 Schema + Reducer 的状态管理机制，既保证了类型安全，又支持高并发的原子更新。</p>
<pre class="mermaid"><code>flowchart LR
    subgraph "State Schema"
        MS[messages: MessageList]:::schemaClass
        UI[user_input: string]:::schemaClass
        LR[last_response: string]:::schemaClass
        NR[node_responses: Map]:::schemaClass
    end

    subgraph "State Operations"
        R1[MessageReducer]:::reducerClass
        R2[AppendReducer]:::reducerClass
        R3[DefaultReducer]:::reducerClass
    end

    subgraph "Concurrent Updates"
        N1[Node 1 Output]:::nodeOutputClass
        N2[Node 2 Output]:::nodeOutputClass
        N3[Node 3 Output]:::nodeOutputClass
    end

    N1 --&gt; R1
    N2 --&gt; R2
    N3 --&gt; R3
    R1 --&gt; MS
    R2 --&gt; NR
    R3 --&gt; LR

    classDef schemaClass fill:#e3f2fd,stroke:#1565c0,stroke-width:2px
    classDef reducerClass fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    classDef nodeOutputClass fill:#fff8e1,stroke:#f57f17,stroke-width:2px</code></pre>
<p>Graph 的状态底层是 <code>map[string]any</code>，通过 <code>StateSchema</code> 提供运行时类型校验和字段验证。Reducer 机制确保状态字段按预定义规则安全合并，避免并发更新冲突。</p>
<h4 id="_26">常用键常量参考</h4>
<ul>
<li>用户可见：<code>graph.StateKeyUserInput</code>、<code>graph.StateKeyOneShotMessages</code>、<code>graph.StateKeyMessages</code>、<code>graph.StateKeyLastResponse</code>、<code>graph.StateKeyNodeResponses</code>、<code>graph.StateKeyMetadata</code></li>
<li>系统内部：<code>session</code>、<code>exec_context</code>、<code>tool_callbacks</code>、<code>model_callbacks</code>、<code>agent_callbacks</code>、<code>current_node_id</code>、<code>parent_agent</code></li>
<li>命令/恢复：<code>__command__</code>、<code>__resume_map__</code></li>
</ul>
<p>常量均定义在 <code>graph/state.go</code> 与 <code>graph/keys.go</code>，建议通过常量引用，避免硬编码。</p>
<h4 id="_27">节点级回调与生成参数</h4>
<p>节点可通过可选项注册回调或参数（见 <code>graph/state_graph.go</code>）：
- <code>graph.WithPreNodeCallback</code> / <code>graph.WithPostNodeCallback</code> / <code>graph.WithNodeErrorCallback</code>
- LLM 节点可用 <code>graph.WithGenerationConfig</code>、<code>graph.WithModelCallbacks</code>
- 工具节点可用 <code>graph.WithToolCallbacks</code>
- Agent 节点可用 <code>graph.WithAgentNodeEventCallback</code></p>
<p>此外，<code>graph.WithName</code>/<code>graph.WithDescription</code> 可为节点添加友好的名称与描述；<code>graph.WithDestinations</code> 可声明潜在动态路由目标（仅用于静态校验/可视化）。</p>
<h3 id="llm_2">LLM 输入规则：三段式设计</h3>
<p>LLM 节点的输入处理是我们花了很多时间打磨的功能。看起来简单的三段式规则，实际上解决了 AI 应用中最常见的上下文管理问题。</p>
<p>LLM 节点内置了一套固定的输入选择逻辑（无需额外配置）：</p>
<ol>
<li><strong>优先用 <code>graph.StateKeyOneShotMessages</code></strong>：完全覆盖本轮输入（含 system/user），执行后清空</li>
<li><strong>其次用 <code>graph.StateKeyUserInput</code></strong>：在 <code>graph.StateKeyMessages</code> 基础上追加本轮 user，再把 assistant 回答一起原子写回，随后清空 <code>graph.StateKeyUserInput</code></li>
<li><strong>否则仅用 <code>graph.StateKeyMessages</code></strong>：常见于工具回路二次进 LLM（<code>graph.StateKeyUserInput</code> 已被清空）</li>
</ol>
<p>这套规则的精妙之处在于，它既保证了"预处理节点可以改写 <code>graph.StateKeyUserInput</code> 并在同一轮生效"，又与工具循环（tool_calls → tools → LLM）自然衔接。</p>
<p>示例（技术解析级别的小片段，演示三种输入路径）：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-52-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-52-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-52-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-52-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-52-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-52-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-52-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-52-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-52-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-52-10">10</a></span>
<span class="normal"><a href="#__codelineno-52-11">11</a></span>
<span class="normal"><a href="#__codelineno-52-12">12</a></span>
<span class="normal"><a href="#__codelineno-52-13">13</a></span>
<span class="normal"><a href="#__codelineno-52-14">14</a></span>
<span class="normal"><a href="#__codelineno-52-15">15</a></span>
<span class="normal"><a href="#__codelineno-52-16">16</a></span>
<span class="normal"><a href="#__codelineno-52-17">17</a></span>
<span class="normal"><a href="#__codelineno-52-18">18</a></span>
<span class="normal"><a href="#__codelineno-52-19">19</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-52-1"><a id="__codelineno-52-1" name="__codelineno-52-1"></a><span class="c1">// OneShot（graph.StateKeyOneShotMessages）：完全覆盖本轮输入（包含 system/user），适合“前置节点构造完整 prompt”</span>
</span><span id="__span-52-2"><a id="__codelineno-52-2" name="__codelineno-52-2"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-52-3"><a id="__codelineno-52-3" name="__codelineno-52-3"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-52-4"><a id="__codelineno-52-4" name="__codelineno-52-4"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/model&quot;</span>
</span><span id="__span-52-5"><a id="__codelineno-52-5" name="__codelineno-52-5"></a><span class="p">)</span>
</span><span id="__span-52-6"><a id="__codelineno-52-6" name="__codelineno-52-6"></a>
</span><span id="__span-52-7"><a id="__codelineno-52-7" name="__codelineno-52-7"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-52-8"><a id="__codelineno-52-8" name="__codelineno-52-8"></a><span class="w">    </span><span class="nx">systemPrompt</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;你是审慎可靠的助手&quot;</span>
</span><span id="__span-52-9"><a id="__codelineno-52-9" name="__codelineno-52-9"></a><span class="w">    </span><span class="nx">userPrompt</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;请用要点总结这段文本&quot;</span>
</span><span id="__span-52-10"><a id="__codelineno-52-10" name="__codelineno-52-10"></a><span class="p">)</span>
</span><span id="__span-52-11"><a id="__codelineno-52-11" name="__codelineno-52-11"></a>
</span><span id="__span-52-12"><a id="__codelineno-52-12" name="__codelineno-52-12"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;prepare_prompt&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-52-13"><a id="__codelineno-52-13" name="__codelineno-52-13"></a><span class="w">    </span><span class="nx">oneShot</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">[]</span><span class="nx">model</span><span class="p">.</span><span class="nx">Message</span><span class="p">{</span>
</span><span id="__span-52-14"><a id="__codelineno-52-14" name="__codelineno-52-14"></a><span class="w">        </span><span class="nx">model</span><span class="p">.</span><span class="nx">NewSystemMessage</span><span class="p">(</span><span class="nx">systemPrompt</span><span class="p">),</span>
</span><span id="__span-52-15"><a id="__codelineno-52-15" name="__codelineno-52-15"></a><span class="w">        </span><span class="nx">model</span><span class="p">.</span><span class="nx">NewUserMessage</span><span class="p">(</span><span class="nx">userPrompt</span><span class="p">),</span>
</span><span id="__span-52-16"><a id="__codelineno-52-16" name="__codelineno-52-16"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-52-17"><a id="__codelineno-52-17" name="__codelineno-52-17"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyOneShotMessages</span><span class="p">:</span><span class="w"> </span><span class="nx">oneShot</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-52-18"><a id="__codelineno-52-18" name="__codelineno-52-18"></a><span class="p">})</span>
</span><span id="__span-52-19"><a id="__codelineno-52-19" name="__codelineno-52-19"></a><span class="c1">// 后续进入 LLM 节点时将仅使用 graph.StateKeyOneShotMessages，并在执行后清空</span>
</span></code></pre></div></td></tr></table></div>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-53-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-53-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-53-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-53-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-53-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-53-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-53-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-53-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-53-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-53-10">10</a></span>
<span class="normal"><a href="#__codelineno-53-11">11</a></span>
<span class="normal"><a href="#__codelineno-53-12">12</a></span>
<span class="normal"><a href="#__codelineno-53-13">13</a></span>
<span class="normal"><a href="#__codelineno-53-14">14</a></span>
<span class="normal"><a href="#__codelineno-53-15">15</a></span>
<span class="normal"><a href="#__codelineno-53-16">16</a></span>
<span class="normal"><a href="#__codelineno-53-17">17</a></span>
<span class="normal"><a href="#__codelineno-53-18">18</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-53-1"><a id="__codelineno-53-1" name="__codelineno-53-1"></a><span class="c1">// UserInput（graph.StateKeyUserInput）：在历史 graph.StateKeyMessages 基础上附加本轮用户输入</span>
</span><span id="__span-53-2"><a id="__codelineno-53-2" name="__codelineno-53-2"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-53-3"><a id="__codelineno-53-3" name="__codelineno-53-3"></a><span class="w">    </span><span class="s">&quot;strings&quot;</span>
</span><span id="__span-53-4"><a id="__codelineno-53-4" name="__codelineno-53-4"></a>
</span><span id="__span-53-5"><a id="__codelineno-53-5" name="__codelineno-53-5"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-53-6"><a id="__codelineno-53-6" name="__codelineno-53-6"></a><span class="p">)</span>
</span><span id="__span-53-7"><a id="__codelineno-53-7" name="__codelineno-53-7"></a>
</span><span id="__span-53-8"><a id="__codelineno-53-8" name="__codelineno-53-8"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-53-9"><a id="__codelineno-53-9" name="__codelineno-53-9"></a><span class="w">    </span><span class="nx">stateKeyCleanedInput</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;cleaned_input&quot;</span>
</span><span id="__span-53-10"><a id="__codelineno-53-10" name="__codelineno-53-10"></a><span class="p">)</span>
</span><span id="__span-53-11"><a id="__codelineno-53-11" name="__codelineno-53-11"></a>
</span><span id="__span-53-12"><a id="__codelineno-53-12" name="__codelineno-53-12"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;clean_input&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-53-13"><a id="__codelineno-53-13" name="__codelineno-53-13"></a><span class="w">    </span><span class="nx">in</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">strings</span><span class="p">.</span><span class="nx">TrimSpace</span><span class="p">(</span><span class="nx">s</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyUserInput</span><span class="p">].(</span><span class="kt">string</span><span class="p">))</span>
</span><span id="__span-53-14"><a id="__codelineno-53-14" name="__codelineno-53-14"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span>
</span><span id="__span-53-15"><a id="__codelineno-53-15" name="__codelineno-53-15"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyUserInput</span><span class="p">:</span><span class="w"> </span><span class="nx">in</span><span class="p">,</span><span class="w">                </span><span class="c1">// 将清洗后的输入写回，LLM 节点会把 user+assistant 原子写入 messages</span>
</span><span id="__span-53-16"><a id="__codelineno-53-16" name="__codelineno-53-16"></a><span class="w">        </span><span class="nx">stateKeyCleanedInput</span><span class="p">:</span><span class="w">    </span><span class="nx">in</span><span class="p">,</span><span class="w">                </span><span class="c1">// 同时保留业务自定义键</span>
</span><span id="__span-53-17"><a id="__codelineno-53-17" name="__codelineno-53-17"></a><span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-53-18"><a id="__codelineno-53-18" name="__codelineno-53-18"></a><span class="p">})</span>
</span></code></pre></div></td></tr></table></div>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-54-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-54-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-54-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-54-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-54-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-54-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-54-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-54-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-54-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-54-10">10</a></span>
<span class="normal"><a href="#__codelineno-54-11">11</a></span>
<span class="normal"><a href="#__codelineno-54-12">12</a></span>
<span class="normal"><a href="#__codelineno-54-13">13</a></span>
<span class="normal"><a href="#__codelineno-54-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-54-1"><a id="__codelineno-54-1" name="__codelineno-54-1"></a><span class="c1">// Messages-only（graph.StateKeyMessages）：工具回路返回后，graph.StateKeyUserInput 已清空；LLM 仅基于 graph.StateKeyMessages（含 tool 响应）继续推理</span>
</span><span id="__span-54-2"><a id="__codelineno-54-2" name="__codelineno-54-2"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-54-3"><a id="__codelineno-54-3" name="__codelineno-54-3"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-54-4"><a id="__codelineno-54-4" name="__codelineno-54-4"></a><span class="p">)</span>
</span><span id="__span-54-5"><a id="__codelineno-54-5" name="__codelineno-54-5"></a>
</span><span id="__span-54-6"><a id="__codelineno-54-6" name="__codelineno-54-6"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-54-7"><a id="__codelineno-54-7" name="__codelineno-54-7"></a><span class="w">    </span><span class="nx">nodeAsk</span><span class="w">       </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;ask&quot;</span>
</span><span id="__span-54-8"><a id="__codelineno-54-8" name="__codelineno-54-8"></a><span class="w">    </span><span class="nx">nodeExecTools</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;exec_tools&quot;</span>
</span><span id="__span-54-9"><a id="__codelineno-54-9" name="__codelineno-54-9"></a><span class="w">    </span><span class="nx">nodeFallback</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;fallback&quot;</span>
</span><span id="__span-54-10"><a id="__codelineno-54-10" name="__codelineno-54-10"></a><span class="p">)</span>
</span><span id="__span-54-11"><a id="__codelineno-54-11" name="__codelineno-54-11"></a>
</span><span id="__span-54-12"><a id="__codelineno-54-12" name="__codelineno-54-12"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddToolsNode</span><span class="p">(</span><span class="nx">nodeExecTools</span><span class="p">,</span><span class="w"> </span><span class="nx">tools</span><span class="p">)</span>
</span><span id="__span-54-13"><a id="__codelineno-54-13" name="__codelineno-54-13"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddToolsConditionalEdges</span><span class="p">(</span><span class="nx">nodeAsk</span><span class="p">,</span><span class="w"> </span><span class="nx">nodeExecTools</span><span class="p">,</span><span class="w"> </span><span class="nx">nodeFallback</span><span class="p">)</span>
</span><span id="__span-54-14"><a id="__codelineno-54-14" name="__codelineno-54-14"></a><span class="c1">// 再次回到 nodeAsk（或下游 LLM 节点）时，由于 graph.StateKeyUserInput 已清空，将走 messages-only 分支</span>
</span></code></pre></div></td></tr></table></div>
<h4 id="_28">指令占位符注入</h4>
<p><code>AddLLMNode</code> 的 <code>instruction</code> 支持占位符，语法与 <code>llmagent</code> 一致：
- <code>{key}</code> / <code>{key?}</code>：从会话 <code>session.State</code> 读取键值，可选后缀 <code>?</code> 缺失时为空；
- <code>{user:subkey}</code>、<code>{app:subkey}</code>、<code>{temp:subkey}</code>：按命名空间读取。</p>
<p>GraphAgent 会把当前 <code>*session.Session</code> 放入状态（<code>graph.StateKeySession</code> 键），LLM 节点会在执行前对指令进行占位符展开。</p>
<p>提示：GraphAgent 会从会话事件播种 <code>graph.StateKeyMessages</code> 以保证多轮连贯；从检查点恢复时，若用户消息仅为 "resume"，不会注入到 <code>graph.StateKeyUserInput</code>，以避免干扰已恢复的状态。</p>
<h3 id="_29">并发执行和状态安全</h3>
<p>当一个节点有多条出边时，会自动触发并行执行：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-55-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-55-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-55-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-55-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-55-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-55-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-55-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-55-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-55-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-55-10">10</a></span>
<span class="normal"><a href="#__codelineno-55-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-55-1"><a id="__codelineno-55-1" name="__codelineno-55-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-55-2"><a id="__codelineno-55-2" name="__codelineno-55-2"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-55-3"><a id="__codelineno-55-3" name="__codelineno-55-3"></a><span class="p">)</span>
</span><span id="__span-55-4"><a id="__codelineno-55-4" name="__codelineno-55-4"></a>
</span><span id="__span-55-5"><a id="__codelineno-55-5" name="__codelineno-55-5"></a><span class="c1">// 这样的图结构会自动并行执行</span>
</span><span id="__span-55-6"><a id="__codelineno-55-6" name="__codelineno-55-6"></a><span class="nx">stateGraph</span><span class="p">.</span>
</span><span id="__span-55-7"><a id="__codelineno-55-7" name="__codelineno-55-7"></a><span class="w">    </span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;analyze&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">analyzeData</span><span class="p">).</span>
</span><span id="__span-55-8"><a id="__codelineno-55-8" name="__codelineno-55-8"></a><span class="w">    </span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;generate_report&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">generateReport</span><span class="p">).</span><span class="w"> </span>
</span><span id="__span-55-9"><a id="__codelineno-55-9" name="__codelineno-55-9"></a><span class="w">    </span><span class="nx">AddNode</span><span class="p">(</span><span class="s">&quot;call_external_api&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">callAPI</span><span class="p">).</span>
</span><span id="__span-55-10"><a id="__codelineno-55-10" name="__codelineno-55-10"></a><span class="w">    </span><span class="nx">AddEdge</span><span class="p">(</span><span class="s">&quot;analyze&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;generate_report&quot;</span><span class="p">).</span><span class="w">    </span><span class="c1">// 这两个会并行执行</span>
</span><span id="__span-55-11"><a id="__codelineno-55-11" name="__codelineno-55-11"></a><span class="w">    </span><span class="nx">AddEdge</span><span class="p">(</span><span class="s">&quot;analyze&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;call_external_api&quot;</span><span class="p">)</span><span class="w">   </span><span class="c1">// </span>
</span></code></pre></div></td></tr></table></div>
<p>内部实现保证了并发安全：执行器为每个任务构造浅拷贝（maps.Copy）并在合并时加锁，同时通过 Reducer 机制来安全地合并并发更新。</p>
<h3 id="io_1">节点 I/O 约定与常用键</h3>
<p>节点之间仅通过共享 <code>State</code> 传递数据，节点函数返回的增量由 Schema 的 Reducer 合并。</p>
<ul>
<li>函数节点（Function）<ul>
<li>输入：完整 <code>State</code>（按 Schema 声明读取）</li>
<li>输出：只写业务键（例如 <code>{"parsed_time":"..."}</code>），不要写内部键</li>
</ul>
</li>
</ul>
<ul>
<li>LLM 节点<ul>
<li>输入优先级：<code>graph.StateKeyOneShotMessages</code> → <code>graph.StateKeyUserInput</code> → <code>graph.StateKeyMessages</code></li>
<li>输出：原子写回 <code>graph.StateKeyMessages</code>、设置 <code>graph.StateKeyLastResponse</code>、设置 <code>graph.StateKeyNodeResponses[&lt;llm_node_id&gt;]</code></li>
</ul>
</li>
</ul>
<ul>
<li>工具节点（Tools）<ul>
<li>自 <code>graph.StateKeyMessages</code> 尾部配对当前轮的 <code>assistant(tool_calls)</code>，按顺序追加工具返回到 <code>graph.StateKeyMessages</code></li>
<li>多个工具按 LLM 返回顺序顺序执行</li>
</ul>
</li>
</ul>
<ul>
<li>Agent 节点<ul>
<li>通过 <code>Invocation.RunOptions.RuntimeState</code> 接收 Graph 的 <code>State</code></li>
<li>输出：设置 <code>graph.StateKeyLastResponse</code> 与 <code>graph.StateKeyNodeResponses[&lt;agent_node_id&gt;]</code>；执行成功后会清空 <code>graph.StateKeyUserInput</code></li>
</ul>
</li>
</ul>
<p>实践建议：
- 串行读取：紧邻下游直接读取 <code>graph.StateKeyLastResponse</code>；
- 并行/汇合读取：从 <code>graph.StateKeyNodeResponses[&lt;nodeID&gt;]</code> 读取指定节点输出；
- 为业务键在 Schema 中声明合适的 Reducer，避免并发写入冲突。</p>
<h3 id="api">API 速查表</h3>
<ul>
<li>构图<ul>
<li><code>graph.NewStateGraph(schema)</code> → 构建器</li>
<li><code>AddNode(id, func, ...opts)</code> / <code>AddLLMNode(id, model, instruction, tools, ...opts)</code></li>
<li><code>AddToolsNode(id, tools, ...opts)</code> / <code>AddAgentNode(id, ...opts)</code></li>
<li><code>AddEdge(from, to)</code> / <code>AddConditionalEdges(from, condition, pathMap)</code></li>
<li><code>AddToolsConditionalEdges(llmNode, toolsNode, fallback)</code></li>
<li><code>SetEntryPoint(nodeID)</code> / <code>SetFinishPoint(nodeID)</code> / <code>Compile()</code></li>
</ul>
</li>
</ul>
<ul>
<li>常用 State 键（用户可见）<ul>
<li><code>graph.StateKeyUserInput</code>、<code>graph.StateKeyOneShotMessages</code>、<code>graph.StateKeyMessages</code>、<code>graph.StateKeyLastResponse</code>、<code>graph.StateKeyNodeResponses</code>、<code>graph.StateKeyMetadata</code></li>
</ul>
</li>
</ul>
<ul>
<li>节点级可选项<ul>
<li><code>graph.WithGenerationConfig</code>、<code>graph.WithModelCallbacks</code>、<code>graph.WithToolCallbacks</code></li>
<li><code>graph.WithPreNodeCallback</code>、<code>graph.WithPostNodeCallback</code>、<code>graph.WithNodeErrorCallback</code></li>
</ul>
</li>
</ul>
<ul>
<li>执行<ul>
<li><code>graphagent.New(name, compiledGraph, ...opts)</code> → <code>runner.NewRunner(app, agent)</code> → <code>Run(...)</code></li>
</ul>
</li>
</ul>
<p>更多端到端用法见 <code>examples/graph</code>（基础/并行/多轮/中断/工具/占位符）。</p>
<h2 id="dot">可视化导出（DOT/图片）</h2>
<p>Graph 支持直接导出 Graphviz（图形可视化软件，Graph Visualization）<code>DOT</code>（Graphviz 的描述语言，Directed Graph Language）文本，以及通过系统安装的 <code>dot</code>（Graphviz 命令行工具 <code>dot</code> 是 Graphviz 的布局引擎之一，用于渲染 DOT 文件）渲染 <code>PNG</code>（Portable Network Graphics，便携式网络图形格式）/<code>SVG</code>（Scalable Vector Graphics，可缩放矢量图形）。</p>
<ul>
<li><code>WithDestinations</code>（在节点上声明潜在动态去向）会以虚线（dotted、灰色）显示，仅用于静态检查与可视化，不影响运行时路由。</li>
<li>条件边（Conditional edges）会以虚线（dashed、灰色）并标注分支键值。</li>
<li>常规边（AddEdge）为实线。</li>
<li>虚拟 <code>Start</code>/<code>End</code> 节点可通过选项打开/隐藏。</li>
</ul>
<p>示例：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-56-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-56-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-56-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-56-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-56-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-56-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-56-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-56-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-56-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-56-10">10</a></span>
<span class="normal"><a href="#__codelineno-56-11">11</a></span>
<span class="normal"><a href="#__codelineno-56-12">12</a></span>
<span class="normal"><a href="#__codelineno-56-13">13</a></span>
<span class="normal"><a href="#__codelineno-56-14">14</a></span>
<span class="normal"><a href="#__codelineno-56-15">15</a></span>
<span class="normal"><a href="#__codelineno-56-16">16</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-56-1"><a id="__codelineno-56-1" name="__codelineno-56-1"></a><span class="nx">g</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">sg</span><span class="p">.</span><span class="nx">MustCompile</span><span class="p">()</span>
</span><span id="__span-56-2"><a id="__codelineno-56-2" name="__codelineno-56-2"></a>
</span><span id="__span-56-3"><a id="__codelineno-56-3" name="__codelineno-56-3"></a><span class="c1">// 生成 DOT 文本</span>
</span><span id="__span-56-4"><a id="__codelineno-56-4" name="__codelineno-56-4"></a><span class="nx">dot</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">DOT</span><span class="p">(</span>
</span><span id="__span-56-5"><a id="__codelineno-56-5" name="__codelineno-56-5"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithRankDir</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">RankDirLR</span><span class="p">),</span><span class="w">     </span><span class="c1">// 左→右布局（或 graph.RankDirTB）</span>
</span><span id="__span-56-6"><a id="__codelineno-56-6" name="__codelineno-56-6"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithIncludeDestinations</span><span class="p">(</span><span class="kc">true</span><span class="p">),</span><span class="w">    </span><span class="c1">// 显示 WithDestinations 声明</span>
</span><span id="__span-56-7"><a id="__codelineno-56-7" name="__codelineno-56-7"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithGraphLabel</span><span class="p">(</span><span class="s">&quot;My Workflow&quot;</span><span class="p">),</span><span class="w">   </span><span class="c1">// 图标题</span>
</span><span id="__span-56-8"><a id="__codelineno-56-8" name="__codelineno-56-8"></a><span class="p">)</span>
</span><span id="__span-56-9"><a id="__codelineno-56-9" name="__codelineno-56-9"></a>
</span><span id="__span-56-10"><a id="__codelineno-56-10" name="__codelineno-56-10"></a><span class="c1">// 渲染 PNG （需要已安装 Graphviz 的 dot）</span>
</span><span id="__span-56-11"><a id="__codelineno-56-11" name="__codelineno-56-11"></a><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">g</span><span class="p">.</span><span class="nx">RenderImage</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Background</span><span class="p">(),</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">ImageFormatPNG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;workflow.png&quot;</span><span class="p">,</span>
</span><span id="__span-56-12"><a id="__codelineno-56-12" name="__codelineno-56-12"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithRankDir</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">RankDirLR</span><span class="p">),</span>
</span><span id="__span-56-13"><a id="__codelineno-56-13" name="__codelineno-56-13"></a><span class="w">    </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithIncludeDestinations</span><span class="p">(</span><span class="kc">true</span><span class="p">),</span>
</span><span id="__span-56-14"><a id="__codelineno-56-14" name="__codelineno-56-14"></a><span class="p">);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-56-15"><a id="__codelineno-56-15" name="__codelineno-56-15"></a><span class="w">    </span><span class="c1">// 未安装 Graphviz 时这里会返回错误，可忽略或提示安装</span>
</span><span id="__span-56-16"><a id="__codelineno-56-16" name="__codelineno-56-16"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>API 参考：</p>
<ul>
<li><code>g.DOT(...)</code> / <code>g.WriteDOT(w, ...)</code>：导出 DOT 文本</li>
<li><code>g.RenderImage(ctx, format, outputPath, ...)</code>：调用 <code>dot</code> 渲染图片（<code>png</code>/<code>svg</code> 等）</li>
<li>选项：<code>WithRankDir(graph.RankDirLR|graph.RankDirTB)</code>、<code>WithIncludeDestinations(bool)</code>、<code>WithIncludeStartEnd(bool)</code>、<code>WithGraphLabel(string)</code></li>
</ul>
<p>完整示例见：<code>examples/graph/visualization</code></p>
<h2 id="_30">高级特性</h2>
<h3 id="_31">检查点与恢复</h3>
<p>为了支持时间旅行与可靠恢复，可以为执行器或 GraphAgent 配置检查点保存器。下面演示使用 SQLite Saver 持久化检查点并从特定检查点恢复。</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-57-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-57-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-57-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-57-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-57-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-57-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-57-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-57-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-57-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-57-10">10</a></span>
<span class="normal"><a href="#__codelineno-57-11">11</a></span>
<span class="normal"><a href="#__codelineno-57-12">12</a></span>
<span class="normal"><a href="#__codelineno-57-13">13</a></span>
<span class="normal"><a href="#__codelineno-57-14">14</a></span>
<span class="normal"><a href="#__codelineno-57-15">15</a></span>
<span class="normal"><a href="#__codelineno-57-16">16</a></span>
<span class="normal"><a href="#__codelineno-57-17">17</a></span>
<span class="normal"><a href="#__codelineno-57-18">18</a></span>
<span class="normal"><a href="#__codelineno-57-19">19</a></span>
<span class="normal"><a href="#__codelineno-57-20">20</a></span>
<span class="normal"><a href="#__codelineno-57-21">21</a></span>
<span class="normal"><a href="#__codelineno-57-22">22</a></span>
<span class="normal"><a href="#__codelineno-57-23">23</a></span>
<span class="normal"><a href="#__codelineno-57-24">24</a></span>
<span class="normal"><a href="#__codelineno-57-25">25</a></span>
<span class="normal"><a href="#__codelineno-57-26">26</a></span>
<span class="normal"><a href="#__codelineno-57-27">27</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-57-1"><a id="__codelineno-57-1" name="__codelineno-57-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-57-2"><a id="__codelineno-57-2" name="__codelineno-57-2"></a><span class="w">    </span><span class="s">&quot;database/sql&quot;</span>
</span><span id="__span-57-3"><a id="__codelineno-57-3" name="__codelineno-57-3"></a>
</span><span id="__span-57-4"><a id="__codelineno-57-4" name="__codelineno-57-4"></a><span class="w">    </span><span class="nx">_</span><span class="w"> </span><span class="s">&quot;github.com/mattn/go-sqlite3&quot;</span>
</span><span id="__span-57-5"><a id="__codelineno-57-5" name="__codelineno-57-5"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/agent&quot;</span>
</span><span id="__span-57-6"><a id="__codelineno-57-6" name="__codelineno-57-6"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/agent/graphagent&quot;</span>
</span><span id="__span-57-7"><a id="__codelineno-57-7" name="__codelineno-57-7"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-57-8"><a id="__codelineno-57-8" name="__codelineno-57-8"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph/checkpoint/sqlite&quot;</span>
</span><span id="__span-57-9"><a id="__codelineno-57-9" name="__codelineno-57-9"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/model&quot;</span>
</span><span id="__span-57-10"><a id="__codelineno-57-10" name="__codelineno-57-10"></a><span class="p">)</span>
</span><span id="__span-57-11"><a id="__codelineno-57-11" name="__codelineno-57-11"></a>
</span><span id="__span-57-12"><a id="__codelineno-57-12" name="__codelineno-57-12"></a><span class="c1">// 配置检查点</span>
</span><span id="__span-57-13"><a id="__codelineno-57-13" name="__codelineno-57-13"></a><span class="nx">db</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">sql</span><span class="p">.</span><span class="nx">Open</span><span class="p">(</span><span class="s">&quot;sqlite3&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;./checkpoints.db&quot;</span><span class="p">)</span>
</span><span id="__span-57-14"><a id="__codelineno-57-14" name="__codelineno-57-14"></a><span class="nx">saver</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">sqlite</span><span class="p">.</span><span class="nx">NewSaver</span><span class="p">(</span><span class="nx">db</span><span class="p">)</span>
</span><span id="__span-57-15"><a id="__codelineno-57-15" name="__codelineno-57-15"></a>
</span><span id="__span-57-16"><a id="__codelineno-57-16" name="__codelineno-57-16"></a><span class="nx">graphAgent</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;workflow&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">g</span><span class="p">,</span>
</span><span id="__span-57-17"><a id="__codelineno-57-17" name="__codelineno-57-17"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithCheckpointSaver</span><span class="p">(</span><span class="nx">saver</span><span class="p">))</span>
</span><span id="__span-57-18"><a id="__codelineno-57-18" name="__codelineno-57-18"></a>
</span><span id="__span-57-19"><a id="__codelineno-57-19" name="__codelineno-57-19"></a><span class="c1">// 执行时自动保存检查点（默认每步保存）</span>
</span><span id="__span-57-20"><a id="__codelineno-57-20" name="__codelineno-57-20"></a>
</span><span id="__span-57-21"><a id="__codelineno-57-21" name="__codelineno-57-21"></a><span class="c1">// 从检查点恢复</span>
</span><span id="__span-57-22"><a id="__codelineno-57-22" name="__codelineno-57-22"></a><span class="nx">eventCh</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">userID</span><span class="p">,</span><span class="w"> </span><span class="nx">sessionID</span><span class="p">,</span>
</span><span id="__span-57-23"><a id="__codelineno-57-23" name="__codelineno-57-23"></a><span class="w">    </span><span class="nx">model</span><span class="p">.</span><span class="nx">NewUserMessage</span><span class="p">(</span><span class="s">&quot;resume&quot;</span><span class="p">),</span>
</span><span id="__span-57-24"><a id="__codelineno-57-24" name="__codelineno-57-24"></a><span class="w">    </span><span class="nx">agent</span><span class="p">.</span><span class="nx">WithRuntimeState</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">any</span><span class="p">{</span>
</span><span id="__span-57-25"><a id="__codelineno-57-25" name="__codelineno-57-25"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">CfgKeyCheckpointID</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ckpt-123&quot;</span><span class="p">,</span>
</span><span id="__span-57-26"><a id="__codelineno-57-26" name="__codelineno-57-26"></a><span class="w">    </span><span class="p">}),</span>
</span><span id="__span-57-27"><a id="__codelineno-57-27" name="__codelineno-57-27"></a><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<h4 id="_32">检查点管理</h4>
<p>使用管理器可以便捷地浏览、查询与删除检查点：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-58-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-58-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-58-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-58-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-58-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-58-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-58-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-58-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-58-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-58-10">10</a></span>
<span class="normal"><a href="#__codelineno-58-11">11</a></span>
<span class="normal"><a href="#__codelineno-58-12">12</a></span>
<span class="normal"><a href="#__codelineno-58-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-58-1"><a id="__codelineno-58-1" name="__codelineno-58-1"></a><span class="nx">cm</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewCheckpointManager</span><span class="p">(</span><span class="nx">saver</span><span class="p">)</span>
</span><span id="__span-58-2"><a id="__codelineno-58-2" name="__codelineno-58-2"></a>
</span><span id="__span-58-3"><a id="__codelineno-58-3" name="__codelineno-58-3"></a><span class="c1">// 最新检查点（可按 namespace 过滤；空字符串代表跨命名空间）</span>
</span><span id="__span-58-4"><a id="__codelineno-58-4" name="__codelineno-58-4"></a><span class="nx">latest</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">cm</span><span class="p">.</span><span class="nx">Latest</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">lineageID</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">)</span>
</span><span id="__span-58-5"><a id="__codelineno-58-5" name="__codelineno-58-5"></a>
</span><span id="__span-58-6"><a id="__codelineno-58-6" name="__codelineno-58-6"></a><span class="c1">// 列表（按时间倒序）</span>
</span><span id="__span-58-7"><a id="__codelineno-58-7" name="__codelineno-58-7"></a><span class="nx">tuples</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">cm</span><span class="p">.</span><span class="nx">ListCheckpoints</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewCheckpointConfig</span><span class="p">(</span><span class="nx">lineageID</span><span class="p">).</span><span class="nx">ToMap</span><span class="p">(),</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">graph</span><span class="p">.</span><span class="nx">CheckpointFilter</span><span class="p">{</span><span class="nx">Limit</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="p">})</span>
</span><span id="__span-58-8"><a id="__codelineno-58-8" name="__codelineno-58-8"></a>
</span><span id="__span-58-9"><a id="__codelineno-58-9" name="__codelineno-58-9"></a><span class="c1">// 获取具体检查点元组（含 pending writes）</span>
</span><span id="__span-58-10"><a id="__codelineno-58-10" name="__codelineno-58-10"></a><span class="nx">tuple</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">cm</span><span class="p">.</span><span class="nx">GetTuple</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">CreateCheckpointConfig</span><span class="p">(</span><span class="nx">lineageID</span><span class="p">,</span><span class="w"> </span><span class="nx">checkpointID</span><span class="p">,</span><span class="w"> </span><span class="nx">namespace</span><span class="p">))</span>
</span><span id="__span-58-11"><a id="__codelineno-58-11" name="__codelineno-58-11"></a>
</span><span id="__span-58-12"><a id="__codelineno-58-12" name="__codelineno-58-12"></a><span class="c1">// 删除谱系</span>
</span><span id="__span-58-13"><a id="__codelineno-58-13" name="__codelineno-58-13"></a><span class="nx">_</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">cm</span><span class="p">.</span><span class="nx">DeleteLineage</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">lineageID</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>建议在生产中为 <code>namespace</code> 使用稳定的业务标识（如 <code>svc:prod:flowX</code>），便于审计与对账。</p>
<h3 id="_33">默认值与注意事项</h3>
<ul>
<li>默认值（Executor）<ul>
<li><code>ChannelBufferSize = 256</code>、<code>MaxSteps = 100</code>、<code>CheckpointSaveTimeout = 10s</code></li>
<li>步/节点超时可通过 <code>Executor</code> 的 <code>WithStepTimeout</code> / <code>WithNodeTimeout</code> 配置（目前 GraphAgent 选项未直接暴露）</li>
</ul>
</li>
</ul>
<ul>
<li>会话<ul>
<li>生产环境优先使用 Redis Session；设置合理 TTL 与清理策略</li>
</ul>
</li>
<li>Runner 会自动从会话事件播种多轮 <code>graph.StateKeyMessages</code></li>
</ul>
<ul>
<li>检查点<ul>
<li>采用稳定的 <code>namespace</code> 命名（如 <code>svc:prod:flowX</code>）；使用 <code>CheckpointManager</code> 按谱系审计与清理</li>
</ul>
</li>
</ul>
<ul>
<li>事件与背压<ul>
<li>调整 <code>WithChannelBufferSize</code>；按 <code>author</code>/<code>object</code> 过滤事件降低噪音</li>
</ul>
</li>
</ul>
<ul>
<li>命名与键<ul>
<li>节点/路由标签/状态键使用常量；为需要合并的键声明 Reducer</li>
</ul>
</li>
</ul>
<ul>
<li>治理与合规</li>
<li>关键路径引入 HITL；敏感信息优先落到 <code>graph.StateKeyMetadata</code>，避免混入 <code>graph.StateKeyMessages</code></li>
</ul>
<h3 id="_34">事件速览</h3>
<ul>
<li>Author 约定<ul>
<li>节点级：节点 ID（无法获取时为 <code>graph.AuthorGraphNode</code>）</li>
<li>Pregel 阶段：<code>graph.AuthorGraphPregel</code></li>
<li>执行器/系统：<code>graph.AuthorGraphExecutor</code></li>
<li>用户输入：<code>user</code>（未导出常量）</li>
</ul>
</li>
</ul>
<ul>
<li>对象类型（子集）<ul>
<li>节点：<code>graph.ObjectTypeGraphNodeStart | graph.ObjectTypeGraphNodeComplete | graph.ObjectTypeGraphNodeError</code></li>
<li>Pregel：<code>graph.ObjectTypeGraphPregelPlanning | graph.ObjectTypeGraphPregelExecution | graph.ObjectTypeGraphPregelUpdate</code></li>
<li>通道/状态：<code>graph.ObjectTypeGraphChannelUpdate</code> / <code>graph.ObjectTypeGraphStateUpdate</code></li>
<li>检查点：<code>graph.ObjectTypeGraphCheckpoint</code>、<code>graph.ObjectTypeGraphCheckpointCreated</code>、<code>graph.ObjectTypeGraphCheckpointCommitted</code>、<code>graph.ObjectTypeGraphCheckpointInterrupt</code></li>
</ul>
</li>
</ul>
<p>更多示例见下文“事件监控”。</p>
<h3 id="human-in-the-loop">Human-in-the-Loop</h3>
<p>在关键路径上引入人工确认（HITL）能够显著提升可控性。下面的示例展示一个“中断—恢复”的基本流程：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-59-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-59-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-59-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-59-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-59-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-59-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-59-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-59-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-59-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-59-10">10</a></span>
<span class="normal"><a href="#__codelineno-59-11">11</a></span>
<span class="normal"><a href="#__codelineno-59-12">12</a></span>
<span class="normal"><a href="#__codelineno-59-13">13</a></span>
<span class="normal"><a href="#__codelineno-59-14">14</a></span>
<span class="normal"><a href="#__codelineno-59-15">15</a></span>
<span class="normal"><a href="#__codelineno-59-16">16</a></span>
<span class="normal"><a href="#__codelineno-59-17">17</a></span>
<span class="normal"><a href="#__codelineno-59-18">18</a></span>
<span class="normal"><a href="#__codelineno-59-19">19</a></span>
<span class="normal"><a href="#__codelineno-59-20">20</a></span>
<span class="normal"><a href="#__codelineno-59-21">21</a></span>
<span class="normal"><a href="#__codelineno-59-22">22</a></span>
<span class="normal"><a href="#__codelineno-59-23">23</a></span>
<span class="normal"><a href="#__codelineno-59-24">24</a></span>
<span class="normal"><a href="#__codelineno-59-25">25</a></span>
<span class="normal"><a href="#__codelineno-59-26">26</a></span>
<span class="normal"><a href="#__codelineno-59-27">27</a></span>
<span class="normal"><a href="#__codelineno-59-28">28</a></span>
<span class="normal"><a href="#__codelineno-59-29">29</a></span>
<span class="normal"><a href="#__codelineno-59-30">30</a></span>
<span class="normal"><a href="#__codelineno-59-31">31</a></span>
<span class="normal"><a href="#__codelineno-59-32">32</a></span>
<span class="normal"><a href="#__codelineno-59-33">33</a></span>
<span class="normal"><a href="#__codelineno-59-34">34</a></span>
<span class="normal"><a href="#__codelineno-59-35">35</a></span>
<span class="normal"><a href="#__codelineno-59-36">36</a></span>
<span class="normal"><a href="#__codelineno-59-37">37</a></span>
<span class="normal"><a href="#__codelineno-59-38">38</a></span>
<span class="normal"><a href="#__codelineno-59-39">39</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-59-1"><a id="__codelineno-59-1" name="__codelineno-59-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-59-2"><a id="__codelineno-59-2" name="__codelineno-59-2"></a><span class="w">    </span><span class="s">&quot;context&quot;</span>
</span><span id="__span-59-3"><a id="__codelineno-59-3" name="__codelineno-59-3"></a><span class="w">    </span><span class="s">&quot;fmt&quot;</span>
</span><span id="__span-59-4"><a id="__codelineno-59-4" name="__codelineno-59-4"></a>
</span><span id="__span-59-5"><a id="__codelineno-59-5" name="__codelineno-59-5"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/agent&quot;</span>
</span><span id="__span-59-6"><a id="__codelineno-59-6" name="__codelineno-59-6"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-59-7"><a id="__codelineno-59-7" name="__codelineno-59-7"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/model&quot;</span>
</span><span id="__span-59-8"><a id="__codelineno-59-8" name="__codelineno-59-8"></a><span class="p">)</span>
</span><span id="__span-59-9"><a id="__codelineno-59-9" name="__codelineno-59-9"></a>
</span><span id="__span-59-10"><a id="__codelineno-59-10" name="__codelineno-59-10"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-59-11"><a id="__codelineno-59-11" name="__codelineno-59-11"></a><span class="w">    </span><span class="nx">stateKeyContent</span><span class="w">    </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;content&quot;</span>
</span><span id="__span-59-12"><a id="__codelineno-59-12" name="__codelineno-59-12"></a><span class="w">    </span><span class="nx">stateKeyDecision</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;decision&quot;</span>
</span><span id="__span-59-13"><a id="__codelineno-59-13" name="__codelineno-59-13"></a><span class="w">    </span><span class="nx">interruptKeyReview</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;review_key&quot;</span>
</span><span id="__span-59-14"><a id="__codelineno-59-14" name="__codelineno-59-14"></a><span class="w">    </span><span class="nx">nodeReview</span><span class="w">         </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;review&quot;</span>
</span><span id="__span-59-15"><a id="__codelineno-59-15" name="__codelineno-59-15"></a><span class="p">)</span>
</span><span id="__span-59-16"><a id="__codelineno-59-16" name="__codelineno-59-16"></a>
</span><span id="__span-59-17"><a id="__codelineno-59-17" name="__codelineno-59-17"></a><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="nx">nodeReview</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-59-18"><a id="__codelineno-59-18" name="__codelineno-59-18"></a><span class="w">    </span><span class="nx">content</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">s</span><span class="p">[</span><span class="nx">stateKeyContent</span><span class="p">].(</span><span class="kt">string</span><span class="p">)</span>
</span><span id="__span-59-19"><a id="__codelineno-59-19" name="__codelineno-59-19"></a>
</span><span id="__span-59-20"><a id="__codelineno-59-20" name="__codelineno-59-20"></a><span class="w">    </span><span class="c1">// 中断并等待人工输入</span>
</span><span id="__span-59-21"><a id="__codelineno-59-21" name="__codelineno-59-21"></a><span class="w">    </span><span class="nx">result</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">Interrupt</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="p">,</span><span class="w"> </span><span class="nx">interruptKeyReview</span><span class="p">,</span>
</span><span id="__span-59-22"><a id="__codelineno-59-22" name="__codelineno-59-22"></a><span class="w">        </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;请审核: %s&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">content</span><span class="p">))</span>
</span><span id="__span-59-23"><a id="__codelineno-59-23" name="__codelineno-59-23"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-59-24"><a id="__codelineno-59-24" name="__codelineno-59-24"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
</span><span id="__span-59-25"><a id="__codelineno-59-25" name="__codelineno-59-25"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-59-26"><a id="__codelineno-59-26" name="__codelineno-59-26"></a>
</span><span id="__span-59-27"><a id="__codelineno-59-27" name="__codelineno-59-27"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="nx">stateKeyDecision</span><span class="p">:</span><span class="w"> </span><span class="nx">result</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-59-28"><a id="__codelineno-59-28" name="__codelineno-59-28"></a><span class="p">})</span>
</span><span id="__span-59-29"><a id="__codelineno-59-29" name="__codelineno-59-29"></a>
</span><span id="__span-59-30"><a id="__codelineno-59-30" name="__codelineno-59-30"></a><span class="c1">// 恢复执行（需要 import agent 包）</span>
</span><span id="__span-59-31"><a id="__codelineno-59-31" name="__codelineno-59-31"></a><span class="nx">eventCh</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">userID</span><span class="p">,</span><span class="w"> </span><span class="nx">sessionID</span><span class="p">,</span>
</span><span id="__span-59-32"><a id="__codelineno-59-32" name="__codelineno-59-32"></a><span class="w">    </span><span class="nx">model</span><span class="p">.</span><span class="nx">NewUserMessage</span><span class="p">(</span><span class="s">&quot;resume&quot;</span><span class="p">),</span>
</span><span id="__span-59-33"><a id="__codelineno-59-33" name="__codelineno-59-33"></a><span class="w">    </span><span class="nx">agent</span><span class="p">.</span><span class="nx">WithRuntimeState</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">any</span><span class="p">{</span>
</span><span id="__span-59-34"><a id="__codelineno-59-34" name="__codelineno-59-34"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">CfgKeyCheckpointID</span><span class="p">:</span><span class="w"> </span><span class="nx">checkpointID</span><span class="p">,</span>
</span><span id="__span-59-35"><a id="__codelineno-59-35" name="__codelineno-59-35"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyResumeMap</span><span class="p">:</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">any</span><span class="p">{</span>
</span><span id="__span-59-36"><a id="__codelineno-59-36" name="__codelineno-59-36"></a><span class="w">            </span><span class="s">&quot;review_key&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;approved&quot;</span><span class="p">,</span>
</span><span id="__span-59-37"><a id="__codelineno-59-37" name="__codelineno-59-37"></a><span class="w">        </span><span class="p">},</span>
</span><span id="__span-59-38"><a id="__codelineno-59-38" name="__codelineno-59-38"></a><span class="w">    </span><span class="p">}),</span>
</span><span id="__span-59-39"><a id="__codelineno-59-39" name="__codelineno-59-39"></a><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>恢复辅助函数：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-60-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-60-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-60-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-60-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-60-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-60-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-60-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-60-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-60-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-60-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-60-1"><a id="__codelineno-60-1" name="__codelineno-60-1"></a><span class="c1">// 带类型的恢复值读取</span>
</span><span id="__span-60-2"><a id="__codelineno-60-2" name="__codelineno-60-2"></a><span class="k">if</span><span class="w"> </span><span class="nx">v</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">ResumeValue</span><span class="p">[</span><span class="kt">string</span><span class="p">](</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;approval&quot;</span><span class="p">);</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* 使用 v */</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-60-3"><a id="__codelineno-60-3" name="__codelineno-60-3"></a>
</span><span id="__span-60-4"><a id="__codelineno-60-4" name="__codelineno-60-4"></a><span class="c1">// 带默认值</span>
</span><span id="__span-60-5"><a id="__codelineno-60-5" name="__codelineno-60-5"></a><span class="nx">v</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">ResumeValueOrDefault</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">state</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;approval&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;no&quot;</span><span class="p">)</span>
</span><span id="__span-60-6"><a id="__codelineno-60-6" name="__codelineno-60-6"></a>
</span><span id="__span-60-7"><a id="__codelineno-60-7" name="__codelineno-60-7"></a><span class="c1">// 判断/清理</span>
</span><span id="__span-60-8"><a id="__codelineno-60-8" name="__codelineno-60-8"></a><span class="nx">_</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">HasResumeValue</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;approval&quot;</span><span class="p">)</span>
</span><span id="__span-60-9"><a id="__codelineno-60-9" name="__codelineno-60-9"></a><span class="nx">graph</span><span class="p">.</span><span class="nx">ClearResumeValue</span><span class="p">(</span><span class="nx">state</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;approval&quot;</span><span class="p">)</span>
</span><span id="__span-60-10"><a id="__codelineno-60-10" name="__codelineno-60-10"></a><span class="nx">graph</span><span class="p">.</span><span class="nx">ClearAllResumeValues</span><span class="p">(</span><span class="nx">state</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>也可以在执行入口通过命令注入恢复值（无需提前到特定节点）。使用 Runner 传入 <code>RuntimeState</code> 即可：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-61-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-61-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-61-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-61-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-61-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-61-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-61-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-61-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-61-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-61-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-61-1"><a id="__codelineno-61-1" name="__codelineno-61-1"></a><span class="nx">cmd</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewResumeCommand</span><span class="p">().</span>
</span><span id="__span-61-2"><a id="__codelineno-61-2" name="__codelineno-61-2"></a><span class="w">    </span><span class="nx">WithResumeMap</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">any</span><span class="p">{</span><span class="s">&quot;approval&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;yes&quot;</span><span class="p">})</span>
</span><span id="__span-61-3"><a id="__codelineno-61-3" name="__codelineno-61-3"></a>
</span><span id="__span-61-4"><a id="__codelineno-61-4" name="__codelineno-61-4"></a><span class="c1">// 通过 RuntimeState 注入 __command__ 到初始状态</span>
</span><span id="__span-61-5"><a id="__codelineno-61-5" name="__codelineno-61-5"></a><span class="nx">events</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">userID</span><span class="p">,</span><span class="w"> </span><span class="nx">sessionID</span><span class="p">,</span>
</span><span id="__span-61-6"><a id="__codelineno-61-6" name="__codelineno-61-6"></a><span class="w">    </span><span class="nx">model</span><span class="p">.</span><span class="nx">NewUserMessage</span><span class="p">(</span><span class="s">&quot;resume&quot;</span><span class="p">),</span>
</span><span id="__span-61-7"><a id="__codelineno-61-7" name="__codelineno-61-7"></a><span class="w">    </span><span class="nx">agent</span><span class="p">.</span><span class="nx">WithRuntimeState</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">any</span><span class="p">{</span>
</span><span id="__span-61-8"><a id="__codelineno-61-8" name="__codelineno-61-8"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyCommand</span><span class="p">:</span><span class="w"> </span><span class="nx">cmd</span><span class="p">,</span>
</span><span id="__span-61-9"><a id="__codelineno-61-9" name="__codelineno-61-9"></a><span class="w">    </span><span class="p">}),</span>
</span><span id="__span-61-10"><a id="__codelineno-61-10" name="__codelineno-61-10"></a><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="_35">事件监控</h3>
<p>事件流承载了整个图的执行过程与增量输出。下面的示例展示了如何遍历事件并区分图事件与模型增量：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-62-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-62-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-62-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-62-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-62-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-62-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-62-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-62-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-62-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-62-10">10</a></span>
<span class="normal"><a href="#__codelineno-62-11">11</a></span>
<span class="normal"><a href="#__codelineno-62-12">12</a></span>
<span class="normal"><a href="#__codelineno-62-13">13</a></span>
<span class="normal"><a href="#__codelineno-62-14">14</a></span>
<span class="normal"><a href="#__codelineno-62-15">15</a></span>
<span class="normal"><a href="#__codelineno-62-16">16</a></span>
<span class="normal"><a href="#__codelineno-62-17">17</a></span>
<span class="normal"><a href="#__codelineno-62-18">18</a></span>
<span class="normal"><a href="#__codelineno-62-19">19</a></span>
<span class="normal"><a href="#__codelineno-62-20">20</a></span>
<span class="normal"><a href="#__codelineno-62-21">21</a></span>
<span class="normal"><a href="#__codelineno-62-22">22</a></span>
<span class="normal"><a href="#__codelineno-62-23">23</a></span>
<span class="normal"><a href="#__codelineno-62-24">24</a></span>
<span class="normal"><a href="#__codelineno-62-25">25</a></span>
<span class="normal"><a href="#__codelineno-62-26">26</a></span>
<span class="normal"><a href="#__codelineno-62-27">27</a></span>
<span class="normal"><a href="#__codelineno-62-28">28</a></span>
<span class="normal"><a href="#__codelineno-62-29">29</a></span>
<span class="normal"><a href="#__codelineno-62-30">30</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-62-1"><a id="__codelineno-62-1" name="__codelineno-62-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-62-2"><a id="__codelineno-62-2" name="__codelineno-62-2"></a><span class="w">    </span><span class="s">&quot;fmt&quot;</span>
</span><span id="__span-62-3"><a id="__codelineno-62-3" name="__codelineno-62-3"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-62-4"><a id="__codelineno-62-4" name="__codelineno-62-4"></a><span class="p">)</span>
</span><span id="__span-62-5"><a id="__codelineno-62-5" name="__codelineno-62-5"></a>
</span><span id="__span-62-6"><a id="__codelineno-62-6" name="__codelineno-62-6"></a><span class="k">for</span><span class="w"> </span><span class="nx">ev</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">eventCh</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-62-7"><a id="__codelineno-62-7" name="__codelineno-62-7"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">ev</span><span class="p">.</span><span class="nx">Response</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-62-8"><a id="__codelineno-62-8" name="__codelineno-62-8"></a><span class="w">        </span><span class="k">continue</span>
</span><span id="__span-62-9"><a id="__codelineno-62-9" name="__codelineno-62-9"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-62-10"><a id="__codelineno-62-10" name="__codelineno-62-10"></a><span class="w">    </span><span class="c1">// 按对象类型分流（Graph 扩展事件类型见 graph/events.go）</span>
</span><span id="__span-62-11"><a id="__codelineno-62-11" name="__codelineno-62-11"></a><span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="nx">ev</span><span class="p">.</span><span class="nx">Response</span><span class="p">.</span><span class="nx">Object</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-62-12"><a id="__codelineno-62-12" name="__codelineno-62-12"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">ObjectTypeGraphNodeStart</span><span class="p">:</span>
</span><span id="__span-62-13"><a id="__codelineno-62-13" name="__codelineno-62-13"></a><span class="w">        </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;节点开始&quot;</span><span class="p">)</span>
</span><span id="__span-62-14"><a id="__codelineno-62-14" name="__codelineno-62-14"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">ObjectTypeGraphNodeComplete</span><span class="p">:</span>
</span><span id="__span-62-15"><a id="__codelineno-62-15" name="__codelineno-62-15"></a><span class="w">        </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;节点完成&quot;</span><span class="p">)</span>
</span><span id="__span-62-16"><a id="__codelineno-62-16" name="__codelineno-62-16"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">ObjectTypeGraphChannelUpdate</span><span class="p">:</span>
</span><span id="__span-62-17"><a id="__codelineno-62-17" name="__codelineno-62-17"></a><span class="w">        </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;通道更新&quot;</span><span class="p">)</span>
</span><span id="__span-62-18"><a id="__codelineno-62-18" name="__codelineno-62-18"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">ObjectTypeGraphCheckpoint</span><span class="p">,</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">ObjectTypeGraphCheckpointCommitted</span><span class="p">:</span>
</span><span id="__span-62-19"><a id="__codelineno-62-19" name="__codelineno-62-19"></a><span class="w">        </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;检查点事件&quot;</span><span class="p">)</span>
</span><span id="__span-62-20"><a id="__codelineno-62-20" name="__codelineno-62-20"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-62-21"><a id="__codelineno-62-21" name="__codelineno-62-21"></a><span class="w">    </span><span class="c1">// 同时处理模型增量/最终输出</span>
</span><span id="__span-62-22"><a id="__codelineno-62-22" name="__codelineno-62-22"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">ev</span><span class="p">.</span><span class="nx">Response</span><span class="p">.</span><span class="nx">Choices</span><span class="p">)</span><span class="w"> </span><span class="p">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-62-23"><a id="__codelineno-62-23" name="__codelineno-62-23"></a><span class="w">        </span><span class="nx">ch</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">ev</span><span class="p">.</span><span class="nx">Response</span><span class="p">.</span><span class="nx">Choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="__span-62-24"><a id="__codelineno-62-24" name="__codelineno-62-24"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">ev</span><span class="p">.</span><span class="nx">Response</span><span class="p">.</span><span class="nx">IsPartial</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">ch</span><span class="p">.</span><span class="nx">Delta</span><span class="p">.</span><span class="nx">Content</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-62-25"><a id="__codelineno-62-25" name="__codelineno-62-25"></a><span class="w">            </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Print</span><span class="p">(</span><span class="nx">ch</span><span class="p">.</span><span class="nx">Delta</span><span class="p">.</span><span class="nx">Content</span><span class="p">)</span>
</span><span id="__span-62-26"><a id="__codelineno-62-26" name="__codelineno-62-26"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">!</span><span class="nx">ev</span><span class="p">.</span><span class="nx">Response</span><span class="p">.</span><span class="nx">IsPartial</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">ch</span><span class="p">.</span><span class="nx">Message</span><span class="p">.</span><span class="nx">Content</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-62-27"><a id="__codelineno-62-27" name="__codelineno-62-27"></a><span class="w">            </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;\n输出:&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">ch</span><span class="p">.</span><span class="nx">Message</span><span class="p">.</span><span class="nx">Content</span><span class="p">)</span>
</span><span id="__span-62-28"><a id="__codelineno-62-28" name="__codelineno-62-28"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-62-29"><a id="__codelineno-62-29" name="__codelineno-62-29"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-62-30"><a id="__codelineno-62-30" name="__codelineno-62-30"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>在实际使用中，建议结合 Event 的 <code>Author</code> 字段进行过滤：</p>
<ul>
<li>节点级事件（模型、工具、节点起止）：<code>Author = &lt;nodeID&gt;</code>（若无法获取 nodeID，则为 <code>graph-node</code>）</li>
<li>Pregel（规划/执行/更新/错误）：<code>Author = graph.AuthorGraphPregel</code></li>
<li>执行器级别事件（状态更新/检查点等）：<code>Author = graph.AuthorGraphExecutor</code></li>
<li>用户输入事件（Runner 写入）：<code>Author = user</code></li>
</ul>
<p>利用这一约定，你可以精准订阅某个节点的流式输出，而无需在节点之间传递流式上下文（流式由事件通道统一承载，状态仍按 LangGraph 风格以结构化 State 传递）。</p>
<p>示例：仅消费节点 <code>ask</code> 的流式输出，并在完成时打印最终消息。</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-63-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-63-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-63-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-63-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-63-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-63-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-63-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-63-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-63-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-63-10">10</a></span>
<span class="normal"><a href="#__codelineno-63-11">11</a></span>
<span class="normal"><a href="#__codelineno-63-12">12</a></span>
<span class="normal"><a href="#__codelineno-63-13">13</a></span>
<span class="normal"><a href="#__codelineno-63-14">14</a></span>
<span class="normal"><a href="#__codelineno-63-15">15</a></span>
<span class="normal"><a href="#__codelineno-63-16">16</a></span>
<span class="normal"><a href="#__codelineno-63-17">17</a></span>
<span class="normal"><a href="#__codelineno-63-18">18</a></span>
<span class="normal"><a href="#__codelineno-63-19">19</a></span>
<span class="normal"><a href="#__codelineno-63-20">20</a></span>
<span class="normal"><a href="#__codelineno-63-21">21</a></span>
<span class="normal"><a href="#__codelineno-63-22">22</a></span>
<span class="normal"><a href="#__codelineno-63-23">23</a></span>
<span class="normal"><a href="#__codelineno-63-24">24</a></span>
<span class="normal"><a href="#__codelineno-63-25">25</a></span>
<span class="normal"><a href="#__codelineno-63-26">26</a></span>
<span class="normal"><a href="#__codelineno-63-27">27</a></span>
<span class="normal"><a href="#__codelineno-63-28">28</a></span>
<span class="normal"><a href="#__codelineno-63-29">29</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-63-1"><a id="__codelineno-63-1" name="__codelineno-63-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-63-2"><a id="__codelineno-63-2" name="__codelineno-63-2"></a><span class="w">    </span><span class="s">&quot;fmt&quot;</span>
</span><span id="__span-63-3"><a id="__codelineno-63-3" name="__codelineno-63-3"></a>
</span><span id="__span-63-4"><a id="__codelineno-63-4" name="__codelineno-63-4"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-63-5"><a id="__codelineno-63-5" name="__codelineno-63-5"></a><span class="p">)</span>
</span><span id="__span-63-6"><a id="__codelineno-63-6" name="__codelineno-63-6"></a>
</span><span id="__span-63-7"><a id="__codelineno-63-7" name="__codelineno-63-7"></a><span class="kd">const</span><span class="w"> </span><span class="nx">nodeIDWatch</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;ask&quot;</span>
</span><span id="__span-63-8"><a id="__codelineno-63-8" name="__codelineno-63-8"></a>
</span><span id="__span-63-9"><a id="__codelineno-63-9" name="__codelineno-63-9"></a><span class="k">for</span><span class="w"> </span><span class="nx">ev</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">eventCh</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-63-10"><a id="__codelineno-63-10" name="__codelineno-63-10"></a><span class="w">    </span><span class="c1">// 仅关注来自指定节点的事件</span>
</span><span id="__span-63-11"><a id="__codelineno-63-11" name="__codelineno-63-11"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">ev</span><span class="p">.</span><span class="nx">Author</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">nodeIDWatch</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-63-12"><a id="__codelineno-63-12" name="__codelineno-63-12"></a><span class="w">        </span><span class="k">continue</span>
</span><span id="__span-63-13"><a id="__codelineno-63-13" name="__codelineno-63-13"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-63-14"><a id="__codelineno-63-14" name="__codelineno-63-14"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">ev</span><span class="p">.</span><span class="nx">Response</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">ev</span><span class="p">.</span><span class="nx">Response</span><span class="p">.</span><span class="nx">Choices</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-63-15"><a id="__codelineno-63-15" name="__codelineno-63-15"></a><span class="w">        </span><span class="k">continue</span>
</span><span id="__span-63-16"><a id="__codelineno-63-16" name="__codelineno-63-16"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-63-17"><a id="__codelineno-63-17" name="__codelineno-63-17"></a><span class="w">    </span><span class="nx">choice</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">ev</span><span class="p">.</span><span class="nx">Response</span><span class="p">.</span><span class="nx">Choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="__span-63-18"><a id="__codelineno-63-18" name="__codelineno-63-18"></a>
</span><span id="__span-63-19"><a id="__codelineno-63-19" name="__codelineno-63-19"></a><span class="w">    </span><span class="c1">// 节点的流式增量（Delta）</span>
</span><span id="__span-63-20"><a id="__codelineno-63-20" name="__codelineno-63-20"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">ev</span><span class="p">.</span><span class="nx">Response</span><span class="p">.</span><span class="nx">IsPartial</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">choice</span><span class="p">.</span><span class="nx">Delta</span><span class="p">.</span><span class="nx">Content</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-63-21"><a id="__codelineno-63-21" name="__codelineno-63-21"></a><span class="w">        </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Print</span><span class="p">(</span><span class="nx">choice</span><span class="p">.</span><span class="nx">Delta</span><span class="p">.</span><span class="nx">Content</span><span class="p">)</span>
</span><span id="__span-63-22"><a id="__codelineno-63-22" name="__codelineno-63-22"></a><span class="w">        </span><span class="k">continue</span>
</span><span id="__span-63-23"><a id="__codelineno-63-23" name="__codelineno-63-23"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-63-24"><a id="__codelineno-63-24" name="__codelineno-63-24"></a>
</span><span id="__span-63-25"><a id="__codelineno-63-25" name="__codelineno-63-25"></a><span class="w">    </span><span class="c1">// 节点的最终完整消息</span>
</span><span id="__span-63-26"><a id="__codelineno-63-26" name="__codelineno-63-26"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">!</span><span class="nx">ev</span><span class="p">.</span><span class="nx">Response</span><span class="p">.</span><span class="nx">IsPartial</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">choice</span><span class="p">.</span><span class="nx">Message</span><span class="p">.</span><span class="nx">Content</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-63-27"><a id="__codelineno-63-27" name="__codelineno-63-27"></a><span class="w">        </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;\n[ask] 最终输出:&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">choice</span><span class="p">.</span><span class="nx">Message</span><span class="p">.</span><span class="nx">Content</span><span class="p">)</span>
</span><span id="__span-63-28"><a id="__codelineno-63-28" name="__codelineno-63-28"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-63-29"><a id="__codelineno-63-29" name="__codelineno-63-29"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<h4 id="statedelta_1">事件元数据（StateDelta）</h4>
<p>每个事件还携带 <code>StateDelta</code>，可读取模型/工具等执行元数据：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-64-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-64-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-64-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-64-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-64-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-64-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-64-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-64-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-64-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-64-10">10</a></span>
<span class="normal"><a href="#__codelineno-64-11">11</a></span>
<span class="normal"><a href="#__codelineno-64-12">12</a></span>
<span class="normal"><a href="#__codelineno-64-13">13</a></span>
<span class="normal"><a href="#__codelineno-64-14">14</a></span>
<span class="normal"><a href="#__codelineno-64-15">15</a></span>
<span class="normal"><a href="#__codelineno-64-16">16</a></span>
<span class="normal"><a href="#__codelineno-64-17">17</a></span>
<span class="normal"><a href="#__codelineno-64-18">18</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-64-1"><a id="__codelineno-64-1" name="__codelineno-64-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-64-2"><a id="__codelineno-64-2" name="__codelineno-64-2"></a><span class="w">    </span><span class="s">&quot;encoding/json&quot;</span>
</span><span id="__span-64-3"><a id="__codelineno-64-3" name="__codelineno-64-3"></a>
</span><span id="__span-64-4"><a id="__codelineno-64-4" name="__codelineno-64-4"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-64-5"><a id="__codelineno-64-5" name="__codelineno-64-5"></a><span class="p">)</span>
</span><span id="__span-64-6"><a id="__codelineno-64-6" name="__codelineno-64-6"></a>
</span><span id="__span-64-7"><a id="__codelineno-64-7" name="__codelineno-64-7"></a><span class="k">for</span><span class="w"> </span><span class="nx">ev</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">events</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-64-8"><a id="__codelineno-64-8" name="__codelineno-64-8"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">ev</span><span class="p">.</span><span class="nx">StateDelta</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">continue</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-64-9"><a id="__codelineno-64-9" name="__codelineno-64-9"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">ev</span><span class="p">.</span><span class="nx">StateDelta</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">MetadataKeyModel</span><span class="p">];</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-64-10"><a id="__codelineno-64-10" name="__codelineno-64-10"></a><span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="nx">md</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">ModelExecutionMetadata</span>
</span><span id="__span-64-11"><a id="__codelineno-64-11" name="__codelineno-64-11"></a><span class="w">        </span><span class="nx">_</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">json</span><span class="p">.</span><span class="nx">Unmarshal</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">md</span><span class="p">)</span>
</span><span id="__span-64-12"><a id="__codelineno-64-12" name="__codelineno-64-12"></a><span class="w">        </span><span class="c1">// 使用 md.Input / md.Output / md.Duration 等</span>
</span><span id="__span-64-13"><a id="__codelineno-64-13" name="__codelineno-64-13"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-64-14"><a id="__codelineno-64-14" name="__codelineno-64-14"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">ev</span><span class="p">.</span><span class="nx">StateDelta</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">MetadataKeyTool</span><span class="p">];</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-64-15"><a id="__codelineno-64-15" name="__codelineno-64-15"></a><span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="nx">td</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">ToolExecutionMetadata</span>
</span><span id="__span-64-16"><a id="__codelineno-64-16" name="__codelineno-64-16"></a><span class="w">        </span><span class="nx">_</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">json</span><span class="p">.</span><span class="nx">Unmarshal</span><span class="p">(</span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">td</span><span class="p">)</span>
</span><span id="__span-64-17"><a id="__codelineno-64-17" name="__codelineno-64-17"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-64-18"><a id="__codelineno-64-18" name="__codelineno-64-18"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<h4 id="_36">在节点回调中携带业务值</h4>
<p>默认情况下，中途事件（如 <code>graph.state.update</code>）只会上报“更新了哪些键”，不携带值；最终完成事件（<code>graph.execution</code>）的 <code>StateDelta</code> 才包含“最终状态快照”。如果仅需在“某个节点”完成后，将其返回的部分键值即时发给上游服务，可在该节点的 After 回调中构造并发送一条自定义事件：</p>
<p>实现步骤：
- 在节点上注册 <code>WithPostNodeCallback</code>；
- 在回调的 <code>result any</code> 中读取该节点返回的 <code>graph.State</code>（state delta）；
- 选择需要的键值，序列化后放入自定义事件的 <code>StateDelta</code>；
- 通过 <code>agent.EmitEvent</code> 发送到事件通道。</p>
<p>示例：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-65-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-65-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-65-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-65-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-65-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-65-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-65-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-65-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-65-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-65-10">10</a></span>
<span class="normal"><a href="#__codelineno-65-11">11</a></span>
<span class="normal"><a href="#__codelineno-65-12">12</a></span>
<span class="normal"><a href="#__codelineno-65-13">13</a></span>
<span class="normal"><a href="#__codelineno-65-14">14</a></span>
<span class="normal"><a href="#__codelineno-65-15">15</a></span>
<span class="normal"><a href="#__codelineno-65-16">16</a></span>
<span class="normal"><a href="#__codelineno-65-17">17</a></span>
<span class="normal"><a href="#__codelineno-65-18">18</a></span>
<span class="normal"><a href="#__codelineno-65-19">19</a></span>
<span class="normal"><a href="#__codelineno-65-20">20</a></span>
<span class="normal"><a href="#__codelineno-65-21">21</a></span>
<span class="normal"><a href="#__codelineno-65-22">22</a></span>
<span class="normal"><a href="#__codelineno-65-23">23</a></span>
<span class="normal"><a href="#__codelineno-65-24">24</a></span>
<span class="normal"><a href="#__codelineno-65-25">25</a></span>
<span class="normal"><a href="#__codelineno-65-26">26</a></span>
<span class="normal"><a href="#__codelineno-65-27">27</a></span>
<span class="normal"><a href="#__codelineno-65-28">28</a></span>
<span class="normal"><a href="#__codelineno-65-29">29</a></span>
<span class="normal"><a href="#__codelineno-65-30">30</a></span>
<span class="normal"><a href="#__codelineno-65-31">31</a></span>
<span class="normal"><a href="#__codelineno-65-32">32</a></span>
<span class="normal"><a href="#__codelineno-65-33">33</a></span>
<span class="normal"><a href="#__codelineno-65-34">34</a></span>
<span class="normal"><a href="#__codelineno-65-35">35</a></span>
<span class="normal"><a href="#__codelineno-65-36">36</a></span>
<span class="normal"><a href="#__codelineno-65-37">37</a></span>
<span class="normal"><a href="#__codelineno-65-38">38</a></span>
<span class="normal"><a href="#__codelineno-65-39">39</a></span>
<span class="normal"><a href="#__codelineno-65-40">40</a></span>
<span class="normal"><a href="#__codelineno-65-41">41</a></span>
<span class="normal"><a href="#__codelineno-65-42">42</a></span>
<span class="normal"><a href="#__codelineno-65-43">43</a></span>
<span class="normal"><a href="#__codelineno-65-44">44</a></span>
<span class="normal"><a href="#__codelineno-65-45">45</a></span>
<span class="normal"><a href="#__codelineno-65-46">46</a></span>
<span class="normal"><a href="#__codelineno-65-47">47</a></span>
<span class="normal"><a href="#__codelineno-65-48">48</a></span>
<span class="normal"><a href="#__codelineno-65-49">49</a></span>
<span class="normal"><a href="#__codelineno-65-50">50</a></span>
<span class="normal"><a href="#__codelineno-65-51">51</a></span>
<span class="normal"><a href="#__codelineno-65-52">52</a></span>
<span class="normal"><a href="#__codelineno-65-53">53</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-65-1"><a id="__codelineno-65-1" name="__codelineno-65-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-65-2"><a id="__codelineno-65-2" name="__codelineno-65-2"></a><span class="w">    </span><span class="s">&quot;context&quot;</span>
</span><span id="__span-65-3"><a id="__codelineno-65-3" name="__codelineno-65-3"></a><span class="w">    </span><span class="s">&quot;encoding/json&quot;</span>
</span><span id="__span-65-4"><a id="__codelineno-65-4" name="__codelineno-65-4"></a>
</span><span id="__span-65-5"><a id="__codelineno-65-5" name="__codelineno-65-5"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/agent&quot;</span>
</span><span id="__span-65-6"><a id="__codelineno-65-6" name="__codelineno-65-6"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-65-7"><a id="__codelineno-65-7" name="__codelineno-65-7"></a><span class="p">)</span>
</span><span id="__span-65-8"><a id="__codelineno-65-8" name="__codelineno-65-8"></a>
</span><span id="__span-65-9"><a id="__codelineno-65-9" name="__codelineno-65-9"></a><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-65-10"><a id="__codelineno-65-10" name="__codelineno-65-10"></a><span class="w">    </span><span class="nx">nodeParse</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;parse&quot;</span>
</span><span id="__span-65-11"><a id="__codelineno-65-11" name="__codelineno-65-11"></a><span class="w">    </span><span class="nx">stateKeyOut</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;parsed_value&quot;</span><span class="w"> </span><span class="c1">// 仅输出所需键</span>
</span><span id="__span-65-12"><a id="__codelineno-65-12" name="__codelineno-65-12"></a><span class="p">)</span>
</span><span id="__span-65-13"><a id="__codelineno-65-13" name="__codelineno-65-13"></a>
</span><span id="__span-65-14"><a id="__codelineno-65-14" name="__codelineno-65-14"></a><span class="kd">func</span><span class="w"> </span><span class="nx">parseNode</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-65-15"><a id="__codelineno-65-15" name="__codelineno-65-15"></a><span class="w">    </span><span class="c1">// ...业务处理...</span>
</span><span id="__span-65-16"><a id="__codelineno-65-16" name="__codelineno-65-16"></a><span class="w">    </span><span class="nx">val</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">any</span><span class="p">{</span><span class="s">&quot;ok&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;score&quot;</span><span class="p">:</span><span class="w"> </span><span class="mf">0.97</span><span class="p">}</span>
</span><span id="__span-65-17"><a id="__codelineno-65-17" name="__codelineno-65-17"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="nx">stateKeyOut</span><span class="p">:</span><span class="w"> </span><span class="nx">val</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-65-18"><a id="__codelineno-65-18" name="__codelineno-65-18"></a><span class="p">}</span>
</span><span id="__span-65-19"><a id="__codelineno-65-19" name="__codelineno-65-19"></a>
</span><span id="__span-65-20"><a id="__codelineno-65-20" name="__codelineno-65-20"></a><span class="kd">func</span><span class="w"> </span><span class="nx">buildGraph</span><span class="p">()</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">graph</span><span class="p">.</span><span class="nx">Graph</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-65-21"><a id="__codelineno-65-21" name="__codelineno-65-21"></a><span class="w">    </span><span class="nx">sg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateGraph</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">MessagesStateSchema</span><span class="p">())</span>
</span><span id="__span-65-22"><a id="__codelineno-65-22" name="__codelineno-65-22"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="nx">nodeParse</span><span class="p">,</span><span class="w"> </span><span class="nx">parseNode</span><span class="p">,</span>
</span><span id="__span-65-23"><a id="__codelineno-65-23" name="__codelineno-65-23"></a><span class="w">        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">WithPostNodeCallback</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span>
</span><span id="__span-65-24"><a id="__codelineno-65-24" name="__codelineno-65-24"></a><span class="w">            </span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span>
</span><span id="__span-65-25"><a id="__codelineno-65-25" name="__codelineno-65-25"></a><span class="w">            </span><span class="nx">cb</span><span class="w"> </span><span class="o">*</span><span class="nx">graph</span><span class="p">.</span><span class="nx">NodeCallbackContext</span><span class="p">,</span>
</span><span id="__span-65-26"><a id="__codelineno-65-26" name="__codelineno-65-26"></a><span class="w">            </span><span class="nx">st</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">,</span>
</span><span id="__span-65-27"><a id="__codelineno-65-27" name="__codelineno-65-27"></a><span class="w">            </span><span class="nx">result</span><span class="w"> </span><span class="kt">any</span><span class="p">,</span>
</span><span id="__span-65-28"><a id="__codelineno-65-28" name="__codelineno-65-28"></a><span class="w">            </span><span class="nx">nodeErr</span><span class="w"> </span><span class="kt">error</span><span class="p">,</span>
</span><span id="__span-65-29"><a id="__codelineno-65-29" name="__codelineno-65-29"></a><span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-65-30"><a id="__codelineno-65-30" name="__codelineno-65-30"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">nodeErr</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-65-31"><a id="__codelineno-65-31" name="__codelineno-65-31"></a><span class="w">            </span><span class="nx">inv</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">agent</span><span class="p">.</span><span class="nx">InvocationFromContext</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
</span><span id="__span-65-32"><a id="__codelineno-65-32" name="__codelineno-65-32"></a><span class="w">            </span><span class="nx">execCtx</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">st</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyExecContext</span><span class="p">].(</span><span class="o">*</span><span class="nx">graph</span><span class="p">.</span><span class="nx">ExecutionContext</span><span class="p">)</span>
</span><span id="__span-65-33"><a id="__codelineno-65-33" name="__codelineno-65-33"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">delta</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">result</span><span class="p">.(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">);</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-65-34"><a id="__codelineno-65-34" name="__codelineno-65-34"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="nx">v</span><span class="p">,</span><span class="w"> </span><span class="nx">exists</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">delta</span><span class="p">[</span><span class="nx">stateKeyOut</span><span class="p">];</span><span class="w"> </span><span class="nx">exists</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">execCtx</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-65-35"><a id="__codelineno-65-35" name="__codelineno-65-35"></a><span class="w">                    </span><span class="nx">evt</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewGraphEvent</span><span class="p">(</span>
</span><span id="__span-65-36"><a id="__codelineno-65-36" name="__codelineno-65-36"></a><span class="w">                        </span><span class="nx">inv</span><span class="p">.</span><span class="nx">InvocationID</span><span class="p">,</span>
</span><span id="__span-65-37"><a id="__codelineno-65-37" name="__codelineno-65-37"></a><span class="w">                        </span><span class="nx">cb</span><span class="p">.</span><span class="nx">NodeID</span><span class="p">,</span>
</span><span id="__span-65-38"><a id="__codelineno-65-38" name="__codelineno-65-38"></a><span class="w">                        </span><span class="nx">graph</span><span class="p">.</span><span class="nx">ObjectTypeGraphNodeExecution</span><span class="p">,</span>
</span><span id="__span-65-39"><a id="__codelineno-65-39" name="__codelineno-65-39"></a><span class="w">                    </span><span class="p">)</span>
</span><span id="__span-65-40"><a id="__codelineno-65-40" name="__codelineno-65-40"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="nx">evt</span><span class="p">.</span><span class="nx">StateDelta</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">evt</span><span class="p">.</span><span class="nx">StateDelta</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">][]</span><span class="kt">byte</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
</span><span id="__span-65-41"><a id="__codelineno-65-41" name="__codelineno-65-41"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="nx">b</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">json</span><span class="p">.</span><span class="nx">Marshal</span><span class="p">(</span><span class="nx">v</span><span class="p">);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-65-42"><a id="__codelineno-65-42" name="__codelineno-65-42"></a><span class="w">                        </span><span class="nx">evt</span><span class="p">.</span><span class="nx">StateDelta</span><span class="p">[</span><span class="nx">stateKeyOut</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">b</span>
</span><span id="__span-65-43"><a id="__codelineno-65-43" name="__codelineno-65-43"></a><span class="w">                        </span><span class="nx">_</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">agent</span><span class="p">.</span><span class="nx">EmitEvent</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">inv</span><span class="p">,</span><span class="w"> </span><span class="nx">execCtx</span><span class="p">.</span><span class="nx">EventChan</span><span class="p">,</span><span class="w"> </span><span class="nx">evt</span><span class="p">)</span>
</span><span id="__span-65-44"><a id="__codelineno-65-44" name="__codelineno-65-44"></a><span class="w">                    </span><span class="p">}</span>
</span><span id="__span-65-45"><a id="__codelineno-65-45" name="__codelineno-65-45"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-65-46"><a id="__codelineno-65-46" name="__codelineno-65-46"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-65-47"><a id="__codelineno-65-47" name="__codelineno-65-47"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-65-48"><a id="__codelineno-65-48" name="__codelineno-65-48"></a><span class="w">        </span><span class="p">}),</span>
</span><span id="__span-65-49"><a id="__codelineno-65-49" name="__codelineno-65-49"></a><span class="w">    </span><span class="p">).</span>
</span><span id="__span-65-50"><a id="__codelineno-65-50" name="__codelineno-65-50"></a><span class="w">        </span><span class="nx">SetEntryPoint</span><span class="p">(</span><span class="nx">nodeParse</span><span class="p">).</span>
</span><span id="__span-65-51"><a id="__codelineno-65-51" name="__codelineno-65-51"></a><span class="w">        </span><span class="nx">SetFinishPoint</span><span class="p">(</span><span class="nx">nodeParse</span><span class="p">)</span>
</span><span id="__span-65-52"><a id="__codelineno-65-52" name="__codelineno-65-52"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">sg</span><span class="p">.</span><span class="nx">Compile</span><span class="p">()</span>
</span><span id="__span-65-53"><a id="__codelineno-65-53" name="__codelineno-65-53"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>建议：
- 仅输出必要键，控制负载与敏感信息；
- 内部/易变键不会被序列化到最终快照，亦不建议外发（参考 <a href="https://github.com/trpc-group/trpc-agent-go/blob/main/graph/internal_keys.go#L16">graph/internal_keys.go:16</a>）；
- 文本类中间结果优先复用模型流式事件（<code>choice.Delta.Content</code>）。</p>
<p>也可以在 Agent 级别配置回调：</p>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-66-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-66-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-66-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-66-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-66-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-66-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-66-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-66-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-66-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-66-10">10</a></span>
<span class="normal"><a href="#__codelineno-66-11">11</a></span>
<span class="normal"><a href="#__codelineno-66-12">12</a></span>
<span class="normal"><a href="#__codelineno-66-13">13</a></span>
<span class="normal"><a href="#__codelineno-66-14">14</a></span>
<span class="normal"><a href="#__codelineno-66-15">15</a></span>
<span class="normal"><a href="#__codelineno-66-16">16</a></span>
<span class="normal"><a href="#__codelineno-66-17">17</a></span>
<span class="normal"><a href="#__codelineno-66-18">18</a></span>
<span class="normal"><a href="#__codelineno-66-19">19</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-66-1"><a id="__codelineno-66-1" name="__codelineno-66-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-66-2"><a id="__codelineno-66-2" name="__codelineno-66-2"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/agent&quot;</span>
</span><span id="__span-66-3"><a id="__codelineno-66-3" name="__codelineno-66-3"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/model&quot;</span>
</span><span id="__span-66-4"><a id="__codelineno-66-4" name="__codelineno-66-4"></a><span class="p">)</span>
</span><span id="__span-66-5"><a id="__codelineno-66-5" name="__codelineno-66-5"></a>
</span><span id="__span-66-6"><a id="__codelineno-66-6" name="__codelineno-66-6"></a><span class="c1">// 方式一：构造回调并注册（推荐）</span>
</span><span id="__span-66-7"><a id="__codelineno-66-7" name="__codelineno-66-7"></a><span class="nx">cb</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">agent</span><span class="p">.</span><span class="nx">NewCallbacks</span><span class="p">().</span>
</span><span id="__span-66-8"><a id="__codelineno-66-8" name="__codelineno-66-8"></a><span class="w">    </span><span class="nx">RegisterBeforeAgent</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">inv</span><span class="w"> </span><span class="o">*</span><span class="nx">agent</span><span class="p">.</span><span class="nx">Invocation</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">model</span><span class="p">.</span><span class="nx">Response</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-66-9"><a id="__codelineno-66-9" name="__codelineno-66-9"></a><span class="w">        </span><span class="c1">// 返回非空 *model.Response 可直接短路此轮执行</span>
</span><span id="__span-66-10"><a id="__codelineno-66-10" name="__codelineno-66-10"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-66-11"><a id="__codelineno-66-11" name="__codelineno-66-11"></a><span class="w">    </span><span class="p">}).</span>
</span><span id="__span-66-12"><a id="__codelineno-66-12" name="__codelineno-66-12"></a><span class="w">    </span><span class="nx">RegisterAfterAgent</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">inv</span><span class="w"> </span><span class="o">*</span><span class="nx">agent</span><span class="p">.</span><span class="nx">Invocation</span><span class="p">,</span><span class="w"> </span><span class="nx">runErr</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">model</span><span class="p">.</span><span class="nx">Response</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-66-13"><a id="__codelineno-66-13" name="__codelineno-66-13"></a><span class="w">        </span><span class="c1">// 可对最终响应做统一修改/替换</span>
</span><span id="__span-66-14"><a id="__codelineno-66-14" name="__codelineno-66-14"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-66-15"><a id="__codelineno-66-15" name="__codelineno-66-15"></a><span class="w">    </span><span class="p">})</span>
</span><span id="__span-66-16"><a id="__codelineno-66-16" name="__codelineno-66-16"></a>
</span><span id="__span-66-17"><a id="__codelineno-66-17" name="__codelineno-66-17"></a><span class="nx">graphAgent</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;workflow&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">g</span><span class="p">,</span>
</span><span id="__span-66-18"><a id="__codelineno-66-18" name="__codelineno-66-18"></a><span class="w">    </span><span class="nx">graphagent</span><span class="p">.</span><span class="nx">WithAgentCallbacks</span><span class="p">(</span><span class="nx">cb</span><span class="p">),</span>
</span><span id="__span-66-19"><a id="__codelineno-66-19" name="__codelineno-66-19"></a><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<h2 id="_37">常见问题排查</h2>
<ul>
<li>报错 "graph must have an entry point"<ul>
<li>未设置入口点。调用 <code>SetEntryPoint()</code>，并确保目标节点已定义。</li>
</ul>
</li>
</ul>
<ul>
<li>报错目标/源节点不存在<ul>
<li>在连边/条件路由前先定义节点；条件路由的 <code>pathMap</code> 目标也需存在。</li>
</ul>
</li>
</ul>
<ul>
<li>工具未执行<ul>
<li>确认 LLM 返回了 <code>tool_calls</code>，并使用了 <code>AddToolsConditionalEdges(ask, tools, fallback)</code>；</li>
<li>工具名需与模型声明一致；</li>
<li>配对规则是从最近一次 <code>assistant(tool_calls)</code> 回溯到下一个 <code>user</code>，检查消息顺序。</li>
</ul>
</li>
</ul>
<ul>
<li>没有观察到流式事件<ul>
<li>调大 <code>WithChannelBufferSize</code> 并按 <code>Author</code>/对象类型过滤；</li>
<li>确认从 <code>Runner.Run(...)</code> 消费事件。</li>
</ul>
</li>
</ul>
<ul>
<li>从检查点恢复未按预期继续<ul>
<li>通过 <code>agent.WithRuntimeState(map[string]any{ graph.CfgKeyCheckpointID: "..." })</code> 传入；</li>
<li>HITL 恢复时提供 <code>ResumeMap</code>；纯 "resume" 文本不会注入到 <code>graph.StateKeyUserInput</code>。</li>
</ul>
</li>
</ul>
<ul>
<li>并行下状态冲突<ul>
<li>为列表/映射等声明合并型 Reducer（如 <code>StringSliceReducer</code>、<code>MergeReducer</code>），避免多个分支覆盖同一键。</li>
</ul>
</li>
</ul>
<h2 id="_38">实际案例</h2>
<h3 id="_39">审批工作流</h3>
<div class="language-go highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-67-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-67-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-67-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-67-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-67-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-67-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-67-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-67-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-67-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-67-10">10</a></span>
<span class="normal"><a href="#__codelineno-67-11">11</a></span>
<span class="normal"><a href="#__codelineno-67-12">12</a></span>
<span class="normal"><a href="#__codelineno-67-13">13</a></span>
<span class="normal"><a href="#__codelineno-67-14">14</a></span>
<span class="normal"><a href="#__codelineno-67-15">15</a></span>
<span class="normal"><a href="#__codelineno-67-16">16</a></span>
<span class="normal"><a href="#__codelineno-67-17">17</a></span>
<span class="normal"><a href="#__codelineno-67-18">18</a></span>
<span class="normal"><a href="#__codelineno-67-19">19</a></span>
<span class="normal"><a href="#__codelineno-67-20">20</a></span>
<span class="normal"><a href="#__codelineno-67-21">21</a></span>
<span class="normal"><a href="#__codelineno-67-22">22</a></span>
<span class="normal"><a href="#__codelineno-67-23">23</a></span>
<span class="normal"><a href="#__codelineno-67-24">24</a></span>
<span class="normal"><a href="#__codelineno-67-25">25</a></span>
<span class="normal"><a href="#__codelineno-67-26">26</a></span>
<span class="normal"><a href="#__codelineno-67-27">27</a></span>
<span class="normal"><a href="#__codelineno-67-28">28</a></span>
<span class="normal"><a href="#__codelineno-67-29">29</a></span>
<span class="normal"><a href="#__codelineno-67-30">30</a></span>
<span class="normal"><a href="#__codelineno-67-31">31</a></span>
<span class="normal"><a href="#__codelineno-67-32">32</a></span>
<span class="normal"><a href="#__codelineno-67-33">33</a></span>
<span class="normal"><a href="#__codelineno-67-34">34</a></span>
<span class="normal"><a href="#__codelineno-67-35">35</a></span>
<span class="normal"><a href="#__codelineno-67-36">36</a></span>
<span class="normal"><a href="#__codelineno-67-37">37</a></span>
<span class="normal"><a href="#__codelineno-67-38">38</a></span>
<span class="normal"><a href="#__codelineno-67-39">39</a></span>
<span class="normal"><a href="#__codelineno-67-40">40</a></span>
<span class="normal"><a href="#__codelineno-67-41">41</a></span>
<span class="normal"><a href="#__codelineno-67-42">42</a></span>
<span class="normal"><a href="#__codelineno-67-43">43</a></span>
<span class="normal"><a href="#__codelineno-67-44">44</a></span>
<span class="normal"><a href="#__codelineno-67-45">45</a></span>
<span class="normal"><a href="#__codelineno-67-46">46</a></span>
<span class="normal"><a href="#__codelineno-67-47">47</a></span>
<span class="normal"><a href="#__codelineno-67-48">48</a></span>
<span class="normal"><a href="#__codelineno-67-49">49</a></span>
<span class="normal"><a href="#__codelineno-67-50">50</a></span>
<span class="normal"><a href="#__codelineno-67-51">51</a></span>
<span class="normal"><a href="#__codelineno-67-52">52</a></span>
<span class="normal"><a href="#__codelineno-67-53">53</a></span>
<span class="normal"><a href="#__codelineno-67-54">54</a></span>
<span class="normal"><a href="#__codelineno-67-55">55</a></span>
<span class="normal"><a href="#__codelineno-67-56">56</a></span>
<span class="normal"><a href="#__codelineno-67-57">57</a></span>
<span class="normal"><a href="#__codelineno-67-58">58</a></span>
<span class="normal"><a href="#__codelineno-67-59">59</a></span>
<span class="normal"><a href="#__codelineno-67-60">60</a></span>
<span class="normal"><a href="#__codelineno-67-61">61</a></span>
<span class="normal"><a href="#__codelineno-67-62">62</a></span>
<span class="normal"><a href="#__codelineno-67-63">63</a></span>
<span class="normal"><a href="#__codelineno-67-64">64</a></span>
<span class="normal"><a href="#__codelineno-67-65">65</a></span>
<span class="normal"><a href="#__codelineno-67-66">66</a></span>
<span class="normal"><a href="#__codelineno-67-67">67</a></span>
<span class="normal"><a href="#__codelineno-67-68">68</a></span>
<span class="normal"><a href="#__codelineno-67-69">69</a></span>
<span class="normal"><a href="#__codelineno-67-70">70</a></span>
<span class="normal"><a href="#__codelineno-67-71">71</a></span>
<span class="normal"><a href="#__codelineno-67-72">72</a></span>
<span class="normal"><a href="#__codelineno-67-73">73</a></span>
<span class="normal"><a href="#__codelineno-67-74">74</a></span>
<span class="normal"><a href="#__codelineno-67-75">75</a></span>
<span class="normal"><a href="#__codelineno-67-76">76</a></span>
<span class="normal"><a href="#__codelineno-67-77">77</a></span>
<span class="normal"><a href="#__codelineno-67-78">78</a></span>
<span class="normal"><a href="#__codelineno-67-79">79</a></span>
<span class="normal"><a href="#__codelineno-67-80">80</a></span>
<span class="normal"><a href="#__codelineno-67-81">81</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-67-1"><a id="__codelineno-67-1" name="__codelineno-67-1"></a><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-67-2"><a id="__codelineno-67-2" name="__codelineno-67-2"></a><span class="w">    </span><span class="s">&quot;context&quot;</span>
</span><span id="__span-67-3"><a id="__codelineno-67-3" name="__codelineno-67-3"></a><span class="w">    </span><span class="s">&quot;fmt&quot;</span>
</span><span id="__span-67-4"><a id="__codelineno-67-4" name="__codelineno-67-4"></a><span class="w">    </span><span class="s">&quot;strings&quot;</span>
</span><span id="__span-67-5"><a id="__codelineno-67-5" name="__codelineno-67-5"></a>
</span><span id="__span-67-6"><a id="__codelineno-67-6" name="__codelineno-67-6"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/graph&quot;</span>
</span><span id="__span-67-7"><a id="__codelineno-67-7" name="__codelineno-67-7"></a><span class="w">    </span><span class="s">&quot;trpc.group/trpc-go/trpc-agent-go/model/openai&quot;</span>
</span><span id="__span-67-8"><a id="__codelineno-67-8" name="__codelineno-67-8"></a><span class="p">)</span>
</span><span id="__span-67-9"><a id="__codelineno-67-9" name="__codelineno-67-9"></a>
</span><span id="__span-67-10"><a id="__codelineno-67-10" name="__codelineno-67-10"></a><span class="kd">func</span><span class="w"> </span><span class="nx">buildApprovalWorkflow</span><span class="p">()</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">graph</span><span class="p">.</span><span class="nx">Graph</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-67-11"><a id="__codelineno-67-11" name="__codelineno-67-11"></a><span class="w">    </span><span class="nx">sg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">NewStateGraph</span><span class="p">(</span><span class="nx">graph</span><span class="p">.</span><span class="nx">MessagesStateSchema</span><span class="p">())</span>
</span><span id="__span-67-12"><a id="__codelineno-67-12" name="__codelineno-67-12"></a>
</span><span id="__span-67-13"><a id="__codelineno-67-13" name="__codelineno-67-13"></a><span class="w">    </span><span class="c1">// AI 初审（定义 LLM 模型）</span>
</span><span id="__span-67-14"><a id="__codelineno-67-14" name="__codelineno-67-14"></a><span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">(</span>
</span><span id="__span-67-15"><a id="__codelineno-67-15" name="__codelineno-67-15"></a><span class="w">        </span><span class="nx">modelNameApprove</span><span class="w">      </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;gpt-4o-mini&quot;</span>
</span><span id="__span-67-16"><a id="__codelineno-67-16" name="__codelineno-67-16"></a><span class="w">        </span><span class="nx">promptApproveDecision</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;判断申请是否符合要求，回复 approve 或 reject&quot;</span>
</span><span id="__span-67-17"><a id="__codelineno-67-17" name="__codelineno-67-17"></a>
</span><span id="__span-67-18"><a id="__codelineno-67-18" name="__codelineno-67-18"></a><span class="w">        </span><span class="nx">nodeAIReview</span><span class="w">    </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;ai_review&quot;</span>
</span><span id="__span-67-19"><a id="__codelineno-67-19" name="__codelineno-67-19"></a><span class="w">        </span><span class="nx">nodeHumanReview</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;human_review&quot;</span>
</span><span id="__span-67-20"><a id="__codelineno-67-20" name="__codelineno-67-20"></a><span class="w">        </span><span class="nx">nodeApprove</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;approve&quot;</span>
</span><span id="__span-67-21"><a id="__codelineno-67-21" name="__codelineno-67-21"></a><span class="w">        </span><span class="nx">nodeReject</span><span class="w">      </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;reject&quot;</span>
</span><span id="__span-67-22"><a id="__codelineno-67-22" name="__codelineno-67-22"></a>
</span><span id="__span-67-23"><a id="__codelineno-67-23" name="__codelineno-67-23"></a><span class="w">        </span><span class="nx">routeHumanReview</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;route_human_review&quot;</span>
</span><span id="__span-67-24"><a id="__codelineno-67-24" name="__codelineno-67-24"></a><span class="w">        </span><span class="nx">routeReject</span><span class="w">      </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;route_reject&quot;</span>
</span><span id="__span-67-25"><a id="__codelineno-67-25" name="__codelineno-67-25"></a><span class="w">        </span><span class="nx">routeApprove</span><span class="w">     </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;route_approve&quot;</span>
</span><span id="__span-67-26"><a id="__codelineno-67-26" name="__codelineno-67-26"></a>
</span><span id="__span-67-27"><a id="__codelineno-67-27" name="__codelineno-67-27"></a><span class="w">        </span><span class="nx">stateKeyApplication</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;application&quot;</span>
</span><span id="__span-67-28"><a id="__codelineno-67-28" name="__codelineno-67-28"></a><span class="w">        </span><span class="nx">stateKeyDecision</span><span class="w">    </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;decision&quot;</span>
</span><span id="__span-67-29"><a id="__codelineno-67-29" name="__codelineno-67-29"></a><span class="w">    </span><span class="p">)</span>
</span><span id="__span-67-30"><a id="__codelineno-67-30" name="__codelineno-67-30"></a>
</span><span id="__span-67-31"><a id="__codelineno-67-31" name="__codelineno-67-31"></a><span class="w">    </span><span class="nx">llm</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">openai</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="nx">modelNameApprove</span><span class="p">)</span>
</span><span id="__span-67-32"><a id="__codelineno-67-32" name="__codelineno-67-32"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddLLMNode</span><span class="p">(</span><span class="nx">nodeAIReview</span><span class="p">,</span><span class="w"> </span><span class="nx">llm</span><span class="p">,</span><span class="w"> </span><span class="nx">promptApproveDecision</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span><span class="p">)</span>
</span><span id="__span-67-33"><a id="__codelineno-67-33" name="__codelineno-67-33"></a>
</span><span id="__span-67-34"><a id="__codelineno-67-34" name="__codelineno-67-34"></a><span class="w">    </span><span class="c1">// 条件路由到人工审核或拒绝</span>
</span><span id="__span-67-35"><a id="__codelineno-67-35" name="__codelineno-67-35"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddConditionalEdges</span><span class="p">(</span><span class="nx">nodeAIReview</span><span class="p">,</span>
</span><span id="__span-67-36"><a id="__codelineno-67-36" name="__codelineno-67-36"></a><span class="w">        </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-67-37"><a id="__codelineno-67-37" name="__codelineno-67-37"></a><span class="w">            </span><span class="nx">resp</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">s</span><span class="p">[</span><span class="nx">graph</span><span class="p">.</span><span class="nx">StateKeyLastResponse</span><span class="p">].(</span><span class="kt">string</span><span class="p">)</span>
</span><span id="__span-67-38"><a id="__codelineno-67-38" name="__codelineno-67-38"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">strings</span><span class="p">.</span><span class="nx">Contains</span><span class="p">(</span><span class="nx">resp</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;approve&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-67-39"><a id="__codelineno-67-39" name="__codelineno-67-39"></a><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nx">routeHumanReview</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-67-40"><a id="__codelineno-67-40" name="__codelineno-67-40"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-67-41"><a id="__codelineno-67-41" name="__codelineno-67-41"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">routeReject</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-67-42"><a id="__codelineno-67-42" name="__codelineno-67-42"></a><span class="w">        </span><span class="p">},</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span>
</span><span id="__span-67-43"><a id="__codelineno-67-43" name="__codelineno-67-43"></a><span class="w">            </span><span class="nx">routeHumanReview</span><span class="p">:</span><span class="w"> </span><span class="nx">nodeHumanReview</span><span class="p">,</span>
</span><span id="__span-67-44"><a id="__codelineno-67-44" name="__codelineno-67-44"></a><span class="w">            </span><span class="nx">routeReject</span><span class="p">:</span><span class="w">      </span><span class="nx">nodeReject</span><span class="p">,</span>
</span><span id="__span-67-45"><a id="__codelineno-67-45" name="__codelineno-67-45"></a><span class="w">        </span><span class="p">})</span>
</span><span id="__span-67-46"><a id="__codelineno-67-46" name="__codelineno-67-46"></a>
</span><span id="__span-67-47"><a id="__codelineno-67-47" name="__codelineno-67-47"></a><span class="w">    </span><span class="c1">// 人工审核节点</span>
</span><span id="__span-67-48"><a id="__codelineno-67-48" name="__codelineno-67-48"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="nx">nodeHumanReview</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-67-49"><a id="__codelineno-67-49" name="__codelineno-67-49"></a><span class="w">        </span><span class="nx">app</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">s</span><span class="p">[</span><span class="nx">stateKeyApplication</span><span class="p">].(</span><span class="kt">string</span><span class="p">)</span>
</span><span id="__span-67-50"><a id="__codelineno-67-50" name="__codelineno-67-50"></a><span class="w">        </span><span class="nx">decision</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">Interrupt</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;approval&quot;</span><span class="p">,</span>
</span><span id="__span-67-51"><a id="__codelineno-67-51" name="__codelineno-67-51"></a><span class="w">            </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;请审批: %s&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">app</span><span class="p">))</span>
</span><span id="__span-67-52"><a id="__codelineno-67-52" name="__codelineno-67-52"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-67-53"><a id="__codelineno-67-53" name="__codelineno-67-53"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
</span><span id="__span-67-54"><a id="__codelineno-67-54" name="__codelineno-67-54"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-67-55"><a id="__codelineno-67-55" name="__codelineno-67-55"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="nx">stateKeyDecision</span><span class="p">:</span><span class="w"> </span><span class="nx">decision</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-67-56"><a id="__codelineno-67-56" name="__codelineno-67-56"></a><span class="w">    </span><span class="p">})</span>
</span><span id="__span-67-57"><a id="__codelineno-67-57" name="__codelineno-67-57"></a>
</span><span id="__span-67-58"><a id="__codelineno-67-58" name="__codelineno-67-58"></a><span class="w">    </span><span class="c1">// 结果处理</span>
</span><span id="__span-67-59"><a id="__codelineno-67-59" name="__codelineno-67-59"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="nx">nodeApprove</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-67-60"><a id="__codelineno-67-60" name="__codelineno-67-60"></a><span class="w">        </span><span class="c1">// 执行批准逻辑</span>
</span><span id="__span-67-61"><a id="__codelineno-67-61" name="__codelineno-67-61"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="s">&quot;status&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;approved&quot;</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-67-62"><a id="__codelineno-67-62" name="__codelineno-67-62"></a><span class="w">    </span><span class="p">})</span>
</span><span id="__span-67-63"><a id="__codelineno-67-63" name="__codelineno-67-63"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddNode</span><span class="p">(</span><span class="nx">nodeReject</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">any</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-67-64"><a id="__codelineno-67-64" name="__codelineno-67-64"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="s">&quot;status&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;rejected&quot;</span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-67-65"><a id="__codelineno-67-65" name="__codelineno-67-65"></a><span class="w">    </span><span class="p">})</span>
</span><span id="__span-67-66"><a id="__codelineno-67-66" name="__codelineno-67-66"></a>
</span><span id="__span-67-67"><a id="__codelineno-67-67" name="__codelineno-67-67"></a><span class="w">    </span><span class="c1">// 配置流程</span>
</span><span id="__span-67-68"><a id="__codelineno-67-68" name="__codelineno-67-68"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">SetEntryPoint</span><span class="p">(</span><span class="nx">nodeAIReview</span><span class="p">)</span>
</span><span id="__span-67-69"><a id="__codelineno-67-69" name="__codelineno-67-69"></a><span class="w">    </span><span class="nx">sg</span><span class="p">.</span><span class="nx">AddConditionalEdges</span><span class="p">(</span><span class="nx">nodeHumanReview</span><span class="p">,</span>
</span><span id="__span-67-70"><a id="__codelineno-67-70" name="__codelineno-67-70"></a><span class="w">        </span><span class="kd">func</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">s</span><span class="w"> </span><span class="nx">graph</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-67-71"><a id="__codelineno-67-71" name="__codelineno-67-71"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">s</span><span class="p">[</span><span class="nx">stateKeyDecision</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;approve&quot;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-67-72"><a id="__codelineno-67-72" name="__codelineno-67-72"></a><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nx">routeApprove</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-67-73"><a id="__codelineno-67-73" name="__codelineno-67-73"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-67-74"><a id="__codelineno-67-74" name="__codelineno-67-74"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">routeReject</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
</span><span id="__span-67-75"><a id="__codelineno-67-75" name="__codelineno-67-75"></a><span class="w">        </span><span class="p">},</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span>
</span><span id="__span-67-76"><a id="__codelineno-67-76" name="__codelineno-67-76"></a><span class="w">            </span><span class="nx">routeApprove</span><span class="p">:</span><span class="w"> </span><span class="nx">nodeApprove</span><span class="p">,</span>
</span><span id="__span-67-77"><a id="__codelineno-67-77" name="__codelineno-67-77"></a><span class="w">            </span><span class="nx">routeReject</span><span class="p">:</span><span class="w">  </span><span class="nx">nodeReject</span><span class="p">,</span>
</span><span id="__span-67-78"><a id="__codelineno-67-78" name="__codelineno-67-78"></a><span class="w">        </span><span class="p">})</span>
</span><span id="__span-67-79"><a id="__codelineno-67-79" name="__codelineno-67-79"></a>
</span><span id="__span-67-80"><a id="__codelineno-67-80" name="__codelineno-67-80"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">sg</span><span class="p">.</span><span class="nx">Compile</span><span class="p">()</span>
</span><span id="__span-67-81"><a id="__codelineno-67-81" name="__codelineno-67-81"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<h2 id="_40">总结</h2>
<p>本文介绍了 <code>graph</code> 包与 GraphAgent 的核心用法：如何声明节点与路由、如何通过 Schema 与 Reducer 安全合并状态、以及如何利用事件、检查点与中断实现可观测与可恢复。对于结构化流程（审批、内容审核、分步数据处理等），Graph 提供稳定、可审计的执行路径；对于需要智能决策的环节，可通过 LLM 节点与子 Agent 灵活扩展。</p>
<h2 id="_41">参考与示例</h2>
<ul>
<li>代码仓库: https://github.com/trpc-group/trpc-agent-go</li>
<li>Graph 示例: <code>examples/graph</code> 目录（基础/并行/多轮/中断与恢复等）<ul>
<li>I/O 约定：<code>io_conventions</code>、<code>io_conventions_tools</code></li>
<li>并行 / 扇出：<code>parallel</code>、<code>fanout</code>、<code>diamond</code></li>
<li>占位符：<code>placeholder</code></li>
<li>检查点 / 中断：<code>checkpoint</code>、<code>interrupt</code></li>
</ul>
</li>
<li>进一步阅读：<code>graph/state_graph.go</code>、<code>graph/executor.go</code>、<code>agent/graphagent</code></li>
</ul>







  
    
  
  
    
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="最后更新">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_datetime" title="2025年10月25日 01:43:23 UTC">2025-10-25 01:43:23</span>
  </span>

    
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="创建日期">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_datetime" title="2025年8月25日 07:06:16 UTC">2025-08-25 07:06:16</span>
  </span>

    
    
    
  </aside>


  



  <form class="md-feedback" name="feedback" hidden>
    <fieldset>
      <legend class="md-feedback__title">
        Was this page helpful?
      </legend>
      <div class="md-feedback__inner">
        <div class="md-feedback__list">
          
            <button class="md-feedback__icon md-icon" type="submit" title="This page was helpful" data-md-value="1">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m7 0c0 .8-.7 1.5-1.5 1.5S14 10.3 14 9.5 14.7 8 15.5 8s1.5.7 1.5 1.5m-5 7.73c-1.75 0-3.29-.73-4.19-1.81L9.23 14c.45.72 1.52 1.23 2.77 1.23s2.32-.51 2.77-1.23l1.42 1.42c-.9 1.08-2.44 1.81-4.19 1.81"/></svg>
            </button>
          
            <button class="md-feedback__icon md-icon" type="submit" title="This page could be improved" data-md-value="0">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10m-6.5-4c.8 0 1.5.7 1.5 1.5s-.7 1.5-1.5 1.5-1.5-.7-1.5-1.5.7-1.5 1.5-1.5M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m2 4.5c1.75 0 3.29.72 4.19 1.81l-1.42 1.42C14.32 16.5 13.25 16 12 16s-2.32.5-2.77 1.23l-1.42-1.42C8.71 14.72 10.25 14 12 14"/></svg>
            </button>
          
        </div>
        <div class="md-feedback__note">
          
            <div data-md-value="1" hidden>
              
              
                
              
              
              
                
                
              
              Thanks for your feedback!
            </div>
          
            <div data-md-value="0" hidden>
              
              
                
              
              
              
                
                
              
              Thanks for your feedback!<br>Please help us improve by opening an <a href="https://github.com/trpc-group/trpc-agent-go/issues/new" target="_blank" rel="noopener">issue</a>.
            </div>
          
        </div>
      </div>
    </fieldset>
  </form>


                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="页脚" >
        
          
          <a href="../planner/" class="md-footer__link md-footer__link--prev" aria-label="上一页: Planner">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                上一页
              </span>
              <div class="md-ellipsis">
                Planner
              </div>
            </div>
          </a>
        
        
          
          <a href="../event/" class="md-footer__link md-footer__link--next" aria-label="下一页: Event">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                下一页
              </span>
              <div class="md-ellipsis">
                Event
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["content.code.copy", "navigation.footer", "navigation.tabs", "search.suggest", "search.share", "content.action.edit", "content.action.view"], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.92b07e13.min.js"></script>
      
    
  </body>
</html>