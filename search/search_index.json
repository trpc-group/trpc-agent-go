{"config":{"lang":["en","zh"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"","title":"tRPC-Agent-Go: Empowering Go Developers to Build Intelligent AI Applications","text":""},{"location":"#1-project-introduction","title":"1. Project Introduction","text":"<p>The tRPC team previously open-sourced the A2A development framework tRPC-A2A-Go and MCP development framework tRPC-MCP-Go. Especially tRPC-A2A-Go has gained many users and contributors both domestically and internationally. Now we are launching the tRPC-Agent-Go development framework to complete the Go language AI ecosystem development framework.</p> <p>Most mainstream Agent frameworks (AutoGen, CrewAI, Agno, ADK, etc.) are Python-based, while Go has natural advantages in microservices, concurrency, and deployment. Go also has large-scale applications within Tencent, and there are relatively few Agent frameworks based on Go in the industry. Most are orchestrated workflow frameworks, lacking true \"decentralized, collaborative, emergent\" autonomous multi-Agent capabilities. tRPC-Agent-Go directly leverages Go's high concurrency and tRPC ecosystem to bring LLM reasoning, negotiation, and adaptability to Go scenarios, meeting complex business requirements for both \"intelligence + performance\".</p>"},{"location":"#2-architecture-design","title":"2. Architecture Design","text":"<p>tRPC-Agent-Go adopts a modular architecture design, consisting of multiple core components that are all pluggable. Component communication is decoupled through an event-driven mechanism, supporting callback insertion for custom logic:</p> <ul> <li>Agent: Core execution unit, responsible for processing user input and generating responses</li> <li>Runner: Agent executor, responsible for managing execution flow and connecting Session/Memory Service capabilities</li> <li>Model: Supports multiple LLM models (OpenAI, DeepSeek, etc.)</li> <li>Tool: Provides various tool capabilities (Function, MCP, DuckDuckGo, etc.)</li> <li>Session: Manages user session state and events</li> <li>Memory: Records user long-term memory and personalized information</li> <li>Knowledge: Implements RAG knowledge retrieval capabilities</li> <li>Planner: Provides Agent planning and reasoning capabilities</li> </ul> <p>Below is the architecture diagram of each component:</p> <p></p>"},{"location":"#3-core-features","title":"3. Core Features","text":"<p>Diverse Agent System</p> <ul> <li>LLMAgent: Based on large language models, supports tool calling and reasoning</li> <li>ChainAgent: Chain execution, supports multi-step task decomposition</li> <li>ParallelAgent: Parallel processing, supports multi-expert collaboration</li> <li>CycleAgent: Iterative loops, supports self-optimization</li> <li>GraphAgent: Graph workflow, compatible with existing orchestration habits</li> </ul> <p>Rich Tool Ecosystem</p> <ul> <li>Built-in common tools</li> <li>Supports multiple extension methods like Function, MCP protocol</li> <li>Flexible tool combination and calling strategies</li> </ul> <p>Intelligent Session Management</p> <ul> <li>Supports Redis and in-memory storage for session persistence</li> <li>Long-term memory and personalized information retention</li> <li>RAG retrieval-augmented generation capabilities</li> <li>Real-time event-driven architecture</li> </ul> <p>End-to-End Observability</p> <ul> <li>OpenTelemetry full-link tracing and performance monitoring</li> <li>Visual debugging interface and real-time monitoring</li> <li>Structured logging and error tracking</li> </ul>"},{"location":"#4-quick-start","title":"4. Quick Start","text":""},{"location":"#basic-usage","title":"Basic Usage","text":"<pre><code>package main\n\nimport (\n    \"context\"\n    \"fmt\"\n    \"log\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/agent/llmagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/model\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/openai\"\n    \"trpc.group/trpc-go/trpc-agent-go/runner\"\n    \"trpc.group/trpc-go/trpc-agent-go/tool\"\n    \"trpc.group/trpc-go/trpc-agent-go/tool/function\"\n)\n\nfunc main() {\n    // Create model.\n    modelInstance := openai.New(\"deepseek-chat\")\n\n    // Create tool.\n    calculatorTool := function.NewFunctionTool(\n        calculator,\n        function.WithName(\"calculator\"),\n        function.WithDescription(\"Execute addition, subtraction, multiplication, and division. \"+\n            \"Parameters: a, b are numeric values, op takes values add/sub/mul/div; \"+\n            \"returns result as the calculation result.\"),\n    )\n\n    // Enable streaming output.\n    genConfig := model.GenerationConfig{\n        Stream: true,\n    }\n\n    // Create Agent.\n    agent := llmagent.New(\"assistant\",\n        llmagent.WithModel(modelInstance),\n        llmagent.WithTools([]tool.Tool{calculatorTool}),\n        llmagent.WithGenerationConfig(genConfig),\n    )\n\n    // Create Runner.\n    runner := runner.NewRunner(\"calculator-app\", agent)\n\n    // Execute conversation.\n    ctx := context.Background()\n    events, err := runner.Run(ctx,\n        \"user-001\",\n        \"session-001\",\n        model.NewUserMessage(\"Calculate what 2+3 equals\"),\n    )\n    if err != nil {\n        log.Fatal(err)\n    }\n\n    // Process event stream.\n    for event := range events {\n        if event.Object == \"chat.completion.chunk\" {\n            fmt.Print(event.Response.Choices[0].Delta.Content)\n        }\n    }\n    fmt.Println()\n}\n\nfunc calculator(ctx context.Context, req calculatorReq) (calculatorRsp, error) {\n    var result float64\n    switch req.Op {\n    case \"add\", \"+\":\n        result = req.A + req.B\n    case \"sub\", \"-\":\n        result = req.A - req.B\n    case \"mul\", \"*\":\n        result = req.A * req.B\n    case \"div\", \"/\":\n        result = req.A / req.B\n    }\n    return calculatorRsp{Result: result}, nil\n}\n\ntype calculatorReq struct {\n    A  float64 `json:\"a\"`\n    B  float64 `json:\"b\"`\n    Op string  `json:\"op\"`\n}\n\ntype calculatorRsp struct {\n    Result float64 `json:\"result\"`\n}\n</code></pre>"},{"location":"#multi-agent-collaboration-example","title":"Multi-Agent Collaboration Example","text":"<pre><code>// Create chain Agent.\nchainAgent := chainagent.New(\"problem-solver\",\n    chainagent.WithSubAgents([]agent.Agent{\n        analysisAgent,   // Analysis Agent.\n        executionAgent,  // Execution Agent.\n    }))\n\n// Use Runner to execute.\nrunner := runner.NewRunner(\"multi-agent-app\", chainAgent)\nevents, _ := runner.Run(ctx, userID, sessionID, message)\n</code></pre>"},{"location":"#5-acknowledgments","title":"5. Acknowledgments","text":"<p>Thanks to Tencent internal businesses such as Tencent Yuanbao, Tencent Video, Tencent News, IMA, QQ Music, and other businesses for their support. Business scenario refinement is the best validation for the framework.</p> <p>Thanks to excellent open-source frameworks like ADK, Agno, CrewAI, AutoGen, etc., for their inspiration, providing ideas for tRPC-Agent-Go development.</p>"},{"location":"#6-project-address","title":"6. Project Address","text":"<p>GitHub: tRPC-Agent-Go</p>"},{"location":"a2a/","title":"tRPC-Agent-Go A2A Integration Guide","text":""},{"location":"a2a/#overview","title":"Overview","text":"<p>tRPC-Agent-Go provides a complete A2A (Agent-to-Agent) solution with two core components:</p> <ul> <li>A2A Server: Exposes local Agents as A2A services for other Agents to call</li> <li>A2AAgent: A client proxy for calling remote A2A services, allowing you to use remote Agents as if they were local</li> </ul>"},{"location":"a2a/#core-capabilities","title":"Core Capabilities","text":"<ul> <li>Zero Protocol Awareness: Developers only need to focus on Agent business logic without understanding A2A protocol details</li> <li>Automatic Adaptation: The framework automatically converts Agent information to A2A AgentCard</li> <li>Message Conversion: Automatically handles conversion between A2A protocol messages and Agent message formats</li> </ul>"},{"location":"a2a/#a2a-server-exposing-agents-as-services","title":"A2A Server: Exposing Agents as Services","text":""},{"location":"a2a/#concept-introduction","title":"Concept Introduction","text":"<p>A2A Server is a server-side component provided by tRPC-Agent-Go for quickly converting any local Agent into a network service that complies with the A2A protocol.</p>"},{"location":"a2a/#core-features","title":"Core Features","text":"<ul> <li>One-Click Conversion: Expose Agents as A2A services through simple configuration</li> <li>Automatic Protocol Adaptation: Automatically handles conversion between A2A protocol and Agent interfaces</li> <li>AgentCard Generation: Automatically generates AgentCards required for service discovery</li> <li>Streaming Support: Supports both streaming and non-streaming response modes</li> </ul>"},{"location":"a2a/#automatic-conversion-from-agent-to-a2a","title":"Automatic Conversion from Agent to A2A","text":"<p>tRPC-Agent-Go implements seamless conversion from Agent to A2A service through the <code>server/a2a</code> package:</p> <pre><code>func New(opts ...Option) (*a2a.A2AServer, error) {}\n</code></pre>"},{"location":"a2a/#automatic-agentcard-generation","title":"Automatic AgentCard Generation","text":"<p>The framework automatically extracts Agent metadata (name, description, tools, etc.) to generate an AgentCard that complies with the A2A protocol, including: - Basic Agent information (name, description, URL) - Capability declarations (streaming support) - Skill lists (automatically generated based on Agent tools)</p>"},{"location":"a2a/#message-protocol-conversion","title":"Message Protocol Conversion","text":"<p>The framework includes a built-in <code>messageProcessor</code> that implements bidirectional conversion between A2A protocol messages and Agent message formats, so users don't need to worry about message format conversion details.</p>"},{"location":"a2a/#a2a-server-quick-start","title":"A2A Server Quick Start","text":""},{"location":"a2a/#exposing-agent-services-with-a2a-server","title":"Exposing Agent Services with A2A Server","text":"<p>With just a few lines of code, you can convert any Agent into an A2A service:</p>"},{"location":"a2a/#basic-example-creating-a2a-server","title":"Basic Example: Creating A2A Server","text":"<pre><code>package main\n\nimport (\n    \"trpc.group/trpc-go/trpc-agent-go/agent/llmagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/openai\"\n    a2aserver \"trpc.group/trpc-go/trpc-agent-go/server/a2a\"\n)\n\nfunc main() {\n    // 1. Create a regular Agent\n    model := openai.New(\"gpt-4o-mini\")\n    agent := llmagent.New(\"MyAgent\",\n        llmagent.WithModel(model),\n        llmagent.WithDescription(\"An intelligent assistant\"),\n    )\n\n    // 2. Convert to A2A service with one click\n    server, _ := a2aserver.New(\n        a2aserver.WithHost(\"localhost:8080\"),\n        a2aserver.WithAgent(agent), // Pass in any Agent\n    )\n\n    // 3. Start the service to accept A2A requests\n    server.Start(\":8080\")\n}\n</code></pre>"},{"location":"a2a/#direct-a2a-protocol-client-call","title":"Direct A2A Protocol Client Call","text":"<pre><code>import (\n    \"trpc.group/trpc-go/trpc-a2a-go/client\"\n    \"trpc.group/trpc-go/trpc-a2a-go/protocol\"\n)\n\nfunc main() {\n    // Connect to A2A service\n    client, _ := client.NewA2AClient(\"http://localhost:8080/\")\n\n    // Send message to Agent\n    message := protocol.NewMessage(\n        protocol.MessageRoleUser,\n        []protocol.Part{protocol.NewTextPart(\"Hello, please help me analyze this code\")},\n    )\n\n    // Agent will automatically process and return results\n    response, _ := client.SendMessage(context.Background(),\n        protocol.SendMessageParams{Message: message})\n}\n</code></pre>"},{"location":"a2a/#a2aagent-calling-remote-a2a-services","title":"A2AAgent: Calling Remote A2A Services","text":"<p>Corresponding to A2A Server, tRPC-Agent-Go also provides <code>A2AAgent</code> for calling remote A2A services, enabling communication between Agents.</p>"},{"location":"a2a/#concept-introduction_1","title":"Concept Introduction","text":"<p><code>A2AAgent</code> is a special Agent implementation that doesn't directly handle user requests but forwards them to remote A2A services. From the user's perspective, <code>A2AAgent</code> looks like a regular Agent, but it's actually a local proxy for a remote Agent.</p> <p>Simple Understanding: - A2A Server: I have an Agent and want others to call it \u2192 Expose as A2A service - A2AAgent: I want to call someone else's Agent \u2192 Call through A2AAgent proxy</p>"},{"location":"a2a/#core-features_1","title":"Core Features","text":"<ul> <li>Transparent Proxy: Use remote Agents as if they were local Agents</li> <li>Automatic Discovery: Automatically discover remote Agent capabilities through AgentCard</li> <li>Protocol Conversion: Automatically handle conversion between local message formats and A2A protocol</li> <li>Streaming Support: Support both streaming and non-streaming communication modes</li> <li>State Transfer: Support transferring local state to remote Agents</li> <li>Error Handling: Comprehensive error handling and retry mechanisms</li> </ul>"},{"location":"a2a/#use-cases","title":"Use Cases","text":"<ol> <li>Distributed Agent Systems: Call Agents from other services in microservice architectures</li> <li>Agent Orchestration: Combine multiple specialized Agents into complex workflows</li> <li>Cross-Team Collaboration: Call Agent services provided by other teams</li> </ol>"},{"location":"a2a/#a2aagent-quick-start","title":"A2AAgent Quick Start","text":""},{"location":"a2a/#basic-usage","title":"Basic Usage","text":"<pre><code>package main\n\nimport (\n    \"context\"\n    \"fmt\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/agent/a2aagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/runner\"\n    \"trpc.group/trpc-go/trpc-agent-go/model\"\n    \"trpc.group/trpc-go/trpc-agent-go/session/inmemory\"\n)\n\nfunc main() {\n    // 1. Create A2AAgent pointing to remote A2A service\n    a2aAgent, err := a2aagent.New(\n        a2aagent.WithAgentCardURL(\"http://localhost:8888\"),\n    )\n    if err != nil {\n        panic(err)\n    }\n\n    // 2. Use it like a regular Agent\n    sessionService := inmemory.NewSessionService()\n    runner := runner.NewRunner(\"test\", a2aAgent, \n        runner.WithSessionService(sessionService))\n\n    // 3. Send message\n    events, err := runner.Run(\n        context.Background(),\n        \"user1\",\n        \"session1\", \n        model.NewUserMessage(\"Please tell me a joke\"),\n    )\n    if err != nil {\n        panic(err)\n    }\n\n    // 4. Handle response\n    for event := range events {\n        if event.Response != nil &amp;&amp; len(event.Response.Choices) &gt; 0 {\n            fmt.Print(event.Response.Choices[0].Message.Content)\n        }\n    }\n}\n</code></pre> <p>In multi-agent systems, <code>A2AAgent</code> is often used as a SubAgent of a local coordinator Agent (for example an <code>LLMAgent</code>). You can combine <code>A2AAgent</code> with <code>LLMAgent.SetSubAgents</code> to dynamically load and refresh remote SubAgents from a registry without recreating the coordinator.</p>"},{"location":"a2a/#advanced-configuration","title":"Advanced Configuration","text":"<pre><code>// Create A2AAgent with advanced configuration\na2aAgent, err := a2aagent.New(\n    // Specify remote service address\n    a2aagent.WithAgentCardURL(\"http://remote-agent:8888\"),\n\n    // Set streaming buffer size\n    a2aagent.WithStreamingChannelBufSize(2048),\n\n    // Custom protocol conversion\n    a2aagent.WithCustomEventConverter(customEventConverter),\n\n    a2aagent.WithCustomA2AConverter(customA2AConverter),\n)\n</code></pre>"},{"location":"a2a/#complete-example-a2a-server-a2aagent-combined-usage","title":"Complete Example: A2A Server + A2AAgent Combined Usage","text":"<p>Here's a complete example showing how to run both A2A Server (exposing local Agent) and A2AAgent (calling remote service) in the same program:</p> <pre><code>package main\n\nimport (\n    \"context\"\n    \"fmt\"\n    \"time\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/agent/a2aagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/agent/llmagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/openai\"\n    \"trpc.group/trpc-go/trpc-agent-go/runner\"\n    \"trpc.group/trpc-go/trpc-agent-go/server/a2a\"\n    \"trpc.group/trpc-go/trpc-agent-go/session/inmemory\"\n)\n\nfunc main() {\n    // 1. Create and start remote Agent service\n    remoteAgent := createRemoteAgent()\n    startA2AServer(remoteAgent, \"localhost:8888\")\n\n    time.Sleep(1 * time.Second) // Wait for service to start\n\n    // 2. Create A2AAgent connecting to remote service\n    a2aAgent, err := a2aagent.New(\n        a2aagent.WithAgentCardURL(\"http://localhost:8888\"),\n        a2aagent.WithTransferStateKey(\"user_context\"),\n    )\n    if err != nil {\n        panic(err)\n    }\n\n    // 3. Create local Agent\n    localAgent := createLocalAgent()\n\n    // 4. Compare local and remote Agent responses\n    compareAgents(localAgent, a2aAgent)\n}\n\nfunc createRemoteAgent() agent.Agent {\n    model := openai.New(\"gpt-4o-mini\")\n    return llmagent.New(\"JokeAgent\",\n        llmagent.WithModel(model),\n        llmagent.WithDescription(\"I am a joke-telling agent\"),\n        llmagent.WithInstruction(\"Always respond with a funny joke\"),\n    )\n}\n\nfunc createLocalAgent() agent.Agent {\n    model := openai.New(\"gpt-4o-mini\") \n    return llmagent.New(\"LocalAgent\",\n        llmagent.WithModel(model),\n        llmagent.WithDescription(\"I am a local assistant\"),\n    )\n}\n\nfunc startA2AServer(agent agent.Agent, host string) {\n    server, err := a2a.New(\n        a2a.WithHost(host),\n        a2a.WithAgent(agent, true), // Enable streaming\n    )\n    if err != nil {\n        panic(err)\n    }\n\n    go func() {\n        server.Start(host)\n    }()\n}\n\nfunc compareAgents(localAgent, remoteAgent agent.Agent) {\n    sessionService := inmemory.NewSessionService()\n\n    localRunner := runner.NewRunner(\"local\", localAgent,\n        runner.WithSessionService(sessionService))\n    remoteRunner := runner.NewRunner(\"remote\", remoteAgent,\n        runner.WithSessionService(sessionService))\n\n    userMessage := \"Please tell me a joke\"\n\n    // Call local Agent\n    fmt.Println(\"=== Local Agent Response ===\")\n    processAgent(localRunner, userMessage)\n\n    // Call remote Agent (via A2AAgent)\n    fmt.Println(\"\\n=== Remote Agent Response (via A2AAgent) ===\")\n    processAgent(remoteRunner, userMessage)\n}\n\nfunc processAgent(runner runner.Runner, message string) {\n    events, err := runner.Run(\n        context.Background(),\n        \"user1\",\n        \"session1\",\n        model.NewUserMessage(message),\n        agent.WithRuntimeState(map[string]any{\n            \"user_context\": \"test_context\",\n        }),\n    )\n    if err != nil {\n        fmt.Printf(\"Error: %v\\n\", err)\n        return\n    }\n\n    for event := range events {\n        if event.Response != nil &amp;&amp; len(event.Response.Choices) &gt; 0 {\n            content := event.Response.Choices[0].Message.Content\n            if content == \"\" {\n                content = event.Response.Choices[0].Delta.Content\n            }\n            if content != \"\" {\n                fmt.Print(content)\n            }\n        }\n    }\n    fmt.Println()\n}\n</code></pre>"},{"location":"a2a/#agentcard-automatic-discovery","title":"AgentCard Automatic Discovery","text":"<p><code>A2AAgent</code> supports automatically obtaining remote Agent information through the standard AgentCard discovery mechanism:</p> <pre><code>// A2AAgent automatically retrieves AgentCard from the following path\n// http://remote-agent:8888/.well-known/agent.json\n\ntype AgentCard struct {\n    Name         string                 `json:\"name\"`\n    Description  string                 `json:\"description\"`\n    URL          string                 `json:\"url\"`\n    Capabilities AgentCardCapabilities  `json:\"capabilities\"`\n}\n\ntype AgentCardCapabilities struct {\n    Streaming *bool `json:\"streaming,omitempty\"`\n}\n</code></pre>"},{"location":"a2a/#state-transfer","title":"State Transfer","text":"<p><code>A2AAgent</code> supports transferring local runtime state to remote Agents:</p> <pre><code>a2aAgent, _ := a2aagent.New(\n    a2aagent.WithAgentCardURL(\"http://remote-agent:8888\"),\n    // Specify state keys to transfer\n    a2aagent.WithTransferStateKey(\"user_id\", \"session_context\", \"preferences\"),\n)\n\n// Runtime state is passed to remote Agent through A2A protocol metadata field\nevents, _ := runner.Run(ctx, userID, sessionID, message,\n    agent.WithRuntimeState(map[string]any{\n        \"user_id\":         \"12345\",\n        \"session_context\": \"shopping_cart\",\n        \"preferences\":     map[string]string{\"language\": \"en\"},\n    }),\n)\n</code></pre>"},{"location":"a2a/#custom-http-headers","title":"Custom HTTP Headers","text":"<p>You can pass custom HTTP headers to A2A agent for each request using <code>WithA2ARequestOptions</code>:</p> <pre><code>import \"trpc.group/trpc-go/trpc-a2a-go/client\"\n\nevents, err := runner.Run(\n    context.Background(),\n    userID,\n    sessionID,\n    model.NewUserMessage(\"your question\"),\n    // Pass custom HTTP headers for this request\n    agent.WithA2ARequestOptions(\n        client.WithRequestHeader(\"X-Custom-Header\", \"custom-value\"),\n        client.WithRequestHeader(\"X-Request-ID\", fmt.Sprintf(\"req-%d\", time.Now().UnixNano())),\n        client.WithRequestHeader(\"Authorization\", \"Bearer your-token\"),\n    ),\n)\n</code></pre> <p>Common Use Cases:</p> <ol> <li> <p>Authentication: Pass authentication tokens    <pre><code>agent.WithA2ARequestOptions(\n    client.WithRequestHeader(\"Authorization\", \"Bearer \"+token),\n)\n</code></pre></p> </li> <li> <p>Distributed Tracing: Add request/trace IDs    <pre><code>agent.WithA2ARequestOptions(\n    client.WithRequestHeader(\"X-Request-ID\", requestID),\n    client.WithRequestHeader(\"X-Trace-ID\", traceID),\n)\n</code></pre></p> </li> </ol> <p>Configuring UserID Header:</p> <p>Both client and server support configuring which HTTP header to use for UserID, default is X-User-ID:</p> <pre><code>// Client side: Configure which header to send UserID in\na2aAgent, _ := a2aagent.New(\n    a2aagent.WithAgentCardURL(\"http://remote-agent:8888\"),\n    // Default is \"X-User-ID\", can be customized\n    a2aagent.WithUserIDHeader(\"X-Custom-User-ID\"),\n)\n\n// Server side: Configure which header to read UserID from\nserver, _ := a2a.New(\n    a2a.WithHost(\"localhost:8888\"),\n    a2a.WithAgent(agent, true),\n    // Default is \"X-User-ID\", can be customized\n    a2a.WithUserIDHeader(\"X-Custom-User-ID\"),\n)\n</code></pre> <p>The UserID from <code>invocation.Session.UserID</code> will be automatically sent via the configured header to the A2A server.</p>"},{"location":"a2a/#custom-converters","title":"Custom Converters","text":"<p>For special requirements, you can customize message and event converters:</p> <pre><code>// Custom A2A message converter\ntype CustomA2AConverter struct{}\n\nfunc (c *CustomA2AConverter) ConvertToA2AMessage(\n    isStream bool, \n    agentName string, \n    invocation *agent.Invocation,\n) (*protocol.Message, error) {\n    // Custom message conversion logic\n    return &amp;protocol.Message{\n        MessageID: invocation.InvocationID,\n        Role:      protocol.MessageRoleUser,\n        Parts:     []protocol.Part{/* custom content */},\n    }, nil\n}\n\n// Custom event converter  \ntype CustomEventConverter struct{}\n\nfunc (c *CustomEventConverter) ConvertToEvent(\n    result protocol.MessageResult,\n    agentName string,\n    invocation *agent.Invocation,\n) (*event.Event, error) {\n    // Custom event conversion logic\n    return event.New(invocation.InvocationID, agentName), nil\n}\n\n// Use custom converters\na2aAgent, _ := a2aagent.New(\n    a2aagent.WithAgentCardURL(\"http://remote-agent:8888\"),\n    a2aagent.WithA2AMessageConverter(&amp;CustomA2AConverter{}),\n    a2aagent.WithEventConverter(&amp;CustomEventConverter{}),\n)\n</code></pre>"},{"location":"a2a/#summary-a2a-server-vs-a2aagent","title":"Summary: A2A Server vs A2AAgent","text":"Component Role Use Case Core Functions A2A Server Service Provider Expose local Agent for other systems to call \u2022 Protocol conversion\u2022 AgentCard generation\u2022 Message routing\u2022 Streaming support A2AAgent Service Consumer Call remote A2A services \u2022 Transparent proxy\u2022 Automatic discovery\u2022 State transfer\u2022 Protocol adaptation"},{"location":"a2a/#typical-architecture-pattern","title":"Typical Architecture Pattern","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 A2A protocol  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502   Client    \u2502\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2192\u2502 A2A Server    \u2502\n\u2502 (A2AAgent)  \u2502               \u2502 (local Agent) \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518               \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n      \u2191                              \u2191\n      \u2502                              \u2502\n   Call remote                   Expose local\n   Agent service                 Agent service\n</code></pre> <p>Through the combined use of A2A Server and A2AAgent, you can easily build distributed Agent systems.</p>"},{"location":"agent/","title":"Agent Usage Documentation","text":"<p>Agent is the core execution unit of the tRPC-Agent-Go framework, responsible for processing user input and generating corresponding responses. Each Agent implements a unified interface, supporting streaming output and callback mechanisms.</p> <p>The framework provides multiple types of Agents, including LLMAgent, ChainAgent, ParallelAgent, CycleAgent, and GraphAgent. This document focuses on LLMAgent. For detailed information about other Agent types and multi-Agent systems, please refer to Multi-Agent.</p>"},{"location":"agent/#quick-start","title":"Quick Start","text":"<p>Recommended Usage: Runner</p> <p>We strongly recommend using Runner to execute Agents instead of directly calling Agent interfaces. Runner provides a more user-friendly interface, integrating services like Session and Memory, making usage much simpler.</p> <p>\ud83d\udcd6 Learn More: For detailed usage methods, please refer to Runner</p> <p>This example uses OpenAI's GPT-4o-mini model. Before starting, please ensure you have prepared the corresponding <code>OPENAI_API_KEY</code> and exported it through environment variables:</p> <pre><code>export OPENAI_API_KEY=\"your_api_key\"\n</code></pre> <p>Additionally, the framework supports OpenAI API-compatible models, which can be configured through environment variables:</p> <pre><code>export OPENAI_BASE_URL=\"your_api_base_url\"\nexport OPENAI_API_KEY=\"your_api_key\"\n</code></pre>"},{"location":"agent/#creating-model-instance","title":"Creating Model Instance","text":"<p>First, you need to create a model instance. Here we use OpenAI's GPT-4o-mini model:</p> <pre><code>import \"trpc.group/trpc-go/trpc-agent-go/model/openai\"\n\nmodelName := flag.String(\"model\", \"gpt-4o-mini\", \"Name of the model to use\")\nflag.Parse()\n// Create OpenAI model instance.\nmodelInstance := openai.New(*modelName, openai.Options{})\n</code></pre>"},{"location":"agent/#configuring-generation-parameters","title":"Configuring Generation Parameters","text":"<p>Set the model's generation parameters, including maximum tokens, temperature, and whether to use streaming output:</p> <pre><code>import \"trpc.group/trpc-go/trpc-agent-go/model\"\n\nmaxTokens := 1000\ntemperature := 0.7\ngenConfig := model.GenerationConfig{\n    MaxTokens:   &amp;maxTokens,   // Maximum number of tokens to generate.\n    Temperature: &amp;temperature, // Temperature parameter, controls output randomness.\n    Stream:      true,         // Enable streaming output.\n}\n</code></pre>"},{"location":"agent/#creating-llmagent","title":"Creating LLMAgent","text":"<p>Use the model instance and configuration to create an LLMAgent, while setting the Agent's Description and Instruction.</p> <p>Description is used to describe the basic functionality and characteristics of the Agent, while Instruction defines the specific instructions and behavioral guidelines that the Agent should follow when executing tasks.</p> <pre><code>import \"trpc.group/trpc-go/trpc-agent-go/agent/llmagent\"\n\nllmAgent := llmagent.New(\n    \"demo-agent\",                      // Agent name.\n    llmagent.WithModel(modelInstance), // Set model.\n    llmagent.WithDescription(\"A helpful AI assistant for demonstrations\"),              // Set description.\n    llmagent.WithInstruction(\"Be helpful, concise, and informative in your responses\"), // Set instruction.\n    llmagent.WithGenerationConfig(genConfig),                                           // Set generation parameters.\n    // Set the filter mode for messages passed to the model. The final messages passed to the model must satisfy both WithMessageTimelineFilterMode and WithMessageBranchFilterMode conditions.\n    // Timeline dimension filter conditions\n    // Default: llmagent.TimelineFilterAll\n    // Optional values:\n    //  - llmagent.TimelineFilterAll: Includes historical messages as well as messages generated in the current request\n    //  - llmagent.TimelineFilterCurrentRequest: Only includes messages generated in the current request\n    //  - llmagent.TimelineFilterCurrentInvocation: Only includes messages generated in the current invocation context\n    llmagent.WithMessageTimelineFilterMode(llmagent.TimelineFilterAll),\n\n    // Branch dimension filter conditions\n    // Default: llmagent.BranchFilterModePrefix\n    // Optional values:\n    //  - llmagent.BranchFilterModeAll: Includes messages from all agents. Use this when the current agent interacts with the model and needs to synchronize all valid content messages generated by all agents to the model.\n    //  - llmagent.BranchFilterModePrefix: Filters messages by prefix matching Event.FilterKey with Invocation.eventFilterKey. Use this when you want to pass messages generated by the current agent and related upstream/downstream agents to the model.\n    //  - llmagent.BranchFilterModeExact: Filters messages where Event.FilterKey == Invocation.eventFilterKey. Use this when the current agent interacts with the model and only needs to use messages generated by the current agent.\n    llmagent.WithMessageBranchFilterMode(llmagent.BranchFilterModeAll),\n)\n</code></pre>"},{"location":"agent/#placeholder-variables-session-state-injection","title":"Placeholder Variables (Session State Injection)","text":"<p>LLMAgent automatically injects session state into <code>Instruction</code> and the optional <code>SystemPrompt</code> via placeholder variables. Supported patterns:</p> <ul> <li><code>{key}</code>: Replace with the string value of <code>session.State[\"key\"]</code></li> <li><code>{key?}</code>: Optional; if missing, replaced with an empty string</li> <li><code>{user:subkey}</code> / <code>{app:subkey}</code> / <code>{temp:subkey}</code>: Use user/app/temp scoped keys (session services merge app/user state into session with these prefixes)</li> <li><code>{invocation:subkey}:</code> Replaces with the value of fmt.Sprintf(\"%+v\", <code>invocation.state[\"subkey\"]</code>). (The state can be set via invocation.SetState(k, v))</li> </ul> <p>Notes:</p> <ul> <li>If a non-optional key is not found, the original <code>{key}</code> is preserved (helps the LLM notice missing context)</li> <li>Values are read from <code>invocation.Session.State</code> (Runner + SessionService set/merge this automatically)</li> </ul> <p>Example:</p> <pre><code>llm := llmagent.New(\n  \"research-agent\",\n  llmagent.WithModel(modelInstance),\n  llmagent.WithInstruction(\n    \"You are a research assistant. Focus: {research_topics}. \" +\n    \"User interests: {user:topics?}. App banner: {app:banner?}.\",\n  ),\n)\n\ninv := agent.NewInvoction()\ninv.SetState(\"case\", \"case-1\")\n\n// Initialize session state (Runner + SessionService)\n_ = sessionService.UpdateUserState(ctx, session.UserKey{AppName: app, UserID: user}, session.StateMap{\n  \"topics\": []byte(\"quantum computing, cryptography\"),\n})\n_ = sessionService.UpdateAppState(ctx, app, session.StateMap{\n  \"banner\": []byte(\"Research Mode\"),\n})\n// Unprefixed keys live directly in session.State\n_, _ = sessionService.CreateSession(ctx, session.Key{AppName: app, UserID: user, SessionID: sid}, session.StateMap{\n  \"research_topics\": []byte(\"AI, ML, DL\"),\n})\n</code></pre> <p>See also:</p> <ul> <li>Examples: <code>examples/placeholder</code>, <code>examples/outputkey</code></li> <li>Session API: <code>docs/mkdocs/en/session.md</code></li> </ul>"},{"location":"agent/#using-runner-to-execute-agent","title":"Using Runner to Execute Agent","text":"<p>Use Runner to execute the Agent, which is the recommended usage:</p> <pre><code>import \"trpc.group/trpc-go/trpc-agent-go/runner\"\n\n// Create Runner.\nrunner := runner.NewRunner(\"demo-app\", llmAgent)\n\n// Send message directly without creating complex Invocation.\nmessage := model.NewUserMessage(\"Hello! Can you tell me about yourself?\")\neventChan, err := runner.Run(ctx, \"user-001\", \"session-001\", message)\nif err != nil {\n    log.Fatalf(\"Failed to execute Agent: %v\", err)\n}\n</code></pre>"},{"location":"agent/#message-visibility-options","title":"Message Visibility Options","text":"<p>The Agent can dynamically manage the visibility of messages generated by other Agents and historical session messages based on different scenarios. This is configurable through relevant options. When interacting with the model, only the visible content is passed as input.</p> <p>TIPS: - Messages from different sessionIDs are never visible to each other under any circumstances. The following control strategies only apply to messages sharing the same sessionID. - Invocation.Message always visible regardless of the configuration. - When the option is not configured, the default value is FullContext.</p> <p>Config: - <code>llmagent.WithMessageFilterMode(MessageFilterMode)</code>:   - <code>FullContext</code>: Includes historical messages and messages generated in the current request, filtered by prefix matching with the filterKey.   - <code>RequestContext</code>: Only includes messages generated in the current request, filtered by prefix matching with the filterKey.   - <code>IsolatedRequest</code>: Only includes messages generated in the current request, filtered by exact matching with the filterKey.   - <code>IsolatedInvocation</code>: Only includes messages generated in the current Invocation context, filtered by exact matching with the filterKey.</p> <p>Recommended Usage Examples (These examples are simplified configurations based on advanced usage):</p> <pre><code>taskagentA := llmagent.New(\n  \"coordinator\",\n  llmagent.WithModel(modelInstance),\n  // Makes all messages generated by taskagentA and taskagentB visible (including historical session messages under the same sessionID)\n  llmagent.WithMessageFilterMode(llmagent.FullContext),\n  // Makes all messages generated during the current runner.Run of taskagentA and taskagentB visible (excluding historical session messages)\n  llmagent.WithMessageFilterMode(llmagent.RequestContext),\n  // Only makes messages generated during the current runner.Run of taskagentA visible (excluding its own historical session messages)\n  llmagent.WithMessageFilterMode(llmagent.IsolatedRequest),\n  // Agent execution order: taskagentA-invocation1 -&gt; taskagentB-invocation2 -&gt; taskagentA-invocation3 (current execution phase)\n  // Only makes messages generated during the current taskagentA-invocation3 phase visible (excluding its own historical session messages and messages generated during taskagentA-invocation1)\n  llmagent.WithMessageFilterMode(llmagent.IsolatedInvocation),\n)\n\ntaskagentB := llmagent.New(\n  \"coordinator\",\n  llmagent.WithModel(modelInstance),\n  // Makes all messages generated by taskagentA and taskagentB visible (including historical session messages under the same sessionID)\n  llmagent.WithMessageFilterMode(llmagent.FullContext),\n  // Makes all messages generated during the current runner.Run of taskagentA and taskagentB visible (excluding historical session messages)\n  llmagent.WithMessageFilterMode(llmagent.RequestContext),\n  // Only makes messages generated during the current runner.Run of taskagentB visible (excluding its own historical session messages)\n  llmagent.WithMessageFilterMode(llmagent.IsolatedRequest),\n  // Agent execution order: taskagentA-invocation1 -&gt; taskagentB-invocation2 -&gt; taskagentA-invocation3 -&gt; taskagentB-invocation4 (current execution phase)\n  // Only makes messages generated during the current taskagentB-invocation4 phase visible (excluding its own historical session messages and messages generated during taskagentB-invocation2)\n  llmagent.WithMessageFilterMode(llmagent.IsolatedInvocation),\n)\n\n// Cyclically execute taskagentA and taskagentB\ncycleAgent := cycleagent.New(\n  \"coordinator\",\n  llmagent.WithModel(modelInstance),\n  llmagent.WithSubAgents([]agent.Agent{taskagentA, taskagentB}),\n  llmagent.WithMessageFilterMode(llmagent.FullContext)\n)\n\n// Create Runner\nrunner := runner.NewRunner(\"demo-app\", cycleAgent)\n\n// Send message directly without creating complex Invocation\nmessage := model.NewUserMessage(\"Hello! Can you tell me about yourself?\")\neventChan, err := runner.Run(ctx, \"user-001\", \"session-001\", message)\nif err != nil {\n    log.Fatalf(\"Failed to run Agent: %v\", err)\n}\n</code></pre> <p>Advanced Usage Examples: You can independently control the visibility of historical messages and messages generated by other Agents for the current agent using WithMessageTimelineFilterModeand WithMessageBranchFilterMode. When the current agent interacts with the model, only messages satisfying both conditions are input to the model. (invocation.Messageis always visible in any scenario.) - <code>WithMessageTimelineFilterMode</code>: Controls visibility from a temporal dimension   - <code>TimelineFilterAll</code>: Includes historical messages and messages generated in the current request.   - <code>TimelineFilterCurrentRequest</code>: Only includes messages generated in the current request (one runner.Runcounts as one request).   - <code>TimelineFilterCurrentInvocation</code>: Only includes messages generated in the current invocation context. - <code>WithMessageBranchFilterMode</code>: Controls visibility from a branch dimension (used to manage visibility of messages generated by other agents).   - <code>BranchFilterModePrefix</code>: Uses prefix matching between Event.FilterKeyand Invocation.eventFilterKey.   - <code>BranchFilterModeAll</code>: Includes messages from all agents.   - <code>BranchFilterModeExact</code>: Only includes messages generated by the current agent.</p> <pre><code>llmAgent := llmagent.New(\n    \"demo-agent\",                      // Agent name\n    llmagent.WithModel(modelInstance), // Set the model\n    llmagent.WithDescription(\"A helpful AI assistant for demonstrations\"),              // Set description\n    llmagent.WithInstruction(\"Be helpful, concise, and informative in your responses\"), // Set instruction\n    llmagent.WithGenerationConfig(genConfig),                                           // Set generation parameters\n\n    // Set the message filtering mode for input to the model. The final messages passed to the model must satisfy both WithMessageTimelineFilterMode and WithMessageBranchFilterMode conditions.\n    // Temporal dimension filtering condition\n    // Default: llmagent.TimelineFilterAll\n    // Options:\n    //  - llmagent.TimelineFilterAll: Includes historical messages and messages generated in the current request.\n    //  - llmagent.TimelineFilterCurrentRequest: Only includes messages generated in the current request.\n    //  - llmagent.TimelineFilterCurrentInvocation: Only includes messages generated in the current invocation context.\n    llmagent.WithMessageTimelineFilterMode(llmagent.TimelineFilterAll),\n    // Branch dimension filtering condition\n    // Default: llmagent.BranchFilterModePrefix\n    // Options:\n    //  - llmagent.BranchFilterModeAll: Includes messages from all agents. Use this when the current agent needs to sync valid content messages generated by all agents to the model during interaction.\n    //  - llmagent.BranchFilterModePrefix: Filters messages by prefix matching Event.FilterKey with Invocation.eventFilterKey. Use this when you want to pass messages generated by the current agent and related upstream/downstream agents to the model.\n    //  - llmagent.BranchFilterModeExact: Filters messages where Event.FilterKey exactly matches Invocation.eventFilterKey. Use this when the current agent only needs to use messages generated by itself during model interaction.\n    llmagent.WithMessageBranchFilterMode(llmagent.BranchFilterModeAll),\n)\n</code></pre>"},{"location":"agent/#reasoning-content-mode-deepseek-thinking-mode","title":"Reasoning Content Mode (DeepSeek Thinking Mode)","text":"<p>When using models with thinking/reasoning capabilities (such as DeepSeek), the model outputs both <code>reasoning_content</code> (thinking chain) and <code>content</code> (final answer). According to DeepSeek API documentation, in multi-turn conversations, you should not send the previous turn's <code>reasoning_content</code> to the model.</p> <p>LLMAgent provides <code>WithReasoningContentMode</code> to control how <code>reasoning_content</code> is handled in conversation history:</p> <p>Available Modes:</p> Mode Constant Description Discard Previous Turns <code>ReasoningContentModeDiscardPreviousTurns</code> Discard <code>reasoning_content</code> from previous request turns, keep for current request. (Default, recommended) Keep All <code>ReasoningContentModeKeepAll</code> Keep all <code>reasoning_content</code> in history (for debugging). Discard All <code>ReasoningContentModeDiscardAll</code> Discard all <code>reasoning_content</code> from history for maximum bandwidth savings. <p>Usage Example:</p> <pre><code>// Recommended configuration for DeepSeek models with thinking mode.\nagent := llmagent.New(\n    \"deepseek-agent\",\n    llmagent.WithModel(deepseekModel),\n    llmagent.WithInstruction(\"You are a helpful assistant.\"),\n    // Discard reasoning_content from previous turns (recommended for DeepSeek).\n    llmagent.WithReasoningContentMode(llmagent.ReasoningContentModeDiscardPreviousTurns),\n)\n</code></pre> <p>How It Works:</p> <ul> <li><code>keep_all</code>: All <code>reasoning_content</code> is preserved in session history. Use this if you need to retain thinking chains for debugging or analysis.</li> <li><code>discard_previous_turns</code>: When building the message list for a new request, <code>reasoning_content</code> from messages belonging to previous requests is cleared. Messages within the current request (e.g., during tool call loops) retain their <code>reasoning_content</code>. This follows DeepSeek's recommendation.</li> <li><code>discard_all</code>: All <code>reasoning_content</code> is stripped from historical messages before sending to the model.</li> </ul> <p>Note: This option only affects how historical messages are processed before sending to the model. The current response's <code>reasoning_content</code> is always captured and stored in session events.</p>"},{"location":"agent/#delegation-visibility-options","title":"Delegation Visibility Options","text":"<p>When building multi\u2011Agent systems (task delegation between Agents), LLMAgent provides a unified fallback option for delegation events. Transfer events always include announcement text and are tagged <code>transfer</code> so UIs (User Interfaces) can filter them if desired.</p> <ul> <li><code>llmagent.WithDefaultTransferMessage(string)</code><ul> <li>Configure the default message used when a model calls a SubAgent without a <code>message</code>.</li> <li>Pass an empty string to disable injecting a default message; pass a non\u2011empty string to enable and override it.</li> </ul> </li> </ul> <p>Usage example:</p> <pre><code>coordinator := llmagent.New(\n  \"coordinator\",\n  llmagent.WithModel(modelInstance),\n  llmagent.WithSubAgents([]agent.Agent{mathAgent, weatherAgent}),\n  // Transfer announcement events are always emitted (tagged `transfer`). Filter in the UI if needed.\n  // Customize the default message when the model omits it (empty string disables)\n  llmagent.WithDefaultTransferMessage(\"Handing off to the specialist\"),\n)\n</code></pre> <p>Notes:</p> <ul> <li>These options do not change the actual handoff logic; they only affect user\u2011visible texts or whether a fallback <code>message</code> is injected.</li> <li>Transfer announcements are emitted as Events with <code>Response.Object == \"agent.transfer\"</code>. If your UI should not display system\u2011level notices, filter this object type at the renderer/service layer.</li> </ul>"},{"location":"agent/#handling-event-stream","title":"Handling Event Stream","text":"<p>The <code>eventChan</code> returned by <code>runner.Run()</code> is an event channel. The Agent continuously sends Event objects to this channel during execution.</p> <p>Each Event contains execution state information at a specific moment: LLM-generated content, tool call requests and results, error messages, etc. By iterating through the event channel, you can get real-time execution progress (see Event section below for details).</p> <p>Receive execution results through the event channel:</p> <pre><code>// 1. Get event channel (returns immediately, starts async execution)\neventChan, err := runner.Run(ctx, userID, sessionID, message)\nif err != nil {\n    log.Fatalf(\"Failed to start: %v\", err)\n}\n\n// 2. Handle event stream (receive execution results in real-time)\nfor event := range eventChan {\n    // Check for errors\n    if event.Error != nil {\n        log.Printf(\"Execution error: %s\", event.Error.Message)\n        continue\n    }\n\n    // Handle response content\n    if len(event.Response.Choices) &gt; 0 {\n        choice := event.Response.Choices[0]\n\n        // Streaming content (real-time display)\n        if choice.Delta.Content != \"\" {\n            fmt.Print(choice.Delta.Content)\n        }\n\n        // Tool call information\n        for _, toolCall := range choice.Message.ToolCalls {\n            fmt.Printf(\"Calling tool: %s\\n\", toolCall.Function.Name)\n        }\n    }\n\n    // Check if completed (note: should not break on tool call completion)\n    if event.IsFinalResponse() {\n        fmt.Println()\n        break\n    }\n}\n</code></pre> <p>The complete code for this example can be found at examples/runner</p> <p>Why is Runner recommended?</p> <ol> <li>Simpler Interface: No need to create complex Invocation objects</li> <li>Integrated Services: Automatically integrates Session, Memory and other services</li> <li>Better Management: Unified management of Agent execution flow</li> <li>Production Ready: Suitable for production environment use</li> </ol> <p>\ud83d\udca1 Tip: Want to learn more about Runner's detailed usage and advanced features? Please check Runner</p> <p>Advanced Usage: Direct Agent Usage</p> <p>If you need more fine-grained control, you can also use the Agent interface directly, but this requires creating Invocation objects:</p>"},{"location":"agent/#core-concepts","title":"Core Concepts","text":""},{"location":"agent/#invocation-advanced-usage","title":"Invocation (Advanced Usage)","text":"<p>Invocation is the context object for Agent execution flow, containing all information needed for a single call. Note: This is advanced usage, we recommend using Runner to simplify operations.</p> <pre><code>import \"trpc.group/trpc-go/trpc-agent-go/agent\"\n\n// Create Invocation object (advanced usage).\ninvocation := agent.NewInvocation(\n    agent.WithAgentName(agent),                                                                  // Agent.\n    agent.WithInvocationMessage(model.NewUserMessage(\"Hello! Can you tell me about yourself?\")), // User message.\n    agent.WithInvocationSession(&amp;session.Session{ID: \"session-001\"}),                            // session object.\n    agent.WithInvocationEndInvocation(false),                                                    // Whether to end invocation.\n    agent.WithInvocationModel(modelInstance),                                                    // Model to use.\n)\n\n// Call Agent directly (advanced usage).\nctx := context.Background()\neventChan, err := llmAgent.Run(ctx, invocation)\nif err != nil {\n    log.Fatalf(\"Failed to execute Agent: %v\", err)\n}\n</code></pre> <p>When to use direct calls?</p> <ul> <li>Need complete control over execution flow</li> <li>Custom Session and Memory management</li> <li>Implement special invocation logic</li> <li>Debugging and testing scenarios</li> </ul> <pre><code>// Invocation is the context object for Agent execution flow, containing\n// all information needed for a single call.\ntype Invocation struct {\n    // Agent specifies the Agent instance to call.\n    Agent Agent\n    // AgentName identifies the name of the Agent instance to call.\n    AgentName string\n    // InvocationID provides a unique identifier for each call.\n    InvocationID string\n    // Branch is a branch identifier for hierarchical event filtering.\n    Branch string\n    // EndInvocation indicates whether to end the invocation.\n    EndInvocation bool\n\n    // Session maintains the context state of the conversation.\n    Session *session.Session\n    // Model specifies the model instance to use.\n    Model model.Model\n    // Message is the specific content sent by the user to the Agent.\n    Message model.Message\n    // RunOptions are option configurations for the Run call.\n    RunOptions RunOptions\n    // TransferInfo supports control transfer between Agents.\n    TransferInfo *TransferInfo\n\n    // Structured output configuration (optional).\n    StructuredOutput     *model.StructuredOutput\n    StructuredOutputType reflect.Type\n\n    // Services injected for this invocation.\n    MemoryService   memory.Service\n    ArtifactService artifact.Service\n\n    // Internal signaling: notify when events are appended.\n    noticeChanMap map[string]chan any\n    noticeMu      *sync.Mutex\n\n    // Internal: event filter key and parent linkage for nested flows.\n    eventFilterKey string\n    parent         *Invocation\n\n    // Invocation-scoped state (lazy-init, thread-safe via stateMu).\n    state   map[string]any\n    stateMu sync.RWMutex\n\n    // Optional per-invocation safety limits (usually set by LLMAgent).\n    MaxLLMCalls      int\n    MaxToolIterations int\n\n    // Internal counters used to enforce MaxLLMCalls / MaxToolIterations.\n    llmCallCount       int\n    toolIterationCount int\n}\n</code></pre>"},{"location":"agent/#invocation-state","title":"Invocation State","text":"<p><code>Invocation</code> provides a general-purpose state storage mechanism for sharing data within the lifecycle of a single invocation. This is useful for callbacks, middleware, or any scenario that requires storing temporary data at the invocation level.</p> <p>Core Methods:</p> <pre><code>// Set a state value\ninv.SetState(key string, value any)\n\n// Get a state value\nvalue, ok := inv.GetState(key string)\n\n// Delete a state value\ninv.DeleteState(key string)\n</code></pre> <p>Features:</p> <ul> <li>Invocation-scoped: State is automatically scoped to a single invocation</li> <li>Thread-safe: Built-in RWMutex protection for concurrent access</li> <li>Lazy initialization: Memory allocated only on first use</li> <li>General-purpose: Can be used for callbacks, middleware, custom logic, and more</li> </ul> <p>Usage Example:</p> <p>Version Requirement The structured callback API (recommended) requires trpc-agent-go &gt;= 0.6.0.</p> <pre><code>// Store data in BeforeAgentCallback\n// Note: Structured callback API requires trpc-agent-go &gt;= 0.6.0\ncallbacks := agent.NewCallbacks()\ncallbacks.RegisterBeforeAgent(func(ctx context.Context, args *agent.BeforeAgentArgs) (*agent.BeforeAgentResult, error) {\n    args.Invocation.SetState(\"agent:start_time\", time.Now())\n    args.Invocation.SetState(\"custom:request_id\", \"req-123\")\n    return nil, nil\n})\n\n// Read data in AfterAgentCallback\ncallbacks.RegisterAfterAgent(func(ctx context.Context, args *agent.AfterAgentArgs) (*agent.AfterAgentResult, error) {\n    if startTime, ok := args.Invocation.GetState(\"agent:start_time\"); ok {\n        duration := time.Since(startTime.(time.Time))\n        log.Printf(\"Execution took: %v\", duration)\n        args.Invocation.DeleteState(\"agent:start_time\")\n    }\n    return nil, nil\n})\n</code></pre> <p>Recommended Key Naming Convention:</p> <ul> <li>Agent callbacks: <code>\"agent:xxx\"</code></li> <li>Model callbacks: <code>\"model:xxx\"</code></li> <li>Tool callbacks: <code>\"tool:toolName:xxx\"</code></li> <li>Middleware: <code>\"middleware:xxx\"</code></li> <li>Custom logic: <code>\"custom:xxx\"</code></li> </ul> <p>For detailed usage and more examples, please refer to Callbacks.</p>"},{"location":"agent/#event","title":"Event","text":"<p>Event is the real-time feedback generated during Agent execution, reporting execution progress in real-time through Event streams.</p> <p>Events mainly include the following types:</p> <ul> <li>Model conversation events</li> <li>Tool call and response events</li> <li>Agent transfer events</li> <li>Error events</li> </ul> <pre><code>// Event is the real-time feedback generated during Agent execution, reporting execution progress in real-time through Event streams.\ntype Event struct {\n    // Response contains model response content, tool call results and statistics.\n    *model.Response\n    // InvocationID is associated with a specific invocation.\n    InvocationID string `json:\"invocationId\"`\n    // Author is the source of the event, such as Agent or tool.\n    Author string `json:\"author\"`\n    // ID is the unique identifier of the event.\n    ID string `json:\"id\"`\n    // Timestamp records the time when the event occurred.\n    Timestamp time.Time `json:\"timestamp\"`\n    // Branch is a branch identifier for hierarchical event filtering.\n    Branch string `json:\"branch,omitempty\"`\n    // RequiresCompletion identifies whether this event requires a completion signal.\n    RequiresCompletion bool `json:\"requiresCompletion,omitempty\"`\n    // LongRunningToolIDs is a set of IDs for long-running function calls. Agent clients can understand which function calls are long-running through this field, only valid for function call events.\n    LongRunningToolIDs map[string]struct{} `json:\"longRunningToolIDs,omitempty\"`\n}\n</code></pre> <p>The streaming nature of Events allows you to see the Agent's working process in real-time, just like having a natural conversation with a real person. You only need to iterate through the Event stream, check the content and status of each Event, and you can completely handle the Agent's execution results.</p>"},{"location":"agent/#agent-interface","title":"Agent Interface","text":"<p>The Agent interface defines the core behaviors that all Agents must implement. This interface allows you to uniformly use different types of Agents while supporting tool calls and sub-Agent management.</p> <pre><code>type Agent interface {\n    // Run receives execution context and invocation information, returns an event channel. Through this channel, you can receive Agent execution progress and results in real-time.\n    Run(ctx context.Context, invocation *Invocation) (&lt;-chan *event.Event, error)\n    // Tools returns the list of tools that this Agent can access and execute.\n    Tools() []tool.Tool\n    // Info method provides basic information about the Agent, including name and description, for easy identification and management.\n    Info() Info\n    // SubAgents returns the list of sub-Agents available to this Agent.\n    // SubAgents and FindSubAgent methods support collaboration between Agents. An Agent can delegate tasks to other Agents, building complex multi-Agent systems.\n    SubAgents() []Agent\n    // FindSubAgent finds sub-Agent by name.\n    FindSubAgent(name string) Agent\n}\n</code></pre> <p>The framework provides multiple types of Agent implementations, including LLMAgent, ChainAgent, ParallelAgent, CycleAgent, and GraphAgent. For detailed information about different types of Agents and multi-Agent systems, please refer to Multi-Agent.</p>"},{"location":"agent/#callbacks","title":"Callbacks","text":"<p>Callbacks provide a rich callback mechanism that allows you to inject custom logic at key points during Agent execution.</p> <p>Version Requirement The structured callback API (recommended) requires trpc-agent-go &gt;= 0.6.0.</p>"},{"location":"agent/#callback-types","title":"Callback Types","text":"<p>The framework provides three types of callbacks:</p> <p>Agent Callbacks: Triggered before and after Agent execution</p> <pre><code>// Create callbacks using agent.NewCallbacks()\ncallbacks := agent.NewCallbacks()\n</code></pre> <p>Model Callbacks: Triggered before and after model calls</p> <pre><code>// Create callbacks using model.NewCallbacks()\ncallbacks := model.NewCallbacks()\n</code></pre> <p>Tool Callbacks: Triggered before and after tool calls</p> <pre><code>// Create callbacks using tool.NewCallbacks()\ncallbacks := tool.NewCallbacks()\n</code></pre>"},{"location":"agent/#usage-example","title":"Usage Example","text":"<pre><code>// Create Agent callbacks (using structured API)\n// Note: Structured callback API requires trpc-agent-go &gt;= 0.6.0\ncallbacks := agent.NewCallbacks()\ncallbacks.RegisterBeforeAgent(func(ctx context.Context, args *agent.BeforeAgentArgs) (*agent.BeforeAgentResult, error) {\n    log.Printf(\"Agent %s started execution\", args.Invocation.AgentName)\n    return nil, nil\n})\ncallbacks.RegisterAfterAgent(func(ctx context.Context, args *agent.AfterAgentArgs) (*agent.AfterAgentResult, error) {\n    if args.Error != nil {\n        log.Printf(\"Agent %s execution error: %v\", args.Invocation.AgentName, args.Error)\n    } else {\n        log.Printf(\"Agent %s execution completed\", args.Invocation.AgentName)\n    }\n    return nil, nil\n})\n\n// Use callbacks in llmAgent\nllmagent := llmagent.New(\"llmagent\", llmagent.WithAgentCallbacks(callbacks))\n</code></pre> <p>The callback mechanism allows you to precisely control the Agent's execution process and implement more complex business logic.</p>"},{"location":"agent/#advanced-usage","title":"Advanced Usage","text":"<p>The framework provides advanced features like Runner, Session, and Memory for building more complex Agent systems.</p> <p>Runner is the recommended usage, responsible for managing Agent execution flow, connecting Session/Memory Service capabilities, and providing a more user-friendly interface.</p> <p>Session Service is used to manage session state, supporting conversation history and context maintenance.</p> <p>Memory Service is used to record user preference information, supporting personalized experiences.</p> <p>Recommended Reading Order:</p> <ol> <li>Runner - Learn the recommended usage</li> <li>Session - Understand session management</li> <li>Multi-Agent - Learn multi-Agent systems</li> </ol>"},{"location":"agent/#runtime-instruction-updates","title":"Runtime Instruction Updates","text":"<p>You can update an Agent\u2019s behavior-defining text at runtime without rebuilding or restarting the Agent.</p> <p>What changes dynamically</p> <ul> <li>Instruction: the behavior guideline appended to the system message.</li> <li>Global Instruction (system prompt): the system-level preface prepended to the request.</li> </ul> <p>Both can be updated on an existing <code>LLMAgent</code> instance and take effect on subsequent model requests.</p> <p>Example</p> <pre><code>import (\n    \"context\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/agent/llmagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/model\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/openai\"\n    \"trpc.group/trpc-go/trpc-agent-go/runner\"\n)\n\n// 1) Build model and agent once at startup.\nmdl := openai.New(\"gpt-4o-mini\", openai.Options{})\nllm := llmagent.New(\n    \"support-bot\",\n    llmagent.WithModel(mdl),\n    llmagent.WithInstruction(\"Be helpful and concise.\"),\n)\nrun := runner.NewRunner(\"my-app\", llm)\n\n// 2) Later, change behavior at runtime (e.g., user updates prompt in UI).\nllm.SetInstruction(\"Translate all user inputs to French.\")\nllm.SetGlobalInstruction(\"System: Safety first. No PII leakage.\")\n\n// 3) Subsequent runs use the new instructions.\nmsg := model.NewUserMessage(\"Where is the nearest museum?\")\nch, err := run.Run(context.Background(), \"u1\", \"s1\", msg)\n_ = ch; _ = err\n</code></pre> <p>Notes</p> <ul> <li>Thread\u2011safe: the setters are concurrency\u2011safe and can be called while the service is handling requests.</li> <li>Mid\u2011turn behavior: if an Agent\u2019s current turn triggers more than one model request (e.g., due to tool calls), updates may apply to subsequent requests in the same turn. If you need per\u2011run stability, set or freeze the text at the start of the run.</li> <li>Per\u2011session personalization: for per\u2011user or per\u2011session data, prefer placeholders in the instruction and session state injection (see the \u201cPlaceholder Variables\u201d section above).</li> </ul>"},{"location":"agent/#alternative-placeholderdriven-dynamic-system-prompts","title":"Alternative: Placeholder\u2011Driven Dynamic System Prompts","text":"<p>If you\u2019d rather not call setters, you can make the instruction itself a template and feed values via session state. The instruction processor replaces placeholders using session/app/user state on each turn.</p> <p>Patterns</p> <ul> <li>Persistent per\u2011user value: store under <code>user:*</code> and reference <code>{user:key}</code>.</li> <li>Persistent per\u2011app value: store under <code>app:*</code> and reference <code>{app:key}</code>.</li> <li>Per\u2011turn ephemeral value: write into the session\u2019s <code>temp:*</code> namespace and reference <code>{temp:key}</code> (not persisted).</li> </ul> <p>Example: per\u2011user dynamic instruction</p> <pre><code>import (\n    \"context\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/agent/llmagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/runner\"\n    \"trpc.group/trpc-go/trpc-agent-go/session\"\n    \"trpc.group/trpc-go/trpc-agent-go/session/inmemory\"\n)\n\nsvc := inmemory.NewSessionService()\napp, user, sid := \"my-app\", \"u1\", \"s1\"\n\n// 1) Instruction template references a user-scoped key.\nllm := llmagent.New(\n  \"dyn-agent\",\n  llmagent.WithInstruction(\"{user:system_prompt}\"),\n)\nrun := runner.NewRunner(app, llm, runner.WithSessionService(svc))\n\n// 2) Update the user-scoped state when the user changes settings.\n_ = svc.UpdateUserState(context.Background(), session.UserKey{AppName: app, UserID: user}, session.StateMap{\n  \"system_prompt\": []byte(\"You are a helpful assistant. Always answer in English.\"),\n})\n\n// 3) Runs now read the latest prompt via placeholder injection.\n_, _ = run.Run(context.Background(), user, sid, model.NewUserMessage(\"Hi!\"))\n</code></pre> <p>Example: per\u2011turn temp value via a before\u2011agent callback</p> <p>Version Requirement The structured callback API (recommended) requires trpc-agent-go &gt;= 0.6.0.</p> <pre><code>// Note: Structured callback API requires trpc-agent-go &gt;= 0.6.0\ncallbacks := agent.NewCallbacks()\ncallbacks.RegisterBeforeAgent(func(ctx context.Context, args *agent.BeforeAgentArgs) (*agent.BeforeAgentResult, error) {\n  if args.Invocation != nil &amp;&amp; args.Invocation.Session != nil {\n    if args.Invocation.Session.State == nil {\n      args.Invocation.Session.State = make(map[string][]byte)\n    }\n    // Write a one-off instruction for this turn only\n    args.Invocation.Session.State[\"temp:sys\"] = []byte(\"Translate to French.\")\n  }\n  return nil, nil\n})\n\nllm := llmagent.New(\n  \"temp-agent\",\n  llmagent.WithInstruction(\"{temp:sys}\"),\n  llmagent.WithAgentCallbacks(callbacks), // requires trpc-agent-go &gt;= 0.6.0\n)\n</code></pre> <p>Caveats</p> <ul> <li>In-memory <code>UpdateUserState</code> intentionally forbids <code>temp:*</code> updates; write <code>temp:*</code> directly to <code>invocation.Session.State</code> (e.g., via a callback) when you need ephemeral, per\u2011turn values.</li> <li>Placeholders are resolved at request time; changing the stored value updates behavior on the next model request without recreating the agent.</li> </ul>"},{"location":"agui/","title":"AG-UI Guide","text":"<p>The AG-UI (Agent-User Interaction) protocol is maintained by the open-source AG-UI Protocol project. It enables agents built in different languages, frameworks, and execution environments to deliver their runtime outputs to user interfaces through a unified event stream. The protocol tolerates loosely matched payloads and supports transports such as SSE and WebSocket.</p> <p><code>tRPC-Agent-Go</code> ships with native AG-UI integration. It provides an SSE server implementation by default, while also allowing you to swap in a custom <code>service.Service</code> to use transports like WebSocket and to extend the event translation logic.</p>"},{"location":"agui/#getting-started","title":"Getting Started","text":"<p>Assuming you already have an agent, you can expose it via the AG-UI protocol with just a few lines of code:</p> <pre><code>import (\n    \"net/http\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/runner\"\n    \"trpc.group/trpc-go/trpc-agent-go/server/agui\"\n)\n\n// Create the agent.\nagent := newAgent()\n// Build the Runner that will execute the agent.\nrunner := runner.NewRunner(agent.Info().Name, agent)\n// Create the AG-UI server and mount it on an HTTP route.\nserver, err := agui.New(runner, agui.WithPath(\"/agui\"))\nif err != nil {\n    log.Fatalf(\"create agui server failed: %v\", err)\n}\n// Start the HTTP listener.\nif err := http.ListenAndServe(\"127.0.0.1:8080\", server.Handler()); err != nil {\n    log.Fatalf(\"server stopped with error: %v\", err)\n}\n</code></pre> <p>Note: If <code>WithPath</code> is not specified, the AG-UI server mounts at <code>/</code> by default.</p> <p>A complete version of this example lives in examples/agui/server/default.</p> <p>For an in-depth guide to Runners, refer to the runner documentation.</p> <p>On the client side you can pair the server with frameworks that understand the AG-UI protocol, such as CopilotKit. It provides React/Next.js components with built-in SSE subscriptions. The sample at examples/agui/client/copilotkit builds a web UI that communicates with the agent through AG-UI, as shown below.</p> <p></p>"},{"location":"agui/#advanced-usage","title":"Advanced Usage","text":""},{"location":"agui/#custom-transport","title":"Custom transport","text":"<p>The AG-UI specification does not enforce a transport. The framework uses SSE by default, but you can implement the <code>service.Service</code> interface to switch to WebSocket or any other transport:</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/runner\"\n    \"trpc.group/trpc-go/trpc-agent-go/server/agui\"\n    aguirunner \"trpc.group/trpc-go/trpc-agent-go/server/agui/runner\"\n    \"trpc.group/trpc-go/trpc-agent-go/server/agui/service\"\n)\n\ntype wsService struct {\n    path    string\n    runner  aguirunner.Runner\n    handler http.Handler\n}\n\nfunc NewWSService(runner aguirunner.Runner, opt ...service.Option) service.Service {\n    opts := service.NewOptions(opt...)\n    s := &amp;wsService{\n        path:   opts.Path,\n        runner: runner,\n    }\n    h := http.NewServeMux()\n    h.HandleFunc(s.path, s.handle)\n    s.handler = h\n    return s\n}\n\nfunc (s *wsService) Handler() http.Handler { /* HTTP Handler */ }\n\nrunner := runner.NewRunner(agent.Info().Name, agent)\nserver, _ := agui.New(runner, agui.WithServiceFactory(NewWSService))\n</code></pre>"},{"location":"agui/#custom-translator","title":"Custom translator","text":"<p><code>translator.New</code> converts internal events into the standard AG-UI events. To enrich the stream while keeping the default behaviour, implement <code>translator.Translator</code> and use the AG-UI <code>Custom</code> event type to carry extra data:</p> <pre><code>import (\n    aguievents \"github.com/ag-ui-protocol/ag-ui/sdks/community/go/pkg/core/events\"\n    agentevent \"trpc.group/trpc-go/trpc-agent-go/event\"\n    \"trpc.group/trpc-go/trpc-agent-go/runner\"\n    \"trpc.group/trpc-go/trpc-agent-go/server/agui\"\n    \"trpc.group/trpc-go/trpc-agent-go/server/agui/adapter\"\n    aguirunner \"trpc.group/trpc-go/trpc-agent-go/server/agui/runner\"\n    \"trpc.group/trpc-go/trpc-agent-go/server/agui/translator\"\n)\n\ntype customTranslator struct {\n    inner translator.Translator\n}\n\nfunc (t *customTranslator) Translate(ctx context.Context, evt *agentevent.Event) ([]aguievents.Event, error) {\n    out, err := t.inner.Translate(evt)\n    if err != nil {\n        return nil, err\n    }\n    if payload := buildCustomPayload(evt); payload != nil {\n        out = append(out, aguievents.NewCustomEvent(\"trace.metadata\", aguievents.WithValue(payload)))\n    }\n    return out, nil\n}\n\nfunc buildCustomPayload(evt *agentevent.Event) map[string]any {\n    if evt == nil || evt.Response == nil {\n        return nil\n    }\n    return map[string]any{\n        \"object\":    evt.Response.Object,\n        \"timestamp\": evt.Response.Timestamp,\n    }\n}\n\nfactory := func(ctx context.Context, input *adapter.RunAgentInput) translator.Translator {\n    return &amp;customTranslator{inner: translator.New(input.ThreadID, input.RunID)}\n}\n\nrunner := runner.NewRunner(agent.Info().Name, agent)\nserver, _ := agui.New(runner, agui.WithAGUIRunnerOptions(aguirunner.WithTranslatorFactory(factory)))\n</code></pre> <p>For example, when using React Planner, if you want to apply different custom events to different tags, you can achieve this by implementing a custom Translator, as shown in the image below.</p> <p></p> <p>You can find the complete code example in examples/agui/server/react.</p>"},{"location":"agui/#custom-useridresolver","title":"Custom <code>UserIDResolver</code>","text":"<p>By default every request maps to the fixed user ID <code>\"user\"</code>. Implement a custom <code>UserIDResolver</code> if you need to derive the user from the <code>RunAgentInput</code>:</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/runner\"\n    \"trpc.group/trpc-go/trpc-agent-go/server/agui\"\n    \"trpc.group/trpc-go/trpc-agent-go/server/agui/adapter\"\n    aguirunner \"trpc.group/trpc-go/trpc-agent-go/server/agui/runner\"\n)\n\nresolver := func(ctx context.Context, input *adapter.RunAgentInput) (string, error) {\n    if user, ok := input.ForwardedProps[\"userId\"].(string); ok &amp;&amp; user != \"\" {\n        return user, nil\n    }\n    return \"anonymous\", nil\n}\n\nrunner := runner.NewRunner(agent.Info().Name, agent)\nserver, _ := agui.New(runner, agui.WithAGUIRunnerOptions(aguirunner.WithUserIDResolver(resolver)))\n</code></pre>"},{"location":"agui/#custom-runoptionresolver","title":"Custom <code>RunOptionResolver</code>","text":"<p>By default, the AG-UI Runner does not append extra <code>agent.RunOption</code>s to the underlying <code>runner.Run</code>. Implement <code>RunOptionResolver</code>, inject it with <code>aguirunner.WithRunOptionResolver</code>, and translate client-provided configuration (for example, <code>modelName</code> or <code>knowledgeFilter</code>) from <code>ForwardedProps</code>.</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/agent\"\n    \"trpc.group/trpc-go/trpc-agent-go/runner\"\n    \"trpc.group/trpc-go/trpc-agent-go/server/agui\"\n    \"trpc.group/trpc-go/trpc-agent-go/server/agui/adapter\"\n    aguirunner \"trpc.group/trpc-go/trpc-agent-go/server/agui/runner\"\n)\n\nresolver := func(_ context.Context, input *adapter.RunAgentInput) ([]agent.RunOption, error) {\n    if input == nil {\n        return nil, errors.New(\"empty input\")\n    }\n    if input.ForwardedProps == nil {\n        return nil, nil\n    }\n    opts := make([]agent.RunOption, 0, 2)\n    if modelName, ok := input.ForwardedProps[\"modelName\"].(string); ok &amp;&amp; modelName != \"\" {\n        opts = append(opts, agent.WithModelName(modelName))\n    }\n    if filter, ok := input.ForwardedProps[\"knowledgeFilter\"].(map[string]any); ok {\n        opts = append(opts, agent.WithKnowledgeFilter(filter))\n    }\n    return opts, nil\n}\n\nrunner := runner.NewRunner(agent.Info().Name, agent)\nserver, _ := agui.New(runner, agui.WithAGUIRunnerOptions(aguirunner.WithRunOptionResolver(resolver)))\n</code></pre> <p><code>RunOptionResolver</code> executes for every incoming <code>RunAgentInput</code>. Its return value is forwarded to <code>runner.Run</code> in order. Returning an error surfaces a <code>RunError</code> to the client, while returning <code>nil</code> means no extra options are added.</p>"},{"location":"agui/#observability-reporting","title":"Observability Reporting","text":"<p>AG-UI Runner exposes <code>WithStartSpan</code> to create a tracing span at the beginning of each run and attach request attributes.</p> <pre><code>import (\n    \"go.opentelemetry.io/otel/attribute\"\n    \"go.opentelemetry.io/otel/trace\"\n    \"trpc.group/trpc-go/trpc-agent-go/server/agui\"\n    aguirunner \"trpc.group/trpc-go/trpc-agent-go/server/agui/runner\"\n    \"trpc.group/trpc-go/trpc-agent-go/server/agui/adapter\"\n    \"trpc.group/trpc-go/trpc-agent-go/runner\"\n    atrace \"trpc.group/trpc-go/trpc-agent-go/telemetry/trace\"\n)\n\n// Custom StartSpan: set threadId/userId/input as span attributes\nfunc startSpan(ctx context.Context, input *adapter.RunAgentInput) (context.Context, trace.Span, error) {\n    userID, err := userIDResolver(ctx, input)\n    if err != nil {\n        return nil, nil, err\n    }\n    attrs := []attribute.KeyValue{\n        attribute.String(\"session.id\", input.ThreadID),\n        attribute.String(\"user.id\", userID),\n        attribute.String(\"trace.input\", input.Messages[len(input.Messages)-1].Content),\n    }\n    ctx, span := atrace.Tracer.Start(ctx, \"agui-run\", trace.WithAttributes(attrs...))\n    return ctx, span, nil\n}\n\nfunc userIDResolver(ctx context.Context, input *adapter.RunAgentInput) (string, error) {\n    if user, ok := input.ForwardedProps[\"userId\"].(string); ok &amp;&amp; user != \"\" {\n        return user, nil\n    }\n    return \"anonymous\", nil\n}\n\nr := runner.NewRunner(agent.Info().Name, agent)\nserver, err := agui.New(r,\n    agui.WithAGUIRunnerOptions(\n        aguirunner.WithUserIDResolver(userIDResolver),\n        aguirunner.WithStartSpan(startSpan),\n    ),\n)\n</code></pre> <p>Pair this with an <code>AfterTranslate</code> callback to accumulate output and write it to <code>trace.output</code>. This keeps streaming events aligned with backend traces so you can inspect both input and final output in your observability platform. </p> <p>For a Langfuse-specific example, see examples/agui/server/langfuse.</p>"},{"location":"agui/#event-translation-callback","title":"Event Translation Callback","text":"<p>AG-UI provides an event translation callback mechanism, allowing custom logic to be inserted before and after the event translation process.</p> <ul> <li><code>translator.BeforeTranslateCallback</code>: Triggered before the internal event is translated into an AG-UI event. The return value convention:<ul> <li>Return <code>(customEvent, nil)</code>: Use <code>customEvent</code> as the input event for translation.</li> <li>Return <code>(nil, nil)</code>: Retain the current event and continue with the subsequent callbacks. If all callbacks return <code>nil</code>, the original event will be used.</li> <li>Return an error: Terminates the current execution, and the client will receive a <code>RunError</code>.</li> </ul> </li> <li><code>translator.AfterTranslateCallback</code>: Triggered after the AG-UI event translation is completed and just before it is sent to the client. The return value convention:<ul> <li>Return <code>(customEvent, nil)</code>: Use <code>customEvent</code> as the final event to be sent to the client.</li> <li>Return <code>(nil, nil)</code>: Retain the current event and continue with the subsequent callbacks. If all callbacks return <code>nil</code>, the original event will be sent.</li> <li>Return an error: Terminates the current execution, and the client will receive a <code>RunError</code>.</li> </ul> </li> </ul> <p>Usage Example:</p> <pre><code>import (\n    aguievents \"github.com/ag-ui-protocol/ag-ui/sdks/community/go/pkg/core/events\"\n    \"trpc.group/trpc-go/trpc-agent-go/event\"\n    \"trpc.group/trpc-go/trpc-agent-go/server/agui\"\n    aguirunner \"trpc.group/trpc-go/trpc-agent-go/server/agui/runner\"\n    \"trpc.group/trpc-go/trpc-agent-go/server/agui/translator\"\n)\n\ncallbacks := translator.NewCallbacks().\n    RegisterBeforeTranslate(func(ctx context.Context, event *event.Event) (*event.Event, error) {\n        // Logic to execute before event translation\n        return nil, nil\n    }).\n    RegisterAfterTranslate(func(ctx context.Context, event aguievents.Event) (aguievents.Event, error) {\n        // Logic to execute after event translation\n        if msg, ok := event.(*aguievents.TextMessageContentEvent); ok {\n            // Modify the message content in the event\n            return aguievents.NewTextMessageContentEvent(msg.MessageID, msg.Delta+\" [via callback]\"), nil\n        }\n        return nil, nil\n    })\n\nserver, err := agui.New(runner, agui.WithAGUIRunnerOptions(aguirunner.WithTranslateCallbacks(callbacks)))\n</code></pre> <p>Event translation callbacks can be used in various scenarios, such as:</p> <ul> <li>Custom Event Handling: Modify event data or add additional business logic during the translation process.</li> <li>Monitoring and Reporting: Insert monitoring and reporting logic before and after event translation. A full example of integrating with Langfuse observability platform can be found at examples/agui/server/langfuse.</li> </ul>"},{"location":"agui/#runagentinput-hook","title":"RunAgentInput Hook","text":"<p>You can use <code>WithRunAgentInputHook</code> to mutate the AG-UI request before it reaches the runner. The following example reads <code>other_content</code> from <code>ForwardedProps</code> and appends it to the latest user message:</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/runner\"\n    \"trpc.group/trpc-go/trpc-agent-go/server/agui\"\n    \"trpc.group/trpc-go/trpc-agent-go/server/agui/adapter\"\n    aguirunner \"trpc.group/trpc-go/trpc-agent-go/server/agui/runner\"\n)\n\nhook := func(ctx context.Context, input *adapter.RunAgentInput) (*adapter.RunAgentInput, error) {\n    if input == nil {\n        return nil, errors.New(\"empty input\")\n    }\n    if len(input.Messages) == 0 {\n        return nil, errors.New(\"missing messages\")\n    }\n    if input.ForwardedProps == nil {\n        return input, nil\n    }\n    otherContent, ok := input.ForwardedProps[\"other_content\"].(string)\n    if !ok {\n        return input, nil\n    }\n\n    input.Messages[len(input.Messages)-1].Content += otherContent\n    return input, nil\n}\n\nrunner := runner.NewRunner(agent.Info().Name, agent)\nserver, _ := agui.New(runner, agui.WithAGUIRunnerOptions(aguirunner.WithRunAgentInputHook(hook)))\n</code></pre> <p>Key points:</p> <ul> <li>Returning <code>nil</code> keeps the original input object while preserving in-place edits.</li> <li>Returning a custom <code>*adapter.RunAgentInput</code> replaces the original input; returning <code>nil</code> keeps it.</li> <li>Returning an error aborts the request and the client receives a <code>RunError</code> event.</li> </ul>"},{"location":"agui/#session-storage-and-event-aggregation","title":"Session Storage and Event Aggregation","text":"<p>When constructing the AG-UI Runner, pass in <code>SessionService</code>. Events generated by real-time conversations will be written into the session through <code>SessionService</code>, making it convenient to replay the history later via <code>MessagesSnapshot</code>.</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/runner\"\n    \"trpc.group/trpc-go/trpc-agent-go/server/agui\"\n    aguirunner \"trpc.group/trpc-go/trpc-agent-go/server/agui/runner\"\n    \"trpc.group/trpc-go/trpc-agent-go/session/inmemory\"  \n)\n\nrunner := runner.NewRunner(agent.Info().Name, agent)\nsessionService := inmemory.NewSessionService()\n\nserver, err := agui.New(\n    runner,\n    agui.WithPath(\"/agui\"),\n    agui.WithMessagesSnapshotPath(\"/history\"),\n    agui.WithMessagesSnapshotEnabled(true),\n    agui.WithAppName(appName),\n    agui.WithSessionService(sessionService),\n    agui.WithAGUIRunnerOptions(aguirunner.WithUserIDResolver(userIDResolver)),\n)\n</code></pre> <p>In streaming response scenarios, a single reply usually consists of multiple incremental text events. Writing all of them directly into the session can put significant pressure on <code>SessionService</code>.</p> <p>To address this, the framework first aggregates events and then writes them into the session. In addition, it performs a periodic flush once per second by default, and each flush writes the current aggregation result into the session.</p> <ul> <li><code>aggregator.WithEnabled(true)</code> is used to control whether event aggregation is enabled. It is enabled by default. When enabled, it aggregates consecutive text events that share the same <code>messageId</code>. When disabled, no aggregation is performed on AG-UI events.</li> <li><code>aguirunner.WithFlushInterval(time.Second)</code> is used to control the periodic flush interval of aggregated results. The default is 1 second. Setting it to 0 disables the periodic flush mechanism.</li> </ul> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/runner\"\n    \"trpc.group/trpc-go/trpc-agent-go/server/agui\"\n    \"trpc.group/trpc-go/trpc-agent-go/server/agui/aggregator\"\n    aguirunner \"trpc.group/trpc-go/trpc-agent-go/server/agui/runner\"\n    \"trpc.group/trpc-go/trpc-agent-go/session/inmemory\"\n)\n\nrunner := runner.NewRunner(agent.Info().Name, agent)\nsessionService := inmemory.NewSessionService()\n\nserver, err := agui.New(\n    runner,\n    agui.WithPath(\"/agui\"),\n    agui.WithMessagesSnapshotPath(\"/history\"),\n    agui.WithMessagesSnapshotEnabled(true),\n    agui.WithAppName(appName),\n    agui.WithSessionService(sessionService),\n    agui.WithAGUIRunnerOptions(\n        aguirunner.WithUserIDResolver(userIDResolver),\n        aguirunner.WithAggregationOption(aggregator.WithEnabled(true)), // Enable event aggregation, enabled by default\n        aguirunner.WithFlushInterval(time.Second),                      // Set the periodic flush interval for aggregation results, default is 1 second\n    ),\n)\n</code></pre> <p>If more complex aggregation strategies are required, you can implement <code>aggregator.Aggregator</code> and inject it through a custom factory. Note that although an aggregator is created separately for each session, avoiding cross-session state management and concurrency handling, the aggregation methods themselves may still be called concurrently, so concurrency must still be handled properly.</p> <p>For example, while remaining compatible with the default text aggregation, you can accumulate the content of custom events of type <code>\"think\"</code> and then persist them.</p> <p>A complete example can be found at examples/agui/server/thinkaggregator</p> <pre><code>import (\n    aguievents \"github.com/ag-ui-protocol/ag-ui/sdks/community/go/pkg/core/events\"\n    \"trpc.group/trpc-go/trpc-agent-go/runner\"\n    \"trpc.group/trpc-go/trpc-agent-go/server/agui\"\n    \"trpc.group/trpc-go/trpc-agent-go/server/agui/aggregator\"\n    aguirunner \"trpc.group/trpc-go/trpc-agent-go/server/agui/runner\"\n    \"trpc.group/trpc-go/trpc-agent-go/session/inmemory\"\n)\n\ntype thinkAggregator struct {\n    mu    sync.Mutex\n    inner aggregator.Aggregator\n    think strings.Builder\n}\n\nfunc newAggregator(ctx context.Context, opt ...aggregator.Option) aggregator.Aggregator {\n    return &amp;thinkAggregator{inner: aggregator.New(ctx, opt...)}\n}\n\n\nfunc (c *thinkAggregator) Append(ctx context.Context, event aguievents.Event) ([]aguievents.Event, error) {\n    // Use a mutex to ensure concurrent safety of the inner aggregator and the think buffer, avoiding race conditions when multiple events are appended concurrently.\n    c.mu.Lock()\n    defer c.mu.Unlock()\n\n    // For custom \"think\" events, use a strategy of \"accumulate only, do not emit immediately\":\n    // 1. Force flush inner first to fully emit previously accumulated normal events.\n    // 2. Append the current think content to the buffer only, without returning it immediately.\n    // This ensures that think fragments are not interrupted by normal events, and that previous normal events are emitted before new thinking content.\n    if custom, ok := event.(*aguievents.CustomEvent); ok &amp;&amp; custom.Name == string(thinkEventTypeContent) {\n        flushed, err := c.inner.Flush(ctx)\n        if err != nil {\n            return nil, err\n        }\n        // Only participate in accumulation when the value is a string, to avoid polluting the buffer with values of unexpected types.\n        if v, ok := custom.Value.(string); ok {\n            c.think.WriteString(v)\n        }\n        // The current think event only participates in internal accumulation and is not immediately visible externally. The return value is the previously aggregated results from inner.\n        return flushed, nil\n    }\n\n    // Non-think events follow the default inner aggregation logic to ensure that the original text aggregation behavior is preserved.\n    events, err := c.inner.Append(ctx, event)\n    if err != nil {\n        return nil, err\n    }\n\n    // If there is no accumulated think content, directly return the aggregation results from inner without additional wrapping.\n    if c.think.Len() == 0 {\n        return events, nil\n    }\n\n    // If there is accumulated think content, insert a single aggregated think event before the current batch of events:\n    // 1. Package the buffer content into a single CustomEvent.\n    // 2. Clear the buffer to avoid sending duplicate content.\n    // 3. Place this think event before the current events to preserve the time order: output the complete thinking content first, then subsequent events.\n    think := aguievents.NewCustomEvent(string(thinkEventTypeContent), aguievents.WithValue(c.think.String()))\n    c.think.Reset()\n\n    out := make([]aguievents.Event, 0, len(events)+1)\n    out = append(out, think)\n    out = append(out, events...)\n    return out, nil\n}\n\nfunc (c *thinkAggregator) Flush(ctx context.Context) ([]aguievents.Event, error) {\n    // Flush likewise needs to ensure concurrent safety of the inner aggregator and the think buffer.\n    c.mu.Lock()\n    defer c.mu.Unlock()\n\n    // Flush inner first to ensure that all normal events are emitted according to its own aggregation strategy.\n    events, err := c.inner.Flush(ctx)\n    if err != nil {\n        return nil, err\n    }\n\n    // If there is still unflushed content in the think buffer,\n    // wrap it into a single aggregated think event and insert it at the front of the current batch,\n    // ensuring that the aggregated thinking content is not reordered by events produced by subsequent flushes.\n    if c.think.Len() &gt; 0 {\n        think := aguievents.NewCustomEvent(string(thinkEventTypeContent), aguievents.WithValue(c.think.String()))\n        c.think.Reset()\n        events = append([]aguievents.Event{think}, events...)\n    }\n    return events, nil\n}\n\nrunner := runner.NewRunner(agent.Info().Name, agent)\nsessionService := inmemory.NewSessionService()\n\nserver, err := agui.New(\n    runner,\n    agui.WithPath(\"/agui\"),\n    agui.WithMessagesSnapshotPath(\"/history\"),\n    agui.WithMessagesSnapshotEnabled(true),\n    agui.WithAppName(appName),\n    agui.WithSessionService(sessionService),\n    agui.WithAGUIRunnerOptions(\n        aguirunner.WithUserIDResolver(userIDResolver),\n        aguirunner.WithAggregatorFactory(newAggregator),\n    ),\n)\n</code></pre>"},{"location":"agui/#message-snapshot","title":"Message Snapshot","text":"<p>Message snapshots restore historical conversations when a page is first opened or a connection is re-established. The feature is controlled by <code>agui.WithMessagesSnapshotEnabled(true)</code> and is disabled by default. Once enabled, AG-UI exposes both the chat route and the snapshot route:</p> <ul> <li>The chat route defaults to <code>/</code> and can be customised with <code>agui.WithPath</code>;</li> <li>The snapshot route defaults to <code>/history</code>, can be customised with <code>WithMessagesSnapshotPath</code>, and returns the event flow <code>RUN_STARTED \u2192 MESSAGES_SNAPSHOT \u2192 RUN_FINISHED</code>.</li> </ul> <p>When enabling message snapshots, configure the following options:</p> <ul> <li><code>agui.WithMessagesSnapshotEnabled(true)</code> enables the snapshot endpoint;</li> <li><code>agui.WithMessagesSnapshotPath</code> sets the custom snapshot route, defaulting to <code>/history</code>;</li> <li><code>agui.WithAppName(name)</code> specifies the application name;</li> <li><code>agui.WithSessionService(service)</code> injects the <code>session.Service</code> used to look up historical events;</li> <li><code>aguirunner.WithUserIDResolver(resolver)</code> customises how <code>userID</code> is resolved, defaulting to <code>\"user\"</code>.</li> </ul> <p>While serving a snapshot request, the framework parses <code>threadId</code> from the <code>RunAgentInput</code> as the <code>SessionID</code>, combines it with the custom <code>UserIDResolver</code> to obtain <code>userID</code>, and then builds a <code>session.Key</code> together with <code>appName</code>. It queries the session through <code>session.Service</code>, converts the stored events (<code>Session.Events</code>) into AG-UI messages, and wraps them in a <code>MESSAGES_SNAPSHOT</code> event alongside matching <code>RUN_STARTED</code> and <code>RUN_FINISHED</code> events.</p> <p>Example:</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/server/agui\"\n    \"trpc.group/trpc-go/trpc-agent-go/server/agui/adapter\"\n    aguirunner \"trpc.group/trpc-go/trpc-agent-go/server/agui/runner\"\n    \"trpc.group/trpc-go/trpc-agent-go/session/inmemory\"\n)\n\nresolver := func(ctx context.Context, input *adapter.RunAgentInput) (string, error) {\n    if user, ok := input.ForwardedProps[\"userId\"].(string); ok &amp;&amp; user != \"\" {\n        return user, nil\n    }\n    return \"anonymous\", nil\n}\n\nsessionService := inmemory.NewService(context.Background())\nserver, err := agui.New(\n    runner,\n    agui.WithPath(\"/chat\"),                    // Custom chat route, defaults to \"/\"\n    agui.WithAppName(\"demo-app\"),              // AppName used to build the session key\n    agui.WithSessionService(sessionService),   // Session Service used to query sessions\n    agui.WithMessagesSnapshotEnabled(true),    // Enable message snapshots\n    agui.WithMessagesSnapshotPath(\"/history\"), // Snapshot route, defaults to \"/history\"\n    agui.WithAGUIRunnerOptions(\n        aguirunner.WithUserIDResolver(resolver), // Custom userID resolver\n    ),\n)\nif err != nil {\n    log.Fatalf(\"create agui server failed: %v\", err)\n}\nif err := http.ListenAndServe(\"127.0.0.1:8080\", server.Handler()); err != nil {\n    log.Fatalf(\"server stopped with error: %v\", err)\n}\n</code></pre> <p>You can find a complete example at examples/agui/messagessnapshot.</p> <p>The format of AG-UI's MessagesSnapshot event can be found at messages.</p>"},{"location":"agui/#setting-the-basepath-for-routes","title":"Setting the BasePath for Routes","text":"<p><code>agui.WithBasePath</code> sets the base route prefix for the AG-UI service. The default value is <code>/</code>, and it is used to mount the chat route and message snapshot route under a unified prefix, avoiding conflicts with existing services.</p> <p><code>agui.WithPath</code> and <code>agui.WithMessagesSnapshotPath</code> only define sub-routes under the base path. The framework will use <code>url.JoinPath</code> to concatenate them with the base path to form the final accessible routes.</p> <p>Here\u2019s an example of usage:</p> <pre><code>server, err := agui.New(\n    runner,\n    agui.WithBasePath(\"/agui\"),                // Set the AG-UI prefix route\n    agui.WithPath(\"/chat\"),                    // Set the chat route, default is \"/\"\n    agui.WithMessagesSnapshotEnabled(true),    // Enable message snapshot feature\n    agui.WithMessagesSnapshotPath(\"/history\"), // Set the message snapshot route, default is \"/history\"\n)\nif err != nil {\n    log.Fatalf(\"create agui server failed: %v\", err)\n}\n</code></pre> <p>In this case, the chat route will be <code>/agui/chat</code>, and the message snapshot route will be <code>/agui/history</code>.</p>"},{"location":"agui/#best-practices","title":"Best Practices","text":""},{"location":"agui/#generating-documents","title":"Generating Documents","text":"<p>If a long-form document is inserted directly into the main conversation, it can easily \u201cflood\u201d the dialogue, making it hard for users to distinguish between conversation content and document content. To solve this, it\u2019s recommended to use a document panel to carry long documents. By defining a workflow in the AG-UI event stream \u2014 \u201copen document panel \u2192 write document content \u2192 close document panel\u201d \u2014 you can pull long documents out of the main conversation and avoid disturbing normal interactions. A sample approach is as follows.</p> <ol> <li> <p>Backend: Define tools and constrain call order</p> <p>Provide the Agent with two tools: open document panel and close document panel, and constrain the generation order in the prompt:  when entering the document generation flow, execute in the following order:</p> <ol> <li>Call the \u201copen document panel\u201d tool first</li> <li>Then output the document content</li> <li>Finally call the \u201cclose document panel\u201d tool</li> </ol> <p>Converted into an AG-UI event stream, it looks roughly like this:</p> <pre><code>Open document panel tool\n  \u2192 ToolCallStart\n  \u2192 ToolCallArgs\n  \u2192 ToolCallEnd\n  \u2192 ToolCallResult\n\nDocument content\n  \u2192 TextMessageStart\n  \u2192 TextMessageContent\n  \u2192 TextMessageEnd\n\nClose document panel tool\n  \u2192 ToolCallStart\n  \u2192 ToolCallArgs\n  \u2192 ToolCallEnd\n  \u2192 ToolCallResult\n</code></pre> </li> <li> <p>Frontend: Listen for tool events and manage the document panel</p> <p>On the frontend, listen to the event stream:</p> <ul> <li>When an <code>open_report_document</code> tool event is captured: create a document panel and write all subsequent text message content into that panel.</li> <li>When a <code>close_report_document</code> tool event is captured: close the document panel (or mark it as completed).</li> </ul> </li> </ol> <p>The effect is shown below. For a full example, refer to examples/agui/server/report.</p> <p></p>"},{"location":"artifact/","title":"Artifacts","text":"<p>Artifacts in trpc-agent-go are named, versioned binary data objects that can be linked to user sessions or persistently associated with users across sessions. The artifact system consists of two main components:</p> <ol> <li>Artifacts: The data objects themselves - containing binary content, metadata, and versioning information</li> <li>Artifact Service: The storage and management service that handles saving, retrieving, and organizing artifacts</li> </ol> <p>This system enables agents to store, retrieve, and manage various types of content including images, documents, text files, and other binary data.</p>"},{"location":"artifact/#what-are-artifacts","title":"What are Artifacts?","text":"<p>Artifacts are data containers that hold:</p> <ul> <li>Binary content (images, documents, files, etc.)</li> <li>Metadata (MIME type, name, URL)</li> <li>Version information</li> <li>Association with users and sessions</li> </ul>"},{"location":"artifact/#what-is-the-artifact-service","title":"What is the Artifact Service?","text":"<p>The Artifact Service is the backend system that:</p> <ul> <li>Stores and retrieves artifacts</li> <li>Manages versioning</li> <li>Handles namespace organization (session vs user scope)</li> <li>Provides different storage backends (in-memory, cloud storage)</li> </ul>"},{"location":"artifact/#system-overview","title":"System Overview","text":"<p>The artifact system provides:</p> <ul> <li>Versioned Storage: Each artifact is automatically versioned, allowing you to track changes over time</li> <li>Session-based Organization: Artifacts can be scoped to specific user sessions</li> <li>User-persistent Storage: Artifacts can be stored persistently for users across sessions using the <code>user:</code> namespace</li> <li>Multiple Storage Backends: Support for in-memory storage (development) and cloud storage (production)</li> <li>MIME Type Support: Proper content type handling for different file formats</li> </ul>"},{"location":"artifact/#core-components","title":"Core Components","text":""},{"location":"artifact/#artifact-data-structure","title":"Artifact Data Structure","text":"<p>An Artifact is the fundamental data object that contains your content:</p> <pre><code>type Artifact struct {\n    // Data contains the raw bytes (required)\n    Data []byte `json:\"data,omitempty\"`\n    // MimeType is the IANA standard MIME type (required)\n    MimeType string `json:\"mime_type,omitempty\"`\n    // URL is the optional URL where the artifact can be accessed\n    URL string `json:\"url,omitempty\"`\n    // Name is an optional display name of the artifact\n    Name string `json:\"name,omitempty\"`\n}\n</code></pre>"},{"location":"artifact/#session-information","title":"Session Information","text":"<pre><code>type SessionInfo struct {\n    // AppName is the name of the application\n    AppName string\n    // UserID is the ID of the user\n    UserID string\n    // SessionID is the ID of the session\n    SessionID string\n}\n</code></pre>"},{"location":"artifact/#artifact-service-backends","title":"Artifact Service Backends","text":"<p>The Artifact Service provides different storage implementations for managing artifacts:</p>"},{"location":"artifact/#in-memory-storage","title":"In-Memory Storage","text":"<p>Perfect for development and testing:</p> <pre><code>import \"trpc.group/trpc-go/trpc-agent-go/artifact/inmemory\"\n\nservice := inmemory.NewService()\n</code></pre>"},{"location":"artifact/#tencent-cloud-object-storage-cos","title":"Tencent Cloud Object Storage (COS)","text":"<p>For production deployments with Tencent Cloud:</p> <pre><code>import \"trpc.group/trpc-go/trpc-agent-go/artifact/cos\"\n\n// Set environment variables\n// export COS_SECRETID=\"your-secret-id\"\n// export COS_SECRETKEY=\"your-secret-key\"\n\nservice := cos.NewService(\"https://bucket.cos.region.myqcloud.com\")\n</code></pre>"},{"location":"artifact/#s3-compatible-storage","title":"S3-Compatible Storage","text":"<p>The S3 backend supports AWS S3 and S3-compatible services (MinIO, DigitalOcean Spaces, Cloudflare R2, etc.).</p> <pre><code>import \"trpc.group/trpc-go/trpc-agent-go/artifact/s3\"\n</code></pre>"},{"location":"artifact/#usage","title":"Usage","text":"<pre><code>// Create the service\nservice, err := s3.NewService(os.Getenv(\"S3_BUCKET\"))\nif err != nil {\n    log.Fatal(err)\n}\n\n// With custom endpoint (for S3-compatible services)\nservice, err := s3.NewService(os.Getenv(\"S3_BUCKET\"),\n    s3.WithEndpoint(os.Getenv(\"S3_ENDPOINT\")),\n    s3.WithCredentials(os.Getenv(\"S3_ACCESS_KEY\"), os.Getenv(\"S3_SECRET_KEY\")),\n    s3.WithPathStyle(),  // Required for MinIO and some S3-compatible services\n)\n</code></pre> <p>Note: The bucket must already exist before using the service.</p>"},{"location":"artifact/#configuration-options","title":"Configuration Options","text":"Option Description Default <code>WithEndpoint(url)</code> Custom endpoint for S3-compatible services (use <code>http://</code> for non-SSL) AWS S3 <code>WithRegion(region)</code> AWS region <code>AWS_REGION</code> env or <code>us-east-1</code> <code>WithCredentials(key, secret)</code> Static credentials AWS credential chain <code>WithSessionToken(token)</code> STS session token for temporary credentials - <code>WithPathStyle()</code> Use path-style URLs (required for MinIO, R2) Virtual-hosted <code>WithRetries(n)</code> Max retry attempts 3"},{"location":"artifact/#credential-resolution-order","title":"Credential Resolution Order","text":"<p>When no explicit credentials are provided via <code>WithCredentials()</code>, the AWS SDK resolves credentials in the following order of precedence:</p> <ol> <li>Environment variables: <code>AWS_ACCESS_KEY_ID</code> and <code>AWS_SECRET_ACCESS_KEY</code></li> <li>Shared credentials file: <code>~/.aws/credentials</code> (with optional <code>AWS_PROFILE</code>)</li> <li>IAM role: EC2 instance profile, ECS task role, Lambda execution role, etc.</li> </ol>"},{"location":"artifact/#usage-in-agents","title":"Usage in Agents","text":""},{"location":"artifact/#setup-artifact-service-with-runner","title":"Setup Artifact Service with Runner","text":"<pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/artifact/inmemory\"\n    \"trpc.group/trpc-go/trpc-agent-go/runner\"\n)\n\n// Create artifact service\nartifactService := inmemory.NewService()\n\n// Create runner with artifact service\nr := runner.NewRunner(\n    \"my-app\",\n    myAgent,\n    runner.WithArtifactService(artifactService),\n)\n</code></pre>"},{"location":"artifact/#creating-and-managing-artifacts-in-tools","title":"Creating and Managing Artifacts in Tools","text":"<p>Tools can create artifacts and use the Artifact Service through the tool context:</p> <pre><code>func myTool(ctx context.Context, input MyInput) (MyOutput, error) {\n    // Get tool context\n    toolCtx, err := agent.NewToolContext(ctx)\n    if err != nil {\n        return MyOutput{}, err\n    }\n\n    // Create an artifact\n    artifact := &amp;artifact.Artifact{\n        Data:     []byte(\"Hello, World!\"),\n        MimeType: \"text/plain\",\n        Name:     \"greeting.txt\",\n    }\n\n    // Save the artifact\n    version, err := toolCtx.SaveArtifact(\"greeting.txt\", artifact)\n    if err != nil {\n        return MyOutput{}, err\n    }\n\n    // Load the artifact later\n    loadedArtifact, err := toolCtx.LoadArtifact(\"greeting.txt\", nil) // nil for latest version\n    if err != nil {\n        return MyOutput{}, err\n    }\n\n    return MyOutput{}, nil\n}\n</code></pre>"},{"location":"artifact/#namespace-and-versioning","title":"Namespace and Versioning","text":""},{"location":"artifact/#session-scoped-artifacts","title":"Session-scoped Artifacts","text":"<p>By default, artifacts are scoped to the current session:</p> <pre><code>// This file is only accessible within the current session\nversion, err := toolCtx.SaveArtifact(\"session-file.txt\", artifact)\n</code></pre>"},{"location":"artifact/#user-persistent-artifacts","title":"User-persistent Artifacts","text":"<p>Use the <code>user:</code> prefix to create artifacts that persist across sessions:</p> <pre><code>// This file persists across all sessions for the user\nversion, err := toolCtx.SaveArtifact(\"user:profile.json\", artifact)\n</code></pre>"},{"location":"artifact/#version-management","title":"Version Management","text":"<p>Each save operation creates a new version:</p> <pre><code>// Save version 0\nv0, _ := toolCtx.SaveArtifact(\"document.txt\", artifact1)\n\n// Save version 1\nv1, _ := toolCtx.SaveArtifact(\"document.txt\", artifact2)\n\n// Load specific version\noldVersion := 0\nartifact, _ := toolCtx.LoadArtifact(\"document.txt\", &amp;oldVersion)\n\n// Load latest version\nartifact, _ := toolCtx.LoadArtifact(\"document.txt\", nil)\n</code></pre>"},{"location":"artifact/#artifact-service-interface","title":"Artifact Service Interface","text":"<p>The Artifact Service provides the following operations for managing artifacts:</p> <pre><code>type Service interface {\n    // Save an artifact and return the version ID\n    SaveArtifact(ctx context.Context, sessionInfo SessionInfo, filename string, artifact *Artifact) (int, error)\n\n    // Load an artifact (latest version if version is nil)\n    LoadArtifact(ctx context.Context, sessionInfo SessionInfo, filename string, version *int) (*Artifact, error)\n\n    // List all artifact filenames in a session\n    ListArtifactKeys(ctx context.Context, sessionInfo SessionInfo) ([]string, error)\n\n    // Delete an artifact (all versions)\n    DeleteArtifact(ctx context.Context, sessionInfo SessionInfo, filename string) error\n\n    // List all versions of an artifact\n    ListVersions(ctx context.Context, sessionInfo SessionInfo, filename string) ([]int, error)\n}\n</code></pre>"},{"location":"artifact/#examples","title":"Examples","text":""},{"location":"artifact/#image-generation-and-storage","title":"Image Generation and Storage","text":"<pre><code>// Tool to generate and save images\nfunc generateImageTool(ctx context.Context, input GenerateImageInput) (GenerateImageOutput, error) {\n    // Generate image (implementation details omitted)\n    imageData := generateImage(input.Prompt)\n\n    // Create artifact\n    artifact := &amp;artifact.Artifact{\n        Data:     imageData,\n        MimeType: \"image/png\",\n        Name:     \"generated-image.png\",\n    }\n\n    // Save to artifacts\n    toolCtx, _ := agent.NewToolContext(ctx)\n    version, err := toolCtx.SaveArtifact(\"generated-image.png\", artifact)\n\n    return GenerateImageOutput{\n        ImagePath: \"generated-image.png\",\n        Version:   version,\n    }, err\n}\n</code></pre>"},{"location":"artifact/#text-processing-and-storage","title":"Text Processing and Storage","text":"<pre><code>// Tool to process and save text\nfunc processTextTool(ctx context.Context, input ProcessTextInput) (ProcessTextOutput, error) {\n    // Process the text\n    processedText := strings.ToUpper(input.Text)\n\n    // Create artifact\n    artifact := &amp;artifact.Artifact{\n        Data:     []byte(processedText),\n        MimeType: \"text/plain\",\n        Name:     \"processed-text.txt\",\n    }\n\n    // Save to user namespace for persistence\n    toolCtx, _ := agent.NewToolContext(ctx)\n    version, err := toolCtx.SaveArtifact(\"user:processed-text.txt\", artifact)\n\n    return ProcessTextOutput{\n        ProcessedText: processedText,\n        Version:       version,\n    }, err\n}\n</code></pre>"},{"location":"artifact/#best-practices","title":"Best Practices","text":"<ol> <li> <p>Use Appropriate Namespaces: Use session-scoped artifacts for temporary data and user-persistent artifacts for data that should survive across sessions.</p> </li> <li> <p>Set Proper MIME Types: Always specify the correct MIME type for your artifacts to ensure proper handling.</p> </li> <li> <p>Handle Versions: Consider whether you need to track versions and use the versioning system appropriately.</p> </li> <li> <p>Choose the Right Storage Backend: Use in-memory storage for development and cloud storage for production.</p> </li> <li> <p>Error Handling: Always handle errors when saving and loading artifacts, as storage operations can fail.</p> </li> <li> <p>Resource Management: Be mindful of storage costs and data lifecycle when using cloud storage backends.</p> </li> </ol>"},{"location":"artifact/#configuration","title":"Configuration","text":""},{"location":"artifact/#environment-variables-for-s3","title":"Environment Variables for S3","text":"<p>When using AWS S3 or S3-compatible services:</p> <pre><code>export AWS_ACCESS_KEY_ID=\"your-access-key\"\nexport AWS_SECRET_ACCESS_KEY=\"your-secret-key\"\nexport AWS_REGION=\"your-region\"\nexport S3_BUCKET=\"your-bucket-name\"\n\n# Optional: for S3-compatible services (MinIO, R2, Spaces, etc.)\nexport S3_ENDPOINT=\"https://your-endpoint.com\"\n</code></pre>"},{"location":"artifact/#environment-variables-for-cos","title":"Environment Variables for COS","text":"<p>When using Tencent Cloud Object Storage:</p> <pre><code>export COS_SECRETID=\"your-secret-id\"\nexport COS_SECRETKEY=\"your-secret-key\"\n</code></pre>"},{"location":"artifact/#storage-path-structure","title":"Storage Path Structure","text":"<p>The artifact system organizes files using the following path structure:</p> <ul> <li>Session-scoped: <code>{app_name}/{user_id}/{session_id}/{filename}/{version}</code></li> <li>User-persistent: <code>{app_name}/{user_id}/user/{filename}/{version}</code></li> </ul> <p>This structure ensures proper isolation between applications, users, and sessions while maintaining version history.</p>"},{"location":"callbacks/","title":"Callbacks","text":""},{"location":"callbacks/#callbacks","title":"Callbacks","text":"<p>Version Requirement The structured callback API (recommended) requires trpc-agent-go &gt;= 0.6.0.</p> <p>This page describes the callback system used across the project to intercept, observe, and customize model inference, tool invocation, and agent execution.</p> <p>The callback system comes in three categories:</p> <ul> <li>ModelCallbacks</li> <li>ToolCallbacks</li> <li>AgentCallbacks</li> </ul> <p>Each category provides a Before and an After callback. A Before callback can short-circuit the default execution by returning a non-nil custom response.</p>"},{"location":"callbacks/#modelcallbacks","title":"ModelCallbacks","text":""},{"location":"callbacks/#structured-model-callbacks-recommended","title":"Structured Model Callbacks (Recommended)","text":"<ul> <li>BeforeModelCallbackStructured: Runs before a model inference with structured arguments.</li> <li>AfterModelCallbackStructured: Runs after the model finishes with structured arguments.</li> </ul> <p>Arguments:</p> <pre><code>type BeforeModelArgs struct {\n    Request *model.Request  // The request about to be sent (can be modified)\n}\n\ntype BeforeModelResult struct {\n    Context        context.Context  // Optional context for subsequent operations\n    CustomResponse *model.Response  // If non-nil, skips model call and returns this response\n}\n\ntype AfterModelArgs struct {\n    Request  *model.Request   // The original request sent to the model\n    Response *model.Response  // The response from the model (may be nil)\n    Error    error            // Any error that occurred during model call\n}\n\ntype AfterModelResult struct {\n    Context        context.Context  // Optional context for subsequent operations\n    CustomResponse *model.Response  // If non-nil, replaces the original response\n}\n</code></pre> <p>Signatures:</p> <pre><code>type BeforeModelCallbackStructured func(ctx context.Context, args *model.BeforeModelArgs) (*model.BeforeModelResult, error)\ntype AfterModelCallbackStructured  func(ctx context.Context, args *model.AfterModelArgs) (*model.AfterModelResult, error)\n</code></pre> <p>Key points:</p> <ul> <li>Structured parameters provide better type safety and clearer intent.</li> <li><code>BeforeModelResult.Context</code> can be used to pass context to subsequent operations.</li> <li><code>AfterModelResult.Context</code> allows passing context between callbacks.</li> <li>Before can return a non-nil response to skip the model call.</li> <li>After receives the original request, useful for content restoration and post-processing.</li> </ul>"},{"location":"callbacks/#callback-execution-control","title":"Callback Execution Control","text":"<p>By default, callback execution stops immediately when:</p> <ul> <li>A callback returns an error</li> <li>A callback returns a non-nil <code>CustomResponse</code> (for Before callbacks) or <code>CustomResult</code> (for Tool callbacks)</li> </ul> <p>You can control this behavior using options when creating callbacks:</p> <pre><code>// Continue executing remaining callbacks even if an error occurs\nmodelCallbacks := model.NewCallbacks(\n    model.WithContinueOnError(true),\n)\n\n// Continue executing remaining callbacks even if a CustomResponse is returned\nmodelCallbacks := model.NewCallbacks(\n    model.WithContinueOnResponse(true),\n)\n\n// Enable both options: continue on both error and CustomResponse\nmodelCallbacks := model.NewCallbacks(\n    model.WithContinueOnError(true),\n    model.WithContinueOnResponse(true),\n)\n</code></pre> <p>Execution Modes:</p> <ol> <li>Default (both false): Stop on first error or CustomResponse</li> <li>Continue on Error: Continue executing remaining callbacks even if one returns an error</li> <li>Continue on Response: Continue executing remaining callbacks even if one returns a CustomResponse</li> <li>Continue on Both: Continue executing all callbacks regardless of errors or CustomResponse</li> </ol> <p>Priority Rules:</p> <ul> <li>If both an error and a CustomResponse occur, the error takes priority and will be returned (unless <code>continueOnError</code> is true)</li> <li>When <code>continueOnError</code> is true and an error occurs, execution continues but the first error is preserved and returned at the end</li> <li>When <code>continueOnResponse</code> is true and a CustomResponse is returned, execution continues but the last CustomResponse is used</li> </ul> <p>Example:</p> <pre><code>modelCallbacks := model.NewCallbacks().\n  // Before: respond to a special prompt to skip the real model call.\n  RegisterBeforeModel(func(ctx context.Context, args *model.BeforeModelArgs) (*model.BeforeModelResult, error) {\n    if len(args.Request.Messages) &gt; 0 &amp;&amp; strings.Contains(args.Request.Messages[len(args.Request.Messages)-1].Content, \"/ping\") {\n      return &amp;model.BeforeModelResult{\n        CustomResponse: &amp;model.Response{Choices: []model.Choice{{Message: model.Message{Role: model.RoleAssistant, Content: \"pong\"}}}},\n      }, nil\n    }\n    return nil, nil\n  }).\n  // After: annotate successful responses, keep errors untouched.\n  RegisterAfterModel(func(ctx context.Context, args *model.AfterModelArgs) (*model.AfterModelResult, error) {\n    if args.Error != nil {\n      return nil, args.Error\n    }\n    if args.Response != nil &amp;&amp; len(args.Response.Choices) &gt; 0 {\n      args.Response.Choices[0].Message.Content += \"\\n\\n-- answered by callback\"\n      return &amp;model.AfterModelResult{CustomResponse: args.Response}, nil\n    }\n    return nil, nil\n  })\n</code></pre> <p>Usage: After creating callbacks, pass them to the LLM Agent when creating it using the <code>llmagent.WithModelCallbacks()</code> option:</p> <pre><code>// Create model callbacks\nmodelCallbacks := model.NewCallbacks().\n  RegisterBeforeModel(...).\n  RegisterAfterModel(...)\n\n// Create LLM Agent and pass model callbacks\nllmAgent := llmagent.New(\n  \"chat-assistant\",\n  llmagent.WithModel(modelInstance),\n  llmagent.WithModelCallbacks(modelCallbacks),  // Pass model callbacks\n)\n</code></pre> <p>For a complete example, see <code>examples/callbacks/main.go</code>.</p>"},{"location":"callbacks/#legacy-model-callbacks-deprecated","title":"Legacy Model Callbacks (Deprecated)","text":"<p>\u26a0\ufe0f Deprecated Legacy callbacks are deprecated. Use structured callbacks for new code.</p>"},{"location":"callbacks/#toolcallbacks","title":"ToolCallbacks","text":""},{"location":"callbacks/#structured-tool-callbacks-recommended","title":"Structured Tool Callbacks (Recommended)","text":"<ul> <li>BeforeToolCallbackStructured: Runs before each tool invocation with structured arguments.</li> <li>AfterToolCallbackStructured: Runs after each tool invocation with structured arguments.</li> </ul> <p>Arguments:</p> <pre><code>type BeforeToolArgs struct {\n    ToolName     string               // The name of the tool\n    Declaration  *tool.Declaration    // Tool declaration metadata\n    Arguments    []byte               // JSON arguments (can be modified)\n}\n\ntype BeforeToolResult struct {\n    Context       context.Context     // Optional context for subsequent operations\n    CustomResult  any                 // If non-nil, skips tool execution and returns this result\n    ModifiedArguments []byte          // Optional modified arguments for tool execution\n}\n\ntype AfterToolArgs struct {\n    ToolName     string               // The name of the tool\n    Declaration  *tool.Declaration    // Tool declaration metadata\n    Arguments    []byte               // Original JSON arguments\n    Result       any                  // Result from tool execution (may be nil)\n    Error        error                // Any error that occurred during tool execution\n}\n\ntype AfterToolResult struct {\n    Context       context.Context     // Optional context for subsequent operations\n    CustomResult  any                 // If non-nil, replaces the original result\n}\n</code></pre> <p>Signatures:</p> <pre><code>type BeforeToolCallbackStructured func(ctx context.Context, args *tool.BeforeToolArgs) (*tool.BeforeToolResult, error)\ntype AfterToolCallbackStructured  func(ctx context.Context, args *tool.AfterToolArgs) (*tool.AfterToolResult, error)\n</code></pre> <p>Key points:</p> <ul> <li>Structured parameters provide better type safety and clearer intent.</li> <li><code>BeforeToolResult.ModifiedArguments</code> allows modifying tool arguments.</li> <li><code>BeforeToolResult.Context</code> and <code>AfterToolResult.Context</code> can pass context between operations.</li> <li>Arguments can be modified directly via <code>args.Arguments</code>.</li> <li>If BeforeToolCallbackStructured returns a non-nil custom result, the tool is skipped and that result is used directly.</li> </ul>"},{"location":"callbacks/#callback-execution-control_1","title":"Callback Execution Control","text":"<p>By default, callback execution stops immediately when:</p> <ul> <li>A callback returns an error</li> <li>A callback returns a non-nil <code>CustomResult</code></li> </ul> <p>You can control this behavior using options when creating callbacks:</p> <pre><code>// Continue executing remaining callbacks even if an error occurs\ntoolCallbacks := tool.NewCallbacks(\n    tool.WithContinueOnError(true),\n)\n\n// Continue executing remaining callbacks even if a CustomResult is returned\ntoolCallbacks := tool.NewCallbacks(\n    tool.WithContinueOnResponse(true),\n)\n\n// Enable both options: continue on both error and CustomResult\ntoolCallbacks := tool.NewCallbacks(\n    tool.WithContinueOnError(true),\n    tool.WithContinueOnResponse(true),\n)\n</code></pre> <p>Execution Modes:</p> <ol> <li>Default (both false): Stop on first error or CustomResult</li> <li>Continue on Error: Continue executing remaining callbacks even if one returns an error</li> <li>Continue on Response: Continue executing remaining callbacks even if one returns a CustomResult</li> <li>Continue on Both: Continue executing all callbacks regardless of errors or CustomResult</li> </ol> <p>Priority Rules:</p> <ul> <li>If both an error and a CustomResult occur, the error takes priority and will be returned (unless <code>continueOnError</code> is true)</li> <li>When <code>continueOnError</code> is true and an error occurs, execution continues but the first error is preserved and returned at the end</li> <li>When <code>continueOnResponse</code> is true and a CustomResult is returned, execution continues but the last CustomResult is used</li> </ul> <p>Example:</p> <pre><code>toolCallbacks := tool.NewCallbacks().\n  RegisterBeforeTool(func(ctx context.Context, args *tool.BeforeToolArgs) (*tool.BeforeToolResult, error) {\n    if args.Arguments != nil &amp;&amp; args.ToolName == \"calculator\" {\n      // Enrich arguments.\n      original := string(args.Arguments)\n      enriched := []byte(fmt.Sprintf(`{\"original\":%s,\"ts\":%d}`, original, time.Now().Unix()))\n      args.Arguments = enriched\n    }\n    return nil, nil\n  }).\n  RegisterAfterTool(func(ctx context.Context, args *tool.AfterToolArgs) (*tool.AfterToolResult, error) {\n    if args.Error != nil {\n      return nil, args.Error\n    }\n    if s, ok := args.Result.(string); ok {\n      return &amp;tool.AfterToolResult{\n        CustomResult: s + \"\\n-- post processed by tool callback\",\n      }, nil\n    }\n    return nil, nil\n  })\n</code></pre> <p>Usage: After creating callbacks, pass them to the LLM Agent when creating it using the <code>llmagent.WithToolCallbacks()</code> option:</p> <pre><code>// Create tool callbacks\ntoolCallbacks := tool.NewCallbacks().\n  RegisterBeforeTool(...).\n  RegisterAfterTool(...)\n\n// Create LLM Agent and pass tool callbacks\nllmAgent := llmagent.New(\n  \"chat-assistant\",\n  llmagent.WithModel(modelInstance),\n  llmagent.WithTools(tools),\n  llmagent.WithToolCallbacks(toolCallbacks),  // Pass tool callbacks\n)\n</code></pre> <p>For a complete example, see <code>examples/callbacks/main.go</code>.</p> <p>Telemetry and events:</p> <ul> <li>Modified arguments are propagated to:<ul> <li><code>TraceToolCall</code> telemetry attributes.</li> <li>Graph events emitted by <code>emitToolStartEvent</code> and <code>emitToolCompleteEvent</code>.</li> </ul> </li> </ul>"},{"location":"callbacks/#legacy-tool-callbacks-deprecated","title":"Legacy Tool Callbacks (Deprecated)","text":"<p>\u26a0\ufe0f Deprecated Legacy callbacks are deprecated. Use structured callbacks for new code.</p>"},{"location":"callbacks/#agentcallbacks","title":"AgentCallbacks","text":""},{"location":"callbacks/#structured-agent-callbacks-recommended","title":"Structured Agent Callbacks (Recommended)","text":"<ul> <li>BeforeAgentCallbackStructured: Runs before agent execution with structured arguments.</li> <li>AfterAgentCallbackStructured: Runs after agent execution with structured arguments.</li> </ul> <p>Arguments:</p> <pre><code>type BeforeAgentArgs struct {\n    Invocation *agent.Invocation  // The invocation context\n}\n\ntype BeforeAgentResult struct {\n    Context        context.Context  // Optional context for subsequent operations\n    CustomResponse *model.Response  // If non-nil, skips agent execution and returns this response\n}\n\ntype AfterAgentArgs struct {\n    Invocation        *agent.Invocation  // The invocation context\n    FullResponseEvent *event.Event       // The final response event from agent execution (may be nil)\n    Error             error              // Any error that occurred during agent execution (may be nil)\n}\n\ntype AfterAgentResult struct {\n    Context        context.Context  // Optional context for subsequent operations\n    CustomResponse *model.Response  // If non-nil, replaces the original response\n}\n</code></pre> <p>Signatures:</p> <pre><code>type BeforeAgentCallbackStructured func(ctx context.Context, args *agent.BeforeAgentArgs) (*agent.BeforeAgentResult, error)\ntype AfterAgentCallbackStructured  func(ctx context.Context, args *agent.AfterAgentArgs) (*agent.AfterAgentResult, error)\n</code></pre> <p>Key points:</p> <ul> <li>Structured parameters provide better type safety and clearer intent.</li> <li><code>BeforeAgentResult.Context</code> and <code>AfterAgentResult.Context</code> can pass context between operations.</li> <li>Access to full invocation context allows for rich per-invocation logic.</li> <li>Before can short-circuit with a custom model.Response.</li> <li>After can return a replacement response.</li> <li><code>AfterAgentArgs.FullResponseEvent</code> provides access to the final response event from agent execution, useful for logging, monitoring, post-processing, etc.</li> </ul>"},{"location":"callbacks/#callback-execution-control_2","title":"Callback Execution Control","text":"<p>By default, callback execution stops immediately when:</p> <ul> <li>A callback returns an error</li> <li>A callback returns a non-nil <code>CustomResponse</code></li> </ul> <p>You can control this behavior using options when creating callbacks:</p> <pre><code>// Continue executing remaining callbacks even if an error occurs\nagentCallbacks := agent.NewCallbacks(\n    agent.WithContinueOnError(true),\n)\n\n// Continue executing remaining callbacks even if a CustomResponse is returned\nagentCallbacks := agent.NewCallbacks(\n    agent.WithContinueOnResponse(true),\n)\n\n// Enable both options: continue on both error and CustomResponse\nagentCallbacks := agent.NewCallbacks(\n    agent.WithContinueOnError(true),\n    agent.WithContinueOnResponse(true),\n)\n</code></pre> <p>Execution Modes:</p> <ol> <li>Default (both false): Stop on first error or CustomResponse</li> <li>Continue on Error: Continue executing remaining callbacks even if one returns an error</li> <li>Continue on Response: Continue executing remaining callbacks even if one returns a CustomResponse</li> <li>Continue on Both: Continue executing all callbacks regardless of errors or CustomResponse</li> </ol> <p>Priority Rules:</p> <ul> <li>If both an error and a CustomResponse occur, the error takes priority and will be returned (unless <code>continueOnError</code> is true)</li> <li>When <code>continueOnError</code> is true and an error occurs, execution continues but the first error is preserved and returned at the end</li> <li>When <code>continueOnResponse</code> is true and a CustomResponse is returned, execution continues but the last CustomResponse is used</li> </ul> <p>Example:</p> <pre><code>agentCallbacks := agent.NewCallbacks().\n  // Before: if the user message contains /abort, return a fixed response and skip the rest.\n  RegisterBeforeAgent(func(ctx context.Context, args *agent.BeforeAgentArgs) (*agent.BeforeAgentResult, error) {\n    if args.Invocation != nil &amp;&amp; strings.Contains(args.Invocation.GetUserMessageContent(), \"/abort\") {\n      return &amp;agent.BeforeAgentResult{\n        CustomResponse: &amp;model.Response{Choices: []model.Choice{{Message: model.Message{Role: model.RoleAssistant, Content: \"aborted by callback\"}}}},\n      }, nil\n    }\n    return nil, nil\n  }).\n  // After: append a footer to successful responses, can access FullResponseEvent for final response event.\n  RegisterAfterAgent(func(ctx context.Context, args *agent.AfterAgentArgs) (*agent.AfterAgentResult, error) {\n    if args.Error != nil {\n      return nil, args.Error\n    }\n    // Can access the final response event from agent execution via FullResponseEvent.\n    if args.FullResponseEvent != nil &amp;&amp; args.FullResponseEvent.Response != nil {\n      if len(args.FullResponseEvent.Response.Choices) &gt; 0 {\n        c := args.FullResponseEvent.Response.Choices[0]\n        c.Message.Content = c.Message.Content + \"\\n\\n-- handled by agent callback\"\n        args.FullResponseEvent.Response.Choices[0] = c\n        return &amp;agent.AfterAgentResult{CustomResponse: args.FullResponseEvent.Response}, nil\n      }\n    }\n    return nil, nil\n  })\n</code></pre> <p>Usage: After creating callbacks, pass them to the LLM Agent when creating it using the <code>llmagent.WithAgentCallbacks()</code> option:</p> <pre><code>// Create agent callbacks\nagentCallbacks := agent.NewCallbacks().\n  RegisterBeforeAgent(...).\n  RegisterAfterAgent(...)\n\n// Create LLM Agent and pass agent callbacks\nllmAgent := llmagent.New(\n  \"chat-assistant\",\n  llmagent.WithModel(modelInstance),\n  llmagent.WithAgentCallbacks(agentCallbacks),  // Pass agent callbacks\n)\n</code></pre>"},{"location":"callbacks/#stop-agent-via-callbacks-stop-agent-via-callbacks","title":"Stop agent via callbacks {#stop-agent-via-callbacks}","text":"<p>Use <code>agent.NewStopError</code> in callbacks when you need to halt execution and emit <code>stop_agent_error</code> to the runner stream. This is useful for quota checks, guard rails, or manual aborts.</p> <pre><code>agentCallbacks := agent.NewCallbacks().\n  RegisterBeforeAgent(func(ctx context.Context, args *agent.BeforeAgentArgs) (*agent.BeforeAgentResult, error) {\n    if args.Invocation != nil &amp;&amp; args.Invocation.TokenUsage.Total &gt;= maxTokens {\n      return nil, agent.NewStopError(\"token limit reached\")\n    }\n    return nil, nil\n  }).\n  RegisterAfterAgent(func(ctx context.Context, args *agent.AfterAgentArgs) (*agent.AfterAgentResult, error) {\n    if args.Error != nil {\n      return nil, args.Error\n    }\n    if args.FullResponseEvent != nil &amp;&amp; args.FullResponseEvent.Response != nil &amp;&amp;\n      args.FullResponseEvent.Response.Usage.TotalTokens &gt;= maxTokens {\n      return nil, agent.NewStopError(\"token limit reached after response\")\n    }\n    return nil, nil\n  })\n</code></pre> <p>Notes:</p> <ul> <li>The flow turns the <code>StopError</code> into a <code>stop_agent_error</code> event and stops the loop. Downstream consumers can detect   <code>event.Error.Type == agent.ErrorTypeStopAgentError</code>.</li> <li>Pair with context cancellation when you need a hard cutoff that also stops in-flight model calls or tool executions;   see the runner docs for context cancellation patterns.</li> </ul> <p>For a complete example, see <code>examples/callbacks/main.go</code>.</p>"},{"location":"callbacks/#legacy-agent-callbacks-deprecated","title":"Legacy Agent Callbacks (Deprecated)","text":"<p>\u26a0\ufe0f Deprecated Legacy callbacks are deprecated. Use structured callbacks for new code.</p>"},{"location":"callbacks/#access-invocation-in-callbacks","title":"Access Invocation in Callbacks","text":"<p>Callbacks can access the current agent invocation via context to correlate events, add tracing, or implement per-invocation logic.</p> <pre><code>if inv, ok := agent.InvocationFromContext(ctx); ok &amp;&amp; inv != nil {\n  fmt.Printf(\"invocation id=%s, agent=%s\\n\", inv.InvocationID, inv.AgentName)\n}\n</code></pre> <p>This pattern is showcased in the examples where Before/After callbacks print the presence of an invocation.</p>"},{"location":"callbacks/#invocation-state-sharing-data-between-callbacks","title":"Invocation State: Sharing Data Between Callbacks","text":"<p><code>Invocation</code> provides a general-purpose <code>State</code> mechanism for storing invocation-scoped data. It can be used not only for sharing data between Before and After callbacks, but also for middleware, custom logic, and any invocation-level state management.</p>"},{"location":"callbacks/#core-methods","title":"Core Methods","text":"<pre><code>// Set a state value.\nfunc (inv *Invocation) SetState(key string, value any)\n\n// Get a state value, returns value and existence flag.\nfunc (inv *Invocation) GetState(key string) (any, bool)\n\n// Delete a state value.\nfunc (inv *Invocation) DeleteState(key string)\n</code></pre>"},{"location":"callbacks/#features","title":"Features","text":"<ul> <li>Invocation-scoped: State is automatically scoped to a single invocation</li> <li>Thread-safe: Built-in RWMutex protection for concurrent access</li> <li>Lazy initialization: Memory allocated only on first use</li> <li>Clean lifecycle: Explicit deletion prevents memory leaks</li> <li>General-purpose: Not limited to callbacks, can be used for any invocation-level state</li> </ul>"},{"location":"callbacks/#naming-convention","title":"Naming Convention","text":"<p>To avoid key conflicts between different use cases, use prefixes:</p> <ul> <li>Agent callbacks: <code>\"agent:xxx\"</code> (e.g., <code>\"agent:start_time\"</code>)</li> <li>Model callbacks: <code>\"model:xxx\"</code> (e.g., <code>\"model:start_time\"</code>)</li> <li>Tool callbacks: <code>\"tool:&lt;toolName&gt;:&lt;toolCallID&gt;:xxx\"</code> (e.g., <code>\"tool:calculator:call_abc123:start_time\"</code>)<ul> <li>Note: Tool callbacks should include tool call ID to support concurrent calls</li> </ul> </li> <li>Middleware: <code>\"middleware:xxx\"</code> (e.g., <code>\"middleware:request_id\"</code>)</li> <li>Custom logic: <code>\"custom:xxx\"</code> (e.g., <code>\"custom:user_context\"</code>)</li> </ul>"},{"location":"callbacks/#example-agent-callback-timing","title":"Example: Agent Callback Timing","text":"<pre><code>agentCallbacks := agent.NewCallbacks().\n  // BeforeAgentCallback: Record start time.\n  RegisterBeforeAgent(func(ctx context.Context, args *agent.BeforeAgentArgs) (*agent.BeforeAgentResult, error) {\n    args.Invocation.SetState(\"agent:start_time\", time.Now())\n    return nil, nil\n  }).\n  // AfterAgentCallback: Calculate execution duration.\n  RegisterAfterAgent(func(ctx context.Context, args *agent.AfterAgentArgs) (*agent.AfterAgentResult, error) {\n    if startTimeVal, ok := args.Invocation.GetState(\"agent:start_time\"); ok {\n      startTime := startTimeVal.(time.Time)\n      duration := time.Since(startTime)\n      fmt.Printf(\"Agent execution took: %v\\n\", duration)\n      args.Invocation.DeleteState(\"agent:start_time\") // Clean up state.\n    }\n    return nil, nil\n  })\n</code></pre>"},{"location":"callbacks/#example-model-callback-timing","title":"Example: Model Callback Timing","text":"<p>Model and Tool callbacks need to retrieve the Invocation from context first:</p> <pre><code>modelCallbacks := model.NewCallbacks().\n  // BeforeModelCallback: Record start time.\n  RegisterBeforeModel(func(ctx context.Context, args *model.BeforeModelArgs) (*model.BeforeModelResult, error) {\n    if inv, ok := agent.InvocationFromContext(ctx); ok &amp;&amp; inv != nil {\n      inv.SetState(\"model:start_time\", time.Now())\n    }\n    return nil, nil\n  }).\n  // AfterModelCallback: Calculate execution duration.\n  RegisterAfterModel(func(ctx context.Context, args *model.AfterModelArgs) (*model.AfterModelResult, error) {\n    if inv, ok := agent.InvocationFromContext(ctx); ok &amp;&amp; inv != nil {\n      if startTimeVal, ok := inv.GetState(\"model:start_time\"); ok {\n        startTime := startTimeVal.(time.Time)\n        duration := time.Since(startTime)\n        fmt.Printf(\"Model inference took: %v\\n\", duration)\n        inv.DeleteState(\"model:start_time\") // Clean up state.\n      }\n    }\n    return nil, nil\n  })\n</code></pre>"},{"location":"callbacks/#example-tool-callback-timing-multi-tool-isolation","title":"Example: Tool Callback Timing (Multi-tool Isolation)","text":"<pre><code>toolCallbacks := tool.NewCallbacks().\n  // BeforeToolCallback: Record tool start time.\n  RegisterBeforeTool(func(ctx context.Context, args *tool.BeforeToolArgs) (*tool.BeforeToolResult, error) {\n    if inv, ok := agent.InvocationFromContext(ctx); ok &amp;&amp; inv != nil {\n      // Get tool call ID for concurrent call support.\n      toolCallID, ok := tool.ToolCallIDFromContext(ctx)\n      if !ok || toolCallID == \"\" {\n        toolCallID = \"default\" // Fallback for compatibility.\n      }\n\n      // Use tool call ID to build unique key.\n      key := fmt.Sprintf(\"tool:%s:%s:start_time\", args.ToolName, toolCallID)\n      inv.SetState(key, time.Now())\n    }\n    return nil, nil\n  }).\n  // AfterToolCallback: Calculate tool execution duration.\n  RegisterAfterTool(func(ctx context.Context, args *tool.AfterToolArgs) (*tool.AfterToolResult, error) {\n    if inv, ok := agent.InvocationFromContext(ctx); ok &amp;&amp; inv != nil {\n      // Get tool call ID for concurrent call support.\n      toolCallID, ok := tool.ToolCallIDFromContext(ctx)\n      if !ok || toolCallID == \"\" {\n        toolCallID = \"default\" // Fallback for compatibility.\n      }\n\n      key := fmt.Sprintf(\"tool:%s:%s:start_time\", args.ToolName, toolCallID)\n      if startTimeVal, ok := inv.GetState(key); ok {\n        startTime := startTimeVal.(time.Time)\n        duration := time.Since(startTime)\n        fmt.Printf(\"Tool %s (call %s) took: %v\\n\", args.ToolName, toolCallID, duration)\n        inv.DeleteState(key) // Clean up state.\n      }\n    }\n    return nil, nil\n  })\n</code></pre> <p>Key Points:</p> <ol> <li>Get tool call ID: Use <code>tool.ToolCallIDFromContext(ctx)</code> to retrieve the unique ID for each tool call from context</li> <li>Key format: <code>\"tool:&lt;toolName&gt;:&lt;toolCallID&gt;:&lt;key&gt;\"</code> ensures state isolation for concurrent calls</li> <li>Fallback handling: If tool call ID is not available (older versions or special scenarios), use <code>\"default\"</code> as fallback</li> <li>Consistency: Before and After callbacks must use the same logic to retrieve tool call ID</li> </ol> <p>This ensures that when the LLM calls <code>calculator</code> multiple times concurrently (e.g., <code>calculator(1,2)</code> and <code>calculator(3,4)</code>), each call has its own independent timing data.</p>"},{"location":"callbacks/#complete-example","title":"Complete Example","text":"<p>For a complete timing example with OpenTelemetry integration, see: examples/callbacks/timer</p> <p>For an authentication and authorization example using Invocation State for permission checks and audit logging, see: examples/callbacks/auth</p>"},{"location":"callbacks/#global-callbacks-and-chain-registration","title":"Global Callbacks and Chain Registration","text":"<p>You can define reusable global callbacks using chain registration.</p> <pre><code>_ = model.NewCallbacks().\n  RegisterBeforeModel(func(ctx context.Context, args *model.BeforeModelArgs) (*model.BeforeModelResult, error) {\n    fmt.Printf(\"Global BeforeModel: %d messages.\\n\", len(args.Request.Messages))\n    return nil, nil\n  }).\n  RegisterAfterModel(func(ctx context.Context, args *model.AfterModelArgs) (*model.AfterModelResult, error) {\n    fmt.Println(\"Global AfterModel: completed.\")\n    return nil, nil\n  })\n\n_ = tool.NewCallbacks().\n  RegisterBeforeTool(func(ctx context.Context, args *tool.BeforeToolArgs) (*tool.BeforeToolResult, error) {\n    fmt.Printf(\"Global BeforeTool: %s.\\n\", args.ToolName)\n    return nil, nil\n  }).\n  RegisterAfterTool(func(ctx context.Context, args *tool.AfterToolArgs) (*tool.AfterToolResult, error) {\n    fmt.Printf(\"Global AfterTool: %s done.\\n\", args.ToolName)\n    return nil, nil\n  })\n\n_ = agent.NewCallbacks().\n  RegisterBeforeAgent(func(ctx context.Context, args *agent.BeforeAgentArgs) (*agent.BeforeAgentResult, error) {\n    fmt.Printf(\"Global BeforeAgent: %s.\\n\", args.Invocation.AgentName)\n    return nil, nil\n  }).\n  RegisterAfterAgent(func(ctx context.Context, args *agent.AfterAgentArgs) (*agent.AfterAgentResult, error) {\n    fmt.Println(\"Global AfterAgent: completed.\")\n    return nil, nil\n  })\n</code></pre>"},{"location":"callbacks/#mocking-and-argument-mutation-examples","title":"Mocking and Argument Mutation Examples","text":"<p>Mock a tool result and short-circuit execution:</p> <pre><code>toolCallbacks := tool.NewCallbacks().\n  RegisterBeforeTool(func(ctx context.Context, args *tool.BeforeToolArgs) (*tool.BeforeToolResult, error) {\n    if args.ToolName == \"calculator\" &amp;&amp; args.Arguments != nil &amp;&amp; strings.Contains(string(args.Arguments), \"42\") {\n      return &amp;tool.BeforeToolResult{\n        CustomResult: calculatorResult{Operation: \"custom\", A: 42, B: 42, Result: 4242},\n      }, nil\n    }\n    return nil, nil\n  })\n</code></pre> <p>Modify arguments prior to execution (and telemetry/event reporting):</p> <pre><code>toolCallbacks := tool.NewCallbacks().\n  RegisterBeforeTool(func(ctx context.Context, args *tool.BeforeToolArgs) (*tool.BeforeToolResult, error) {\n    if args.Arguments != nil &amp;&amp; args.ToolName == \"calculator\" {\n      originalArgs := string(args.Arguments)\n      modifiedArgs := fmt.Sprintf(`{\"original\":%s,\"timestamp\":\"%d\"}`, originalArgs, time.Now().Unix())\n      args.Arguments = []byte(modifiedArgs)\n    }\n    return nil, nil\n  })\n</code></pre> <p>Both examples mirror the runnable demo under examples/callbacks.</p>"},{"location":"callbacks/#running-the-callbacks-example","title":"Running the Callbacks Example","text":"<pre><code>cd examples/callbacks\nexport OPENAI_API_KEY=\"your-api-key\"\n\n# Basic\ngo run .\n\n# Choose model\ngo run . -model gpt-4o-mini\n\n# Disable streaming\ngo run . -streaming=false\n</code></pre> <p>Observe logs for Before/After callbacks, argument mutation messages, and tool responses.</p>"},{"location":"custom-agent/","title":"Custom Agent","text":"<p>If you don\u2019t want to start with Graph or multi-Agent orchestration and prefer embedding LLM into your existing service logic, implement the <code>agent.Agent</code> interface directly and control the flow yourself.</p> <p>This example shows a small \u201cintent branching\u201d agent:</p> <ul> <li>First classify intent using the LLM: <code>chitchat</code> or <code>task</code></li> <li>If chitchat: reply conversationally</li> <li>If task: output a short actionable plan (in real apps, you can route to tools or downstream services)</li> </ul>"},{"location":"custom-agent/#when-to-choose-a-custom-agent","title":"When to choose a custom Agent","text":"<ul> <li>Logic is simple but you need precise control (validation, fallbacks, branching)</li> <li>You don\u2019t need visual orchestration or complex teams yet (you can later evolve to Chain/Parallel/Graph)</li> </ul>"},{"location":"custom-agent/#what-to-implement","title":"What to implement","text":"<p>You must implement:</p> <ul> <li><code>Run(ctx, *Invocation) (&lt;-chan *event.Event, error)</code>: execute your flow and emit events (forward model streaming to events)</li> <li><code>Tools() []tool.Tool</code>: return available tools (empty if none)</li> <li><code>Info() Info</code>: basic agent info</li> <li><code>SubAgents()/FindSubAgent()</code>: return empty/nil if not used</li> </ul> <p>Core pattern:</p> <p>1) Use <code>invocation.Message</code> as user input</p> <p>2) Share framework capabilities via <code>invocation</code> (Session, Callbacks, Artifact, etc.)</p> <p>3) Call <code>model.Model.GenerateContent(ctx, *model.Request)</code> for streaming responses; forward via <code>event.NewResponseEvent(...)</code></p>"},{"location":"custom-agent/#code-example","title":"Code example","text":"<p>Full example: <code>examples/customagent</code></p> <p>Key snippet (simplified):</p> <pre><code>type SimpleIntentAgent struct {\n    name        string\n    description string\n    model       model.Model\n}\n\nfunc (a *SimpleIntentAgent) Run(ctx context.Context, inv *agent.Invocation) (&lt;-chan *event.Event, error) {\n    out := make(chan *event.Event, 64)\n    go func() {\n        defer close(out)\n        intent := a.classifyIntent(ctx, inv) // chitchat | task\n        if intent == \"task\" {\n            a.replyTaskPlan(ctx, inv, out)\n        } else {\n            a.replyChitChat(ctx, inv, out)\n        }\n    }()\n    return out, nil\n}\n\nfunc (a *SimpleIntentAgent) replyChitChat(ctx context.Context, inv *agent.Invocation, out chan&lt;- *event.Event) {\n    req := &amp;model.Request{\n        Messages: []model.Message{\n            model.NewSystemMessage(\"Be concise and friendly.\"),\n            inv.Message,\n        },\n        GenerationConfig: model.GenerationConfig{Stream: true},\n    }\n    rspCh, _ := a.model.GenerateContent(ctx, req)\n    for rsp := range rspCh {\n        out &lt;- event.NewResponseEvent(inv.InvocationID, a.name, rsp)\n    }\n}\n</code></pre>"},{"location":"custom-agent/#runner-integration","title":"Runner integration","text":"<p>While you can call Agent directly, we recommend running agents via <code>Runner</code> which manages session and appends events for you.</p> <p>Example:</p> <pre><code>// Build model and agent\nm := openai.New(\"deepseek-chat\")\nag := NewSimpleIntentAgent(\"biz-agent\", \"intent branching\", m)\n\n// Run with Runner\nr := runner.NewRunner(\"customagent-app\", ag)\nch, err := r.Run(ctx, \"user-001\", \"session-001\", model.NewUserMessage(\"Hi there\"))\n// consume events...\n</code></pre>"},{"location":"custom-agent/#run-the-example-interactive","title":"Run the example (interactive)","text":"<pre><code>cd examples/customagent\nexport OPENAI_API_KEY=\"your_api_key\"\ngo run . -model deepseek-chat\n\n# Inside the interactive session:\n# /history  - Ask to show conversation history\n# /new      - Start a new session\n# /exit     - Quit\n</code></pre>"},{"location":"custom-agent/#extensions","title":"Extensions","text":"<ul> <li>Add tools: return <code>[]tool.Tool</code> (e.g., <code>function.NewFunctionTool(...)</code>) to call DB/HTTP/internal services</li> <li>Add validation: enforce checks and guards before branching</li> <li>Evolve gradually: when if-else grows or you need collaboration, move to <code>ChainAgent</code>/<code>ParallelAgent</code> or <code>Graph</code></li> </ul>"},{"location":"dify/","title":"tRPC-Agent-Go Dify Integration Guide","text":""},{"location":"dify/#overview","title":"Overview","text":"<p>tRPC-Agent-Go provides complete integration with the Dify platform through the <code>DifyAgent</code> component. Developers can easily invoke Dify workflows and chatflows, seamlessly integrating Dify's powerful AI capabilities into tRPC-Agent-Go applications.</p>"},{"location":"dify/#what-is-dify","title":"What is Dify?","text":"<p>Dify is an open-source LLM application development platform that provides visual AI workflow orchestration, prompt engineering, RAG (Retrieval-Augmented Generation), and other enterprise-grade features. With Dify, you can quickly build and deploy complex AI applications.</p>"},{"location":"dify/#core-capabilities","title":"Core Capabilities","text":"<ul> <li>Unified Interface: Use Dify services like regular Agents without understanding Dify API details</li> <li>Protocol Conversion: Automatically handle conversion between tRPC-Agent-Go message formats and Dify API</li> <li>Streaming Support: Support both streaming and non-streaming response modes for real-time interaction</li> <li>State Transfer: Support transferring session state to Dify workflows</li> <li>Custom Extensions: Support custom request and response converters</li> </ul>"},{"location":"dify/#difyagent-calling-dify-services","title":"DifyAgent: Calling Dify Services","text":""},{"location":"dify/#concept-introduction","title":"Concept Introduction","text":"<p><code>DifyAgent</code> is a special Agent implementation provided by tRPC-Agent-Go that forwards requests to Dify platform workflows or chatflow services. From the user's perspective, <code>DifyAgent</code> looks like a regular Agent, but it's actually a local proxy for Dify services.</p> <p>Simple Understanding: - I have a Dify workflow/chatflow \u2192 Call it in tRPC-Agent-Go through DifyAgent - Use Dify's AI capabilities like a local Agent</p>"},{"location":"dify/#core-features","title":"Core Features","text":"<ul> <li>Transparent Proxy: Use Dify services like local Agents</li> <li>Automatic Protocol Conversion: Automatically handle message format conversion with Dify API</li> <li>Streaming Support: Support both streaming and non-streaming communication modes</li> <li>State Transfer: Support transferring session state to Dify workflows</li> <li>Custom Processing: Support custom streaming response handlers</li> <li>Flexible Configuration: Support custom Dify client configuration</li> </ul>"},{"location":"dify/#use-cases","title":"Use Cases","text":"<ol> <li>Enterprise AI Applications: Call internally deployed Dify services</li> <li>Workflow Orchestration: Use Dify's visual workflow capabilities for complex business logic</li> <li>RAG Applications: Build intelligent Q&amp;A systems using Dify's knowledge base and RAG capabilities</li> <li>Multi-Model Integration: Manage and call multiple LLM models uniformly through Dify</li> </ol>"},{"location":"dify/#quick-start","title":"Quick Start","text":""},{"location":"dify/#prerequisites","title":"Prerequisites","text":"<ol> <li> <p>Get Dify Service Information:</p> <ul> <li>Dify service URL (e.g., <code>https://api.dify.ai/v1</code>)</li> <li>API Secret (obtained from Dify application settings)</li> </ul> </li> <li> <p>Install Dependencies:    <pre><code>go get trpc.group/trpc-go/trpc-agent-go\ngo get github.com/cloudernative/dify-sdk-go\n</code></pre></p> </li> </ol>"},{"location":"dify/#basic-usage","title":"Basic Usage","text":""},{"location":"dify/#example-1-non-streaming-chat","title":"Example 1: Non-Streaming Chat","text":"<pre><code>package main\n\nimport (\n    \"context\"\n    \"fmt\"\n    \"log\"\n    \"time\"\n\n    \"github.com/cloudernative/dify-sdk-go\"\n    \"trpc.group/trpc-go/trpc-agent-go/agent\"\n    \"trpc.group/trpc-go/trpc-agent-go/agent/difyagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/model\"\n    \"trpc.group/trpc-go/trpc-agent-go/runner\"\n    \"trpc.group/trpc-go/trpc-agent-go/session/inmemory\"\n)\n\nfunc main() {\n    // 1. Create DifyAgent\n    difyAgent, err := difyagent.New(\n        difyagent.WithBaseUrl(\"https://api.dify.ai/v1\"),\n        difyagent.WithName(\"dify-chat-assistant\"),\n        difyagent.WithDescription(\"Dify intelligent assistant\"),\n        difyagent.WithEnableStreaming(false), // Non-streaming mode\n        difyagent.WithGetDifyClientFunc(func(invocation *agent.Invocation) (*dify.Client, error) {\n            return dify.NewClientWithConfig(&amp;dify.ClientConfig{\n                Host:             \"https://api.dify.ai/v1\",\n                DefaultAPISecret: \"your-api-secret\",\n                Timeout:          30 * time.Second,\n            }), nil\n        }),\n    )\n    if err != nil {\n        log.Fatal(err)\n    }\n\n    // 2. Create session service\n    sessionService := inmemory.NewSessionService()\n\n    // 3. Create Runner\n    chatRunner := runner.NewRunner(\n        \"dify-runner\",\n        difyAgent,\n        runner.WithSessionService(sessionService),\n    )\n\n    // 4. Send message\n    events, err := chatRunner.Run(\n        context.Background(),\n        \"user-1\",\n        \"session-1\",\n        model.NewUserMessage(\"Hello, please introduce yourself\"),\n    )\n    if err != nil {\n        log.Fatal(err)\n    }\n\n    // 5. Process response\n    for event := range events {\n        if event.Response != nil &amp;&amp; len(event.Response.Choices) &gt; 0 {\n            if event.Response.Done {\n                fmt.Println(event.Response.Choices[0].Message.Content)\n            }\n        }\n    }\n}\n</code></pre>"},{"location":"dify/#example-2-streaming-chat","title":"Example 2: Streaming Chat","text":"<pre><code>package main\n\nimport (\n    \"context\"\n    \"fmt\"\n    \"log\"\n    \"time\"\n\n    \"github.com/cloudernative/dify-sdk-go\"\n    \"trpc.group/trpc-go/trpc-agent-go/agent\"\n    \"trpc.group/trpc-go/trpc-agent-go/agent/difyagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/model\"\n    \"trpc.group/trpc-go/trpc-agent-go/runner\"\n    \"trpc.group/trpc-go/trpc-agent-go/session/inmemory\"\n)\n\nfunc main() {\n    // Custom streaming response handler\n    streamingHandler := func(resp *model.Response) (string, error) {\n        if len(resp.Choices) &gt; 0 {\n            content := resp.Choices[0].Delta.Content\n            if content != \"\" {\n                fmt.Print(content) // Real-time printing\n            }\n            return content, nil\n        }\n        return \"\", nil\n    }\n\n    // Create DifyAgent with streaming support\n    difyAgent, err := difyagent.New(\n        difyagent.WithBaseUrl(\"https://api.dify.ai/v1\"),\n        difyagent.WithName(\"dify-streaming-assistant\"),\n        difyagent.WithDescription(\"Dify streaming assistant\"),\n        difyagent.WithEnableStreaming(true), // Enable streaming\n        difyagent.WithStreamingRespHandler(streamingHandler),\n        difyagent.WithStreamingChannelBufSize(2048), // Streaming buffer size\n        difyagent.WithGetDifyClientFunc(func(invocation *agent.Invocation) (*dify.Client, error) {\n            return dify.NewClientWithConfig(&amp;dify.ClientConfig{\n                Host:             \"https://api.dify.ai/v1\",\n                DefaultAPISecret: \"your-api-secret\",\n                Timeout:          60 * time.Second,\n            }), nil\n        }),\n    )\n    if err != nil {\n        log.Fatal(err)\n    }\n\n    // Create session service and Runner\n    sessionService := inmemory.NewSessionService()\n    chatRunner := runner.NewRunner(\n        \"dify-streaming-runner\",\n        difyAgent,\n        runner.WithSessionService(sessionService),\n    )\n\n    // Send message\n    fmt.Print(\"\ud83e\udd16 Assistant: \")\n    events, err := chatRunner.Run(\n        context.Background(),\n        \"user-1\",\n        \"session-1\",\n        model.NewUserMessage(\"Please write a short story about a robot learning to paint\"),\n    )\n    if err != nil {\n        log.Fatal(err)\n    }\n\n    // Process streaming response\n    for event := range events {\n        if event.Error != nil {\n            log.Printf(\"Error: %s\", event.Error.Message)\n        }\n        // streamingHandler will automatically handle and print content\n    }\n    fmt.Println() // New line\n}\n</code></pre>"},{"location":"dify/#configuration-options","title":"Configuration Options","text":""},{"location":"dify/#basic-configuration","title":"Basic Configuration","text":"Option Description Required <code>WithBaseUrl(url)</code> Dify service URL No <code>WithName(name)</code> Agent name Yes <code>WithDescription(desc)</code> Agent description No"},{"location":"dify/#client-configuration","title":"Client Configuration","text":"Option Description Default <code>WithGetDifyClientFunc(fn)</code> Custom Dify client creation function Use default config"},{"location":"dify/#streaming-configuration","title":"Streaming Configuration","text":"Option Description Default <code>WithEnableStreaming(bool)</code> Enable streaming mode false <code>WithStreamingChannelBufSize(size)</code> Streaming buffer size 1024 <code>WithStreamingRespHandler(handler)</code> Custom streaming response handler Default handler"},{"location":"dify/#advanced-configuration","title":"Advanced Configuration","text":"Option Description <code>WithCustomEventConverter(converter)</code> Custom event converter <code>WithCustomRequestConverter(converter)</code> Custom request converter <code>WithTransferStateKey(keys...)</code> Set session state keys to transfer"},{"location":"dify/#advanced-usage","title":"Advanced Usage","text":""},{"location":"dify/#custom-state-transfer","title":"Custom State Transfer","text":"<p>Transfer session state to Dify workflows:</p> <pre><code>difyAgent, _ := difyagent.New(\n    difyagent.WithName(\"stateful-agent\"),\n    // Specify state keys to transfer\n    difyagent.WithTransferStateKey(\"user_profile\", \"conversation_context\"),\n    // ... other configs\n)\n\n// Set state in Runner\nrunner.Run(\n    ctx,\n    userID,\n    sessionID,\n    model.NewUserMessage(\"Check my orders\"),\n    // These states will be transferred to Dify\n    runner.WithRuntimeState(map[string]interface{}{\n        \"user_profile\": map[string]string{\n            \"name\": \"John\",\n            \"vip_level\": \"gold\",\n        },\n        \"conversation_context\": \"Discussing order issues\",\n    }),\n)\n</code></pre>"},{"location":"dify/#custom-response-processing","title":"Custom Response Processing","text":"<p>Implement custom streaming response handler:</p> <pre><code>// Custom handler: filter sensitive words, format output, etc.\ncustomHandler := func(resp *model.Response) (string, error) {\n    if len(resp.Choices) == 0 {\n        return \"\", nil\n    }\n\n    content := resp.Choices[0].Delta.Content\n\n    // 1. Filter sensitive words\n    filtered := filterSensitiveWords(content)\n\n    // 2. Real-time logging\n    log.Printf(\"Received chunk: %s\", filtered)\n\n    // 3. Real-time display\n    fmt.Print(filtered)\n\n    // Return processed content (will be aggregated to final response)\n    return filtered, nil\n}\n\ndifyAgent, _ := difyagent.New(\n    difyagent.WithStreamingRespHandler(customHandler),\n    // ... other configs\n)\n</code></pre>"},{"location":"dify/#custom-request-converter","title":"Custom Request Converter","text":"<p>Implement custom request conversion logic:</p> <pre><code>type MyRequestConverter struct{}\n\nfunc (c *MyRequestConverter) ConvertToDifyRequest(\n    ctx context.Context,\n    invocation *agent.Invocation,\n    isStream bool,\n) (*dify.ChatMessageRequest, error) {\n    // Custom request building logic\n    req := &amp;dify.ChatMessageRequest{\n        Query:           extractQuery(invocation),\n        ResponseMode:    getResponseMode(isStream),\n        ConversationID:  getConversationID(invocation),\n        User:            invocation.RunOptions.UserID,\n        Inputs:          customInputs(invocation),\n    }\n    return req, nil\n}\n\ndifyAgent, _ := difyagent.New(\n    difyagent.WithCustomRequestConverter(&amp;MyRequestConverter{}),\n    // ... other configs\n)\n</code></pre>"},{"location":"dify/#custom-event-converter","title":"Custom Event Converter","text":"<p>Implement custom response conversion logic:</p> <pre><code>type MyEventConverter struct{}\n\nfunc (c *MyEventConverter) ConvertToEvent(\n    resp *dify.ChatMessageResponse,\n    agentName string,\n    invocation *agent.Invocation,\n) *event.Event {\n    // Custom event conversion logic\n    return event.New(\n        invocation.InvocationID,\n        agentName,\n        event.WithResponse(&amp;model.Response{\n            Done: true,\n            Choices: []model.Choice{{\n                Message: model.Message{\n                    Role:    model.RoleAssistant,\n                    Content: customFormat(resp.Answer),\n                },\n            }},\n        }),\n    )\n}\n\nfunc (c *MyEventConverter) ConvertStreamingToEvent(\n    resp *dify.ChatMessageStreamResponse,\n    agentName string,\n    invocation *agent.Invocation,\n) *event.Event {\n    // Custom streaming event conversion logic\n    // ...\n}\n\ndifyAgent, _ := difyagent.New(\n    difyagent.WithCustomEventConverter(&amp;MyEventConverter{}),\n    // ... other configs\n)\n</code></pre>"},{"location":"dify/#environment-variable-configuration","title":"Environment Variable Configuration","text":"<p>Recommended to use environment variables for sensitive information:</p> <pre><code>export DIFY_BASE_URL=\"https://api.dify.ai/v1\"\nexport DIFY_API_SECRET=\"app-xxxxxxxxxx\"\n</code></pre> <p>Read in code:</p> <pre><code>import \"os\"\n\ndifyAgent, _ := difyagent.New(\n    difyagent.WithGetDifyClientFunc(func(invocation *agent.Invocation) (*dify.Client, error) {\n        return dify.NewClientWithConfig(&amp;dify.ClientConfig{\n            Host:             os.Getenv(\"DIFY_BASE_URL\"),\n            DefaultAPISecret: os.Getenv(\"DIFY_API_SECRET\"),\n            Timeout:          30 * time.Second,\n        }), nil\n    }),\n    // ... other configs\n)\n</code></pre>"},{"location":"dify/#error-handling","title":"Error Handling","text":""},{"location":"dify/#common-errors-and-solutions","title":"Common Errors and Solutions","text":"Error Cause Solution <code>agent name is required</code> Agent name not set Use <code>WithName()</code> to set name <code>request converter not set</code> Request converter not set Use default or custom converter <code>Dify request failed</code> Dify API call failed Check network, API Secret, service URL <code>event converter not set</code> Event converter not set Use default or custom converter"},{"location":"dify/#error-event-processing","title":"Error Event Processing","text":"<pre><code>for event := range events {\n    // Check for errors\n    if event.Error != nil {\n        log.Printf(\"Error: %s\", event.Error.Message)\n        continue\n    }\n\n    // Check response errors\n    if event.Response != nil &amp;&amp; event.Response.Error != nil {\n        log.Printf(\"Response Error: %s\", event.Response.Error.Message)\n        continue\n    }\n\n    // Normal processing\n    // ...\n}\n</code></pre>"},{"location":"dify/#best-practices","title":"Best Practices","text":""},{"location":"dify/#1-timeout-configuration","title":"1. Timeout Configuration","text":"<p>Set reasonable timeout based on Dify workflow complexity:</p> <pre><code>difyagent.WithGetDifyClientFunc(func(invocation *agent.Invocation) (*dify.Client, error) {\n    return dify.NewClientWithConfig(&amp;dify.ClientConfig{\n        Host:             baseURL,\n        DefaultAPISecret: apiSecret,\n        Timeout:          60 * time.Second, // Longer timeout for complex workflows\n    }), nil\n})\n</code></pre>"},{"location":"dify/#2-streaming-buffer-size","title":"2. Streaming Buffer Size","text":"<p>Adjust buffer based on expected response length:</p> <pre><code>// Short responses\ndifyagent.WithStreamingChannelBufSize(512)\n\n// Long responses (e.g., article generation)\ndifyagent.WithStreamingChannelBufSize(4096)\n</code></pre>"},{"location":"dify/#3-error-retry","title":"3. Error Retry","text":"<p>Implement retry mechanism in production:</p> <pre><code>func runWithRetry(runner *runner.Runner, maxRetries int) error {\n    for i := 0; i &lt; maxRetries; i++ {\n        events, err := runner.Run(ctx, userID, sessionID, msg)\n        if err == nil {\n            // Process events\n            return nil\n        }\n        log.Printf(\"Retry %d/%d: %v\", i+1, maxRetries, err)\n        time.Sleep(time.Second * time.Duration(i+1))\n    }\n    return fmt.Errorf(\"max retries exceeded\")\n}\n</code></pre>"},{"location":"dify/#4-session-management","title":"4. Session Management","text":"<p>Properly manage session IDs to maintain conversation context:</p> <pre><code>// Use unique session ID for each user conversation\nsessionID := fmt.Sprintf(\"user-%s-conv-%d\", userID, time.Now().Unix())\n\n// Or use persistent session ID for long-term conversations\nsessionID := getUserSessionID(userID)\n</code></pre>"},{"location":"dify/#example-code","title":"Example Code","text":"<p>Complete examples are located in the project's <code>examples/dify/</code> directory:</p> <ul> <li><code>basic_chat/</code>: Basic non-streaming chat example</li> <li><code>streaming_chat/</code>: Streaming chat example</li> <li><code>advanced_usage/</code>: Advanced usage examples (state transfer, custom converters, etc.)</li> </ul> <p>Run examples:</p> <pre><code>cd examples/dify/basic_chat\nexport DIFY_BASE_URL=\"https://api.dify.ai/v1\"\nexport DIFY_API_SECRET=\"your-api-secret\"\ngo run main.go\n</code></pre>"},{"location":"dify/#faq","title":"FAQ","text":"<p>Q: What's the difference between DifyAgent and A2AAgent?</p> <p>A:  - <code>DifyAgent</code>: Specifically for calling Dify platform services using Dify API - <code>A2AAgent</code>: For calling remote Agent services that comply with A2A protocol - Choice depends on backend service type</p> <p>Q: How to use self-hosted Dify in enterprise intranet?</p> <p>A: Simply set <code>WithBaseUrl()</code> to the intranet Dify service address, e.g.: <pre><code>difyagent.WithBaseUrl(\"http://dify.internal.company.com/v1\")\n</code></pre></p> <p>Q: How to choose between streaming and non-streaming modes?</p> <p>A: - Streaming: Suitable for long text generation, scenarios requiring real-time feedback - Non-streaming: Suitable for short responses, batch processing scenarios</p> <p>Q: How to debug Dify requests?</p> <p>A: Implement a custom request converter with logging: <pre><code>func (c *MyConverter) ConvertToDifyRequest(...) (*dify.ChatMessageRequest, error) {\n    req := &amp;dify.ChatMessageRequest{...}\n    log.Printf(\"Dify Request: %+v\", req)\n    return req, nil\n}\n</code></pre></p>"},{"location":"dify/#related-resources","title":"Related Resources","text":"<ul> <li>Dify Official Documentation</li> <li>Dify SDK Go</li> <li>tRPC-Agent-Go Documentation</li> <li>A2A Integration Guide</li> </ul>"},{"location":"ecosystem/","title":"tRPC-Agent-Go Ecosystem Development Guide","text":"<p>This document analyzes the modules in the tRPC-Agent-Go framework that need ecosystem development, explains the interfaces that need to be implemented, and provides contribution guidance.</p> <p>Note: All community-built components are contributed directly to the corresponding directory under the GitHub open source repository, such as <code>model/somemodel</code>, <code>tool/sometool</code>, <code>agent/someagent</code>, etc.</p> <p>When contributing, create a reasonably named subfolder under the corresponding contribution module directory, then implement the corresponding module interface, and provide rich test cases and example samples.</p>"},{"location":"ecosystem/#ecosystem-development-module-analysis","title":"Ecosystem Development Module Analysis","text":""},{"location":"ecosystem/#1-agent-ecosystem","title":"1. Agent Ecosystem","text":"<p>Goal: Encapsulate and adapt third-party Agent frameworks</p> <p>Interface Definition: agent.Agent</p> <p>Existing Implementation Reference: LLMAgent</p> <p>Implementation Notes:</p> <ul> <li>The <code>Run</code> method must return an event channel, supporting streaming responses</li> <li>The <code>Tools</code> method returns the list of tools available to the Agent</li> <li>The <code>Info</code> method provides basic information about the Agent</li> <li><code>SubAgents</code> and <code>FindSubAgent</code> support Agent composition patterns</li> <li>Reference LLMAgent implementation to understand event handling and error handling mechanisms</li> </ul> <p>Implementation Example:</p> <pre><code>package langchain\n\nimport (\n    \"context\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/agent\"\n    \"trpc.group/trpc-go/trpc-agent-go/event\"\n    \"trpc.group/trpc-go/trpc-agent-go/tool\"\n)\n\ntype LangChainAdapter struct {\n    config *Config\n    client *langchain.Client\n}\n\nfunc New(config *Config) (agent.Agent, error) {\n    client := langchain.NewClient(config.Endpoint, config.APIKey)\n\n    return &amp;LangChainAdapter{\n        config: config,\n        client: client,\n    }, nil\n}\n\nfunc (a *LangChainAdapter) Run(ctx context.Context, invocation *agent.Invocation) (&lt;-chan *event.Event, error) {\n    events := make(chan *event.Event)\n\n    go func() {\n        defer close(events)\n\n        response, err := a.client.Call(ctx, invocation.Messages)\n        if err != nil {\n            events &lt;- &amp;event.Event{\n                Type: event.TypeError,\n                Error: err,\n            }\n            return\n        }\n\n        events &lt;- &amp;event.Event{\n            Type: event.TypeResponse,\n            Response: &amp;model.Response{\n                Content: response.Content,\n            },\n        }\n    }()\n\n    return events, nil\n}\n\nfunc (a *LangChainAdapter) Tools() []tool.Tool {\n    return a.config.Tools\n}\n\nfunc (a *LangChainAdapter) Info() agent.Info {\n    return agent.Info{\n        Name:        \"langchain-adapter\",\n        Description: \"LangChain framework adapter\",\n    }\n}\n\nfunc (a *LangChainAdapter) SubAgents() []agent.Agent {\n    return nil\n}\n\nfunc (a *LangChainAdapter) FindSubAgent(name string) agent.Agent {\n    return nil\n}\n</code></pre> <p>Open Source Components That Can Be Integrated:</p> <ul> <li>LangChain adapter</li> <li>LangGraph adapter</li> </ul> <p>Contribution Method:</p> <ul> <li>Create components under the corresponding directory (create a subdirectory with the corresponding component name)</li> <li>Contribute directly to <code>https://github.com/trpc-group/trpc-agent-go/agent/</code></li> </ul>"},{"location":"ecosystem/#2-model-ecosystem","title":"2. Model Ecosystem","text":"<p>Goal: Support more model providers</p> <p>Interface Definition: model.Model</p> <p>Existing Implementation Reference: OpenAI Model</p> <p>Implementation Notes:</p> <ul> <li>The <code>GenerateContent</code> method must support streaming responses, returning an event channel</li> <li>Distinguish between system-level errors (return error) and API-level errors (Response.Error)</li> <li>Implement the <code>Info</code> method to provide basic model information</li> <li>Reference OpenAI implementation to understand request building and response handling</li> <li>Support context cancellation and timeout control</li> </ul> <p>Implementation Example:</p> <pre><code>package gemini\n\nimport (\n    \"context\"\n    \"fmt\"\n    \"trpc.group/trpc-go/trpc-agent-go/model\"\n)\n\ntype GeminiModel struct {\n    config *Config\n    client *gemini.Client\n}\n\nfunc New(config *Config) (model.Model, error) {\n    client := gemini.NewClient(config.APIKey)\n\n    return &amp;GeminiModel{\n        config: config,\n        client: client,\n    }, nil\n}\n\nfunc (g *GeminiModel) GenerateContent(ctx context.Context, request *model.Request) (&lt;-chan *model.Response, error) {\n    if request == nil {\n        return nil, fmt.Errorf(\"request cannot be nil\")\n    }\n\n    responses := make(chan *model.Response)\n\n    go func() {\n        defer close(responses)\n\n        // Call Gemini API.\n        stream, err := g.client.GenerateContent(ctx, request.Messages)\n        if err != nil {\n            responses &lt;- &amp;model.Response{\n                Error: &amp;model.Error{\n                    Message: err.Error(),\n                },\n            }\n            return\n        }\n\n        for chunk := range stream {\n            responses &lt;- &amp;model.Response{\n                Content: chunk.Content,\n            }\n        }\n    }()\n\n    return responses, nil\n}\n\nfunc (g *GeminiModel) Info() model.Info {\n    return model.Info{\n        Name: \"gemini-pro\",\n    }\n}\n</code></pre> <p>Open Source Components That Can Be Integrated:</p> <ul> <li>Google Gemini model support</li> <li>Anthropic Claude model support</li> <li>Ollama local model support</li> </ul> <p>Contribution Method:</p> <ul> <li>Create components under the corresponding directory (create a subdirectory with the corresponding component name)</li> <li>Contribute directly to <code>https://github.com/trpc-group/trpc-agent-go/model/</code></li> </ul>"},{"location":"ecosystem/#3-tool-ecosystem","title":"3. Tool Ecosystem","text":"<p>Goal: Integrate more third-party tools</p> <p>Interface Definition: </p> <ul> <li>tool.Tool - Single tool interface</li> <li>tool.ToolSet - Tool collection interface</li> </ul> <p>Existing Implementation Reference: DuckDuckGo Tool</p> <p>Implementation Notes:</p> <p>Single Tool Implementation:</p> <ul> <li>The <code>Declaration</code> method must return complete tool metadata</li> <li>The <code>Call</code> method receives JSON format parameters and returns results of any type</li> <li>Use JSON Schema to define input and output formats</li> <li>Reference DuckDuckGo implementation to understand tool calling and error handling</li> <li>Support context cancellation and timeout control</li> </ul> <p>Tool Collection Implementation:</p> <ul> <li>The <code>Tools</code> method returns available tool lists based on context</li> <li>The <code>Close</code> method releases resources held by the tool collection</li> <li>Support dynamic tool loading and configuration</li> <li>Implement tool lifecycle management</li> </ul> <p>Implementation Example:</p> <p>Single Tool Implementation:</p> <pre><code>package weather\n\nimport (\n    \"context\"\n    \"encoding/json\"\n    \"fmt\"\n    \"net/http\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/tool\"\n)\n\ntype WeatherTool struct {\n    apiKey string\n    client *http.Client\n}\n\nfunc New(apiKey string) tool.CallableTool {\n    return &amp;WeatherTool{\n        apiKey: apiKey,\n        client: &amp;http.Client{},\n    }\n}\n\nfunc (w *WeatherTool) Declaration() *tool.Declaration {\n    return &amp;tool.Declaration{\n        Name:        \"get_weather\",\n        Description: \"Get current weather information for a location\",\n        InputSchema: &amp;tool.Schema{\n            Type: \"object\",\n            Properties: map[string]*tool.Schema{\n                \"location\": {\n                    Type:        \"string\",\n                    Description: \"City name or coordinates\",\n                },\n            },\n            Required: []string{\"location\"},\n        },\n        OutputSchema: &amp;tool.Schema{\n            Type: \"object\",\n            Properties: map[string]*tool.Schema{\n                \"temperature\": {Type: \"number\"},\n                \"condition\":   {Type: \"string\"},\n                \"humidity\":    {Type: \"number\"},\n            },\n        },\n    }\n}\n\nfunc (w *WeatherTool) Call(ctx context.Context, jsonArgs []byte) (any, error) {\n    var args struct {\n        Location string `json:\"location\"`\n    }\n\n    if err := json.Unmarshal(jsonArgs, &amp;args); err != nil {\n        return nil, fmt.Errorf(\"invalid arguments: %w\", err)\n    }\n\n    url := fmt.Sprintf(\"https://api.weatherapi.com/v1/current.json?key=%s&amp;q=%s\", w.apiKey, args.Location)\n\n    req, err := http.NewRequestWithContext(ctx, \"GET\", url, nil)\n    if err != nil {\n        return nil, err\n    }\n\n    resp, err := w.client.Do(req)\n    if err != nil {\n        return nil, err\n    }\n    defer resp.Body.Close()\n\n    var weatherData map[string]interface{}\n    if err := json.NewDecoder(resp.Body).Decode(&amp;weatherData); err != nil {\n        return nil, err\n    }\n\n    return weatherData, nil\n}\n</code></pre> <p>Tool Collection Implementation:</p> <pre><code>package apitools\n\nimport (\n    \"context\"\n    \"sync\"\n    \"trpc.group/trpc-go/trpc-agent-go/tool\"\n)\n\ntype APIToolSet struct {\n    tools map[string]tool.Tool\n    mu    sync.RWMutex\n}\n\nfunc New() *APIToolSet {\n    return &amp;APIToolSet{\n        tools: make(map[string]tool.Tool),\n    }\n}\n\nfunc (a *APIToolSet) AddTool(name string, t tool.Tool) {\n    a.mu.Lock()\n    defer a.mu.Unlock()\n    a.tools[name] = t\n}\n\nfunc (a *APIToolSet) RemoveTool(name string) {\n    a.mu.Lock()\n    defer a.mu.Unlock()\n    delete(a.tools, name)\n}\n\nfunc (a *APIToolSet) Tools(ctx context.Context) []tool.Tool {\n    a.mu.RLock()\n    defer a.mu.RUnlock()\n\n    var result []tool.Tool\n    for _, t := range a.tools {\n        result = append(result, t)\n    }\n    return result\n}\n\nfunc (a *APIToolSet) Close() error {\n    a.mu.Lock()\n    defer a.mu.Unlock()\n\n    // Clean up resources.\n    a.tools = make(map[string]tool.Tool)\n    return nil\n}\n\n// Name identifies this ToolSet.\nfunc (a *APIToolSet) Name() string { return \"api-tools\" }\n</code></pre> <p>Open Source Components That Can Be Integrated:</p> <ul> <li>Search engine tools (Google, Bing)</li> <li>Weather query tools</li> <li>Calculator tools</li> <li>File operation tools</li> <li>API tool collections (REST API toolkit)</li> <li>Database operation tool collections</li> <li>File processing tool collections</li> </ul> <p>Contribution Method:</p> <ul> <li>Create components under the corresponding directory (create a subdirectory with the corresponding component name)</li> <li>Contribute directly to <code>https://github.com/trpc-group/trpc-agent-go/tool/</code></li> </ul>"},{"location":"ecosystem/#4-knowledge-base-ecosystem","title":"4. Knowledge Base Ecosystem","text":"<p>Goal: Integrate mature RAG components</p> <p>Interface Definition: knowledge.Knowledge</p> <p>Existing Implementation Reference: </p> <ul> <li>InMemory Knowledge</li> </ul> <p>Implementation Notes:</p> <ul> <li>The <code>Search</code> method supports context and history records</li> <li>Returns relevant documents and relevance scores</li> <li>Supports search parameters and result limits</li> <li>Reference InMemory implementation to understand search logic and result processing</li> <li>Supports vectorized search and semantic matching</li> </ul> <p>Implementation Example:</p> <pre><code>package weaviate\n\nimport (\n    \"context\"\n    \"fmt\"\n    \"trpc.group/trpc-go/trpc-agent-go/knowledge\"\n    \"trpc.group/trpc-go/trpc-agent-go/knowledge/document\"\n)\n\ntype WeaviateKnowledge struct {\n    config *Config\n    client *weaviate.Client\n}\n\nfunc New(config *Config) (knowledge.Knowledge, error) {\n    client := weaviate.NewClient(config.Endpoint, config.APIKey)\n\n    return &amp;WeaviateKnowledge{\n        config: config,\n        client: client,\n    }, nil\n}\n\nfunc (w *WeaviateKnowledge) Search(ctx context.Context, req *knowledge.SearchRequest) (*knowledge.SearchResult, error) {\n    if req.Query == \"\" {\n        return nil, fmt.Errorf(\"query cannot be empty\")\n    }\n\n    // Build search query.\n    query := w.buildQuery(req)\n\n    // Execute vector search.\n    results, err := w.client.Search(ctx, query)\n    if err != nil {\n        return nil, err\n    }\n\n    if len(results) == 0 {\n        return nil, fmt.Errorf(\"no results found\")\n    }\n\n    // Return best matching result.\n    bestResult := results[0]\n\n    return &amp;knowledge.SearchResult{\n        Document: &amp;document.Document{\n            ID:      bestResult.ID,\n            Content: bestResult.Content,\n            Metadata: bestResult.Metadata,\n        },\n        Score: bestResult.Score,\n        Text:  bestResult.Content,\n    }, nil\n}\n\nfunc (w *WeaviateKnowledge) buildQuery(req *knowledge.SearchRequest) *weaviate.Query {\n    // Build Weaviate query logic.\n    return &amp;weaviate.Query{\n        Query: req.Query,\n        Limit: req.MaxResults,\n        Filter: w.buildFilter(req),\n    }\n}\n</code></pre> <p>Open Source Components That Can Be Integrated:</p> <ul> <li>Weaviate vector database</li> <li>Pinecone vector database</li> <li>Qdrant vector database</li> </ul> <p>Contribution Method:</p> <ul> <li>Create components under the corresponding directory (create a subdirectory with the corresponding component name)</li> <li>Contribute directly to <code>https://github.com/trpc-group/trpc-agent-go/knowledge/</code></li> </ul>"},{"location":"ecosystem/#5-session-ecosystem","title":"5. Session Ecosystem","text":"<p>Goal: Support multiple session storage backends, manage user session state and events</p> <p>Interface Definition: session.Service</p> <p>Existing Implementation Reference:</p> <ul> <li>InMemory Session</li> <li>Redis Session</li> </ul> <p>Implementation Notes:</p> <ul> <li>Implement complete Session lifecycle management (create, get, delete, list)</li> <li>Support state storage and event recording</li> <li>Implement connection pooling and error handling</li> <li>Support transactions and consistency</li> <li>Can reuse storage module clients</li> <li>Reference InMemory and Redis implementations to understand Session management logic</li> </ul> <p>Implementation Example:</p> <pre><code>package postgresql\n\nimport (\n    \"context\"\n    \"database/sql\"\n    \"encoding/json\"\n    \"fmt\"\n    \"time\"\n    \"trpc.group/trpc-go/trpc-agent-go/event\"\n    \"trpc.group/trpc-go/trpc-agent-go/session\"\n)\n\ntype PostgreSQLService struct {\n    db *sql.DB\n}\n\nfunc New(dsn string) (session.Service, error) {\n    db, err := sql.Open(\"postgres\", dsn)\n    if err != nil {\n        return nil, err\n    }\n\n    if err := db.Ping(); err != nil {\n        return nil, err\n    }\n\n    return &amp;PostgreSQLService{db: db}, nil\n}\n\nfunc (p *PostgreSQLService) CreateSession(ctx context.Context, key session.Key, state session.StateMap, \n    options ...session.Option) (*session.Session, error) {\n    if err := key.CheckSessionKey(); err != nil {\n        return nil, err\n    }\n\n    now := time.Now()\n    session := &amp;session.Session{\n        ID:        key.SessionID,\n        AppName:   key.AppName,\n        UserID:    key.UserID,\n        State:     state,\n        Events:    []event.Event{},\n        UpdatedAt: now,\n        CreatedAt: now,\n    }\n\n    // Insert into database.\n    _, err := p.db.ExecContext(ctx, `\n        INSERT INTO sessions (id, app_name, user_id, state, created_at, updated_at)\n        VALUES ($1, $2, $3, $4, $5, $6)\n    `, session.ID, session.AppName, session.UserID, p.marshalState(state), session.CreatedAt, session.UpdatedAt)\n\n    if err != nil {\n        return nil, err\n    }\n\n    return session, nil\n}\n\nfunc (p *PostgreSQLService) GetSession(ctx context.Context, key session.Key, \n    options ...session.Option) (*session.Session, error) {\n    if err := key.CheckSessionKey(); err != nil {\n        return nil, err\n    }\n\n    var session session.Session\n    var stateData []byte\n\n    err := p.db.QueryRowContext(ctx, `\n        SELECT id, app_name, user_id, state, created_at, updated_at\n        FROM sessions WHERE id = $1\n    `, key.SessionID).Scan(&amp;session.ID, &amp;session.AppName, &amp;session.UserID, &amp;stateData, &amp;session.CreatedAt, \n        &amp;session.UpdatedAt)\n\n    if err != nil {\n        return nil, err\n    }\n\n    session.State = p.unmarshalState(stateData)\n\n    return &amp;session, nil\n}\n\nfunc (p *PostgreSQLService) Close() error {\n    return p.db.Close()\n}\n\nfunc (p *PostgreSQLService) marshalState(state session.StateMap) []byte {\n    data, _ := json.Marshal(state)\n    return data\n}\n\nfunc (p *PostgreSQLService) unmarshalState(data []byte) session.StateMap {\n    var state session.StateMap\n    json.Unmarshal(data, &amp;state)\n    return state\n}\n</code></pre> <p>Open Source Components That Can Be Integrated:</p> <ul> <li>PostgreSQL session storage</li> <li>MongoDB session storage</li> <li>MySQL session storage</li> <li>Cassandra session storage</li> </ul> <p>Contribution Method:</p> <ul> <li>Create components under the corresponding directory (create a subdirectory with the corresponding component name)</li> <li>Contribute directly to <code>https://github.com/trpc-group/trpc-agent-go/session/</code></li> </ul>"},{"location":"ecosystem/#6-memory-ecosystem","title":"6. Memory Ecosystem","text":"<p>Goal: Support multiple memory storage backends, manage user long-term memory and personalized information</p> <p>Interface Definition: memory.Service</p> <p>Existing Implementation Reference: InMemory Memory</p> <p>Implementation Notes:</p> <ul> <li>Implement complete Memory lifecycle management (add, update, delete, search, read)</li> <li>Support memory topic classification and search</li> <li>Provide memory tool integration (memory_add, memory_search, etc.)</li> <li>Implement connection pooling and error handling</li> <li>Can reuse storage module clients</li> <li>Support memory limits and cleanup mechanisms</li> <li>Reference InMemory implementation to understand memory management logic</li> </ul> <p>Implementation Example:</p> <pre><code>package postgresql\n\nimport (\n    \"context\"\n    \"database/sql\"\n    \"encoding/json\"\n    \"fmt\"\n    \"time\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/memory\"\n    memorytool \"trpc.group/trpc-go/trpc-agent-go/memory/tool\"\n    \"trpc.group/trpc-go/trpc-agent-go/tool\"\n)\n\ntype PostgreSQLMemoryService struct {\n    db *sql.DB\n    cachedTools map[string]tool.Tool\n}\n\nfunc New(dsn string) (memory.Service, error) {\n    db, err := sql.Open(\"postgres\", dsn)\n    if err != nil {\n        return nil, err\n    }\n\n    if err := db.Ping(); err != nil {\n        return nil, err\n    }\n\n    service := &amp;PostgreSQLMemoryService{\n        db: db,\n        cachedTools: make(map[string]tool.Tool),\n    }\n\n    // Initialize tools.\n    service.initTools()\n\n    return service, nil\n}\n\nfunc (p *PostgreSQLMemoryService) AddMemory(ctx context.Context, userKey memory.UserKey, memoryStr string, \n    topics []string) error {\n    if err := userKey.CheckUserKey(); err != nil {\n        return err\n    }\n\n    now := time.Now()\n    memoryID := p.generateMemoryID(memoryStr)\n\n    // Insert memory into database.\n    _, err := p.db.ExecContext(ctx, `\n        INSERT INTO memories (id, app_name, user_id, memory, topics, created_at, updated_at)\n        VALUES ($1, $2, $3, $4, $5, $6, $7)\n    `, memoryID, userKey.AppName, userKey.UserID, memoryStr, p.marshalTopics(topics), now, now)\n\n    return err\n}\n\nfunc (p *PostgreSQLMemoryService) SearchMemories(ctx context.Context, userKey memory.UserKey, \n    query string) ([]*memory.Entry, error) {\n    if err := userKey.CheckUserKey(); err != nil {\n        return nil, err\n    }\n\n    // Execute full-text search.\n    rows, err := p.db.QueryContext(ctx, `\n        SELECT id, app_name, user_id, memory, topics, created_at, updated_at\n        FROM memories \n        WHERE app_name = $1 AND user_id = $2 \n        AND (memory ILIKE $3 OR topics::text ILIKE $3)\n        ORDER BY updated_at DESC\n        LIMIT 10\n    `, userKey.AppName, userKey.UserID, \"%\"+query+\"%\")\n\n    if err != nil {\n        return nil, err\n    }\n    defer rows.Close()\n\n    var entries []*memory.Entry\n    for rows.Next() {\n        var entry memory.Entry\n        var topicsData []byte\n\n        err := rows.Scan(&amp;entry.ID, &amp;entry.AppName, &amp;entry.UserID, &amp;entry.Memory.Memory, &amp;topicsData, &amp;entry.CreatedAt, \n        &amp;entry.UpdatedAt)\n    if err != nil {\n        return nil, err\n    }\n\n        entry.Memory.Topics = p.unmarshalTopics(topicsData)\n        entries = append(entries, &amp;entry)\n    }\n\n    return entries, nil\n}\n\nfunc (p *PostgreSQLMemoryService) Tools() []tool.Tool {\n    var tools []tool.Tool\n    for _, t := range p.cachedTools {\n        tools = append(tools, t)\n    }\n    return tools\n}\n\nfunc (p *PostgreSQLMemoryService) initTools() {\n    p.cachedTools[memory.AddToolName] = memorytool.NewAddTool(p)\n    p.cachedTools[memory.SearchToolName] = memorytool.NewSearchTool(p)\n    p.cachedTools[memory.LoadToolName] = memorytool.NewLoadTool(p)\n}\n\nfunc (p *PostgreSQLMemoryService) generateMemoryID(memoryStr string) string {\n    // Generate unique memory ID.\n    return fmt.Sprintf(\"mem_%d\", time.Now().UnixNano())\n}\n\nfunc (p *PostgreSQLMemoryService) marshalTopics(topics []string) []byte {\n    data, _ := json.Marshal(topics)\n    return data\n}\n\nfunc (p *PostgreSQLMemoryService) unmarshalTopics(data []byte) []string {\n    var topics []string\n    json.Unmarshal(data, &amp;topics)\n    return topics\n}\n</code></pre> <p>For quick implementation, you can directly integrate with existing Memory platforms/services (such as mem0). Recommendations:</p> <ul> <li>Provide implementation in <code>memory/mem0/</code>, following the <code>memory.Service</code> interface.</li> <li>Reuse existing <code>memory/tool</code> tools (<code>memory_add</code>, <code>memory_search</code>, <code>memory_load</code>, etc.), expose through <code>Tools()</code>.</li> <li>Map topics and search according to target service capabilities, maintain lightweight local indexes when necessary to enhance query experience.</li> <li>Optional: Reuse <code>storage</code> module client management for unified authentication, connection and reuse.</li> </ul> <p>Example skeleton (simplified):</p> <pre><code>package mem0\n\nimport (\n    \"context\"\n    \"net/http\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/memory\"\n    memorytool \"trpc.group/trpc-go/trpc-agent-go/memory/tool\"\n    \"trpc.group/trpc-go/trpc-agent-go/tool\"\n)\n\ntype Service struct {\n    client  *http.Client\n    baseURL string\n    apiKey  string\n    tools   map[string]tool.Tool\n}\n\nfunc New(baseURL, apiKey string) *Service {\n    s := &amp;Service{\n        client:  &amp;http.Client{},\n        baseURL: baseURL,\n        apiKey:  apiKey,\n        tools:   make(map[string]tool.Tool),\n    }\n    s.tools[memory.AddToolName] = memorytool.NewAddTool(s)\n    s.tools[memory.SearchToolName] = memorytool.NewSearchTool(s)\n    s.tools[memory.LoadToolName] = memorytool.NewLoadTool(s)\n    return s\n}\n\nfunc (s *Service) Tools() []tool.Tool {\n    var ts []tool.Tool\n    for _, t := range s.tools {\n        ts = append(ts, t)\n    }\n    return ts\n}\n\nfunc (s *Service) AddMemory(ctx context.Context, key memory.UserKey, m string, topics []string) error {\n    if err := key.CheckUserKey(); err != nil {\n        return err\n    }\n    // Call mem0 API to write memory.\n    return nil\n}\n\nfunc (s *Service) SearchMemories(ctx context.Context, key memory.UserKey, q string) ([]*memory.Entry, error) {\n    if err := key.CheckUserKey(); err != nil {\n        return nil, err\n    }\n    // Call mem0 API to search, and convert to []*memory.Entry.\n    return nil, nil\n}\n\n// Other interfaces Update/Delete/Clear/Read map according to mem0 capabilities\n</code></pre> <p>Implementation points:</p> <ul> <li>Configure authentication and rate limiting according to target service guidelines.</li> <li>Return values strictly align with <code>memory.Entry</code> and <code>memory.Memory</code>, use UTC for time fields.</li> <li>Tool declarations should accurately describe input and output for frontend and model understanding.</li> <li>Add README, examples and tests to ensure compatibility with runner-based integrations.</li> </ul> <p>Open Source Components That Can Be Integrated:</p> <ul> <li>PostgreSQL memory storage</li> <li>MongoDB memory storage</li> <li>Elasticsearch memory storage</li> <li>Redis memory storage</li> </ul> <p>Contribution Method:</p> <ul> <li>Create components under the corresponding directory (create a subdirectory with the corresponding component name)</li> <li>Contribute directly to <code>https://github.com/trpc-group/trpc-agent-go/memory/</code></li> </ul>"},{"location":"ecosystem/#7-observability-ecosystem","title":"7. Observability Ecosystem","text":"<p>Goal: Provide unified observability capabilities based on OpenTelemetry standards, covering Logging, Metrics, Tracing, facilitating ecosystem expansion and replacement.</p> <p>Core Packages and Interfaces:</p> <ul> <li>Logging: <code>trpc-agent-go/log</code> (<code>log.Logger</code> interface and <code>log.Default</code> global logger).</li> <li>Metrics: <code>trpc-agent-go/telemetry/metric</code> (global <code>metric.Meter</code> and <code>metric.Start</code> initialization).</li> <li>Tracing: <code>trpc-agent-go/telemetry/trace</code> (global <code>trace.Tracer</code> and <code>trace.Start</code> initialization).</li> <li>tRPC Integration: <code>trpc/log.go</code>, <code>trpc/telemetry/galileo/</code>.</li> </ul>"},{"location":"ecosystem/#logging","title":"Logging","text":"<ul> <li>Interface Definition: <code>log.Logger</code> defines <code>Debug/Info/Warn/Error/Fatal</code> and their <code>*f</code> variant methods, facilitating replacement with any implementation.</li> <li>Default Implementation: <code>log.Default</code> uses <code>zap</code>'s <code>SugaredLogger</code> by default.</li> <li>Dynamic Level: <code>log.SetLevel(level)</code> supports <code>debug/info/warn/error/fatal</code>.</li> <li>tRPC Integration: <code>trpc/log.go</code> injects <code>tlog.DefaultLogger</code> as <code>log.Default</code> and refreshes with tRPC plugin lifecycle.</li> </ul> <p>Example (using global logger):</p> <pre><code>package main\n\nimport (\n    \"context\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/log\"\n)\n\nfunc main() {\n    log.SetLevel(log.LevelInfo)\n    log.Info(\"app start\")\n    log.Debugf(\"ctx: %v\", context.Background())\n}\n</code></pre> <p>Example (in tRPC through configuration to disk/remote):</p> <pre><code>plugins:\n  log:\n    default:\n      - writer: console\n        level: info\n      - writer: file\n        level: warn\n        writer_config:\n          log_path: ./app.log\n</code></pre> <p>Contribution directions:</p> <ul> <li>Adapt any Logger (such as zerolog, logrus): implement <code>log.Logger</code> interface, and set <code>log.Default = yourLogger</code> during initialization.</li> <li>tRPC pluginization: reference <code>trpc/log.go</code>'s <code>plugin.RegisterSetupHook</code> usage.</li> </ul>"},{"location":"ecosystem/#metrics","title":"Metrics","text":"<ul> <li>Package: <code>telemetry/metric</code>.</li> <li>Global Object: <code>metric.Meter</code>, default <code>noop</code>, points to OTel Meter after calling <code>metric.Start</code>.</li> <li>Initialization: <code>metric.Start(ctx, metric.WithEndpoint(\"host:4317\"))</code>.</li> <li>OTLP Export: uses <code>otlpmetricgrpc</code>, supports environment variable override:<ul> <li><code>OTEL_EXPORTER_OTLP_METRICS_ENDPOINT</code>.</li> <li><code>OTEL_EXPORTER_OTLP_ENDPOINT</code> (fallback).</li> </ul> </li> <li>Resource Identification: automatically fills <code>service.namespace/name/version</code>.</li> </ul> <p>Example (start metrics and report Counter):</p> <pre><code>package main\n\nimport (\n    \"context\"\n\n    \"go.opentelemetry.io/otel/metric\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/telemetry/metric\" // alias ametric\n    ametric \"trpc.group/trpc-go/trpc-agent-go/telemetry/metric\"\n)\n\nfunc main() {\n    mp, err := ametric.NewMeterProvider(\n        context.Background(),\n        ametric.WithEndpoint(\"localhost:4318\"),\n        ametric.WithProtocol(\"http\"),\n    )\n    if err != nil {\n        log.Fatalf(\"Failed to create meter provider: %v\", err)\n    }\n    defer mp.Shutdown(context.Background())\n    ametric.InitMeterProvider(mp)\n    meter := mp.Meter(\"trpc_agent_go.app\")\n        counter, _ := meter.Int64Counter(\n        \"requests_total\",\n        metric.WithDescription(\"total requests\"),\n    )\n    counter.Add(context.Background(), 1)\n}\n</code></pre> <p>Contribution directions:</p> <ul> <li>Exporter ecosystem: encapsulate more OTel Exporter convenient startup methods (such as Prometheus pull/OTLP http).</li> <li>Metrics library: agree on common metric naming and label conventions, provide helper methods.</li> </ul>"},{"location":"ecosystem/#tracing","title":"Tracing","text":"<ul> <li>Package: <code>telemetry/trace</code>.</li> <li>Global Object: <code>trace.Tracer</code>, default <code>noop</code>, points to OTel Tracer after calling <code>trace.Start</code>.</li> <li>Initialization: <code>trace.Start(ctx, trace.WithEndpoint(\"host:4317\"))</code>.</li> <li>OTLP Export: uses <code>otlptracegrpc</code>, supports environment variable override:<ul> <li><code>OTEL_EXPORTER_OTLP_TRACES_ENDPOINT</code>.</li> <li><code>OTEL_EXPORTER_OTLP_ENDPOINT</code> (fallback).</li> </ul> </li> <li>Propagator: enables <code>TraceContext</code> by default.</li> </ul> <p>Example (start tracing and create Span):</p> <pre><code>package main\n\nimport (\n    \"context\"\n\n    \"go.opentelemetry.io/otel/trace\"\n    atrace \"trpc.group/trpc-go/trpc-agent-go/telemetry/trace\"\n)\n\nfunc main() {\n    clean, _ := atrace.Start(context.Background(),\n        atrace.WithEndpoint(\"localhost:4317\"),\n    )\n    defer clean()\n\n    ctx, span := atrace.Tracer.Start(context.Background(), \"example\",\n        trace.WithAttributes(),\n    )\n    _ = ctx\n    span.End()\n}\n</code></pre> <p>Contribution directions:</p> <ul> <li>Exporter ecosystem: encapsulate Zipkin, Jaeger (direct push) and other startup methods.</li> <li>Span conventions: agree on common Span names/attribute keys, provide helpers (can be placed in <code>telemetry/</code>).</li> </ul>"},{"location":"ecosystem/#8-api-service-ecosystem","title":"8. API Service Ecosystem","text":"<p>Goal: Provide unified, extensible API service encapsulation for frontend Chat interfaces (such as ADK Web, AG-UI, Agent UI), covering session management, conversation sending, streaming transmission, tool calls, observability and authentication capabilities, and align with various UI protocols for plug-and-play.</p> <p>Existing Implementation Reference:</p> <ul> <li>A2A Server: <code>server/a2a</code>.<ul> <li>Service encapsulation for A2A protocol, built-in <code>AuthProvider</code> and task orchestration, suitable for platform-to-Agent integration scenarios.</li> </ul> </li> </ul> <p>Alignment with Frontend Protocols:</p> <ul> <li>AG-UI: Reference <code>https://github.com/ag-ui-protocol/ag-ui</code>.<ul> <li>Required capabilities:<ul> <li>Session list/create/query.</li> <li>Text conversation and SSE streaming increment; support tool calls and function response fragment display.</li> <li>State/usage metadata, error expression alignment.</li> <li>Rich media support (InlineData) for files/images and server-side storage integration.</li> <li>Authentication (API Key, JWT, Cookie session) and CORS.</li> </ul> </li> <li>Recommend providing implementation in <code>server/agui/</code>, reuse common model and event mapping tools, complete protocol layer adaptation in Handler.</li> </ul> </li> <li>Agent UI (agno): Reference <code>https://docs.agno.com/agent-ui/introduction</code>.<ul> <li>Focus: SSE/WebSocket streaming, Tool call streaming UI feedback, session/artifact persistence.</li> </ul> </li> </ul> <p>Key Design Points:</p> <ul> <li>Schema Mapping:<ul> <li>Input: Map UI's <code>Content</code>/<code>Part</code> to internal <code>model.Message</code>.</li> <li>Output events: Map internal <code>event.Event</code> to UI-expected envelope/parts, structure tool calls and tool responses to avoid duplicate text display.</li> </ul> </li> <li>Streaming Transmission:<ul> <li>Prefer SSE for streaming; WebSocket can be an ecosystem extension.</li> <li>Non-streaming endpoints need to aggregate final messages and tool responses according to UI expectations.</li> </ul> </li> <li>Session Storage:<ul> <li>Inject specific implementation through <code>runner.WithSessionService</code>, reuse <code>session</code> module.</li> </ul> </li> <li>Observability:<ul> <li>Reuse <code>telemetry/trace</code> and <code>telemetry/metric</code>, export key spans and event attributes for UI-side debugging and positioning.</li> </ul> </li> <li>Authentication and Security:<ul> <li>Support API Key/JWT/custom Header; add rate limiting and cross-domain control for sensitive endpoints.</li> </ul> </li> <li>Open Specifications:<ul> <li>Recommend attaching <code>openapi.json</code>/<code>README.md</code> to each <code>server/*</code> submodule for frontend/integration party integration.</li> </ul> </li> </ul> <p>AG-UI Adaptation Suggestion (skeleton):</p> <pre><code>package agui\n\nimport (\n    \"net/http\"\n\n    \"github.com/gorilla/mux\"\n    \"trpc.group/trpc-go/trpc-agent-go/agent\"\n    \"trpc.group/trpc-go/trpc-agent-go/runner\"\n)\n\ntype Server struct {\n    router *mux.Router\n    ag     agent.Agent\n    run    runner.Runner\n}\n\nfunc New(ag agent.Agent, opts ...runner.Option) *Server {\n    r := runner.NewRunner(ag.Info().Name, ag, opts...)\n    s := &amp;Server{router: mux.NewRouter(), ag: ag, run: r}\n    s.routes()\n    return s\n}\n\nfunc (s *Server) Handler() http.Handler { return s.router }\n\nfunc (s *Server) routes() {\n    // GET /sessions, POST /sessions, GET /sessions/{id}\n    // POST /chat (non-stream), POST /chat/stream (SSE)\n}\n</code></pre> <p>Ecosystem Directions and Contribution Standards:</p> <ul> <li>Target UI/Protocols:<ul> <li>AG-UI: Provide HTTP + SSE adaptation in <code>server/agui/</code>, with examples and <code>openapi.json</code>.</li> </ul> </li> <li>Agent UI (agno): Provide HTTP + SSE / WebSocket adaptation in <code>server/agentui/</code>.<ul> <li>WebSocket/Bidi Streaming: Align with ADK <code>run_live</code>, provide real-time audio/video channels (depends on model-side support).</li> </ul> </li> <li>Implementation Requirements:<ul> <li>Clear event Schema, complete mapping, ensure tool calls/responses have good experience in UI.</li> <li>Support pluggable session storage, default In-Memory, recommend supporting Redis/MySQL etc.</li> <li>Built-in CORS, authentication middleware (API Key/JWT), expose health check endpoints.</li> <li>Observability: integrate <code>telemetry</code>, provide minimal Trace and Metric examples.</li> <li>Documentation: README, OpenAPI, end-to-end examples (include simple frontend or curl scripts).</li> </ul> </li> </ul> <p>Link references:</p> <ul> <li><code>server/a2a</code> (A2A protocol encapsulation). </li> </ul>"},{"location":"ecosystem/#9-planner-ecosystem","title":"9. Planner Ecosystem","text":"<p>Goal: Provide diverse planners to adapt to different models and workflows, including built-in thinking capability adaptation and explicit planning (ReAct/Reflection, etc.).</p> <p>Interface Definition: <code>planner.Planner</code>.</p> <ul> <li><code>BuildPlanningInstruction(ctx, invocation, llmRequest) string</code>: Build or inject system prompts and request configurations for planning.</li> <li><code>ProcessPlanningResponse(ctx, invocation, response) *model.Response</code>: Post-process model responses for planning (optional).</li> </ul> <p>Existing Implementation Reference:</p> <ul> <li><code>planner/builtin</code>: Adapt O series, Claude, Gemini and other models with reasoning parameters, through configuring <code>ReasoningEffort</code>, <code>ThinkingEnabled</code>, <code>ThinkingTokens</code>.</li> <li><code>planner/react</code>: Provide explicit planning instructions and response post-processing, agree on <code>/*PLANNING*/</code>, <code>/*ACTION*/</code>, <code>/*REASONING*/</code>, <code>/*FINAL_ANSWER*/</code> and other tags.</li> </ul> <p>Ecosystem Directions:</p> <ul> <li>Reflection Planner: Self-reflective correction and multi-round re-planning.</li> <li>LangGraph style Planner: Align with Pregel parallel and checkpoint mechanisms.</li> <li>Tool-first Planner: Selection and constraints for Tool-First processes.</li> </ul> <p>Integration Example (skeleton):</p> <pre><code>package myplanner\n\nimport (\n    \"context\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/agent\"\n    \"trpc.group/trpc-go/trpc-agent-go/model\"\n    \"trpc.group/trpc-go/trpc-agent-go/planner\"\n)\n\ntype Planner struct{}\n\nvar _ planner.Planner = (*Planner)(nil)\n\nfunc New() *Planner { return &amp;Planner{} }\n\nfunc (p *Planner) BuildPlanningInstruction(ctx context.Context, inv *agent.Invocation, req *model.Request) string {\n    // Can inject custom parameters into req, and return system prompt string.\n    return \"You must plan before action.\"\n}\n\nfunc (p *Planner) ProcessPlanningResponse(ctx context.Context, inv *agent.Invocation, \n    rsp *model.Response) *model.Response {\n    if rsp == nil {\n        return nil\n    }\n    // Can do structured segmentation or tool call correction on rsp.\n    return nil\n}\n</code></pre> <p>Combination and Usage: Inject Planner when creating <code>agent/llmagent</code>, or select different Planner strategies at <code>runner</code> layer as needed, combine with <code>Tool</code> and <code>Session</code> management for end-to-end implementation.</p> <p>Contribution Suggestions:</p> <ul> <li>Provide implementation and README, test cases, examples in <code>planner/&lt;name&gt;/</code>.</li> <li>Combine with <code>docs/overall-introduction.md</code>'s Observability to provide end-to-end examples for frontend UI demonstration.</li> <li>Follow goimports and error message style, add periods at end of comments, code line breaks around 80 columns.</li> </ul>"},{"location":"ecosystem/#component-relationship-description","title":"Component Relationship Description","text":""},{"location":"ecosystem/#relationship-between-storage-session-and-memory","title":"Relationship between Storage, Session, and Memory","text":"<p>These three components have different responsibilities and relationships in the architecture:</p> <p>1. Storage (Storage Layer)</p> <ul> <li>Responsibility: Provide unified storage client management, provide infrastructure support for Session and Memory</li> <li>Function: Register, manage and obtain clients for various storage backends (Redis, PostgreSQL, MongoDB, etc.)</li> <li>Characteristics: As an infrastructure component, can be shared and used by Session and Memory components</li> </ul> <p>2. Session (Session Layer)</p> <ul> <li>Responsibility: Manage user session state and events</li> <li>Function: Create, get, delete sessions, manage session state, record session events</li> <li>Dependency: Can reuse Storage module clients</li> <li>Data Characteristics: Temporary data, can be cleaned up after session ends</li> </ul> <p>3. Memory (Memory Layer)</p> <ul> <li>Responsibility: Manage user long-term memory and personalized information</li> <li>Function: Add, search, update, delete user memories, provide memory tools</li> <li>Dependency: Can reuse Storage module clients</li> <li>Data Characteristics: Persistent data, maintained across sessions</li> </ul> <p>Relationship Diagram:</p> <pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502   Application   \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n          \u2502\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502   Session       \u2502    \u2502   Memory        \u2502\n\u2502   Service       \u2502    \u2502   Service       \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n          \u2502                      \u2502\n          \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                     \u2502\n          \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n          \u2502   Storage       \u2502\n          \u2502   Client        \u2502\n          \u2502   Management    \u2502\n          \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                     \u2502\n          \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n          \u2502   Storage       \u2502\n          \u2502   Backends      \u2502\n          \u2502   (Redis, DB)   \u2502\n          \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre> <p>Usage Example:</p> <pre><code>// 1. Register storage client.\nstorage.RegisterRedisInstance(\"default\", storage.WithClientBuilderURL(\"redis://localhost:6379\"))\n\n// 2. Session service uses storage client.\nsessionService, err := session.NewRedisService(\n    session.WithRedisInstance(\"default\"),\n)\n\n// 3. Memory service uses storage client.\nmemoryService, err := memory.NewRedisService(\n    memory.WithRedisInstance(\"default\"),\n)\n\n// 4. Use in application.\nsession, err := sessionService.CreateSession(ctx, sessionKey, state)\nmemory, err := memoryService.AddMemory(ctx, userKey, \"User likes coffee\", []string{\"preferences\"})\n</code></pre>"},{"location":"ecosystem/#contribution-guidance","title":"Contribution Guidance","text":""},{"location":"ecosystem/#contribution-guidance_1","title":"Contribution Guidance","text":"<p>Suitable Components:</p> <ul> <li>Various third-party service and tool integrations</li> <li>Open source component adapters</li> <li>Standard protocol support</li> <li>Framework functionality extensions</li> </ul> <p>Contribution Process:</p> <ol> <li>Fork <code>https://github.com/trpc-group/trpc-agent-go</code></li> <li>Create components under the corresponding module root directory (such as <code>model/somemodel</code>, <code>tool/sometool</code>, <code>agent/someagent</code>)</li> <li>Implement corresponding interfaces</li> <li>Write tests and documentation</li> <li>Submit Pull Request</li> </ol> <p>Directory Structure Example:</p> <pre><code>model/gemini/\n\u251c\u2500\u2500 model.go\n\u251c\u2500\u2500 config.go\n\u251c\u2500\u2500 examples/\n\u251c\u2500\u2500 README.md\n\u2514\u2500\u2500 gemini_test.go\n</code></pre>"},{"location":"ecosystem/#summary","title":"Summary","text":"<p>Ecosystem development is an important direction for tRPC-Agent-Go development. By implementing standard interfaces, various third-party services and tools can be easily integrated to expand the framework's capabilities.</p> <p>Key Contribution Points:</p> <ul> <li>Reference existing implementations to understand interface usage</li> <li>Choose appropriate contribution paths based on component types</li> <li>Follow unified interface specifications and code standards</li> <li>Provide complete test cases and documentation</li> </ul> <p>Determining Contribution Location:</p> <ul> <li>All components are contributed directly to the corresponding module directory on GitHub</li> </ul> <p>Storage, Session, Memory Component Characteristics:</p> <ul> <li>Storage: Provides unified client management, can be shared by Session and Memory</li> <li>Session: Manages temporary session data, can reuse Storage clients</li> <li>Memory: Manages persistent memory data, can reuse Storage clients</li> <li>The three components are decoupled through interfaces, supporting independent implementation and combined usage</li> </ul>"},{"location":"evaluation/","title":"Evaluation Usage Guide","text":"<p>Evaluation provides a comprehensive framework for agent assessment, supporting evaluation data management in both local file and in-memory modes, and offering multi-dimensional evaluation capabilities for agents.</p>"},{"location":"evaluation/#quick-start","title":"Quick Start","text":"<p>This section describes how to execute the Agent evaluation process in local file system or inmemory mode.</p>"},{"location":"evaluation/#local-file-system","title":"Local File System","text":"<p>local maintains evaluation sets, evaluation metrics, and evaluation results on the local file system.</p> <p>For a complete example, see examples/evaluation/local.</p>"},{"location":"evaluation/#code","title":"Code","text":"<pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation\"\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation/evalresult\"\n    evalresultlocal \"trpc.group/trpc-go/trpc-agent-go/evaluation/evalresult/local\"\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation/evalset\"\n    evalsetlocal \"trpc.group/trpc-go/trpc-agent-go/evaluation/evalset/local\"\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation/evaluator/registry\"\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation/metric\"\n    metriclocal \"trpc.group/trpc-go/trpc-agent-go/evaluation/metric/local\"\n    \"trpc.group/trpc-go/trpc-agent-go/runner\"\n)\n\n// Create Runner.\nrunner := runner.NewRunner(appName, agent)\n// Create EvalSet Manager\u3001Metric Manager\u3001EvalResult Manager\u3001Registry.\nevalSetManager := evalsetlocal.New(evalset.WithBaseDir(*inputDir))\nmetricManager := metriclocal.New(metric.WithBaseDir(*inputDir))\nevalResultManager := evalresultlocal.New(evalresult.WithBaseDir(*outputDir))\nregistry := registry.New()\n// Create AgentEvaluator.\nagentEvaluator, err := evaluation.New(\n    appName,\n    runner,\n    evaluation.WithEvalSetManager(evalSetManager),\n    evaluation.WithMetricManager(metricManager),\n    evaluation.WithEvalResultManager(evalResultManager),\n    evaluation.WithRegistry(registry),\n    evaluation.WithNumRuns(numRuns),\n)\nif err != nil {\n    log.Fatalf(\"create evaluator: %v\", err)\n}\n// Perform Evaluation.\nresult, err := agentEvaluator.Evaluate(context.Background(), evalSetID)\nif err != nil {\n    log.Fatalf(\"evaluate: %v\", err)\n}\n</code></pre>"},{"location":"evaluation/#evaluation-set-file-example","title":"Evaluation Set File Example","text":"<pre><code>{\n  \"evalSetId\": \"math-basic\",\n  \"name\": \"math-basic\",\n  \"evalCases\": [\n    {\n      \"evalId\": \"calc_add\",\n      \"conversation\": [\n        {\n          \"invocationId\": \"calc_add-1\",\n          \"userContent\": {\n            \"role\": \"user\",\n            \"content\": \"calc add 2 3\"\n          },\n          \"finalResponse\": {\n            \"role\": \"assistant\",\n            \"content\": \"calc result: 5\"\n          },\n          \"tools\": [\n            {\n              \"id\": \"tool_use_1\",\n              \"name\": \"calculator\",\n              \"arguments\": {\n                \"operation\": \"add\",\n                \"a\": 2,\n                \"b\": 3\n              },\n              \"result\": {\n                \"a\": 2,\n                \"b\": 3,\n                \"operation\": \"add\",\n                \"result\": 5\n              }\n            }\n          ]\n        }\n      ],\n      \"sessionInput\": {\n        \"appName\": \"math-eval-app\",\n        \"userId\": \"user\"\n      }\n    }\n  ],\n  \"creationTimestamp\": 1761134484.9804401\n}\n</code></pre>"},{"location":"evaluation/#evaluation-metric-file-example","title":"Evaluation Metric File Example","text":"<pre><code>[\n  {\n    \"metricName\": \"tool_trajectory_avg_score\",\n    \"threshold\": 1,\n    \"criterion\": {\n      \"toolTrajectory\": {\n        \"orderSensitive\": false,\n        \"defaultStrategy\": {\n          \"name\": {\n            \"matchStrategy\": \"exact\"\n          },\n          \"arguments\": {\n            \"matchStrategy\": \"exact\"\n          },\n          \"result\": {\n            \"matchStrategy\": \"exact\"\n          }\n        }\n      }\n    }\n  }\n]\n</code></pre>"},{"location":"evaluation/#evaluation-result-file-example","title":"Evaluation Result File Example","text":"<pre><code>{\n  \"evalSetResultId\": \"math-eval-app_math-basic_538cdf6e-925d-41cf-943b-2849982b195e\",\n  \"evalSetResultName\": \"math-eval-app_math-basic_538cdf6e-925d-41cf-943b-2849982b195e\",\n  \"evalSetId\": \"math-basic\",\n  \"evalCaseResults\": [\n    {\n      \"evalSetId\": \"math-basic\",\n      \"evalId\": \"calc_add\",\n      \"finalEvalStatus\": \"passed\",\n      \"overallEvalMetricResults\": [\n        {\n          \"metricName\": \"tool_trajectory_avg_score\",\n          \"score\": 1,\n          \"evalStatus\": \"passed\",\n          \"threshold\": 1,\n          \"criterion\": {\n            \"toolTrajectory\": {\n              \"defaultStrategy\": {\n                \"name\": {\n                  \"matchStrategy\": \"exact\"\n                },\n                \"arguments\": {\n                  \"matchStrategy\": \"exact\"\n                },\n                \"result\": {\n                  \"matchStrategy\": \"exact\"\n                }\n              }\n            }\n          },\n          \"details\": {\n            \"score\": 1\n          }\n        }\n      ],\n      \"evalMetricResultPerInvocation\": [\n        {\n          \"actualInvocation\": {\n            \"invocationId\": \"5cc1f162-37e6-4d07-90e9-eb3ec5205b8d\",\n            \"userContent\": {\n              \"role\": \"user\",\n              \"content\": \"calc add 2 3\"\n            },\n            \"finalResponse\": {\n              \"role\": \"assistant\",\n              \"content\": \"The result of 2 + 3 is **5**.\"\n            },\n            \"tools\": [\n              {\n                \"id\": \"call_00_etTEEthmCocxvq7r3m2LJRXf\",\n                \"name\": \"calculator\",\n                \"arguments\": {\n                  \"a\": 2,\n                  \"b\": 3,\n                  \"operation\": \"add\"\n                },\n                \"result\": {\n                  \"a\": 2,\n                  \"b\": 3,\n                  \"operation\": \"add\",\n                  \"result\": 5\n                }\n              }\n            ]\n          },\n          \"expectedInvocation\": {\n            \"invocationId\": \"calc_add-1\",\n            \"userContent\": {\n              \"role\": \"user\",\n              \"content\": \"calc add 2 3\"\n            },\n            \"finalResponse\": {\n              \"role\": \"assistant\",\n              \"content\": \"calc result: 5\"\n            },\n            \"tools\": [\n              {\n                \"id\": \"tool_use_1\",\n                \"name\": \"calculator\",\n                \"arguments\": {\n                  \"a\": 2,\n                  \"b\": 3,\n                  \"operation\": \"add\"\n                },\n                \"result\": {\n                  \"a\": 2,\n                  \"b\": 3,\n                  \"operation\": \"add\",\n                  \"result\": 5\n                }\n              }\n            ]\n          },\n          \"evalMetricResults\": [\n            {\n              \"metricName\": \"tool_trajectory_avg_score\",\n              \"score\": 1,\n              \"evalStatus\": \"passed\",\n              \"threshold\": 1,\n              \"criterion\": {\n                \"toolTrajectory\": {\n                  \"defaultStrategy\": {\n                    \"name\": {\n                      \"matchStrategy\": \"exact\"\n                    },\n                    \"arguments\": {\n                      \"matchStrategy\": \"exact\"\n                    },\n                    \"result\": {\n                      \"matchStrategy\": \"exact\"\n                    }\n                  }\n                }\n              },\n              \"details\": {\n                \"score\": 1\n              }\n            }\n          ]\n        }\n      ],\n      \"sessionId\": \"19877398-9586-4a97-b1d3-f8ce636ea54f\",\n      \"userId\": \"user\"\n    }\n  ],\n  \"creationTimestamp\": 1766455261.342534\n}\n</code></pre>"},{"location":"evaluation/#inmemory","title":"inmemory","text":"<p>inmemory maintains the evaluation set, evaluation metrics, and evaluation results in memory.</p> <p>For a complete example, see examples/evaluation/inmemory.</p>"},{"location":"evaluation/#code_1","title":"Code","text":"<pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation\"\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation/evalresult\"\n    evalresultinmemory \"trpc.group/trpc-go/trpc-agent-go/evaluation/evalresult/inmemory\"\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation/evalset\"\n    evalsetinmemory \"trpc.group/trpc-go/trpc-agent-go/evaluation/evalset/inmemory\"\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation/evaluator/registry\"\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation/metric\"\n    metricinmemory \"trpc.group/trpc-go/trpc-agent-go/evaluation/metric/inmemory\"\n    \"trpc.group/trpc-go/trpc-agent-go/runner\"\n)\n\n// Create Runner.\nrun := runner.NewRunner(appName, agent)\n// Create EvalSet Manager\u3001Metric Manager\u3001EvalResult Manager\u3001Registry.\nevalSetManager := evalsetinmemory.New()\nmetricManager := metricinmemory.New()\nevalResultManager := evalresultinmemory.New()\nregistry := registry.New()\n// Constructing evaluation set data.\nif err := prepareEvalSet(ctx, evalSetManager); err != nil {\n    log.Fatalf(\"prepare eval set: %v\", err)\n}\n// Constructing evaluation metric data.\nif err := prepareMetric(ctx, metricManager); err != nil {\n    log.Fatalf(\"prepare metric: %v\", err)\n}\n// Create AgentEvaluator.\nagentEvaluator, err := evaluation.New(\n    appName,\n    run,\n    evaluation.WithEvalSetManager(evalSetManager),\n    evaluation.WithMetricManager(metricManager),\n    evaluation.WithEvalResultManager(evalResultManager),\n    evaluation.WithRegistry(registry),\n    evaluation.WithNumRuns(numRuns),\n)\nif err != nil {\n    log.Fatalf(\"create evaluator: %v\", err)\n}\n// Perform Evaluation.\nresult, err := agentEvaluator.Evaluate(ctx, evalSetID)\nif err != nil {\n    log.Fatalf(\"evaluate: %v\", err)\n}\n</code></pre>"},{"location":"evaluation/#evalset-construction","title":"EvalSet Construction","text":"<pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/model\"\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation/evalset\"\n)\n\nif _, err := evalSetManager.Create(ctx, appName, evalSetID); err != nil {\n    return err\n}\ncases := []*evalset.EvalCase{\n    {\n        EvalID: \"calc_add\",\n        Conversation: []*evalset.Invocation{\n            {\n                InvocationID: \"calc_add-1\",\n                UserContent: &amp;model.Message{\n                    Role:    model.RoleUser,\n                    Content: \"calc add 2 3\",\n                },\n                FinalResponse: &amp;model.Message{\n                    Role:    model.RoleAssistant,\n                    Content: \"calc result: 5\",\n                },\n                Tools: []*evalset.Tool{\n                    {\n                        ID:   \"tool_use_1\",\n                        Name: \"calculator\",\n                        Arguments: map[string]any{\n                            \"operation\": \"add\",\n                            \"a\":         2,\n                            \"b\":         3,\n                        },\n                        Result: map[string]any{\n                            \"a\":         2,\n                            \"b\":         3,\n                            \"operation\": \"add\",\n                            \"result\":    5,\n                        },\n                    },\n                },\n            },\n        },\n        SessionInput: &amp;evalset.SessionInput{\n            AppName: appName,\n            UserID:  \"user\",\n        },\n    },\n}\nfor _, evalCase := range cases {\n    if err := evalSetManager.AddCase(ctx, appName, evalSetID, evalCase); err != nil {\n        return err\n    }\n}\n</code></pre>"},{"location":"evaluation/#metric-construction","title":"Metric Construction","text":"<pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation/metric\"\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation/metric/criterion\"\n    cjson \"trpc.group/trpc-go/trpc-agent-go/evaluation/metric/criterion/json\"\n    ctext \"trpc.group/trpc-go/trpc-agent-go/evaluation/metric/criterion/text\"\n    ctooltrajectory \"trpc.group/trpc-go/trpc-agent-go/evaluation/metric/criterion/tooltrajectory\"\n)\n\nevalMetric := &amp;metric.EvalMetric{\n    MetricName: \"tool_trajectory_avg_score\",\n    Threshold:  1.0,\n    Criterion: criterion.New(\n        criterion.WithToolTrajectory(\n            ctooltrajectory.New(\n                ctooltrajectory.WithDefault(\n                    &amp;ctooltrajectory.ToolTrajectoryStrategy{\n                        Name: &amp;ctext.TextCriterion{\n                            MatchStrategy: ctext.TextMatchStrategyExact,\n                        },\n                        Arguments: &amp;cjson.JSONCriterion{\n                            MatchStrategy: cjson.JSONMatchStrategyExact,\n                        },\n                        Result: &amp;cjson.JSONCriterion{\n                            MatchStrategy: cjson.JSONMatchStrategyExact,\n                        },\n                    },\n                ),\n            ),\n        ),\n    ),\n}\nmetricManager.Add(ctx, appName, evalSetID, evalMetric)\n</code></pre>"},{"location":"evaluation/#core-concepts","title":"Core Concepts","text":"<ul> <li>The EvalSet provides the dataset required for evaluation, including user input and its corresponding expected agent output.</li> <li>The Metric defines the metric used to measure model performance, including the metric name and corresponding score threshold.</li> <li>The Evaluator compares the actual session results with the expected session results, calculates the specific score, and determines the evaluation status based on the metric threshold.</li> <li>The Evaluator Registry maintains the mapping between metric names and corresponding evaluators and supports dynamic registration and search of evaluators.</li> <li>The Evaluation Service, as a core component, integrates the Agent to be evaluated, the EvalSet, the Metric, the Evaluator Registry, and the EvalResult Registry. The evaluation process is divided into two phases:<ul> <li>Inference: Extracting user input from the EvalSet, invoking the Agent to perform inference, and combining the Agent's actual output with the expected output to form the inference result. </li> <li>Result Evaluation Phase: Evaluate retrieves the corresponding evaluator from the registry based on the evaluation metric name. Multiple evaluators are used to perform a multi-dimensional evaluation of the inference results, ultimately generating the evaluation result, EvalResult.</li> </ul> </li> <li>Agent Evaluator: To reduce the randomness of the agent's output, the evaluation service is called NumRuns times and aggregates the results to obtain a more stable evaluation result.</li> </ul>"},{"location":"evaluation/#evalset","title":"EvalSet","text":"<p>An EvalSet is a collection of EvalCase instances, identified by a unique EvalSetID, serving as session data within the evaluation process.</p> <p>An EvalCase represents a set of evaluation cases within the same Session and includes a unique identifier (EvalID), the conversation content, and session initialization information.</p> <p>Conversation data includes three types of content:</p> <ul> <li>User input</li> <li>Agent final response</li> <li>Tool invocation and result</li> <li>Intermediate response information</li> </ul> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation/epochtime\"\n    \"trpc.group/trpc-go/trpc-agent-go/model\"\n)\n\n// EvalSet represents an evaluation set.\ntype EvalSet struct {\n    EvalSetID         string               // Unique identifier of the evaluation set.\n    Name              string               // Evaluation set name.\n    Description       string               // Evaluation set description.\n    EvalCases         []*EvalCase          // All evaluation cases.\n    CreationTimestamp *epochtime.EpochTime // Creation time.\n}\n\n// EvalCase represents a single evaluation case.\ntype EvalCase struct {\n    EvalID            string               // Unique identifier of the case.\n    Conversation      []*Invocation        // Conversation sequence.\n    SessionInput      *SessionInput        // Session initialization data.\n    CreationTimestamp *epochtime.EpochTime // Creation time.\n}\n\n// Invocation represents a user-agent interaction.\ntype Invocation struct {\n    InvocationID          string\n    UserContent           *model.Message       // User input.\n    FinalResponse         *model.Message       // Agent final response.\n    Tools                 []*Tool              // Tool calls and results.\n    IntermediateResponses []*model.Message     // Intermediate responses.\n    CreationTimestamp     *epochtime.EpochTime // Creation time.\n}\n\n// Tool represents a single tool invocation and its execution result.\ntype Tool struct {\n    ID        string         // Tool invocation ID.\n    Name      string         // Tool name.\n    Arguments map[string]any // Tool invocation parameters.\n    Result    map[string]any // Tool execution result.\n}\n\n// SessionInput represents session initialization input.\ntype SessionInput struct {\n    AppName string         // Application name.\n    UserID  string         // User ID.\n    State   map[string]any // Initial state.\n}\n</code></pre> <p>The EvalSet Manager is responsible for performing operations such as adding, deleting, modifying, and querying evaluation sets. The interface definition is as follows:</p> <pre><code>type Manager interface {\n    // Get the specified EvalSet.\n    Get(ctx context.Context, appName, evalSetID string) (*EvalSet, error)\n    // Create a new EvalSet.\n    Create(ctx context.Context, appName, evalSetID string) (*EvalSet, error)\n    // List all EvalSet IDs.\n    List(ctx context.Context, appName string) ([]string, error)\n    // Delete the specified EvalSet.\n    Delete(ctx context.Context, appName, evalSetID string) error\n    // Get the specified case.\n    GetCase(ctx context.Context, appName, evalSetID, evalCaseID string) (*EvalCase, error)\n    // Add a case to the evaluation set.\n    AddCase(ctx context.Context, appName, evalSetID string, evalCase *EvalCase) error\n    // Update a case.\n    UpdateCase(ctx context.Context, appName, evalSetID string, evalCase *EvalCase) error\n    // Delete case.\n    DeleteCase(ctx context.Context, appName, evalSetID, evalCaseID string) error\n}\n</code></pre> <p>The framework provides two implementations of the EvalSet Manager:</p> <ul> <li>local: Stores the evaluation set in the local file system, with a file name format of <code>&lt;EvalSetID&gt;.evalset.json</code>.</li> <li>inmemory: Stores the evaluation set in memory, ensuring a deep copy of all operations. This is suitable for temporary testing scenarios.</li> </ul>"},{"location":"evaluation/#metric","title":"Metric","text":"<p>Metric represents an evaluation indicator used to measure a certain aspect of EvalSet\u2019s performance. Each evaluation indicator includes the metric name, evaluation criterion, and score threshold.</p> <p>During the evaluation process, the evaluator compares the actual conversation with the expected conversation according to the configured evaluation criterion, calculates the evaluation score for this metric, and compares it with the threshold:</p> <ul> <li>When the evaluation score is lower than the threshold, the metric is determined as not passed.</li> <li>When the evaluation score reaches or exceeds the threshold, the metric is determined as passed.</li> </ul> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation/metric/criterion\"\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation/metric/criterion/tooltrajectory\"\n)\n\n// EvalMetric represents a single metric used to evaluate an EvalCase.\ntype EvalMetric struct {\n    MetricName string               // Metric name.\n    Threshold  float64              // Score threshold.\n    Criterion  *criterion.Criterion // Evaluation criterion.\n}\n\n// Criterion aggregates various evaluation criteria.\ntype Criterion struct {\n    ToolTrajectory *tooltrajectory.ToolTrajectoryCriterion // Tool trajectory evaluation criterion.\n}\n</code></pre> <p>The Metric Manager is responsible for managing evaluation metrics.</p> <p>Each EvalSet can have multiple evaluation metrics, identified by <code>MetricName</code>.</p> <p>The interface definition is as follows:</p> <pre><code>type Manager interface {\n    // Returns all metric names for a specified EvalSet.\n    List(ctx context.Context, appName, evalSetID string) ([]string, error)\n    // Gets a single metric from a specified EvalSet.\n    Get(ctx context.Context, appName, evalSetID, metricName string) (*EvalMetric, error)\n    // Adds the metric to a specified EvalSet.\n    Add(ctx context.Context, appName, evalSetID string, metric *EvalMetric) error\n    // Deletes the specified metric.\n    Delete(ctx context.Context, appName, evalSetID, metricName string) error\n    // Updates the specified metric.\n    Update(ctx context.Context, appName, evalSetID string, metric *EvalMetric) error\n}\n</code></pre> <p>The framework provides two implementations of the Metric Manager:</p> <ul> <li>local: Stores evaluation metrics in the local file system, with file names in the format <code>&lt;EvalSetID&gt;.metric.json</code>.</li> <li>inmemory: Stores evaluation metrics in memory, ensuring a deep copy for all operations. Suitable for temporary testing or quick verification scenarios.</li> </ul>"},{"location":"evaluation/#evaluator","title":"Evaluator","text":"<p>The Evaluator calculates the final evaluation result based on actual sessions, expected sessions, and the evaluation metric.</p> <p>The Evaluator outputs the following:</p> <ul> <li>Overall evaluation score</li> <li>Overall evaluation status</li> <li>A list of session-by-session evaluation results</li> </ul> <p>The evaluation results for a single session include:</p> <ul> <li>Actual sessions</li> <li>Expected sessions</li> <li>Evaluation score</li> <li>Evaluation status</li> </ul> <p>The evaluation status is typically determined by both the score and the metric threshold:</p> <ul> <li>If the evaluation score \u2265 the metric threshold, the status is Passed</li> <li>If the evaluation score &lt; the metric threshold, the status is Failed</li> </ul> <p>Note: The evaluator name <code>Evaluator.Name()</code> must match the evaluation metric name <code>metric.MetricName</code>.</p> <p>The Evaluator interface is defined as follows:</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation/evalset\"\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation/metric\"\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation/status\"\n)\n\n// Evaluator defines the general interface for evaluators.\ntype Evaluator interface {\n    // Name returns the evaluator name.\n    Name() string\n    // Description returns the evaluator description.\n    Description() string\n    // Evaluate executes the evaluation logic, compares the actual and expected sessions, and returns the result.\n    Evaluate(ctx context.Context, actuals, expecteds []*evalset.Invocation,\n        evalMetric *metric.EvalMetric) (*EvaluateResult, error)\n}\n\n// EvaluateResult represents the aggregated results of the evaluator across multiple sessions.\ntype EvaluateResult struct {\n    OverallScore         float64               // Overall score.\n    OverallStatus        status.EvalStatus     // Overall status, categorized as passed/failed/not evaluated.\n    PerInvocationResults []PerInvocationResult // Evaluation results for a single session.\n}\n\n// PerInvocationResult represents the evaluation results for a single session.\ntype PerInvocationResult struct {\n    ActualInvocation   *evalset.Invocation // Actual session.\n    ExpectedInvocation *evalset.Invocation // Expected session.\n    Score              float64             // Current session score.\n    Status             status.EvalStatus   // Current session status.\n}\n</code></pre>"},{"location":"evaluation/#registry","title":"Registry","text":"<p>Registry is used to centrally manage and access various evaluators.</p> <p>Methods include:</p> <ul> <li><code>Register(name string, e Evaluator)</code>: Registers an evaluator with a specified name.</li> <li><code>Get(name string)</code>: Gets an evaluator instance by name.</li> </ul> <pre><code>import \"trpc.group/trpc-go/trpc-agent-go/evaluation/evaluator\"\n\n// Registry defines the evaluator registry interface.\ntype Registry interface {\n    // Register registers an evaluator with the global registry.\n    Register(name string, e evaluator.Evaluator) error\n    // Get gets an instance by evaluator name.\n    Get(name string) (evaluator.Evaluator, error)\n}\n</code></pre> <p>The framework registers the following evaluators by default:</p> <ul> <li><code>tool_trajectory_avg_score</code> tool trajectory consistency evaluator.<ul> <li>For a single session:<ul> <li>If the actual tool call sequence is exactly the same as the expected one, a score of 1 is assigned;</li> <li>If not, a score of 0 is assigned.</li> </ul> </li> </ul> </li> <li>For multiple sessions: The final score is calculated by averaging the scores from each session.</li> </ul>"},{"location":"evaluation/#evalresult","title":"EvalResult","text":"<p>The EvalResult module is used to record and manage evaluation result data.</p> <p>EvalSetResult records the evaluation results of an evaluation set (EvalSetID) and contains multiple EvalCaseResults, which display the execution status and score details of each evaluation case.</p> <p><pre><code>import \"trpc.group/trpc-go/trpc-agent-go/evaluation/internal/epochtime\"\n\n// EvalSetResult represents the overall evaluation result of the evaluation set.\ntype EvalSetResult struct {\n    EvalSetResultID   string               // Unique identifier of the evaluation result.\n    EvalSetResultName string               // Evaluation result name.\n    EvalSetID         string               // Corresponding evaluation set ID.\n    EvalCaseResults   []*EvalCaseResult    // Results of each evaluation case.\n    CreationTimestamp *epochtime.EpochTime // Result creation time.\n}\n</code></pre> EvalCaseResult represents the evaluation result of a single evaluation case, including the overall evaluation status, scores for each indicator, and evaluation details for each round of dialogue.</p> <pre><code>import \"trpc.group/trpc-go/trpc-agent-go/evaluation/status\"\n\n// EvalCaseResult represents the evaluation result of a single evaluation case.\ntype EvalCaseResult struct {\n    EvalSetID                     string                           // Evaluation set ID.\n    EvalID                        string                           // Unique identifier of the case.\n    FinalEvalStatus               status.EvalStatus                // Final evaluation status of the case.\n    OverallEvalMetricResults      []*EvalMetricResult              // Overall score for each metric.\n    EvalMetricResultPerInvocation []*EvalMetricResultPerInvocation // Metric evaluation results per invocation.\n    SessionID                     string                           // Session ID generated during the inference phase.\n    UserID                        string                           // User ID used during the inference phase.\n}\n</code></pre> <p>EvalMetricResult represents the evaluation result of a specific metric, including the score, status, threshold, and additional information.</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation/metric/criterion\"\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation/status\"\n)\n\n// EvalMetricResult represents the evaluation result of a single metric.\ntype EvalMetricResult struct {\n    MetricName string               // Metric name.\n    Score      float64              // Actual score.\n    EvalStatus status.EvalStatus    // Evaluation status.\n    Threshold  float64              // Score threshold.\n    Criterion  *criterion.Criterion // Evaluation criterion.\n    Details    map[string]any       // Additional information, such as scoring process, error description, etc.\n}\n</code></pre> <p>EvalMetricResultPerInvocation represents the metric-by-metric evaluation result of a single conversation turn, used to analyze the performance differences of a specific conversation under different metrics.</p> <pre><code>import \"trpc.group/trpc-go/trpc-agent-go/evaluation/evalset\"\n\n// EvalMetricResultPerInvocation represents the metric-by-metric evaluation results for a single conversation.\ntype EvalMetricResultPerInvocation struct {\n    ActualInvocation   *evalset.Invocation // Actual conversation executed.\n    ExpectedInvocation *evalset.Invocation // Expected conversation result.\n    EvalMetricResults  []*EvalMetricResult // Evaluation results for each metric.\n}\n</code></pre> <p>The EvalResult Manager manages the storage, query, and list operations of evaluation results. The interface definition is as follows:</p> <pre><code>// Manager defines the management interface for evaluation results.\ntype Manager interface {\n    // Save saves the evaluation result and returns the EvalSetResultID.\n    Save(ctx context.Context, appName string, evalSetResult *EvalSetResult) (string, error)\n    // Get retrieves the specified evaluation result based on the evalSetResultID.\n    Get(ctx context.Context, appName, evalSetResultID string) (*EvalSetResult, error)\n    // List returns all evaluation result IDs for the specified application.\n    List(ctx context.Context, appName string) ([]string, error)\n}\n</code></pre> <p>The framework provides two implementations of the EvalResult Manager:</p> <ul> <li>local: Stores the evaluation results in the local file system. The default file name format is <code>&lt;EvalSetResultID&gt;.evalset_result.json</code>. The default naming convention for <code>EvalSetResultID</code> is <code>&lt;appName&gt;_&lt;EvalSetID&gt;_&lt;UUID&gt;</code>.</li> <li>inmemory: Stores the evaluation results in memory. All operations ensure a deep copy, which is suitable for debugging and quick verification scenarios.</li> </ul>"},{"location":"evaluation/#service","title":"Service","text":"<p>Service is an evaluation service that integrates the following modules:</p> <ul> <li>EvalSet</li> <li>Metric</li> <li>Registry</li> <li>Evaluator</li> <li>EvalSetResult</li> </ul> <p>The Service interface defines the complete evaluation process, including the inference and evaluation phases. The interface definition is as follows:</p> <pre><code>import \"trpc.group/trpc-go/trpc-agent-go/evaluation/evalset\"\n\n// Service defines the core interface of the evaluation service.\ntype Service interface {\n    // Inference performs inference, calls the Agent to process the specified evaluation case, \n    // and returns the inference result.\n    Inference(ctx context.Context, request *InferenceRequest) ([]*InferenceResult, error)\n    // Evaluate evaluates the inference result, generates and persists the evaluation result.\n    Evaluate(ctx context.Context, request *EvaluateRequest) (*evalresult.EvalSetResult, error)\n}\n</code></pre> <p>The framework provides a default local evaluation service <code>local</code> implementation for the Service interface: it calls the local Agent to perform reasoning and evaluation locally.</p>"},{"location":"evaluation/#inference","title":"Inference","text":"<p>The inference phase is responsible for running the agent and capturing the actual responses to the test cases.</p> <p>The input is <code>InferenceRequest</code>, and the output is a list of <code>InferenceResult</code>.</p> <pre><code>// InferenceRequest represents an inference request.\ntype InferenceRequest struct {\n    AppName     string   // Application name.\n    EvalSetID   string   // Evaluation set ID.\n    EvalCaseIDs []string // List of evaluation case IDs to be inferred.\n}\n</code></pre> <p>Description:</p> <ul> <li><code>AppName</code> specifies the application name.</li> <li><code>EvalSetID</code> specifies the evaluation set.</li> <li><code>EvalCaseIDs</code> specifies the list of use cases to be evaluated. If left blank, all use cases in the evaluation set are evaluated by default.</li> </ul> <p>During the inference phase, the system sequentially reads the <code>Invocation</code> of each evaluation case, uses the <code>UserContent</code> as user input to invoke the agent, and records the agent's response.</p> <pre><code>import \"trpc.group/trpc-go/trpc-agent-go/evaluation/status\"\n\n// InferenceResult represents the inference result of a single evaluation case.\ntype InferenceResult struct {\n    AppName      string                // Application name.\n    EvalSetID    string                // Evaluation set ID.\n    EvalCaseID   string                // Evaluation case ID.\n    Inferences   []*evalset.Invocation // Session ID for the actual inference.\n    SessionID    string                // Session ID for the inference phase.\n    Status       status.EvalStatus     // Inference status.\n    ErrorMessage string                // Error message if inference fails.\n}\n</code></pre> <p>Note:</p> <ul> <li>Each <code>InferenceResult</code> corresponds to an <code>EvalCase</code>.</li> <li>Since an evaluation set may contain multiple evaluation cases, <code>Inference</code> returns a list of <code>InferenceResult</code>s.</li> </ul>"},{"location":"evaluation/#evaluate","title":"Evaluate","text":"<p>The evaluation phase evaluates inference results. Its input is <code>EvaluateRequest</code>, and its output is the evaluation result <code>EvalSetResult</code>.</p> <pre><code>import \"trpc.group/trpc-go/trpc-agent-go/evaluation/metric\"\n\n// EvaluateRequest represents an evaluation request.\ntype EvaluateRequest struct {\n    AppName          string             // Application name.\n    EvalSetID        string             // Evaluation set ID.\n    InferenceResults []*InferenceResult // Inference phase results.\n    EvaluateConfig   *EvaluateConfig    // Evaluation configuration.\n}\n\n// EvaluateConfig represents the configuration for the evaluation phase.\ntype EvaluateConfig struct {\n    EvalMetrics []*metric.EvalMetric // Metric set to be evaluated.\n}\n</code></pre> <p>Description:</p> <ul> <li>The framework will call the corresponding evaluator based on the configured <code>EvalMetrics</code> to perform evaluation and scoring.</li> <li>Each metric result will be aggregated into the final <code>EvalSetResult</code>.</li> </ul>"},{"location":"evaluation/#agentevaluator","title":"AgentEvaluator","text":"<p><code>AgentEvaluator</code> evaluates an agent based on the configured evaluation set EvalSetID.</p> <pre><code>// AgentEvaluator evaluates an agent based on an evaluation set.\ntype AgentEvaluator interface {\n    // Evaluate evaluates the specified evaluation set.\n    Evaluate(ctx context.Context, evalSetID string) (*EvaluationResult, error)\n}\n</code></pre> <p><code>EvaluationResult</code> represents the final result of a complete evaluation task, including the overall evaluation status, execution time, and a summary of the results of all evaluation cases.</p> <pre><code>import \"trpc.group/trpc-go/trpc-agent-go/evaluation/status\"\n\n// EvaluationResult contains the aggregated results of multiple evaluation runs.\ntype EvaluationResult struct {\n    AppName       string                  // Application name.\n    EvalSetID     string                  // Corresponding evaluation set ID.\n    OverallStatus status.EvalStatus       // Overall evaluation status.\n    ExecutionTime time.Duration           // Execution duration.\n    EvalCases     []*EvaluationCaseResult // Results of each evaluation case.\n}\n</code></pre> <p><code>EvaluationCaseResult</code> aggregates the results of multiple runs of a single evaluation case, including the overall evaluation status, detailed results of each run, and metric-level statistics.</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation/evalresult\"\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation/status\"\n)\n\n// EvaluationCaseResult summarizes the results of a single evaluation case across multiple executions.\ntype EvaluationCaseResult struct {\n    EvalCaseID      string                         // Evaluation case ID.\n    OverallStatus   status.EvalStatus              // Overall evaluation status.\n    EvalCaseResults []*evalresult.EvalCaseResult   // Individual run results.\n    MetricResults   []*evalresult.EvalMetricResult // Metric-level results.\n}\n</code></pre> <p>An <code>AgentEvaluator</code> instance can be created using <code>evaluation.New</code>. By default, it uses the <code>local</code> implementations of the <code>EvalSet Manager</code>, <code>Metric Manager</code>, and <code>EvalResult Manager</code>.</p> <pre><code>import \"trpc.group/trpc-go/trpc-agent-go/evaluation\"\n\nagentEvaluator, err := evaluation.New(appName, runner, evaluation.WithNumRuns(numRuns))\n</code></pre> <p>Because the Agent's execution process may be uncertain, <code>evaluation.WithNumRuns</code> provides a mechanism for multiple evaluation runs to reduce the randomness of a single run.</p> <ul> <li>The default number of runs is 1;</li> <li>By specifying <code>evaluation.WithNumRuns(n)</code>, each evaluation case can be run multiple times;</li> <li>The final result is based on the combined statistical results of multiple runs. The default statistical method is the average of the evaluation scores of multiple runs.</li> </ul>"},{"location":"evaluation/#usage-guide","title":"Usage Guide","text":""},{"location":"evaluation/#local-file-path","title":"Local File Path","text":"<p>There are three types of local files:</p> <ul> <li>EvalSet file</li> <li>Metric file</li> <li>EvalResult file</li> </ul>"},{"location":"evaluation/#evalset-file","title":"EvalSet File","text":"<p>The default path for the evaluation set file is <code>./&lt;AppName&gt;/&lt;EvalSetID&gt;.evalset.json</code>.</p> <p>You can set a custom <code>BaseDir</code> using <code>WithBaseDir</code>, which means the file path will be <code>&lt;BaseDir&gt;/&lt;AppName&gt;/&lt;EvalSetID&gt;.evalset.json</code>.</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation\"\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation/evalset\"\n    evalsetlocal \"trpc.group/trpc-go/trpc-agent-go/evaluation/evalset/local\"\n)\n\nevalSetManager := evalsetlocal.New(evalset.WithBaseDir(\"&lt;BaseDir&gt;\"))\nagentEvaluator, err := evaluation.New(appName, runner, evaluation.WithEvalSetManager(evalSetManager))\n</code></pre> <p>In addition, if the default path structure does not meet your requirements, you can customize the file path rules by implementing the <code>Locator</code> interface. The interface definition is as follows:</p> <pre><code>// Locator is used to define the path generation and enumeration logic for evaluation set files.\ntype Locator interface {\n    // Build specifies the appName and evalSetID Path to the evaluation set file.\n    Build(baseDir, appName, evalSetID string) string\n    // List all evaluation set IDs under the specified appName.\n    List(baseDir, appName string) ([]string, error)\n}\n</code></pre> <p>For example, set the evaluation set file format to <code>custom-&lt;EvalSetID&gt;.evalset.json</code>.</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation\"\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation/evalset\"\n    evalsetlocal \"trpc.group/trpc-go/trpc-agent-go/evaluation/evalset/local\"\n)\n\nevalSetManager := evalsetlocal.New(evalset.WithLocator(&amp;customLocator{}))\nagentEvaluator, err := evaluation.New(appName, runner, evaluation.WithEvalSetManager(evalSetManager))\n\ntype customLocator struct {\n}\n\n// Build returns the custom file path format: &lt;BaseDir&gt;/&lt;AppName&gt;/custom-&lt;EvalSetID&gt;.evalset.json.\nfunc (l *customLocator) Build(baseDir, appName, EvalSetID string) string {\n    return filepath.Join(baseDir, appName, \"custom-\"+evalSetID+\".evalset.json\")\n}\n\n// List lists all evaluation set IDs under the specified app.\nfunc (l *customLocator) List(baseDir, appName string) ([]string, error) {\n    dir := filepath.Join(baseDir, appName)\n    entries, err := os.ReadDir(dir)\n    if err != nil {\n        if errors.Is(err, os.ErrNotExist) {\n            return []string{}, nil\n        }\n        return nil, err\n    }\n    var results []string\n    for _, entry := range entries {\n        if entry.IsDir() {\n            continue\n        }\n        if strings.HasSuffix(entry.Name(), \".evalset.json\") {\n            name := strings.TrimPrefix(entry.Name(), \"custom-\")\n            name = strings.TrimSuffix(name, defaultResultFileSuffix)\n            results = append(results, name)\n        }\n    }\n    return results, nil\n}\n</code></pre>"},{"location":"evaluation/#metric-file","title":"Metric File","text":"<p>The default path for the metrics file is <code>./&lt;AppName&gt;/&lt;EvalSetID&gt;.metrics.json</code>.</p> <p>You can use <code>WithBaseDir</code> to set a custom <code>BaseDir</code>, meaning the file path will be <code>&lt;BaseDir&gt;/&lt;AppName&gt;/&lt;EvalSetID&gt;.metrics.json</code>.</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation\"\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation/metric\"\n    metriclocal \"trpc.group/trpc-go/trpc-agent-go/evaluation/metric/local\"\n)\n\nmetricManager := metriclocal.New(metric.WithBaseDir(\"&lt;BaseDir&gt;\"))\nagentEvaluator, err := evaluation.New(appName, runner, evaluation.WithMetricManager(metricManager))\n</code></pre> <p>In addition, if the default path structure does not meet your requirements, you can customize the file path rules by implementing the <code>Locator</code> interface. The interface definition is as follows:</p> <pre><code>// Locator is used to define the path generation for evaluation metric files.\ntype Locator interface {\n    // Build builds the evaluation metric file path for the specified appName and evalSetID.\n    Build(baseDir, appName, evalSetID string) string\n}\n</code></pre> <p>For example, set the evaluation set file format to <code>custom-&lt;EvalSetID&gt;.metrics.json</code>.</p> <pre><code>import ( \n    \"trpc.group/trpc-go/trpc-agent-go/evaluation\" \n    \"trpc.group/trpc-go/trpc-agent-go/evaluation/metric\" \n    metriclocal \"trpc.group/trpc-go/trpc-agent-go/evaluation/metric/local\"\n)\n\nmetricManager := metriclocal.New(metric.WithLocator(&amp;customLocator{}))\nagentEvaluator, err := evaluation.New(appName, runner, evaluation.WithMetricManager(metricManager))\n\ntype customLocator struct {\n}\n\n// Build returns the custom file path format: &lt;BaseDir&gt;/&lt;AppName&gt;/custom-&lt;EvalSetID&gt;.metrics.json.\nfunc (l *customLocator) Build(baseDir, appName, EvalSetID string) string {\n    return filepath.Join(baseDir, appName, \"custom-\"+evalSetID+\".metrics.json\")\n}\n</code></pre>"},{"location":"evaluation/#evalresult-file","title":"EvalResult File","text":"<p>The default path for the evaluation result file is <code>./&lt;AppName&gt;/&lt;EvalSetResultID&gt;.evalresult.json</code>.</p> <p>You can set a custom <code>BaseDir</code> using <code>WithBaseDir</code>. For example, the file path will be <code>&lt;BaseDir&gt;/&lt;AppName&gt;/&lt;EvalSetResultID&gt;.evalresult.json</code>. The default naming convention for <code>EvalSetResultID</code> is <code>&lt;appName&gt;_&lt;EvalSetID&gt;_&lt;UUID&gt;</code>.</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation\"\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation/evalresult\"\n    evalresultlocal \"trpc.group/trpc-go/trpc-agent-go/evaluation/evalresult/local\"\n)\n\nevalResultManager := evalresultlocal.New(evalresult.WithBaseDir(\"&lt;BaseDir&gt;\"))\nagentEvaluator, err := evaluation.New(appName, runner, evaluation.WithEvalResultManager(evalResultManager))\n</code></pre> <p>In addition, if the default path structure does not meet your requirements, you can customize the file path rules by implementing the <code>Locator</code> interface. The interface definition is as follows:</p> <pre><code>// Locator is used to define the path generation and enumeration logic for evaluation result files.\ntype Locator interface {\n    // Build the specified appName and The evaluation result file path for the evalSetResultID.\n    Build(baseDir, appName, evalSetResultID string) string\n    // List all evaluation result IDs under the specified appName.\n    List(baseDir, appName string) ([]string, error)\n}\n</code></pre> <p>For example, set the evaluation result file format to <code>custom-&lt;EvalSetResultID&gt;.evalresult.json</code>.</p> <pre><code>import ( \n    \"trpc.group/trpc-go/trpc-agent-go/evaluation\" \n    \"trpc.group/trpc-go/trpc-agent-go/evaluation/evalresult\" \n    evalresultlocal \"trpc.group/trpc-go/trpc-agent-go/evaluation/evalresult/local\"\n)\n\nevalResultManager := evalresultlocal.New(evalresult.WithLocator(&amp;customLocator{}))\nagentEvaluator, err := evaluation.New(appName, runner, evaluation.WithEvalResultManager(evalResultManager))\n\ntype customLocator struct {\n}\n\n// Build returns the custom file path format: &lt;BaseDir&gt;/&lt;AppName&gt;/custom-&lt;EvalSetResultID&gt;.evalresult.json.\nfunc (l *customLocator) Build(baseDir, appName, evalSetResultID string) string {\n    return filepath.Join(baseDir, appName, \"custom-\"+evalSetResultID+\".evalresult.json\")\n}\n\n// List lists all evaluation result IDs under the specified app.\nfunc (l *customLocator) List(baseDir, appName string) ([]string, error) {\n    dir := filepath.Join(baseDir, appName)\n    entries, err := os.ReadDir(dir)\n    if err != nil {\n        if errors.Is(err, os.ErrNotExist) {\n            return []string{}, nil\n        }\n        return nil, err\n    }\n    var results []string\n    for _, entry := range entries {\n        if entry.IsDir() {\n            continue\n        }\n        if strings.HasSuffix(entry.Name(), \".evalresult.json\") {\n            name := strings.TrimPrefix(entry.Name(), \"custom-\")\n            name = strings.TrimSuffix(name, \".evalresult.json\")\n            results = append(results, name)\n        }\n    }\n    return results, nil\n}\n</code></pre>"},{"location":"evaluation/#evaluation-criterion","title":"Evaluation Criterion","text":"<p>The evaluation criterion describes the specific evaluation method and can be combined as needed.</p> <p>The framework has the following built-in types of evaluation criteria:</p> Criterion Type Applicable Object TextCriterion Text string JSONCriterion JSON object, usually used to compare <code>map[string]any</code> ToolTrajectoryCriterion Tool invocation trajectory Criterion Aggregation of multiple criteria"},{"location":"evaluation/#textcriterion","title":"TextCriterion","text":"<p>TextCriterion is used for string matching and can be configured to ignore case and to use a specific matching strategy.</p> <pre><code>// TextCriterion defines the matching method for strings.\ntype TextCriterion struct {\n    Ignore          bool              // Whether to skip matching.\n    CaseInsensitive bool              // Whether case-insensitive.\n    MatchStrategy   TextMatchStrategy // Matching strategy.\n    Compare         func(actual, expected string) (bool, error) // Custom comparison.\n}\n</code></pre> <p>Explanation of TextMatchStrategy values:</p> TextMatchStrategy Value Description exact The actual string is exactly the same as the expected string (default). contains The actual string contains the expected string. regex The actual string matches the expected string as a regular expression."},{"location":"evaluation/#jsoncriterion","title":"JSONCriterion","text":"<p>JSONCriterion is used to compare structured JSON data. You can configure whether to ignore the comparison and choose a specific matching strategy.</p> <pre><code>// JSONCriterion defines the matching method for JSON objects.\ntype JSONCriterion struct {\n    Ignore          bool                                                // Whether to skip matching.\n    IgnoreTree      map[string]any                                      // Ignore tree; a true leaf skips the key and its subtree.\n    NumberTolerance *float64                                            // Numeric tolerance; default is 1e-6, 0 means exact; applied to numeric leaf values.\n    MatchStrategy   JSONMatchStrategy                                   // Matching strategy.\n    Compare         func(actual, expected map[string]any) (bool, error) // Custom comparison.\n}\n</code></pre> <p>Explanation of JSONMatchStrategy values:</p> JSONMatchStrategy Value Description exact The actual JSON is exactly the same as the expected JSON (default). <p><code>IgnoreTree</code> lets you skip specific fields and their subtrees while checking the remaining fields.</p> <p>For example, ignore <code>metadata.updatedAt</code> but verify other fields:</p> <pre><code>criterion := &amp;json.JSONCriterion{\n    IgnoreTree: map[string]any{\n        \"metadata\": map[string]any{\n            \"updatedAt\": true,\n        },\n    },\n    NumberTolerance: 1e-6,\n}\n</code></pre> <p>Configuration file example:</p> <pre><code>[\n  {\n    \"metricName\": \"tool_trajectory_avg_score\",\n    \"threshold\": 1,\n    \"criterion\": {\n      \"toolTrajectory\": {\n        \"orderSensitive\": false,\n        \"defaultStrategy\": {\n          \"name\": {\n            \"matchStrategy\": \"exact\"\n          },\n          \"arguments\": {\n            \"matchStrategy\": \"exact\",\n            \"numberTolerance\": 1e-6,\n          },\n          \"result\": {\n            \"matchStrategy\": \"exact\",\n            \"numberTolerance\": 1e-6,\n            \"ignoreTree\": {\n              \"metadata\": {\n                \"updatedAt\": true\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n]\n</code></pre>"},{"location":"evaluation/#tooltrajectorycriterion","title":"ToolTrajectoryCriterion","text":"<p>ToolTrajectoryCriterion is used to configure the evaluation criteria for tool invocations and results. You can set default strategies, customize strategies by tool name, and control whether invocation order must be preserved.</p> <pre><code>// ToolTrajectoryCriterion defines the evaluation criteria for tool invocations and results.\ntype ToolTrajectoryCriterion struct {\n    DefaultStrategy *ToolTrajectoryStrategy                                  // Default strategy.\n    ToolStrategy    map[string]*ToolTrajectoryStrategy                       // Customized strategies by tool name.\n    OrderSensitive  bool                                                     // Whether to require strict order matching.\n    SubsetMatching  bool                                                     // Whether expected calls can be a subset of actual.\n    Compare         func(actual, expected *evalset.Invocation) (bool, error) // Custom comparison.\n}\n\n// ToolTrajectoryStrategy defines the matching strategy for a single tool.\ntype ToolTrajectoryStrategy struct {\n    Name      *TextCriterion // Tool name matching.\n    Arguments *JSONCriterion // Invocation arguments matching.\n    Result    *JSONCriterion // Tool result matching.\n}\n</code></pre> <p>DefaultStrategy is used to configure the global default evaluation criterion and applies to all tools.</p> <p>ToolStrategy overrides the evaluation criterion for specific tools by tool name. When ToolStrategy is not set, all tool invocations use DefaultStrategy.</p> <p>If no evaluation criterion is configured, the framework uses the default evaluation criterion: tool names are compared using TextCriterion with the <code>exact</code> strategy, and arguments and results are compared using JSONCriterion with the <code>exact</code> strategy. This ensures that tool trajectory evaluation always has a reasonable fallback behavior.</p> <p>The following example illustrates a typical scenario: for most tools you want strict alignment of tool invocations and results, but for time-related tools such as <code>current_time</code>, the response value itself is unstable. Therefore, you only need to check whether the correct tool and arguments were invoked as expected, without requiring the time value itself to be exactly the same.</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation/metric/criterion\"\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation/metric/criterion/json\"\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation/metric/criterion/text\"\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation/metric/criterion/tooltrajectory\"\n)\n\ncriterion := criterion.New(\n    criterion.WithToolTrajectory(\n        tooltrajectory.New(\n            tooltrajectory.WithDefault(\n                &amp;tooltrajectory.ToolTrajectoryStrategy{\n                    Name: &amp;text.TextCriterion{\n                        MatchStrategy: text.TextMatchStrategyExact,\n                    },\n                    Arguments: &amp;json.JSONCriterion{\n                        MatchStrategy: json.JSONMatchStrategyExact,\n                    },\n                    Result: &amp;json.JSONCriterion{\n                        MatchStrategy: json.JSONMatchStrategyExact,\n                    },\n                },\n            ),\n            tooltrajectory.WithTool(map[string]*tooltrajectory.ToolTrajectoryStrategy{\n                \"current_time\": {\n                    Name: &amp;text.TextCriterion{\n                        MatchStrategy: text.TextMatchStrategyExact,\n                    },\n                    Arguments: &amp;json.JSONCriterion{\n                        MatchStrategy: json.JSONMatchStrategyExact,\n                    },\n                    Result: &amp;json.JSONCriterion{\n                        Ignore: true, // Ignore matching of this tool's result.\n                    },\n                },\n            }),\n        ),\n    ),\n)\n</code></pre> <p>By default, tool invocation matching is order-insensitive. Each expected tool attempts to pair with any actual tool that satisfies the strategy, and a single actual invocation will not be reused. Matching passes when all expected tools find a partner. Specifically, the evaluator builds a bipartite graph with expected invocations as left nodes and actual invocations as right nodes; for every expected/actual pair that satisfies the tool strategy, it adds an edge. It then uses the Kuhn algorithm to compute the maximum matching and checks unmatched expected nodes. If every expected node is matched, tool matching passes; otherwise, the unmatched expected nodes are returned.</p> <p>If you want to strictly compare in the order tools appear, enable <code>WithOrderSensitive(true)</code>. The evaluator scans the expected and actual lists in order and fails if an expected invocation cannot find a matching actual invocation.</p> <pre><code>criterion := criterion.New(\n    criterion.WithToolTrajectory(\n        ctooltrajectory.New(\n            ctooltrajectory.WithOrderSensitive(true), // Enable order-sensitive matching.\n        ),\n    ),\n)\n</code></pre> <p>Configuration example for strict order matching:</p> <pre><code>[\n  {\n    \"metricName\": \"tool_trajectory_avg_score\",\n    \"threshold\": 1,\n    \"criterion\": {\n      \"toolTrajectory\": {\n        \"orderSensitive\": true,\n        \"defaultStrategy\": {\n          \"name\": {\n            \"matchStrategy\": \"exact\"\n          },\n          \"arguments\": {\n            \"matchStrategy\": \"exact\"\n          },\n          \"result\": {\n            \"matchStrategy\": \"exact\"\n          }\n        }\n      }\n    }\n  }\n]\n</code></pre> <p>SubsetMatching controls whether the expected tool sequence can be just a subset of the actual tool sequence. It is off by default.</p> <ul> <li>Off: the expected and actual tool call counts must be the same.</li> <li>On: the actual sequence may be longer, allowing the expected tools to be a subset of the actual tools.</li> </ul> <pre><code>criterion := criterion.New(\n    criterion.WithToolTrajectory(\n        ctooltrajectory.New(\n            ctooltrajectory.WithSubsetMatching(true),\n        ),\n    ),\n)\n</code></pre> <p>Configuration example with subset matching:</p> <pre><code>[\n  {\n    \"metricName\": \"tool_trajectory_avg_score\",\n    \"threshold\": 1,\n    \"criterion\": {\n      \"toolTrajectory\": {\n        \"subsetMatching\": true,\n        \"defaultStrategy\": {\n          \"name\": {\n            \"matchStrategy\": \"exact\"\n          },\n          \"arguments\": {\n            \"matchStrategy\": \"exact\"\n          },\n          \"result\": {\n            \"matchStrategy\": \"exact\"\n          }\n        }\n      }\n    }\n  }\n]\n</code></pre> <p>Assume <code>A</code>, <code>B</code>, <code>C</code>, and <code>D</code> each denote one tool call. Matching examples:</p> SubsetMatching OrderSensitive Expected Actual Result Note Off Off <code>[A]</code> <code>[A, B]</code> Mismatch Count differs On Off <code>[A]</code> <code>[A, B]</code> Match Expected is subset On Off <code>[C, A]</code> <code>[A, B, C]</code> Match Expected is subset with order-insensitive matching On On <code>[A, C]</code> <code>[A, B, C]</code> Match Expected is subset and order matches On On <code>[C, A]</code> <code>[A, B, C]</code> Mismatch Order not satisfied On Off <code>[C, D]</code> <code>[A, B, C]</code> Mismatch Actual tool sequence missing D Any Any <code>[A, A]</code> <code>[A]</code> Mismatch Actual calls insufficient; a single call cannot be reused"},{"location":"evaluation/#evaluator_1","title":"Evaluator","text":""},{"location":"evaluation/#tool-trajectory-evaluator","title":"Tool Trajectory Evaluator","text":"<p>The metric name corresponding to the tool trajectory evaluator is <code>tool_trajectory_avg_score</code>. It is used to evaluate whether the Agent\u2019s use of tools across multiple conversations conforms to expectations.</p> <p>In a single conversation, the evaluator compares the actual tool invocation trajectory with the expected trajectory using <code>ToolTrajectoryCriterion</code>:</p> <ul> <li>If the entire tool invocation trajectory satisfies the evaluation criterion, the score of this conversation on this metric is 1.</li> <li>If any step of the invocation does not satisfy the evaluation criterion, the score of this conversation on this metric is 0.</li> </ul> <p>In the scenario of multiple conversations, the evaluator takes the average of the scores of all conversations on this metric as the final <code>tool_trajectory_avg_score</code>, and compares it with <code>EvalMetric.Threshold</code> to determine whether the result is pass or fail.</p> <p>A typical way to combine the tool trajectory evaluator with Metric and Criterion is as follows:</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation/metric\"\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation/metric/criterion\"\n    ctooltrajectory \"trpc.group/trpc-go/trpc-agent-go/evaluation/metric/criterion/tooltrajectory\"\n)\n\nevalMetric := &amp;metric.EvalMetric{\n    MetricName: \"tool_trajectory_avg_score\",\n    Threshold:  1.0,\n    Criterion: criterion.New(\n        criterion.WithToolTrajectory(\n            // Use the default evaluation criterion; tool name, arguments, and result must be strictly identical.\n            ctooltrajectory.New(),\n        ),\n    ),\n}\n</code></pre> <p>For a complete example, see examples/evaluation/tooltrajectory.</p>"},{"location":"event/","title":"Event Usage Documentation","text":"<p>Event is the core communication mechanism between Agent and users in trpc-agent-go. It's like a message envelope that carries Agent response content, tool call results, error information, etc. Through Event, you can understand Agent's working status in real-time, handle streaming responses, implement multi-Agent collaboration, and track tool execution.</p>"},{"location":"event/#event-overview","title":"Event Overview","text":"<p>Event is the carrier for communication between Agent and users.</p> <p>Users obtain event streams through the <code>runner.Run()</code> method, then listen to event channels to handle Agent responses.</p>"},{"location":"event/#event-structure","title":"Event Structure","text":"<p><code>Event</code> represents an event between Agent and users, with the following structure definition:</p> <pre><code>type Event struct {\n    // Response is the basic response structure of Event, carrying LLM responses.\n    *model.Response\n    // RequestID The unique identifier for this request.\n    // It can be passed via runner.Run using agent.WithRequestID.\n    RequestID string `json:\"requestID,omitempty\"`\n\n    // ParentInvocationID is the parent invocation ID of the event.\n    ParentInvocationID string `json:\"parentInvocationId,omitempty\"`\n\n    // InvocationID is current invocation ID of the event.\n    InvocationID string `json:\"invocationId\"`\n\n    // Author is the initiator of the event.\n    Author string `json:\"author\"`\n\n    // ID is the unique identifier of the event.\n    ID string `json:\"id\"`\n\n    // Timestamp is the timestamp of the event.\n    Timestamp time.Time `json:\"timestamp\"`\n\n    // Branch is a branch identifier for multi-Agent collaboration.\n    Branch string `json:\"branch,omitempty\"`\n\n    // RequiresCompletion indicates whether this event requires a completion signal.\n    RequiresCompletion bool `json:\"requiresCompletion,omitempty\"`\n\n    // LongRunningToolIDs is a set of IDs for long-running function calls.\n    // Agent clients will understand which function calls are long-running from this field.\n    // Only valid for function call events.\n    LongRunningToolIDs map[string]struct{} `json:\"longRunningToolIDs,omitempty\"`\n\n    // StateDelta contains state changes to be written to the session.\n    StateDelta map[string][]byte `json:\"stateDelta,omitempty\"`\n\n    // StructuredOutput carries a typed, in-memory structured payload (not serialized).\n    StructuredOutput any `json:\"-\"`\n\n    // Actions carry flow-level hints (e.g., skip post-tool summarization).\n    Actions *EventActions `json:\"actions,omitempty\"`\n}\n\n// EventActions provides optional behavior hints attached to the event.\ntype EventActions struct {\n    // SkipSummarization indicates the flow should not run a summarization LLM call\n    // after a tool.response event.\n    SkipSummarization bool `json:\"skipSummarization,omitempty\"`\n}\n</code></pre> <p><code>model.Response</code> is the basic response structure of Event, carrying LLM responses, tool calls, and error information, defined as follows:</p> <pre><code>type Response struct {\n    // Response unique identifier.\n    ID string `json:\"id\"`\n\n    // Object type (such as \"chat.completion\", \"error\", etc.), helps clients identify processing methods.\n    Object string `json:\"object\"`\n\n    // Creation timestamp.\n    Created int64 `json:\"created\"`\n\n    // Model name used.\n    Model string `json:\"model\"`\n\n    // Response options, LLM may generate multiple candidate responses for user selection, default is 1.\n    Choices []Choice `json:\"choices\"`\n\n    // Usage statistics, records token usage.\n    Usage *Usage `json:\"usage,omitempty\"`\n\n    // System fingerprint.\n    SystemFingerprint *string `json:\"system_fingerprint,omitempty\"`\n\n    // Error information.\n    Error *ResponseError `json:\"error,omitempty\"`\n\n    // Timestamp.\n    Timestamp time.Time `json:\"timestamp\"`\n\n    // Indicates whether the entire conversation is complete.\n    Done bool `json:\"done\"`\n\n    // Whether it's a partial response.\n    IsPartial bool `json:\"is_partial\"`\n}\n\ntype Choice struct {\n    // Choice index.\n    Index int `json:\"index\"`\n\n    // Complete message, contains the entire response.\n    Message Message `json:\"message,omitempty\"`\n\n    // Incremental message, used for streaming responses, only contains new content of current chunk.\n    // For example: complete response \"Hello, how can I help you?\" in streaming response:\n    // First event: Delta.Content = \"Hello\"\n    // Second event: Delta.Content = \", how\"  \n    // Third event: Delta.Content = \" can I help you?\"\n    Delta Message `json:\"delta,omitempty\"`\n\n    // Completion reason.\n    FinishReason *string `json:\"finish_reason,omitempty\"`\n}\n\ntype Message struct {\n    // Role of message initiator, such as \"system\", \"user\", \"assistant\", \"tool\".\n    Role string `json:\"role\"`\n\n    // Message content.\n    Content string `json:\"content\"`\n\n    // Content fragments for multimodal messages.\n    ContentParts []ContentPart `json:\"content_parts,omitempty\"`\n\n    // ID of the tool used by tool response.\n    ToolID string `json:\"tool_id,omitempty\"`\n\n    // Name of the tool used by tool response.\n    ToolName string `json:\"tool_name,omitempty\"`\n\n    // Optional tool calls.\n    ToolCalls []ToolCall `json:\"tool_calls,omitempty\"`\n}\n\ntype Usage struct {\n    // Number of tokens used in prompts.\n    PromptTokens int `json:\"prompt_tokens\"`\n\n    // Number of tokens used in completion.\n    CompletionTokens int `json:\"completion_tokens\"`\n\n    // Total number of tokens used in response.\n    TotalTokens int `json:\"total_tokens\"`\n\n    // Timing statistics (optional).\n    TimingInfo *TimingInfo `json:\"timing_info,omitempty\"`\n}\n\ntype TimingInfo struct {\n    // FirstTokenDuration is the accumulated duration from request start to the first meaningful token.\n    // A \"meaningful token\" is defined as the first chunk containing reasoning content, regular content, or tool calls.\n    //\n    // Return timing:\n    // - Streaming requests: Calculated and returned immediately when the first meaningful chunk is received\n    // - Non-streaming requests: Calculated and returned when the complete response is received\n    FirstTokenDuration time.Duration `json:\"time_to_first_token,omitempty\"`\n\n    // ReasoningDuration is the accumulated duration of reasoning phases (streaming mode only).\n    // Measured from the first reasoning chunk to the last reasoning chunk in each LLM call.\n    //\n    // Measurement details:\n    // - Starts timing when the first chunk with reasoning content is received\n    // - Continues timing for all subsequent reasoning chunks\n    // - Stops timing when the first non-reasoning chunk (regular content or tool call) is received\n    //\n    // Return timing:\n    // - Streaming requests: Calculated and returned immediately when reasoning ends (i.e., when the first\n    //   non-reasoning content/tool call chunk is received)\n    // - Non-streaming requests: Cannot be measured precisely, this field will remain 0\n    ReasoningDuration time.Duration `json:\"reasoning_duration,omitempty\"`\n}\n</code></pre>"},{"location":"event/#event-types","title":"Event Types","text":"<p>Events are created and sent in the following scenarios:</p> <ol> <li>User Message Events: Automatically created when users send messages</li> <li>Agent Response Events: Created when Agent generates responses</li> <li>Streaming Response Events: Created for each response chunk in streaming mode</li> <li>Tool Call Events: Created when Agent calls tools</li> <li>Error Events: Created when errors occur</li> <li>Agent Transfer Events: Created when Agent transfers to other Agents</li> <li>Completion Events: Created when Agent execution completes</li> </ol> <p>Based on the <code>model.Response.Object</code> field, Events can be divided into the following types:</p> <pre><code>const (\n    // Error event.\n    ObjectTypeError = \"error\"\n\n    // Tool response event.\n    ObjectTypeToolResponse = \"tool.response\"\n\n    // Preprocessing events.\n    ObjectTypePreprocessingBasic = \"preprocessing.basic\"\n    ObjectTypePreprocessingContent = \"preprocessing.content\"\n    ObjectTypePreprocessingIdentity = \"preprocessing.identity\"\n    ObjectTypePreprocessingInstruction = \"preprocessing.instruction\"\n    ObjectTypePreprocessingPlanning = \"preprocessing.planning\"\n\n    // Postprocessing events.\n    ObjectTypePostprocessingPlanning = \"postprocessing.planning\"\n    ObjectTypePostprocessingCodeExecution = \"postprocessing.code_execution\"\n\n    // Agent transfer event.\n    ObjectTypeTransfer = \"agent.transfer\"\n\n    // Runner completion event.\n    ObjectTypeRunnerCompletion = \"runner.completion\"\n)\n</code></pre>"},{"location":"event/#filtering-transfer-announcements","title":"Filtering Transfer Announcements","text":"<p>Transfer announcements (Agent delegation notices) are emitted as Events with <code>Response.Object == \"agent.transfer\"</code>.</p> <p>This typically appears as a handoff notice: \"Transferring control to agent: \". <p>If your UI should not display these system-level notices, you have two compatible strategies:  - Filter by <code>Object</code>: hide events where <code>Response.Object == \"agent.transfer\"</code>.  - Filter by <code>Tag</code>: hide events whose <code>Event.Tag</code> contains the <code>transfer</code> tag. The framework adds this tag to delegation-related events (including transfer tool results), so filtering by tag avoids breaking ToolCall/ToolResult alignment.</p> <p>Tags are appended using a semicolon delimiter (<code>;</code>). Use <code>event.WithTag(tag)</code> when creating custom events; multiple tags are stored as <code>tag1;tag2;...</code>.</p>"},{"location":"event/#code-execution-event-tags","title":"Code Execution Event Tags","text":"<p>For code execution related events, use <code>Event.Tag</code> to distinguish between code and execution results:</p> <ul> <li>Code Execution Event: <code>Response.Object == \"postprocessing.code_execution\"</code> and <code>Event.ContainsTag(event.TagCodeExecution)</code></li> <li>Execution Result Event: <code>Response.Object == \"postprocessing.code_execution\"</code> and <code>Event.ContainsTag(event.TagCodeExecutionResult)</code></li> </ul> <p>The related constants are defined in the <code>trpc.group/trpc-go/trpc-agent-go/event</code> package.</p>"},{"location":"event/#helper-detect-runner-completion","title":"Helper: Detect Runner Completion","text":"<p>Use the convenience method to detect when the whole run has finished regardless of Agent type:</p> <pre><code>// e.IsRunnerCompletion() returns true for the terminal runner-completion event.\nif e.IsRunnerCompletion() {\n    // Safe point to stop reading the channel\n}\n</code></pre>"},{"location":"event/#event-creation","title":"Event Creation","text":"<p>When developing custom Agent types or Processors, you need to create Events.</p> <p>Event provides three creation methods, suitable for different scenarios. Prefer these helpers instead of constructing <code>&amp;event.Event{}</code> directly.</p> <pre><code>// Create new event.\nfunc New(invocationID, author string, opts ...Option) *Event\n\n// Create error event.\nfunc NewErrorEvent(invocationID, author, errorType, errorMessage string) *Event\n\n// Create event from response.\nfunc NewResponseEvent(invocationID, author string, response *model.Response) *Event\n</code></pre> <p>Parameter Description:</p> <ul> <li><code>invocationID string</code>: Invocation unique identifier</li> <li><code>author string</code>: Event initiator</li> <li><code>opts ...Option</code>: Optional configuration options (New method only)</li> <li><code>errorType string</code>: Error type (NewErrorEvent method only)</li> <li><code>errorMessage string</code>: Error message (NewErrorEvent method only)</li> <li><code>response *model.Response</code>: Response object (NewResponseEvent method only)</li> </ul> <p>The framework supports the following Options for configuring Event:</p> <ul> <li><code>WithBranch(branch string)</code>: Set event branch identifier</li> <li><code>WithResponse(response *model.Response)</code>: Set event response content</li> <li><code>WithObject(o string)</code>: Set event type</li> </ul> <p>Example: <pre><code>// Create basic event.\nevt := event.New(\"invoke-123\", \"agent\")\n\n// Create event with branch.\nevt := event.New(\"invoke-123\", \"agent\", event.WithBranch(\"main\"))\n\n// Create error event.\nevt := event.NewErrorEvent(\"invoke-123\", \"agent\", \"api_error\", \"Request timeout\")\n\n// Create event from response.\nresponse := &amp;model.Response{\n    Object: \"chat.completion\",\n    Done:   true,\n    Choices: []model.Choice{{Message: model.Message{Role: \"assistant\", Content: \"Hello!\"}}},\n}\nevt := event.NewResponseEvent(\"invoke-123\", \"agent\", response)\n</code></pre></p>"},{"location":"event/#tool-response-streaming-including-agenttool-forwarding","title":"Tool Response Streaming (including AgentTool forwarding)","text":"<p>When a Streamable tool is invoked (including AgentTool), the framework emits <code>tool.response</code> events. In streaming mode:</p> <ul> <li>Each partial chunk appears in <code>choice.Delta.Content</code>, <code>Done=false</code>, <code>IsPartial=true</code>.</li> <li>Final tool messages arrive with <code>choice.Message.Role=tool</code> and <code>choice.Message.Content</code>.</li> </ul> <p>When AgentTool enables <code>WithStreamInner(true)</code>, it also forwards the child Agent\u2019s events inline to the parent flow:</p> <ul> <li>Forwarded child events are standard <code>event.Event</code> items; incremental text appears in <code>choice.Delta.Content</code>.</li> <li>To avoid duplicate display, the child\u2019s final full message is not forwarded; it is aggregated into the final <code>tool.response</code> content so the next LLM turn has tool messages as required by some providers.</li> </ul> <p>Runner automatically sends completion signals for events requiring them (<code>RequiresCompletion=true</code>), so manual handling is not needed.</p> <p>Example handling in an event loop:</p> <pre><code>if evt.Response != nil &amp;&amp; evt.Object == model.ObjectTypeToolResponse &amp;&amp; len(evt.Response.Choices) &gt; 0 {\n    for _, ch := range evt.Response.Choices {\n        if ch.Delta.Content != \"\" { // partial\n            fmt.Print(ch.Delta.Content)\n            continue\n        }\n        if ch.Message.Role == model.RoleTool &amp;&amp; ch.Message.Content != \"\" { // final\n            fmt.Println(strings.TrimSpace(ch.Message.Content))\n        }\n    }\n    // Continue to next event; don't treat as assistant content\n    continue\n}\n</code></pre> <p>Tip: For custom events, always use <code>event.New(...)</code> with <code>WithResponse</code>, <code>WithBranch</code>, etc., to ensure IDs and timestamps are set consistently.</p>"},{"location":"event/#tags","title":"Tags","text":"<p>Events support simple tagging via <code>Event.Tag</code> to annotate business labels for filtering and analytics:</p> <ul> <li>Delimiter: <code>;</code> (semicolon). Multiple tags concatenate as <code>tag1;tag2</code>.</li> <li>Helper: <code>event.WithTag(\"&lt;tag&gt;\")</code> to append a tag without losing existing ones.</li> <li>Built-in usage: delegation-related events are tagged with <code>transfer</code>. UIs can hide these internal messages while preserving the complete event stream for debugging and processing.</li> </ul>"},{"location":"event/#event-methods","title":"Event Methods","text":"<p>Event provides the <code>Clone</code> method for creating deep copies of Events.</p> <pre><code>func (e *Event) Clone() *Event\n</code></pre>"},{"location":"event/#event-usage-examples","title":"Event Usage Examples","text":"<p>This example demonstrates how to use Event in real applications to handle Agent streaming responses, tool calls, and error handling.</p>"},{"location":"event/#core-flow","title":"Core Flow","text":"<ol> <li>Send User Message: Start Agent processing through <code>runner.Run()</code></li> <li>Receive Event Stream: Handle events returned by Agent in real-time</li> <li>Handle Different Event Types: Distinguish streaming content, tool calls, errors, etc.</li> <li>Visual Output: Provide user-friendly interactive experience</li> </ol>"},{"location":"event/#code-example","title":"Code Example","text":"<pre><code>// processMessage handles single message interaction.\nfunc (c *multiTurnChat) processMessage(ctx context.Context, userMessage string) error {\n    message := model.NewUserMessage(userMessage)\n\n    // Run agent through runner.\n    eventChan, err := c.runner.Run(ctx, c.userID, c.sessionID, message)\n    if err != nil {\n        return fmt.Errorf(\"failed to run agent: %w\", err)\n    }\n\n    // Handle response.\n    return c.processResponse(eventChan)\n}\n\n// processResponse handles response, including streaming response and tool call visualization.\nfunc (c *multiTurnChat) processResponse(eventChan &lt;-chan *event.Event) error {\n    fmt.Print(\"\ud83e\udd16 Assistant: \")\n\n    var (\n        fullContent       string        // Accumulated complete content.\n        toolCallsDetected bool          // Whether tool calls are detected.\n        assistantStarted  bool          // Whether Assistant has started replying.\n    )\n\n    for event := range eventChan {\n        // Handle single event.\n        if err := c.handleEvent(event, &amp;toolCallsDetected, &amp;assistantStarted, &amp;fullContent); err != nil {\n            return err\n        }\n        // Check if it's the final event.\n        if event.IsFinalResponse() {\n            fmt.Printf(\"\\n\")\n            break\n        }\n    }\n\n    return nil\n}\n\n// handleEvent handles single event.\nfunc (c *multiTurnChat) handleEvent(\n    event *event.Event,\n    toolCallsDetected *bool,\n    assistantStarted *bool,\n    fullContent *string,\n) error {\n    // 1. Handle error events.\n    if event.Error != nil {\n        fmt.Printf(\"\\n\u274c Error: %s\\n\", event.Error.Message)\n        return nil\n    }\n\n    // 2. Handle tool calls.\n    if c.handleToolCalls(event, toolCallsDetected, assistantStarted) {\n        return nil\n    }\n\n    // 3. Handle tool responses.\n    if c.handleToolResponses(event) {\n        return nil\n    }\n\n    // 4. Handle content.\n    c.handleContent(event, toolCallsDetected, assistantStarted, fullContent)\n\n    return nil\n}\n\n// handleToolCalls detects and displays tool calls.\nfunc (c *multiTurnChat) handleToolCalls(\n    event *event.Event,\n    toolCallsDetected *bool,\n    assistantStarted *bool,\n) bool {\n    if len(event.Response.Choices) &gt; 0 &amp;&amp; len(event.Response.Choices[0].Message.ToolCalls) &gt; 0 {\n        *toolCallsDetected = true\n        if *assistantStarted {\n            fmt.Printf(\"\\n\")\n        }\n        fmt.Printf(\"\ud83d\udd27 Tool calls initiated:\\n\")\n        for _, toolCall := range event.Response.Choices[0].Message.ToolCalls {\n            fmt.Printf(\"   \u2022 %s (ID: %s)\\n\", toolCall.Function.Name, toolCall.ID)\n            if len(toolCall.Function.Arguments) &gt; 0 {\n                fmt.Printf(\"     Args: %s\\n\", string(toolCall.Function.Arguments))\n            }\n        }\n        fmt.Printf(\"\\n\ud83d\udd04 Executing tools...\\n\")\n        return true\n    }\n    return false\n}\n\n// handleToolResponses detects and displays tool responses.\nfunc (c *multiTurnChat) handleToolResponses(event *event.Event) bool {\n    if event.Response != nil &amp;&amp; len(event.Response.Choices) &gt; 0 {\n        for _, choice := range event.Response.Choices {\n            if choice.Message.Role == model.RoleTool &amp;&amp; choice.Message.ToolID != \"\" {\n                fmt.Printf(\"\u2705 Tool response (ID: %s): %s\\n\",\n                    choice.Message.ToolID,\n                    strings.TrimSpace(choice.Message.Content))\n                return true\n            }\n        }\n    }\n    return false\n}\n\n// handleContent handles and displays content.\nfunc (c *multiTurnChat) handleContent(\n    event *event.Event,\n    toolCallsDetected *bool,\n    assistantStarted *bool,\n    fullContent *string,\n) {\n    if len(event.Response.Choices) &gt; 0 {\n        choice := event.Response.Choices[0]\n        content := c.extractContent(choice)\n\n        if content != \"\" {\n            c.displayContent(content, toolCallsDetected, assistantStarted, fullContent)\n        }\n    }\n}\n\n// extractContent extracts content based on streaming mode.\nfunc (c *multiTurnChat) extractContent(choice model.Choice) string {\n    if c.streaming {\n        // Streaming mode: use incremental content.\n        return choice.Delta.Content\n    }\n    // Non-streaming mode: use complete message content.\n    return choice.Message.Content\n}\n\n// displayContent prints content to console.\nfunc (c *multiTurnChat) displayContent(\n    content string,\n    toolCallsDetected *bool,\n    assistantStarted *bool,\n    fullContent *string,\n) {\n    if !*assistantStarted {\n        if *toolCallsDetected {\n            fmt.Printf(\"\\n\ud83e\udd16 Assistant: \")\n        }\n        *assistantStarted = true\n    }\n    fmt.Print(content)\n    *fullContent += content\n}\n</code></pre>"},{"location":"event/#relationship-and-usage-scenarios-of-requestid-parentinvocationid-and-invocationid","title":"Relationship and Usage Scenarios of RequestID, ParentInvocationID, and InvocationID","text":"<ul> <li><code>RequestID string</code>\u200b\u200b: Used to identify and distinguish multiple user interaction requests within the same session. It can be bound to the business layer's own request ID via runner.Runu agent.WithRequestID. This ensures unique identification for each request cycle, similar to how request IDs are employed to guarantee idempotency and de-duplication in API interactions.</li> <li><code>\u200b\u200bParentInvocationID string</code>\u200b\u200b: Used to associate the parent execution context. This ID can link to related events in the parent execution, enabling hierarchical tracking of nested operations. This mirrors concepts where a parent request ID groups multiple sub-requests, each with distinct identifiers but shared parent context for cohesive management.</li> <li><code>\u200b\u200bInvocationID string</code>\u200b\u200b: The current execution context ID. This ID associates related events within the same execution context, allowing precise correlation of actions and outcomes for a specific invocation. It functions similarly to child request IDs in systems where individual operations are tracked under a parent scope.</li> </ul> <p>Using these three IDs, the event flow can be organized in a hierarchical structure as follows: - requestID-1:   - invocationID-1:     - invocationID-2     - invocationID-3   - invocationID-1   - invocationID-4   - invocationID-5 - requestID-2:   - invocationID-6     - invocationID-7   - invocationID-8   - invocationID-9</p>"},{"location":"graph/","title":"Graph Package Guide","text":""},{"location":"graph/#overview","title":"Overview","text":"<p>Graph combines controllable workflow orchestration with extensible agent capabilities. It is suitable for:</p> <ul> <li>Type-safe state management and predictable routing.</li> <li>LLM decision making, tool-calling loops, and optional Human in the Loop (HITL).</li> <li>Reusable components that can run standalone or be composed as sub\u2011agents.</li> </ul> <p>Highlights:</p> <ul> <li>Schema\u2011driven State and Reducers to avoid data races when concurrent branches write the same field.</li> <li>Deterministic parallelism with BSP style (Plan / Execute / Update).</li> <li>Built\u2011in node types wrap LLM, Tools, and Agent to reduce boilerplate.</li> <li>Streaming events, checkpoints, and interrupts for observability and recovery.</li> <li>Node\u2011level retry/backoff with exponential delay and jitter, plus executor\u2011level defaults and rich retry metadata in events.</li> <li>Node event emitter (EventEmitter) for emitting custom events, progress updates, and streaming text from within NodeFunc.</li> </ul>"},{"location":"graph/#quick-start","title":"Quick Start","text":""},{"location":"graph/#minimal-workflow","title":"Minimal Workflow","text":"<p>Below is a classic \"prepare \u2192 ask LLM \u2192 optionally call tools\" loop using <code>graph.MessagesStateSchema()</code> (predefines <code>graph.StateKeyMessages</code>, <code>graph.StateKeyUserInput</code>, <code>graph.StateKeyLastResponse</code>, etc.).</p> <pre><code>flowchart LR\n    START([start]):::startNode --&gt; P[prepare]:::processNode\n    P --&gt; A[ask LLM]:::llmNode\n    A -. tool_calls .-&gt; T[tools]:::toolNode\n    A -- no tool_calls --&gt; F[fallback]:::processNode\n    T --&gt; A\n    F --&gt; END([finish]):::endNode\n\n    classDef startNode fill:#e1f5e1,stroke:#4caf50,stroke-width:2px\n    classDef endNode fill:#ffe1e1,stroke:#f44336,stroke-width:2px\n    classDef llmNode fill:#e3f2fd,stroke:#2196f3,stroke-width:2px\n    classDef toolNode fill:#fff3e0,stroke:#ff9800,stroke-width:2px\n    classDef processNode fill:#f3e5f5,stroke:#9c27b0,stroke-width:2px</code></pre> <p>The Graph package allows you to model complex AI workflows as directed graphs, where nodes represent processing steps and edges represent data flow and control flow. It is particularly suitable for building AI applications that require conditional routing, state management, and multi-step processing.</p>"},{"location":"graph/#usage-pattern","title":"Usage Pattern","text":"<p>The usage of the Graph package follows this pattern:</p> <ol> <li>Create Graph: Use <code>StateGraph</code> builder to define workflow structure</li> <li>Create GraphAgent: Wrap the compiled Graph as an Agent</li> <li>Create Runner: Use Runner to manage sessions and execution environment</li> <li>Execute Workflow: Execute workflow through Runner and handle results</li> </ol> <p>This pattern provides:</p> <ul> <li>Type Safety: Ensures data consistency through state schema</li> <li>Session Management: Supports concurrent execution for multiple users and sessions</li> <li>Event Stream: Real-time monitoring of workflow execution progress</li> <li>Error Handling: Unified error handling and recovery mechanisms</li> </ul>"},{"location":"graph/#agent-integration","title":"Agent Integration","text":"<p>GraphAgent implements the <code>agent.Agent</code> interface and can:</p> <ul> <li>Act as Independent Agent: Execute directly through Runner</li> <li>Act as SubAgent: Be used as a sub-agent by other Agents (such as LLMAgent)</li> <li>Host SubAgents: Register child agents via <code>graphagent.WithSubAgents</code> and invoke them through <code>AddAgentNode</code></li> </ul> <p>This design lets GraphAgent plug into other agents while orchestrating its own specialized sub-agents.</p>"},{"location":"graph/#key-features","title":"Key Features","text":"<ul> <li>Type-safe state management: Use Schema to define state structure, support custom Reducers</li> <li>Conditional routing: Dynamically select execution paths based on state</li> <li>LLM node integration: Built-in support for large language models</li> <li>Tool nodes: Support function calls and external tool integration</li> <li>Agent nodes: Delegate parts of the workflow to registered sub-agents</li> <li>Streaming execution: Support real-time event streams and progress tracking</li> <li>Concurrency safety: Thread-safe graph execution</li> <li>Checkpoint-based Time Travel: Navigate through execution history and restore previous states</li> <li>Human-in-the-Loop (HITL): Support for interactive workflows with interrupt and resume capabilities</li> <li>Atomic checkpointing: Atomic storage of checkpoints with pending writes for reliable recovery</li> <li>Checkpoint Lineage: Track related checkpoints forming execution threads with parent-child relationships</li> </ul>"},{"location":"graph/#core-concepts","title":"Core Concepts","text":""},{"location":"graph/#1-graph","title":"1. Graph","text":"<p>A graph is the core structure of a workflow, consisting of nodes and edges:</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/graph\"\n)\n\n// Create state schema.\nschema := graph.NewStateSchema()\n\n// Create graph.\ngraph := graph.New(schema)\n</code></pre> <p>Virtual Nodes:</p> <ul> <li><code>Start</code>: Virtual start node, automatically connected through <code>SetEntryPoint()</code></li> <li><code>End</code>: Virtual end node, automatically connected through <code>SetFinishPoint()</code></li> <li>These nodes don't need to be explicitly created, the system automatically handles connections</li> </ul>"},{"location":"graph/#2-node","title":"2. Node","text":"<p>A node represents a processing step in the workflow:</p> <pre><code>import (\n    \"context\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/graph\"\n)\n\n// Node function signature.\ntype NodeFunc func(ctx context.Context, state graph.State) (any, error)\n\n// Create node.\nnode := &amp;graph.Node{\n    ID:          \"process_data\",\n    Name:        \"Data Processing\",\n    Description: \"Process input data\",\n    Function:    processDataFunc,\n}\n</code></pre>"},{"location":"graph/#3-state","title":"3. State","text":"<p>State is a data container passed between nodes:</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/graph\"\n)\n\n// State is a key-value pair mapping.\ntype State map[string]any\n\n// User-defined state keys.\nconst (\n    StateKeyInput         = \"input\"          // Input data.\n    StateKeyResult        = \"result\"         // Processing result.\n    StateKeyProcessedData = \"processed_data\" // Processed data.\n    StateKeyStatus        = \"status\"         // Processing status.\n)\n</code></pre> <p>Built-in State Keys:</p> <p>The Graph package provides some built-in state keys, mainly for internal system communication:</p> <p>User-accessible Built-in Keys:</p> <ul> <li><code>StateKeyUserInput</code>: User input (one-shot, cleared after consumption, persisted by LLM nodes)</li> <li><code>StateKeyOneShotMessages</code>: One-shot messages (complete override for current round, cleared after consumption)</li> <li><code>StateKeyLastResponse</code>: Last response (used to set final output, Executor reads this value as result)</li> <li><code>StateKeyMessages</code>: Message history (durable, supports append + MessageOp patch operations)</li> <li><code>StateKeyNodeResponses</code>: Per-node responses map. Key is node ID, value is the   node's final textual response. Use <code>StateKeyLastResponse</code> for the final   serial output; when multiple parallel nodes converge, read each node's   output from <code>StateKeyNodeResponses</code>.</li> <li><code>StateKeyMetadata</code>: Metadata (general metadata storage available to users)</li> </ul> <p>System Internal Keys (users should not use directly):</p> <ul> <li><code>StateKeySession</code>: Session information (automatically set by GraphAgent)</li> <li><code>StateKeyExecContext</code>: Execution context (automatically set by Executor)</li> <li><code>StateKeyToolCallbacks</code>: Tool callbacks (automatically set by Executor)</li> <li><code>StateKeyModelCallbacks</code>: Model callbacks (automatically set by Executor)</li> </ul> <p>Users should use custom state keys to store business data, and only use user-accessible built-in state keys when necessary.</p>"},{"location":"graph/#4-state-schema","title":"4. State Schema","text":"<p>State schema defines the structure and behavior of state:</p> <pre><code>import (\n    \"reflect\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/graph\"\n)\n\n// Create state schema.\nschema := graph.NewStateSchema()\n\n// Add field definitions.\nschema.AddField(\"counter\", graph.StateField{\n    Type:    reflect.TypeOf(0),\n    Reducer: graph.DefaultReducer,\n    Default: func() any { return 0 },\n})\n</code></pre>"},{"location":"graph/#usage-guide","title":"Usage Guide","text":""},{"location":"graph/#node-io-conventions","title":"Node I/O Conventions","text":"<p>Nodes communicate exclusively through the shared state. Each node returns a state delta which is merged into the graph state using the schema's reducers. Downstream nodes read whatever upstream nodes wrote.</p> <ul> <li> <p>Common built\u2011in keys (user\u2011facing)</p> <ul> <li><code>user_input</code>: One\u2011shot input for the next LLM/Agent node. Cleared after consumption.</li> <li><code>one_shot_messages</code>: Full message override for the next LLM call. Cleared after consumption.</li> <li><code>messages</code>: Durable conversation history (LLM/Tools append here). Supports MessageOp patches.</li> <li><code>last_response</code>: The last textual assistant response.</li> <li><code>node_responses</code>: Map[nodeID]any \u2014 per\u2011node final textual response. Use <code>last_response</code> for the most recent.</li> </ul> </li> </ul> <ul> <li> <p>Function node</p> <ul> <li>Input: the entire state</li> <li>Output: return a <code>graph.State</code> delta with custom keys (declare them in the schema), e.g. <code>{\"parsed_time\": \"...\"}</code></li> </ul> </li> </ul> <ul> <li> <p>LLM node</p> <ul> <li>Input priority: <code>one_shot_messages</code> \u2192 <code>user_input</code> \u2192 <code>messages</code></li> <li>Output:<ul> <li>Appends assistant message to <code>messages</code></li> <li>Sets <code>last_response</code></li> <li>Sets <code>node_responses[&lt;llm_node_id&gt;]</code></li> </ul> </li> </ul> </li> </ul> <ul> <li> <p>Tools node</p> <ul> <li>Input: scans <code>messages</code> for the latest assistant message with <code>tool_calls</code></li> <li>Output: appends tool responses to <code>messages</code></li> </ul> </li> </ul> <ul> <li>Agent node (sub\u2011agent)<ul> <li>Input: state is injected into the sub\u2011agent's <code>Invocation.RunOptions.RuntimeState</code>.<ul> <li>Model/Tool callbacks can access it via <code>agent.InvocationFromContext(ctx)</code>.</li> </ul> </li> <li>Output on finish:<ul> <li>Sets <code>last_response</code></li> <li>Sets <code>node_responses[&lt;agent_node_id&gt;]</code></li> <li>Clears <code>user_input</code></li> </ul> </li> </ul> </li> </ul> <p>Recommended patterns</p> <ul> <li>Add your own keys in the schema (e.g., <code>parsed_time</code>, <code>final_payload</code>) and write/read them in function nodes.</li> <li>To feed structured hints into an LLM node, write <code>one_shot_messages</code> in the previous node (e.g., prepend a system message with parsed context).</li> <li>To consume an upstream node's text, read <code>last_response</code> immediately downstream or fetch from <code>node_responses[that_node_id]</code> later.</li> </ul> <p>See examples:</p> <ul> <li><code>examples/graph/io_conventions</code> \u2014 Function + LLM + Agent I/O</li> <li><code>examples/graph/io_conventions_tools</code> \u2014 Adds a Tools node path and shows how to capture tool JSON</li> <li><code>examples/graph/retry</code> \u2014 Node-level retry/backoff demonstration</li> </ul>"},{"location":"graph/#constant-references-import-and-keys","title":"Constant references (import and keys)","text":"<ul> <li>Import: <code>import \"trpc.group/trpc-go/trpc-agent-go/graph\"</code></li> <li>Defined in: <code>graph/state.go</code></li> </ul> <ul> <li> <p>User\u2011facing keys</p> <ul> <li><code>user_input</code> \u2192 <code>graph.StateKeyUserInput</code></li> <li><code>one_shot_messages</code> \u2192 <code>graph.StateKeyOneShotMessages</code></li> <li><code>messages</code> \u2192 <code>graph.StateKeyMessages</code></li> <li><code>last_response</code> \u2192 <code>graph.StateKeyLastResponse</code></li> <li><code>node_responses</code> \u2192 <code>graph.StateKeyNodeResponses</code></li> </ul> </li> </ul> <ul> <li>Other useful keys<ul> <li><code>session</code> \u2192 <code>graph.StateKeySession</code></li> <li><code>metadata</code> \u2192 <code>graph.StateKeyMetadata</code></li> <li><code>current_node_id</code> \u2192 <code>graph.StateKeyCurrentNodeID</code></li> <li><code>exec_context</code> \u2192 <code>graph.StateKeyExecContext</code></li> <li><code>tool_callbacks</code> \u2192 <code>graph.StateKeyToolCallbacks</code></li> <li><code>model_callbacks</code> \u2192 <code>graph.StateKeyModelCallbacks</code></li> <li><code>agent_callbacks</code> \u2192 <code>graph.StateKeyAgentCallbacks</code></li> <li><code>parent_agent</code> \u2192 <code>graph.StateKeyParentAgent</code></li> </ul> </li> </ul> <p>Snippet:</p> <pre><code>import (\n    \"context\"\n    \"trpc.group/trpc-go/trpc-agent-go/graph\"\n)\n\nfunc myNode(ctx context.Context, state graph.State) (any, error) {\n    last, _ := state[graph.StateKeyLastResponse].(string)\n    return graph.State{\"my_key\": last}, nil\n}\n</code></pre>"},{"location":"graph/#event-metadata-keys-statedelta","title":"Event metadata keys (StateDelta)","text":"<ul> <li>Import: <code>import \"trpc.group/trpc-go/trpc-agent-go/graph\"</code></li> <li>Defined in: <code>graph/events.go</code></li> </ul> <ul> <li>Model metadata: <code>_model_metadata</code> \u2192 <code>graph.MetadataKeyModel</code> (struct <code>graph.ModelExecutionMetadata</code>)</li> <li>Tool metadata: <code>_tool_metadata</code> \u2192 <code>graph.MetadataKeyTool</code> (struct <code>graph.ToolExecutionMetadata</code>)</li> <li>Node metadata: <code>_node_metadata</code> \u2192 <code>graph.MetadataKeyNode</code> (struct <code>graph.NodeExecutionMetadata</code>). Includes retry info: <code>Attempt</code>, <code>MaxAttempts</code>, <code>NextDelay</code>, <code>Retrying</code> and timing fields.</li> </ul> <p>Snippet:</p> <pre><code>if b, ok := event.StateDelta[graph.MetadataKeyModel]; ok {\n    var md graph.ModelExecutionMetadata\n    _ = json.Unmarshal(b, &amp;md)\n}\n</code></pre>"},{"location":"graph/#node-event-emitter-eventemitter","title":"Node Event Emitter (EventEmitter)","text":"<p>During NodeFunc execution, nodes can proactively emit custom events to the outside through <code>EventEmitter</code>, for real-time delivery of progress, intermediate results, or custom business data.</p> <p>Getting EventEmitter</p> <pre><code>func myNode(ctx context.Context, state graph.State) (any, error) {\n    // Get EventEmitter from State\n    emitter := graph.GetEventEmitterWithContext(ctx, state)\n    // Or use a custom context\n    // emitter := graph.GetEventEmitter(state)\n\n    // Use emitter to emit events...\n    return state, nil\n}\n</code></pre> <p>EventEmitter Interface</p> <pre><code>type EventEmitter interface {\n    // Emit sends any event\n    Emit(evt *event.Event) error\n    // EmitCustom emits a custom event\n    EmitCustom(eventType string, payload any) error\n    // EmitProgress emits a progress event (progress: 0-100)\n    EmitProgress(progress float64, message string) error\n    // EmitText emits a streaming text event\n    EmitText(text string) error\n    // Context returns the associated context\n    Context() context.Context\n}\n</code></pre> <p>Usage Examples</p> <pre><code>func dataProcessNode(ctx context.Context, state graph.State) (any, error) {\n    emitter := graph.GetEventEmitter(state)\n\n    // 1. Emit custom event\n    emitter.EmitCustom(\"data.loaded\", map[string]any{\n        \"recordCount\": 1000,\n        \"source\":      \"database\",\n    })\n\n    // 2. Emit progress events\n    total := 100\n    for i := 0; i &lt; total; i++ {\n        processItem(i)\n        progress := float64(i+1) / float64(total) * 100\n        emitter.EmitProgress(progress, fmt.Sprintf(\"Processing %d/%d\", i+1, total))\n    }\n\n    // 3. Emit streaming text\n    emitter.EmitText(\"Processing complete.\\n\")\n    emitter.EmitText(\"Results: 100 items processed successfully.\")\n\n    return state, nil\n}\n</code></pre> <p>Event Flow Diagram</p> <pre><code>sequenceDiagram\n    autonumber\n    participant NF as NodeFunc\n    participant EE as EventEmitter\n    participant EC as EventChan\n    participant EX as Executor\n    participant TR as AGUI Translator\n    participant FE as Frontend Client\n\n    Note over NF,FE: Event Emission Phase\n    NF-&gt;&gt;EE: GetEventEmitter(state)\n    EE--&gt;&gt;NF: Return EventEmitter instance\n\n    alt Emit Custom Event\n        NF-&gt;&gt;EE: EmitCustom(eventType, payload)\n    else Emit Progress Event\n        NF-&gt;&gt;EE: EmitProgress(progress, message)\n    else Emit Text Event\n        NF-&gt;&gt;EE: EmitText(text)\n    end\n\n    Note over EE: Build NodeCustomEventMetadata\n    EE-&gt;&gt;EE: Inject NodeID, InvocationID, Timestamp\n    EE-&gt;&gt;EC: Send Event to channel\n\n    Note over EC,FE: Event Consumption Phase\n    EC-&gt;&gt;EX: Executor receives event\n    EX-&gt;&gt;TR: Pass event to Translator\n\n    alt Custom Event\n        TR-&gt;&gt;TR: Convert to AG-UI CustomEvent\n    else Progress Event\n        TR-&gt;&gt;TR: Convert to AG-UI CustomEvent (with progress info)\n    else Text Event (in message context)\n        TR-&gt;&gt;TR: Convert to TextMessageContentEvent\n    else Text Event (not in message context)\n        TR-&gt;&gt;TR: Convert to AG-UI CustomEvent\n    end\n\n    TR-&gt;&gt;FE: SSE push AG-UI event\n    FE-&gt;&gt;FE: Process and update UI</code></pre> <p>AGUI Event Conversion</p> <p>When using AGUI Server, events emitted by nodes are automatically converted to AG-UI protocol events:</p> Node Event Type AG-UI Event Type Description Custom CustomEvent Custom event, payload in <code>value</code> field Progress CustomEvent Progress event with <code>progress</code> and <code>message</code> Text (in message context) TextMessageContentEvent Streaming text appended to current message Text (not in message context) CustomEvent Contains <code>nodeId</code> and <code>content</code> fields <p>Notes</p> <ul> <li>Thread Safety: EventEmitter is thread-safe and can be used in concurrent environments</li> <li>Graceful Degradation: If State has no valid ExecutionContext or EventChan, <code>GetEventEmitter</code> returns a no-op emitter that silently succeeds for all operations</li> <li>Error Handling: Event emission failures do not interrupt node execution; it's recommended to only log warnings</li> <li>Custom Event Metadata: <code>_node_custom_metadata</code> \u2192 <code>graph.MetadataKeyNodeCustom</code> (struct <code>graph.NodeCustomEventMetadata</code>)</li> </ul>"},{"location":"graph/#1-creating-graphagent-and-runner","title":"1. Creating GraphAgent and Runner","text":"<p>Users mainly use the Graph package by creating GraphAgent and then using it through Runner. This is the recommended usage pattern:</p> <pre><code>package main\n\nimport (\n    \"context\"\n    \"fmt\"\n    \"time\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/agent/graphagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/graph\"\n    \"trpc.group/trpc-go/trpc-agent-go/model\"\n    \"trpc.group/trpc-go/trpc-agent-go/runner\"\n    \"trpc.group/trpc-go/trpc-agent-go/session/inmemory\"\n)\n\nfunc main() {\n    // 1. Create state schema\n    schema := graph.MessagesStateSchema()\n\n    // 2. Create state graph builder\n    stateGraph := graph.NewStateGraph(schema)\n\n    // 3. Add nodes\n    stateGraph.AddNode(\"start\", startNodeFunc).\n        AddNode(\"process\", processNodeFunc)\n\n    // 4. Set edges\n    stateGraph.AddEdge(\"start\", \"process\")\n\n    // 5. Set entry point and finish point\n    // SetEntryPoint automatically creates an edge from the virtual Start node to the \"start\" node\n    // SetFinishPoint automatically creates an edge from the \"process\" node to the virtual End node\n    stateGraph.SetEntryPoint(\"start\").\n        SetFinishPoint(\"process\")\n\n    // 6. Compile the graph\n    compiledGraph, err := stateGraph.Compile()\n    if err != nil {\n        panic(err)\n    }\n\n    // 7. Create GraphAgent\n    graphAgent, err := graphagent.New(\"simple-workflow\", compiledGraph,\n        graphagent.WithDescription(\"Simple workflow example\"),\n        graphagent.WithInitialState(graph.State{}),\n        // Set message filter modes for the model. Messages passed to the model must satisfy both WithMessageTimelineFilterMode and WithMessageBranchFilterMode conditions\n        // Timeline filter mode\n        // Default value: graphagent.TimelineFilterAll\n        // Options:\n        //  - graphagent.TimelineFilterAll: Include historical messages and messages generated in the current request\n        //  - graphagent.TimelineFilterCurrentRequest: Only include messages generated in the current request\n        //  - graphagent.TimelineFilterCurrentInvocation: Only include messages generated in the current invocation context\n        graphagent.WithMessageTimelineFilterMode(graphagent.TimelineFilterAll),\n        // Branch filter mode\n        // Default value: graphagent.BranchFilterModePrefix\n        // Options:\n        //  - graphagent.BranchFilterModeAll: Include messages from all agents. Set this value when the current agent needs to synchronize all valid content messages generated by all agents to the model during interaction\n        //  - graphagent.BranchFilterModePrefix: Filter messages by prefix matching Event.FilterKey with Invocation.eventFilterKey. Set this value when you want to pass messages generated by the current agent and related upstream/downstream agents to the model\n        //  - graphagent.BranchFilterModeExact: Filter messages by Event.FilterKey == Invocation.eventFilterKey. Set this value when the current agent only needs to use messages generated by itself during model interaction\n        graphagent.WithMessageBranchFilterMode(graphagent.BranchFilterModeAll),\n    )\n    if err != nil {\n        panic(err)\n    }\n\n    // 8. Create session service\n    sessionService := inmemory.NewSessionService()\n\n    // 9. Create Runner\n    appRunner := runner.NewRunner(\n        \"simple-app\",\n        graphAgent,\n        runner.WithSessionService(sessionService),\n    )\n\n    // 10. Execute workflow\n    ctx := context.Background()\n    userID := \"user\"\n    sessionID := fmt.Sprintf(\"session-%d\", time.Now().Unix())\n\n    // Create user message (Runner will automatically put the message content into StateKeyUserInput)\n    message := model.NewUserMessage(\"Hello World\")\n\n    // Execute through Runner\n    eventChan, err := appRunner.Run(ctx, userID, sessionID, message)\n    if err != nil {\n        panic(err)\n    }\n\n    // Handle event stream\n    for event := range eventChan {\n        if event.Error != nil {\n            fmt.Printf(\"Error: %s\\n\", event.Error.Message)\n            continue\n        }\n\n        if len(event.Response.Choices) &gt; 0 {\n            choice := event.Response.Choices[0]\n            if choice.Delta.Content != \"\" {\n                fmt.Print(choice.Delta.Content)\n            }\n        }\n\n        // Recommended: Use Runner completion event as a signal for \"workflow end\"\n        if event.IsRunnerCompletion() {\n            break\n        }\n    }\n}\n\nconst (\n    stateKeyProcessedData = \"processed_data\"\n    stateKeyResult        = \"result\"\n)\n\n// Start node function implementation\nfunc startNodeFunc(ctx context.Context, state graph.State) (any, error) {\n    // Get user input from built-in StateKeyUserInput (automatically set by Runner)\n    input := state[graph.StateKeyUserInput].(string)\n    return graph.State{\n        stateKeyProcessedData: fmt.Sprintf(\"Processed: %s\", input),\n    }, nil\n}\n\n// Process node function implementation\nfunc processNodeFunc(ctx context.Context, state graph.State) (any, error) {\n    processed := state[stateKeyProcessedData].(string)\n    result := fmt.Sprintf(\"Result: %s\", processed)\n    return graph.State{\n        stateKeyResult:             result,\n        graph.StateKeyLastResponse: fmt.Sprintf(\"Final result: %s\", result),\n    }, nil\n}\n</code></pre>"},{"location":"graph/#2-using-llm-nodes","title":"2. Using LLM Nodes","text":"<p>LLM nodes implement a fixed three-stage input rule without extra configuration:</p> <ol> <li>OneShot first: If <code>one_shot_messages</code> exists, use it as the input for this round.</li> <li>UserInput next: Otherwise, if <code>user_input</code> exists, persist once to history.</li> <li>History default: Otherwise, use durable <code>messages</code> as input.</li> </ol> <pre><code>// Create LLM model.\nmodel := openai.New(\"gpt-4\")\n\n// Add LLM node.\nstateGraph.AddLLMNode(\"analyze\", model,\n    `You are a document analysis expert. Analyze the provided document and:\n1. Classify document type and complexity\n2. Extract key themes\n3. Evaluate content quality\nPlease provide structured analysis results.`,\n    nil) // Tool mapping.\n</code></pre> <p>Important notes:</p> <ul> <li>System prompt is only used for this round and is not persisted to state.</li> <li>One-shot keys (<code>user_input</code> / <code>one_shot_messages</code>) are automatically cleared after successful execution.</li> <li>All state updates are atomic.</li> <li>GraphAgent/Runner only sets <code>user_input</code> and no longer pre-populates <code>messages</code> with a user message. This allows any pre-LLM node to modify <code>user_input</code> and have it take effect in the same round.</li> </ul>"},{"location":"graph/#three-input-paradigms","title":"Three input paradigms","text":"<ul> <li> <p>OneShot (<code>StateKeyOneShotMessages</code>):</p> <ul> <li>When present, only the provided <code>[]model.Message</code> is used for this round, typically including a full system prompt and user prompt. Automatically cleared afterwards.</li> <li>Use case: a dedicated pre-node constructs the full prompt and must fully override input.</li> </ul> </li> </ul> <ul> <li> <p>UserInput (<code>StateKeyUserInput</code>):</p> <ul> <li>When non-empty, the LLM node uses durable <code>messages</code> plus this round's user input to call the model. After the call, it writes the user input and assistant reply to <code>messages</code> using <code>MessageOp</code> (e.g., <code>AppendMessages</code>, <code>ReplaceLastUser</code>) atomically, and clears <code>user_input</code> to avoid repeated appends.</li> <li>Use case: conversational flows where pre-nodes may adjust user input.</li> </ul> </li> </ul> <ul> <li>Messages only (just <code>StateKeyMessages</code>):<ul> <li>Common in tool-call loops. After the first round via <code>user_input</code>, routing to tools and back to LLM, since <code>user_input</code> is cleared, the LLM uses only <code>messages</code> (history). The tail is often a <code>tool</code> response, enabling the model to continue reasoning based on tool outputs.</li> </ul> </li> </ul>"},{"location":"graph/#atomic-updates-with-reducer-and-messageop","title":"Atomic updates with Reducer and MessageOp","text":"<p>The Graph package supports <code>MessageOp</code> patch operations (e.g., <code>ReplaceLastUser</code>, <code>AppendMessages</code>) on message state via <code>MessageReducer</code> to achieve atomic merges. Benefits:</p> <ul> <li>Pre-LLM nodes can modify <code>user_input</code>. The LLM node returns a single state delta with the needed patch operations (replace last user message, append assistant message) for one-shot, race-free persistence.</li> <li>Backwards compatible with appending <code>[]Message</code>, while providing more expressive updates for complex cases.</li> </ul> <p>Example: modify <code>user_input</code> in a pre-node before entering the LLM node.</p> <pre><code>stateGraph.\n    AddNode(\"prepare_input\", func(ctx context.Context, s graph.State) (any, error) {\n        cleaned := strings.TrimSpace(s[graph.StateKeyUserInput].(string))\n        return graph.State{graph.StateKeyUserInput: cleaned}, nil\n    }).\n    AddLLMNode(\"ask\", modelInstance,\n        \"You are a helpful assistant. Answer concisely.\",\n        nil).\n    SetEntryPoint(\"prepare_input\").\n    SetFinishPoint(\"ask\")\n</code></pre>"},{"location":"graph/#using-removeallmessages-to-clear-message-history","title":"Using RemoveAllMessages to Clear Message History","text":"<p>When chaining multiple LLM nodes, <code>MessageReducer</code> accumulates messages. If each LLM node requires an isolated message context (without inheriting the previous node's conversation history), use <code>RemoveAllMessages</code> to clear previous messages:</p> <pre><code>// In the prompt preparation node, clear messages before setting new UserInput.\nfunc preparePromptNode(ctx context.Context, state graph.State) (any, error) {\n    userMessage := buildUserMessage(...)\n    return graph.State{\n        // Key: Clear previous messages first to avoid accumulation.\n        graph.StateKeyMessages:  graph.RemoveAllMessages{},\n        graph.StateKeyUserInput: userMessage,\n    }, nil\n}\n</code></pre> <p>Use cases:</p> <ul> <li>Multiple independent LLM nodes within the same Graph, where each node doesn't   need the previous node's conversation history</li> <li>Loop structures where each iteration requires a fresh message context</li> <li>Scenarios requiring complete message list reconstruction</li> </ul> <p>Notes:</p> <ul> <li><code>RemoveAllMessages{}</code> is a special <code>MessageOp</code> that <code>MessageReducer</code> recognizes   and uses to clear the message list</li> <li>Must set <code>RemoveAllMessages{}</code> before setting <code>StateKeyUserInput</code></li> <li><code>WithSubgraphIsolatedMessages(true)</code> only works for <code>AddSubgraphNode</code>, not for   <code>AddLLMNode</code>; use <code>RemoveAllMessages</code> to isolate messages between LLM nodes</li> </ul>"},{"location":"graph/#3-graphagent-configuration-options","title":"3. GraphAgent Configuration Options","text":"<p>GraphAgent supports various configuration options:</p> <pre><code>// Multiple options can be used when creating GraphAgent.\ngraphAgent, err := graphagent.New(\n    \"workflow-name\",\n    compiledGraph,\n    graphagent.WithDescription(\"Workflow description\"),\n    graphagent.WithInitialState(graph.State{\n        \"initial_data\": \"Initial data\",\n    }),\n    graphagent.WithChannelBufferSize(1024),            // Tune event buffer size\n    graphagent.WithCheckpointSaver(memorySaver),       // Persist checkpoints if needed\n    graphagent.WithSubAgents([]agent.Agent{subAgent}), // Register sub-agents by name\n    graphagent.WithAddSessionSummary(true),            // Inject session summary as system message\n    graphagent.WithMaxHistoryRuns(5),                  // Truncate history when summaries are off\n    // Set the filter mode for messages passed to the model. The final messages passed to the model must satisfy both WithMessageTimelineFilterMode and WithMessageBranchFilterMode conditions.\n    // Timeline dimension filter conditions\n    // Default: graphagent.TimelineFilterAll\n    // Optional values:\n    //  - graphagent.TimelineFilterAll: Includes historical messages as well as messages generated in the current request\n    //  - graphagent.TimelineFilterCurrentRequest: Only includes messages generated in the current request\n    //  - graphagent.TimelineFilterCurrentInvocation: Only includes messages generated in the current invocation context\n    graphagent.WithMessageTimelineFilterMode(graphagent.TimelineFilterAll),\n\n    // Branch dimension filter conditions\n    // Default: graphagent.BranchFilterModePrefix\n    // Optional values:\n    //  - graphagent.BranchFilterModeAll: Includes messages from all agents. Use this when the current agent interacts with the model and needs to synchronize all valid content messages generated by all agents to the model.\n    //  - graphagent.BranchFilterModePrefix: Filters messages by prefix matching Event.FilterKey with Invocation.eventFilterKey. Use this when you want to pass messages generated by the current agent and related upstream/downstream agents to the model.\n    //  - graphagent.BranchFilterModeExact: Filters messages where Event.FilterKey == Invocation.eventFilterKey. Use this when the current agent interacts with the model and only needs to use messages generated by the current agent.\n    graphagent.WithMessageBranchFilterMode(graphagent.BranchFilterModeAll),\n    // Reasoning content mode (for DeepSeek thinking mode)\n    // Default: graphagent.ReasoningContentModeDiscardPreviousTurns\n    // Options:\n    //  - graphagent.ReasoningContentModeDiscardPreviousTurns: Discard reasoning_content\n    //    from previous request turns (default, recommended).\n    //  - graphagent.ReasoningContentModeKeepAll: Keep all reasoning_content in history.\n    //  - graphagent.ReasoningContentModeDiscardAll: Discard all reasoning_content.\n    graphagent.WithReasoningContentMode(graphagent.ReasoningContentModeDiscardPreviousTurns),\n    graphagent.WithAgentCallbacks(&amp;agent.Callbacks{\n        // Agent-level callbacks.\n    }),\n)\n</code></pre> <p>Model/tool callbacks are configured per node, e.g. <code>AddLLMNode(..., graph.WithModelCallbacks(...))</code> or <code>AddToolsNode(..., graph.WithToolCallbacks(...))</code>.</p> <p>Session summary notes:</p> <ul> <li><code>WithAddSessionSummary(true)</code> takes effect only when <code>Session.Summaries</code> contains a summary for the invocation\u2019s filter key. Summaries are typically produced by SessionService + SessionSummarizer, and Runner will auto\u2011enqueue summarization after persisting events.</li> <li>GraphAgent reads summaries only; it does not generate them. If you bypass Runner, call <code>sessionService.CreateSessionSummary</code> or <code>EnqueueSummaryJob</code> after appending events.</li> <li>Summary injection works only when <code>TimelineFilterMode</code> is <code>TimelineFilterAll</code>.</li> </ul>"},{"location":"graph/#concurrency-considerations","title":"Concurrency considerations","text":"<p>When using Graph + GraphAgent in a concurrent environment (for example, serving many requests from a single long\u2011lived process), keep the following in mind:</p> <ul> <li>CheckpointSaver and Cache implementations must be concurrency\u2011safe   The <code>CheckpointSaver</code> and <code>Cache</code> interfaces are intentionally storage\u2011agnostic. A single <code>Executor</code>/<code>GraphAgent</code> instance may call their methods from multiple goroutines when several invocations run in parallel. If you provide your own implementations, ensure:<ul> <li>All exported methods (<code>Get</code>/<code>GetTuple</code>/<code>List</code>/<code>Put</code>/<code>PutWrites</code>/<code>PutFull</code>/<code>DeleteLineage</code> for <code>CheckpointSaver</code>, and <code>Get</code>/<code>Set</code>/<code>Clear</code> for <code>Cache</code>) are safe for concurrent use.</li> <li>Internal maps, connection pools, or in\u2011memory buffers are properly synchronized.</li> </ul> </li> </ul> <ul> <li>NodeFunc, tools, and callbacks should treat state as per\u2011invocation, not global   Each node receives an isolated copy of graph state for the current task. This copy is safe to mutate inside the node, but it is not safe to:<ul> <li>Store references to that state (or its internal maps/slices) in global variables and modify them from other goroutines later.</li> <li>Access <code>StateKeyExecContext</code> (<code>*graph.ExecutionContext</code>) and bypass its internal locks when reading/writing <code>execCtx.State</code> or <code>execCtx.pendingTasks</code>. If you need shared mutable state across nodes or invocations, protect it with your own synchronization (for example, <code>sync.Mutex</code> or <code>sync.RWMutex</code>) or use external services (such as databases or caches).</li> </ul> </li> </ul> <ul> <li>Do not share a single *agent.Invocation across goroutines   The framework expects each <code>Run</code> call (GraphAgent, Runner, or other Agent types) to operate on its own <code>*agent.Invocation</code>. Reusing the same <code>*agent.Invocation</code> instance in multiple goroutines and calling <code>Run</code> concurrently can cause data races on fields like <code>Branch</code>, <code>RunOptions</code>, or callback state. Prefer:<ul> <li>Creating a fresh <code>*agent.Invocation</code> per request, or</li> <li>Cloning from a parent invocation using <code>invocation.Clone(...)</code> when you need linkage.</li> </ul> </li> </ul> <ul> <li>Parallel tools require tool implementations to be safe for concurrent use   Tools in a <code>Tools</code> node can be executed in parallel when <code>WithEnableParallelTools(true)</code> is used on that node:<ul> <li>The framework guarantees that the <code>tools</code> map is only read during execution.</li> <li>It also guarantees that the shared graph state passed to tools is only read; updates are written back by nodes, not by tools. However, each <code>tool.Tool</code> implementation and its <code>tool.Callbacks</code> may be invoked from multiple goroutines at the same time. Make sure:</li> <li>Tool implementations do not mutate shared global state without proper locking.</li> <li>Any internal caches, HTTP clients, or client pools inside tools are safe for concurrent use.</li> </ul> </li> </ul> <p>These constraints are especially important in long\u2011running services where a single <code>Graph</code>/<code>Executor</code>/<code>GraphAgent</code> instance is reused for many invocations.</p> <p>Once sub-agents are registered you can delegate within the graph via agent nodes:</p> <pre><code>// Assume subAgent.Info().Name == \"assistant\"\nstateGraph.AddAgentNode(\"assistant\",\n    graph.WithName(\"Delegate to assistant agent\"),\n    graph.WithDescription(\"Invoke the pre-registered assistant agent\"),\n)\n\n// During execution the GraphAgent looks up a sub-agent with the same name and runs it\n</code></pre> <p>The agent node uses its ID for the lookup, so keep <code>AddAgentNode(\"assistant\")</code> aligned with <code>subAgent.Info().Name == \"assistant\"</code>.</p>"},{"location":"graph/#4-conditional-routing","title":"4. Conditional Routing","text":"<pre><code>// Define condition function.\nfunc complexityCondition(ctx context.Context, state graph.State) (string, error) {\n    complexity := state[\"complexity\"].(string)\n    if complexity == \"simple\" {\n        return \"simple_process\", nil\n    }\n    return \"complex_process\", nil\n}\n\n// Add conditional edges.\nstateGraph.AddConditionalEdges(\"analyze\", complexityCondition, map[string]string{\n    \"simple_process\":  \"simple_node\",\n    \"complex_process\": \"complex_node\",\n})\n</code></pre>"},{"location":"graph/#41-named-ends-pernode-ends","title":"4.1 Named Ends (Per\u2011node Ends)","text":"<p>When a node produces business outcomes (e.g., <code>approve</code>/<code>reject</code>/<code>manual_review</code>) and you want to route by those semantic labels, declare node\u2011local Named Ends (Ends).</p> <p>Why this helps:</p> <ul> <li>Central, declarative mapping from labels to concrete targets at the node site.</li> <li>Compile\u2011time validation: <code>Compile()</code> verifies every end target exists (or is the special <code>graph.End</code>).</li> <li>Unified routing: reused by both <code>Command.GoTo</code> and conditional edges.</li> <li>Decoupling: nodes express outcomes in business terms; the mapping ties outcomes to graph structure.</li> </ul> <p>API:</p> <pre><code>// Declare Ends on a node (label -&gt; concrete target)\nsg.AddNode(\"decision\", decideNode,\n    graph.WithEndsMap(map[string]string{\n        \"approve\": \"approved\",\n        \"reject\":  \"rejected\",\n        // You may map a label to the terminal End\n        // \"drop\":  graph.End,\n    }),\n)\n\n// Short form: label equals the target node ID\nsg.AddNode(\"router\", routerNode, graph.WithEnds(\"nodeB\", \"nodeC\"))\n</code></pre> <p>Command\u2011style routing (Command.GoTo):</p> <pre><code>func decideNode(ctx context.Context, s graph.State) (any, error) {\n    switch s[\"decision\"].(string) {\n    case \"approve\":\n        return &amp;graph.Command{GoTo: \"approve\"}, nil // label\n    case \"reject\":\n        return &amp;graph.Command{GoTo: \"reject\"}, nil\n    default:\n        return &amp;graph.Command{GoTo: \"reject\"}, nil\n    }\n}\n</code></pre> <p>Conditional edges can reuse Ends: when <code>AddConditionalEdges(from, condition, pathMap)</code> receives a <code>nil</code> <code>pathMap</code> or no match is found, the executor tries the node's Ends; if still no match, the return string is treated as a concrete node ID.</p> <p>Resolution precedence:</p> <ol> <li>Explicit mapping in the conditional edge's <code>pathMap</code>.</li> <li>The node's Ends mapping (label \u2192 concrete target).</li> <li>Treat the return string as a node ID.</li> </ol> <p>Compile\u2011time checks:</p> <ul> <li><code>WithEndsMap/WithEnds</code> targets are validated in <code>Compile()</code>.</li> <li>Targets must exist in the graph or be the special constant <code>graph.End</code>.</li> </ul> <p>Notes:</p> <ul> <li>Use the constant <code>graph.End</code> to terminate; do not use the string \"END\".</li> <li>With <code>Command.GoTo</code>, you don't need to add a static <code>AddEdge(from, to)</code> for the target; ensure the target exists and set <code>SetFinishPoint(target)</code> if it should end the graph.</li> </ul> <p>Runnable example: <code>examples/graph/multiends</code>.</p>"},{"location":"graph/#42-multiconditional-fanout","title":"4.2 Multi\u2011conditional Fan\u2011out","text":"<p>Sometimes a single decision needs to spawn multiple branches in parallel for independent processing (e.g., route to both summarization and tagging).</p> <p>API:</p> <pre><code>// Return multiple branch keys, each resolved to a concrete target.\nsg.AddMultiConditionalEdges(\n    \"router\",\n    func(ctx context.Context, s graph.State) ([]string, error) {\n        // Decide multiple paths at once\n        return []string{\"toA\", \"toB\"}, nil\n    },\n    map[string]string{\n        \"toA\": \"A\", // branch key -&gt; target node\n        \"toB\": \"B\",\n    },\n)\n</code></pre> <p>Notes:</p> <ul> <li>Results are de\u2011duplicated before triggering; repeated keys do not trigger a   target more than once in the same step.</li> <li>Resolution precedence for each branch key mirrors single\u2011conditional routing:<ol> <li>explicit <code>pathMap</code>; 2) node's Ends; 3) treat as node ID.</li> </ol> </li> <li>Visualization: when <code>pathMap</code> is omitted, DOT falls back to the node's Ends   mapping to render dashed conditional edges.</li> </ul>"},{"location":"graph/#5-tool-node-integration","title":"5. Tool Node Integration","text":"<pre><code>// Create tools.\ntools := map[string]tool.Tool{\n    \"calculator\": calculatorTool,\n    \"search\":     searchTool,\n}\n\n// Add tool node.\nstateGraph.AddToolsNode(\"tools\", tools)\n\n// Add conditional routing from LLM to tools.\nstateGraph.AddToolsConditionalEdges(\"llm_node\", \"tools\", \"fallback_node\")\n</code></pre> <p>Enable parallel tool execution for the Tools node (aligns with LLMAgent's option):</p> <pre><code>// Tools node runs tool calls concurrently when multiple tool_calls are present.\nstateGraph.AddToolsNode(\n    \"tools\",\n    tools,\n    graph.WithEnableParallelTools(true), // optional; default is serial\n)\n</code></pre> <p>Tool-call pairing and second entry into LLM:</p> <ul> <li>Scan <code>messages</code> backward from the tail to find the most recent <code>assistant(tool_calls)</code>; stop at <code>user</code> to ensure correct pairing.</li> <li>When returning from tools to the LLM node, since <code>user_input</code> is cleared, the LLM follows the \"Messages only\" branch and continues based on the tool response in history.</li> </ul>"},{"location":"graph/#placeholder-variables-in-llm-instructions","title":"Placeholder Variables in LLM Instructions","text":"<p>LLM nodes support placeholder injection in their <code>instruction</code> string (same rules as LLMAgent). Both native <code>{key}</code> and Mustache <code>{{key}}</code> syntaxes are accepted (Mustache is normalized to the native form automatically):</p> <ul> <li><code>{key}</code> / <code>{{key}}</code> \u2192 replaced by <code>session.State[\"key\"]</code></li> <li><code>{key?}</code> / <code>{{key?}}</code> \u2192 optional; missing values become empty</li> <li><code>{user:subkey}</code>, <code>{app:subkey}</code>, <code>{temp:subkey}</code> (and their Mustache forms) \u2192 access user/app/temp scopes (session services merge app/user state into session with these prefixes)</li> </ul> <p>Notes:</p> <ul> <li>GraphAgent writes the current <code>*session.Session</code> into graph state under <code>StateKeySession</code>; the LLM node reads values from there</li> <li>Unprefixed keys (e.g., <code>research_topics</code>) must be present directly in <code>session.State</code></li> </ul> <p>Example:</p> <pre><code>mdl := openai.New(modelName)\nstateGraph.AddLLMNode(\n  \"research\",\n  mdl,\n  \"You are a research assistant. Focus: {research_topics}. User: {user:topics?}. App: {app:banner?}.\",\n  nil,\n)\n</code></pre> <p>See the runnable example: <code>examples/graph/placeholder</code>.</p> <p>Injecting retrieval output and user input</p> <ul> <li>Upstream nodes can place ephemeral values into the session's <code>temp:</code> namespace so the LLM instruction can read them with placeholders.</li> <li>Pattern:</li> </ul> <pre><code>// In a node before the LLM node\nsg.AddNode(\"retrieve\", func(ctx context.Context, s graph.State) (any, error) {\n    // Suppose you computed `retrieved` and want to include current user input.\n    retrieved := \"\u2022 doc A...\\n\u2022 doc B...\"\n    var input string\n    if v, ok := s[graph.StateKeyUserInput].(string); ok { input = v }\n    if sess, _ := s[graph.StateKeySession].(*session.Session); sess != nil {\n        if sess.State == nil { sess.State = make(session.StateMap) }\n        sess.State[session.StateTempPrefix+\"retrieved_context\"] = []byte(retrieved)\n        sess.State[session.StateTempPrefix+\"user_input\"] = []byte(input)\n    }\n    return graph.State{}, nil\n})\n\n// LLM node instruction can reference {temp:retrieved_context} and {temp:user_input}\nsg.AddLLMNode(\"answer\", mdl,\n    \"Use context to answer.\\n\\nContext:\\n{temp:retrieved_context}\\n\\nQuestion: {temp:user_input}\",\n    nil)\n</code></pre> <p>Example: <code>examples/graph/retrieval_placeholder</code>.</p> <p>Best practices for placeholders and session state</p> <ul> <li>Ephemeral vs persistent: write per\u2011turn values to <code>temp:*</code> on <code>session.State</code> (session state). Persistent configuration should go through <code>SessionService</code> with <code>user:*</code>/<code>app:*</code>.</li> <li>Why direct write is OK: LLM nodes expand placeholders from the session object present in graph state; see graph/state_graph.go. GraphAgent puts the session into state; see agent/graphagent/graph_agent.go.</li> <li>Service guardrails: the in\u2011memory service intentionally disallows writing <code>temp:*</code> (and <code>app:*</code> via user updater); see session/inmemory/service.go.</li> <li>Concurrency: when multiple branches run in parallel, avoid multiple nodes mutating the same <code>session.State</code> keys. Prefer composing in a single node before the LLM, or store intermediate values in graph state then write once to <code>temp:*</code>.</li> <li>Observability: if you want parts of the prompt to appear in completion events, also store a compact summary in graph state (e.g., under <code>metadata</code>). The final event serializes non\u2011internal final state; see graph/events.go.</li> </ul>"},{"location":"graph/#6-node-retry-backoff","title":"6. Node Retry &amp; Backoff","text":"<p>Configure per\u2011node retry with exponential backoff and optional jitter. Failed attempts do not produce writes; only a successful attempt applies its state delta and routing.</p> <ul> <li>Per\u2011node policy via <code>WithRetryPolicy</code>:</li> </ul> <pre><code>// Simple convenience policy (attempts include the first try)\nsg.AddNode(\"unstable\", unstableFunc,\n    graph.WithRetryPolicy(graph.WithSimpleRetry(3)))\n\n// Full policy\npolicy := graph.RetryPolicy{\n    MaxAttempts:     3,                      // 1 initial + up to 2 retries\n    InitialInterval: 200 * time.Millisecond, // base delay\n    BackoffFactor:   2.0,                    // exponential backoff\n    MaxInterval:     2 * time.Second,        // clamp\n    Jitter:          true,                   // randomize delay\n    RetryOn: []graph.RetryCondition{\n        graph.DefaultTransientCondition(),   // deadline/net timeouts\n        graph.RetryOnErrors(context.DeadlineExceeded),\n        graph.RetryOnPredicate(func(err error) bool { return true }),\n    },\n    MaxElapsedTime:  5 * time.Second,        // total retry budget (optional)\n    // PerAttemptTimeout: 0,                 // reserved; node timeout comes from executor\n}\nsg.AddNode(\"unstable\", unstableFunc, graph.WithRetryPolicy(policy))\n</code></pre> <ul> <li>Default policy via Executor (applies when a node has none):</li> </ul> <pre><code>exec, _ := graph.NewExecutor(compiled,\n    graph.WithDefaultRetryPolicy(graph.WithSimpleRetry(2)))\n</code></pre> <p>Notes</p> <ul> <li>Interrupts are never retried.</li> <li>Backoff delay is clamped by the current step deadline when set (<code>WithStepTimeout</code>).</li> <li>Events carry retry metadata so UIs/CLIs can display progress:</li> </ul> <pre><code>if b, ok := ev.StateDelta[graph.MetadataKeyNode]; ok {\n    var md graph.NodeExecutionMetadata\n    _ = json.Unmarshal(b, &amp;md)\n    if md.Phase == graph.ExecutionPhaseError &amp;&amp; md.Retrying {\n        // md.Attempt, md.MaxAttempts, md.NextDelay\n    }\n}\n</code></pre> <p>Example: <code>examples/graph/retry</code> shows an unstable node that retries before a final LLM answer.</p>"},{"location":"graph/#7-runner-configuration","title":"7. Runner Configuration","text":"<p>Runner provides session management and execution environment:</p> <pre><code>// Create session service.\nsessionService := inmemory.NewSessionService()\n// Or use Redis session service.\n// sessionService, err := redis.NewService(redis.WithRedisClientURL(\"redis://localhost:6379\"))\n\n// Create Runner.\nappRunner := runner.NewRunner(\n    \"app-name\",\n    graphAgent,\n    runner.WithSessionService(sessionService),\n    // Can add more configuration options.\n)\n\n// Use Runner to execute workflow.\n// Runner only sets StateKeyUserInput; it no longer pre-populates StateKeyMessages.\nmessage := model.NewUserMessage(\"User input\")\neventChan, err := appRunner.Run(ctx, userID, sessionID, message)\n</code></pre>"},{"location":"graph/#8-message-state-schema","title":"8. Message State Schema","text":"<p>For conversational applications, you can use predefined message state schema:</p> <pre><code>// Use message state schema.\nschema := graph.MessagesStateSchema()\n\n// This schema includes:\n// - messages: Conversation history (StateKeyMessages).\n// - user_input: User input (StateKeyUserInput).\n// - last_response: Last response (StateKeyLastResponse).\n// - node_responses: Map of nodeID -&gt; response (StateKeyNodeResponses).\n// - metadata: Metadata (StateKeyMetadata).\n</code></pre>"},{"location":"graph/#9-state-key-usage-scenarios","title":"9. State Key Usage Scenarios","text":"<p>User-defined State Keys: Used to store business logic data.</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/graph\"\n)\n\n// Recommended: Use custom state keys.\nconst (\n    StateKeyDocumentLength = \"document_length\"\n    StateKeyComplexityLevel = \"complexity_level\"\n    StateKeyProcessingStage = \"processing_stage\"\n)\n\n// Use in nodes.\nreturn graph.State{\n    StateKeyDocumentLength: len(input),\n    StateKeyComplexityLevel: \"simple\",\n    StateKeyProcessingStage: \"completed\",\n}, nil\n</code></pre> <p>Built-in State Keys: Used for system integration.</p> <pre><code>import (\n    \"time\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/graph\"\n)\n\n// Get user input (automatically set by system).\nuserInput := state[graph.StateKeyUserInput].(string)\n\n// Set final output (system will read this value).\nreturn graph.State{\n    graph.StateKeyLastResponse: \"Processing complete\",\n}, nil\n\n// Read per-node responses when multiple nodes (e.g., parallel LLM nodes)\n// produce outputs. Values are stored as a map[nodeID]any and merged across\n// steps. Use LastResponse for the final serial output; use NodeResponses for\n// converged parallel outputs.\nresponses, _ := state[graph.StateKeyNodeResponses].(map[string]any)\nnews := responses[\"news\"].(string)\ndialog := responses[\"dialog\"].(string)\n\n// Use them separately or combine into the final output.\nreturn graph.State{\n    \"news_output\":  news,\n    \"dialog_output\": dialog,\n    graph.StateKeyLastResponse: news + \"\\n\" + dialog,\n}, nil\n\n// Store metadata.\nreturn graph.State{\n    graph.StateKeyMetadata: map[string]any{\n        \"timestamp\": time.Now(),\n        \"version\": \"1.0\",\n    },\n}, nil\n</code></pre>"},{"location":"graph/#advanced-features","title":"Advanced Features","text":""},{"location":"graph/#1-interrupt-and-resume-human-in-the-loop","title":"1. Interrupt and Resume (Human-in-the-Loop)","text":"<p>The Graph package supports human-in-the-loop (HITL) workflows through interrupt and resume functionality. This enables workflows to pause execution, wait for human input or approval, and then resume from the exact point where they were interrupted.</p>"},{"location":"graph/#basic-usage","title":"Basic Usage","text":"<pre><code>import (\n    \"context\"\n    \"trpc.group/trpc-go/trpc-agent-go/graph\"\n)\n\n// Create a node that can interrupt execution for human input\nb.AddNode(\"approval_node\", func(ctx context.Context, s graph.State) (any, error) {\n    // Use the Interrupt helper for clean interrupt/resume handling\n    prompt := map[string]any{\n        \"message\": \"Please approve this action (yes/no):\",\n        \"data\":    s[\"some_data\"],\n    }\n}\n</code></pre> <p>Turn the diagram into a runnable workflow:</p> <pre><code>package main\n\nimport (\n    \"context\"\n    \"fmt\"\n    \"strings\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/agent/graphagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/graph\"\n    \"trpc.group/trpc-go/trpc-agent-go/model\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/openai\"\n    \"trpc.group/trpc-go/trpc-agent-go/runner\"\n    \"trpc.group/trpc-go/trpc-agent-go/tool\"\n    \"trpc.group/trpc-go/trpc-agent-go/tool/function\"\n)\n\n// Unexported constants to avoid magic strings\nconst (\n    nodePrepare  = \"prepare\"\n    nodeAsk      = \"ask\"\n    nodeTools    = \"tools\"\n    nodeFallback = \"fallback\"\n    nodeFinish   = \"finish\"\n\n    modelName     = \"gpt-4o-mini\"\n    systemPrompt  = \"You are a careful assistant.\"\n    outputKeyFinal = \"final_output\"\n\n    toolNameCalculator = \"calculator\"\n\n    demoUserID    = \"user\"\n    demoSessionID = \"session\"\n    demoQuestion  = \"What is 6 * 7?\"\n)\n\nfunc newCalculator() tool.Tool {\n    type Input struct {\n        Expression string `json:\"expression\"`\n    }\n    type Output struct {\n        Result float64 `json:\"result\"`\n    }\n    return function.NewFunctionTool[Input, Output](\n        func(ctx context.Context, in Input) (Output, error) {\n            // Implement a real evaluator here\n            return Output{Result: 42}, nil\n        },\n        function.WithName(toolNameCalculator),\n        function.WithDescription(\"Evaluate a math expression\"),\n    )\n}\n\nfunc buildWorkflow(m model.Model, tools map[string]tool.Tool) (*graph.Graph, error) {\n    sg := graph.NewStateGraph(graph.MessagesStateSchema())\n\n    sg.AddNode(nodePrepare, func(ctx context.Context, s graph.State) (any, error) {\n        raw := fmt.Sprint(s[graph.StateKeyUserInput])\n        cleaned := strings.TrimSpace(raw)\n        return graph.State{graph.StateKeyUserInput: cleaned}, nil\n    })\n\n    sg.AddLLMNode(nodeAsk, m, systemPrompt, tools)\n    sg.AddToolsNode(nodeTools, tools)\n\n    sg.AddNode(nodeFallback, func(ctx context.Context, s graph.State) (any, error) {\n        return graph.State{graph.StateKeyLastResponse: \"No tools required; answer directly\"}, nil\n    })\n\n    sg.AddNode(nodeFinish, func(ctx context.Context, s graph.State) (any, error) {\n        return graph.State{outputKeyFinal: fmt.Sprint(s[graph.StateKeyLastResponse])}, nil\n    })\n\n    sg.SetEntryPoint(nodePrepare)\n    sg.AddEdge(nodePrepare, nodeAsk)\n    sg.AddToolsConditionalEdges(nodeAsk, nodeTools, nodeFallback)\n    sg.AddEdge(nodeTools, nodeAsk)\n    sg.AddEdge(nodeFallback, nodeFinish)\n    sg.SetFinishPoint(nodeFinish)\n\n    return sg.Compile()\n}\n\nfunc main() {\n    mdl := openai.New(modelName)\n    tools := map[string]tool.Tool{toolNameCalculator: newCalculator()}\n\n    g, err := buildWorkflow(mdl, tools)\n    if err != nil {\n        panic(err)\n    }\n\n    // Run with GraphAgent + Runner (no direct Executor.Execute)\n    ga, err := graphagent.New(\"demo\", g)\n    if err != nil {\n        panic(err)\n    }\n    app := runner.NewRunner(\"app\", ga)\n    events, err := app.Run(context.Background(), demoUserID, demoSessionID,\n        model.NewUserMessage(demoQuestion))\n    if err != nil {\n        panic(err)\n    }\n    for ev := range events {\n        if ev.Response == nil {\n            continue\n        }\n        if ev.Author == nodeAsk &amp;&amp; !ev.Response.IsPartial &amp;&amp; len(ev.Response.Choices) &gt; 0 {\n            fmt.Println(\"LLM:\", ev.Response.Choices[0].Message.Content)\n        }\n    }\n}\n</code></pre> <p>The example shows how to declare nodes, connect edges, and run. Next, we'll cover execution with GraphAgent + Runner, then core concepts and common practices.</p>"},{"location":"graph/#execution","title":"Execution","text":"<ul> <li>Wrap the compiled graph with <code>graphagent.New</code> (as a generic <code>agent.Agent</code>) and hand it to <code>runner.Runner</code> to manage sessions and streaming events.</li> </ul> <p>Minimal GraphAgent + Runner:</p> <pre><code>compiled, _ := buildWorkflow(openai.New(\"gpt-4o-mini\"), nil)\nga, _ := graphagent.New(\"demo\", compiled)\napp := runner.NewRunner(\"app\", ga)\n\nevents, _ := app.Run(ctx, \"user\", \"session\", model.NewUserMessage(\"hi\"))\nfor ev := range events { /* handle events */ }\n</code></pre> <p>Session backends:</p> <ul> <li>In-memory: <code>session/inmemory</code> (used by examples)</li> <li>Redis: <code>session/redis</code> (more common in production)</li> </ul> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/session/redis\"\n)\n\nsess, _ := redis.NewService(redis.WithRedisClientURL(\"redis://localhost:6379\"))\napp := runner.NewRunner(\"app\", ga, runner.WithSessionService(sess))\n</code></pre>"},{"location":"graph/#graphagent-options","title":"GraphAgent Options","text":"<pre><code>ga, err := graphagent.New(\n    \"workflow\",\n    compiledGraph,\n    graphagent.WithDescription(\"Workflow description\"),\n    graphagent.WithInitialState(graph.State{\"init\": 1}),\n    graphagent.WithChannelBufferSize(512),\n    graphagent.WithCheckpointSaver(saver),\n    graphagent.WithSubAgents([]agent.Agent{subAgent}), // Set Subagents\n    graphagent.WithAgentCallbacks(agent.NewCallbacks()), // Note: Structured callback API requires trpc-agent-go &gt;= 0.6.0\n    // Set the filter mode for messages passed to the model. The final messages passed to the model must satisfy both WithMessageTimelineFilterMode and WithMessageBranchFilterMode conditions.\n    // Timeline dimension filter conditions\n    // Default: graphagent.TimelineFilterAll\n    // Optional values:\n    //  - graphagent.TimelineFilterAll: Includes historical messages as well as messages generated in the current request\n    //  - graphagent.TimelineFilterCurrentRequest: Only includes messages generated in the current request\n    //  - graphagent.TimelineFilterCurrentInvocation: Only includes messages generated in the current invocation context\n    graphagent.WithMessageTimelineFilterMode(graphagent.TimelineFilterAll),\n\n    // Branch dimension filter conditions\n    // Default: graphagent.BranchFilterModePrefix\n    // Optional values:\n    //  - graphagent.BranchFilterModeAll: Includes messages from all agents. Use this when the current agent interacts with the model and needs to synchronize all valid content messages generated by all agents to the model.\n    //  - graphagent.BranchFilterModePrefix: Filters messages by prefix matching Event.FilterKey with Invocation.eventFilterKey. Use this when you want to pass messages generated by the current agent and related upstream/downstream agents to the model.\n    //  - graphagent.BranchFilterModeExact: Filters messages where Event.FilterKey == Invocation.eventFilterKey. Use this when the current agent interacts with the model and only needs to use messages generated by the current agent.\n    graphagent.WithMessageBranchFilterMode(graphagent.BranchFilterModeAll),\n)\n</code></pre>"},{"location":"graph/#core-concepts_1","title":"Core Concepts","text":""},{"location":"graph/#state-management","title":"State Management","text":"<p>GraphAgent uses a Schema + Reducer model to manage state. You first define the state shape and merge rules; later nodes have clear expectations about the origin and lifecycle of keys they read/write.</p>"},{"location":"graph/#builtin-schema","title":"Built\u2011in Schema","text":"<pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/graph\"\n)\n\nschema := graph.MessagesStateSchema()\n\n// Predefined fields (key constants) and semantics:\n// - graph.StateKeyMessages       (\"messages\")        Conversation history ([]model.Message; MessageReducer + MessageOp for atomic updates)\n// - graph.StateKeyUserInput      (\"user_input\")      User input (string; one-shot; cleared after successful execution)\n// - graph.StateKeyLastResponse   (\"last_response\")   Last response (string)\n// - graph.StateKeyNodeResponses  (\"node_responses\")  Per-node outputs (map[string]any; aggregated across parallel branches)\n// - graph.StateKeyMetadata       (\"metadata\")        Metadata (map[string]any; merged by MergeReducer)\n\n// Additional one-shot/system keys (use as needed):\n// - graph.StateKeyOneShotMessages (\"one_shot_messages\")  One-shot override of this turn's input ([]model.Message)\n// - graph.StateKeySession         (\"session\")            Session object (internal)\n// - graph.StateKeyExecContext     (\"exec_context\")       Execution context (events etc., internal)\n</code></pre>"},{"location":"graph/#custom-schema","title":"Custom Schema","text":"<pre><code>import (\n    \"reflect\"\n    \"trpc.group/trpc-go/trpc-agent-go/graph\"\n)\n\nschema := graph.NewStateSchema()\n\n// Add a custom field\nschema.AddField(\"counter\", graph.StateField{\n    Type:    reflect.TypeOf(0),\n    Default: func() any { return 0 },\n    Reducer: func(old, new any) any {\n        return old.(int) + new.(int)  // accumulate\n    },\n})\n\n// String slice with a built-in reducer\nschema.AddField(\"items\", graph.StateField{\n    Type:    reflect.TypeOf([]string{}),\n    Default: func() any { return []string{} },\n    Reducer: graph.StringSliceReducer,\n})\n</code></pre> <p>Reducers ensure fields are merged safely per predefined rules, which is critical under concurrent execution.</p> <p>Tip: define constants for business keys to avoid scattered magic strings.</p>"},{"location":"graph/#node-types","title":"Node Types","text":"<p>GraphAgent provides four built\u2011in node types:</p>"},{"location":"graph/#function-node","title":"Function Node","text":"<p>The most basic node, for custom logic:</p> <pre><code>import (\n    \"context\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/graph\"\n)\n\nconst (\n    stateKeyInput  = \"input\"\n    stateKeyOutput = \"output\"\n    nodeProcess    = \"process\"\n)\n\nsg.AddNode(nodeProcess, func(ctx context.Context, state graph.State) (any, error) {\n    data := state[stateKeyInput].(string)\n    processed := transform(data)\n    // Function nodes must explicitly specify the output key\n    return graph.State{stateKeyOutput: processed}, nil\n})\n</code></pre>"},{"location":"graph/#llm-node","title":"LLM Node","text":"<p>Integrates an LLM and auto\u2011manages conversation history:</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/graph\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/openai\"\n)\n\nconst (\n    llmModelName     = \"gpt-4o-mini\"\n    llmSystemPrompt  = \"System prompt\"\n    llmNodeAssistant = \"assistant\"\n)\n\nmodel := openai.New(llmModelName)\nsg.AddLLMNode(llmNodeAssistant, model, llmSystemPrompt, tools)\n\n// Inputs (priority): graph.StateKeyOneShotMessages &gt; graph.StateKeyUserInput &gt; graph.StateKeyMessages\n// Outputs: graph.StateKeyLastResponse, graph.StateKeyMessages (atomic), graph.StateKeyNodeResponses (includes this node's output for aggregation)\n</code></pre>"},{"location":"graph/#node-cache","title":"Node Cache","text":"<p>Enable caching for pure function-like nodes to avoid repeated computation.</p> <ul> <li>Graph-level settings:<ul> <li><code>WithCache(cache Cache)</code> sets the cache backend (an in-memory implementation is provided for testing)</li> <li><code>WithCachePolicy(policy *CachePolicy)</code> sets the default cache policy (key function + Time To Live, TTL)</li> </ul> </li> <li>Node-level override: <code>WithNodeCachePolicy(policy *CachePolicy)</code></li> <li>Clear by nodes: <code>ClearCache(nodes ...string)</code></li> </ul> <p>References:</p> <ul> <li>Graph accessors and setters: graph/graph.go</li> <li>Defaults and in-memory backend:<ul> <li>Interface/policy + canonical JSON + SHA\u2011256: graph/cache.go</li> <li>In-memory cache with read-write lock and deep copy: graph/cache.go</li> </ul> </li> <li>Executor:<ul> <li>Try Get before executing a node; on hit, skip the node function and only run callbacks + writes: graph/executor.go</li> <li>Persist Set after successful execution: graph/executor.go</li> <li>Attach <code>_cache_hit</code> flag on node.complete events: graph/executor.go</li> </ul> </li> </ul> <p>Minimal usage:</p> <pre><code>schema := graph.NewStateSchema()\nsg := graph.NewStateGraph(schema).\n  WithCache(graph.NewInMemoryCache()).\n  WithCachePolicy(graph.DefaultCachePolicy())\n\nnodePolicy := &amp;graph.CachePolicy{KeyFunc: graph.DefaultCachePolicy().KeyFunc, TTL: 10*time.Minute}\nsg.AddNode(\"compute\", computeFunc, graph.WithNodeCachePolicy(nodePolicy)).\n  SetEntryPoint(\"compute\").\n  SetFinishPoint(\"compute\")\n\ncompiled, _ := sg.Compile()\n</code></pre> <p>Advanced usage:</p> <ul> <li>Field-based keys (recommended)</li> </ul> <pre><code>package main\n\nimport (\n    \"context\"\n    \"time\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/graph\"\n)\n\nfunc build() (*graph.Graph, error) {\n    schema := graph.NewStateSchema()\n    sg := graph.NewStateGraph(schema).\n        WithCache(graph.NewInMemoryCache()).\n        WithCachePolicy(graph.DefaultCachePolicy())\n\n    compute := func(ctx context.Context, s graph.State) (any, error) {\n        return graph.State{\"out\": s[\"n\"].(int) * 2}, nil\n    }\n\n    // Use only `n` and `user_id` for cache key derivation; other fields won't affect hits\n    sg.AddNode(\"compute\", compute,\n        graph.WithNodeCachePolicy(&amp;graph.CachePolicy{KeyFunc: graph.DefaultCachePolicy().KeyFunc, TTL: 30*time.Minute}),\n        graph.WithCacheKeyFields(\"n\", \"user_id\"),\n    )\n\n    return sg.Compile()\n}\n</code></pre> <ul> <li>Custom selector (for complex projections)</li> </ul> <pre><code>package main\n\nimport (\n    \"context\"\n    \"time\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/graph\"\n)\n\nfunc build() (*graph.Graph, error) {\n    schema := graph.NewStateSchema()\n    sg := graph.NewStateGraph(schema).\n        WithCache(graph.NewInMemoryCache()).\n        WithCachePolicy(graph.DefaultCachePolicy())\n\n    compute := func(ctx context.Context, s graph.State) (any, error) { return graph.State{\"out\": 42}, nil }\n\n    sg.AddNode(\"compute\", compute,\n        graph.WithNodeCachePolicy(&amp;graph.CachePolicy{KeyFunc: graph.DefaultCachePolicy().KeyFunc, TTL: 5*time.Minute}),\n        graph.WithCacheKeySelector(func(m map[string]any) any {\n            // derive cache key input from sanitized map\n            return map[string]any{\"n\": m[\"n\"], \"uid\": m[\"uid\"]}\n        }),\n    )\n    return sg.Compile()\n}\n</code></pre> <ul> <li>Versioned namespace (avoid stale cache across versions)</li> </ul> <pre><code>package main\n\nimport (\n    \"trpc.group/trpc-go/trpc-agent-go/graph\"\n)\n\nfunc build() (*graph.Graph, error) {\n    schema := graph.NewStateSchema()\n    sg := graph.NewStateGraph(schema).\n        WithGraphVersion(\"v2025.03\"). // namespace becomes __writes__:v2025.03:&lt;node&gt;\n        WithCache(graph.NewInMemoryCache()).\n        WithCachePolicy(graph.DefaultCachePolicy())\n\n    // ... AddNode(...)\n    return sg.Compile()\n}\n</code></pre> <ul> <li>Per-node TTL (Time To Live)</li> </ul> <pre><code>package main\n\nimport (\n    \"context\"\n    \"time\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/graph\"\n)\n\nfunc build() (*graph.Graph, error) {\n    schema := graph.NewStateSchema()\n    sg := graph.NewStateGraph(schema).\n        WithCache(graph.NewInMemoryCache()).\n        WithCachePolicy(graph.DefaultCachePolicy())\n\n    compute := func(ctx context.Context, s graph.State) (any, error) { return graph.State{\"out\": 42}, nil }\n\n    sg.AddNode(\"compute\", compute,\n        graph.WithNodeCachePolicy(&amp;graph.CachePolicy{\n            KeyFunc: graph.DefaultCachePolicy().KeyFunc,\n            TTL:     10 * time.Minute,\n        }),\n    )\n    return sg.Compile()\n}\n</code></pre> <ul> <li>Clear cache (per node)</li> </ul> <pre><code>package main\n\nimport (\n    \"trpc.group/trpc-go/trpc-agent-go/graph\"\n)\n\nfunc clear(sg *graph.StateGraph) {\n    // clear specific nodes\n    sg.ClearCache(\"compute\", \"format\")\n\n    // clear all nodes in the graph (no args)\n    sg.ClearCache()\n}\n</code></pre> <ul> <li>Read cache-hit marker (<code>_cache_hit</code>)</li> </ul> <pre><code>package main\n\nimport (\n    \"context\"\n    \"fmt\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/agent\"\n    \"trpc.group/trpc-go/trpc-agent-go/event\"\n    \"trpc.group/trpc-go/trpc-agent-go/graph\"\n)\n\nfunc runAndReadHits(executor *graph.Executor, initial graph.State) error {\n    inv := &amp;agent.Invocation{InvocationID: \"demo\"}\n    ch, err := executor.Execute(context.Background(), initial, inv)\n    if err != nil { return err }\n    for e := range ch {\n        if e.Response != nil &amp;&amp; e.Response.Object == graph.ObjectTypeGraphNodeComplete {\n            if e.StateDelta != nil {\n                if _, ok := e.StateDelta[\"_cache_hit\"]; ok {\n                    fmt.Println(\"cache hit: skipped node function\")\n                }\n            }\n        }\n        if e.Done { break }\n    }\n    return nil\n}\n</code></pre> <p>Advanced usage:</p> <ul> <li>Field-based keys (recommended): declare <code>WithCacheKeyFields(\"n\", \"user_id\")</code> on a node; internally this maps the sanitized input to <code>{n, user_id}</code> before default canonicalization and hashing.</li> <li>Custom selector: <code>WithCacheKeySelector(func(m map[string]any) any { return map[string]any{\"n\": m[\"n\"], \"uid\": m[\"uid\"]} })</code></li> <li>Versioned namespace: <code>WithGraphVersion(\"v2025.03\")</code> expands the namespace to <code>__writes__:&lt;version&gt;:&lt;node&gt;</code>, reducing stale cache collisions across code changes.</li> </ul> <p>Notes:</p> <ul> <li>Prefer caching only pure functions (no side effects)</li> <li>TTL=0 means no expiration; consider a persistent backend (Redis/SQLite) in production</li> <li>Key function sanitizes input to avoid volatile/non-serializable fields being part of the key: graph/cache_key.go</li> <li>Call <code>ClearCache(\"nodeID\")</code> after code changes or include a function identifier/version in the key</li> </ul> <p>Runner + GraphAgent usage example:</p> <pre><code>package main\n\nimport (\n    \"bufio\"\n    \"context\"\n    \"flag\"\n    \"fmt\"\n    \"os\"\n    \"strings\"\n    \"time\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/agent\"\n    \"trpc.group/trpc-go/trpc-agent-go/agent/graphagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/graph\"\n    \"trpc.group/trpc-go/trpc-agent-go/model\"\n    \"trpc.group/trpc-go/trpc-agent-go/runner\"\n    \"trpc.group/trpc-go/trpc-agent-go/session/inmemory\"\n)\n\nfunc main() {\n    ttl := flag.Duration(\"ttl\", 1*time.Minute, \"cache ttl\")\n    flag.Parse()\n\n    // Build graph with cache\n    schema := graph.NewStateSchema()\n    sg := graph.NewStateGraph(schema).\n        WithCache(graph.NewInMemoryCache()).\n        WithCachePolicy(graph.DefaultCachePolicy())\n\n    compute := func(ctx context.Context, s graph.State) (any, error) {\n        n, _ := s[\"n\"].(int)\n        time.Sleep(200 * time.Millisecond)\n        return graph.State{\"out\": n * 2}, nil\n    }\n    sg.AddNode(\"compute\", compute,\n        graph.WithNodeCachePolicy(&amp;graph.CachePolicy{KeyFunc: graph.DefaultCachePolicy().KeyFunc, TTL: *ttl}),\n        graph.WithCacheKeyFields(\"n\"),\n    ).\n        SetEntryPoint(\"compute\").\n        SetFinishPoint(\"compute\")\n    g, _ := sg.Compile()\n\n    // GraphAgent + Runner\n    ga, _ := graphagent.New(\"cache-demo\", g, graphagent.WithInitialState(graph.State{}))\n    app := runner.NewRunner(\"app\", ga, runner.WithSessionService(inmemory.NewSessionService()))\n\n    // Interactive\n    sc := bufio.NewScanner(os.Stdin)\n    fmt.Println(\"Enter integers; repeated inputs should hit cache. type 'exit' to quit\")\n    for {\n        fmt.Print(\"&gt; \")\n        if !sc.Scan() { break }\n        txt := strings.TrimSpace(sc.Text())\n        if txt == \"exit\" { break }\n        if txt == \"\" { continue }\n        msg := model.NewUserMessage(fmt.Sprintf(\"compute %s\", txt))\n        evts, err := app.Run(context.Background(), \"user\", fmt.Sprintf(\"s-%d\", time.Now().UnixNano()), msg, agent.WithRuntimeState(graph.State{\"n\": atoi(txt)}))\n        if err != nil { fmt.Println(\"run error:\", err); continue }\n        for e := range evts {\n            if e.Response != nil &amp;&amp; e.Response.Object == graph.ObjectTypeGraphNodeComplete {\n                if e.StateDelta != nil { if _, ok := e.StateDelta[\"_cache_hit\"]; ok { fmt.Println(\"cache hit\") } }\n            }\n            if e.Done { break }\n        }\n    }\n}\n\nfunc atoi(s string) int { var n int; fmt.Sscanf(s, \"%d\", &amp;n); return n }\n</code></pre> <p>Example:</p> <ul> <li>Interactive + Runner + GraphAgent: examples/graph/nodecache/main.go</li> </ul>"},{"location":"graph/#tools-node","title":"Tools Node","text":"<p>Executes tool calls in sequence:</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/graph\"\n)\n\nconst nodeTools = \"tools\"\n\nsg.AddToolsNode(nodeTools, tools)\n// Multiple tools execute in the order returned by the LLM\n// For parallelism, use multiple nodes + parallel edges\n// Pairing rule: walk the messages from the tail to the most recent assistant(tool_calls)\n// message; stop at a new user to ensure pairing with the current tool call round.\n</code></pre>"},{"location":"graph/#reading-tool-results-into-state","title":"Reading Tool Results into State","text":"<p>After a tools node, add a function node to collect tool outputs from <code>graph.StateKeyMessages</code> and write a structured result into state:</p> <pre><code>const stateKeyToolResults = \"tool_results\"\n\nsg.AddNode(\"collect_tool_results\", func(ctx context.Context, s graph.State) (any, error) {\n    msgs, _ := s[graph.StateKeyMessages].([]model.Message)\n    if len(msgs) == 0 { return nil, nil }\n\n    // Find latest assistant(tool_calls) for this round\n    i := len(msgs) - 1\n    for i &gt;= 0 &amp;&amp; !(msgs[i].Role == model.RoleAssistant &amp;&amp; len(msgs[i].ToolCalls) &gt; 0) {\n        if msgs[i].Role == model.RoleUser { // crossed a new round\n            return nil, nil\n        }\n        i--\n    }\n    if i &lt; 0 { return nil, nil }\n\n    // Collect matching tool results (by ToolID)\n    idset := map[string]bool{}\n    for _, tc := range msgs[i].ToolCalls { idset[tc.ID] = true }\n    results := map[string]string{}\n    for j := i + 1; j &lt; len(msgs); j++ {\n        m := msgs[j]\n        if m.Role == model.RoleTool &amp;&amp; idset[m.ToolID] {\n            // Each tool decided its own output encoding; here treat content as JSON/text\n            results[m.ToolName] = m.Content\n        }\n        if m.Role == model.RoleUser { break }\n    }\n    if len(results) == 0 { return nil, nil }\n    return graph.State{stateKeyToolResults: results}, nil\n})\n</code></pre> <p>Reference example: <code>examples/graph/io_conventions_tools</code>.</p> <pre><code>#### Agent Node\nEmbed a sub\u2011agent to enable multi\u2011agent collaboration:\n\n```go\nimport (\n    \"trpc.group/trpc-go/trpc-agent-go/agent\"\n    \"trpc.group/trpc-go/trpc-agent-go/agent/graphagent\"\n)\n\nconst (\n    subAgentNameAnalyzer = \"analyzer\"\n    graphAgentNameMain   = \"main\"\n)\n\n// Important: node ID must match the sub\u2011agent's name\nsg.AddAgentNode(subAgentNameAnalyzer)\n\n// Inject sub\u2011agent instances when creating the GraphAgent\nanalyzer := createAnalyzer()  // internal agent name must be \"analyzer\"\ngraphAgent, _ := graphagent.New(graphAgentNameMain, g,\n    graphagent.WithSubAgents([]agent.Agent{analyzer}))\n</code></pre>"},{"location":"graph/#edges-and-routing","title":"Edges and Routing","text":"<p>Edges define control flow between nodes:</p> <pre><code>import (\n    \"context\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/graph\"\n)\n\nconst (\n    nodeA         = \"nodeA\"\n    nodeB         = \"nodeB\"\n    nodeDecision  = \"decision\"\n    nodePathA     = \"pathA\"\n    nodePathB     = \"pathB\"\n\n    routeToPathA  = \"route_to_pathA\"\n    routeToPathB  = \"route_to_pathB\"\n    stateKeyFlag  = \"flag\"\n)\n\n// Straight edge\nsg.AddEdge(nodeA, nodeB)\n\n// Conditional edges (third arg is the route map; provide explicitly for static checks)\n// Define target nodes first\nsg.AddNode(nodePathA, handlerA)\nsg.AddNode(nodePathB, handlerB)\n// Then add conditional routing\nsg.AddConditionalEdges(nodeDecision,\n    func(ctx context.Context, s graph.State) (string, error) {\n        if s[stateKeyFlag].(bool) {\n            return routeToPathA, nil\n        }\n        return routeToPathB, nil\n    }, map[string]string{\n        routeToPathA: nodePathA,\n        routeToPathB: nodePathB,\n    })\n\n// Tools conditional edges: handle LLM tool calls\nconst (\n    nodeLLM      = \"llm\"\n    nodeToolsUse = \"tools\"\n    nodeFallback = \"fallback\"\n)\nsg.AddToolsConditionalEdges(nodeLLM, nodeToolsUse, nodeFallback)\n\n// Parallel edges: branches from the same node run in parallel\nconst (\n    nodeSplit   = \"split\"\n    nodeBranch1 = \"branch1\"\n    nodeBranch2 = \"branch2\"\n)\nsg.AddEdge(nodeSplit, nodeBranch1)\nsg.AddEdge(nodeSplit, nodeBranch2)  // branch1 and branch2 execute in parallel\n</code></pre> <p>Tip: setting entry and finish points implicitly connects to virtual Start/End nodes:</p> <ul> <li><code>SetEntryPoint(\"first\")</code> is equivalent to Start \u2192 first.</li> <li><code>SetFinishPoint(\"last\")</code> is equivalent to last \u2192 End.   There's no need to add these two edges explicitly.</li> </ul> <p>Constants: <code>graph.Start == \"__start__\"</code>, <code>graph.End == \"__end__\"</code>.</p>"},{"location":"graph/#message-visibility-options","title":"Message Visibility Options","text":"<p>The Agent can dynamically manage the visibility of messages generated by other Agents and historical session messages based on different scenarios. This is configurable through relevant options. When interacting with the model, only the visible content is passed as input.</p> <p>TIPS: - Messages from different sessionIDs are never visible to each other under any circumstances. The following control strategies only apply to messages sharing the same sessionID. - Invocation.Message always visible regardless of the configuration. - The related configuration only controls the initial value of State[graph.StateKeyMessages]. - The messages generated by the Agent node have a filterKey corresponding to the subAgent name. As a result, when using IsolatedRequestor IsolatedInvocationfor filtering, these messages are not visible to the current graphAgent. - When the option is not configured, the default value is FullContext.</p> <p>Config: - <code>llmagent.WithMessageFilterMode(MessageFilterMode)</code>:   - <code>FullContext</code>: Includes historical messages and messages generated in the current request, filtered by prefix matching with the filterKey.   - <code>RequestContext</code>: Only includes messages generated in the current request, filtered by prefix matching with the filterKey.   - <code>IsolatedRequest</code>: Only includes messages generated in the current request, filtered by exact matching with the filterKey.   - <code>IsolatedInvocation</code>: Only includes messages generated in the current Invocation context, filtered by exact matching with the filterKey.</p> <p>Recommended Usage Examples (These examples are simplified configurations based on advanced usage):</p> <p>Example 1: Message Visibility Control for graphAgent <pre><code>subgraphAgentA := graphagent.New(\n    \"subgraphA\", subgraph,\n    // All messages generated by parentAgent, subgraphAgentA, and subgraphAgentB (including messages from task1 and task2) are visible (includes historical messages from the same sessionID)\n    graphagent.WithMessageFilterMode(graphagent.FullContext),\n    // All messages generated during the current runner.Run by parentAgent, subgraphAgentA, and subgraphAgentB (including messages from task1 and task2) are visible (excludes historical messages from previous sessions)\n    graphagent.WithMessageFilterMode(graphagent.RequestContext),\n    // Only messages generated by subgraphAgentA during the current runner.Run are visible (excludes its own historical messages)\n    graphagent.WithMessageFilterMode(graphagent.IsolatedRequest),\n    // Only messages generated during the current invocation of subgraphAgentA are visible (in this example, subgraphAgentA executes only once, making it equivalent to graphagent.IsolatedRequest)\n    graphagent.WithMessageFilterMode(graphagent.IsolatedInvocation),\n)\n\nsubgraphAgentB := graphagent.New(\n    \"subgraphB\", subgraph,\n    // All messages generated by parentAgent, subgraphAgentA, and subgraphAgentB (including messages from task1 and task2) are visible (includes historical messages from the same sessionID)\n    graphagent.WithMessageFilterMode(graphagent.FullContext),\n    // All messages generated during the current runner.Run by parentAgent, subgraphAgentA, and subgraphAgentB (including messages from task1 and task2) are visible (excludes historical messages from previous sessions)\n    graphagent.WithMessageFilterMode(graphagent.RequestContext),\n    // Only messages generated by subgraphAgentB (including messages from task1 and task2) during the current runner.Run are visible (excludes its own historical messages)\n    graphagent.WithMessageFilterMode(graphagent.IsolatedRequest),\n    // Only messages generated during the current invocation of subgraphAgentB are visible, excluding historical messages (messages generated during task1 and task2 executions are not visible to each other).\n    graphagent.WithMessageFilterMode(graphagent.IsolatedInvocation),\n)\n\nsg.AddAgentNode(\"subgraphA\")\nsg.AddNode(\"fanout\", func(ctx context.Context, state graph.State) (any, error) {\n    return []*graph.Command{\n        {\n            GoTo: \"subgraph\",\n            Update: graph.State{\n                \"task\": \"task 1\"\n            },\n        },\n        {\n            GoTo: \"subgraph\",\n            Update: graph.State{\n                \"task\": \"task 2\"\n            },\n        },\n    }, nil\n})\nsg.AddAgentNode(\"subgraphB\")\nsg.AddEdge(\"subgraphA\", \"fanout\")\nsg.SetEntryPoint(subgraphA)\ngraph, err := sg.Compile()\nif err != nil {\n    log.Fatalf(\"Failed to Compile state graph, err: %w\", err)\n}\nparentAgent := graphagent.New(\n    \"subgraph\", graph,\n    // subagent\n    graphagent.WithSubAgents(subgraphAgent)\n)\n</code></pre></p> <p>Example 2: Message Visibility Control for LLM Agent node <pre><code>taskagentA := llmagent.New(\n  \"coordinator\",\n  llmagent.WithModel(modelInstance),\n  // Makes all messages generated by taskagentA and taskagentB visible (including historical session messages under the same sessionID)\n  llmagent.WithMessageFilterMode(llmagent.FullContext),\n  // Makes all messages generated during the current runner.Run of taskagentA and taskagentB visible (excluding historical session messages)\n  llmagent.WithMessageFilterMode(llmagent.RequestContext),\n  // Only makes messages generated during the current runner.Run of taskagentA visible (excluding its own historical session messages)\n  llmagent.WithMessageFilterMode(llmagent.IsolatedRequest),\n  // Agent execution order: taskagentA-invocation1 -&gt; taskagentB-invocation2 -&gt; taskagentA-invocation3 (current execution phase)\n  // Only makes messages generated during the current taskagentA-invocation3 phase visible (excluding its own historical session messages and messages generated during taskagentA-invocation1)\n  llmagent.WithMessageFilterMode(llmagent.IsolatedInvocation),\n)\n\ntaskagentB := llmagent.New(\n  \"coordinator\",\n  llmagent.WithModel(modelInstance),\n  // Makes all messages generated by taskagentA and taskagentB visible (including historical session messages under the same sessionID)\n  llmagent.WithMessageFilterMode(llmagent.FullContext),\n  // Makes all messages generated during the current runner.Run of taskagentA and taskagentB visible (excluding historical session messages)\n  llmagent.WithMessageFilterMode(llmagent.RequestContext),\n  // Only makes messages generated during the current runner.Run of taskagentB visible (excluding its own historical session messages)\n  llmagent.WithMessageFilterMode(llmagent.IsolatedRequest),\n  // Agent execution order: taskagentA-invocation1 -&gt; taskagentB-invocation2 -&gt; taskagentA-invocation3 -&gt; taskagentB-invocation4 (current execution phase)\n  // Only makes messages generated during the current taskagentB-invocation4 phase visible (excluding its own historical session messages and messages generated during taskagentB-invocation2)\n  llmagent.WithMessageFilterMode(llmagent.IsolatedInvocation),\n)\n\n// Cyclically execute taskagentA and taskagentB\ncycleAgent := cycleagent.New(\n  \"coordinator\",\n  llmagent.WithModel(modelInstance),\n  llmagent.WithSubAgents([]agent.Agent{taskagentA, taskagentB}),\n  llmagent.WithMessageFilterMode(llmagent.FullContext)\n)\n\nsg.AddAgentNode(\"taskagentA\")\n// Execute multiple tasks in parallel at the same time\nsg.AddNode(\"fanout\", func(ctx context.Context, state graph.State) (any, error) {\n    return []*graph.Command{\n        {\n            GoTo: \"taskB\",\n            Update: graph.State{\n                \"task\": \"task 1\"\n            },\n        },\n        {\n            GoTo: \"taskB\",\n            Update: graph.State{\n                \"task\": \"task 2\"\n            },\n        },\n    }, nil\n})\n// You can set the message filter mode of taskagentB to llmagent.IsolatedInvocation to isolate contextual conversation information between multiple tasks.\nsg.AddNode(\"taskB\", func(ctx context.Context, state graph.State) (any, error){\n    task := state[\"task-id\"]\n    inv, _ := agent.InvocationFromContext(ctx)\n    inv.Message = model.NewUserMessage(task)\n    chan, err := taskagentB.Run(ctx, inv)\n    // do any thing\n})\n</code></pre></p> <p>Advanced Usage Examples: You can independently control the visibility of historical messages and messages generated by other Agents for the current agent using WithMessageTimelineFilterModeand WithMessageBranchFilterMode. When the current agent interacts with the model, only messages satisfying both conditions are input to the model. (invocation.Messageis always visible in any scenario.) - <code>WithMessageTimelineFilterMode</code>: Controls visibility from a temporal dimension   - <code>TimelineFilterAll</code>: Includes historical messages and messages generated in the current request.   - <code>TimelineFilterCurrentRequest</code>: Only includes messages generated in the current request (one runner.Runcounts as one request).   - <code>TimelineFilterCurrentInvocation</code>: Only includes messages generated in the current invocation context. - <code>WithMessageBranchFilterMode</code>: Controls visibility from a branch dimension (used to manage visibility of messages generated by other agents).   - <code>BranchFilterModePrefix</code>: Uses prefix matching between Event.FilterKeyand Invocation.eventFilterKey.   - <code>BranchFilterModeAll</code>: Includes messages from all agents.   - <code>BranchFilterModeExact</code>: Only includes messages generated by the current agent.</p> <pre><code>llmAgent := llmagent.New(\n    \"demo-agent\",                      // Agent name\n    llmagent.WithModel(modelInstance), // Set the model\n    llmagent.WithDescription(\"A helpful AI assistant for demonstrations\"),              // Set description\n    llmagent.WithInstruction(\"Be helpful, concise, and informative in your responses\"), // Set instruction\n    llmagent.WithGenerationConfig(genConfig),                                           // Set generation parameters\n\n    // Set the message filtering mode for input to the model. The final messages passed to the model must satisfy both WithMessageTimelineFilterMode and WithMessageBranchFilterMode conditions.\n    // Temporal dimension filtering condition\n    // Default: llmagent.TimelineFilterAll\n    // Options:\n    //  - llmagent.TimelineFilterAll: Includes historical messages and messages generated in the current request.\n    //  - llmagent.TimelineFilterCurrentRequest: Only includes messages generated in the current request.\n    //  - llmagent.TimelineFilterCurrentInvocation: Only includes messages generated in the current invocation context.\n    llmagent.WithMessageTimelineFilterMode(llmagent.TimelineFilterAll),\n    // Branch dimension filtering condition\n    // Default: llmagent.BranchFilterModePrefix\n    // Options:\n    //  - llmagent.BranchFilterModeAll: Includes messages from all agents. Use this when the current agent needs to sync valid content messages generated by all agents to the model during interaction.\n    //  - llmagent.BranchFilterModePrefix: Filters messages by prefix matching Event.FilterKey with Invocation.eventFilterKey. Use this when you want to pass messages generated by the current agent and related upstream/downstream agents to the model.\n    //  - llmagent.BranchFilterModeExact: Filters messages where Event.FilterKey exactly matches Invocation.eventFilterKey. Use this when the current agent only needs to use messages generated by itself during model interaction.\n    llmagent.WithMessageBranchFilterMode(llmagent.BranchFilterModeAll),\n)\n</code></pre>"},{"location":"graph/#command-mode-dynamic-routing-fanout","title":"Command Mode (Dynamic Routing / Fan\u2011out)","text":"<p>Nodes can return <code>graph.State</code>, or <code>*graph.Command</code> / <code>[]*graph.Command</code> to update state and direct the next hop:</p> <pre><code>// Dynamic route to A or B with a state write\nconst (\n    nodeDecide = \"decide\"\n    nodeA      = \"A\"\n    nodeB      = \"B\"\n    stateKeyFlag = \"flag\"\n)\n\nsg.AddNode(nodeDecide, func(ctx context.Context, s graph.State) (any, error) {\n    if s[stateKeyFlag].(bool) {\n        return &amp;graph.Command{Update: graph.State{\"routed\": nodeA}, GoTo: nodeA}, nil\n    }\n    return &amp;graph.Command{Update: graph.State{\"routed\": nodeB}, GoTo: nodeB}, nil\n})\n\n// Fan-out: dispatch multiple tasks to the same worker in parallel\nconst (\n    nodeFanout = \"fanout\"\n    nodeWorker = \"worker\"\n)\nsg.AddNode(nodeFanout, func(ctx context.Context, s graph.State) (any, error) {\n    cmds := []*graph.Command{\n        {Update: graph.State{\"param\": \"A\"}, GoTo: nodeWorker},\n        {Update: graph.State{\"param\": \"B\"}, GoTo: nodeWorker},\n        {Update: graph.State{\"param\": \"C\"}, GoTo: nodeWorker},\n    }\n    return cmds, nil\n})\n</code></pre> <p>When using command\u2011based routing, you don't need static edges to <code>GoTo</code> targets; just ensure the target nodes exist and call <code>SetFinishPoint</code> where appropriate.</p>"},{"location":"graph/#architecture","title":"Architecture","text":""},{"location":"graph/#overall-architecture","title":"Overall Architecture","text":"<p>GraphAgent's architecture manages complexity via clear layering. Each layer has a well\u2011defined responsibility and communicates through standard interfaces.</p> <pre><code>flowchart TB\n    subgraph \"Runner Layer\"\n        R[Runner]:::runnerClass\n        S[Session Service]:::sessionClass\n    end\n\n    subgraph \"GraphAgent\"\n        GA[GraphAgent Wrapper]:::agentClass\n        CB[Callbacks]:::callbackClass\n    end\n\n    subgraph \"Graph Engine\"\n        SG[StateGraph Builder]:::builderClass\n        G[Graph]:::graphClass\n        E[Executor]:::executorClass\n    end\n\n    subgraph \"Execution Components\"\n        P[Planning]:::phaseClass\n        EX[Execution]:::phaseClass\n        U[Update]:::phaseClass\n    end\n\n    subgraph \"Storage\"\n        CP[Checkpoint]:::storageClass\n        ST[State Store]:::storageClass\n    end\n\n    R --&gt; GA\n    GA --&gt; G\n    G --&gt; E\n    E --&gt; P\n    E --&gt; EX\n    E --&gt; U\n    E --&gt; CP\n\n    classDef runnerClass fill:#e8f5e9,stroke:#43a047,stroke-width:2px\n    classDef sessionClass fill:#f3e5f5,stroke:#8e24aa,stroke-width:2px\n    classDef agentClass fill:#e3f2fd,stroke:#1976d2,stroke-width:2px\n    classDef callbackClass fill:#fce4ec,stroke:#c2185b,stroke-width:2px\n    classDef builderClass fill:#fff8e1,stroke:#f57c00,stroke-width:2px\n    classDef graphClass fill:#f1f8e9,stroke:#689f38,stroke-width:2px\n    classDef executorClass fill:#e0f2f1,stroke:#00796b,stroke-width:2px\n    classDef phaseClass fill:#ede7f6,stroke:#512da8,stroke-width:2px\n    classDef storageClass fill:#efebe9,stroke:#5d4037,stroke-width:2px</code></pre>"},{"location":"graph/#core-modules","title":"Core Modules","text":"<p>Overview of core components:</p> <p><code>graph/state_graph.go</code> \u2014 StateGraph builder Provides a fluent, declarative Go API to build graphs via method chaining (AddNode \u2192 AddEdge \u2192 Compile) covering nodes, edges, and conditional routing.</p> <p><code>graph/graph.go</code> \u2014 Compiled runtime Implements channel\u2011based, event\u2011triggered execution. Node results merge into State; channels are used to drive routing and carry sentinel values (not business data).</p> <p><code>graph/executor.go</code> \u2014 BSP executor Heart of the system, inspired by Google's Pregel. Implements BSP (Bulk Synchronous Parallel) supersteps: Planning \u2192 Execution \u2192 Update.</p> <p><code>graph/checkpoint/*</code> \u2014 Checkpoints and recovery Optional checkpoint persistence (e.g., sqlite). Atomically saves state and pending writes; supports lineage/checkpoint\u2011based recovery.</p> <p><code>agent/graphagent/graph_agent.go</code> \u2014 Bridge between Graph and Agent Adapts a compiled Graph into a generic Agent, reusing sessions, callbacks, and streaming.</p>"},{"location":"graph/#execution-model","title":"Execution Model","text":"<p>GraphAgent adapts Pregel's BSP (Bulk Synchronous Parallel) to a single\u2011process runtime and adds checkpoints, HITL interrupts/resumes, and time travel:</p> <pre><code>sequenceDiagram\n    autonumber\n    participant R as Runner\n    participant GA as GraphAgent\n    participant EX as Executor\n    participant CK as Checkpoint Saver\n    participant DB as Storage\n    participant H as Human\n\n    R-&gt;&gt;GA: Run(invocation)\n    GA-&gt;&gt;EX: Execute(graph, state, options)\n    GA--&gt;&gt;R: Stream node/tool/model events\n\n    loop Each superstep (BSP)\n        EX-&gt;&gt;EX: Planning \u2014 compute frontier\n        par Parallel node execution\n            EX-&gt;&gt;EX: Run node i (shallow state copy)\n            EX--&gt;&gt;GA: node-start event (author=nodeID)\n        and\n            EX-&gt;&gt;EX: Run node j (shallow state copy)\n            EX--&gt;&gt;GA: node-start event\n        end\n\n        alt Node triggers Interrupt(key,prompt)\n            EX-&gt;&gt;CK: Save checkpoint(state,frontier,\n            EX-&gt;&gt;CK: pending_writes,versions_seen,reason=interrupt)\n            CK-&gt;&gt;DB: atomic commit\n            EX--&gt;&gt;GA: interrupt event(checkpoint_id,prompt)\n            GA--&gt;&gt;R: propagate + pause\n            R-&gt;&gt;H: ask for input/approval\n            H--&gt;&gt;R: provide decision/value\n            R-&gt;&gt;GA: Run(resume) runtime_state{\n            R-&gt;&gt;GA: checkpoint_id,resume_map}\n            GA-&gt;&gt;EX: ResumeFromCheckpoint(checkpoint_id,resume_map)\n            EX-&gt;&gt;CK: Load checkpoint\n            CK-&gt;&gt;EX: state/frontier/pending_writes/versions_seen\n            EX-&gt;&gt;EX: rebuild frontier and apply resume values\n        else Normal\n            EX--&gt;&gt;GA: node-complete events (incl. tool/model)\n            EX-&gt;&gt;EX: Update \u2014 merge via reducers\n            EX-&gt;&gt;CK: Save checkpoint(state,frontier,\n            EX-&gt;&gt;CK: pending_writes,versions_seen)\n            CK-&gt;&gt;DB: atomic commit\n        end\n    end\n\n    Note over EX,CK: versions_seen prevents re-execution\n    Note over EX,CK: pending_writes rebuilds channels\n    Note over EX,CK: parent_id forms lineage for time travel\n\n    opt Time travel (rewind/branch)\n        R-&gt;&gt;GA: Run(runtime_state{checkpoint_id})\n        GA-&gt;&gt;EX: ResumeFromCheckpoint(checkpoint_id)\n        EX-&gt;&gt;CK: Load checkpoint + lineage\n        CK-&gt;&gt;EX: Restore state; may create new lineage_id\n    end\n\n    EX--&gt;&gt;GA: done event (last_response)\n    GA--&gt;&gt;R: final output</code></pre> <pre><code>flowchart TB\n    %% Execution panorama (compact wiring)\n    subgraph Client\n        R[Runner]:::runner --&gt; GA[GraphAgent]:::agent\n    end\n\n    subgraph Engine[Graph Engine]\n        GA --&gt; EX[Executor]:::executor\n        subgraph BSP[\"BSP Superstep\"]\n            P[Planning]:::phase --&gt; X[Execution]:::phase --&gt; U[Update]:::phase\n        end\n    end\n\n    N[Nodes: LLM / Tools / Function / Agent]:::process\n    CK[(Checkpoint)]:::storage\n    H[Human]:::human\n\n    EX --&gt; BSP\n    EX --&gt; N\n    EX -.-&gt; CK\n    GA &lt;--&gt; H\n    GA --&gt; R\n\n    classDef runner fill:#e8f5e9,stroke:#43a047,stroke-width:2px\n    classDef agent fill:#e3f2fd,stroke:#1976d2,stroke-width:2px\n    classDef executor fill:#e0f2f1,stroke:#00796b,stroke-width:2px\n    classDef phase fill:#ede7f6,stroke:#512da8,stroke-width:2px\n    classDef process fill:#f3e5f5,stroke:#9c27b0,stroke-width:2px\n    classDef storage fill:#efebe9,stroke:#6d4c41,stroke-width:2px\n    classDef human fill:#e8f5e9,stroke:#43a047,stroke-width:2px</code></pre> <p>Key points:</p> <ol> <li>Planning: determine runnable nodes from the channel frontier.</li> <li>Execution: each node gets a shallow state copy (maps.Copy) and runs in parallel.</li> <li>Update: reducers merge updates safely for concurrency.</li> </ol> <p>This design enables per\u2011step observability and safe interruption/recovery.</p>"},{"location":"graph/#runtime-isolation-and-event-snapshots","title":"Runtime Isolation and Event Snapshots","text":"<ul> <li>The Executor is reusable and concurrency\u2011safe. Per\u2011run state lives in <code>ExecutionContext</code> (channel versions, pending writes, last checkpoint, etc.).</li> <li>Each event's <code>StateDelta</code> is a deep\u2011copy snapshot containing only serializable and allowed keys; internal keys (execution context, callbacks, etc.) are filtered out for external telemetry and persistence.</li> </ul>"},{"location":"graph/#executor-configuration","title":"Executor Configuration","text":"<pre><code>exec, err := graph.NewExecutor(g,\n    graph.WithChannelBufferSize(1024),              // event channel buffer\n    graph.WithMaxSteps(50),                          // max steps\n    graph.WithStepTimeout(5*time.Minute),            // step timeout\n    graph.WithNodeTimeout(2*time.Minute),            // node timeout\n    graph.WithCheckpointSaver(saver),                // enable checkpoints (sqlite/inmemory)\n    graph.WithCheckpointSaveTimeout(30*time.Second), // checkpoint save timeout\n)\n</code></pre>"},{"location":"graph/#defaults-and-notes","title":"Defaults and Notes","text":"<ul> <li> <p>Defaults (Executor)</p> <ul> <li><code>ChannelBufferSize = 256</code>, <code>MaxSteps = 100</code>, <code>CheckpointSaveTimeout = 10s</code></li> <li>Per\u2011step/node timeouts are available on <code>Executor</code> via <code>WithStepTimeout</code> / <code>WithNodeTimeout</code> (not exposed by <code>GraphAgent</code> options yet)</li> </ul> </li> </ul> <ul> <li>Sessions<ul> <li>Prefer Redis session backend in production; set TTLs and cleanup</li> </ul> </li> <li>Runner seeds multi\u2011turn <code>graph.StateKeyMessages</code> from session events automatically</li> </ul> <ul> <li> <p>Checkpoints</p> <ul> <li>Use stable <code>namespace</code> names (e.g., <code>svc:prod:flowX</code>); audit and clean up by lineage via <code>CheckpointManager</code></li> </ul> </li> </ul> <ul> <li> <p>Events/backpressure</p> <ul> <li>Tune <code>WithChannelBufferSize</code>; filter events by <code>author</code>/<code>object</code> to reduce noise</li> </ul> </li> </ul> <ul> <li> <p>Naming and keys</p> <ul> <li>Use constants for node IDs, route labels, and state keys; define reducers for non\u2011trivial merges</li> </ul> </li> </ul> <ul> <li>Governance</li> <li>Insert HITL on critical paths; prefer storing sensitive details under <code>graph.StateKeyMetadata</code> rather than <code>graph.StateKeyMessages</code></li> </ul>"},{"location":"graph/#integrating-with-multiagent-systems","title":"Integrating with Multi\u2011Agent Systems","text":"<p>GraphAgent is designed to be part of the tRPC\u2011Agent\u2011Go multi\u2011agent ecosystem, not an island. It implements the standard Agent interface and collaborates with other agent types.</p>"},{"location":"graph/#graphagent-as-an-agent","title":"GraphAgent as an Agent","text":"<p>GraphAgent implements the standard Agent interface:</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/agent\"\n    \"trpc.group/trpc-go/trpc-agent-go/agent/chainagent\"\n)\n\n// Use directly inside ChainAgent, ParallelAgent, CycleAgent\nchain := chainagent.New(\"chain\",\n    chainagent.WithSubAgents([]agent.Agent{\n        graphAgent1,  // structured flow #1\n        graphAgent2,  // structured flow #2\n    }))\n</code></pre>"},{"location":"graph/#advanced-orchestration","title":"Advanced Orchestration","text":"<p>End\u2011to\u2011end business flow: entry normalization \u2192 smart routing \u2192 multiple pods (Email, Weather, Research) \u2192 parallel fan\u2011out/aggregation \u2192 final composition and publish.</p> <pre><code>flowchart LR\n    %% Layout\n    subgraph UE[\"User &amp; Entry\"]\n        U((User)):::human --&gt; IN[\"entry&lt;br/&gt;normalize\"]:::process\n    end\n\n    subgraph FAB[\"Graph Orchestration\"]\n        Rtr[\"where_to_go&lt;br/&gt;router\"]:::router\n        Compose[\"compose&lt;br/&gt;LLM\"]:::llm\n    end\n\n    IN --&gt; Rtr\n\n    %% Email Agent (expanded)\n    subgraph EC[\"Email Agent\"]\n        direction LR\n        CE[\"classifier&lt;br/&gt;LLM\"]:::llm --&gt; WE[\"writer&lt;br/&gt;LLM\"]:::llm\n    end\n\n    %% Weather Agent (expanded)\n    subgraph WA[\"Weather Agent\"]\n        direction LR\n        LE[\"locate&lt;br/&gt;LLM\"]:::llm --&gt; WT[\"weather tool\"]:::tool\n    end\n\n    %% Routing from router to pods\n    Rtr -- email --&gt; CE\n    Rtr -- weather --&gt; LE\n    Rtr -- other --&gt; REPLY[\"reply&lt;br/&gt;LLM\"]:::llm\n\n    %% Fanout Pipeline (fanout \u2192 workers \u2192 aggregate)\n    subgraph FP[\"Fanout Pipeline\"]\n        direction LR\n        Fan[\"plan_fanout\"]:::process --&gt; W1[\"worker A\"]:::process\n        Fan --&gt; W2[\"worker B\"]:::process\n        Fan --&gt; W3[\"worker C\"]:::process\n        W1 --&gt; Agg[\"aggregate\"]:::process\n        W2 --&gt; Agg\n        W3 --&gt; Agg\n    end\n    Rtr -- research --&gt; Fan\n\n    %% Human-in-the-loop (optional)\n    Compose -. review .- HG[\"human&lt;br/&gt;review\"]:::human\n\n    %% Compose final (minimal wiring)\n    Agg --&gt; Compose\n    WE --&gt; Compose\n    WT --&gt; Compose\n    REPLY --&gt; Compose\n    Compose --&gt; END([END]):::terminal\n\n    %% Styles\n    classDef router fill:#fff7e0,stroke:#f5a623,stroke-width:2px\n    classDef llm fill:#e3f2fd,stroke:#1e88e5,stroke-width:2px\n    classDef tool fill:#fff3e0,stroke:#fb8c00,stroke-width:2px\n    classDef process fill:#f3e5f5,stroke:#8e24aa,stroke-width:2px\n    classDef human fill:#e8f5e9,stroke:#43a047,stroke-width:2px\n    classDef terminal fill:#ffebee,stroke:#e53935,stroke-width:2px</code></pre> <p>Highlights:</p> <ul> <li><code>where_to_go</code> can be LLM\u2011decided or function\u2011driven (conditional edges).</li> <li>Fanout Pipeline uses Command GoTo at runtime, then aggregates.</li> <li>Optional human review follows aggregation to gate critical output.</li> <li>Single checkpoint display at Compose balances clarity and recoverability.</li> </ul>"},{"location":"graph/#embedding-agents-in-a-graph","title":"Embedding Agents in a Graph","text":"<p>Inside a graph, you can call existing sub\u2011agents as nodes. The example below shows how to create sub\u2011agents, declare the corresponding nodes, and inject them when constructing the GraphAgent.</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/agent\"\n    \"trpc.group/trpc-go/trpc-agent-go/agent/graphagent\"\n)\n\n// Create sub\u2011agents\nconst (\n    SubAgentAnalyzer = \"analyzer\"\n    SubAgentReviewer = \"reviewer\"\n)\nanalyzer := createAnalyzer()  // name must be \"analyzer\"\nreviewer := createReviewer()  // name must be \"reviewer\"\n\n// Declare agent nodes in the graph\nsg.AddAgentNode(SubAgentAnalyzer)\nsg.AddAgentNode(SubAgentReviewer)\n\n// Inject sub\u2011agents when creating the GraphAgent\ngraphAgent, _ := graphagent.New(\"workflow\", g,\n    graphagent.WithSubAgents([]agent.Agent{\n        analyzer,\n        reviewer,\n    }))\n\n// I/O: sub\u2011agents receive graph.StateKeyUserInput as the message AND the full\n// graph state via inv.RunOptions.RuntimeState; on finish they update\n// graph.StateKeyLastResponse and graph.StateKeyNodeResponses[nodeID]\n</code></pre>"},{"location":"graph/#passing-only-results-map-last_response-to-downstream-user_input","title":"Passing only results: map last_response to downstream user_input","text":"<p>Scenario: A \u2192 B \u2192 C as black boxes. Downstream should only consume upstream's result text as this turn's input, without pulling full session history.</p> <ul> <li>Approach 1 (dependency\u2011free, universally available): add a pre\u2011node callback to the target Agent node that assigns parent <code>last_response</code> to <code>user_input</code>. Optionally isolate messages.</li> </ul> <pre><code>sg.AddAgentNode(\"orchestrator\",\n    // Map upstream last_response \u2192 this turn's user_input\n    graph.WithPreNodeCallback(func(ctx context.Context, cb *graph.NodeCallbackContext, s graph.State) (any, error) {\n        if v, ok := s[graph.StateKeyLastResponse].(string); ok &amp;&amp; v != \"\" {\n            s[graph.StateKeyUserInput] = v\n        }\n        return nil, nil\n    }),\n    // Optional: isolate child sub\u2011agent from session contents\n    graph.WithSubgraphIsolatedMessages(true),\n)\n</code></pre> <ul> <li>Approach 2 (enhanced option, more concise):</li> </ul> <pre><code>// Declarative option that automatically maps last_response \u2192 user_input\nsg.AddAgentNode(\"orchestrator\",\n    graph.WithSubgraphInputFromLastResponse(),\n    graph.WithSubgraphIsolatedMessages(true), // optional: isolate for true \"pass only results\"\n)\n</code></pre> <p>Notes: Both approaches ensure B only sees A's result, and C only sees B's. The option is more concise when available; the callback is zero\u2011dependency and works everywhere.</p>"},{"location":"graph/#hybrid-pattern-example","title":"Hybrid Pattern Example","text":"<p>Embed dynamic decision\u2011making within a structured flow:</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/agent\"\n    \"trpc.group/trpc-go/trpc-agent-go/agent/chainagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/agent/graphagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/graph\"\n)\n\nsg := graph.NewStateGraph(schema)\n\nconst (\n    nodePrepare  = \"prepare\"\n    nodeAnalyzer = \"analyzer\"\n    nodeFinalize = \"finalize\"\n)\n\n// Structured data preparation\nsg.AddNode(nodePrepare, prepareData)\n\n// Dynamic decision point \u2014 use a ChainAgent\ndynamicAgent := chainagent.New(nodeAnalyzer,\n    chainagent.WithSubAgents([]agent.Agent{...}))\nsg.AddAgentNode(nodeAnalyzer)\n\n// Continue the structured flow\nsg.AddNode(nodeFinalize, finalizeResults)\n\n// Wire the flow\nsg.SetEntryPoint(nodePrepare)\nsg.AddEdge(nodePrepare, nodeAnalyzer)   // hand over to dynamic agent\nsg.AddEdge(nodeAnalyzer, nodeFinalize)  // return to structured flow\nsg.SetFinishPoint(nodeFinalize)\n\n// Inject on creation\ngraphAgent, _ := graphagent.New(\"hybrid\", g,\n    graphagent.WithSubAgents([]agent.Agent{dynamicAgent}))\n</code></pre>"},{"location":"graph/#core-mechanics-in-depth","title":"Core Mechanics in Depth","text":""},{"location":"graph/#state-management-schema-reducer","title":"State Management: Schema + Reducer","text":"<p>State is a central challenge in graph workflows. We designed a Schema + Reducer mechanism that provides type safety and supports high\u2011concurrency atomic updates.</p> <pre><code>flowchart LR\n    subgraph \"State Schema\"\n        MS[messages: MessageList]:::schemaClass\n        UI[user_input: string]:::schemaClass\n        LR[last_response: string]:::schemaClass\n        NR[node_responses: Map]:::schemaClass\n    end\n\n    subgraph \"Reducers\"\n        R1[MessageReducer + MessageOp]:::reducerClass\n        R2[MergeReducer (Map)]:::reducerClass\n        R3[ReplaceReducer (String)]:::reducerClass\n    end\n\n    subgraph \"Node Outputs\"\n        N1[Node 1 Output]:::nodeOutputClass\n        N2[Node 2 Output]:::nodeOutputClass\n        N3[Node 3 Output]:::nodeOutputClass\n    end\n\n    N1 --&gt; R1\n    N2 --&gt; R2\n    N3 --&gt; R3\n    R1 --&gt; MS\n    R2 --&gt; NR\n    R3 --&gt; LR\n\n    classDef schemaClass fill:#e3f2fd,stroke:#1565c0,stroke-width:2px\n    classDef reducerClass fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px\n    classDef nodeOutputClass fill:#fff8e1,stroke:#f57f17,stroke-width:2px</code></pre> <p>Graph state is a <code>map[string]any</code> with runtime validation provided by <code>StateSchema</code>. The reducer mechanism ensures safe merging and avoids conflicts under concurrent updates.</p>"},{"location":"graph/#common-state-keys","title":"Common State Keys","text":"<ul> <li>User\u2011visible: <code>graph.StateKeyUserInput</code>, <code>graph.StateKeyOneShotMessages</code>, <code>graph.StateKeyMessages</code>, <code>graph.StateKeyLastResponse</code>, <code>graph.StateKeyNodeResponses</code>, <code>graph.StateKeyMetadata</code></li> <li>Internal: <code>session</code>, <code>exec_context</code>, <code>tool_callbacks</code>, <code>model_callbacks</code>, <code>agent_callbacks</code>, <code>current_node_id</code>, <code>parent_agent</code></li> <li>Command/Resume: <code>__command__</code>, <code>__resume_map__</code></li> </ul> <p>Constants live in <code>graph/state.go</code> and <code>graph/keys.go</code>. Prefer referencing constants over hard\u2011coding strings.</p>"},{"location":"graph/#nodelevel-callbacks-tools-generation-parameters","title":"Node\u2011level Callbacks, Tools &amp; Generation Parameters","text":"<p>Per\u2011node options (see <code>graph/state_graph.go</code>):</p> <ul> <li><code>graph.WithPreNodeCallback</code> / <code>graph.WithPostNodeCallback</code> / <code>graph.WithNodeErrorCallback</code></li> <li>LLM nodes: <code>graph.WithGenerationConfig</code>, <code>graph.WithModelCallbacks</code></li> <li>Tooling: <code>graph.WithToolCallbacks</code>, <code>graph.WithToolSets</code> (supply ToolSets in addition to <code>tools []tool.Tool</code>),   <code>graph.WithRefreshToolSetsOnRun</code> (rebuild tools from ToolSets on each run for dynamic sources such as MCP)</li> <li>Agent nodes: <code>graph.WithAgentNodeEventCallback</code></li> </ul>"},{"location":"graph/#toolsets-in-graphs-vs-agents","title":"ToolSets in Graphs vs Agents","text":"<p><code>graph.WithToolSets</code> is a per\u2011node, compile\u2011time configuration. It attaches one or more <code>tool.ToolSet</code> instances to a specific LLM node when you build the graph:</p> <pre><code>sg.AddLLMNode(\"llm\",\n    model,\n    \"inst\",\n    tools,\n    graph.WithToolSets([]tool.ToolSet{mcpToolSet, fileToolSet}),\n)\n</code></pre> <p>Key points:</p> <ul> <li>Graph structure (including node ToolSets) is immutable after <code>Compile()</code>. Changing ToolSets requires rebuilding the graph or providing a new <code>GraphAgent</code>.</li> <li>Runtime\u2011level ToolSet changes should be handled at the Agent level (for example, <code>llmagent.AddToolSet</code>, <code>llmagent.RemoveToolSet</code>, <code>llmagent.SetToolSets</code>) or by swapping the underlying Agent used by a graph Agent node.</li> </ul> <p>Additionally, <code>graph.WithName</code>/<code>graph.WithDescription</code> add friendly labels; <code>graph.WithDestinations</code> declares potential dynamic destinations (for static checks/visualization only).</p>"},{"location":"graph/#llm-input-rules-threestage-design","title":"LLM Input Rules: Three\u2011Stage Design","text":"<p>The LLM input pipeline looks simple but solves common context\u2011management problems in AI apps.</p> <p>Built\u2011in selection logic (no extra config):</p> <ol> <li>Prefer <code>graph.StateKeyOneShotMessages</code>: fully override inputs (system/user) for this turn; cleared after execution.</li> <li>Else use <code>graph.StateKeyUserInput</code>: append this turn's user to <code>graph.StateKeyMessages</code>, then atomically write back user+assistant; finally clear <code>graph.StateKeyUserInput</code>.</li> <li>Else use <code>graph.StateKeyMessages</code> only: common on tool loops re\u2011entering LLM (since <code>graph.StateKeyUserInput</code> has been cleared).</li> </ol> <p>The benefit: preprocess nodes can rewrite <code>graph.StateKeyUserInput</code> and take effect in the same turn, while seamlessly integrating with the tool loop (tool_calls \u2192 tools \u2192 LLM).</p> <p>Examples (showing the three paths):</p> <pre><code>// OneShot (graph.StateKeyOneShotMessages): completely override this turn's inputs (system/user)\nimport (\n    \"trpc.group/trpc-go/trpc-agent-go/graph\"\n    \"trpc.group/trpc-go/trpc-agent-go/model\"\n)\n\nconst (\n    systemPrompt = \"You are a careful and reliable assistant\"\n    userPrompt   = \"Summarize this text in bullet points\"\n)\n\nsg.AddNode(\"prepare_prompt\", func(ctx context.Context, s graph.State) (any, error) {\n    oneShot := []model.Message{\n        model.NewSystemMessage(systemPrompt),\n        model.NewUserMessage(userPrompt),\n    }\n    return graph.State{graph.StateKeyOneShotMessages: oneShot}, nil\n})\n// The following LLM node will use graph.StateKeyOneShotMessages only and clear it afterwards\n</code></pre> <pre><code>// UserInput (graph.StateKeyUserInput): append this turn's user input on top of history graph.StateKeyMessages\nimport (\n    \"strings\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/graph\"\n)\n\nconst (\n    stateKeyCleanedInput = \"cleaned_input\"\n)\n\nsg.AddNode(\"clean_input\", func(ctx context.Context, s graph.State) (any, error) {\n    in := strings.TrimSpace(s[graph.StateKeyUserInput].(string))\n    return graph.State{\n        graph.StateKeyUserInput: in,                // LLM node atomically writes user+assistant to messages\n        stateKeyCleanedInput:    in,                // keep a business\u2011specific key as well\n    }, nil\n})\n</code></pre> <pre><code>// Messages\u2011only (graph.StateKeyMessages): after tool loop returns, graph.StateKeyUserInput is cleared; LLM continues based on graph.StateKeyMessages (incl. tool responses)\nimport (\n    \"trpc.group/trpc-go/trpc-agent-go/graph\"\n)\n\nconst (\n    nodeAsk       = \"ask\"\n    nodeExecTools = \"exec_tools\"\n    nodeFallback  = \"fallback\"\n)\n\nsg.AddToolsNode(nodeExecTools, tools)\nsg.AddToolsConditionalEdges(nodeAsk, nodeExecTools, nodeFallback)\n// On returning to nodeAsk (or a downstream LLM) graph.StateKeyUserInput is empty, so it follows the messages\u2011only path\n</code></pre>"},{"location":"graph/#instruction-placeholder-injection","title":"Instruction Placeholder Injection","text":"<p><code>AddLLMNode</code>'s <code>instruction</code> supports placeholders, same syntax as <code>llmagent</code>:</p> <ul> <li><code>{key}</code> / <code>{key?}</code>: read from <code>session.State</code>; optional <code>?</code> yields empty when missing.</li> <li><code>{user:subkey}</code>, <code>{app:subkey}</code>, <code>{temp:subkey}</code>: read by namespace.</li> </ul> <p>GraphAgent stores the current <code>*session.Session</code> into state (<code>graph.StateKeySession</code>) and expands placeholders before the LLM call.</p> <p>Tip: GraphAgent seeds <code>graph.StateKeyMessages</code> from prior session events for multi\u2011turn continuity. When resuming from a checkpoint, a plain \"resume\" message is not injected as <code>graph.StateKeyUserInput</code>, preserving the recovered state.</p>"},{"location":"graph/#concurrency-and-state-safety","title":"Concurrency and State Safety","text":"<p>When a node has multiple outgoing edges, parallel execution is triggered automatically:</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/graph\"\n)\n\n// This graph structure executes in parallel automatically\nstateGraph.\n    AddNode(\"analyze\", analyzeData).\n    AddNode(\"generate_report\", generateReport).\n    AddNode(\"call_external_api\", callAPI).\n    AddEdge(\"analyze\", \"generate_report\").    // these two run in parallel\n    AddEdge(\"analyze\", \"call_external_api\")   //\n</code></pre> <p>Internally, the executor constructs shallow copies (maps.Copy) per task and merges under a lock, with reducers ensuring safe concurrent updates.</p>"},{"location":"graph/#node-io-conventions_1","title":"Node I/O Conventions","text":"<p>Nodes communicate only via the shared <code>State</code>. Each node returns a state delta that merges via the Schema's reducers.</p> <ul> <li> <p>Function nodes</p> <ul> <li>Input: full <code>State</code> (read keys declared in your schema)</li> <li>Output: write business keys only (e.g., <code>{\"parsed_time\":\"...\"}</code>); avoid internal keys</li> </ul> </li> </ul> <ul> <li> <p>LLM nodes</p> <ul> <li>Input priority: <code>graph.StateKeyOneShotMessages</code> \u2192 <code>graph.StateKeyUserInput</code> \u2192 <code>graph.StateKeyMessages</code></li> <li>Output: append to <code>graph.StateKeyMessages</code> atomically, set <code>graph.StateKeyLastResponse</code>, set <code>graph.StateKeyNodeResponses[&lt;llm_node_id&gt;]</code></li> </ul> </li> </ul> <ul> <li> <p>Tools nodes</p> <ul> <li>Read the latest assistant message with <code>tool_calls</code> for the current round and append tool responses to <code>graph.StateKeyMessages</code></li> <li>Multiple tools execute in the order returned by the LLM</li> </ul> </li> </ul> <ul> <li>Agent nodes<ul> <li>Receive graph <code>State</code> via <code>Invocation.RunOptions.RuntimeState</code></li> <li>Output: set <code>graph.StateKeyLastResponse</code> and <code>graph.StateKeyNodeResponses[&lt;agent_node_id&gt;]</code>; <code>graph.StateKeyUserInput</code> is cleared after execution</li> </ul> </li> </ul> <p>Good practice:</p> <ul> <li>Sequential reads: consume the immediate upstream text from <code>graph.StateKeyLastResponse</code>.</li> <li>Parallel/merge reads: read specific node outputs from <code>graph.StateKeyNodeResponses[&lt;nodeID&gt;]</code>.</li> <li>Declare business keys in your schema with suitable reducers to avoid data races.</li> </ul>"},{"location":"graph/#api-cheat-sheet","title":"API Cheat Sheet","text":"<ul> <li> <p>Build graph</p> <ul> <li><code>graph.NewStateGraph(schema)</code> \u2192 builder</li> <li><code>AddNode(id, func, ...opts)</code> / <code>AddLLMNode(id, model, instruction, tools, ...opts)</code></li> <li><code>AddToolsNode(id, tools, ...opts)</code> / <code>AddAgentNode(id, ...opts)</code></li> <li><code>AddEdge(from, to)</code> / <code>AddConditionalEdges(from, condition, pathMap)</code></li> <li><code>AddToolsConditionalEdges(llmNode, toolsNode, fallback)</code></li> <li><code>SetEntryPoint(nodeID)</code> / <code>SetFinishPoint(nodeID)</code> / <code>Compile()</code></li> </ul> </li> </ul> <ul> <li> <p>State keys (user\u2011visible)</p> <ul> <li><code>graph.StateKeyUserInput</code>, <code>graph.StateKeyOneShotMessages</code>, <code>graph.StateKeyMessages</code>, <code>graph.StateKeyLastResponse</code>, <code>graph.StateKeyNodeResponses</code>, <code>graph.StateKeyMetadata</code></li> </ul> </li> </ul> <ul> <li> <p>Per\u2011node options</p> <ul> <li>LLM/tools:<ul> <li><code>graph.WithGenerationConfig</code>, <code>graph.WithModelCallbacks</code></li> <li><code>graph.WithToolCallbacks</code>, <code>graph.WithToolSets</code></li> </ul> </li> <li>Callbacks:<ul> <li><code>graph.WithPreNodeCallback</code>, <code>graph.WithPostNodeCallback</code>, <code>graph.WithNodeErrorCallback</code></li> </ul> </li> </ul> </li> </ul> <ul> <li>Execution<ul> <li><code>graphagent.New(name, compiledGraph, ...opts)</code> \u2192 <code>runner.NewRunner(app, agent)</code> \u2192 <code>Run(...)</code></li> </ul> </li> </ul> <p>See examples under <code>examples/graph</code> for end\u2011to\u2011end patterns (basic/parallel/multi\u2011turn/interrupts/tools/placeholder).</p>"},{"location":"graph/#visualization-dotimage","title":"Visualization (DOT/Image)","text":"<p>Graph can export a Graphviz DOT (Directed Graph Language) description and render images via the <code>dot</code> (Graph Visualization layout engine) executable.</p> <ul> <li><code>WithDestinations</code> draws dotted gray edges for declared dynamic routes (visualization + static checks only; it does not affect runtime).</li> <li>Conditional edges render as dashed gray edges with branch labels.</li> <li>Regular edges render as solid lines.</li> <li>Virtual <code>Start</code>/<code>End</code> nodes can be shown or hidden via an option.</li> </ul> <p>Example:</p> <pre><code>g := sg.MustCompile()\n\n// Build DOT text\ndot := g.DOT(\n    graph.WithRankDir(graph.RankDirLR),  // left\u2192right (or graph.RankDirTB)\n    graph.WithIncludeDestinations(true), // show declared WithDestinations\n    graph.WithGraphLabel(\"My Workflow\"),\n)\n\n// Render PNG (requires Graphviz's dot)\nif err := g.RenderImage(context.Background(), graph.ImageFormatPNG, \"workflow.png\",\n    graph.WithRankDir(graph.RankDirLR),\n    graph.WithIncludeDestinations(true),\n); err != nil {\n    // If Graphviz is not installed, this returns an error \u2014 ignore or instruct the user to install dot\n}\n</code></pre> <p>API reference:</p> <ul> <li><code>g.DOT(...)</code> / <code>g.WriteDOT(w, ...)</code> on a compiled <code>*graph.Graph</code></li> <li><code>g.RenderImage(ctx, format, outputPath, ...)</code> (e.g., <code>png</code>/<code>svg</code>)</li> <li>Options: <code>WithRankDir(graph.RankDirLR|graph.RankDirTB)</code>, <code>WithIncludeDestinations(bool)</code>, <code>WithIncludeStartEnd(bool)</code>, <code>WithGraphLabel(string)</code></li> </ul> <p>Full example: <code>examples/graph/visualization</code></p>"},{"location":"graph/#advanced-features_1","title":"Advanced Features","text":""},{"location":"graph/#checkpoints-and-recovery","title":"Checkpoints and Recovery","text":"<p>To support time\u2011travel and reliable recovery, configure a checkpoint saver on the Executor or GraphAgent. Below uses the SQLite saver to persist checkpoints and resume from a specific checkpoint.</p> <pre><code>import (\n    \"database/sql\"\n\n    _ \"github.com/mattn/go-sqlite3\"\n    \"trpc.group/trpc-go/trpc-agent-go/agent\"\n    \"trpc.group/trpc-go/trpc-agent-go/agent/graphagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/graph\"\n    \"trpc.group/trpc-go/trpc-agent-go/graph/checkpoint/sqlite\"\n    \"trpc.group/trpc-go/trpc-agent-go/graph/checkpoint/redis\"\n    \"trpc.group/trpc-go/trpc-agent-go/model\"\n)\n\n// Configure checkpoints\ndb, _ := sql.Open(\"sqlite3\", \"./checkpoints.db\")\nsaver, _ := sqlite.NewSaver(db)\n\ngraphAgent, _ := graphagent.New(\"workflow\", g,\n    graphagent.WithCheckpointSaver(saver))\n\n// Checkpoints are saved automatically during execution (by default every step)\n\n// Resume from a checkpoint\neventCh, err := r.Run(ctx, userID, sessionID,\n    model.NewUserMessage(\"resume\"),\n    agent.WithRuntimeState(map[string]any{\n        graph.CfgKeyCheckpointID: \"ckpt-123\",\n    }),\n)\n\n// Configure redis checkpoints\nredisSaver, _ := redis.NewSaver(redis.WithRedisClientURL(\"redis://[username:password@]host:port[/database]\"))\n\ngraphAgent, _ := graphagent.New(\"workflow\", g,\n    graphagent.WithCheckpointSaver(redisSaver))\n\n// Checkpoints are saved automatically during execution (by default every step)\n\n// Resume from a checkpoint\neventCh, err := r.Run(ctx, userID, sessionID,\n    model.NewUserMessage(\"resume\"),\n    agent.WithRuntimeState(map[string]any{\n        graph.CfgKeyCheckpointID: \"ckpt-123\",\n    }),\n)\n</code></pre>"},{"location":"graph/#checkpoint-management","title":"Checkpoint Management","text":"<p>Use the manager to list, query, and delete checkpoints:</p> <pre><code>cm := graph.NewCheckpointManager(saver)\n\n// Latest checkpoint (filter by namespace; empty string means cross\u2011namespace)\nlatest, _ := cm.Latest(ctx, lineageID, \"\")\n\n// List (time\u2011desc)\ntuples, _ := cm.ListCheckpoints(ctx, graph.NewCheckpointConfig(lineageID).ToMap(), &amp;graph.CheckpointFilter{Limit: 10})\n\n// Get a specific checkpoint tuple (includes pending writes)\ntuple, _ := cm.GetTuple(ctx, graph.CreateCheckpointConfig(lineageID, checkpointID, namespace))\n\n// Delete a lineage\n_ = cm.DeleteLineage(ctx, lineageID)\n</code></pre> <p>Use a stable business identifier for <code>namespace</code> in production (e.g., <code>svc:prod:flowX</code>) for clear auditing.</p>"},{"location":"graph/#events-at-a-glance","title":"Events at a Glance","text":"<ul> <li> <p>Authors</p> <ul> <li>Node-level: node ID (fallback <code>graph.AuthorGraphNode</code>)</li> <li>Pregel phases: <code>graph.AuthorGraphPregel</code></li> <li>Executor/system: <code>graph.AuthorGraphExecutor</code></li> <li>User input: <code>user</code> (no exported constant)</li> </ul> </li> </ul> <ul> <li>Object types (subset)<ul> <li>Node: <code>graph.ObjectTypeGraphNodeStart | graph.ObjectTypeGraphNodeComplete | graph.ObjectTypeGraphNodeError</code></li> <li>Pregel: <code>graph.ObjectTypeGraphPregelPlanning | graph.ObjectTypeGraphPregelExecution | graph.ObjectTypeGraphPregelUpdate</code></li> <li>Channel/state: <code>graph.ObjectTypeGraphChannelUpdate</code> / <code>graph.ObjectTypeGraphStateUpdate</code></li> <li>Checkpoints: <code>graph.ObjectTypeGraphCheckpoint</code>, <code>graph.ObjectTypeGraphCheckpointCreated</code>, <code>graph.ObjectTypeGraphCheckpointCommitted</code>, <code>graph.ObjectTypeGraphCheckpointInterrupt</code></li> </ul> </li> </ul> <p>See \"Event Monitoring\" for a full streaming example and metadata parsing.</p>"},{"location":"graph/#humanintheloop","title":"Human\u2011in\u2011the\u2011Loop","text":"<p>Introduce human confirmation on critical paths. The example shows a basic interrupt \u2192 resume flow:</p> <pre><code>import (\n    \"context\"\n    \"fmt\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/agent\"\n    \"trpc.group/trpc-go/trpc-agent-go/graph\"\n    \"trpc.group/trpc-go/trpc-agent-go/model\"\n)\n\nconst (\n    stateKeyContent    = \"content\"\n    stateKeyDecision   = \"decision\"\n    interruptKeyReview = \"review_key\"\n    nodeReview         = \"review\"\n)\n\nsg.AddNode(nodeReview, func(ctx context.Context, s graph.State) (any, error) {\n    content := s[stateKeyContent].(string)\n\n    // Interrupt and wait for human input\n    result, err := graph.Interrupt(ctx, s, interruptKeyReview,\n        fmt.Sprintf(\"Please review: %s\", content))\n    if err != nil {\n        return nil, err\n    }\n\n    return graph.State{stateKeyDecision: result}, nil\n})\n\n// Resume execution (requires the agent package)\neventCh, err := r.Run(ctx, userID, sessionID,\n    model.NewUserMessage(\"resume\"),\n    agent.WithRuntimeState(map[string]any{\n        graph.CfgKeyCheckpointID: checkpointID,\n        graph.StateKeyResumeMap: map[string]any{\n            \"review_key\": \"approved\",\n        },\n    }),\n)\n</code></pre> <p>Helpers:</p> <pre><code>// Typed resume value\nif v, ok := graph.ResumeValue[string](ctx, state, \"approval\"); ok { /* use v */ }\n\n// With default\nv := graph.ResumeValueOrDefault(ctx, state, \"approval\", \"no\")\n\n// Check / clear\n_ = graph.HasResumeValue(state, \"approval\")\ngraph.ClearResumeValue(state, \"approval\")\ngraph.ClearAllResumeValues(state)\n</code></pre> <p>You can also inject resume values at entry via a command (no need to jump to a specific node first). Pass it via Runner runtime state:</p> <pre><code>cmd := graph.NewResumeCommand().\n    WithResumeMap(map[string]any{\"approval\": \"yes\"})\n\n// Inject __command__ into initial state via RuntimeState\neventCh, err := r.Run(ctx, userID, sessionID,\n    model.NewUserMessage(\"resume\"),\n    agent.WithRuntimeState(map[string]any{\n        graph.StateKeyCommand: cmd,\n    }),\n)\n</code></pre>"},{"location":"graph/#event-monitoring","title":"Event Monitoring","text":"<p>The event stream carries execution progress and incremental outputs. The example shows how to iterate events and distinguish graph events vs model deltas:</p> <pre><code>import (\n    \"fmt\"\n    \"trpc.group/trpc-go/trpc-agent-go/graph\"\n)\n\nfor ev := range eventCh {\n    if ev.Response == nil {\n        continue\n    }\n    // ... your handling here\n}\n</code></pre> <p>You can also filter by the event's <code>Author</code> field:</p> <ul> <li>Node\u2011level events (model, tools, node start/stop): <code>Author = &lt;nodeID&gt;</code> (or <code>graph-node</code> if unavailable)</li> <li>Pregel (planning/execution/update/errors): <code>Author = graph.AuthorGraphPregel</code></li> <li>Executor\u2011level (state updates/checkpoints): <code>Author = graph.AuthorGraphExecutor</code></li> <li>User input (Runner writes): <code>Author = user</code></li> </ul> <p>This convention lets you subscribe to a specific node's stream without passing streaming context through nodes (streaming travels via the event channel; state stays structured in a LangGraph\u2011like style).</p> <p>Example: consume only node <code>ask</code>'s streaming output and print the final message when done.</p> <pre><code>import (\n    \"fmt\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/graph\"\n)\n\nconst nodeIDWatch = \"ask\"\n\nfor ev := range eventCh {\n    // Only care about events from the watched node\n    if ev.Author != nodeIDWatch {\n        continue\n    }\n    if ev.Response == nil || len(ev.Response.Choices) == 0 {\n        continue\n    }\n    choice := ev.Response.Choices[0]\n\n    // Streaming deltas\n    if ev.Response.IsPartial &amp;&amp; choice.Delta.Content != \"\" {\n        fmt.Print(choice.Delta.Content)\n        continue\n    }\n\n    // Final full message\n    if !ev.Response.IsPartial &amp;&amp; choice.Message.Content != \"\" {\n        fmt.Println(\"\\n[ask] final output:\", choice.Message.Content)\n    }\n}\n</code></pre>"},{"location":"graph/#event-metadata-statedelta","title":"Event Metadata (StateDelta)","text":"<p>Each event also carries <code>StateDelta</code>, which includes execution metadata for models/tools:</p> <pre><code>import (\n    \"encoding/json\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/graph\"\n)\n\nfor ev := range events {\n    if ev.StateDelta == nil { continue }\n    if b, ok := ev.StateDelta[graph.MetadataKeyModel]; ok {\n        var md graph.ModelExecutionMetadata\n        _ = json.Unmarshal(b, &amp;md)\n        // md.Input / md.Output / md.Duration\n    }\n    if b, ok := ev.StateDelta[graph.MetadataKeyTool]; ok {\n        var td graph.ToolExecutionMetadata\n        _ = json.Unmarshal(b, &amp;td)\n    }\n}\n</code></pre>"},{"location":"graph/#emit-selected-values-from-node-callbacks","title":"Emit selected values from node callbacks","text":"<p>By default, mid\u2011run events like <code>graph.state.update</code> report which keys were updated (metadata\u2011only). Concrete values are not included to keep the stream lightweight and avoid exposing intermediate, potentially conflicting updates. The final <code>graph.execution</code> event's <code>StateDelta</code> carries the serialized final snapshot of allowed keys (see implementations in graph/executor.go:2001, graph/events.go:1276, graph/events.go:1330).</p> <p>If you only need to surface a few values from the result of a specific node right after it completes, register an After\u2011node callback and emit a small custom event containing just those values:</p> <p>Steps:</p> <ul> <li>Register <code>WithPostNodeCallback</code> on the target node.</li> <li>In the callback, read <code>result any</code>; when the node returns <code>graph.State</code>, this is the node's state delta.</li> <li>Pick the needed keys, serialize to JSON, attach to a new event's <code>StateDelta</code>.</li> <li>Send via <code>agent.EmitEvent</code>.</li> </ul> <p>Example:</p> <pre><code>import (\n    \"context\"\n    \"encoding/json\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/agent\"\n    \"trpc.group/trpc-go/trpc-agent-go/graph\"\n)\n\nconst (\n    nodeParse   = \"parse\"\n    stateKeyOut = \"parsed_value\" // emit only what upstream needs\n)\n\nfunc parseNode(ctx context.Context, s graph.State) (any, error) {\n    val := map[string]any{\"ok\": true, \"score\": 0.97}\n    return graph.State{stateKeyOut: val}, nil\n}\n\nfunc buildGraph() (*graph.Graph, error) {\n    sg := graph.NewStateGraph(graph.MessagesStateSchema())\n    sg.AddNode(nodeParse, parseNode,\n        graph.WithPostNodeCallback(func(\n            ctx context.Context,\n            cb *graph.NodeCallbackContext,\n            st graph.State,\n            result any,\n            nodeErr error,\n        ) (any, error) {\n            if nodeErr != nil { return nil, nil }\n            inv, _ := agent.InvocationFromContext(ctx)\n            execCtx, _ := st[graph.StateKeyExecContext].(*graph.ExecutionContext)\n            if delta, ok := result.(graph.State); ok {\n                if v, exists := delta[stateKeyOut]; exists &amp;&amp; execCtx != nil {\n                    evt := graph.NewGraphEvent(\n                        inv.InvocationID,\n                        cb.NodeID, // author = node id for easy filtering\n                        graph.ObjectTypeGraphNodeExecution,\n                    )\n                    if evt.StateDelta == nil { evt.StateDelta = make(map[string][]byte) }\n                    if b, err := json.Marshal(v); err == nil {\n                        evt.StateDelta[stateKeyOut] = b\n                        _ = agent.EmitEvent(ctx, inv, execCtx.EventChan, evt)\n                    }\n                }\n            }\n            return nil, nil\n        }),\n    ).\n        SetEntryPoint(nodeParse).\n        SetFinishPoint(nodeParse)\n    return sg.Compile()\n}\n</code></pre> <p>Recommendations:</p> <ul> <li>Emit only necessary keys to control bandwidth and avoid leaking sensitive data.</li> <li>Internal/volatile keys are filtered from final snapshots and should not be emitted (see graph/internal_keys.go:16).</li> <li>For textual intermediate outputs, prefer existing model streaming events (<code>choice.Delta.Content</code>).</li> </ul> <p>You can also configure agent\u2011level callbacks:</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/agent\"\n    \"trpc.group/trpc-go/trpc-agent-go/model\"\n)\n\n// Construct and register callbacks (recommended)\n// Note: Structured callback API requires trpc-agent-go &gt;= 0.6.0\ncb := agent.NewCallbacks().\n    RegisterBeforeAgent(func(ctx context.Context, args *agent.BeforeAgentArgs) (*agent.BeforeAgentResult, error) {\n        // Return a non-nil CustomResponse to short-circuit this turn\n        return nil, nil\n    }).\n    RegisterAfterAgent(func(ctx context.Context, args *agent.AfterAgentArgs) (*agent.AfterAgentResult, error) {\n        // Modify/replace the final response\n        return nil, nil\n    })\n\ngraphAgent, _ := graphagent.New(\"workflow\", g,\n    graphagent.WithAgentCallbacks(cb),\n)\n</code></pre>"},{"location":"graph/#troubleshooting","title":"Troubleshooting","text":"<p>Q1: Graph has no entry point</p> <ul> <li>Error: \"graph must have an entry point\". Call <code>SetEntryPoint()</code> and ensure the node exists.</li> </ul> <p>Q2: Edge target/source does not exist</p> <ul> <li>Error mentions missing node. Define nodes before wiring edges/condition maps.</li> </ul> <p>Q3: Tools don't run after LLM</p> <ul> <li>Ensure the LLM actually returned <code>tool_calls</code> and you used <code>AddToolsConditionalEdges(ask, tools, fallback)</code>.</li> <li>Check that tool names in your map match the model's declared tool names.</li> <li>Pairing walks from the latest assistant(tool_calls) until a new user; verify messages ordering.</li> </ul> <p>Q4: LLM returns tool_calls but tools never execute (always routes to fallback)</p> <ul> <li>Root cause: Using <code>NewStateSchema()</code> instead of <code>MessagesStateSchema()</code>.</li> <li><code>AddToolsConditionalEdges</code> internally checks <code>state[StateKeyMessages].([]model.Message)</code> to determine if there are tool calls.</li> <li>If the Schema lacks the <code>StateKeyMessages</code> field, <code>MessageReducer</code> won't be applied. The LLM node returns <code>[]graph.MessageOp</code> instead of <code>[]model.Message</code>, causing type assertion to fail and always routing to <code>fallbackNode</code>.</li> <li>Solution: Replace <code>graph.NewStateSchema()</code> with <code>graph.MessagesStateSchema()</code>, then add custom fields on top:   <pre><code>// Wrong\nschema := graph.NewStateSchema()\n\n// Correct\nschema := graph.MessagesStateSchema()\nschema.AddField(\"my_field\", graph.StateField{...})\n</code></pre></li> </ul> <p>Q5: No streaming events observed</p> <ul> <li>Increase <code>WithChannelBufferSize</code> and filter by <code>Author</code>/object types.</li> <li>Verify you're consuming events from <code>Runner.Run(...)</code> and not from direct <code>Executor</code> calls.</li> </ul> <p>Q6: Resume did not continue where expected</p> <ul> <li>Pass <code>agent.WithRuntimeState(map[string]any{ graph.CfgKeyCheckpointID: \"...\" })</code>.</li> <li>Provide <code>ResumeMap</code> for HITL continuation when needed. A plain \"resume\" message is not added to <code>graph.StateKeyUserInput</code>.</li> </ul> <p>Q7: State conflicts in parallel</p> <ul> <li>Define reducers for lists/maps (e.g., <code>StringSliceReducer</code>, <code>MergeReducer</code>), avoid overwriting the same key from multiple branches without merge semantics.</li> </ul> <p>Q8: What does the tools parameter in AddLLMNode do? When are tools actually called?</p> <ul> <li>tools parameter is declarative: The tools passed to <code>AddLLMNode</code> are placed in <code>model.Request.Tools</code>, telling the LLM what tools are available.</li> <li>LLM decides whether to call tools: Based on the tools declaration and user input, the LLM decides whether to return <code>tool_calls</code> in its response.</li> <li>tools are NOT automatically executed: <code>AddLLMNode</code> only declares tools and sends requests to the LLM; it does not execute tools.</li> <li>Tool execution requires AddToolsNode + AddToolsConditionalEdges:   <pre><code>// 1. LLM node declares tools (tells LLM what tools are available)\nsg.AddLLMNode(\"ask\", model, systemPrompt, tools)\n\n// 2. Tools node executes tools (based on tool_calls returned by LLM)\nsg.AddToolsNode(\"tools\", tools)\n\n// 3. Conditional edges route based on LLM response (routes to tools node if tool_calls present)\nsg.AddToolsConditionalEdges(\"ask\", \"tools\", \"fallback\")\n</code></pre></li> <li>Execution timing: When <code>AddToolsConditionalEdges</code> detects <code>tool_calls</code> in the LLM response, it routes to <code>AddToolsNode</code>, which executes the actual tool calls.</li> </ul> <p>Q9: Messages are duplicated in req.Messages when chaining multiple LLM nodes</p> <ul> <li>Symptom: The same user input appears multiple times in <code>req.Messages</code>.</li> <li>Root cause: When using <code>MessagesStateSchema()</code>, <code>MessageReducer</code> accumulates messages. Each LLM node execution appends a new user message if <code>StateKeyUserInput</code> is not empty. When there are loops (e.g., tool call loops) or multiple LLM nodes chained together, messages keep accumulating.</li> <li>Solution: Use <code>RemoveAllMessages</code> to clear previous messages before setting a new <code>StateKeyUserInput</code>:   <pre><code>// In the prepare prompt node\nfunc preparePromptNode(ctx context.Context, state graph.State) (any, error) {\n    userMessage := buildUserMessage(...)\n    return graph.State{\n        // Key: Clear previous messages to avoid accumulation\n        graph.StateKeyMessages:  graph.RemoveAllMessages{},\n        graph.StateKeyUserInput: userMessage,\n    }, nil\n}\n</code></pre></li> <li>Note: <code>WithSubgraphIsolatedMessages(true)</code> only works for <code>AddSubgraphNode</code>, not for <code>AddLLMNode</code>.</li> </ul>"},{"location":"graph/#realworld-example","title":"Real\u2011World Example","text":""},{"location":"graph/#approval-workflow","title":"Approval Workflow","text":"<pre><code>import (\n    \"context\"\n    \"fmt\"\n    \"strings\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/graph\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/openai\"\n)\n\nfunc buildApprovalWorkflow() (*graph.Graph, error) {\n    sg := graph.NewStateGraph(graph.MessagesStateSchema())\n\n    // AI pre\u2011review (define LLM model)\n    const (\n        modelNameApprove      = \"gpt-4o-mini\"\n        promptApproveDecision = \"Decide whether the application meets requirements; reply approve or reject\"\n\n        nodeAIReview    = \"ai_review\"\n        nodeHumanReview = \"human_review\"\n        nodeApprove     = \"approve\"\n        nodeReject      = \"reject\"\n\n        routeHumanReview = \"route_human_review\"\n        routeReject      = \"route_reject\"\n        routeApprove     = \"route_approve\"\n\n        stateKeyApplication = \"application\"\n        stateKeyDecision    = \"decision\"\n    )\n\n    llm := openai.New(modelNameApprove)\n    sg.AddLLMNode(nodeAIReview, llm, promptApproveDecision, nil)\n\n    // Route to human review or reject\n    sg.AddConditionalEdges(nodeAIReview,\n        func(ctx context.Context, s graph.State) (string, error) {\n            resp := s[graph.StateKeyLastResponse].(string)\n            if strings.Contains(resp, \"approve\") {\n                return routeHumanReview, nil\n            }\n            return routeReject, nil\n        }, map[string]string{\n            routeHumanReview: nodeHumanReview,\n            routeReject:      nodeReject,\n        })\n\n    // Human review node\n    sg.AddNode(nodeHumanReview, func(ctx context.Context, s graph.State) (any, error) {\n        app := s[stateKeyApplication].(string)\n        decision, err := graph.Interrupt(ctx, s, \"approval\",\n            fmt.Sprintf(\"Please approve: %s\", app))\n        if err != nil {\n            return nil, err\n        }\n        return graph.State{stateKeyDecision: decision}, nil\n    })\n\n    // Outcome handling\n    sg.AddNode(nodeApprove, func(ctx context.Context, s graph.State) (any, error) {\n        // perform approval logic\n        return graph.State{\"status\": \"approved\"}, nil\n    })\n    sg.AddNode(nodeReject, func(ctx context.Context, s graph.State) (any, error) {\n        return graph.State{\"status\": \"rejected\"}, nil\n    })\n\n    // Wire the flow\n    sg.SetEntryPoint(nodeAIReview)\n    sg.AddConditionalEdges(nodeHumanReview,\n        func(ctx context.Context, s graph.State) (string, error) {\n            if s[stateKeyDecision] == \"approve\" {\n                return routeApprove, nil\n            }\n            return routeReject, nil\n        }, map[string]string{\n            routeApprove: nodeApprove,\n            routeReject:  nodeReject,\n        })\n\n    return sg.Compile()\n}\n</code></pre>"},{"location":"graph/#summary","title":"Summary","text":"<p>This guide introduced the core usage of the <code>graph</code> package and GraphAgent: declaring nodes and routes, safely merging state via Schema + Reducers, and leveraging events, checkpoints, and interrupts for observability and recovery. For structured flows (approvals, content moderation, stepwise processing), Graph provides stable, auditable execution. For intelligent decisions, extend with LLM nodes and sub\u2011agents.</p>"},{"location":"graph/#references-examples","title":"References &amp; Examples","text":"<ul> <li>Repository: https://github.com/trpc-group/trpc-agent-go</li> <li>Graph examples: <code>examples/graph</code> (basic/parallel/multi\u2011turn/interrupts and recovery)<ul> <li>I/O conventions: <code>io_conventions</code>, <code>io_conventions_tools</code></li> <li>Parallel/fan\u2011out: <code>parallel</code>, <code>fanout</code>, <code>diamond</code></li> <li>Placeholders: <code>placeholder</code></li> <li>Checkpoints/interrupts: <code>checkpoint</code>, <code>interrupt</code></li> </ul> </li> <li>Further reading: <code>graph/state_graph.go</code>, <code>graph/executor.go</code>, <code>agent/graphagent</code></li> </ul>"},{"location":"knowledge/","title":"Knowledge Usage Documentation","text":""},{"location":"knowledge/#overview","title":"Overview","text":"<p>Knowledge is the knowledge management system in the tRPC-Agent-Go framework, providing Retrieval-Augmented Generation (RAG) capabilities for Agents. By integrating vector data, embedding models, and document processing components, the Knowledge system enables Agents to access and retrieve relevant knowledge information, thereby providing more accurate and well-founded responses.</p>"},{"location":"knowledge/#usage-pattern","title":"Usage Pattern","text":"<p>The usage of the Knowledge system follows this pattern:</p> <ol> <li>Create Knowledge: Configure vector storage, Embedder, and knowledge sources</li> <li>Load Documents: Load and index documents from various sources</li> <li>Integrate with Agent: Use <code>WithKnowledge()</code> to integrate Knowledge into LLM Agent</li> <li>Agent Auto Retrieval: Agent automatically performs knowledge retrieval through built-in <code>knowledge_search</code> tool</li> <li>Knowledge Base Management: Enable intelligent synchronization mechanism through <code>enableSourceSync</code> to ensure data in vector storage always stays consistent with user-configured sources</li> </ol> <p>This pattern provides:</p> <ul> <li>Intelligent Retrieval: Semantic search based on vector similarity</li> <li>Multi-source Support: Support for files, directories, URLs, and other knowledge sources</li> <li>Flexible Storage: Support for memory, PostgreSQL, TcVector, and other storage backends</li> <li>High Performance Processing: Concurrent processing and batch document loading</li> <li>Knowledge Filtering: Support static filtering and Agent intelligent filtering through metadata</li> <li>Extensible Architecture: Support for custom Embedders, Retrievers, and Rerankers</li> <li>Dynamic Management: Support runtime addition, removal, and updating of knowledge sources</li> <li>Data Consistency Guarantee: Enable intelligent synchronization mechanism through <code>enableSourceSync</code> to ensure vector storage data always stays consistent with user-configured sources, supporting incremental processing, change detection, and automatic orphan document cleanup</li> </ul>"},{"location":"knowledge/#agent-integration","title":"Agent Integration","text":"<p>How the Knowledge system integrates with Agents:</p> <ul> <li>Automatic Tool Registration: Use <code>WithKnowledge()</code> option to automatically add <code>knowledge_search</code> tool</li> <li>Intelligent Filter Tool: Use <code>WithEnableKnowledgeAgenticFilter(true)</code> to enable <code>knowledge_search_with_agentic_filter</code> tool</li> <li>Tool Invocation: Agents can call knowledge search tools to obtain relevant information</li> <li>Context Enhancement: Retrieved knowledge content is automatically added to Agent's context</li> <li>Metadata Filtering: Support precise search based on document metadata</li> </ul>"},{"location":"knowledge/#quick-start","title":"Quick Start","text":"<p>Full Example: examples/knowledge/basic</p>"},{"location":"knowledge/#environment-requirements","title":"Environment Requirements","text":"<ul> <li>Go 1.24.1 or later</li> <li>Valid LLM API key (OpenAI compatible interface)</li> <li>Vector database (optional, for production environment)</li> </ul>"},{"location":"knowledge/#configure-environment-variables","title":"Configure Environment Variables","text":"<pre><code># OpenAI API configuration.\nexport OPENAI_API_KEY=\"your-openai-api-key\"\nexport OPENAI_BASE_URL=\"your-openai-base-url\"\n\n# Embedding model configuration (optional, needs manual reading).\nexport OPENAI_EMBEDDING_MODEL=\"text-embedding-3-small\"\n</code></pre>"},{"location":"knowledge/#minimal-example","title":"Minimal Example","text":"<pre><code>package main\n\nimport (\n    \"context\"\n    \"log\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/agent/llmagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/knowledge\"\n    openaiembedder \"trpc.group/trpc-go/trpc-agent-go/knowledge/embedder/openai\"\n    \"trpc.group/trpc-go/trpc-agent-go/knowledge/source\"\n    dirsource \"trpc.group/trpc-go/trpc-agent-go/knowledge/source/dir\"\n    filesource \"trpc.group/trpc-go/trpc-agent-go/knowledge/source/file\"\n    knowledgetool \"trpc.group/trpc-go/trpc-agent-go/knowledge/tool\"\n    vectorinmemory \"trpc.group/trpc-go/trpc-agent-go/knowledge/vectorstore/inmemory\"\n    \"trpc.group/trpc-go/trpc-agent-go/model\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/openai\"\n    \"trpc.group/trpc-go/trpc-agent-go/runner\"\n    \"trpc.group/trpc-go/trpc-agent-go/session/inmemory\"\n    \"trpc.group/trpc-go/trpc-agent-go/tool\"\n\n\n    // Import PDF reader to register it (optional - has separate go.mod to avoid unnecessary dependencies).\n    // _ \"trpc.group/trpc-go/trpc-agent-go/knowledge/document/reader/pdf\"\n)\n\nfunc main() {\n    ctx := context.Background()\n\n    // 1. Create embedder.\n    embedder := openaiembedder.New(\n        openaiembedder.WithModel(\"text-embedding-3-small\"),\n    )\n\n    // 2. Create vector store.\n    vectorStore := vectorinmemory.New()\n\n    // 3. Create knowledge sources.\n    sources := []source.Source{\n        filesource.New([]string{\"./data/llm.md\"}),\n        dirsource.New([]string{\"./dir\"}),\n    }\n\n    // 4. Create Knowledge.\n    kb := knowledge.New(\n        knowledge.WithEmbedder(embedder),\n        knowledge.WithVectorStore(vectorStore),\n        knowledge.WithSources(sources),\n        knowledge.WithEnableSourceSync(true),\n    )\n\n    // 5. Load documents.\n    if err := kb.Load(ctx); err != nil {\n        log.Fatalf(\"Failed to load knowledge base: %v\", err)\n    }\n\n    // 6. Create search tool.\n    searchTool := knowledgetool.NewKnowledgeSearchTool(\n        kb,\n        knowledgetool.WithToolName(\"knowledge_search\"),\n        knowledgetool.WithToolDescription(\"Search for relevant information in the knowledge base.\"),\n    )\n\n    // 7. Create Agent and add tool.\n    modelInstance := openai.New(\"claude-4-sonnet-20250514\")\n    llmAgent := llmagent.New(\n        \"knowledge-assistant\",\n        llmagent.WithModel(modelInstance),\n        llmagent.WithTools([]tool.Tool{searchTool}),\n    )\n\n    // 8. Create Runner and execute.\n    sessionService := inmemory.NewSessionService()\n    appRunner := runner.NewRunner(\"knowledge-chat\", llmAgent, runner.WithSessionService(sessionService))\n\n    message := model.NewUserMessage(\"Please tell me about LLM information\")\n    _, err := appRunner.Run(ctx, \"user123\", \"session456\", message)\n    if err != nil {\n        log.Fatalf(\"Failed to run agent: %v\", err)\n    }\n}\n</code></pre>"},{"location":"knowledge/#core-concepts","title":"Core Concepts","text":"<p>The knowledge module is the knowledge management core of the tRPC-Agent-Go framework, providing complete RAG capabilities. The module adopts a modular design, supporting multiple document sources, vector storage backends, and embedding models.</p> <pre><code>knowledge/\n\u251c\u2500\u2500 knowledge.go          # Core interface definitions and main implementation.\n\u251c\u2500\u2500 source/               # Document source management.\n\u2502   \u251c\u2500\u2500 source.go        # Source interface definition.\n\u2502   \u251c\u2500\u2500 file.go          # File source implementation.\n\u2502   \u251c\u2500\u2500 dir.go           # Directory source implementation.\n\u2502   \u251c\u2500\u2500 url.go           # URL source implementation.\n\u2502   \u2514\u2500\u2500 auto.go          # Automatic source type detection.\n\u251c\u2500\u2500 vectorstore/          # Vector storage backend.\n\u2502   \u251c\u2500\u2500 vectorstore.go   # VectorStore interface definition.\n\u2502   \u251c\u2500\u2500 inmemory/        # In-memory vector storage (for development/testing).\n\u2502   \u251c\u2500\u2500 pgvector/        # PostgreSQL + pgvector implementation.\n\u2502   \u2514\u2500\u2500 tcvector/        # Tencent Cloud vector database implementation.\n\u251c\u2500\u2500 embedder/             # Text embedding models.\n\u2502   \u251c\u2500\u2500 embedder.go      # Embedder interface definition.\n\u2502   \u251c\u2500\u2500 openai/          # OpenAI embedding model.\n\u2502   \u2514\u2500\u2500 local/           # Local embedding model.\n\u251c\u2500\u2500 reranker/             # reranker layer.\n\u2502   \u251c\u2500\u2500 reranker.go      # Reranker interface definition.\n\u2502   \u251c\u2500\u2500 topk.go          # return topk result.\n\u251c\u2500\u2500 document/             # Document representation.\n\u2502   \u2514\u2500\u2500 document.go      # Document structure definition.\n\u251c\u2500\u2500 query/                # Query enhancer.\n\u2502   \u251c\u2500\u2500 query.go         # QueryEnhancer interface definition.\n\u2502   \u2514\u2500\u2500 passthrough.go   # Default passthrough enhancer.\n\u2514\u2500\u2500 loader/               # Document loader.\n    \u2514\u2500\u2500 loader.go        # Document loading logic.\n</code></pre>"},{"location":"knowledge/#usage-guide","title":"Usage Guide","text":""},{"location":"knowledge/#integration-with-agent","title":"Integration with Agent","text":"<p>The Knowledge system provides two ways to integrate with Agent: manual tool construction and automatic integration.</p>"},{"location":"knowledge/#method-1-manual-tool-construction-recommended","title":"Method 1: Manual Tool Construction (Recommended)","text":"<p>Use <code>NewKnowledgeSearchTool</code> to manually create search tools, allowing flexible configuration of tool name, description, and support for building multiple knowledge bases.</p> <pre><code>import (\n    knowledgetool \"trpc.group/trpc-go/trpc-agent-go/knowledge/tool\"\n    \"trpc.group/trpc-go/trpc-agent-go/tool\"\n)\n\n// Create search tool.\nsearchTool := knowledgetool.NewKnowledgeSearchTool(\n    kb,\n    knowledgetool.WithToolName(\"knowledge_search\"),\n    knowledgetool.WithToolDescription(\"Search for relevant information in the knowledge base.\"),\n)\n\n// Create Agent and add tool.\nllmAgent := llmagent.New(\n    \"knowledge-assistant\",\n    llmagent.WithModel(modelInstance),\n    llmagent.WithTools([]tool.Tool{searchTool}),\n)\n</code></pre>"},{"location":"knowledge/#method-2-automatic-integration","title":"Method 2: Automatic Integration","text":"<p>Use <code>llmagent.WithKnowledge(kb)</code> to integrate Knowledge into Agent. The framework automatically registers the <code>knowledge_search</code> tool.</p> <pre><code>llmAgent := llmagent.New(\n    \"knowledge-assistant\",\n    llmagent.WithModel(modelInstance),\n    llmagent.WithKnowledge(kb), // Automatically add knowledge_search tool.\n)\n</code></pre> <p>Using NewAgenticFilterSearchTool to create intelligent filter search tool:</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/knowledge/source\"\n    knowledgetool \"trpc.group/trpc-go/trpc-agent-go/knowledge/tool\"\n)\n\n// Get metadata information from sources (for intelligent filtering).\nsourcesMetadata := source.GetAllMetadata(sources)\n\n// Create intelligent filter search tool.\nfilterSearchTool := knowledgetool.NewAgenticFilterSearchTool(\n    kb,                    // Knowledge instance\n    sourcesMetadata,       // Metadata information\n    knowledgetool.WithToolName(\"knowledge_search_with_filter\"),\n    knowledgetool.WithToolDescription(\"Search the knowledge base with intelligent metadata filtering.\"),\n)\n\nllmAgent := llmagent.New(\n    \"knowledge-assistant\",\n    llmagent.WithModel(modelInstance),\n    llmagent.WithTools([]tool.Tool{filterSearchTool}),\n)\n</code></pre>"},{"location":"knowledge/#vector-store","title":"Vector Store","text":"<p>Example Code: examples/knowledge/vectorstores</p> <p>Vector storage can be configured through options in code. Configuration sources can be configuration files, command line parameters, or environment variables, which users can implement themselves.</p> <p>trpc-agent-go supports multiple vector store implementations:</p> <ul> <li>Memory: In-memory vector store, suitable for testing and small-scale data</li> <li>PGVector: PostgreSQL + pgvector extension based vector store, supports hybrid search - Example</li> <li>TcVector: Tencent Cloud Vector Database, supports remote embedding computation and hybrid search - Example</li> <li>Elasticsearch: Supports v7/v8/v9 multi-version Elasticsearch vector store - Example</li> <li>Milvus: High-performance vector database, supports billion-scale vector search - Example</li> </ul>"},{"location":"knowledge/#vector-store-configuration-examples","title":"Vector Store Configuration Examples","text":""},{"location":"knowledge/#memory-in-memory-vector-store","title":"Memory (In-memory Vector Store)","text":"<pre><code>import (\n    vectorinmemory \"trpc.group/trpc-go/trpc-agent-go/knowledge/vectorstore/inmemory\"\n)\n\n// In-memory implementation, suitable for testing and small-scale data\nmemVS := vectorinmemory.New()\n\nkb := knowledge.New(\n    knowledge.WithVectorStore(memVS),\n    knowledge.WithEmbedder(embedder), // Requires local embedder\n)\n</code></pre>"},{"location":"knowledge/#pgvector-postgresql-pgvector","title":"PGVector (PostgreSQL + pgvector)","text":"<pre><code>import (\n    vectorpgvector \"trpc.group/trpc-go/trpc-agent-go/knowledge/vectorstore/pgvector\"\n)\n\n// PostgreSQL + pgvector\npgVS, err := vectorpgvector.New(\n    vectorpgvector.WithPGVectorClientDSN(\"postgres://postgres:your-password@127.0.0.1:5432/your-database?sslmode=disable\"),\n    // Set index dimension based on embedding model (text-embedding-3-small is 1536)\n    vectorpgvector.WithIndexDimension(1536),\n    // Enable/disable text retrieval vector, used with hybrid search weights\n    vectorpgvector.WithEnableTSVector(true),\n    // Adjust hybrid search weights (vector similarity weight vs text relevance weight)\n    vectorpgvector.WithHybridSearchWeights(0.7, 0.3),\n    // If Chinese word segmentation extension is installed (like zhparser/jieba), set language to improve text recall\n    vectorpgvector.WithLanguageExtension(\"english\"),\n)\nif err != nil {\n    // Handle error\n}\n\nkb := knowledge.New(\n    knowledge.WithVectorStore(pgVS),\n    knowledge.WithEmbedder(embedder), // Requires local embedder\n)\n</code></pre>"},{"location":"knowledge/#tcvector-tencent-cloud-vector-database","title":"TcVector (Tencent Cloud Vector Database)","text":"<p>TcVector supports two embedding modes:</p> <p>1. Local Embedding Mode (Default)</p> <p>Use local embedder to compute vectors, then store to TcVector:</p> <pre><code>import (\n    vectortcvector \"trpc.group/trpc-go/trpc-agent-go/knowledge/vectorstore/tcvector\"\n)\n\ndocBuilder := func(tcDoc tcvectordb.Document) (*document.Document, []float64, error) {\n    return &amp;document.Document{ID: tcDoc.Id}, nil, nil\n}\n\n// Local embedding mode\ntcVS, err := vectortcvector.New(\n    vectortcvector.WithURL(\"https://your-tcvector-endpoint\"),\n    vectortcvector.WithUsername(\"your-username\"),\n    vectortcvector.WithPassword(\"your-password\"),\n    // Optional custom method to build documents for retrieval. Falls back to the default if not provided\n    vectortcvector.WithDocBuilder(docBuilder),\n)\nif err != nil {\n    // Handle error\n}\n\nkb := knowledge.New(\n    knowledge.WithVectorStore(tcVS),\n    knowledge.WithEmbedder(embedder), // Requires local embedder\n)\n</code></pre> <p>2. Remote Embedding Mode</p> <p>Use TcVector cloud-side embedding computation, no local embedder needed, saves resources:</p> <pre><code>import (\n    vectortcvector \"trpc.group/trpc-go/trpc-agent-go/knowledge/vectorstore/tcvector\"\n)\n\n// Remote embedding mode\ntcVS, err := vectortcvector.New(\n    vectortcvector.WithURL(\"https://your-tcvector-endpoint\"),\n    vectortcvector.WithUsername(\"your-username\"),\n    vectortcvector.WithPassword(\"your-password\"),\n    // Enable remote embedding computation\n    vectortcvector.WithEnableRemoteEmbedding(true),\n    // Specify TcVector embedding model (e.g., bge-base-zh)\n    vectortcvector.WithRemoteEmbeddingModel(\"bge-base-zh\"),\n    // If hybrid search is needed, enable TSVector\n    vectortcvector.WithEnableTSVector(true),\n)\nif err != nil {\n    // Handle error\n}\n\nkb := knowledge.New(\n    knowledge.WithVectorStore(tcVS),\n    // Note: When using remote embedding, no need to configure embedder\n    // knowledge.WithEmbedder(embedder), // Not needed\n)\n</code></pre>"},{"location":"knowledge/#elasticsearch","title":"Elasticsearch","text":"<pre><code>docBuilder := func(hitSource json.RawMessage) (*document.Document, []float64, error) {\n    var source struct {\n        ID        string    `json:\"id\"`\n        Title     string    `json:\"title\"`\n        Content   string    `json:\"content\"`\n        Page      int       `json:\"page\"`\n        Author    string    `json:\"author\"`\n        CreatedAt time.Time `json:\"created_at\"`\n        UpdatedAt time.Time `json:\"updated_at\"`\n        Embedding []float64 `json:\"embedding\"`\n    }\n    if err := json.Unmarshal(hitSource, &amp;source); err != nil {\n        return nil, nil, err\n    }\n    // Create document.\n    doc := &amp;document.Document{\n        ID:        source.ID,\n        Name:      source.Title,\n        Content:   source.Content,\n        CreatedAt: source.CreatedAt,\n        UpdatedAt: source.UpdatedAt,\n        Metadata: map[string]any{\n            \"page\":   source.Page,\n            \"author\": source.Author,\n        },\n    }\n    return doc, source.Embedding, nil\n}\n\n// Create Elasticsearch vector store with multi-version support (v7, v8, v9)\nesVS, err := vectorelasticsearch.New(\n    vectorelasticsearch.WithAddresses([]string{\"http://localhost:9200\"}),\n    vectorelasticsearch.WithUsername(os.Getenv(\"ELASTICSEARCH_USERNAME\")),\n    vectorelasticsearch.WithPassword(os.Getenv(\"ELASTICSEARCH_PASSWORD\")),\n    vectorelasticsearch.WithAPIKey(os.Getenv(\"ELASTICSEARCH_API_KEY\")),\n    vectorelasticsearch.WithIndexName(getEnvOrDefault(\"ELASTICSEARCH_INDEX_NAME\", \"trpc_agent_documents\")),\n    vectorelasticsearch.WithMaxRetries(3),\n    // Version options: \"v7\", \"v8\", \"v9\" (default \"v9\")\n    vectorelasticsearch.WithVersion(\"v9\"),\n    // Optional custom method to build documents for retrieval. Falls back to the default if not provided.\n    vectorelasticsearch.WithDocBuilder(docBuilder),\n)\nif err != nil {\n    // Handle error.\n}\n\nkb := knowledge.New(\n    knowledge.WithVectorStore(esVS),\n)\n</code></pre>"},{"location":"knowledge/#embedder","title":"Embedder","text":"<p>Embedder is responsible for converting text to vector representations and is a core component of the Knowledge system. Currently, the framework mainly supports OpenAI embedding models:</p> <pre><code>import (\n    openaiembedder \"trpc.group/trpc-go/trpc-agent-go/knowledge/embedder/openai\"\n)\n\n// OpenAI Embedder configuration.\nembedder := openaiembedder.New(\n    openaiembedder.WithModel(\"text-embedding-3-small\"), // Embedding model, can also be set via OPENAI_EMBEDDING_MODEL environment variable.\n)\n\n// Pass to Knowledge.\nkb := knowledge.New(\n    knowledge.WithEmbedder(embedder),\n)\n</code></pre>"},{"location":"knowledge/#reranker","title":"Reranker","text":"<p>Reranker is responsible for the precise ranking of search results</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/knowledge/reranker\"\n)\n\nrerank := reranker.NewTopKReranker(\n    // Specify the number of results to be returned after precision sorting. \n    // If not set, all results will be returned by default\n    reranker.WithK(1),\n)\n\nkb := knowledge.New(\n    knowledge.WithReranker(rerank),\n)\n</code></pre> <p>Supported embedding models:</p> <ul> <li>OpenAI embedding models (text-embedding-3-small, etc.)</li> <li>Other OpenAI API compatible embedding services</li> <li>Gemini embedding model (via <code>knowledge/embedder/gemini</code>)</li> <li>Ollama embedding model (via <code>knowledge/embedder/ollama</code>)</li> <li>huggingface text_embedding_interface model (via <code>knowledge/embedder/huggingface</code>\uff09</li> </ul> <p>Note:</p> <ul> <li>Retriever and Reranker are currently implemented internally by Knowledge, users don't need to configure them separately. Knowledge automatically handles document retrieval and result ranking.</li> <li>The <code>OPENAI_EMBEDDING_MODEL</code> environment variable needs to be manually read in code, the framework won't read it automatically. Refer to the <code>getEnvOrDefault(\"OPENAI_EMBEDDING_MODEL\", \"\")</code> implementation in the example code.</li> </ul>"},{"location":"knowledge/#document-source-configuration","title":"Document Source Configuration","text":"<p>\ud83d\udcc1 Example Code: examples/knowledge/sources</p> <p>The source module provides multiple document source types, each supporting rich configuration options:</p> <ul> <li>File source (file): Single file processing - Example</li> <li>Directory source (dir): Batch directory processing - Example</li> <li>URL source (url): Get content from web pages - Example</li> <li>Auto source (auto): Intelligent type recognition - Example</li> </ul> <pre><code>import (\n    filesource \"trpc.group/trpc-go/trpc-agent-go/knowledge/source/file\"\n    dirsource \"trpc.group/trpc-go/trpc-agent-go/knowledge/source/dir\"\n    urlsource \"trpc.group/trpc-go/trpc-agent-go/knowledge/source/url\"\n    autosource \"trpc.group/trpc-go/trpc-agent-go/knowledge/source/auto\"\n)\n\n// File source: Single file processing, supports .txt, .md, .go, .json, etc. formats.\nfileSrc := filesource.New(\n    []string{\"./data/llm.md\"},\n    filesource.WithChunkSize(1000),      // Chunk size.\n    filesource.WithChunkOverlap(200),    // Chunk overlap.\n    filesource.WithName(\"LLM Doc\"),\n    filesource.WithMetadataValue(\"type\", \"documentation\"),\n)\n\n// Directory source: Batch directory processing, supports recursion and filtering.\ndirSrc := dirsource.New(\n    []string{\"./docs\"},\n    dirsource.WithRecursive(true),                           // Recursively process subdirectories.\n    dirsource.WithFileExtensions([]string{\".md\", \".txt\"}),   // File extension filtering.\n    dirsource.WithExcludePatterns([]string{\"*.tmp\", \"*.log\"}), // Exclusion patterns.\n    dirsource.WithChunkSize(800),\n    dirsource.WithName(\"Documentation\"),\n)\n\n// URL source: Get content from web pages and APIs.\nurlSrc := urlsource.New(\n    []string{\"https://en.wikipedia.org/wiki/Artificial_intelligence\"},\n    urlsource.WithTimeout(30*time.Second),           // Request timeout.\n    urlsource.WithUserAgent(\"MyBot/1.0\"),           // Custom User-Agent.\n    urlsource.WithMaxContentLength(1024*1024),       // Maximum content length (1MB).\n    urlsource.WithName(\"Web Content\"),\n)\n\n// URL source advanced configuration: Separate content fetching and document identification\nurlSrcAlias := urlsource.New(\n    []string{\"https://trpc-go.com/docs/api.md\"},     // Identifier URL (for document ID and metadata)\n    urlsource.WithContentFetchingURL([]string{\"https://github.com/trpc-group/trpc-go/raw/main/docs/api.md\"}), // Actual content fetching URL\n    urlsource.WithName(\"TRPC API Docs\"),\n    urlsource.WithMetadataValue(\"source\", \"github\"),\n)\n// Note: When using WithContentFetchingURL, the identifier URL should preserve the file information from the content fetching URL, for example:\n// Correct: Identifier URL is https://trpc-go.com/docs/api.md, fetch URL is https://github.com/.../docs/api.md\n// Incorrect: Identifier URL is https://trpc-go.com, which loses document path information\n\n// Auto source: Intelligent type recognition, automatically select processor.\nautoSrc := autosource.New(\n    []string{\n        \"Cloud computing provides on-demand access to computing resources.\",\n        \"https://docs.example.com/api\",\n        \"./config.yaml\",\n    },\n    autosource.WithName(\"Mixed Sources\"),\n    autosource.WithFallbackChunkSize(1000),\n)\n\n// Combine usage.\nsources := []source.Source{fileSrc, dirSrc, urlSrc, autoSrc}\n\n// Pass to Knowledge.\nkb := knowledge.New(\n    knowledge.WithSources(sources),\n)\n\n// Load all sources.\nif err := kb.Load(ctx); err != nil {\n    log.Fatalf(\"Failed to load knowledge base: %v\", err)\n}\n</code></pre>"},{"location":"knowledge/#batch-document-processing-and-concurrency","title":"Batch Document Processing and Concurrency","text":"<p>Knowledge supports batch document processing and concurrent loading, which can significantly improve processing performance for large amounts of documents:</p> <pre><code>err := kb.Load(ctx,\n    knowledge.WithShowProgress(true),      // Print progress logs.\n    knowledge.WithProgressStepSize(10),    // Progress step size.\n    knowledge.WithShowStats(true),         // Print statistics.\n    knowledge.WithSourceConcurrency(4),    // Source-level concurrency.\n    knowledge.WithDocConcurrency(64),      // Document-level concurrency.\n)\n</code></pre> <p>Note on performance and rate limits:</p> <ul> <li>Higher concurrency increases embedder API request rates (OpenAI/Gemini) and may hit rate limits.</li> <li>Tune <code>WithSourceConcurrency()</code> and <code>WithDocConcurrency()</code> based on throughput, cost, and limits.</li> <li>Defaults are balanced for most scenarios; increase for speed, decrease to avoid throttling.</li> </ul>"},{"location":"knowledge/#filter-functionality","title":"Filter Functionality","text":"<p>\ud83d\udcc1 Example Code: examples/knowledge/features/metadata-filter</p> <p>The Knowledge system provides powerful filter functionality that allows precise search based on document metadata. This includes both static filters and intelligent filters.</p> <p>Important: Filter Field Naming Convention</p> <p>When using filters, metadata fields should use the <code>metadata.</code> prefix: - The <code>metadata.</code> prefix distinguishes metadata fields from system fields (e.g., <code>id</code>, <code>name</code>, <code>content</code>) - Whether using <code>WithKnowledgeFilter()</code>, <code>tool.WithFilter()</code>, or <code>searchfilter.Equal()</code>, metadata fields should include the <code>metadata.</code> prefix - If you customized the metadata field name via <code>WithMetadataField()</code>, still use the <code>metadata.</code> prefix; the framework will automatically convert it to the actual field name - Custom table columns added via <code>WithDocBuilder</code> (e.g., <code>status</code>, <code>priority</code>) use the field name directly without prefix</p>"},{"location":"knowledge/#basic-filters","title":"Basic Filters","text":"<p>Basic filters support two configuration methods: Agent-level fixed filters and Runner-level runtime filters.</p>"},{"location":"knowledge/#agent-level-filters","title":"Agent-level Filters","text":"<p>Preset fixed search filter conditions when creating an Agent:</p> <pre><code>// Create Agent with fixed filters\nllmAgent := llmagent.New(\n    \"knowledge-assistant\",\n    llmagent.WithModel(modelInstance),\n    llmagent.WithKnowledge(kb),\n    llmagent.WithKnowledgeFilter(map[string]interface{}{\n        \"metadata.category\": \"documentation\",\n        \"metadata.topic\":    \"programming\",\n    }),\n)\n</code></pre>"},{"location":"knowledge/#runner-level-filters","title":"Runner-level Filters","text":"<p>Dynamically pass filters when calling <code>runner.Run()</code>, suitable for scenarios that require filtering based on different request contexts:</p> <pre><code>import \"trpc.group/trpc-go/trpc-agent-go/agent\"\n\n// Pass filters at runtime\neventCh, err := runner.Run(\n    ctx,\n    userID,\n    sessionID,\n    message,\n    agent.WithKnowledgeFilter(map[string]interface{}{\n        \"metadata.user_level\": \"premium\",     // Filter by user level\n        \"metadata.region\":     \"china\",       // Filter by region\n        \"metadata.language\":   \"zh\",          // Filter by language\n    }),\n)\n</code></pre> <p>Important: Agent-level filters have higher priority than Runner-level filters, and values with the same key will be overridden by Agent-level:</p> <pre><code>// Agent-level filter\nllmAgent := llmagent.New(\n    \"assistant\",\n    llmagent.WithKnowledge(kb),\n    llmagent.WithKnowledgeFilter(map[string]interface{}{\n        \"metadata.category\": \"general\",\n        \"metadata.source\":   \"internal\",\n    }),\n)\n\n// Runner-level filter's same keys will be overridden by Agent-level\neventCh, err := runner.Run(\n    ctx, userID, sessionID, message,\n    agent.WithKnowledgeFilter(map[string]interface{}{\n        \"metadata.source\": \"external\",  // Will be overridden by Agent-level \"internal\"\n        \"metadata.topic\":  \"api\",       // Add new filter condition (not in Agent-level)\n    }),\n)\n\n// Final effective filter:\n// {\n//     \"metadata.category\": \"general\",   // From Agent-level\n//     \"metadata.source\":   \"internal\",  // From Agent-level (overrode Runner-level \"external\")\n//     \"metadata.topic\":    \"api\",       // From Runner-level (added)\n// }\n</code></pre>"},{"location":"knowledge/#intelligent-filters-agentic-filter","title":"Intelligent Filters (Agentic Filter)","text":"<p>\ud83d\udcc1 Example Code: examples/knowledge/features/agentic-filter</p> <p>Intelligent filters are an advanced feature of the Knowledge system that allows LLM Agents to dynamically select appropriate filter conditions based on user queries.</p>"},{"location":"knowledge/#enable-intelligent-filters","title":"Enable Intelligent Filters","text":"<pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/knowledge/source\"\n)\n\n// Get metadata information from all sources\nsourcesMetadata := source.GetAllMetadata(sources)\n\n// Create Agent with intelligent filter support\nllmAgent := llmagent.New(\n    \"knowledge-assistant\",\n    llmagent.WithModel(modelInstance),\n    llmagent.WithKnowledge(kb),\n    llmagent.WithEnableKnowledgeAgenticFilter(true),           // Enable intelligent filters\n    llmagent.WithKnowledgeAgenticFilterInfo(sourcesMetadata), // Provide available filter information\n)\n</code></pre>"},{"location":"knowledge/#filter-layers","title":"Filter Layers","text":"<p>The Knowledge system supports multi-layer filters, all implemented using FilterCondition and combined with AND logic. The system does not distinguish priority; all layer filters are merged equally.</p> <p>Filter Layers:</p> <ol> <li> <p>Agent-level Filters:</p> <ul> <li>Metadata filters set via <code>llmagent.WithKnowledgeFilter()</code></li> <li>Complex condition filters set via <code>llmagent.WithKnowledgeConditionedFilter()</code></li> </ul> </li> <li> <p>Tool-level Filters:</p> <ul> <li>Metadata filters set via <code>tool.WithFilter()</code></li> <li>Complex condition filters set via <code>tool.WithConditionedFilter()</code></li> <li>Note: Agent-level filters are actually implemented through Tool-level filters</li> </ul> </li> <li> <p>Runner-level Filters:</p> <ul> <li>Metadata filters passed via <code>agent.WithKnowledgeFilter()</code> in <code>runner.Run()</code></li> <li>Complex condition filters passed via <code>agent.WithKnowledgeConditionedFilter()</code> in <code>runner.Run()</code></li> </ul> </li> <li> <p>LLM Intelligent Filters:</p> <ul> <li>Filters dynamically generated by LLM based on user queries (complex condition filters only)</li> </ul> </li> </ol> <p>Important Notes: - All filters are combined with AND logic, meaning documents must satisfy all filter conditions at all levels - There is no priority override relationship; all filters are equal constraints - Each level supports both metadata filters and complex condition filters (except LLM, which only supports complex conditions)</p>"},{"location":"knowledge/#example-filter-combination","title":"Example: Filter Combination","text":"<pre><code>import \"trpc.group/trpc-go/trpc-agent-go/knowledge/searchfilter\"\n\n// 1. Agent-level filters\nllmAgent := llmagent.New(\n    \"knowledge-assistant\",\n    llmagent.WithModel(modelInstance),\n    llmagent.WithKnowledge(kb),\n    // Agent-level metadata filter\n    llmagent.WithKnowledgeFilter(map[string]interface{}{\n        \"metadata.source\":   \"official\",      // Official source\n        \"metadata.category\": \"documentation\", // Documentation category\n    }),\n    // Agent-level complex condition filter (metadata fields use metadata. prefix)\n    llmagent.WithKnowledgeConditionedFilter(\n        searchfilter.Equal(\"metadata.status\", \"published\"), // Published status\n    ),\n)\n\n// 2. Runner-level filters\neventCh, err := runner.Run(\n    ctx, userID, sessionID, message,\n    // Runner-level metadata filter\n    agent.WithKnowledgeFilter(map[string]interface{}{\n        \"metadata.region\":   \"china\",  // China region\n        \"metadata.language\": \"zh\",     // Chinese language\n    }),\n    // Runner-level complex condition filter\n    agent.WithKnowledgeConditionedFilter(\n        searchfilter.GreaterThan(\"metadata.priority\", 5), // Priority greater than 5\n    ),\n)\n\n// 3. LLM intelligent filter (dynamically generated by LLM)\n// Example: User asks \"find API related docs\", LLM might generate {\"field\": \"metadata.topic\", \"value\": \"api\"}\n\n// Final effective filter conditions (all combined with AND):\n// metadata.source = \"official\" AND \n// metadata.category = \"documentation\" AND \n// metadata.status = \"published\" AND\n// metadata.region = \"china\" AND \n// metadata.language = \"zh\" AND \n// metadata.priority &gt; 5 AND\n// metadata.topic = \"api\"\n//\n// i.e., must satisfy all conditions at all levels\n</code></pre>"},{"location":"knowledge/#complex-condition-filter-example","title":"Complex Condition Filter Example","text":"<pre><code>// Manually create Tool with complex condition filters\nsearchTool := tool.NewKnowledgeSearchTool(\n    kb,\n    // Agent-level metadata filter\n    tool.WithFilter(map[string]interface{}{\n        \"metadata.source\": \"official\",\n    }),\n    // Agent-level complex condition filter (metadata fields use metadata. prefix)\n    tool.WithConditionedFilter(\n        searchfilter.Or(\n            searchfilter.Equal(\"metadata.topic\", \"programming\"),\n            searchfilter.Equal(\"metadata.topic\", \"llm\"),\n        ),\n    ),\n)\n\nllmAgent := llmagent.New(\n    \"knowledge-assistant\",\n    llmagent.WithModel(modelInstance),\n    llmagent.WithTools(searchTool),  // Manually pass Tool\n)\n\n// Final filter conditions:\n// metadata.source = \"official\" AND (metadata.topic = \"programming\" OR metadata.topic = \"llm\")\n// i.e., must be official source AND topic is either programming or LLM\n</code></pre>"},{"location":"knowledge/#common-filter-helper-functions","title":"Common Filter Helper Functions","text":"<pre><code>// Comparison operators (Note: metadata fields need metadata. prefix)\nsearchfilter.Equal(\"metadata.topic\", value)              // metadata.topic = value\nsearchfilter.NotEqual(\"metadata.status\", value)          // metadata.status != value\nsearchfilter.GreaterThan(\"metadata.priority\", value)     // metadata.priority &gt; value\nsearchfilter.GreaterThanOrEqual(\"metadata.score\", value) // metadata.score &gt;= value\nsearchfilter.LessThan(\"metadata.age\", value)             // metadata.age &lt; value\nsearchfilter.LessThanOrEqual(\"metadata.level\", value)    // metadata.level &lt;= value\nsearchfilter.In(\"metadata.category\", values...)          // metadata.category IN (...)\nsearchfilter.NotIn(\"metadata.type\", values...)           // metadata.type NOT IN (...)\nsearchfilter.Like(\"metadata.title\", pattern)             // metadata.title LIKE pattern\nsearchfilter.Between(\"metadata.date\", min, max)          // metadata.date BETWEEN min AND max\n\n// Custom table columns (added via WithDocBuilder) don't need prefix\nsearchfilter.NotEqual(\"status\", \"deleted\")               // status != \"deleted\"\nsearchfilter.GreaterThanOrEqual(\"priority\", 3)           // priority &gt;= 3\n\n// Logical operators\nsearchfilter.And(conditions...)               // AND combination\nsearchfilter.Or(conditions...)                // OR combination\n\n// Nested example: (metadata.status = 'published') AND (metadata.category = 'doc' OR metadata.category = 'tutorial')\nsearchfilter.And(\n    searchfilter.Equal(\"metadata.status\", \"published\"),\n    searchfilter.Or(\n        searchfilter.Equal(\"metadata.category\", \"documentation\"),\n        searchfilter.Equal(\"metadata.category\", \"tutorial\"),\n    ),\n)\n</code></pre>"},{"location":"knowledge/#metadata-configuration","title":"Metadata Configuration","text":"<p>To make intelligent filters work properly, you need to add rich metadata when creating document sources:</p>"},{"location":"knowledge/#metadata-acquisition","title":"Metadata Acquisition","text":"<p>The Knowledge system provides utility functions to collect metadata information from sources:</p> <pre><code>import \"trpc.group/trpc-go/trpc-agent-go/knowledge/source\"\n\n// Get all metadata key-value pairs from all sources\n// Returns map[string][]any containing all possible metadata values\nsourcesMetadata := source.GetAllMetadata(sources)\n\n// Get all metadata keys from all sources\n// Returns []string containing all metadata field names\nmetadataKeys := source.GetAllMetadataKeys(sources)\n</code></pre>"},{"location":"knowledge/#source-metadata-configuration","title":"Source Metadata Configuration","text":"<pre><code>sources := []source.Source{\n    // File source metadata configuration\n    filesource.New(\n        []string{\"./docs/api.md\"},\n        filesource.WithName(\"API Documentation\"),\n        filesource.WithMetadataValue(\"category\", \"documentation\"),\n        filesource.WithMetadataValue(\"topic\", \"api\"),\n        filesource.WithMetadataValue(\"service_type\", \"gateway\"),\n        filesource.WithMetadataValue(\"protocol\", \"trpc-go\"),\n        filesource.WithMetadataValue(\"version\", \"v1.0\"),\n    ),\n\n    // Directory source metadata configuration\n    dirsource.New(\n        []string{\"./tutorials\"},\n        dirsource.WithName(\"Tutorials\"),\n        dirsource.WithMetadataValue(\"category\", \"tutorial\"),\n        dirsource.WithMetadataValue(\"difficulty\", \"beginner\"),\n        dirsource.WithMetadataValue(\"topic\", \"programming\"),\n    ),\n\n    // URL source metadata configuration\n    urlsource.New(\n        []string{\"https://example.com/wiki/rpc\"},\n        urlsource.WithName(\"RPC Wiki\"),\n        urlsource.WithMetadataValue(\"category\", \"encyclopedia\"),\n        urlsource.WithMetadataValue(\"source_type\", \"web\"),\n        urlsource.WithMetadataValue(\"topic\", \"rpc\"),\n        urlsource.WithMetadataValue(\"language\", \"zh\"),\n    ),\n}\n</code></pre>"},{"location":"knowledge/#vector-database-filter-support","title":"Vector Database Filter Support","text":"<p>Different vector databases have varying levels of filter support:</p>"},{"location":"knowledge/#postgresql-pgvector","title":"PostgreSQL + pgvector","text":"<ul> <li>\u2705 Supports all metadata field filtering</li> <li>\u2705 Supports complex query conditions</li> <li>\u2705 Supports JSONB field indexing</li> </ul> <pre><code>vectorStore, err := vectorpgvector.New(\n    vectorpgvector.WithHost(\"127.0.0.1\"),\n    vectorpgvector.WithPort(5432),\n    // ... other configurations\n)\n</code></pre>"},{"location":"knowledge/#tcvector","title":"TcVector","text":"<ul> <li>\u2705 Supports all metadata filtering</li> <li>\u2705 v0.4.0+ new collections automatically support JSON index (requires TCVector service support)</li> <li>\u26a1 Optional: Use <code>WithFilterIndexFields</code> to build additional indexes for frequently queried fields</li> </ul> <pre><code>// v0.4.0+ new collections (TCVector service supports JSON index)\nvectorStore, err := vectortcvector.New(\n    vectortcvector.WithURL(\"https://your-endpoint\"),\n    // ... other configurations\n)\n// All metadata fields are queryable via JSON index, no need to predefine\n\n// Optional: Build additional indexes for high-frequency fields to optimize performance\nmetadataKeys := source.GetAllMetadataKeys(sources)\nvectorStore, err := vectortcvector.New(\n    vectortcvector.WithURL(\"https://your-endpoint\"),\n    vectortcvector.WithFilterIndexFields(metadataKeys), // Optional: build additional indexes\n    // ... other configurations\n)\n\n// Collections before v0.4.0 or TCVector service without JSON index support\nvectorStore, err := vectortcvector.New(\n    vectortcvector.WithURL(\"https://your-endpoint\"),\n    vectortcvector.WithFilterIndexFields(metadataKeys), // Required: predefine filter fields\n    // ... other configurations\n)\n</code></pre> <p>Notes: - v0.4.0+ new collections: Automatically create metadata JSON index, all fields queryable - Legacy collections: Only fields in <code>WithFilterIndexFields</code> are queryable</p>"},{"location":"knowledge/#in-memory-storage","title":"In-memory Storage","text":"<ul> <li>\u2705 Supports all filter functionality</li> <li>\u26a0\ufe0f Only suitable for development and testing</li> </ul>"},{"location":"knowledge/#knowledge-base-management-functionality","title":"Knowledge Base Management Functionality","text":"<p>\ud83d\udcc1 Example Code: examples/knowledge/features/management</p> <p>The Knowledge system provides powerful knowledge base management functionality, supporting dynamic source management and intelligent synchronization mechanisms.</p>"},{"location":"knowledge/#enable-source-sync-enablesourcesync","title":"Enable Source Sync (enableSourceSync)","text":"<p>By enabling <code>enableSourceSync</code>, the knowledge base will always keep vector storage data consistent with configured sources. If you're not using custom methods to manage the knowledge base, it's recommended to enable this option:</p> <pre><code>kb := knowledge.New(\n    knowledge.WithEmbedder(embedder),\n    knowledge.WithVectorStore(vectorStore),\n    knowledge.WithSources(sources),\n    knowledge.WithEnableSourceSync(true), // Enable incremental sync\n)\n</code></pre> <p>How the synchronization mechanism works:</p> <ol> <li>Pre-loading preparation: Refresh document information cache, establish synchronization state tracking</li> <li>Process tracking: Record processed documents to avoid duplicate processing</li> <li>Post-loading cleanup: Automatically clean up orphaned documents that no longer exist</li> </ol> <p>Advantages of enabling synchronization:</p> <ul> <li>Data consistency: Ensure vector storage is completely synchronized with source configuration</li> <li>Incremental updates: Only process changed documents, improving performance</li> <li>Orphan cleanup: Automatically delete documents from removed sources</li> <li>State tracking: Real-time monitoring of synchronization status and processing progress</li> </ul>"},{"location":"knowledge/#dynamic-source-management","title":"Dynamic Source Management","text":"<p>Knowledge supports runtime dynamic management of knowledge sources, ensuring data in vector storage always stays consistent with user-configured sources:</p> <pre><code>// Add new knowledge source - data will stay consistent with configured sources\nnewSource := filesource.New([]string{\"./new-docs/api.md\"})\nif err := kb.AddSource(ctx, newSource); err != nil {\n    log.Printf(\"Failed to add source: %v\", err)\n}\n\n// Reload specified knowledge source - automatically detect changes and sync\nif err := kb.ReloadSource(ctx, newSource); err != nil {\n    log.Printf(\"Failed to reload source: %v\", err)\n}\n\n// Remove specified knowledge source - precisely delete related documents\nif err := kb.RemoveSource(ctx, \"API Documentation\"); err != nil {\n    log.Printf(\"Failed to remove source: %v\", err)\n}\n</code></pre> <p>Core features of dynamic management:</p> <ul> <li>Data consistency guarantee: Vector storage data always stays consistent with user-configured sources</li> <li>Intelligent incremental sync: Only process changed documents, avoiding duplicate processing</li> <li>Precise source control: Support precise addition/removal/reload by source name</li> <li>Orphan document cleanup: Automatically clean up documents that no longer belong to any configured source</li> <li>Hot update support: Update knowledge base without restarting the application</li> </ul>"},{"location":"knowledge/#knowledge-base-status-monitoring","title":"Knowledge Base Status Monitoring","text":"<p>Knowledge provides rich status monitoring functionality to help users understand the synchronization status of currently configured sources:</p> <pre><code>// Show all document information\ndocInfos, err := kb.ShowDocumentInfo(ctx)\nif err != nil {\n    log.Printf(\"Failed to show document info: %v\", err)\n    return\n}\n\n// Also supports querying specific sources or metadata\n// docInfos, err := kb.ShowDocumentInfo(ctx, \"source_name_1\", \"source_name_2\")\n// This will only return document metadata for the specified source names\n\n// Iterate through document information\nfor _, docInfo := range docInfos {\n    fmt.Printf(\"Document ID: %s\\n\", docInfo.DocumentID)\n    fmt.Printf(\"Source: %s\\n\", docInfo.SourceName)\n    fmt.Printf(\"URI: %s\\n\", docInfo.URI)\n    fmt.Printf(\"Chunk Index: %d\\n\", docInfo.ChunkIndex)\n}\n</code></pre> <p>Status monitoring output example:</p> <pre><code>Document ID: a1b2c3d4e5f6...\nSource: Technical Documentation\nURI: /docs/api/authentication.md\nChunk Index: 0\n\nDocument ID: f6e5d4c3b2a1...\nSource: Technical Documentation\nURI: /docs/api/authentication.md\nChunk Index: 1\n</code></pre>"},{"location":"knowledge/#advanced-features","title":"Advanced Features","text":""},{"location":"knowledge/#queryenhancer","title":"QueryEnhancer","text":"<p>QueryEnhancer is used to preprocess and optimize user queries before searching. Currently, the framework only provides a default implementation:</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/knowledge\"\n    \"trpc.group/trpc-go/trpc-agent-go/knowledge/query\"\n)\n\nkb := knowledge.New(\n    knowledge.WithQueryEnhancer(query.NewPassthroughEnhancer()), // Default enhancer, returns query as-is.\n)\n</code></pre> <p>Note: QueryEnhancer is not a required component. If not specified, Knowledge will directly use the original query for search. This option only needs to be configured when custom query preprocessing logic is required.</p>"},{"location":"knowledge/#performance-optimization","title":"Performance Optimization","text":"<p>The Knowledge system provides various performance optimization strategies, including concurrent processing, vector storage optimization, and caching mechanisms:</p> <pre><code>// Adjust concurrency based on system resources.\nkb := knowledge.New(\n    knowledge.WithSources(sources),\n    knowledge.WithSourceConcurrency(runtime.NumCPU()),\n    knowledge.WithDocConcurrency(runtime.NumCPU()*2),\n)\n</code></pre>"},{"location":"knowledge/#complete-example","title":"Complete Example","text":"<p>\ud83d\udcc1 All Examples: examples/knowledge</p> <p>The following is a complete example showing how to create an Agent with Knowledge access capabilities:</p> <pre><code>package main\n\nimport (\n    \"context\"\n    \"flag\"\n    \"log\"\n    \"os\"\n    \"strconv\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/agent/llmagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/knowledge\"\n    \"trpc.group/trpc-go/trpc-agent-go/model\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/openai\"\n    \"trpc.group/trpc-go/trpc-agent-go/runner\"\n    \"trpc.group/trpc-go/trpc-agent-go/session/inmemory\"\n\n    // Embedder.\n    \"trpc.group/trpc-go/trpc-agent-go/knowledge/embedder\"\n    geminiembedder \"trpc.group/trpc-go/trpc-agent-go/knowledge/embedder/gemini\"\n    openaiembedder \"trpc.group/trpc-go/trpc-agent-go/knowledge/embedder/openai\"\n    ollamaembedder \"trpc.group/trpc-go/trpc-agent-go/knowledge/embedder/ollama\"\n    huggingfaceembedder \"trpc.group/trpc-go/trpc-agent-go/knowledge/embedder/huggingface\"\n\n    // Source.\n    \"trpc.group/trpc-go/trpc-agent-go/knowledge/source\"\n    autosource \"trpc.group/trpc-go/trpc-agent-go/knowledge/source/auto\"\n    dirsource \"trpc.group/trpc-go/trpc-agent-go/knowledge/source/dir\"\n    filesource \"trpc.group/trpc-go/trpc-agent-go/knowledge/source/file\"\n    urlsource \"trpc.group/trpc-go/trpc-agent-go/knowledge/source/url\"\n\n    // Vector Store.\n    \"trpc.group/trpc-go/trpc-agent-go/knowledge/vectorstore\"\n    vectorinmemory \"trpc.group/trpc-go/trpc-agent-go/knowledge/vectorstore/inmemory\"\n    vectorpgvector \"trpc.group/trpc-go/trpc-agent-go/knowledge/vectorstore/pgvector\"\n    vectortcvector \"trpc.group/trpc-go/trpc-agent-go/knowledge/vectorstore/tcvector\"\n\n    // Import PDF reader to register it (optional - has separate go.mod to avoid unnecessary dependencies).\n    // _ \"trpc.group/trpc-go/trpc-agent-go/knowledge/document/reader/pdf\"\n)\n\nfunc main() {\n    var (\n        embedderType    = flag.String(\"embedder\", \"openai\", \"embedder type (openai, gemini, ollama, huggingface)\")\n        vectorStoreType = flag.String(\"vectorstore\", \"inmemory\", \"vector store type (inmemory, pgvector, tcvector)\")\n        modelName       = flag.String(\"model\", \"claude-4-sonnet-20250514\", \"Name of the model to use\")\n    )\n\n    flag.Parse()\n\n    ctx := context.Background()\n\n    // 1. Create embedder (select based on environment variables).\n    var embedder embedder.Embedder\n    var err error\n\n    switch *embedderType {\n    case \"gemini\":\n        embedder, err = geminiembedder.New(context.Background())\n        if err != nil {\n            log.Fatalf(\"Failed to create gemini embedder: %v\", err)\n        }\n    case \"ollama\":\n        embedder, err = ollamaembedder.New()\n        if err != nil {\n            log.Fatalf(\"Failed to create ollama embedder: %v\", err)\n        }\n    case \"huggingface\":\n        embedder = huggingfaceembedder.New()\n    default: // openai.\n        embedder = openaiembedder.New(\n            openaiembedder.WithModel(getEnvOrDefault(\"OPENAI_EMBEDDING_MODEL\", \"text-embedding-3-small\")),\n        )\n    }\n\n    // 2. Create vector store (select based on parameters).\n    var vectorStore vectorstore.VectorStore\n\n    switch *vectorStoreType {\n    case \"pgvector\":\n        port, err := strconv.Atoi(getEnvOrDefault(\"PGVECTOR_PORT\", \"5432\"))\n        if err != nil {\n            log.Fatalf(\"Failed to convert PGVECTOR_PORT to int: %v\", err)\n        }\n\n        vectorStore, err = vectorpgvector.New(\n            vectorpgvector.WithHost(getEnvOrDefault(\"PGVECTOR_HOST\", \"127.0.0.1\")),\n            vectorpgvector.WithPort(port),\n            vectorpgvector.WithUser(getEnvOrDefault(\"PGVECTOR_USER\", \"postgres\")),\n            vectorpgvector.WithPassword(getEnvOrDefault(\"PGVECTOR_PASSWORD\", \"\")),\n            vectorpgvector.WithDatabase(getEnvOrDefault(\"PGVECTOR_DATABASE\", \"vectordb\")),\n            vectorpgvector.WithIndexDimension(1536),\n        )\n        if err != nil {\n            log.Fatalf(\"Failed to create pgvector store: %v\", err)\n        }\n    case \"tcvector\":\n        vectorStore, err = vectortcvector.New(\n            vectortcvector.WithURL(getEnvOrDefault(\"TCVECTOR_URL\", \"\")),\n            vectortcvector.WithUsername(getEnvOrDefault(\"TCVECTOR_USERNAME\", \"\")),\n            vectortcvector.WithPassword(getEnvOrDefault(\"TCVECTOR_PASSWORD\", \"\")),\n        )\n        if err != nil {\n            log.Fatalf(\"Failed to create tcvector store: %v\", err)\n        }\n    default: // inmemory.\n        vectorStore = vectorinmemory.New()\n    }\n\n    // 3. Create knowledge sources.\n    sources := []source.Source{\n        // File source: Single file processing.\n        filesource.New(\n            []string{\"./data/llm.md\"},\n            filesource.WithChunkSize(1000),\n            filesource.WithChunkOverlap(200),\n            filesource.WithName(\"LLM Documentation\"),\n            filesource.WithMetadataValue(\"type\", \"documentation\"),\n            filesource.WithMetadataValue(\"category\", \"ai\"),\n        ),\n\n        // Directory source: Batch directory processing.\n        dirsource.New(\n            []string{\"./dir\"},\n            dirsource.WithRecursive(true),\n            dirsource.WithFileExtensions([]string{\".md\", \".txt\"}),\n            dirsource.WithChunkSize(800),\n            dirsource.WithName(\"Documentation\"),\n            dirsource.WithMetadataValue(\"category\", \"docs\"),\n        ),\n\n        // URL source: Get content from web pages.\n        urlsource.New(\n            []string{\"https://en.wikipedia.org/wiki/Artificial_intelligence\"},\n            urlsource.WithName(\"Web Documentation\"),\n            urlsource.WithMetadataValue(\"source\", \"web\"),\n            urlsource.WithMetadataValue(\"category\", \"wikipedia\"),\n            urlsource.WithMetadataValue(\"language\", \"en\"),\n        ),\n\n        // Auto source: Mixed content types.\n        autosource.New(\n            []string{\n                \"Cloud computing is the delivery of computing services over the internet, including servers, storage, databases, networking, software, and analytics. It provides on-demand access to shared computing resources.\",\n                \"Machine learning is a subset of artificial intelligence that enables systems to learn and improve from experience without being explicitly programmed.\",\n                \"./README.md\",\n            },\n            autosource.WithName(\"Mixed Knowledge Sources\"),\n            autosource.WithMetadataValue(\"category\", \"mixed\"),\n            autosource.WithMetadataValue(\"type\", \"custom\"),\n            autosource.WithMetadataValue(\"topics\", []string{\"cloud\", \"ml\", \"ai\"}),\n        ),\n    }\n\n    // 4. Create Knowledge.\n    kb := knowledge.New(\n        knowledge.WithEmbedder(embedder),\n        knowledge.WithVectorStore(vectorStore),\n        knowledge.WithSources(sources),\n    )\n\n    // 5. Load documents (with progress and statistics).\n    log.Println(\"\ud83d\ude80 Starting to load Knowledge ...\")\n    if err := kb.Load(\n        ctx,\n        knowledge.WithShowProgress(true),\n        knowledge.WithProgressStepSize(10),\n        knowledge.WithShowStats(true),\n        knowledge.WithSourceConcurrency(4),\n        knowledge.WithDocConcurrency(64),\n    ); err != nil {\n        log.Fatalf(\"\u274c Knowledge loading failed: %v\", err)\n    }\n    log.Println(\"\u2705 Knowledge loading completed!\")\n\n    // 6. Create LLM model.\n    modelInstance := openai.New(*modelName)\n\n    // Get metadata information from all sources (for intelligent filters).\n    sourcesMetadata := source.GetAllMetadata(sources)\n\n    // 7. Create Agent and integrate Knowledge.\n    llmAgent := llmagent.New(\n        \"knowledge-assistant\",\n        llmagent.WithModel(modelInstance),\n        llmagent.WithDescription(\"Intelligent assistant with Knowledge access capabilities\"),\n        llmagent.WithInstruction(\"Use the knowledge_search or knowledge_search_with_filter tool to retrieve relevant information from Knowledge and answer questions based on retrieved content. Select appropriate filter conditions based on user queries.\"),\n        llmagent.WithKnowledge(kb), // Automatically add knowledge_search tool.\n        llmagent.WithEnableKnowledgeAgenticFilter(true),           // Enable intelligent filters\n        llmagent.WithKnowledgeAgenticFilterInfo(sourcesMetadata), // Provide available filter information\n    )\n\n    // 8. Create Runner.\n    sessionService := inmemory.NewSessionService()\n    appRunner := runner.NewRunner(\n        \"knowledge-chat\",\n        llmAgent,\n        runner.WithSessionService(sessionService),\n    )\n\n    // 9. Execute conversation (Agent will automatically use knowledge_search tool).\n    log.Println(\"\ud83d\udd0d Starting to search knowledge base...\")\n    message := model.NewUserMessage(\"Please tell me about LLM information\")\n    eventChan, err := appRunner.Run(ctx, \"user123\", \"session456\", message)\n    if err != nil {\n        log.Fatalf(\"Failed to run agent: %v\", err)\n    }\n\n    // 10. Handle response ...\n\n    // 11. Demonstrate knowledge base management functionality - view document metadata\n    log.Println(\"\ud83d\udcca Displaying current knowledge base status...\")\n\n    // Query metadata information for all documents, also supports querying specific source or metadata data\n    docInfos, err := kb.ShowDocumentInfo(ctx)\n    if err != nil {\n        log.Printf(\"Failed to show document info: %v\", err)\n    } else {\n        log.Printf(\"Knowledge base contains a total of %d document chunks\", len(docInfos))\n    }\n\n\n    // 12. Demonstrate dynamic source addition - new data will automatically stay consistent with configuration\n    log.Println(\"Demonstrating dynamic source addition...\")\n    newSource := filesource.New(\n        []string{\"./new-docs/changelog.md\"},\n        filesource.WithName(\"Changelog\"),\n        filesource.WithMetadataValue(\"category\", \"changelog\"),\n        filesource.WithMetadataValue(\"type\", \"updates\"),\n    )\n\n    if err := kb.AddSource(ctx, newSource); err != nil {\n        log.Printf(\"Failed to add new source: %v\", err)\n    }\n\n    // 13. Demonstrate source removal (optional, uncomment to test)\n    // if err := kb.RemoveSource(ctx, \"Changelog\"); err != nil {\n    //     log.Printf(\"Failed to remove source: %v\", err)\n    // }\n}\n\n// getEnvOrDefault returns the environment variable value or a default value if not set.\nfunc getEnvOrDefault(key, defaultValue string) string {\n    if value := os.Getenv(key); value != \"\" {\n        return value\n    }\n    return defaultValue\n}\n</code></pre> <p>The environment variable configuration is as follows:</p> <pre><code># OpenAI API configuration (required when using OpenAI embedder, automatically read by OpenAI SDK).\nexport OPENAI_API_KEY=\"your-openai-api-key\"\nexport OPENAI_BASE_URL=\"your-openai-base-url\"\n# OpenAI embedding model configuration (optional, needs manual reading in code).\nexport OPENAI_EMBEDDING_MODEL=\"text-embedding-3-small\"\n\n# Google Gemini API configuration (when using Gemini embedder).\nexport GOOGLE_API_KEY=\"your-google-api-key\"\n\n# PostgreSQL + pgvector configuration (required when using -vectorstore=pgvector)\nexport PGVECTOR_HOST=\"127.0.0.1\"\nexport PGVECTOR_PORT=\"5432\"\nexport PGVECTOR_USER=\"postgres\"\nexport PGVECTOR_PASSWORD=\"your-password\"\nexport PGVECTOR_DATABASE=\"vectordb\"\n\n# TcVector configuration (required when using -vectorstore=tcvector)\nexport TCVECTOR_URL=\"https://your-tcvector-endpoint\"\nexport TCVECTOR_USERNAME=\"your-username\"\nexport TCVECTOR_PASSWORD=\"your-password\"\n\n# Elasticsearch configuration (required when using -vectorstore=elasticsearch)\nexport ELASTICSEARCH_HOSTS=\"http://localhost:9200\"\nexport ELASTICSEARCH_USERNAME=\"\"\nexport ELASTICSEARCH_PASSWORD=\"\"\nexport ELASTICSEARCH_API_KEY=\"\"\nexport ELASTICSEARCH_INDEX_NAME=\"trpc_agent_documents\"\n</code></pre>"},{"location":"knowledge/#command-line-parameters","title":"Command Line Parameters","text":"<pre><code># When running examples, you can select component types through command line parameters.\ngo run main.go -embedder openai -vectorstore inmemory\ngo run main.go -embedder gemini -vectorstore pgvector\ngo run main.go -embedder openai -vectorstore tcvector\ngo run main.go -embedder openai -vectorstore elasticsearch -es-version v9\n\n# Parameter description:\n# -embedder: Select embedder type (openai, gemini, ollama, huggingface), default is openai.\n# -vectorstore: Select vector store type (inmemory, pgvector, tcvector, elasticsearch), default is inmemory.\n# -es-version: Elasticsearch version (v7, v8, v9), only when vectorstore=elasticsearch.\n</code></pre>"},{"location":"knowledge/#troubleshooting","title":"Troubleshooting","text":""},{"location":"knowledge/#common-issues-and-handling-suggestions","title":"Common Issues and Handling Suggestions","text":"<ol> <li> <p>Create embedding failed/HTTP 4xx/5xx</p> <ul> <li>Possible causes: Invalid or missing API Key; Incorrect BaseURL configuration; Network access restrictions; Text too long; The configured BaseURL doesn't provide Embeddings interface or doesn't support the selected embedding model (e.g., returns 404 Not Found).</li> <li>Troubleshooting steps:<ul> <li>Confirm <code>OPENAI_API_KEY</code> is set and available;</li> <li>If using compatible gateway, explicitly set <code>WithBaseURL(os.Getenv(\"OPENAI_BASE_URL\"))</code>;</li> <li>Confirm <code>WithModel(\"text-embedding-3-small\")</code> or the actual embedding model name supported by your service;</li> <li>Use minimal example to call embedding API once to verify connectivity;</li> <li>Use curl to verify if target BaseURL implements <code>/v1/embeddings</code> and model exists:    <pre><code>curl -sS -X POST \"$OPENAI_BASE_URL/embeddings\" \\\n  -H \"Authorization: Bearer $OPENAI_API_KEY\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"model\":\"text-embedding-3-small\",\"input\":\"ping\"}'\n</code></pre>    If returns 404/model doesn't exist, please switch to BaseURL that supports Embeddings or switch to valid embedding model name provided by that service.</li> <li>Gradually shorten text to confirm it's not caused by overly long input.</li> </ul> </li> <li>Reference code:    <pre><code>embedder := openaiembedder.New(\n    openaiembedder.WithModel(\"text-embedding-3-small\"),\n    openaiembedder.WithAPIKey(os.Getenv(\"OPENAI_API_KEY\")),\n    openaiembedder.WithBaseURL(os.Getenv(\"OPENAI_BASE_URL\")),\n)\nif _, err := embedder.GetEmbedding(ctx, \"ping\"); err != nil {\n    log.Fatalf(\"embed check failed: %v\", err)\n}\n</code></pre></li> </ul> </li> <li> <p>Slow loading speed or high CPU usage</p> <ul> <li>Possible causes: Single-core sequential loading; Inappropriate concurrency settings; Unreasonable large file chunking strategy.</li> <li>Troubleshooting steps:<ul> <li>Set source-level/document-level concurrency: <code>WithSourceConcurrency(N)</code>, <code>WithDocConcurrency(M)</code>;</li> <li>Adjust chunk size to avoid too many small chunks;</li> <li>Temporarily disable statistics output to reduce log overhead: <code>WithShowStats(false)</code>.</li> </ul> </li> <li>Reference code:    <pre><code>err := kb.Load(ctx,\n    knowledge.WithSourceConcurrency(runtime.NumCPU()),\n    knowledge.WithDocConcurrency(runtime.NumCPU()*2),\n    knowledge.WithShowStats(false),\n)\n</code></pre></li> </ul> </li> <li> <p>Storage connection failure (pgvector/TcVector)</p> <ul> <li>Possible causes: Incorrect connection parameters; Network/authentication failure; Service not started or port not accessible.</li> <li>Troubleshooting steps:<ul> <li>Use native client to connect once first (psql/curl);</li> <li>Explicitly print current configuration (host/port/user/db/url);</li> <li>For minimal example, only insert/query one record to verify.</li> </ul> </li> </ul> </li> <li> <p>High memory usage</p> <ul> <li>Possible causes: Loading too many documents at once; Chunk size/overlap too large; Similarity filtering too wide.</li> <li>Troubleshooting steps:<ul> <li>Reduce concurrency and chunk overlap;</li> <li>Load directories in batches.</li> </ul> </li> </ul> </li> <li> <p>Dimension/vector mismatch</p> <ul> <li>Symptoms: Search phase errors or abnormal scores of 0.</li> <li>Troubleshooting:<ul> <li>Confirm embedding model dimension matches existing vectors (<code>text-embedding-3-small</code> is 1536);</li> <li>After replacing embedding model, need to rebuild (clear and reload) vector database.</li> </ul> </li> </ul> </li> <li> <p>Path/format reading failure</p> <ul> <li>Symptoms: Loading logs show 0 documents or specific source errors.</li> <li>Troubleshooting:<ul> <li>Confirm files exist and extensions are supported (.md/.txt/.pdf/.csv/.json/.docx, etc.);</li> <li>Whether directory source needs <code>WithRecursive(true)</code>;</li> <li>Use <code>WithFileExtensions</code> for whitelist filtering.</li> </ul> </li> </ul> </li> <li> <p>PDF file reading support</p> <ul> <li>Note: The PDF reader depends on third-party libraries. To avoid introducing unnecessary dependencies into the main module, the PDF reader uses a separate <code>go.mod</code>.</li> <li>Usage: To support PDF file reading, manually import the PDF reader package for registration:    <pre><code>import (\n    // Import PDF reader to support .pdf file parsing.\n    _ \"trpc.group/trpc-go/trpc-agent-go/knowledge/document/reader/pdf\"\n)\n</code></pre></li> <li>Note: Readers for other formats (.txt/.md/.csv/.json, etc.) are automatically registered and do not require manual import.</li> </ul> </li> </ol>"},{"location":"memory/","title":"Memory Usage Guide","text":""},{"location":"memory/#overview","title":"Overview","text":"<p>The Memory module is the memory management system in the tRPC-Agent-Go framework, providing Agents with persistent memory and context management capabilities. By integrating memory services, session management, and memory tools, the Memory system helps Agents remember user information, maintain dialog context, and provide personalized response experiences across multiple conversations.</p>"},{"location":"memory/#positioning","title":"Positioning","text":"<p>Memory manages long-term user information with isolation dimension <code>&lt;appName, userID&gt;</code>. It can be understood as a \"personal profile\" gradually accumulated around a single user.</p> <p>In cross-session scenarios, Memory enables the system to retain key user information, avoiding repetitive information gathering in each session.</p> <p>It is suitable for recording stable, reusable facts such as \"user name is John\", \"occupation is backend engineer\", \"prefers concise answers\", \"commonly used language is English\", and directly using this information in subsequent interactions.</p>"},{"location":"memory/#core-values","title":"Core Values","text":"<ul> <li>Context Continuity: Maintain user history across sessions, avoiding   repetitive questioning and input.</li> <li>Personalized Service: Provide customized responses and suggestions based   on long-term user profiles and preferences.</li> <li>Knowledge Accumulation: Transform facts and experiences from   conversations into reusable knowledge.</li> <li>Persistent Storage: Support multiple storage backends to ensure data   safety and reliability.</li> </ul>"},{"location":"memory/#use-cases","title":"Use Cases","text":"<p>The Memory module is suitable for scenarios requiring cross-session user information and context retention:</p>"},{"location":"memory/#use-case-1-personalized-customer-service-agent","title":"Use Case 1: Personalized Customer Service Agent","text":"<p>Requirement: Customer service Agent needs to remember user information, historical issues, and preferences for consistent service.</p> <p>Implementation: - First conversation: Agent uses <code>memory_add</code> to record name, company, contact - Record user preferences like \"prefers concise answers\", \"technical   background\" - Subsequent sessions: Agent uses <code>memory_load</code> to load user info, no repeated   questions needed - After resolving issues: Use <code>memory_update</code> to update issue status</p>"},{"location":"memory/#use-case-2-learning-companion-agent","title":"Use Case 2: Learning Companion Agent","text":"<p>Requirement: Educational Agent needs to track student learning progress, knowledge mastery, and interests.</p> <p>Implementation: - Use <code>memory_add</code> to record mastered knowledge points - Use topic tags for categorization: <code>[\"math\", \"geometry\"]</code>,   <code>[\"programming\", \"Python\"]</code> - Use <code>memory_search</code> to query related knowledge, avoid repeated teaching - Adjust teaching strategies based on memories, provide personalized learning   paths</p>"},{"location":"memory/#use-case-3-project-management-agent","title":"Use Case 3: Project Management Agent","text":"<p>Requirement: Project management Agent needs to track project information, team members, and task progress.</p> <p>Implementation: - Record key project info: <code>memory_add(\"Project X uses Go language\",   [\"project\", \"tech-stack\"])</code> - Record team member roles: <code>memory_add(\"John Doe is backend lead\",   [\"team\", \"role\"])</code> - Use <code>memory_search</code> to quickly find relevant information - After project completion: Use <code>memory_clear</code> to clear temporary information</p>"},{"location":"memory/#quick-start","title":"Quick Start","text":""},{"location":"memory/#requirements","title":"Requirements","text":"<ul> <li>Go 1.21 or later.</li> <li>A valid LLM API key (OpenAI-compatible endpoint).</li> <li>Redis service (optional for production).</li> </ul>"},{"location":"memory/#environment-variables","title":"Environment Variables","text":"<pre><code># OpenAI API configuration\nexport OPENAI_API_KEY=\"your-openai-api-key\"\nexport OPENAI_BASE_URL=\"your-openai-base-url\"\n</code></pre>"},{"location":"memory/#minimal-example","title":"Minimal Example","text":"<pre><code>package main\n\nimport (\n    \"context\"\n    \"log\"\n\n    // Core components.\n    \"trpc.group/trpc-go/trpc-agent-go/agent/llmagent\"\n    memoryinmemory \"trpc.group/trpc-go/trpc-agent-go/memory/inmemory\"\n    \"trpc.group/trpc-go/trpc-agent-go/model\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/openai\"\n    \"trpc.group/trpc-go/trpc-agent-go/runner\"\n    \"trpc.group/trpc-go/trpc-agent-go/session/inmemory\"\n)\n\nfunc main() {\n    ctx := context.Background()\n\n    // 1. Create the memory service.\n    memoryService := memoryinmemory.NewMemoryService()\n\n    // 2. Create the LLM model.\n    modelInstance := openai.New(\"deepseek-chat\")\n\n    // 3. Create the Agent and register memory tools.\n    llmAgent := llmagent.New(\n        \"memory-assistant\",\n        llmagent.WithModel(modelInstance),\n        llmagent.WithDescription(\"An assistant with memory capabilities.\"),\n        llmagent.WithInstruction(\n            \"Remember important user info and recall it when needed.\",\n        ),\n        llmagent.WithTools(memoryService.Tools()), // Register memory tools.\n    )\n\n    // 4. Create the Runner with memory service.\n    sessionService := inmemory.NewSessionService()\n    appRunner := runner.NewRunner(\n        \"memory-chat\",\n        llmAgent,\n        runner.WithSessionService(sessionService),\n        runner.WithMemoryService(memoryService), // Set memory service.\n    )\n\n    // 5. Run a dialog (the Agent uses memory tools automatically).\n    log.Println(\"\ud83e\udde0 Starting memory-enabled chat...\")\n    message := model.NewUserMessage(\n        \"Hi, my name is John, and I like programming\",\n    )\n    eventChan, err := appRunner.Run(ctx, \"user123\", \"session456\", message)\n    if err != nil {\n        log.Fatalf(\"Failed to run agent: %v\", err)\n    }\n\n    // 6. Handle responses ...\n    _ = eventChan\n}\n</code></pre>"},{"location":"memory/#core-concepts","title":"Core Concepts","text":"<p>The memory module is the core of tRPC-Agent-Go's memory management. It provides complete memory storage and retrieval capabilities with a modular design that supports multiple storage backends and memory tools.</p> <pre><code>memory/\n\u251c\u2500\u2500 memory.go          # Core interface definitions.\n\u251c\u2500\u2500 inmemory/          # In-memory memory service implementation.\n\u251c\u2500\u2500 redis/             # Redis memory service implementation.\n\u2514\u2500\u2500 tool/              # Memory tools implementation.\n    \u251c\u2500\u2500 tool.go        # Tool interfaces and implementations.\n    \u2514\u2500\u2500 types.go       # Tool type definitions.\n</code></pre>"},{"location":"memory/#usage-guide","title":"Usage Guide","text":""},{"location":"memory/#integrate-with-agent","title":"Integrate with Agent","text":"<p>Use a two-step approach to integrate the Memory Service with an Agent:</p> <ol> <li>Register tools: Use <code>llmagent.WithTools(memoryService.Tools())</code> to register memory tools with the Agent</li> <li>Set service: Use <code>runner.WithMemoryService(memoryService)</code> to set the memory service in the Runner</li> </ol> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/agent/llmagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/memory\"\n    memoryinmemory \"trpc.group/trpc-go/trpc-agent-go/memory/inmemory\"\n    \"trpc.group/trpc-go/trpc-agent-go/runner\"\n)\n\n// Step 1: Create memory service\nmemoryService := memoryinmemory.NewMemoryService()\n\n// Step 2: Create Agent and register memory tools\nllmAgent := llmagent.New(\n    \"memory-assistant\",\n    llmagent.WithModel(modelInstance),\n    llmagent.WithDescription(\"An assistant with memory capabilities.\"),\n    llmagent.WithTools(memoryService.Tools()), // Explicitly register tools\n)\n\n// Step 3: Create Runner and set memory service\nappRunner := runner.NewRunner(\n    \"memory-chat\",\n    llmAgent,\n    runner.WithMemoryService(memoryService), // Set service at Runner level\n)\n</code></pre>"},{"location":"memory/#memory-service","title":"Memory Service","text":"<p>Configure the memory service in code. Three backends are supported: in-memory, Redis, MySQL, and PostgreSQL.</p>"},{"location":"memory/#configuration-example","title":"Configuration Example","text":"<pre><code>import (\n    memoryinmemory \"trpc.group/trpc-go/trpc-agent-go/memory/inmemory\"\n    memoryredis \"trpc.group/trpc-go/trpc-agent-go/memory/redis\"\n    memorymysql \"trpc.group/trpc-go/trpc-agent-go/memory/mysql\"\n    memorypostgres \"trpc.group/trpc-go/trpc-agent-go/memory/postgres\"\n)\n\n// In-memory implementation for development and testing.\nmemService := memoryinmemory.NewMemoryService()\n\n// Redis implementation for production.\nredisService, err := memoryredis.NewService(\n    memoryredis.WithRedisClientURL(\"redis://localhost:6379\"),\n    memoryredis.WithToolEnabled(memory.DeleteToolName, true), // Enable delete.\n)\nif err != nil {\n    // Handle error.\n}\n\n// MySQL implementation for production (relational database).\n// Table is automatically created on service initialization. Panics if creation fails.\nmysqlService, err := memorymysql.NewService(\n    memorymysql.WithMySQLClientDSN(\"user:password@tcp(localhost:3306)/dbname?parseTime=true\"),\n    memorymysql.WithToolEnabled(memory.DeleteToolName, true), // Enable delete.\n)\nif err != nil {\n    // Handle error.\n}\n\n// PostgreSQL implementation for production (relational database).\n// Table is automatically created on service initialization. Panics if creation fails.\npostgresService, err := memorypostgres.NewService(\n    memorypostgres.WithPostgresConnString(\"postgres://user:password@localhost:5432/dbname\"),\n    memorypostgres.WithSoftDelete(true), // Enable soft delete.\n    memorypostgres.WithToolEnabled(memory.DeleteToolName, true), // Enable delete.\n)\nif err != nil {\n    // Handle error.\n}\n\n// Register memory tools with the Agent.\nllmAgent := llmagent.New(\n    \"memory-assistant\",\n    llmagent.WithTools(memService.Tools()), // Or redisService.Tools(), mysqlService.Tools(), or postgresService.Tools().\n)\n\n// Set memory service in the Runner.\nrunner := runner.NewRunner(\n    \"app\",\n    llmAgent,\n    runner.WithMemoryService(memService), // Or redisService, mysqlService, or postgresService.\n)\n</code></pre>"},{"location":"memory/#memory-tool-configuration","title":"Memory Tool Configuration","text":"<p>The memory service provides 6 tools. Common tools are enabled by default, while dangerous operations require manual enabling.</p>"},{"location":"memory/#tool-list","title":"Tool List","text":"Tool Function Default Description <code>memory_add</code> Add new memory \u2705 Enabled Create new memory entry <code>memory_update</code> Update memory \u2705 Enabled Modify existing memory <code>memory_search</code> Search memory \u2705 Enabled Find by keywords <code>memory_load</code> Load memories \u2705 Enabled Load recent memories <code>memory_delete</code> Delete memory \u274c Disabled Delete single memory <code>memory_clear</code> Clear memories \u274c Disabled Delete all memories"},{"location":"memory/#enabledisable-tools","title":"Enable/Disable Tools","text":"<pre><code>// Scenario 1: User manageable (allow single deletion)\nmemoryService := memoryinmemory.NewMemoryService(\n    memoryinmemory.WithToolEnabled(memory.DeleteToolName, true),\n)\n\n// Scenario 2: Admin privileges (allow clearing all)\nmemoryService := memoryinmemory.NewMemoryService(\n    memoryinmemory.WithToolEnabled(memory.DeleteToolName, true),\n    memoryinmemory.WithToolEnabled(memory.ClearToolName, true),\n)\n\n// Scenario 3: Read-only assistant (query only)\nmemoryService := memoryinmemory.NewMemoryService(\n    memoryinmemory.WithToolEnabled(memory.AddToolName, false),\n    memoryinmemory.WithToolEnabled(memory.UpdateToolName, false),\n)\n</code></pre>"},{"location":"memory/#overwrite-semantics-ids-and-duplicates","title":"Overwrite Semantics (IDs and duplicates)","text":"<ul> <li>Memory IDs are generated from content + topics. Adding the same content and topics   is idempotent and overwrites the existing entry (not append). UpdatedAt is refreshed.</li> <li>If you need append semantics or different duplicate-handling strategies, you can   implement custom tools or extend the service with policy options (e.g. allow/overwrite/ignore).</li> </ul>"},{"location":"memory/#custom-tool-implementation","title":"Custom Tool Implementation","text":"<p>You can override default tools with custom implementations. See <code>memory/tool/tool.go</code> for reference on how to implement custom tools.</p> <pre><code>import (\n    \"context\"\n    \"fmt\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/memory\"\n    memoryinmemory \"trpc.group/trpc-go/trpc-agent-go/memory/inmemory\"\n    toolmemory \"trpc.group/trpc-go/trpc-agent-go/memory/tool\"\n    \"trpc.group/trpc-go/trpc-agent-go/tool\"\n    \"trpc.group/trpc-go/trpc-agent-go/tool/function\"\n)\n\n// A custom clear tool with real logic using the invocation context.\nfunc customClearMemoryTool() tool.Tool {\n    clearFunc := func(ctx context.Context, _ *toolmemory.ClearMemoryRequest) (*toolmemory.ClearMemoryResponse, error) {\n        // Get memory service and user info from invocation context.\n        memSvc, err := toolmemory.GetMemoryServiceFromContext(ctx)\n        if err != nil {\n            return nil, fmt.Errorf(\"custom clear tool: %w\", err)\n        }\n        appName, userID, err := toolmemory.GetAppAndUserFromContext(ctx)\n        if err != nil {\n            return nil, fmt.Errorf(\"custom clear tool: %w\", err)\n        }\n\n        if err := memSvc.ClearMemories(ctx, memory.UserKey{AppName: appName, UserID: userID}); err != nil {\n            return nil, fmt.Errorf(\"custom clear tool: failed to clear memories: %w\", err)\n        }\n        return &amp;toolmemory.ClearMemoryResponse{Message: \"\ud83c\udf89 All memories cleared successfully!\"}, nil\n    }\n\n    return function.NewFunctionTool(\n        clearFunc,\n        function.WithName(memory.ClearToolName),\n        function.WithDescription(\"Clear all memories for the user.\"),\n    )\n}\n\n// Register the custom tool with an InMemory service.\nmemoryService := memoryinmemory.NewMemoryService(\n    memoryinmemory.WithCustomTool(memory.ClearToolName, customClearMemoryTool),\n)\n</code></pre>"},{"location":"memory/#full-example","title":"Full Example","text":"<p>Below is a complete interactive chat example demonstrating memory capabilities in action.</p>"},{"location":"memory/#run-the-example","title":"Run the Example","text":"<pre><code># View help\ncd examples/memory\ngo run . -h\n\n# Use default config (in-memory storage + streaming)\ngo run .\n\n# Use Redis storage\nexport REDIS_ADDR=localhost:6379\ngo run . -memory redis\n\n# Use MySQL storage (with soft delete)\nexport MYSQL_HOST=localhost\nexport MYSQL_PASSWORD=password\ngo run . -memory mysql -soft-delete\n\n# Use PostgreSQL storage\nexport PG_HOST=localhost\nexport PG_PASSWORD=password\ngo run . -memory postgres -soft-delete\n\n# Non-streaming mode\ngo run . -streaming=false\n</code></pre>"},{"location":"memory/#interactive-demo","title":"Interactive Demo","text":"<pre><code>$ go run .                                          \n\ud83e\udde0 Multi Turn Chat with Memory\nModel: deepseek-chat\nMemory Service: inmemory\nIn-memory\nStreaming: true\nAvailable tools: memory_add, memory_update, memory_search, memory_load\n(memory_delete, memory_clear disabled by default, and can be enabled or customized)\n==================================================\n\u2705 Memory chat ready! Session: memory-session-1765504626\n\n\ud83d\udca1 Special commands:\n   /memory   - Show user memories\n   /new      - Start a new session\n   /exit     - End the conversation\n\n\ud83d\udc64 You: Hi, my name is John and I like coffee.\n\ud83e\udd16 Assistant: Hi John! Nice to meet you. I've made a note that you like coffee. It's great to know your preferences - I'll remember this for our future conversations. Is there anything specific about coffee that you enjoy, or anything else you'd like me to know about you?\n\ud83d\udd27 Memory tool calls initiated:\n   \u2022 memory_add (ID: call_00_wE9FAqaLEPtWcqgF3tQqRoLn)\n     Args: {\"memory\": \"John likes coffee.\", \"topics\": [\"preferences\", \"food-drink\"]}\n\n\ud83d\udd04 Executing memory tools...\n\u2705 Memory tool response (ID: call_00_wE9FAqaLEPtWcqgF3tQqRoLn): {\"message\":\"Memory added successfully\",\"memory\":\"John likes coffee.\",\"topics\":[\"preferences\",\"food-drink\"]}\nI see you're a coffee enthusiast! What brings you here today, John? Are you looking for coffee recommendations, or is there something else I can help you with?\n\n\ud83d\udc64 You: /new\n\ud83c\udd95 Started new memory session!\n   Previous: memory-session-1765504626\n   Current:  memory-session-1765504664\n   (Memory and conversation history have been reset)\n\n\ud83d\udc64 You: What do I like?\n\ud83e\udd16 Assistant: I'll search through my memories to recall what you like. Let me check what information I have stored about your preferences.\n\ud83d\udd27 Memory tool calls initiated:\n   \u2022 memory_search (ID: call_00_CCn57ylCDDQ7iaL88d2JScvl)\n     Args: {\"query\": \"likes preferences favorite enjoy\"}\n\n\ud83d\udd04 Executing memory tools...\n\u2705 Memory tool response (ID: call_00_CCn57ylCDDQ7iaL88d2JScvl): {\"query\":\"likes preferences favorite enjoy\",\"results\":[{\"id\":\"47f1de6c1318d41001a17a46ebb9f9984b6e89e5ac549aedbf34d7744e8862e0\",\"memory\":\"John likes coffee.\",\"topics\":[\"preferences\",\"food-drink\"],\"created\":\"2025-12-12T09:57:12.456153047+08:00\"}],\"count\":1}\nBased on my memories, I know that **you like coffee**. That's the only preference I have recorded so far.\n\nTo give you a more complete answer about your likes, I'd need to learn more about you! Could you tell me about some of your other interests, hobbies, or preferences? For example:\n- What foods or drinks do you enjoy?\n- What hobbies or activities do you like?\n- What kind of music, movies, or books do you prefer?\n- Are there any particular topics or subjects you're interested in?\n\nThe more you share with me, the better I'll be able to remember and help you in the future!\n\n\ud83d\udc64 You: /exit\n\ud83d\udc4b Goodbye!\n</code></pre>"},{"location":"memory/#code-example","title":"Code Example","text":"<p>For full code, see examples/memory. Core implementation:</p> <pre><code>package main\n\nimport (\n    \"context\"\n    \"flag\"\n    \"fmt\"\n    \"log\"\n    \"os\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/agent/llmagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/memory\"\n    memoryinmemory \"trpc.group/trpc-go/trpc-agent-go/memory/inmemory\"\n    memoryredis \"trpc.group/trpc-go/trpc-agent-go/memory/redis\"\n    memorymysql \"trpc.group/trpc-go/trpc-agent-go/memory/mysql\"\n    memorypostgres \"trpc.group/trpc-go/trpc-agent-go/memory/postgres\"\n    \"trpc.group/trpc-go/trpc-agent-go/model\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/openai\"\n    \"trpc.group/trpc-go/trpc-agent-go/runner\"\n    \"trpc.group/trpc-go/trpc-agent-go/session/inmemory\"\n)\n\nfunc main() {\n    var (\n        memType    = flag.String(\"memory\", \"inmemory\", \"Memory service type\")\n        streaming  = flag.Bool(\"streaming\", true, \"Enable streaming\")\n        softDelete = flag.Bool(\"soft-delete\", false, \"Enable soft delete\")\n        modelName  = flag.String(\"model\", \"deepseek-chat\", \"Model name\")\n    )\n    flag.Parse()\n\n    ctx := context.Background()\n\n    // 1. Create memory service\n    memoryService, err := createMemoryService(*memType, *softDelete)\n    if err != nil {\n        log.Fatalf(\"Failed to create memory service: %v\", err)\n    }\n\n    // 2. Create model\n    modelInstance := openai.New(*modelName)\n\n    // 3. Create Agent\n    genConfig := model.GenerationConfig{\n        MaxTokens:   intPtr(2000),\n        Temperature: floatPtr(0.7),\n        Stream:      *streaming,\n    }\n\n    llmAgent := llmagent.New(\n        \"memory-assistant\",\n        llmagent.WithModel(modelInstance),\n        llmagent.WithDescription(\n            \"A helpful AI assistant with memory capabilities. \"+\n            \"I can remember important information about you and \"+\n            \"recall it when needed.\",\n        ),\n        llmagent.WithGenerationConfig(genConfig),\n        llmagent.WithTools(memoryService.Tools()),\n    )\n\n    // 4. Create Runner\n    sessionService := inmemory.NewSessionService()\n    appRunner := runner.NewRunner(\n        \"memory-chat\",\n        llmAgent,\n        runner.WithSessionService(sessionService),\n        runner.WithMemoryService(memoryService),\n    )\n    defer appRunner.Close()\n\n    // 5. Run chat\n    log.Println(\"\ud83e\udde0 Starting memory-enabled chat...\")\n    // ... handle user input and responses\n}\n\nfunc createMemoryService(memType string, softDelete bool) (\n    memory.Service, error) {\n\n    switch memType {\n    case \"redis\":\n        redisAddr := os.Getenv(\"REDIS_ADDR\")\n        if redisAddr == \"\" {\n            redisAddr = \"localhost:6379\"\n        }\n        return memoryredis.NewService(\n            memoryredis.WithRedisClientURL(\n                fmt.Sprintf(\"redis://%s\", redisAddr),\n            ),\n            memoryredis.WithToolEnabled(memory.DeleteToolName, false),\n        )\n\n    case \"mysql\":\n        dsn := buildMySQLDSN()\n        return memorymysql.NewService(\n            memorymysql.WithMySQLClientDSN(dsn),\n            memorymysql.WithSoftDelete(softDelete),\n            memorymysql.WithToolEnabled(memory.DeleteToolName, false),\n        )\n\n    case \"postgres\":\n        return memorypostgres.NewService(\n            memorypostgres.WithHost(getEnv(\"PG_HOST\", \"localhost\")),\n            memorypostgres.WithPort(getEnvInt(\"PG_PORT\", 5432)),\n            memorypostgres.WithUser(getEnv(\"PG_USER\", \"postgres\")),\n            memorypostgres.WithPassword(getEnv(\"PG_PASSWORD\", \"\")),\n            memorypostgres.WithDatabase(getEnv(\"PG_DATABASE\", \"postgres\")),\n            memorypostgres.WithSoftDelete(softDelete),\n            memorypostgres.WithToolEnabled(memory.DeleteToolName, false),\n        )\n\n    default: // inmemory\n        return memoryinmemory.NewMemoryService(\n            memoryinmemory.WithToolEnabled(memory.DeleteToolName, false),\n        ), nil\n    }\n}\n\nfunc buildMySQLDSN() string {\n    host := getEnv(\"MYSQL_HOST\", \"localhost\")\n    port := getEnv(\"MYSQL_PORT\", \"3306\")\n    user := getEnv(\"MYSQL_USER\", \"root\")\n    password := getEnv(\"MYSQL_PASSWORD\", \"\")\n    database := getEnv(\"MYSQL_DATABASE\", \"trpc_agent_go\")\n\n    return fmt.Sprintf(\n        \"%s:%s@tcp(%s:%s)/%s?parseTime=true&amp;charset=utf8mb4\",\n        user, password, host, port, database,\n    )\n}\n\nfunc getEnv(key, defaultVal string) string {\n    if val := os.Getenv(key); val != \"\" {\n        return val\n    }\n    return defaultVal\n}\n\nfunc intPtr(i int) *int             { return &amp;i }\nfunc floatPtr(f float64) *float64   { return &amp;f }\n</code></pre>"},{"location":"memory/#storage-backends","title":"Storage Backends","text":""},{"location":"memory/#in-memory-storage","title":"In-Memory Storage","text":"<p>Use case: Development, testing, rapid prototyping</p> <pre><code>import memoryinmemory \"trpc.group/trpc-go/trpc-agent-go/memory/inmemory\"\n\nmemoryService := memoryinmemory.NewMemoryService()\n</code></pre> <p>Configuration options: - <code>WithMemoryLimit(limit int)</code>: Set memory limit per user - <code>WithCustomTool(toolName, creator)</code>: Register custom tool implementation - <code>WithToolEnabled(toolName, enabled)</code>: Enable/disable specific tool</p> <p>Features: Zero config, high performance, no persistence</p>"},{"location":"memory/#redis-storage","title":"Redis Storage","text":"<p>Use case: Production, high concurrency, distributed deployment</p> <pre><code>import memoryredis \"trpc.group/trpc-go/trpc-agent-go/memory/redis\"\n\nredisService, err := memoryredis.NewService(\n    memoryredis.WithRedisClientURL(\"redis://localhost:6379\"),\n)\n</code></pre> <p>Configuration options: - <code>WithRedisClientURL(url)</code>: Redis connection URL (recommended) - <code>WithRedisInstance(name)</code>: Use pre-registered Redis instance - <code>WithMemoryLimit(limit)</code>: Memory limit per user - <code>WithCustomTool(toolName, creator)</code>: Register custom tool - <code>WithToolEnabled(toolName, enabled)</code>: Enable/disable tool - <code>WithExtraOptions(...options)</code>: Extra options passed to Redis client</p> <p>Note: <code>WithRedisClientURL</code> takes priority over <code>WithRedisInstance</code></p>"},{"location":"memory/#mysql-storage","title":"MySQL Storage","text":"<p>Use case: Production, ACID guarantees, complex queries</p> <pre><code>import memorymysql \"trpc.group/trpc-go/trpc-agent-go/memory/mysql\"\n\ndsn := \"user:password@tcp(localhost:3306)/dbname?parseTime=true\"\nmysqlService, err := memorymysql.NewService(\n    memorymysql.WithMySQLClientDSN(dsn),\n    memorymysql.WithSoftDelete(true),\n)\n</code></pre> <p>Configuration options: - <code>WithMySQLClientDSN(dsn)</code>: MySQL DSN connection string (recommended, requires <code>parseTime=true</code>) - <code>WithMySQLInstance(name)</code>: Use pre-registered MySQL instance - <code>WithSoftDelete(enabled)</code>: Enable soft delete (default false) - <code>WithTableName(name)</code>: Custom table name (default \"memories\") - <code>WithMemoryLimit(limit)</code>: Memory limit per user - <code>WithCustomTool(toolName, creator)</code>: Register custom tool - <code>WithToolEnabled(toolName, enabled)</code>: Enable/disable tool - <code>WithExtraOptions(...options)</code>: Extra options passed to MySQL client - <code>WithSkipDBInit(skip)</code>: Skip table initialization (for users without DDL permissions)</p> <p>DSN example: <pre><code>root:password@tcp(localhost:3306)/memory_db?parseTime=true&amp;charset=utf8mb4\n</code></pre></p> <p>Table schema (auto-created): <pre><code>CREATE TABLE memories (\n    id BIGINT AUTO_INCREMENT PRIMARY KEY,\n    app_name VARCHAR(255) NOT NULL,\n    user_id VARCHAR(255) NOT NULL,\n    memory_id VARCHAR(64) NOT NULL,\n    memory_data JSON NOT NULL,\n    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n    deleted_at TIMESTAMP NULL,\n    UNIQUE INDEX (app_name, user_id, memory_id)\n)\n</code></pre></p> <p>Resource cleanup: Call <code>Close()</code> method to release database connection: <pre><code>defer mysqlService.Close()\n</code></pre></p>"},{"location":"memory/#postgresql-storage","title":"PostgreSQL Storage","text":"<p>Use case: Production, advanced JSONB features</p> <pre><code>import memorypostgres \"trpc.group/trpc-go/trpc-agent-go/memory/postgres\"\n\npostgresService, err := memorypostgres.NewService(\n    memorypostgres.WithHost(\"localhost\"),\n    memorypostgres.WithPort(5432),\n    memorypostgres.WithUser(\"postgres\"),\n    memorypostgres.WithPassword(\"password\"),\n    memorypostgres.WithDatabase(\"dbname\"),\n    memorypostgres.WithSoftDelete(true),\n)\n</code></pre> <p>Configuration options: - <code>WithHost/WithPort/WithUser/WithPassword/WithDatabase</code>: Connection parameters - <code>WithSSLMode(mode)</code>: SSL mode (default \"disable\") - <code>WithPostgresInstance(name)</code>: Use pre-registered PostgreSQL instance - <code>WithSoftDelete(enabled)</code>: Enable soft delete (default false) - <code>WithTableName(name)</code>: Custom table name (default \"memories\") - <code>WithSchema(schema)</code>: Specify database schema (default is public) - <code>WithMemoryLimit(limit)</code>: Memory limit per user - <code>WithCustomTool(toolName, creator)</code>: Register custom tool - <code>WithToolEnabled(toolName, enabled)</code>: Enable/disable tool - <code>WithExtraOptions(...options)</code>: Extra options passed to PostgreSQL client - <code>WithSkipDBInit(skip)</code>: Skip table initialization (for users without DDL permissions)</p> <p>Note: Direct connection parameters take priority over <code>WithPostgresInstance</code></p> <p>Table schema (auto-created): <pre><code>CREATE TABLE memories (\n    id BIGSERIAL PRIMARY KEY,\n    app_name VARCHAR(255) NOT NULL,\n    user_id VARCHAR(255) NOT NULL,\n    memory_id VARCHAR(64) NOT NULL,\n    memory_data JSONB NOT NULL,\n    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n    deleted_at TIMESTAMP NULL,\n    UNIQUE (app_name, user_id, memory_id)\n)\n</code></pre></p> <p>Resource cleanup: Call <code>Close()</code> method to release database connection: <pre><code>defer postgresService.Close()\n</code></pre></p>"},{"location":"memory/#backend-comparison","title":"Backend Comparison","text":"Feature InMemory Redis MySQL PostgreSQL Persistence \u274c \u2705 \u2705 \u2705 Distributed \u274c \u2705 \u2705 \u2705 Transactions \u274c Partial \u2705 ACID \u2705 ACID Queries Simple Medium SQL SQL JSON \u274c Basic JSON JSONB Performance Very High High Med-High Med-High Configuration Zero Simple Medium Medium Soft Delete \u274c \u274c \u2705 \u2705 Use Case Dev/Test High Concurrency Enterprise Advanced Features <p>Selection guide:</p> <pre><code>Development/Testing \u2192 InMemory (zero config, fast)\nHigh Concurrency \u2192 Redis (memory-level performance)\nACID Requirements \u2192 MySQL/PostgreSQL (transaction guarantees)\nComplex JSON \u2192 PostgreSQL (JSONB indexing and queries)\nAudit Trail \u2192 MySQL/PostgreSQL (soft delete support)\n</code></pre> <p>Register PostgreSQL Instance (Optional):</p> <pre><code>import (\n    storage \"trpc.group/trpc-go/trpc-agent-go/storage/postgres\"\n    memorypostgres \"trpc.group/trpc-go/trpc-agent-go/memory/postgres\"\n)\n\n// Register PostgreSQL instance\nstorage.RegisterPostgresInstance(\"my-postgres\",\n    storage.WithClientConnString(\"postgres://user:password@localhost:5432/dbname\"),\n)\n\n// Use registered instance\npostgresService, err := memorypostgres.NewService(\n    memorypostgres.WithPostgresInstance(\"my-postgres\"),\n)\n</code></pre>"},{"location":"memory/#storage-backend-comparison","title":"Storage Backend Comparison","text":"Feature In-Memory Redis MySQL PostgreSQL Data Persistence \u274c \u2705 \u2705 \u2705 Distributed Support \u274c \u2705 \u2705 \u2705 Transaction Support \u274c Partial \u2705 (ACID) \u2705 (ACID) Query Capability Simple Medium Powerful (SQL) Powerful (SQL) JSON Support \u274c Partial \u2705 (JSON) \u2705 (JSONB) Performance Very High High Medium-High Medium-High Configuration Complexity Low Medium Medium Medium Use Case Dev/Test Production Production Production Monitoring Tools None Rich Very Rich Very Rich <p>Selection Guide:</p> <ul> <li>Development/Testing: Use in-memory storage for fast iteration</li> <li>Production (High Performance): Use Redis storage for high concurrency scenarios</li> <li>Production (Data Integrity): Use MySQL storage when ACID guarantees and complex queries are needed</li> <li>Production (PostgreSQL): Use PostgreSQL storage when JSONB support and advanced PostgreSQL features are needed</li> <li>Hybrid Deployment: Choose different storage backends based on different application scenarios</li> </ul>"},{"location":"memory/#faq","title":"FAQ","text":""},{"location":"memory/#difference-between-memory-and-session","title":"Difference between Memory and Session","text":"<p>Memory and Session solve different problems:</p> Dimension Memory Session Purpose Long-term user profile Temporary conversation context Isolation <code>&lt;appName, userID&gt;</code> <code>&lt;appName, userID, sessionID&gt;</code> Lifecycle Persists across sessions Valid within a single session Content User profile, preferences, facts Conversation history, messages Data Size Small (tens to hundreds) Large (tens to thousands of messages) Use Case \"Remember who the user is\" \"Remember what was said\" <p>Example:</p> <pre><code>// Memory: persists across sessions\nmemory.AddMemory(ctx, userKey, \"User is a backend engineer\", []string{\"occupation\"})\n\n// Session: valid only within a session\nsession.AddMessage(ctx, sessionKey, userMessage(\"What's the weather today?\"))\nsession.AddMessage(ctx, sessionKey, agentMessage(\"It's sunny today\"))\n\n// New session: Memory retained, Session reset\n</code></pre>"},{"location":"memory/#memory-id-idempotency","title":"Memory ID Idempotency","text":"<p>Memory ID is generated from SHA256 hash of \"content + topics\". Same content produces the same ID:</p> <pre><code>// First add\nmemory.AddMemory(ctx, userKey, \"User likes programming\", []string{\"hobby\"})\n// Generated ID: abc123...\n\n// Second add with same content\nmemory.AddMemory(ctx, userKey, \"User likes programming\", []string{\"hobby\"})\n// Same ID: abc123..., overwrites, refreshes updated_at\n</code></pre> <p>Implications: - \u2705 Natural deduplication: Avoids redundant storage - \u2705 Idempotent operations: Repeated additions don't create multiple records - \u26a0\ufe0f Overwrite update: Cannot append same content (add timestamp or sequence number if append is needed)</p>"},{"location":"memory/#search-function-limitations","title":"Search Function Limitations","text":"<p>Memory uses token matching, not semantic search:</p> <p>English tokenization: lowercase \u2192 filter stopwords (a, the, is, etc.) \u2192 split by spaces</p> <pre><code>// Can find\nMemory: \"User likes programming\"\nSearch: \"programming\" \u2705 Match\n\n// Cannot find\nMemory: \"User likes programming\"\nSearch: \"coding\" \u274c No match (semantically similar but different words)\n</code></pre> <p>Chinese tokenization: uses bigrams</p> <pre><code>Memory: \"\u7528\u6237\u559c\u6b22\u7f16\u7a0b\"\nSearch: \"\u7f16\u7a0b\" \u2705 Match (\"\u7f16\u7a0b\" in bigrams)\nSearch: \"\u5199\u4ee3\u7801\" \u274c No match (different words)\n</code></pre> <p>Limitations: - All backends perform filtering and sorting in application layer (O(n) complexity) - Performance affected by data volume - No semantic similarity search</p> <p>Recommendations: - Use explicit keywords and topic tags to improve hit rate - Consider integrating vector database for semantic search (requires custom implementation)</p>"},{"location":"memory/#soft-delete-considerations","title":"Soft Delete Considerations","text":"<p>Support status: - \u2705 MySQL, PostgreSQL: support soft delete - \u274c InMemory, Redis: not supported (hard delete only)</p> <p>Soft delete configuration:</p> <pre><code>mysqlService, err := memorymysql.NewService(\n    memorymysql.WithMySQLClientDSN(\"...\"),\n    memorymysql.WithSoftDelete(true), // Enable soft delete\n)\n</code></pre> <p>Behavior differences:</p> Operation Hard Delete Soft Delete Delete Immediate removal Set <code>deleted_at</code> field Query Not visible Auto-filtered (WHERE deleted_at IS NULL) Recovery Cannot recover Can manually clear <code>deleted_at</code> Storage Saves space Occupies space <p>Migration trap: <pre><code>// \u26a0\ufe0f Migrating from soft-delete backend to non-supporting backend\n// Soft-deleted records will be lost!\n\n// Migrating from MySQL (soft delete) to Redis (hard delete)\n// Need to manually handle soft-deleted records\n</code></pre></p>"},{"location":"memory/#best-practices","title":"Best Practices","text":""},{"location":"memory/#production-environment-configuration","title":"Production Environment Configuration","text":"<pre><code>// \u2705 Recommended configuration\npostgresService, err := memorypostgres.NewService(\n    // Use environment variables for sensitive info\n    memorypostgres.WithHost(os.Getenv(\"DB_HOST\")),\n    memorypostgres.WithUser(os.Getenv(\"DB_USER\")),\n    memorypostgres.WithPassword(os.Getenv(\"DB_PASSWORD\")),\n    memorypostgres.WithDatabase(os.Getenv(\"DB_NAME\")),\n\n    // Enable soft delete (for recovery)\n    memorypostgres.WithSoftDelete(true),\n\n    // Reasonable limit\n    memorypostgres.WithMemoryLimit(1000),\n)\n</code></pre>"},{"location":"memory/#error-handling","title":"Error Handling","text":"<pre><code>// \u2705 Complete error handling\nerr := memoryService.AddMemory(ctx, userKey, content, topics)\nif err != nil {\n    if strings.Contains(err.Error(), \"limit exceeded\") {\n        // Handle limit: clean old memories or reject\n        log.Warnf(\"Memory limit exceeded for user %s\", userKey.UserID)\n    } else {\n        return fmt.Errorf(\"failed to add memory: %w\", err)\n    }\n}\n</code></pre>"},{"location":"memory/#tool-enabling-strategy","title":"Tool Enabling Strategy","text":"<pre><code>// Scenario 1: Read-only assistant\nreadOnlyService := memoryinmemory.NewMemoryService(\n    memoryinmemory.WithToolEnabled(memory.LoadToolName, true),\n    memoryinmemory.WithToolEnabled(memory.SearchToolName, true),\n    memoryinmemory.WithToolEnabled(memory.AddToolName, false),\n    memoryinmemory.WithToolEnabled(memory.UpdateToolName, false),\n)\n\n// Scenario 2: Regular user\nuserService := memoryinmemory.NewMemoryService(\n    memoryinmemory.WithToolEnabled(memory.DeleteToolName, true),\n    // clear disabled (prevent accidental deletion)\n)\n\n// Scenario 3: Admin\nadminService := memoryinmemory.NewMemoryService(\n    memoryinmemory.WithToolEnabled(memory.DeleteToolName, true),\n    memoryinmemory.WithToolEnabled(memory.ClearToolName, true),\n)\n</code></pre>"},{"location":"memory/#references","title":"References","text":"<ul> <li>Memory Module Source</li> <li>Complete Examples</li> <li>API Documentation</li> </ul>"},{"location":"model/","title":"Model Module","text":""},{"location":"model/#overview","title":"Overview","text":"<p>The Model module is the large language model abstraction layer of the tRPC-Agent-Go framework, providing a unified LLM interface design that currently supports OpenAI-compatible and Anthropic-compatible API calls. Through standardized interface design, developers can flexibly switch between different model providers, achieving seamless model integration and invocation. This module has been verified to be compatible with most OpenAI-like interfaces both inside and outside the company.</p> <p>The Model module has the following core features:</p> <ul> <li>Unified Interface Abstraction: Provides standardized <code>Model</code> interface, shielding differences between model providers</li> <li>Streaming Response Support: Native support for streaming output, enabling real-time interactive experience</li> <li>Multimodal Capabilities: Supports text, image, audio, and other multimodal content processing</li> <li>Complete Error Handling: Provides dual-layer error handling mechanism, distinguishing between system errors and API errors</li> <li>Extensible Configuration: Supports rich custom configuration options to meet different scenario requirements</li> </ul>"},{"location":"model/#quick-start","title":"Quick Start","text":""},{"location":"model/#using-model-in-agent","title":"Using Model in Agent","text":"<pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/agent/llmagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/model\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/openai\"\n    \"trpc.group/trpc-go/trpc-agent-go/runner\"\n    \"trpc.group/trpc-go/trpc-agent-go/tool\"\n)\n\nfunc main() {\n    // 1. Create model instance.\n    modelInstance := openai.New(\"deepseek-chat\",\n        openai.WithExtraFields(map[string]interface{}{\n            \"tool_choice\": \"auto\", // Automatically select tools.\n        }),\n    )\n\n    // 2. Configure generation parameters.\n    genConfig := model.GenerationConfig{\n        MaxTokens:   intPtr(2000),\n        Temperature: floatPtr(0.7),\n        Stream:      true, // Enable streaming output.\n    }\n\n    // 3. Create Agent and integrate model.\n    agent := llmagent.New(\n        \"chat-assistant\",\n        llmagent.WithModel(modelInstance),\n        llmagent.WithDescription(\"A helpful assistant\"),\n        llmagent.WithInstruction(\"You are an intelligent assistant, use tools when needed.\"),\n        llmagent.WithGenerationConfig(genConfig),\n        llmagent.WithTools([]tool.Tool{calculatorTool, timeTool}),\n    )\n\n    // 4. Create Runner and run.\n    r := runner.NewRunner(\"app-name\", agent)\n    eventChan, err := r.Run(ctx, userID, sessionID, model.NewUserMessage(\"Hello\"))\n    if err != nil {\n        log.Fatal(err)\n    }\n\n    // 5. Handle response events.\n    for event := range eventChan {\n        // Handle streaming responses, tool calls, etc.\n    }\n}\n</code></pre> <p>Example code is located at examples/runner</p>"},{"location":"model/#usage-methods-and-platform-integration-guide","title":"Usage Methods and Platform Integration Guide","text":"<p>The Model module supports multiple usage methods and platform integration. The following are common usage scenarios based on Runner examples:</p>"},{"location":"model/#quick-start_1","title":"Quick Start","text":"<pre><code># Basic usage: Configure through environment variables, run directly.\ncd examples/runner\nexport OPENAI_BASE_URL=\"https://api.deepseek.com/v1\"\nexport OPENAI_API_KEY=\"your-api-key\"\ngo run main.go -model deepseek-chat\n</code></pre>"},{"location":"model/#platform-integration-configuration","title":"Platform Integration Configuration","text":"<p>All platform integration methods follow the same pattern, only requiring configuration of different environment variables or direct setting in code:</p> <p>Environment Variable Method (Recommended):</p> <pre><code>export OPENAI_BASE_URL=\"Platform API address\"\nexport OPENAI_API_KEY=\"API key\"\n</code></pre> <p>Code Method:</p> <pre><code>model := openai.New(\"Model name\",\n    openai.WithBaseURL(\"Platform API address\"),\n    openai.WithAPIKey(\"API key\"),\n)\n</code></pre>"},{"location":"model/#supported-platforms-and-their-configuration","title":"Supported Platforms and Their Configuration","text":"<p>The following are configuration examples for each platform, divided into environment variable configuration and code configuration methods:</p> <p>Environment Variable Configuration</p> <p>The runner example supports specifying model names through command line parameters (-model), which is actually passing the model name when calling <code>openai.New()</code>.</p> <pre><code># OpenAI platform.\nexport OPENAI_API_KEY=\"sk-...\"\ncd examples/runner\ngo run main.go -model gpt-4o-mini\n\n# OpenAI API compatible.\nexport OPENAI_BASE_URL=\"https://api.deepseek.com/v1\"\nexport OPENAI_API_KEY=\"your-api-key\"\ncd examples/runner\ngo run main.go -model deepseek-chat\n</code></pre> <p>Code Configuration Method</p> <p>Configuration method when directly using Model in your own code:</p> <pre><code>model := openai.New(\"deepseek-chat\",\n    openai.WithBaseURL(\"https://api.deepseek.com/v1\"),\n    openai.WithAPIKey(\"your-api-key\"),\n)\n\n// Other platform configurations are similar, only need to modify model name, BaseURL and APIKey, no additional fields needed.\n</code></pre>"},{"location":"model/#core-interface-design","title":"Core Interface Design","text":""},{"location":"model/#model-interface","title":"Model Interface","text":"<pre><code>// Model is the interface that all language models must implement.\ntype Model interface {\n    // Generate content, supports streaming response.\n    GenerateContent(ctx context.Context, request *Request) (&lt;-chan *Response, error)\n\n    // Return basic model information.\n    Info() Info\n}\n\n// Model information structure.\ntype Info struct {\n    Name string // Model name.\n}\n</code></pre>"},{"location":"model/#request-structure","title":"Request Structure","text":"<pre><code>// Request represents the request sent to the model.\ntype Request struct {\n    // Message list, containing system instructions, user input and assistant replies.\n    Messages []Message `json:\"messages\"`\n\n    // Generation configuration (inlined into request).\n    GenerationConfig `json:\",inline\"`\n\n    // Tool list.\n    Tools map[string]tool.Tool `json:\"-\"`\n}\n\n// GenerationConfig contains generation parameter configuration.\ntype GenerationConfig struct {\n    // Whether to use streaming response.\n    Stream bool `json:\"stream\"`\n\n    // Temperature parameter (0.0-2.0).\n    Temperature *float64 `json:\"temperature,omitempty\"`\n\n    // Maximum generation token count.\n    MaxTokens *int `json:\"max_tokens,omitempty\"`\n\n    // Top-P sampling parameter.\n    TopP *float64 `json:\"top_p,omitempty\"`\n\n    // Stop generation markers.\n    Stop []string `json:\"stop,omitempty\"`\n\n    // Frequency penalty.\n    FrequencyPenalty *float64 `json:\"frequency_penalty,omitempty\"`\n\n    // Presence penalty.\n    PresencePenalty *float64 `json:\"presence_penalty,omitempty\"`\n\n    // Reasoning effort level (\"low\", \"medium\", \"high\").\n    ReasoningEffort *string `json:\"reasoning_effort,omitempty\"`\n\n    // Whether to enable thinking mode.\n    ThinkingEnabled *bool `json:\"-\"`\n\n    // Maximum token count for thinking mode.\n    ThinkingTokens *int `json:\"-\"`\n}\n</code></pre>"},{"location":"model/#response-structure","title":"Response Structure","text":"<pre><code>// Response represents the response returned by the model.\ntype Response struct {\n    // OpenAI compatible fields.\n    ID                string   `json:\"id,omitempty\"`\n    Object            string   `json:\"object,omitempty\"`\n    Created           int64    `json:\"created,omitempty\"`\n    Model             string   `json:\"model,omitempty\"`\n    SystemFingerprint *string  `json:\"system_fingerprint,omitempty\"`\n    Choices           []Choice `json:\"choices,omitempty\"`\n    Usage             *Usage   `json:\"usage,omitempty\"`\n\n    // Error information.\n    Error *ResponseError `json:\"error,omitempty\"`\n\n    // Internal fields.\n    Timestamp time.Time `json:\"-\"`\n    Done      bool      `json:\"-\"`\n    IsPartial bool      `json:\"-\"`\n}\n\n// ResponseError represents API-level errors.\ntype ResponseError struct {\n    Message string    `json:\"message\"`\n    Type    ErrorType `json:\"type\"`\n    Param   string    `json:\"param,omitempty\"`\n    Code    string    `json:\"code,omitempty\"`\n}\n</code></pre>"},{"location":"model/#openai-model","title":"OpenAI Model","text":""},{"location":"model/#model-name-parameter","title":"Model Name Parameter","text":"<p>When creating an OpenAI model instance using <code>openai.New(name string, opts ...Option)</code>, the first parameter is the actual model name that gets sent to the OpenAI API, as the specific model identifier that tells the API which language model to use.</p> <p>Since the framework supports different models compatible with the OpenAI API, you can obtain the base URL, API key, and model name from various model providers:</p> <p>1. OpenAI Official</p> <ul> <li>Base URL: <code>https://api.openai.com/v1</code></li> <li>Model Names: <code>gpt-4o</code>, <code>gpt-4o-mini</code>, etc.</li> </ul> <p>2. DeepSeek</p> <ul> <li>Base URL: <code>https://api.deepseek.com</code></li> <li>Model Names: <code>deepseek-chat</code>, <code>deepseek-reasoner</code></li> </ul> <p>3. Tencent Hunyuan</p> <ul> <li>Base URL: <code>https://api.hunyuan.cloud.tencent.com/v1</code></li> <li>Model Names: <code>hunyuan-2.0-thinking-20251109</code>, <code>hunyuan-2.0-instruct-20251111</code>, etc.</li> </ul> <p>4. Other Providers</p> <ul> <li>Qwen: Base URL <code>https://dashscope.aliyuncs.com/compatible-mode/v1</code>, Model Names: various qwen models</li> </ul> <p>The OpenAI Model is used to interface with OpenAI and its compatible platforms. It supports streaming output, multimodal and advanced parameter configuration, and provides rich callback mechanisms, batch processing and retry capabilities. It also allows for flexible setting of custom HTTP headers.</p>"},{"location":"model/#configuration-method","title":"Configuration Method","text":""},{"location":"model/#environment-variable-method","title":"Environment Variable Method","text":"<pre><code>export OPENAI_API_KEY=\"your-api-key\"\nexport OPENAI_BASE_URL=\"https://api.openai.com\" # Optional configuration, default is this BASE URL\n</code></pre>"},{"location":"model/#code-method","title":"Code Method","text":"<pre><code>import \"trpc.group/trpc-go/trpc-agent-go/model/openai\"\n\nm := openai.New(\n    \"gpt-4o\",\n    openai.WithAPIKey(\"your-api-key\"),\n    openai.WithBaseURL(\"https://api.openai.com\"), // Optional configuration, default is this BASE URL\n)\n</code></pre>"},{"location":"model/#direct-model-usage","title":"Direct Model Usage","text":"<pre><code>import (\n    \"context\"\n    \"fmt\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/model\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/openai\"\n)\n\nfunc main() {\n    // Create model instance.\n    llm := openai.New(\"deepseek-chat\")\n\n    // Build request.\n    temperature := 0.7\n    maxTokens := 1000\n\n    request := &amp;model.Request{\n        Messages: []model.Message{\n            model.NewSystemMessage(\"You are a professional AI assistant.\"),\n            model.NewUserMessage(\"Introduce Go language's concurrency features.\"),\n        },\n        GenerationConfig: model.GenerationConfig{\n            Temperature: &amp;temperature,\n            MaxTokens:   &amp;maxTokens,\n            Stream:      false,\n        },\n    }\n\n    // Call model.\n    ctx := context.Background()\n    responseChan, err := llm.GenerateContent(ctx, request)\n    if err != nil {\n        fmt.Printf(\"System error: %v\\n\", err)\n        return\n    }\n\n    // Handle response.\n    for response := range responseChan {\n        if response.Error != nil {\n            fmt.Printf(\"API error: %s\\n\", response.Error.Message)\n            return\n        }\n\n        if len(response.Choices) &gt; 0 {\n            fmt.Printf(\"Reply: %s\\n\", response.Choices[0].Message.Content)\n        }\n\n        if response.Done {\n            break\n        }\n    }\n}\n</code></pre>"},{"location":"model/#streaming-output","title":"Streaming Output","text":"<pre><code>// Streaming request configuration.\nrequest := &amp;model.Request{\n    Messages: []model.Message{\n        model.NewSystemMessage(\"You are a creative story teller.\"),\n        model.NewUserMessage(\"Write a short story about a robot learning to paint.\"),\n    },\n    GenerationConfig: model.GenerationConfig{\n        Stream: true,  // Enable streaming output.\n    },\n}\n\n// Handle streaming response.\nresponseChan, err := llm.GenerateContent(ctx, request)\nif err != nil {\n    return err\n}\n\nfor response := range responseChan {\n    if response.Error != nil {\n        fmt.Printf(\"Error: %s\", response.Error.Message)\n        return\n    }\n\n    if len(response.Choices) &gt; 0 &amp;&amp; response.Choices[0].Delta.Content != \"\" {\n        fmt.Print(response.Choices[0].Delta.Content)\n    }\n\n    if response.Done {\n        break\n    }\n}\n</code></pre>"},{"location":"model/#advanced-parameter-configuration","title":"Advanced Parameter Configuration","text":"<pre><code>// Use advanced generation parameters.\ntemperature := 0.3\nmaxTokens := 2000\ntopP := 0.9\npresencePenalty := 0.2\nfrequencyPenalty := 0.5\nreasoningEffort := \"high\"\n\nrequest := &amp;model.Request{\n    Messages: []model.Message{\n        model.NewSystemMessage(\"You are a professional technical documentation writer.\"),\n        model.NewUserMessage(\"Explain the advantages and disadvantages of microservice architecture.\"),\n    },\n    GenerationConfig: model.GenerationConfig{\n        Temperature:      &amp;temperature,\n        MaxTokens:        &amp;maxTokens,\n        TopP:             &amp;topP,\n        PresencePenalty:  &amp;presencePenalty,\n        FrequencyPenalty: &amp;frequencyPenalty,\n        ReasoningEffort:  &amp;reasoningEffort,\n        Stream:           true,\n    },\n}\n</code></pre>"},{"location":"model/#multimodal-content","title":"Multimodal Content","text":"<pre><code>// Read image file.\nimageData, _ := os.ReadFile(\"image.jpg\")\n\n// Create multimodal message.\nrequest := &amp;model.Request{\n    Messages: []model.Message{\n        model.NewSystemMessage(\"You are an image analysis expert.\"),\n        {\n            Role: model.RoleUser,\n            ContentParts: []model.ContentPart{\n                {\n                    Type: model.ContentTypeText,\n                    Text: stringPtr(\"What's in this image?\"),\n                },\n                {\n                    Type: model.ContentTypeImage,\n                    Image: &amp;model.Image{\n                        Data:   imageData,\n                        Format: \"jpeg\",\n                    },\n                },\n            },\n        },\n    },\n}\n</code></pre>"},{"location":"model/#advanced-features","title":"Advanced Features","text":""},{"location":"model/#1-callback-functions","title":"1. Callback Functions","text":"<pre><code>// Set pre-request callback function.\nmodel := openai.New(\"deepseek-chat\",\n    openai.WithChatRequestCallback(func(ctx context.Context, req *openai.ChatCompletionNewParams) {\n        // Called before request is sent.\n        log.Printf(\"Sending request: model=%s, message count=%d\", req.Model, len(req.Messages))\n    }),\n\n    // Set response callback function (non-streaming).\n    openai.WithChatResponseCallback(func(ctx context.Context,\n        req *openai.ChatCompletionNewParams,\n        resp *openai.ChatCompletion) {\n        // Called when complete response is received.\n        log.Printf(\"Received response: ID=%s, tokens used=%d\",\n            resp.ID, resp.Usage.TotalTokens)\n    }),\n\n    // Set streaming response callback function.\n    openai.WithChatChunkCallback(func(ctx context.Context,\n        req *openai.ChatCompletionNewParams,\n        chunk *openai.ChatCompletionChunk) {\n        // Called when each streaming response chunk is received.\n        log.Printf(\"Received streaming chunk: ID=%s\", chunk.ID)\n    }),\n\n    // Set streaming completion callback function.\n    openai.WithChatStreamCompleteCallback(func(ctx context.Context,\n        req *openai.ChatCompletionNewParams,\n        acc *openai.ChatCompletionAccumulator,\n        streamErr error) {\n        // Called when streaming is completely finished (success or error).\n        if streamErr != nil {\n            log.Printf(\"Streaming failed: %v\", streamErr)\n        } else {\n            log.Printf(\"Streaming completed: reason=%s\",\n                acc.Choices[0].FinishReason)\n        }\n    }),\n)\n</code></pre>"},{"location":"model/#2-model-switching","title":"2. Model Switching","text":"<p>Model switching allows dynamically changing the LLM model used by an Agent at runtime. The framework provides two approaches: agent-level switching (affects all subsequent requests) and per-request switching (affects only a single request).</p>"},{"location":"model/#agent-level-switching","title":"Agent-level Switching","text":"<p>Agent-level switching changes the Agent's default model, affecting all subsequent requests.</p>"},{"location":"model/#approach-1-direct-model-instance","title":"Approach 1: Direct Model Instance","text":"<p>Set the model directly by passing a model instance to <code>SetModel</code>:</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/agent/llmagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/openai\"\n)\n\n// Create Agent.\nagent := llmagent.New(\"my-agent\",\n    llmagent.WithModel(openai.New(\"gpt-4o-mini\")),\n)\n\n// Switch to another model.\nagent.SetModel(openai.New(\"gpt-4o\"))\n</code></pre> <p>Use Cases:</p> <pre><code>// Select model based on task complexity.\nif isComplexTask {\n    agent.SetModel(openai.New(\"gpt-4o\"))  // Use powerful model.\n} else {\n    agent.SetModel(openai.New(\"gpt-4o-mini\"))  // Use fast model.\n}\n</code></pre>"},{"location":"model/#approach-2-switch-by-name","title":"Approach 2: Switch by Name","text":"<p>Pre-register multiple models with <code>WithModels</code>, then switch by name using <code>SetModelByName</code>:</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/agent/llmagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/model\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/openai\"\n)\n\n// Create multiple model instances.\ngpt4 := openai.New(\"gpt-4o\")\ngpt4mini := openai.New(\"gpt-4o-mini\")\ndeepseek := openai.New(\"deepseek-chat\")\n\n// Register all models when creating the Agent.\nagent := llmagent.New(\"my-agent\",\n    llmagent.WithModels(map[string]model.Model{\n        \"smart\": gpt4,\n        \"fast\":  gpt4mini,\n        \"cheap\": deepseek,\n    }),\n    llmagent.WithModel(gpt4mini), // Specify initial model.\n    llmagent.WithInstruction(\"You are an intelligent assistant.\"),\n)\n\n// Switch models by name at runtime.\nerr := agent.SetModelByName(\"smart\")\nif err != nil {\n    log.Fatal(err)\n}\n\n// Switch to another model.\nerr = agent.SetModelByName(\"cheap\")\nif err != nil {\n    log.Fatal(err)\n}\n</code></pre> <p>Use Cases:</p> <pre><code>// Select model based on user tier.\nmodelName := \"fast\" // Default to fast model.\nif user.IsPremium() {\n    modelName = \"smart\" // Premium users get advanced model.\n}\nif err := agent.SetModelByName(modelName); err != nil {\n    log.Printf(\"Failed to switch model: %v\", err)\n}\n\n// Select model based on time of day (cost optimization).\nhour := time.Now().Hour()\nif hour &gt;= 22 || hour &lt; 8 {\n    // Use cheap model at night.\n    agent.SetModelByName(\"cheap\")\n} else {\n    // Use fast model during the day.\n    agent.SetModelByName(\"fast\")\n}\n</code></pre>"},{"location":"model/#per-request-switching","title":"Per-request Switching","text":"<p>Per-request switching allows temporarily specifying a model for a single request without affecting the Agent's default model or other requests. This is useful for scenarios where different models are needed for specific tasks.</p>"},{"location":"model/#approach-1-using-withmodel-option","title":"Approach 1: Using WithModel Option","text":"<p>Use <code>agent.WithModel</code> to specify a model instance for a single request:</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/agent\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/openai\"\n)\n\n// Use a specific model for this request only.\neventChan, err := runner.Run(ctx, userID, sessionID, message,\n    agent.WithModel(openai.New(\"gpt-4o\")),\n)\n</code></pre>"},{"location":"model/#approach-2-using-withmodelname-option-recommended","title":"Approach 2: Using WithModelName Option (Recommended)","text":"<p>Use <code>agent.WithModelName</code> to specify a pre-registered model name for a single request:</p> <pre><code>// Pre-register multiple models when creating the Agent.\nagent := llmagent.New(\"my-agent\",\n    llmagent.WithModels(map[string]model.Model{\n        \"smart\": openai.New(\"gpt-4o\"),\n        \"fast\":  openai.New(\"gpt-4o-mini\"),\n        \"cheap\": openai.New(\"deepseek-chat\"),\n    }),\n    llmagent.WithModel(openai.New(\"gpt-4o-mini\")), // Default model.\n)\n\nrunner := runner.NewRunner(\"app\", agent)\n\n// Temporarily use \"smart\" model for this request only.\neventChan, err := runner.Run(ctx, userID, sessionID, message,\n    agent.WithModelName(\"smart\"),\n)\n\n// Next request still uses the default model \"gpt-4o-mini\".\neventChan2, err := runner.Run(ctx, userID, sessionID, message2)\n</code></pre> <p>Use Cases:</p> <pre><code>// Dynamically select model based on message complexity.\nvar opts []agent.RunOption\nif isComplexQuery(message) {\n    opts = append(opts, agent.WithModelName(\"smart\")) // Use powerful model for complex queries.\n}\n\neventChan, err := runner.Run(ctx, userID, sessionID, message, opts...)\n\n// Use specialized reasoning model for reasoning tasks.\neventChan, err := runner.Run(ctx, userID, sessionID, reasoningMessage,\n    agent.WithModelName(\"deepseek-reasoner\"),\n)\n</code></pre>"},{"location":"model/#configuration-details","title":"Configuration Details","text":"<p>WithModels Option:</p> <ul> <li>Accepts a <code>map[string]model.Model</code> where key is the model name and value is the model instance</li> <li>If both <code>WithModel</code> and <code>WithModels</code> are set, <code>WithModel</code> specifies the initial model</li> <li>If only <code>WithModels</code> is set, the first model in the map will be used as the initial model (note: map iteration order is not guaranteed, so it's recommended to explicitly specify the initial model)</li> <li>Reserved name: <code>__default__</code> is used internally by the framework and should not be used</li> </ul> <p>SetModelByName Method:</p> <ul> <li>Parameter: model name (string)</li> <li>Returns: error if the model name is not found</li> <li>The model must be pre-registered via <code>WithModels</code></li> </ul> <p>Per-request Options:</p> <ul> <li><code>agent.RunOptions.Model</code>: Directly specify a model instance</li> <li><code>agent.RunOptions.ModelName</code>: Specify a pre-registered model name</li> <li>Priority: <code>Model</code> &gt; <code>ModelName</code> &gt; Agent default model</li> <li>If the model specified by <code>ModelName</code> is not found, it falls back to the Agent's default model</li> </ul>"},{"location":"model/#agent-level-vs-per-request-comparison","title":"Agent-level vs Per-request Comparison","text":"Feature Agent-level Switching Per-request Switching Scope All subsequent requests Current request only Usage <code>SetModel</code>/<code>SetModelByName</code> <code>RunOptions.Model</code>/<code>ModelName</code> State Change Changes Agent default model Does not change Agent state Use Case Global strategy adjustment Specific task temporary needs Concurrency Affects all concurrent reqs Does not affect other requests Typical Examples User tier, time-based policy Complex queries, reasoning"},{"location":"model/#agent-level-approach-comparison","title":"Agent-level Approach Comparison","text":"Feature SetModel SetModelByName Usage Pass model instance Pass model name Pre-registration Not required Required via WithModels Error Handling None Returns error Use Case Simple switching Complex scenarios, multi-model management Code Maintenance Need to hold model instances Only need to remember names"},{"location":"model/#important-notes","title":"Important Notes","text":"<p>Agent-level Switching:</p> <ul> <li>Immediate Effect: After calling <code>SetModel</code> or <code>SetModelByName</code>, the next request immediately uses the new model</li> <li>Session Persistence: Switching models does not clear session history</li> <li>Independent Configuration: Each model retains its own configuration (temperature, max tokens, etc.)</li> <li>Concurrency Safe: Both switching approaches are concurrency-safe</li> </ul> <p>Per-request Switching:</p> <ul> <li>Temporary Override: Only affects the current request, does not change the Agent's default model</li> <li>Higher Priority: Per-request model settings take precedence over the Agent's default model</li> <li>No Side Effects: Does not affect other concurrent requests or subsequent requests</li> <li>Flexible Combination: Can be used in combination with agent-level switching</li> </ul>"},{"location":"model/#usage-example","title":"Usage Example","text":"<p>For a complete interactive example, see examples/model/switch, which demonstrates both agent-level and per-request switching approaches.</p>"},{"location":"model/#3-batch-processing-batch-api","title":"3. Batch Processing (Batch API)","text":"<p>Batch API is an asynchronous batch processing technique for efficiently handling large volumes of requests. This feature is particularly suitable for scenarios requiring large-scale data processing, significantly reducing costs and improving processing efficiency.</p>"},{"location":"model/#core-features","title":"Core Features","text":"<ul> <li>Asynchronous Processing: Batch requests are processed asynchronously without waiting for immediate responses</li> <li>Cost Optimization: Typically more cost-effective than individual requests</li> <li>Flexible Input: Supports both inline requests and file-based input</li> <li>Complete Management: Provides full operations including create, retrieve, cancel, and list</li> <li>Result Parsing: Automatically downloads and parses batch processing results</li> </ul>"},{"location":"model/#quick-start_2","title":"Quick Start","text":"<p>Creating a Batch Job:</p> <pre><code>import (\n    openaisdk \"github.com/openai/openai-go\"\n    \"trpc.group/trpc-go/trpc-agent-go/model\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/openai\"\n)\n\n// Create model instance.\nllm := openai.New(\"gpt-4o-mini\")\n\n// Prepare batch requests.\nrequests := []*openai.BatchRequestInput{\n    {\n        CustomID: \"request-1\",\n        Method:   \"POST\",\n        URL:      string(openaisdk.BatchNewParamsEndpointV1ChatCompletions),\n        Body: openai.BatchRequest{\n            Messages: []model.Message{\n                model.NewSystemMessage(\"You are a helpful assistant.\"),\n                model.NewUserMessage(\"Hello\"),\n            },\n        },\n    },\n    {\n        CustomID: \"request-2\",\n        Method:   \"POST\",\n        URL:      string(openaisdk.BatchNewParamsEndpointV1ChatCompletions),\n        Body: openai.BatchRequest{\n            Messages: []model.Message{\n                model.NewSystemMessage(\"You are a helpful assistant.\"),\n                model.NewUserMessage(\"Introduce Go language\"),\n            },\n        },\n    },\n}\n\n// Create batch job.\nbatch, err := llm.CreateBatch(ctx, requests,\n    openai.WithBatchCreateCompletionWindow(\"24h\"),\n)\nif err != nil {\n    log.Fatal(err)\n}\n\nfmt.Printf(\"Batch job created: %s\\n\", batch.ID)\n</code></pre>"},{"location":"model/#batch-operations","title":"Batch Operations","text":"<p>Retrieving Batch Status:</p> <pre><code>// Get batch details.\nbatch, err := llm.RetrieveBatch(ctx, batchID)\nif err != nil {\n    log.Fatal(err)\n}\n\nfmt.Printf(\"Status: %s\\n\", batch.Status)\nfmt.Printf(\"Total requests: %d\\n\", batch.RequestCounts.Total)\nfmt.Printf(\"Completed: %d\\n\", batch.RequestCounts.Completed)\nfmt.Printf(\"Failed: %d\\n\", batch.RequestCounts.Failed)\n</code></pre> <p>Downloading and Parsing Results:</p> <pre><code>// Download output file.\nif batch.OutputFileID != \"\" {\n    text, err := llm.DownloadFileContent(ctx, batch.OutputFileID)\n    if err != nil {\n        log.Fatal(err)\n    }\n\n    // Parse batch output.\n    entries, err := llm.ParseBatchOutput(text)\n    if err != nil {\n        log.Fatal(err)\n    }\n\n    // Process each result.\n    for _, entry := range entries {\n        fmt.Printf(\"[%s] Status code: %d\\n\", entry.CustomID, entry.Response.StatusCode)\n        if len(entry.Response.Body.Choices) &gt; 0 {\n            content := entry.Response.Body.Choices[0].Message.Content\n            fmt.Printf(\"Content: %s\\n\", content)\n        }\n        if entry.Error != nil {\n            fmt.Printf(\"Error: %s\\n\", entry.Error.Message)\n        }\n    }\n}\n</code></pre> <p>Canceling a Batch Job:</p> <pre><code>// Cancel an in-progress batch.\nbatch, err := llm.CancelBatch(ctx, batchID)\nif err != nil {\n    log.Fatal(err)\n}\n\nfmt.Printf(\"Batch job canceled: %s\\n\", batch.ID)\n</code></pre> <p>Listing Batch Jobs:</p> <pre><code>// List batch jobs (with pagination support).\npage, err := llm.ListBatches(ctx, \"\", 10)\nif err != nil {\n    log.Fatal(err)\n}\n\nfor _, batch := range page.Data {\n    fmt.Printf(\"ID: %s, Status: %s\\n\", batch.ID, batch.Status)\n}\n</code></pre>"},{"location":"model/#configuration-options","title":"Configuration Options","text":"<p>Global Configuration:</p> <pre><code>// Configure batch default parameters when creating model.\nllm := openai.New(\"gpt-4o-mini\",\n    openai.WithBatchCompletionWindow(\"24h\"),\n    openai.WithBatchMetadata(map[string]string{\n        \"project\": \"my-project\",\n        \"env\":     \"production\",\n    }),\n    openai.WithBatchBaseURL(\"https://custom-batch-api.com\"),\n)\n</code></pre> <p>Request-level Configuration:</p> <pre><code>// Override default configuration when creating batch.\nbatch, err := llm.CreateBatch(ctx, requests,\n    openai.WithBatchCreateCompletionWindow(\"48h\"),\n    openai.WithBatchCreateMetadata(map[string]string{\n        \"priority\": \"high\",\n    }),\n)\n</code></pre>"},{"location":"model/#how-it-works","title":"How It Works","text":"<p>Batch API execution flow:</p> <pre><code>1. Prepare batch requests (BatchRequestInput list)\n2. Validate request format and CustomID uniqueness\n3. Generate JSONL format input file\n4. Upload input file to server\n5. Create batch job\n6. Process requests asynchronously\n7. Download output file and parse results\n</code></pre> <p>Key design:</p> <ul> <li>CustomID Uniqueness: Each request must have a unique CustomID for matching input/output</li> <li>JSONL Format: Batch processing uses JSONL (JSON Lines) format for storing requests and responses</li> <li>Asynchronous Processing: Batch jobs execute asynchronously in the background without blocking main flow</li> <li>Completion Window: Configurable completion time window for batch processing (e.g., 24h)</li> </ul>"},{"location":"model/#use-cases","title":"Use Cases","text":"<ul> <li>Large-scale Data Processing: Processing thousands or tens of thousands of requests</li> <li>Offline Analysis: Non-real-time data analysis and processing tasks</li> <li>Cost Optimization: Batch processing is typically more economical than individual requests</li> <li>Scheduled Tasks: Regularly executed batch processing jobs</li> </ul>"},{"location":"model/#usage-example_1","title":"Usage Example","text":"<p>For a complete interactive example, see examples/model/batch.</p>"},{"location":"model/#4-retry-mechanism","title":"4. Retry Mechanism","text":"<p>The retry mechanism is an automatic error recovery technique that automatically retries failed requests. This feature is provided by the underlying OpenAI SDK, with the framework passing retry parameters to the SDK through configuration options.</p>"},{"location":"model/#core-features_1","title":"Core Features","text":"<ul> <li>Automatic Retry: SDK automatically handles retryable errors</li> <li>Smart Backoff: Follows API's <code>Retry-After</code> headers or uses exponential backoff</li> <li>Configurable: Supports custom maximum retry count and timeout duration</li> <li>Zero Maintenance: No custom retry logic needed, handled by mature SDK</li> </ul>"},{"location":"model/#quick-start_3","title":"Quick Start","text":"<p>Basic Configuration:</p> <pre><code>import (\n    \"time\"\n    openaiopt \"github.com/openai/openai-go/option\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/openai\"\n)\n\n// Create model instance with retry configuration.\nllm := openai.New(\"gpt-4o-mini\",\n    openai.WithOpenAIOptions(\n        openaiopt.WithMaxRetries(3),\n        openaiopt.WithRequestTimeout(30*time.Second),\n    ),\n)\n</code></pre>"},{"location":"model/#retryable-errors","title":"Retryable Errors","text":"<p>The OpenAI SDK automatically retries the following errors:</p> <ul> <li>408 Request Timeout: Request timeout</li> <li>409 Conflict: Conflict error</li> <li>429 Too Many Requests: Rate limiting</li> <li>500+ Server Errors: Internal server errors (5xx)</li> <li>Network Connection Errors: No response or connection failure</li> </ul> <p>Note: SDK default maximum retry count is 2.</p>"},{"location":"model/#retry-strategies","title":"Retry Strategies","text":"<p>Standard Retry:</p> <pre><code>// Standard configuration suitable for most scenarios.\nllm := openai.New(\"gpt-4o-mini\",\n    openai.WithOpenAIOptions(\n        openaiopt.WithMaxRetries(3),\n        openaiopt.WithRequestTimeout(30*time.Second),\n    ),\n)\n</code></pre> <p>Rate Limiting Optimization:</p> <pre><code>// Optimized configuration for rate limiting scenarios.\nllm := openai.New(\"gpt-4o-mini\",\n    openai.WithOpenAIOptions(\n        openaiopt.WithMaxRetries(5),  // More retry attempts.\n        openaiopt.WithRequestTimeout(60*time.Second),  // Longer timeout.\n    ),\n)\n</code></pre> <p>Fast Fail:</p> <pre><code>// For scenarios requiring quick failure.\nllm := openai.New(\"gpt-4o-mini\",\n    openai.WithOpenAIOptions(\n        openaiopt.WithMaxRetries(1),  // Minimal retries.\n        openaiopt.WithRequestTimeout(10*time.Second),  // Short timeout.\n    ),\n)\n</code></pre>"},{"location":"model/#how-it-works_1","title":"How It Works","text":"<p>Retry mechanism execution flow:</p> <pre><code>1. Send request to LLM API\n2. If request fails and error is retryable:\n   a. Check if maximum retry count is reached\n   b. Calculate wait time based on Retry-After header or exponential backoff\n   c. Wait and resend request\n3. If request succeeds or error is not retryable, return result\n</code></pre> <p>Key design:</p> <ul> <li>SDK-level Implementation: Retry logic is completely handled by OpenAI SDK</li> <li>Configuration Pass-through: Framework passes configuration via <code>WithOpenAIOptions</code></li> <li>Smart Backoff: Prioritizes using <code>Retry-After</code> header returned by API</li> <li>Transparent Handling: Transparent to application layer, no additional code needed</li> </ul>"},{"location":"model/#use-cases_1","title":"Use Cases","text":"<ul> <li>Production Environment: Improve service reliability and fault tolerance</li> <li>Rate Limiting: Automatically handle 429 errors</li> <li>Network Instability: Handle temporary network failures</li> <li>Server Errors: Handle temporary server-side issues</li> </ul>"},{"location":"model/#important-notes_1","title":"Important Notes","text":"<ul> <li>No Framework Retry: Framework itself does not implement retry logic</li> <li>Client-level Retry: All retry is handled by OpenAI client</li> <li>Configuration Pass-through: Use <code>WithOpenAIOptions</code> to configure retry behavior</li> <li>Automatic Handling: Rate limiting (429) is automatically handled without additional code</li> </ul>"},{"location":"model/#usage-example_2","title":"Usage Example","text":"<p>For a complete interactive example, see examples/model/retry.</p>"},{"location":"model/#5-custom-http-headers","title":"5. Custom HTTP Headers","text":"<p>In some enterprise or proxy scenarios, the model provider requires additional HTTP headers (for example, organization ID, tenant routing, or custom authentication). The Model module supports setting headers in three reliable ways that apply to all model requests, including non-streaming, streaming, file upload, and batch APIs.</p> <p>Recommended order:</p> <ul> <li>Global header via <code>openai.WithHeaders</code> (simplest for static headers)</li> <li>Global header via OpenAI RequestOption (flexible, middleware-friendly)</li> <li>Custom <code>http.RoundTripper</code> (advanced, cross-cutting)</li> </ul> <p>All methods affect streaming too because the same client is used for <code>New</code> and <code>NewStreaming</code> calls.</p>"},{"location":"model/#1-using-openaiwithheaders-for-headers","title":"1. Using openai.WithHeaders for headers","text":"<pre><code>import \"trpc.group/trpc-go/trpc-agent-go/model/openai\"\n\nllm := openai.New(\"deepseek-chat\",\n    openai.WithHeaders(map[string]string{\n        \"X-Custom-Header\": \"custom-value\",\n        \"X-Request-ID\":    \"req-123\",\n    }),\n)\n</code></pre>"},{"location":"model/#2-global-headers-using-openai-requestoption","title":"2. Global headers using OpenAI RequestOption","text":"<p>Use <code>WithOpenAIOptions</code> with <code>openaiopt.WithHeader</code> or <code>openaiopt.WithMiddleware</code> to inject headers for every request created by the underlying OpenAI client.</p> <pre><code>import (\n    openaiopt \"github.com/openai/openai-go/option\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/openai\"\n)\n\nllm := openai.New(\"deepseek-chat\",\n    // If your provider needs extra headers\n    openai.WithOpenAIOptions(\n        openaiopt.WithHeader(\"X-Custom-Header\", \"custom-value\"),\n        openaiopt.WithHeader(\"X-Request-ID\", \"req-123\"),\n        // You can also set User-Agent or vendor-specific headers\n        openaiopt.WithHeader(\"User-Agent\", \"trpc-agent-go/1.0\"),\n    ),\n)\n</code></pre> <p>For complex logic, middleware lets you modify headers conditionally (for example, by URL path or context values):</p> <pre><code>llm := openai.New(\"deepseek-chat\",\n    openai.WithOpenAIOptions(\n        openaiopt.WithMiddleware(\n            func(r *http.Request, next openaiopt.MiddlewareNext) (*http.Response, error) {\n                // Example: per-request header via context value\n                if v := r.Context().Value(\"x-request-id\"); v != nil {\n                    if s, ok := v.(string); ok &amp;&amp; s != \"\" {\n                        r.Header.Set(\"X-Request-ID\", s)\n                    }\n                }\n                // Or only for chat completion endpoint\n                if strings.Contains(r.URL.Path, \"/chat/completions\") {\n                    r.Header.Set(\"X-Feature-Flag\", \"on\")\n                }\n                return next(r)\n            },\n        ),\n    ),\n)\n</code></pre> <p>Notes for authentication variants:</p> <ul> <li>OpenAI style: keep <code>openai.WithAPIKey(\"sk-...\")</code> which sets   <code>Authorization: Bearer ...</code> under the hood.</li> <li>Azure/OpenAI\u2011compatible that use <code>api-key</code>: omit <code>WithAPIKey</code> and set   <code>openaiopt.WithHeader(\"api-key\", \"&lt;key&gt;\")</code> instead.</li> </ul>"},{"location":"model/#3-custom-httproundtripper-advanced","title":"3. Custom http.RoundTripper (advanced)","text":"<p>Inject headers across all requests at the HTTP layer by wrapping the transport. This is useful when you also need custom proxy, TLS, or metrics logic.</p> <pre><code>type headerRoundTripper struct{ base http.RoundTripper }\n\nfunc (rt headerRoundTripper) RoundTrip(req *http.Request) (*http.Response, error) {\n    // Add or override headers\n    req.Header.Set(\"X-Custom-Header\", \"custom-value\")\n    req.Header.Set(\"X-Trace-ID\", \"trace-xyz\")\n    return rt.base.RoundTrip(req)\n}\n\nllm := openai.New(\"deepseek-chat\",\n    openai.WithHTTPClientOptions(\n        openai.WithHTTPClientTransport(headerRoundTripper{base: http.DefaultTransport}),\n    ),\n)\n</code></pre> <p>Per-request headers</p> <ul> <li>Agent/Runner passes <code>ctx</code> through to the model call; middleware can   read values from <code>req.Context()</code> to inject per-invocation headers.</li> <li>Chat completion per-request base URL override is not exposed; create a   second model with a different base URL or alter <code>r.URL</code> in middleware.</li> </ul>"},{"location":"model/#6-token-tailoring","title":"6. Token Tailoring","text":"<p>Token Tailoring is an intelligent message management technique designed to automatically trim messages when they exceed the model's context window limits, ensuring requests can be successfully sent to the LLM API. This feature is particularly useful for long conversation scenarios, allowing you to keep the message list within the model's token limits while preserving key context.</p> <p>Automatic Mode (Recommended):</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/model/openai\"\n)\n\n// Enable token tailoring with automatic configuration\nmodel := openai.New(\"deepseek-chat\",\n    openai.WithEnableTokenTailoring(true),\n)\n</code></pre> <p>Advanced Mode:</p> <pre><code>// Custom token limit and strategy\nmodel := openai.New(\"deepseek-chat\",\n    openai.WithEnableTokenTailoring(true),               // Required: enable token tailoring\n    openai.WithMaxInputTokens(10000),                    // Custom token limit\n    openai.WithTokenCounter(customCounter),              // Optional: custom counter\n    openai.WithTailoringStrategy(customStrategy),        // Optional: custom strategy\n)\n</code></pre> <p>Token Calculation Formula:</p> <p>The framework automatically calculates \"maxInputTokens\" based on the model's context window:</p> <pre><code>safetyMargin = contextWindow \u00d7 10%\ncalculatedMax = contextWindow - 2048 (output reserve) - 512 (protocol overhead) - safetyMargin\nratioLimit = contextWindow \u00d7 100% (max input ratio)\nmaxInputTokens = max(min(calculatedMax, ratioLimit), 1024 (minimum))\n</code></pre> <p>For example, \"gpt-4o\" (contextWindow = 128000):</p> <pre><code>safetyMargin = 128000 \u00d7 0.10 = 12800 tokens\ncalculatedMax = 128000 - 2048 - 512 - 12800 = 112640 tokens\nratioLimit = 128000 \u00d7 1.0 = 128000 tokens\nmaxInputTokens = 112640 tokens (approximately 88% of context window)\n</code></pre> <p>Default Budget Parameters:</p> <p>The framework uses the following default values for token allocation (it is recommended to keep the defaults):</p> <ul> <li>Protocol Overhead (ProtocolOverheadTokens): 512 tokens - reserved for request/response formatting</li> <li>Output Reserve (ReserveOutputTokens): 2048 tokens - reserved for output generation</li> <li>Input Floor (InputTokensFloor): 1024 tokens - ensures proper model processing</li> <li>Output Floor (OutputTokensFloor): 256 tokens - ensures meaningful responses</li> <li>Safety Margin Ratio (SafetyMarginRatio): 10% - buffer for token counting inaccuracies</li> <li>Max Input Ratio (MaxInputTokensRatio): 100% - maximum input ratio of context window</li> </ul> <p>Tailoring Strategy:</p> <p>The framework provides a default tailoring strategy that preserves messages according to the following priorities:</p> <ol> <li>System Messages: Highest priority, always preserved</li> <li>Latest User Message: Ensures the current conversation turn is complete</li> <li>Tool Call Related Messages: Maintains tool call context integrity</li> <li>Historical Messages: Retains as much conversation history as possible based on remaining space</li> </ol> <p>Custom Tailoring Strategy:</p> <p>You can implement the <code>TailoringStrategy</code> interface to customize the trimming logic:</p> <pre><code>type CustomStrategy struct{}\n\nfunc (s *CustomStrategy) Tailor(\n    ctx context.Context,\n    messages []model.Message,\n    maxTokens int,\n    counter tokencounter.Counter,\n) ([]model.Message, error) {\n    // Implement custom tailoring logic\n    // e.g., keep only the most recent N conversation rounds\n    return messages, nil\n}\n\nmodel := openai.New(\"deepseek-chat\",\n    openai.WithEnableTokenTailoring(true),\n    openai.WithTailoringStrategy(&amp;CustomStrategy{}),\n)\n</code></pre> <p>Advanced Configuration (Custom Budget Parameters):</p> <p>If the default token allocation strategy does not meet your needs, you can customize the budget parameters using <code>WithTokenTailoringConfig</code>. Note: It is recommended to keep the default values unless you have specific requirements.</p> <pre><code>model := openai.New(\"deepseek-chat\",\n    openai.WithEnableTokenTailoring(true),\n    openai.WithTokenTailoringConfig(&amp;model.TokenTailoringConfig{\n        ProtocolOverheadTokens: 1024,   // Custom protocol overhead\n        ReserveOutputTokens:    4096,   // Custom output reserve\n        InputTokensFloor:       2048,   // Custom input floor\n        OutputTokensFloor:      512,    // Custom output floor\n        SafetyMarginRatio:      0.15,   // Custom safety margin (15%)\n        MaxInputTokensRatio:    0.90,   // Custom max input ratio (90%)\n    }),\n)\n</code></pre> <p>For Anthropic models, you can use the same configuration:</p> <pre><code>model := anthropic.New(\"claude-sonnet-4-0\",\n    anthropic.WithEnableTokenTailoring(true),\n    anthropic.WithTokenTailoringConfig(&amp;model.TokenTailoringConfig{\n        SafetyMarginRatio: 0.15,  // Increase safety margin to 15%\n    }),\n)\n</code></pre>"},{"location":"model/#7-variant-optimization-adapting-to-platform-specific-behaviors","title":"7. Variant Optimization: Adapting to Platform-Specific Behaviors","text":"<p>The Variant mechanism is an important optimization in the Model module, used to handle platform-specific behavioral differences across OpenAI-compatible providers. By specifying different Variants, the framework can automatically adapt to API differences between platforms, especially for file upload, deletion, and processing logic.</p>"},{"location":"model/#71-supported-variant-types","title":"7.1. Supported Variant Types","text":"<p>The framework currently supports the following Variants:</p> <p>1. VariantOpenAI\uff08default\uff09</p> <ul> <li>Standard OpenAI API-compatible behavior</li> <li>File upload path\uff1a<code>/openapi/v1/files</code></li> <li>File purpose:<code>user_data</code></li> <li>File deletion Http method:\uff1a<code>DELETE</code></li> </ul> <p>2. VariantHunyuan\uff08hunyuan\uff09</p> <ul> <li>Tencent Hunyuan platform-specific adaptation</li> <li>File upload path:\uff1a<code>/openapi/v1/files/uploads</code></li> <li>File purpose\uff1a<code>file-extract</code></li> <li>File deletion Http Method\uff1a<code>POST</code></li> </ul> <p>3. VariantDeepSeek</p> <ul> <li>DeepSeek platform adaptation</li> <li>Default BaseURL\uff1a<code>https://api.deepseek.com</code></li> <li>API Key environment variable name\uff1a<code>DEEPSEEK_API_KEY</code></li> <li>Other behaviors are consistent with standard OpenAI</li> </ul> <p>4. VariantQwen\uff08Qwen\uff09</p> <ul> <li>Qwen platform adaptation</li> <li>Default BaseURL\uff1a<code>https://dashscope.aliyuncs.com/compatible-mode/v1</code></li> <li>API Key environment variable name\uff1a<code>DASHSCOPE_API_KEY</code></li> <li>Other behaviors are consistent with standard OpenAI</li> </ul>"},{"location":"model/#72-usage","title":"7.2. Usage","text":"<p>Usage Example\uff1a</p> <pre><code>import \"trpc.group/trpc-go/trpc-agent-go/model/openai\"\n\n// Use the Hunyuan platform\nmodel := openai.New(\"hunyuan-model\",\n    openai.WithBaseURL(\"https://your-hunyuan-api.com\"),\n    openai.WithAPIKey(\"your-api-key\"),\n    openai.WithVariant(openai.VariantHunyuan), // Specify the Hunyuan variant\n)\n\n// Use the DeepSeek platform\nmodel := openai.New(\"deepseek-chat\",\n    openai.WithBaseURL(\"https://api.deepseek.com/v1\"),\n    openai.WithAPIKey(\"your-api-key\"),\n    openai.WithVariant(openai.VariantDeepSeek), // Specify the DeepSeek variant\n)\n</code></pre>"},{"location":"model/#73-behavioral-differences-of-variants-examples","title":"7.3. Behavioral Differences of Variants Examples","text":"<p>Message content handling differences\uff1a</p> <pre><code>import \"trpc.group/trpc-go/trpc-agent-go/model\"\n\n// For the Hunyuan platform, the file ID is placed in extraFields instead of content parts\nmessage := model.Message{\n    Role: model.RoleUser,\n    ContentParts: []model.ContentPart{\n        {\n            Type: model.ContentTypeFile,\n            File: &amp;model.File{\n                FileID: \"file_123\",\n            },\n        },\n    },\n}\n</code></pre> <p>Environment variable auto-configuration</p> <p>For certain Variants, the framework supports reading configuration from environment variables automatically:</p> <pre><code># DeepSeek\nexport DEEPSEEK_API_KEY=\"your-api-key\"\n# No need to call WithAPIKey explicitly; the framework reads it automatically\n</code></pre> <pre><code>import \"trpc.group/trpc-go/trpc-agent-go/model\"\n\n// DeepSeek\nmodel := openai.New(\"deepseek-chat\",\n    openai.WithVariant(openai.VariantDeepSeek), // Automatically reads DEEPSEEK_API_KEY\n)\n</code></pre>"},{"location":"model/#8-streaming-tool-call-deltas-showtoolcalldelta","title":"8. Streaming Tool Call Deltas: ShowToolCallDelta","text":"<p>By default, the OpenAI adapter suppresses raw <code>tool_calls</code> chunks in streaming responses. Tool calls are accumulated internally and only exposed once in the final aggregated response via <code>Response.Choices[0].Message.ToolCalls</code>. This keeps the stream clean for typical chat UIs that only render assistant text.</p> <p>For advanced use cases (for example, when the model streams document content inside tool arguments and you need to display it incrementally), you can turn on raw tool call deltas with <code>WithShowToolCallDelta</code>:</p> <pre><code>llm := openai.New(\n    \"gpt-4.1\",\n    openai.WithShowToolCallDelta(true), // Forward tool_call deltas.\n)\n</code></pre> <p>When <code>WithShowToolCallDelta(true)</code> is enabled:</p> <ul> <li>Streaming chunks that contain <code>tool_calls</code> are no longer suppressed by the   adapter.</li> <li>Each chunk is converted into a partial <code>model.Response</code> where:<ul> <li><code>Response.IsPartial == true</code></li> <li><code>Response.Choices[0].Delta.ToolCalls</code> contains the provider\u2019s raw   <code>tool_calls</code> delta mapped to <code>model.ToolCall</code>:<ul> <li><code>Type</code> comes from the provider <code>type</code> field (for example, <code>\"function\"</code>).</li> <li><code>Function.Name</code> and <code>Function.Arguments</code> mirror the original tool name   and JSON-encoded arguments string.</li> <li><code>ID</code> and <code>Index</code> preserve the tool call identity so callers can stitch   fragments together.</li> </ul> </li> </ul> </li> <li>The final aggregated response still exposes the merged tool calls in   <code>Response.Choices[0].Message.ToolCalls</code>, so existing tool execution logic   (for example, <code>FunctionCallResponseProcessor</code>) continues to work unchanged.</li> </ul> <p>Typical integration pattern when this flag is enabled:</p> <ol> <li>Read <code>Response.Choices[0].Delta.ToolCalls[*].Function.Arguments</code> on each    partial response.</li> <li>Group chunks by tool call <code>ID</code> and append the <code>Arguments</code> fragments in    order.</li> <li>Once the accumulated string forms valid JSON, unmarshal it into your    business struct (for example, <code>{ \"content\": \"...\" }</code>) and use it for    progressive UI rendering.</li> </ol> <p>If you do not need to inspect tool arguments during streaming, keep <code>WithShowToolCallDelta</code> disabled to avoid handling partial JSON fragments and to preserve the default clean text-streaming behavior.</p>"},{"location":"model/#anthropic-model","title":"Anthropic Model","text":"<p>Anthropic Model is used to interface with Claude models and compatible platforms, supporting streaming output, thought modes and tool calls, and providing a rich callback mechanism, while also allowing for flexible configuration of custom HTTP headers.</p>"},{"location":"model/#configuration-method_1","title":"Configuration Method","text":""},{"location":"model/#environment-variable-method_1","title":"Environment Variable Method","text":"<pre><code>export ANTHROPIC_API_KEY=\"your-api-key\"\nexport ANTHROPIC_BASE_URL=\"https://api.anthropic.com\" # Optional configuration, default is this BASE URL\n</code></pre>"},{"location":"model/#code-method_1","title":"Code Method","text":"<pre><code>import \"trpc.group/trpc-go/trpc-agent-go/model/anthropic\"\n\nm := anthropic.New(\n    \"claude-sonnet-4-0\",\n    anthropic.WithAPIKey(\"your-api-key\"),\n    anthropic.WithBaseURL(\"https://api.anthropic.com\"), // Optional configuration, default is this BASE URL\n)\n</code></pre>"},{"location":"model/#using-the-model-directly","title":"Using the Model Directly","text":"<pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/model\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/anthropic\"\n)\n\nfunc main() {\n    // Create model instance\n    llm := anthropic.New(\"claude-sonnet-4-0\")\n    // Build request\n    temperature := 0.7\n    maxTokens := 1000\n    request := &amp;model.Request{\n        Messages: []model.Message{\n            model.NewSystemMessage(\"You are a professional AI assistant.\"),\n            model.NewUserMessage(\"Introduce the concurrency features of Go language.\"),\n        },\n        GenerationConfig: model.GenerationConfig{\n            Temperature: &amp;temperature,\n            MaxTokens:   &amp;maxTokens,\n            Stream:      false,\n        },\n    }\n    // Call the model\n    ctx := context.Background()\n    responseChan, err := llm.GenerateContent(ctx, request)\n    if err != nil {\n        fmt.Printf(\"System error: %v\\n\", err)\n        return\n    }\n    // Handle response\n    for response := range responseChan {\n        if response.Error != nil {\n            fmt.Printf(\"API error: %s\\n\", response.Error.Message)\n            return\n        }\n        if len(response.Choices) &gt; 0 {\n            fmt.Printf(\"Reply: %s\\n\", response.Choices[0].Message.Content)\n        }\n        if response.Done {\n            break\n        }\n    }\n}\n</code></pre>"},{"location":"model/#streaming-output_1","title":"Streaming Output","text":"<pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/model\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/anthropic\"\n)\n\nfunc main() {\n    // Create model instance\n    llm := anthropic.New(\"claude-sonnet-4-0\")\n    // Streaming request configuration\n    temperature := 0.7\n    maxTokens := 1000\n    request := &amp;model.Request{\n        Messages: []model.Message{\n            model.NewSystemMessage(\"You are a creative story storyteller.\"),\n            model.NewUserMessage(\"Write a short story about a robot learning to paint.\"),\n        },\n        GenerationConfig: model.GenerationConfig{\n            Temperature: &amp;temperature,\n            MaxTokens:   &amp;maxTokens,\n            Stream:      true,\n        },\n    }\n    // Call the model\n    ctx := context.Background()\n    // Handle streaming response\n    responseChan, err := llm.GenerateContent(ctx, request)\n    if err != nil {\n        fmt.Printf(\"System error: %v\\n\", err)\n        return\n    }\n    for response := range responseChan {\n        if response.Error != nil {\n            fmt.Printf(\"Error: %s\", response.Error.Message)\n            return\n        }\n        if len(response.Choices) &gt; 0 &amp;&amp; response.Choices[0].Delta.Content != \"\" {\n            fmt.Print(response.Choices[0].Delta.Content)\n        }\n        if response.Done {\n            break\n        }\n    }\n}\n</code></pre>"},{"location":"model/#advanced-parameter-configuration_1","title":"Advanced Parameter Configuration","text":"<pre><code>// Using advanced generation parameters\ntemperature := 0.3\nmaxTokens := 2000\ntopP := 0.9\nthinking := true\nthinkingTokens := 2048\n\nrequest := &amp;model.Request{\n    Messages: []model.Message{\n        model.NewSystemMessage(\"You are a professional technical documentation writer.\"),\n        model.NewUserMessage(\"Explain the pros and cons of microservices architecture.\"),\n    },\n    GenerationConfig: model.GenerationConfig{\n        Temperature:     &amp;temperature,\n        MaxTokens:       &amp;maxTokens,\n        TopP:            &amp;topP,\n        ThinkingEnabled: &amp;thinking,\n        ThinkingTokens:  &amp;thinkingTokens,\n        Stream:          true,\n    },\n}\n</code></pre>"},{"location":"model/#advanced-features_1","title":"Advanced features","text":""},{"location":"model/#1-callback-functions_1","title":"1. Callback Functions","text":"<pre><code>import (\n    anthropicsdk \"github.com/anthropics/anthropic-sdk-go\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/anthropic\"\n)\n\nmodel := anthropic.New(\n    \"claude-sonnet-4-0\",\n    anthropic.WithChatRequestCallback(func(ctx context.Context, req *anthropicsdk.MessageNewParams) {\n        // Log the request before sending.\n        log.Printf(\"sending request: model=%s, messages=%d.\", req.Model, len(req.Messages))\n    }),\n    anthropic.WithChatResponseCallback(func(ctx context.Context, req *anthropicsdk.MessageNewParams, resp *anthropicsdk.Message) {\n        // Log details of the non-streaming response.\n        log.Printf(\"received response: id=%s, input_tokens=%d, output_tokens=%d.\", resp.ID, resp.Usage.InputTokens, resp.Usage.OutputTokens)\n    }),\n    anthropic.WithChatChunkCallback(func(ctx context.Context, req *anthropicsdk.MessageNewParams, chunk *anthropicsdk.MessageStreamEventUnion) {\n        // Log the type of the streaming event.\n        log.Printf(\"stream event: %T.\", chunk.AsAny())\n    }),\n    anthropic.WithChatStreamCompleteCallback(func(ctx context.Context, req *anthropicsdk.MessageNewParams, acc *anthropicsdk.Message, streamErr error) {\n        // Log stream completion or error.\n        if streamErr != nil {\n            log.Printf(\"stream failed: %v.\", streamErr)\n            return\n        }\n        log.Printf(\"stream completed: finish_reason=%s, input_tokens=%d, output_tokens=%d.\", acc.StopReason, acc.Usage.InputTokens, acc.Usage.OutputTokens)\n    }),\n)\n</code></pre>"},{"location":"model/#2-model-switching_1","title":"2. Model Switching","text":"<p>Model switching allows dynamically changing the LLM model used by an Agent at runtime. The framework provides two approaches: agent-level switching (affects all subsequent requests) and per-request switching (affects only a single request).</p>"},{"location":"model/#agent-level-switching_1","title":"Agent-level Switching","text":"<p>Agent-level switching changes the Agent's default model, affecting all subsequent requests.</p>"},{"location":"model/#approach-1-direct-model-instance_1","title":"Approach 1: Direct Model Instance","text":"<p>Set the model directly by passing a model instance to <code>SetModel</code>:</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/agent/llmagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/anthropic\"\n)\n\n// Create Agent.\nagent := llmagent.New(\"my-agent\",\n    llmagent.WithModel(anthropic.New(\"claude-3-5-haiku-20241022\")),\n)\n\n// Switch to another model.\nagent.SetModel(anthropic.New(\"claude-3-5-sonnet-20241022\"))\n</code></pre> <p>Use Cases:</p> <pre><code>// Select model based on task complexity.\nif isComplexTask {\n    agent.SetModel(anthropic.New(\"claude-3-5-sonnet-20241022\"))  // Use powerful model.\n} else {\n    agent.SetModel(anthropic.New(\"claude-3-5-haiku-20241022\"))  // Use fast model.\n}\n</code></pre>"},{"location":"model/#approach-2-switch-by-name_1","title":"Approach 2: Switch by Name","text":"<p>Pre-register multiple models with <code>WithModels</code>, then switch by name using <code>SetModelByName</code>:</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/agent/llmagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/model\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/anthropic\"\n)\n\n// Create multiple model instances.\nsonnet := anthropic.New(\"claude-3-5-sonnet-20241022\")\nhaiku := anthropic.New(\"claude-3-5-haiku-20241022\")\n\n// Register all models when creating the Agent.\nagent := llmagent.New(\"my-agent\",\n    llmagent.WithModels(map[string]model.Model{\n        \"smart\": sonnet,\n        \"fast\":  haiku,\n    }),\n    llmagent.WithModel(haiku), // Specify initial model.\n    llmagent.WithInstruction(\"You are an intelligent assistant.\"),\n)\n\n// Switch models by name at runtime.\nerr := agent.SetModelByName(\"smart\")\nif err != nil {\n    log.Fatal(err)\n}\n\n// Switch to another model.\nerr = agent.SetModelByName(\"fast\")\nif err != nil {\n    log.Fatal(err)\n}\n</code></pre> <p>Use Cases:</p> <pre><code>// Select model based on user tier.\nmodelName := \"fast\" // Default to fast model.\nif user.IsPremium() {\n    modelName = \"smart\" // Premium users get advanced model.\n}\nif err := agent.SetModelByName(modelName); err != nil {\n    log.Printf(\"Failed to switch model: %v\", err)\n}\n\n// Select model based on time of day (cost optimization).\nhour := time.Now().Hour()\nif hour &gt;= 22 || hour &lt; 8 {\n    // Use fast model at night.\n    agent.SetModelByName(\"fast\")\n} else {\n    // Use smart model during the day.\n    agent.SetModelByName(\"smart\")\n}\n</code></pre>"},{"location":"model/#per-request-switching_1","title":"Per-request Switching","text":"<p>Per-request switching allows temporarily specifying a model for a single request without affecting the Agent's default model or other requests. This is useful for scenarios where different models are needed for specific tasks.</p>"},{"location":"model/#approach-1-using-withmodel-option_1","title":"Approach 1: Using WithModel Option","text":"<p>Use <code>agent.WithModel</code> to specify a model instance for a single request:</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/agent\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/anthropic\"\n)\n\n// Use a specific model for this request only.\neventChan, err := runner.Run(ctx, userID, sessionID, message,\n    agent.WithModel(anthropic.New(\"claude-3-5-sonnet-20241022\")),\n)\n</code></pre>"},{"location":"model/#approach-2-using-withmodelname-option-recommended_1","title":"Approach 2: Using WithModelName Option (Recommended)","text":"<p>Use <code>agent.WithModelName</code> to specify a pre-registered model name for a single request:</p> <pre><code>// Pre-register multiple models when creating the Agent.\nagent := llmagent.New(\"my-agent\",\n    llmagent.WithModels(map[string]model.Model{\n        \"smart\": anthropic.New(\"claude-3-5-sonnet-20241022\"),\n        \"fast\":  anthropic.New(\"claude-3-5-haiku-20241022\"),\n    }),\n    llmagent.WithModel(anthropic.New(\"claude-3-5-haiku-20241022\")), // Default model.\n)\n\nrunner := runner.NewRunner(\"app\", agent)\n\n// Temporarily use \"smart\" model for this request only.\neventChan, err := runner.Run(ctx, userID, sessionID, message,\n    agent.WithModelName(\"smart\"),\n)\n\n// Next request still uses the default model \"claude-3-5-haiku-20241022\".\neventChan2, err := runner.Run(ctx, userID, sessionID, message2)\n</code></pre> <p>Use Cases:</p> <pre><code>// Dynamically select model based on message complexity.\nvar opts []agent.RunOption\nif isComplexQuery(message) {\n    opts = append(opts, agent.WithModelName(\"smart\")) // Use powerful model for complex queries.\n}\n\neventChan, err := runner.Run(ctx, userID, sessionID, message, opts...)\n\n// Use specialized model for specific tasks.\neventChan, err := runner.Run(ctx, userID, sessionID, visionMessage,\n    agent.WithModelName(\"vision\"),\n)\n</code></pre>"},{"location":"model/#configuration-details_1","title":"Configuration Details","text":"<p>WithModels Option:</p> <ul> <li>Accepts a <code>map[string]model.Model</code> where key is the model name and value is the model instance</li> <li>If both <code>WithModel</code> and <code>WithModels</code> are set, <code>WithModel</code> specifies the initial model</li> <li>If only <code>WithModels</code> is set, the first model in the map will be used as the initial model (note: map iteration order is not guaranteed, so it's recommended to explicitly specify the initial model)</li> <li>Reserved name: <code>__default__</code> is used internally by the framework and should not be used</li> </ul> <p>SetModelByName Method:</p> <ul> <li>Parameter: model name (string)</li> <li>Returns: error if the model name is not found</li> <li>The model must be pre-registered via <code>WithModels</code></li> </ul> <p>Per-request Options:</p> <ul> <li><code>agent.RunOptions.Model</code>: Directly specify a model instance</li> <li><code>agent.RunOptions.ModelName</code>: Specify a pre-registered model name</li> <li>Priority: <code>Model</code> &gt; <code>ModelName</code> &gt; Agent default model</li> <li>If the model specified by <code>ModelName</code> is not found, it falls back to the Agent's default model</li> </ul>"},{"location":"model/#agent-level-vs-per-request-comparison_1","title":"Agent-level vs Per-request Comparison","text":"Feature Agent-level Switching Per-request Switching Scope All subsequent requests Current request only Usage <code>SetModel</code>/<code>SetModelByName</code> <code>RunOptions.Model</code>/<code>ModelName</code> State Change Changes Agent default model Does not change Agent state Use Case Global strategy adjustment Specific task temporary needs Concurrency Affects all concurrent reqs Does not affect other requests Typical Examples User tier, time-based policy Complex queries, reasoning"},{"location":"model/#agent-level-approach-comparison_1","title":"Agent-level Approach Comparison","text":"Feature SetModel SetModelByName Usage Pass model instance Pass model name Pre-registration Not required Required via WithModels Error Handling None Returns error Use Case Simple switching Complex scenarios, multi-model management Code Maintenance Need to hold model instances Only need to remember names"},{"location":"model/#important-notes_2","title":"Important Notes","text":"<p>Agent-level Switching:</p> <ul> <li>Immediate Effect: After calling <code>SetModel</code> or <code>SetModelByName</code>, the next request immediately uses the new model</li> <li>Session Persistence: Switching models does not clear session history</li> <li>Independent Configuration: Each model retains its own configuration (temperature, max tokens, etc.)</li> <li>Concurrency Safe: Both switching approaches are concurrency-safe</li> </ul> <p>Per-request Switching:</p> <ul> <li>Temporary Override: Only affects the current request, does not change the Agent's default model</li> <li>Higher Priority: Per-request model settings take precedence over the Agent's default model</li> <li>No Side Effects: Does not affect other concurrent requests or subsequent requests</li> <li>Flexible Combination: Can be used in combination with agent-level switching</li> </ul>"},{"location":"model/#usage-example_3","title":"Usage Example","text":"<p>For a complete interactive example, see examples/model/switch, which demonstrates both agent-level and per-request switching approaches.</p>"},{"location":"model/#3-custom-http-headers","title":"3. Custom HTTP Headers","text":"<p>In environments like gateways, proprietary platforms, or proxy setups, model API requests often require additional HTTP headers (e.g., organization/tenant identifiers, grayscale routing, custom authentication, etc.). The Model module provides three reliable ways to add headers for \"all model requests,\" including standard requests, streaming, file uploads, batch processing, etc.</p> <p>Recommended order:</p> <ul> <li>Global header via <code>anthropic.WithHeaders</code> (simplest for static headers)</li> <li>Use Anthropic RequestOption to set global headers (flexible, middleware-friendly)</li> <li>Use a custom <code>http.RoundTripper</code> injection (advanced, more cross-cutting capabilities)</li> </ul> <p>All methods affect streaming requests, as they use the same underlying client.</p>"},{"location":"model/#1-using-anthropicwithheaders-for-headers","title":"1. Using anthropic.WithHeaders for headers","text":"<pre><code>import \"trpc.group/trpc-go/trpc-agent-go/model/anthropic\"\n\nllm := anthropic.New(\"claude-sonnet-4-0\",\n    anthropic.WithHeaders(map[string]string{\n        \"X-Custom-Header\": \"custom-value\",\n        \"X-Request-ID\":    \"req-123\",\n    }),\n)\n</code></pre>"},{"location":"model/#2-using-anthropic-requestoption-to-set-global-headers","title":"2. Using Anthropic RequestOption to Set Global Headers","text":"<p>By using <code>WithAnthropicClientOptions</code> combined with <code>anthropicopt.WithHeader</code> or <code>anthropicopt.WithMiddleware</code>, you can inject headers into every request made by the underlying Anthropic client.</p> <pre><code>import (\n    anthropicopt \"github.com/anthropics/anthropic-sdk-go/option\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/anthropic\"\n)\n\nllm := anthropic.New(\"claude-sonnet-4-0\",\n    // If your platform requires additional headers\n    anthropic.WithAnthropicClientOptions(\n        anthropicopt.WithHeader(\"X-Custom-Header\", \"custom-value\"),\n        anthropicopt.WithHeader(\"X-Request-ID\", \"req-123\"),\n        // You can also set User-Agent or vendor-specific headers\n        anthropicopt.WithHeader(\"User-Agent\", \"trpc-agent-go/1.0\"),\n    ),\n)\n</code></pre> <p>If you need to set headers conditionally (e.g., only for certain paths or depending on context values), you can use middleware:</p> <pre><code>import (\n    anthropicopt \"github.com/anthropics/anthropic-sdk-go/option\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/anthropic\"\n)\n\n    llm := anthropic.New(\"claude-sonnet-4-0\",\n        anthropic.WithAnthropicClientOptions(\n            anthropicopt.WithMiddleware(\n            func(r *http.Request, next anthropicopt.MiddlewareNext) (*http.Response, error) {\n                // Example: Set \"per-request\" headers based on context value\n                if v := r.Context().Value(\"x-request-id\"); v != nil {\n                    if s, ok := v.(string); ok &amp;&amp; s != \"\" {\n                        r.Header.Set(\"X-Request-ID\", s)\n                    }\n                }\n                // Or only for the \"message completion\" endpoint\n                if strings.Contains(r.URL.Path, \"v1/messages\") {\n                    r.Header.Set(\"X-Feature-Flag\", \"on\")\n                }\n                return next(r)\n            },\n        ),\n        ),\n    )\n    ```\n\n##### 3. Using Custom `http.RoundTripper`\n\nFor injecting headers at the HTTP transport layer, ideal for scenarios requiring proxying, TLS, custom monitoring, and other capabilities.\n\n```go\nimport (\n    anthropicopt \"github.com/anthropics/anthropic-sdk-go/option\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/anthropic\"\n)\n\ntype headerRoundTripper struct{ base http.RoundTripper }\n\nfunc (rt headerRoundTripper) RoundTrip(req *http.Request) (*http.Response, error) {\n    // Add or override headers\n    req.Header.Set(\"X-Custom-Header\", \"custom-value\")\n    req.Header.Set(\"X-Trace-ID\", \"trace-xyz\")\n    return rt.base.RoundTrip(req)\n}\n\nllm := anthropic.New(\"claude-sonnet-4-0\",\n    anthropic.WithHTTPClientOptions(\n        anthropic.WithHTTPClientTransport(headerRoundTripper{base: http.DefaultTransport}),\n    ),\n)\n</code></pre> <p>Regarding \"per-request\" headers:</p> <ul> <li>The Agent/Runner will propagate <code>ctx</code> to the model call; middleware can read the value from <code>req.Context()</code> to inject headers for \"this call.\"</li> <li>For message completion, the current API doesn't expose per-call BaseURL overrides; if switching is needed, create a model using a different BaseURL or modify the <code>r.URL</code> in middleware.</li> </ul>"},{"location":"model/#4-token-tailoring","title":"4. Token Tailoring","text":"<p>Anthropic models also support Token Tailoring functionality, designed to automatically trim messages when they exceed the model's context window limits, ensuring requests can be successfully sent to the LLM API.</p> <p>Automatic Mode (Recommended):</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/model/anthropic\"\n)\n\n// Enable token tailoring with automatic configuration\nmodel := anthropic.New(\"claude-3-5-sonnet\",\n    anthropic.WithEnableTokenTailoring(true),\n)\n</code></pre> <p>Advanced Mode:</p> <pre><code>// Custom token limit and strategy\nmodel := anthropic.New(\"claude-3-5-sonnet\",\n    anthropic.WithEnableTokenTailoring(true),               // Required: enable token tailoring\n    anthropic.WithMaxInputTokens(10000),                    // Custom token limit\n    anthropic.WithTokenCounter(customCounter),              // Optional: custom counter\n    anthropic.WithTailoringStrategy(customStrategy),        // Optional: custom strategy\n)\n</code></pre> <p>For detailed explanations of the token calculation formula, tailoring strategy, and custom strategy implementation, please refer to Token Tailoring under OpenAI Model.</p>"},{"location":"model/#provider","title":"Provider","text":"<p>With the emergence of multiple large model providers, some have defined their own API specifications. Currently, the framework has integrated the APIs of OpenAI and Anthropic, and exposes them as models. Users can access different provider models through <code>openai.New</code> and <code>anthropic.New</code>.</p> <p>However, there are differences in instantiation and configuration between providers, which often requires developers to modify a significant amount of code when switching between providers, increasing the cost of switching.</p> <p>To solve this problem, the Provider offers a unified model instantiation entry point. Developers only need to specify the provider and model name, and other configuration options are managed through the unified <code>Option</code>, simplifying the complexity of switching between providers.</p> <p>The Provider supports the following <code>Option</code>:</p> Option Description <code>WithAPIKey</code> / <code>WithBaseURL</code> Set the API Key and Base URL for the model <code>WithHTTPClientName</code> / <code>WithHTTPClientTransport</code> Configure HTTP client properties <code>WithHeaders</code> Append static HTTP headers across requests <code>WithChannelBufferSize</code> Adjust the response channel buffer size <code>WithCallbacks</code> Configure OpenAI / Anthropic request, response, and streaming callbacks <code>WithExtraFields</code> Configure custom fields in the request body <code>WithEnableTokenTailoring</code> / <code>WithMaxInputTokens</code><code>WithTokenCounter</code> / <code>WithTailoringStrategy</code> Token trimming related parameters <code>WithTokenTailoringConfig</code> Custom token tailoring budget parameters for advanced configuration <code>WithOpenAIOption</code> / <code>WithAnthropicOption</code> Pass-through native options for the respective providers"},{"location":"model/#usage-example_4","title":"Usage Example","text":"<pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/agent/llmagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/provider\"\n)\n\nproviderName := \"openai\"        // provider supports openai and anthropic.\nmodelName := \"deepseek-chat\"\n\nmodelInstance, err := provider.Model(\n    providerName,\n    modelName,\n    provider.WithAPIKey(c.apiKey),\n    provider.WithBaseURL(c.baseURL),\n    provider.WithChannelBufferSize(c.channelBufferSize),\n    provider.WithEnableTokenTailoring(c.tokenTailoring),\n    provider.WithMaxInputTokens(c.maxInputTokens),\n)\n\nagent := llmagent.New(\"chat-assistant\", llmagent.WithModel(modelInstance))\n</code></pre> <p>Advanced Configuration with TokenTailoringConfig:</p> <p>For advanced users who need to fine-tune token allocation strategy, you can use <code>WithTokenTailoringConfig</code>:</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/model\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/provider\"\n)\n\n// Custom token tailoring budget parameters for all providers\nconfig := &amp;model.TokenTailoringConfig{\n    ProtocolOverheadTokens: 1024,\n    ReserveOutputTokens:    4096,\n    SafetyMarginRatio:      0.15,\n}\n\nmodelInstance, err := provider.Model(\n    \"openai\",\n    \"deepseek-chat\",\n    provider.WithAPIKey(c.apiKey),\n    provider.WithEnableTokenTailoring(true),\n    provider.WithTokenTailoringConfig(config),\n)\n</code></pre> <p>Full code can be found in examples/provider.</p>"},{"location":"model/#registering-a-custom-provider","title":"Registering a Custom Provider","text":"<p>The framework supports registering custom providers to integrate other large model providers or custom model implementations.</p> <p>Using <code>provider.Register</code>, you can define a method to create custom model instances based on the options.</p> <pre><code>import \"trpc.group/trpc-go/trpc-agent-go/model/provider\"\n\nprovider.Register(\"custom-provider\", func(opts *provider.Options) (model.Model, error) {\n    return newCustomModel(opts.ModelName, WithAPIKey(opts.APIKey)), nil\n})\n\ncustomModel, err := provider.Model(\"custom-provider\", \"custom-model\")\n</code></pre>"},{"location":"multiagent/","title":"Multi-Agent System","text":"<p>The Multi-Agent System is one of the core features of the trpc-agent-go framework, allowing you to create complex systems composed of multiple specialized Agents. These Agents can collaborate in different ways to implement various application scenarios from simple to complex.</p>"},{"location":"multiagent/#overview","title":"Overview","text":"<p>The Multi-Agent System is built on the SubAgent concept, implementing various collaboration patterns through the <code>WithSubAgents</code> option:</p>"},{"location":"multiagent/#basic-concepts","title":"Basic Concepts","text":"<ul> <li>SubAgent - Specialized Agents configured through the <code>WithSubAgents</code> option, serving as the foundation for building complex collaboration patterns</li> </ul>"},{"location":"multiagent/#core-collaboration-patterns","title":"Core Collaboration Patterns","text":"<ol> <li>Chain Agent (ChainAgent) - Uses SubAgents to execute sequentially, forming processing pipelines</li> <li>Parallel Agent (ParallelAgent) - Uses SubAgents to process different aspects of the same input simultaneously</li> <li>Cycle Agent (CycleAgent) - Uses SubAgents to iterate in loops until specific conditions are met</li> </ol>"},{"location":"multiagent/#auxiliary-functions","title":"Auxiliary Functions","text":"<ul> <li>Agent Tool (AgentTool) - Wraps Agents as tools for other Agents to call</li> <li>Agent Transfer - Implements task delegation between Agents through the <code>transfer_to_agent</code> tool</li> </ul>"},{"location":"multiagent/#subagent-basics","title":"SubAgent Basics","text":"<p>SubAgent is the core concept of the Multi-Agent System, implemented through the <code>WithSubAgents</code> option. It allows you to combine multiple specialized Agents to build complex collaboration patterns.</p>"},{"location":"multiagent/#role-of-subagent","title":"Role of SubAgent","text":"<ul> <li>Specialized Division of Labor: Each SubAgent focuses on specific domains or task types</li> <li>Modular Design: Decomposes complex systems into manageable components</li> <li>Flexible Combination: Can combine different SubAgents as needed</li> <li>Unified Interface: All collaboration patterns are based on the same <code>WithSubAgents</code> mechanism</li> </ul>"},{"location":"multiagent/#basic-usage","title":"Basic Usage","text":"<pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/agent\"\n    \"trpc.group/trpc-go/trpc-agent-go/agent/llmagent\"\n)\n\n// Create SubAgent.\nmathAgent := llmagent.New(\n    \"math-agent\",\n    llmagent.WithModel(modelInstance),\n    llmagent.WithDescription(\"Handles mathematical calculations and numerical problems\"),\n    llmagent.WithInstruction(\"You are a mathematics expert, focusing on mathematical operations and numerical reasoning...\"),\n)\n\nweatherAgent := llmagent.New(\n    \"weather-agent\",\n    llmagent.WithModel(modelInstance),\n    llmagent.WithDescription(\"Provides weather information and suggestions\"),\n    llmagent.WithInstruction(\"You are a weather expert, providing weather analysis and activity suggestions...\"),\n)\n\n// Use WithSubAgents option to configure SubAgent.\nmainAgent := llmagent.New(\n    \"coordinator-agent\",\n    llmagent.WithModel(modelInstance),\n    llmagent.WithDescription(\"Coordinator Agent responsible for task delegation\"),\n    llmagent.WithInstruction(\"You are a coordinator, analyzing user requests and delegating to appropriate experts...\"),\n    llmagent.WithSubAgents([]agent.Agent{mathAgent, weatherAgent}),\n)\n</code></pre>"},{"location":"multiagent/#core-collaboration-patterns_1","title":"Core Collaboration Patterns","text":"<p>All collaboration patterns are based on the SubAgent concept, implemented through different execution strategies:</p>"},{"location":"multiagent/#chain-agent-chainagent","title":"Chain Agent (ChainAgent)","text":"<p>Chain Agent uses SubAgents connected sequentially to form processing pipelines. Each SubAgent focuses on specific tasks and passes results to the next SubAgent.</p>"},{"location":"multiagent/#use-cases","title":"Use Cases","text":"<ul> <li>Content Creation Workflow: Planning \u2192 Research \u2192 Writing</li> <li>Problem Solving Workflow: Analysis \u2192 Design \u2192 Implementation</li> <li>Data Processing Workflow: Collection \u2192 Cleaning \u2192 Analysis</li> </ul>"},{"location":"multiagent/#basic-usage_1","title":"Basic Usage","text":"<pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/agent\"\n    \"trpc.group/trpc-go/trpc-agent-go/agent/chainagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/agent/llmagent\"\n)\n\n// Create SubAgent.\nplanningAgent := llmagent.New(\"planning-agent\", ...)\nresearchAgent := llmagent.New(\"research-agent\", ...)\nwritingAgent := llmagent.New(\"writing-agent\", ...)\n\n// Create chain Agent, use WithSubAgents to configure SubAgent.\nchainAgent := chainagent.New(\n    \"multi-agent-chain\",\n    chainagent.WithSubAgents([]agent.Agent{\n        planningAgent, \n        researchAgent, \n        writingAgent,\n    }),\n)\n</code></pre>"},{"location":"multiagent/#example-session","title":"Example Session","text":"<pre><code>\ud83d\udd17 Multi-Agent Chain Demo\nChain Flow: Planning \u2192 Research \u2192 Writing\n==================================================\n\n\ud83d\udc64 User: Explain the benefits of renewable energy\n\n\ud83d\udccb Planning Agent: I will create a structured analysis plan...\n\n\ud83d\udd0d Research Agent:\n\ud83d\udd27 Using tools:\n   \u2022 web_search (ID: call_123)\n\ud83d\udd04 Executing...\n\u2705 Tool result: Latest renewable energy data...\n\n\u270d\ufe0f Writing Agent: Based on planning and research:\n[Structured comprehensive response]\n</code></pre>"},{"location":"multiagent/#parallel-agent-parallelagent","title":"Parallel Agent (ParallelAgent)","text":"<p>Parallel Agent uses SubAgents to process different aspects of the same input simultaneously, providing multi-perspective analysis.</p>"},{"location":"multiagent/#use-cases_1","title":"Use Cases","text":"<ul> <li>Business Decision Analysis: Market analysis, technical assessment, risk evaluation, opportunity analysis</li> <li>Multi-dimensional Evaluation: Different experts simultaneously evaluating the same problem</li> <li>Fast Parallel Processing: Scenarios requiring multiple perspectives simultaneously</li> </ul>"},{"location":"multiagent/#basic-usage_2","title":"Basic Usage","text":"<pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/agent/parallelagent\"\n)\n\n// Create SubAgent.\nmarketAgent := llmagent.New(\"market-analysis\", ...)\ntechnicalAgent := llmagent.New(\"technical-assessment\", ...)\nriskAgent := llmagent.New(\"risk-evaluation\", ...)\nopportunityAgent := llmagent.New(\"opportunity-analysis\", ...)\n\n// Create parallel Agent, use WithSubAgents to configure SubAgent.\nparallelAgent := parallelagent.New(\n    \"parallel-demo\",\n    parallelagent.WithSubAgents([]agent.Agent{\n        marketAgent,\n        technicalAgent, \n        riskAgent,\n        opportunityAgent,\n    }),\n)\n</code></pre>"},{"location":"multiagent/#example-session_1","title":"Example Session","text":"<pre><code>\u26a1 Parallel Multi-Agent Demo\nAgents: Market \ud83d\udcca | Technical \u2699\ufe0f | Risk \u26a0\ufe0f | Opportunity \ud83d\ude80\n==================================================\n\n\ud83d\udcac User: Should we implement blockchain for supply chain tracking?\n\n\ud83d\ude80 Starting parallel analysis: \"Should we implement blockchain for supply chain tracking?\"\n\ud83d\udcca Agents analyzing different perspectives...\n\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\n\ud83d\udcca [market-analysis] Starting analysis...\n\u2699\ufe0f [technical-assessment] Starting analysis...\n\u26a0\ufe0f [risk-evaluation] Starting analysis...\n\ud83d\ude80 [opportunity-analysis] Starting analysis...\n\n\ud83d\udcca [market-analysis]: Blockchain supply chain market is experiencing strong growth with 67% CAGR...\n\n\u2699\ufe0f [technical-assessment]: Implementation requires distributed ledger infrastructure and consensus mechanisms...\n\n\u26a0\ufe0f [risk-evaluation]: Main risks include 40% target market regulatory uncertainty...\n\n\ud83d\ude80 [opportunity-analysis]: Strategic advantages include enhanced transparency, leading to 15-20% cost reduction...\n\n\ud83c\udfaf All parallel analysis completed successfully!\n\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\u2705 Multi-perspective analysis completed in 4.1 seconds\n</code></pre>"},{"location":"multiagent/#cycle-agent-cycleagent","title":"Cycle Agent (CycleAgent)","text":"<p>Cycle Agent uses SubAgents to run in iterative loops until specific conditions are met (such as quality thresholds or maximum iterations).</p>"},{"location":"multiagent/#use-cases_2","title":"Use Cases","text":"<ul> <li>Content Optimization: Generate \u2192 Evaluate \u2192 Improve \u2192 Repeat</li> <li>Problem Solving: Propose \u2192 Evaluate \u2192 Enhance \u2192 Repeat</li> <li>Quality Assurance: Draft \u2192 Review \u2192 Revise \u2192 Repeat</li> </ul>"},{"location":"multiagent/#basic-usage_3","title":"Basic Usage","text":"<pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/agent/cycleagent\"\n)\n\n// Create SubAgent.\ngenerateAgent := llmagent.New(\"generate-agent\", ...)\ncriticAgent := llmagent.New(\"critic-agent\", ...)\n\n// Create cycle Agent, use WithSubAgents to configure SubAgent.\ncycleAgent := cycleagent.New(\n    \"cycle-demo\",\n    cycleagent.WithSubAgents([]agent.Agent{\n        generateAgent,\n        criticAgent,\n    }),\n    cycleagent.WithMaxIterations(3),\n    cycleagent.WithEscalationFunc(qualityEscalationFunc),\n)\n</code></pre>"},{"location":"multiagent/#example-session_2","title":"Example Session","text":"<pre><code>\ud83d\udd04 Multi-Agent Cycle Demo\nMax iterations: 3\nCycle: Generate \u2192 Evaluate \u2192 Improve \u2192 Repeat\n==================================================\n\n\ud83d\udc64 User: Write a short joke\n\n\ud83e\udd16 Cycle Response:\n\n\ud83e\udd16 Generate Agent: Why don't skeletons fight each other?\nBecause they don't have the guts!\n\n\ud83d\udc40 Evaluate Agent:\n\ud83d\udd27 Using tools:\n   \u2022 record_score (ID: call_123)\n\ud83d\udd04 Executing...\n\u2705 Quality score: 75/100\n\u26a0\ufe0f Needs improvement - continue iteration\n\n\ud83d\udd04 **2nd Iteration**\n\n\ud83e\udd16 Generate Agent: This is an improved version with a new twist:\n**Why do skeletons never win arguments?**\nBecause they always lose their backbone halfway through!\n\n\ud83d\udc40 Evaluate Agent:\n\ud83d\udd27 Using tools:\n   \u2022 record_score (ID: call_456)\n\ud83d\udd04 Executing...\n\u2705 Quality score: 85/100\n\ud83c\udf89 Quality threshold reached - cycle completed\n\n\ud83c\udfc1 Cycle completed after 2 iterations\n</code></pre>"},{"location":"multiagent/#auxiliary-functions_1","title":"Auxiliary Functions","text":""},{"location":"multiagent/#agent-tool-agenttool","title":"Agent Tool (AgentTool)","text":"<p>Agent Tool is an important foundational function for building complex multi-agent systems. It allows you to wrap any Agent as a callable tool for use by other Agents or applications.</p>"},{"location":"multiagent/#use-cases_3","title":"Use Cases","text":"<ul> <li>Specialized Delegation: Different Agents handle specific types of tasks</li> <li>Tool Integration: Agents can be integrated as tools into larger systems</li> <li>Modular Design: Reusable Agent components can be combined together</li> <li>Complex Workflows: Complex workflows involving multiple specialized Agents</li> </ul>"},{"location":"multiagent/#basic-usage_4","title":"Basic Usage","text":"<pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/agent/llmagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/tool\"\n    agenttool \"trpc.group/trpc-go/trpc-agent-go/tool/agent\"\n    \"trpc.group/trpc-go/trpc-agent-go/tool/function\"\n)\n\n// Create specialized Agent.\nmathAgent := llmagent.New(\n    \"math-specialist\",\n    llmagent.WithModel(modelInstance),\n    llmagent.WithDescription(\"Agent specialized in mathematical operations\"),\n    llmagent.WithInstruction(\"You are a mathematics expert, focusing on mathematical operations, calculations and numerical reasoning...\"),\n    llmagent.WithTools([]tool.Tool{calculatorTool}),\n)\n\n// Wrap Agent as tool.\nagentTool := agenttool.NewTool(\n    mathAgent,\n    // The default value for skip summarization=false. \n    // When set to true, the current round will end immediately after tool.response.\n    agenttool.WithSkipSummarization(false),\n    // Enable inner forwarding: stream child Agent events inline to the parent\n    agenttool.WithStreamInner(true),\n)\n\n// Use Agent tool in main Agent.\nmainAgent := llmagent.New(\n    \"chat-assistant\",\n    llmagent.WithTools([]tool.Tool{timeTool, agentTool}),\n)\n</code></pre>"},{"location":"multiagent/#agent-tool-architecture","title":"Agent Tool Architecture","text":"<pre><code>Chat Assistant (Main Agent)\n\u251c\u2500\u2500 Time Tool (Function)\n\u2514\u2500\u2500 Math Specialist Agent Tool (Agent)\n    \u2514\u2500\u2500 Math Specialist Agent (Specialized Agent)\n        \u2514\u2500\u2500 Calculator Tool (Function)\n</code></pre>"},{"location":"multiagent/#example-session_3","title":"Example Session","text":"<pre><code>\ud83d\ude80 Agent Tool Example\nModel: deepseek-chat\nAvailable tools: current_time, math-specialist\n==================================================\n\n\ud83d\udc64 User: Calculate 923476 * 273472354\n\n\ud83e\udd16 Assistant: I will use the math specialist Agent to calculate this result.\n\n\ud83d\udd27 Tool call initiated:\n   \u2022 math-specialist (ID: call_0_e53a77e9-c994-4421-bfc3-f63fe85678a1)\n     Parameters: {\"request\":\"Calculate 923476 multiplied by 273472354\"}\n\n\ud83d\udd04 Executing tool...\n\u2705 Tool response (ID: call_0_e53a77e9-c994-4421-bfc3-f63fe85678a1):\n\"The result of calculating 923,476 multiplied by 273,472,354 is:\n\n\\[\n923,\\!476 \\times 273,\\!472,\\!354 = 252,\\!545,\\!155,\\!582,\\!504\n\\]\"\n\n\u2705 Tool execution completed.\n</code></pre>"},{"location":"multiagent/#streaming-inner-forwarding-streaminner","title":"Streaming Inner Forwarding (StreamInner)","text":"<p>When <code>WithStreamInner(true)</code> is enabled for the Agent tool:</p> <ul> <li>Child Agent events are forwarded as streaming <code>event.Event</code> items; you can directly display <code>choice.Delta.Content</code></li> <li>To avoid duplicates, the child Agent\u2019s final full text is not forwarded again; it is aggregated into the final <code>tool.response</code> that follows tool_calls (satisfying provider requirements)</li> <li>UI recommendations:<ul> <li>Show forwarded child deltas as they stream</li> <li>By default, don\u2019t reprint the final aggregated tool response text unless debugging</li> </ul> </li> </ul> <p>Example: Distinguish outer assistant, child Agent (forwarded), and tool responses in your event loop</p> <pre><code>// Child Agent forwarded delta (author != parent)\nif ev.Author != parentName &amp;&amp; ev.Response != nil &amp;&amp; len(ev.Response.Choices) &gt; 0 {\n    if delta := ev.Response.Choices[0].Delta.Content; delta != \"\" {\n        fmt.Print(delta)\n    }\n    return\n}\n\n// Tool response (aggregated content), skip by default to avoid duplicates\nif ev.Response != nil &amp;&amp; ev.Object == model.ObjectTypeToolResponse {\n    // ...show on demand or skip\n    return\n}\n</code></pre>"},{"location":"multiagent/#option-matrix","title":"Option Matrix","text":"<ul> <li><code>WithSkipSummarization(false)</code>: (default) Allow one more summarization LLM call after the tool</li> <li><code>WithSkipSummarization(true)</code>: Skip the outer summarization so the tool output is surfaced directly</li> <li><code>WithStreamInner(true)</code>: Forward child Agent events (use <code>Stream: true</code> on both parent and child Agents)</li> <li><code>WithStreamInner(false)</code>: Treat as a callable-only tool, without inner forwarding</li> </ul>"},{"location":"multiagent/#agent-transfer","title":"Agent Transfer","text":"<p>Agent Transfer implements task delegation between Agents through the <code>transfer_to_agent</code> tool, allowing the main Agent to automatically select appropriate SubAgents based on task type.</p>"},{"location":"multiagent/#use-cases_4","title":"Use Cases","text":"<ul> <li>Task Classification: Automatically select appropriate SubAgents based on user requests</li> <li>Intelligent Routing: Route complex tasks to the most suitable handlers</li> <li>Specialized Processing: Each SubAgent focuses on specific domains</li> <li>Seamless Switching: Seamlessly switch between SubAgents while maintaining conversation continuity</li> </ul>"},{"location":"multiagent/#basic-usage_5","title":"Basic Usage","text":"<pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/agent\"\n    \"trpc.group/trpc-go/trpc-agent-go/agent/llmagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/tool\"\n    \"trpc.group/trpc-go/trpc-agent-go/tool/function\"\n)\n\n// Create SubAgent.\nmathAgent := llmagent.New(\n    \"math-agent\",\n    llmagent.WithModel(modelInstance),\n    llmagent.WithDescription(\"Handles mathematical calculations and numerical problems\"),\n    llmagent.WithInstruction(\"You are a mathematics expert, focusing on mathematical operations and numerical reasoning...\"),\n    llmagent.WithTools([]tool.Tool{calculatorTool}),\n)\n\nweatherAgent := llmagent.New(\n    \"weather-agent\",\n    llmagent.WithModel(modelInstance),\n    llmagent.WithDescription(\"Provides weather information and suggestions\"),\n    llmagent.WithInstruction(\"You are a weather expert, providing weather analysis and activity suggestions...\"),\n    llmagent.WithTools([]tool.Tool{weatherTool}),\n)\n\n// Create coordinator Agent, use WithSubAgents to configure SubAgent.\ncoordinatorAgent := llmagent.New(\n    \"coordinator-agent\",\n    llmagent.WithModel(modelInstance),\n    llmagent.WithDescription(\"Coordinator Agent responsible for task delegation\"),\n    llmagent.WithInstruction(\"You are a coordinator, analyzing user requests and delegating to appropriate experts...\"),\n    llmagent.WithSubAgents([]agent.Agent{mathAgent, weatherAgent}),\n)\n</code></pre>"},{"location":"multiagent/#dynamic-subagent-discovery-with-a2a","title":"Dynamic SubAgent Discovery (with A2A)","text":"<p>In real systems, SubAgents are often remote Agents exposed through the A2A protocol. Their list may change over time (for example when new services are registered in a central registry).</p> <p>To support this, <code>LLMAgent</code> implements the <code>agent.SubAgentSetter</code> interface. You can refresh its SubAgents at runtime without recreating the coordinator:</p> <pre><code>import (\n    \"fmt\"\n    \"context\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/agent\"\n    \"trpc.group/trpc-go/trpc-agent-go/agent/a2aagent\"\n)\n\nfunc refreshSubAgents(ctx context.Context, ag agent.Agent) error {\n    cfg, ok := ag.(agent.SubAgentSetter)\n    if !ok {\n        return fmt.Errorf(\"agent does not support dynamic SubAgents\")\n    }\n\n    // 1. Discover remote Agents from your registry or config source.\n    urls := []string{\n        \"http://localhost:8087/\",\n        \"http://localhost:8088/\",\n    }\n\n    // 2. Build A2AAgent proxies for each remote Agent.\n    subAgents := make([]agent.Agent, 0, len(urls))\n    for _, url := range urls {\n        a2, err := a2aagent.New(a2aagent.WithAgentCardURL(url))\n        if err != nil {\n            // In production you may want to log and skip failures.\n            continue\n        }\n        subAgents = append(subAgents, a2)\n    }\n\n    // 3. Atomically replace SubAgents on the coordinator.\n    cfg.SetSubAgents(subAgents)\n    return nil\n}\n</code></pre> <p>This pattern lets you:</p> <ul> <li>Integrate with any registry (service discovery, database, config file)</li> <li>Dynamically add or remove remote SubAgents</li> <li>Keep <code>Runner</code> and session logic unchanged, since the coordinator   remains the same Agent instance</li> </ul>"},{"location":"multiagent/#agent-transfer-architecture","title":"Agent Transfer Architecture","text":"<pre><code>Coordinator Agent (Main Entry)\n\u251c\u2500\u2500 Analyze user requests\n\u251c\u2500\u2500 Select appropriate SubAgent\n\u2514\u2500\u2500 Use transfer_to_agent tool to delegate tasks\n    \u251c\u2500\u2500 Math SubAgent (Mathematical calculations)\n    \u251c\u2500\u2500 Weather SubAgent (Weather information)\n    \u2514\u2500\u2500 Research SubAgent (Information search)\n</code></pre>"},{"location":"multiagent/#example-session_4","title":"Example Session","text":"<pre><code>\ud83d\udd04 Agent Transfer Demo\nAvailable SubAgents: math-agent, weather-agent, research-agent\n==================================================\n\n\ud83d\udc64 User: Calculate compound interest, principal $5000, annual rate 6%, term 8 years\n\n\ud83c\udfaf Coordinator: I will delegate this task to our mathematics expert for accurate calculation.\n\ud83d\udd04 Initiating delegation...\n\ud83d\udd04 Transfer event: Transferring control to Agent: math-agent\n\n\ud83e\uddee Math Expert: I will help you calculate compound interest step by step.\n\ud83d\udd27 \ud83e\uddee Executing tool:\n   \u2022 calculate ({\"operation\":\"power\",\"a\":1.06,\"b\":8})\n   \u2705 Tool completed\n\ud83d\udd27 \ud83e\uddee Executing tool:\n   \u2022 calculate ({\"operation\":\"multiply\",\"a\":5000,\"b\":1.593})\n   \u2705 Tool completed\n\nCompound Interest Calculation Result:\n- Principal: $5,000\n- Annual Rate: 6%\n- Term: 8 years\n- Result: $7,969.24 (interest approximately $2,969.24)\n</code></pre>"},{"location":"multiagent/#environment-variable-configuration","title":"Environment Variable Configuration","text":"<p>All multi-agent examples require the following environment variables:</p> Variable Name Required Default Value Description <code>OPENAI_API_KEY</code> Yes - OpenAI API key <code>OPENAI_BASE_URL</code> No <code>https://api.openai.com/v1</code> OpenAI API base URL"},{"location":"multiagent/#running-examples","title":"Running Examples","text":"<p>All example code is located at examples</p>"},{"location":"multiagent/#core-collaboration-pattern-examples","title":"Core Collaboration Pattern Examples","text":""},{"location":"multiagent/#chain-agent-example","title":"Chain Agent Example","text":"<pre><code>cd examples/multiagent/chain\nexport OPENAI_API_KEY=\"your-api-key\"\ngo run main.go -model deepseek-chat\n</code></pre>"},{"location":"multiagent/#parallel-agent-example","title":"Parallel Agent Example","text":"<pre><code>cd examples/multiagent/parallel\nexport OPENAI_API_KEY=\"your-api-key\"\ngo run main.go -model deepseek-chat\n</code></pre>"},{"location":"multiagent/#cycle-agent-example","title":"Cycle Agent Example","text":"<pre><code>cd examples/multiagent/cycle\nexport OPENAI_API_KEY=\"your-api-key\"\ngo run main.go -model deepseek-chat -max-iterations 5\n</code></pre>"},{"location":"multiagent/#auxiliary-function-examples","title":"Auxiliary Function Examples","text":""},{"location":"multiagent/#agent-tool-example","title":"Agent Tool Example","text":"<pre><code>cd examples/agenttool\nexport OPENAI_API_KEY=\"your-api-key\"\ngo run main.go -model deepseek-chat\n</code></pre>"},{"location":"multiagent/#agent-transfer-example","title":"Agent Transfer Example","text":"<pre><code>cd examples/transfer\nexport OPENAI_API_KEY=\"your-api-key\"\ngo run main.go -model deepseek-chat\n</code></pre>"},{"location":"multiagent/#customization-and-extension","title":"Customization and Extension","text":""},{"location":"multiagent/#adding-new-agents","title":"Adding New Agents","text":"<pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/agent\"\n    \"trpc.group/trpc-go/trpc-agent-go/agent/chainagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/agent/llmagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/tool\"\n)\n\n// Create custom Agent.\ncustomAgent := llmagent.New(\n    \"custom-agent\",\n    llmagent.WithModel(modelInstance),\n    llmagent.WithDescription(\"Custom Agent description\"),\n    llmagent.WithInstruction(\"Custom instruction\"),\n    llmagent.WithTools([]tool.Tool{customTool}),\n)\n\n// Integrate into multi-agent system.\nchainAgent := chainagent.New(\n    \"custom-chain\",\n    chainagent.WithSubAgents([]agent.Agent{\n        existingAgent,\n        customAgent,  // Add custom Agent.\n    }),\n)\n</code></pre>"},{"location":"multiagent/#configuring-tools","title":"Configuring Tools","text":"<pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/agent/llmagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/tool\"\n    \"trpc.group/trpc-go/trpc-agent-go/tool/function\"\n)\n\n// Create custom tool.\ncustomTool := function.NewFunctionTool(\n    customFunction,\n    function.WithName(\"custom_tool\"),\n    function.WithDescription(\"Custom tool description\"),\n)\n\n// Assign tools to Agent.\nagent := llmagent.New(\n    \"tool-agent\",\n    llmagent.WithTools([]tool.Tool{customTool}),\n)\n</code></pre>"},{"location":"multiagent/#adjusting-parameters","title":"Adjusting Parameters","text":"<pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/agent/llmagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/model\"\n)\n\n// Configure generation parameters.\ngenConfig := model.GenerationConfig{\n    MaxTokens:   intPtr(500),\n    Temperature: floatPtr(0.7),\n    Stream:      true,\n}\n\n// Apply to Agent.\nagent := llmagent.New(\n    \"configured-agent\",\n    llmagent.WithGenerationConfig(genConfig),\n)\n</code></pre>"},{"location":"observability/","title":"Observability Features","text":""},{"location":"observability/#overview","title":"Overview","text":"<p>tRPC-Agent-Go provides comprehensive observability features built on the OpenTelemetry standard, offering powerful observability capabilities for Agent applications. With observability enabled, developers can achieve end-to-end monitoring of Agent runtime status, including tracing, performance metrics collection, and logging.</p>"},{"location":"observability/#key-features","title":"\ud83c\udfaf Key Features","text":"<ul> <li>Tracing: Fully records call chains during Agent execution.</li> <li>Metrics: Collects key runtime performance data for Agents.</li> <li>Logging: Unified log collection and management.</li> <li>Multi-platform Support: Supports mainstream monitoring platforms such as Jaeger, Prometheus, Galileo, and ZhiYan Monitoring Bao.</li> <li>Flexible Configuration: Supports multiple configuration methods and custom extensions.</li> </ul>"},{"location":"observability/#integration-with-different-monitoring-platforms","title":"Integration with Different Monitoring Platforms","text":""},{"location":"observability/#langfuse-integration","title":"Langfuse Integration","text":"<p>Langfuse is an observability platform designed for LLM applications and supports collecting tracing data via the OpenTelemetry protocol. tRPC-Agent-Go can export Trace data to Langfuse via OpenTelemetry.</p>"},{"location":"observability/#1-deploy-langfuse","title":"1. Deploy Langfuse","text":"<p>Refer to the Langfuse self-hosting guide for local or cloud deployment. For a quick start, see the Docker Compose deployment guide.</p>"},{"location":"observability/#2-go-code-integration-example","title":"2. Go Code Integration Example","text":"<pre><code>export LANGFUSE_PUBLIC_KEY=\"your-public-key\"\nexport LANGFUSE_SECRET_KEY=\"your-secret-key\"\nexport LANGFUSE_HOST=\"your-langfuse-host\"\nexport LANGFUSE_INSECURE=\"true\" # for insecure connections (development only)\n</code></pre> <pre><code>import (\n    \"context\"\n    \"log\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/telemetry/langfuse\"\n)\n\nfunc main() {\n    // Start trace with Langfuse integration using environment variables\n    clean, err := langfuse.Start(context.Background())\n    if err != nil {\n        log.Fatalf(\"Failed to start trace telemetry: %v\", err)\n    }\n    defer func() {\n        if err := clean(context.Background()); err != nil {\n            log.Printf(\"Failed to clean up trace telemetry: %v\", err)\n        }\n    }()\n</code></pre> <p>See the complete example at examples/telemetry/langfuse.</p> <p>Run the example:</p> <pre><code>go run .\n</code></pre> <p>You can view tracing data in the Langfuse console.</p>"},{"location":"observability/#integration-code-description","title":"Integration Code Description","text":"<p>Langfuse supports receiving Trace data via the <code>/api/public/otel</code> (OTLP) endpoint, supporting HTTP/protobuf only, not gRPC. The above code integrates with Langfuse by setting <code>OTEL_EXPORTER_OTLP_HEADERS</code> and <code>OTEL_EXPORTER_OTLP_TRACES_ENDPOINT</code>.</p> <pre><code># EU data region\nOTEL_EXPORTER_OTLP_ENDPOINT=\"https://cloud.langfuse.com/api/public/otel\"\n# US data region\n# OTEL_EXPORTER_OTLP_ENDPOINT=\"https://us.cloud.langfuse.com/api/public/otel\"\n# Local deployment (&gt;= v3.22.0)\n# OTEL_EXPORTER_OTLP_ENDPOINT=\"http://localhost:3000/api/public/otel\"\n\n# Set Basic Auth authentication\nOTEL_EXPORTER_OTLP_HEADERS=\"Authorization=Basic ${AUTH_STRING}\"\n</code></pre> <p><code>AUTH_STRING</code> is the base64 encoding of <code>public_key:secret_key</code>, which can be generated using the following command:</p> <pre><code>echo -n \"pk-lf-xxxx:sk-lf-xxxx\" | base64\n# On GNU systems, add -w 0 to avoid line breaks\n</code></pre> <p>To specify the endpoint for traces only, set:</p> <pre><code>OTEL_EXPORTER_OTLP_TRACES_ENDPOINT=\"http://localhost:3000/api/public/otel/v1/traces\"\n</code></pre>"},{"location":"observability/#jaeger-prometheus-and-other-open-source-monitoring-platforms","title":"Jaeger, Prometheus, and Other Open-Source Monitoring Platforms","text":"<p>Refer to code examples in examples/telemetry.</p> <pre><code>package main\n\nimport (\n    \"context\"\n    \"log\"\n\n    ametric \"trpc.group/trpc-go/trpc-agent-go/telemetry/metric\"\n    atrace \"trpc.group/trpc-go/trpc-agent-go/telemetry/trace\"\n)\n\nfunc main() {\n    // Start metrics collection.\n    mp, err := ametric.NewMeterProvider(\n        context.Background(),\n        ametric.WithEndpoint(\"localhost:4318\"),\n        ametric.WithProtocol(\"http\"),\n    )\n    if err != nil {\n        log.Fatalf(\"Failed to create meter provider: %v\", err)\n    }\n    defer mp.Shutdown(context.Background())\n    ametric.InitMeterProvider(mp)\n\n    // Start tracing.\n    traceClean, err := atrace.Start(\n        context.Background(),\n        atrace.WithEndpoint(\"localhost:4317\"), // Trace export address.\n    )\n    if err != nil {\n        log.Fatalf(\"Failed to start trace telemetry: %v\", err)\n    }\n    defer traceClean()\n\n    // Your Agent application code.\n    // ...\n    // You can add custom traces and metrics.\n}\n</code></pre>"},{"location":"observability/#jaeger-trace-example","title":"Jaeger trace example","text":""},{"location":"observability/#prometheus-metrics-example","title":"Prometheus metrics example","text":""},{"location":"observability/#practical-application-examples","title":"Practical Application Examples","text":""},{"location":"observability/#basic-metrics-and-tracing","title":"Basic Metrics and Tracing","text":"<pre><code>package main\n\nimport (\n    \"context\"\n    \"fmt\"\n    \"time\"\n\n    ametric \"trpc.group/trpc-go/trpc-agent-go/telemetry/metric\"\n    atrace \"trpc.group/trpc-go/trpc-agent-go/telemetry/trace\"\n    \"trpc.group/trpc-go/trpc-agent-go/log\"\n\n    \"go.opentelemetry.io/otel/attribute\"\n    \"go.opentelemetry.io/otel/metric\"\n    \"go.opentelemetry.io/otel/trace\"\n)\n\nfunc main() {\n    mp, err := ametric.NewMeterProvider(\n        context.Background(),\n        ametric.WithEndpoint(\"localhost:4318\"),\n        ametric.WithProtocol(\"http\"),\n    )\n    if err != nil {\n        log.Fatalf(\"Failed to create meter provider: %v\", err)\n    }\n    defer mp.Shutdown(context.Background())\n    ametric.InitMeterProvider(mp)\n    meter := mp.Meter(\"trpc_agent_go.app\")\n\n    if err := processAgentRequest(context.Background(), meter); err != nil {\n        log.Errorf(\"processAgentRequest failed: %v\", err)\n    }\n}\n\nfunc processAgentRequest(ctx context.Context, meter metric.Meter) error {\n    // Create tracing span.\n    ctx, span := atrace.Tracer.Start(\n        ctx,\n        \"process-agent-request\",\n        trace.WithAttributes(\n            attribute.String(\"agent.type\", \"chat\"),\n            attribute.String(\"user.id\", \"user123\"),\n        ),\n    )\n    defer span.End()\n\n    // Create metrics counter.\n    requestCounter, err := meter.Int64Counter(\n        \"agent.requests.total\",\n        metric.WithDescription(\"Total number of agent requests\"),\n    )\n    if err != nil {\n        return err\n    }\n\n    // Record request.\n    requestCounter.Add(ctx, 1, metric.WithAttributes(\n        attribute.String(\"agent.type\", \"chat\"),\n        attribute.String(\"status\", \"success\"),\n    ))\n\n    // Simulate processing.\n    time.Sleep(100 * time.Millisecond)\n\n    return nil\n}\n</code></pre>"},{"location":"observability/#agent-execution-tracing","title":"Agent Execution Tracing","text":"<p>The framework automatically instruments key components of Agents:</p> <pre><code>// Agent execution will automatically generate the following observability data:\n// \n// Traces:\n// - agent.execution: Overall Agent execution process.\n// - tool.invocation: Tool invocation process.  \n// - model.api_call: Model API call process.\n</code></pre>"},{"location":"observability/#telemetry-data-analysis","title":"Telemetry Data Analysis","text":""},{"location":"observability/#trace-analysis","title":"Trace Analysis","text":"<p>A typical Agent execution trace structure:</p> <pre><code>Agent Request\n\u251c\u2500\u2500 Planning Phase\n\u2502   \u251c\u2500\u2500 Model API Call (DeepSeek)\n\u2502   \u2514\u2500\u2500 Response Processing\n\u251c\u2500\u2500 Tool Execution Phase  \n\u2502   \u251c\u2500\u2500 Tool: web_search\n\u2502   \u251c\u2500\u2500 Tool: knowledge_base\n\u2502   \u2514\u2500\u2500 Result Processing\n\u2514\u2500\u2500 Response Generation Phase\n    \u251c\u2500\u2500 Model API Call (DeepSeek)\n    \u2514\u2500\u2500 Final Response Formatting\n</code></pre> <p>Trace data can be used to analyze:</p> <ul> <li>Performance Bottlenecks: Identify the most time-consuming operations.</li> <li>Error Localization: Quickly locate the exact failing step.</li> <li>Dependencies: Understand relationships between components.</li> <li>Concurrency Analysis: Observe the effects of concurrent execution.</li> </ul>"},{"location":"observability/#advanced-features","title":"Advanced Features","text":""},{"location":"observability/#custom-exporter","title":"Custom Exporter","text":"<p>If you need to send observability data to a custom monitoring system:</p> <pre><code>import (\n    \"go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracehttp\"\n    \"go.opentelemetry.io/otel/sdk/trace\"\n)\n\nfunc setupCustomExporter() error {\n    exporter, err := otlptracehttp.New(\n        context.Background(),\n        otlptracehttp.WithEndpoint(\"https://your-custom-endpoint.com\"),\n        otlptracehttp.WithHeaders(map[string]string{\n            \"Authorization\": \"Bearer your-token\",\n        }),\n    )\n    if err != nil {\n        return err\n    }\n\n    tp := trace.NewTracerProvider(\n        trace.WithBatcher(exporter),\n    )\n\n    // Set as the global TracerProvider.\n    otel.SetTracerProvider(tp)\n\n    return nil\n}\n</code></pre>"},{"location":"observability/#references","title":"References","text":"<ul> <li>OpenTelemetry documentation.</li> <li>tRPC-Agent-Go telemetry examples.</li> </ul> <p>By using observability features properly, you can establish a complete monitoring system for Agent applications, discover and resolve issues in time, and continuously optimize system performance.</p>"},{"location":"planner/","title":"Planner Usage Guide","text":"<p>Planner is a component for implementing planning capabilities for Agents. It allows an Agent to formulate a plan before executing tasks, thereby improving execution efficiency and accuracy.</p> <p>The framework provides two Planner implementations, each suited for different types of models:</p> <ul> <li>BuiltinPlanner: Suitable for models that support native reasoning/thinking.</li> <li>ReActPlanner: Suitable for models that do not support native reasoning, guiding the model to output in a fixed, labeled format to provide a structured reasoning process.</li> </ul>"},{"location":"planner/#planner-interface","title":"Planner Interface","text":"<p>The Planner interface defines the methods that all planners must implement:</p> <pre><code>type Planner interface {\n    // BuildPlanningInstruction applies necessary configurations to the LLM request and constructs the system instruction to be attached for planning.\n    // Return an empty string if no instruction is needed.\n    BuildPlanningInstruction(\n        ctx context.Context,\n        invocation *agent.Invocation,\n        llmRequest *model.Request,\n    ) string\n\n    // ProcessPlanningResponse processes the LLM's planning response and returns the processed response.\n    // Return nil if no processing is needed.\n    ProcessPlanningResponse(\n        ctx context.Context,\n        invocation *agent.Invocation,\n        response *model.Response,\n    ) *model.Response\n}\n</code></pre> <p>Planner workflow:</p> <ol> <li>Request processing phase: Before the LLM request is sent, the Planner adds planning instructions or configurations via <code>BuildPlanningInstruction</code>.</li> <li>Response processing phase: The Planner processes the LLM response and organizes the content structure via <code>ProcessPlanningResponse</code>.</li> </ol>"},{"location":"planner/#enable-and-capture-thinking-without-planner","title":"Enable and Capture Thinking (without Planner)","text":"<p>You can enable and read a model's internal reasoning (\"thinking\") even without using a Planner.  Configure GenerationConfig to request thinking, and then capture ReasoningContent from responses.</p>"},{"location":"planner/#enable-via-generationconfig","title":"Enable via GenerationConfig","text":"<pre><code>genConfig := model.GenerationConfig{\n    Stream:      true,  // streaming or non-streaming\n    MaxTokens:   2000,\n    Temperature: 0.7,\n}\n\n// Enable thinking (if provider/model supports it).\nthinkingEnabled := true\nthinkingTokens := 2048\ngenConfig.ThinkingEnabled = &amp;thinkingEnabled\ngenConfig.ThinkingTokens  = &amp;thinkingTokens\n</code></pre> <p>Attach genConfig to your Agent when constructing it.</p>"},{"location":"planner/#capture-reasoning-from-responses","title":"Capture reasoning from responses","text":"<ul> <li>Streaming: read <code>choice.Delta.ReasoningContent</code> (reasoning) and <code>choice.Delta.Content</code> (visible text).</li> <li>Non-streaming: read <code>choice.Message.ReasoningContent</code> and <code>choice.Message.Content</code>.</li> </ul> <pre><code>eventChan, err := runner.Run(ctx, userID, sessionID, model.NewUserMessage(\"Question\"))\nif err != nil { /* handle */ }\n\nfor e := range eventChan {\n    if e.Error != nil {\n        fmt.Printf(\"Error: %s\\n\", e.Error.Message)\n        continue\n    }\n    if len(e.Response.Choices) == 0 {\n        continue\n    }\n    ch := e.Response.Choices[0]\n\n    // Dim-print reasoning if present.\n    if genConfig.Stream {\n        if rc := ch.Delta.ReasoningContent; rc != \"\" {\n            fmt.Printf(\"\\x1b[2m%s\\x1b[0m\", rc)\n        }\n        if content := ch.Delta.Content; content != \"\" {\n            fmt.Print(content)\n        }\n    } else {\n        if rc := ch.Message.ReasoningContent; rc != \"\" {\n            fmt.Printf(\"\\x1b[2m%s\\x1b[0m\\n\", rc)\n        }\n        if content := ch.Message.Content; content != \"\" {\n            fmt.Println(content)\n        }\n    }\n\n    if e.IsFinalResponse() {\n        fmt.Println()\n        break\n    }\n}\n</code></pre> <p>Notes: - The visibility of reasoning depends on the model and provider; enabling related parameters expresses intent and does not guarantee it will be returned. - In streaming mode, you may insert a blank line between reasoning and normal content to improve the reading experience. - Session history may aggregate segmented reasoning into the final message to aid later review and traceability.</p>"},{"location":"planner/#builtinplanner","title":"BuiltinPlanner","text":"<p>BuiltinPlanner is suitable for models that support native reasoning. It does not generate explicit planning instructions, but instead configures the model to use its internal reasoning mechanisms to implement planning.</p> <p>Model configuration:</p> <pre><code>type Options struct {\n    // ReasoningEffort limits the reasoning effort of the reasoning model.\n    // Supported values: \"low\", \"medium\", \"high\".\n    // Only effective for OpenAI o-series models.\n    ReasoningEffort *string\n    // ThinkingEnabled enables thinking mode for models that support it.\n    // Only effective for Claude and Gemini models via OpenAI API.\n    ThinkingEnabled *bool\n    // ThinkingTokens controls the length of thinking.\n    // Only effective for Claude and Gemini models via OpenAI API.\n    ThinkingTokens *int\n}\n</code></pre> <p>Implementation details for BuiltinPlanner:</p> <ul> <li><code>BuildPlanningInstruction</code>: Injects reasoning parameters into the LLM request. Since the model supports native thinking, no planning tags are required, so it returns an empty string.</li> <li><code>ProcessPlanningResponse</code>: Since the model's response already contains the planning process, it directly returns nil.</li> </ul> <p>Example:</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/agent/llmagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/openai\"\n    \"trpc.group/trpc-go/trpc-agent-go/planner/builtin\"\n)\n\n// Create model instance.\nmodelInstance := openai.New(\"gpt-4o-mini\")\n\n// Create BuiltinPlanner.\nreasoningEffort := \"high\"\nplanner := builtin.New(builtin.Options{\n    ReasoningEffort: &amp;reasoningEffort,\n})\n\n// Create LLMAgent and configure Planner.\nllmAgent := llmagent.New(\n    \"demo-agent\",\n    llmagent.WithModel(modelInstance),\n    llmagent.WithDescription(\"A helpful AI assistant with built-in planning\"),\n    llmagent.WithInstruction(\"Be helpful and think through problems carefully\"),\n    llmagent.WithPlanner(planner), // Configure Planner.\n)\n</code></pre>"},{"location":"planner/#reactplanner","title":"ReActPlanner","text":"<p>ReActPlanner is suitable for models that do not support native reasoning. It guides the LLM to follow a specific format and uses specific tags to structure planning, reasoning, actions, and the final answer, thus enabling a structured reasoning process.</p> <p>ReActPlanner uses the following specific tags to organize response content:</p> <ol> <li>Planning phase (<code>/*PLANNING*/</code>): Create a clear plan to answer the user's question.</li> <li>Reasoning phase (<code>/*REASONING*/</code>): Provide reasoning between tool executions.</li> <li>Action phase (<code>/*ACTION*/</code>): Execute tools according to the plan.</li> <li>Replanning (<code>/*REPLANNING*/</code>): Revise the plan as needed based on results.</li> <li>Final answer (<code>/*FINAL_ANSWER*/</code>): Provide a comprehensive answer.</li> </ol> <p>Implementation details for ReActPlanner:</p> <ul> <li><code>BuildPlanningInstruction</code>: Returns a comprehensive instruction that includes high-level guidance, planning requirements, reasoning requirements, etc., guiding the model to output using labeled format.</li> <li><code>ProcessPlanningResponse</code>: Filters tool calls with empty names. If the content contains the <code>/*FINAL_ANSWER*/</code> tag, only the final answer part is retained; otherwise, the original content is returned, separating planning content from the final answer.</li> </ul> <p>Usage example:</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/agent/llmagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/openai\"\n    \"trpc.group/trpc-go/trpc-agent-go/planner/react\"\n    \"trpc.group/trpc-go/trpc-agent-go/tool/function\"\n)\n\n// Create model instance.\nmodelInstance := openai.New(\"gpt-4o-mini\")\n\n// Create tool.\nsearchTool := function.NewFunctionTool(\n    searchFunction,\n    function.WithName(\"search\"),\n    function.WithDescription(\"Search for information on a given topic\"),\n)\n\n// Create ReActPlanner.\nplanner := react.New()\n\n// Create LLMAgent and configure Planner.\nllmAgent := llmagent.New(\n    \"react-agent\",\n    llmagent.WithModel(modelInstance),\n    llmagent.WithDescription(\"An AI assistant that uses structured planning\"),\n    llmagent.WithInstruction(\"Follow a structured approach to solve problems\"),\n    llmagent.WithPlanner(planner), // Configure Planner.\n    llmagent.WithTools([]tool.Tool{searchTool}), // Configure tools.\n)\n</code></pre> <p>For complete code examples, please refer to examples/react.</p>"},{"location":"planner/#custom-planner","title":"Custom Planner","text":"<p>In addition to the two Planner implementations provided by the framework, you can also create a custom Planner by implementing the <code>Planner</code> interface to meet specific needs:</p> <pre><code>type customPlanner struct {\n    // Custom configuration.\n}\n\nfunc (p *customPlanner) BuildPlanningInstruction(\n    ctx context.Context,\n    invocation *agent.Invocation,\n    llmRequest *model.Request,\n) string {\n    // Return custom planning instruction.\n    return \"Your custom planning instruction\"\n}\n\nfunc (p *customPlanner) ProcessPlanningResponse(\n    ctx context.Context,\n    invocation *agent.Invocation,\n    response *model.Response,\n) *model.Response {\n    // Process response.\n    return response\n}\n\n// Create LLMAgent and configure custom Planner.\nllmAgent := llmagent.New(\n    \"react-agent\",\n    llmagent.WithModel(modelInstance),\n    llmagent.WithDescription(\"An AI assistant that uses structured planning\"),\n    llmagent.WithInstruction(\"Follow a structured approach to solve problems\"),\n    llmagent.WithPlanner(&amp;customPlanner{}),      // Configure Planner.\n    llmagent.WithTools([]tool.Tool{searchTool}), // Configure tools.\n)\n</code></pre>"},{"location":"runner/","title":"Runner Component User Guide","text":""},{"location":"runner/#overview","title":"Overview","text":"<p>Runner provides the interface to run Agents, responsible for session management and event stream processing. The core responsibilities of Runner are: obtain or create sessions, generate an Invocation ID, call Agent.Run, process the returned event stream, and append non-partial response events to the session.</p>"},{"location":"runner/#key-features","title":"\ud83c\udfaf Key Features","text":"<ul> <li>\ud83d\udcbe Session Management: Obtain/create sessions via sessionService, using inmemory.NewSessionService() by default.</li> <li>\ud83d\udd04 Event Handling: Receive Agent event streams and append non-partial response events to the session.</li> <li>\ud83c\udd94 ID Generation: Automatically generate Invocation IDs and event IDs.</li> <li>\ud83d\udcca Observability Integration: Integrates telemetry/trace to automatically record spans.</li> <li>\u2705 Completion Event: Generates a runner-completion event after the Agent event stream ends.</li> </ul>"},{"location":"runner/#architecture","title":"Architecture","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502       Runner        \u2502  - Session management.\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  - Event stream processing.\n          \u2502\n          \u2502 r.agent.Run(ctx, invocation)\n          \u2502\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502       Agent         \u2502  - Receives Invocation.\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  - Returns &lt;-chan *event.Event.\n          \u2502\n          \u2502 Implementation is determined by the Agent.\n          \u2502\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502    Agent Impl       \u2502  e.g., LLMAgent, ChainAgent.\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"runner/#quick-start","title":"\ud83d\ude80 Quick Start","text":""},{"location":"runner/#requirements","title":"\ud83d\udccb Requirements","text":"<ul> <li>Go 1.21 or later.</li> <li>Valid LLM API key (OpenAI-compatible interface).</li> <li>Redis (optional, for distributed session management).</li> </ul>"},{"location":"runner/#minimal-example","title":"\ud83d\udca1 Minimal Example","text":"<pre><code>package main\n\nimport (\n    \"context\"\n    \"fmt\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/agent\"\n    \"trpc.group/trpc-go/trpc-agent-go/agent/llmagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/model\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/openai\"\n    \"trpc.group/trpc-go/trpc-agent-go/runner\"\n)\n\nfunc main() {\n    // 1. Create model.\n    llmModel := openai.New(\"DeepSeek-V3-Online-64K\")\n\n    // 2. Create Agent.\n    a := llmagent.New(\"assistant\",\n        llmagent.WithModel(llmModel),\n        llmagent.WithInstruction(\"You are a helpful AI assistant.\"),\n        llmagent.WithGenerationConfig(model.GenerationConfig{Stream: true}), // Enable streaming output.\n    )\n\n    // 3. Create Runner.\n    r := runner.NewRunner(\"my-app\", a)\n    defer r.Close()  // Ensure cleanup (trpc-agent-go &gt;= v0.5.0)\n\n    // 4. Run conversation.\n    ctx := context.Background()\n    userMessage := model.NewUserMessage(\"Hello!\")\n\n    eventChan, err := r.Run(ctx, \"user1\", \"session1\", userMessage, agent.WithRequestID(\"request-ID\"))\n    if err != nil {\n        panic(err)\n    }\n\n    // 5. Handle responses.\n    for event := range eventChan {\n        if event.Error != nil {\n            fmt.Printf(\"Error: %s\\n\", event.Error.Message)\n            continue\n        }\n\n        if len(event.Response.Choices) &gt; 0 {\n            fmt.Print(event.Response.Choices[0].Delta.Content)\n        }\n\n        // Recommended: stop when Runner emits its completion event.\n        if event.IsRunnerCompletion() {\n            break\n        }\n    }\n}\n</code></pre>"},{"location":"runner/#run-the-example","title":"\ud83d\ude80 Run the Example","text":"<pre><code># Enter the example directory.\ncd examples/runner\n\n# Set API key.\nexport OPENAI_API_KEY=\"your-api-key\"\n\n# Basic run.\ngo run main.go\n\n# Use Redis session.\ndocker run -d -p 6379:6379 redis:alpine\ngo run main.go -session redis\n\n# Custom model.\ngo run main.go -model \"gpt-4o-mini\"\n</code></pre>"},{"location":"runner/#interactive-features","title":"\ud83d\udcac Interactive Features","text":"<p>After running the example, the following special commands are supported:</p> <ul> <li><code>/history</code> - Ask AI to show conversation history.</li> <li><code>/new</code> - Start a new session (reset conversation context).</li> <li><code>/exit</code> - End the conversation.</li> </ul> <p>When the AI uses tools, detailed invocation processes will be displayed:</p> <pre><code>\ud83d\udd27 Tool Call:\n   \u2022 calculator (ID: call_abc123)\n     Params: {\"operation\":\"multiply\",\"a\":25,\"b\":4}\n\n\ud83d\udd04 Executing...\n\u2705 Tool Response (ID: call_abc123): {\"operation\":\"multiply\",\"a\":25,\"b\":4,\"result\":100}\n\n\ud83e\udd16 Assistant: I calculated 25 \u00d7 4 = 100 for you.\n</code></pre>"},{"location":"runner/#core-api","title":"\ud83d\udd27 Core API","text":""},{"location":"runner/#create-runner","title":"Create Runner","text":"<pre><code>// Basic creation.\nr := runner.NewRunner(appName, agent, options...)\n\n// Common options.\nr := runner.NewRunner(\"my-app\", agent,\n    runner.WithSessionService(sessionService),  // Session service.\n)\n</code></pre>"},{"location":"runner/#run-conversation","title":"Run Conversation","text":"<pre><code>// Execute a single conversation.\neventChan, err := r.Run(ctx, userID, sessionID, message, options...)\n</code></pre>"},{"location":"runner/#resume-interrupted-runs-tools-first-resume","title":"Resume Interrupted Runs (tools-first resume)","text":"<p>In long-running conversations, users may interrupt the agent while it is still in a tool-calling phase (for example, the last message in the session is an assistant message with <code>tool_calls</code>, but no tool result has been written yet). When you later reuse the same <code>sessionID</code>, you can ask the Runner to resume from that point instead of asking the model to repeat the tool calls:</p> <pre><code>eventChan, err := r.Run(\n    ctx,\n    userID,\n    sessionID,\n    model.Message{},                // no new user message\n    agent.WithResume(true),         // enable resume mode\n)\n</code></pre> <p>When <code>WithResume(true)</code> is set:</p> <ul> <li>Runner inspects the latest persisted session event.</li> <li>If the last event is an assistant response that contains <code>tool_calls</code> and   there is no later tool result, Runner will execute those pending tools first   (using the same tool set and callbacks as a normal step) and persist the   tool results into the session.</li> <li>After tools finish, the normal LLM cycle continues using the updated session   history, so the model sees both the original tool calls and their results.</li> </ul> <p>If the last event is a user or tool message (or a plain assistant reply without <code>tool_calls</code>), <code>WithResume(true)</code> is a no-op and the flow behaves like today\u2019s <code>Run</code> call.</p>"},{"location":"runner/#provide-conversation-history-auto-seed-session-reuse","title":"Provide Conversation History (auto-seed + session reuse)","text":"<p>If your upstream service maintains the conversation and you want the agent to see that context, you can pass a full history (<code>[]model.Message</code>) directly. The runner will seed an empty session with that history automatically and then merge in new session events.</p> <p>Option A: Use the convenience helper <code>runner.RunWithMessages</code></p> <pre><code>msgs := []model.Message{\n    model.NewSystemMessage(\"You are a helpful assistant.\"),\n    model.NewUserMessage(\"First user input\"),\n    model.NewAssistantMessage(\"Previous assistant reply\"),\n    model.NewUserMessage(\"What\u2019s the next step?\"),\n}\n\nch, err := runner.RunWithMessages(ctx, r, userID, sessionID, msgs, agent.WithRequestID(\"request-ID\"))\n</code></pre> <p>Example: <code>examples/runwithmessages</code> (uses <code>RunWithMessages</code>; runner auto-seeds and continues reusing the session)</p> <p>Option B: Pass via RunOption explicitly (same philosophy as ADK Python)</p> <pre><code>msgs := []model.Message{ /* as above */ }\nch, err := r.Run(ctx, userID, sessionID, model.Message{}, agent.WithMessages(msgs))\n</code></pre> <p>When <code>[]model.Message</code> is provided, the runner persists that history into the session on first use (if empty). The content processor does not read this option; it only derives messages from session events (or falls back to the single <code>invocation.Message</code> if the session has no events). <code>RunWithMessages</code> still sets <code>invocation.Message</code> to the latest user turn so graph/flow agents that inspect it continue to work.</p>"},{"location":"runner/#detecting-end-of-run-and-reading-final-output-graph-friendly","title":"\u2705 Detecting End-of-Run and Reading Final Output (Graph-friendly)","text":"<p>When driving a GraphAgent workflow, the LLM\u2019s \u201cfinal response\u201d is not the end of the workflow\u2014nodes like <code>output</code> may still be pending. Instead of checking <code>Response.IsFinalResponse()</code>, always stop on the Runner\u2019s terminal completion event:</p> <pre><code>for e := range eventChan {\n    // ... print streaming chunks, etc.\n    if e.IsRunnerCompletion() {\n        break\n    }\n}\n</code></pre> <p>For convenience, Runner now propagates the graph\u2019s final snapshot into this last event. You can extract the final textual output via <code>graph.StateKeyLastResponse</code>:</p> <pre><code>import \"trpc.group/trpc-go/trpc-agent-go/graph\"\n\nfor e := range eventChan {\n    if e.IsRunnerCompletion() {\n        if b, ok := e.StateDelta[graph.StateKeyLastResponse]; ok {\n            var final string\n            _ = json.Unmarshal(b, &amp;final)\n            fmt.Println(\"\\nFINAL:\", final)\n        }\n        break\n    }\n}\n</code></pre> <p>This keeps application code simple and consistent across Agent types while still preserving detailed graph events for advanced use.</p>"},{"location":"runner/#session-management","title":"\ud83d\udcbe Session Management","text":""},{"location":"runner/#in-memory-session-default","title":"In-memory Session (Default)","text":"<pre><code>import \"trpc.group/trpc-go/trpc-agent-go/session/inmemory\"\n\nsessionService := inmemory.NewSessionService()\nr := runner.NewRunner(\"app\", agent,\n    runner.WithSessionService(sessionService))\n</code></pre>"},{"location":"runner/#redis-session-distributed","title":"Redis Session (Distributed)","text":"<pre><code>import \"trpc.group/trpc-go/trpc-agent-go/session/redis\"\n\n// Create Redis session service.\nsessionService, err := redis.NewService(\n    redis.WithRedisClientURL(\"redis://localhost:6379\"))\n\nr := runner.NewRunner(\"app\", agent,\n    runner.WithSessionService(sessionService))\n</code></pre>"},{"location":"runner/#session-configuration","title":"Session Configuration","text":"<pre><code>// Configuration options supported by Redis.\nsessionService, err := redis.NewService(\n    redis.WithRedisClientURL(\"redis://localhost:6379\"),\n    redis.WithSessionEventLimit(1000),         // Limit number of session events.\n    // redis.WithRedisInstance(\"redis-instance\"), // Or use an instance name.\n)\n</code></pre>"},{"location":"runner/#agent-configuration","title":"\ud83e\udd16 Agent Configuration","text":"<p>Runner's core responsibility is to manage the Agent execution flow. A created Agent needs to be executed via Runner.</p>"},{"location":"runner/#basic-agent-creation","title":"Basic Agent Creation","text":"<pre><code>// Create a basic Agent (see agent.md for detailed configuration).\nagent := llmagent.New(\"assistant\",\n    llmagent.WithModel(model),\n    llmagent.WithInstruction(\"You are a helpful AI assistant.\"))\n\n// Execute Agent with Runner.\nr := runner.NewRunner(\"my-app\", agent)\n</code></pre>"},{"location":"runner/#switch-agents-per-request","title":"Switch Agents Per Request","text":"<p>Runner can register multiple optional agents at construction time and pick one per Run:</p> <pre><code>reader := llmagent.New(\"agent1\", llmagent.WithModel(model))\nwriter := llmagent.New(\"agent2\", llmagent.WithModel(model))\n\nr := runner.NewRunner(\"my-app\", reader, // Use reader as the default agent.\n    runner.WithAgent(\"writer\", writer), // Register an optional agent by name.\n)\n\n// Use the default reader agent.\nch, err := r.Run(ctx, userID, sessionID, msg)\n\n// Pick the writer agent by name.\nch, err = r.Run(ctx, userID, sessionID, msg, agent.WithAgentByName(\"writer\"))\n\n// Override with an instance directly (no pre-registration needed).\ncustom := llmagent.New(\"custom\", llmagent.WithModel(model))\nch, err = r.Run(ctx, userID, sessionID, msg, agent.WithAgent(custom))\n</code></pre> <ul> <li><code>runner.NewRunner(\"my-app\", agent)</code>: Set the default agent when creating the Runner.</li> <li><code>runner.WithAgent(\"agentName\", agent)</code>: Pre-register an agent by name so later requests can switch via name.</li> <li><code>agent.WithAgentByName(\"agentName\")</code>: Choose a registered agent by name for a single request without changing the default.</li> <li><code>agent.WithAgent(agent)</code>: Provide an agent instance directly for a single request; highest priority and no pre-registration needed.</li> </ul> <p>Agent selection priority: <code>agent.WithAgent</code> &gt; <code>agent.WithAgentByName</code> &gt; default agent set at construction. </p> <p>The selected agent name is used as the event author and is recorded via <code>appid.RegisterRunner</code> for observability.</p>"},{"location":"runner/#generation-configuration","title":"Generation Configuration","text":"<p>Runner passes generation configuration to the Agent:</p> <pre><code>// Helper functions.\nfunc intPtr(i int) *int           { return &amp;i }\nfunc floatPtr(f float64) *float64 { return &amp;f }\n\ngenConfig := model.GenerationConfig{\n    MaxTokens:   intPtr(2000),\n    Temperature: floatPtr(0.7),\n    Stream:      true,  // Enable streaming output.\n}\n\nagent := llmagent.New(\"assistant\",\n    llmagent.WithModel(model),\n    llmagent.WithGenerationConfig(genConfig))\n</code></pre>"},{"location":"runner/#tool-integration","title":"Tool Integration","text":"<p>Tool configuration is done inside the Agent, while Runner is responsible for running the Agent with tools:</p> <pre><code>// Create tools (see tool.md for detailed configuration).\ntools := []tool.Tool{\n    function.NewFunctionTool(myFunction, function.WithName(\"my_tool\")),\n    // More tools...\n}\n\n// Add tools to the Agent.\nagent := llmagent.New(\"assistant\",\n    llmagent.WithModel(model),\n    llmagent.WithTools(tools))\n\n// Runner runs the Agent configured with tools.\nr := runner.NewRunner(\"my-app\", agent)\n</code></pre> <p>Tool invocation flow: Runner itself does not directly handle tool invocation. The flow is as follows:</p> <ol> <li>Pass tools: Runner passes context to the Agent via Invocation.</li> <li>Agent processing: Agent.Run handles the tool invocation logic.</li> <li>Event forwarding: Runner receives the event stream returned by the Agent and forwards it.</li> <li>Session recording: Append non-partial response events to the session.</li> </ol>"},{"location":"runner/#multi-agent-support","title":"Multi-Agent Support","text":"<p>Runner can execute complex multi-Agent structures (see multiagent.md for details):</p> <pre><code>import \"trpc.group/trpc-go/trpc-agent-go/agent/chainagent\"\n\n// Create a multi-Agent pipeline.\nmultiAgent := chainagent.New(\"pipeline\",\n    chainagent.WithSubAgents([]agent.Agent{agent1, agent2}))\n\n// Execute with the same Runner.\nr := runner.NewRunner(\"multi-app\", multiAgent)\n</code></pre>"},{"location":"runner/#event-processing","title":"\ud83d\udcca Event Processing","text":""},{"location":"runner/#event-types","title":"Event Types","text":"<pre><code>import \"trpc.group/trpc-go/trpc-agent-go/event\"\n\nfor event := range eventChan {\n    // Error event.\n    if event.Error != nil {\n        fmt.Printf(\"Error: %s\\n\", event.Error.Message)\n        continue\n    }\n\n    // Streaming content.\n    if len(event.Response.Choices) &gt; 0 {\n        choice := event.Response.Choices[0]\n        fmt.Print(choice.Delta.Content)\n    }\n\n    // Tool invocation.\n    if len(event.Response.Choices) &gt; 0 &amp;&amp; len(event.Response.Choices[0].Message.ToolCalls) &gt; 0 {\n        for _, toolCall := range event.Response.Choices[0].Message.ToolCalls {\n            fmt.Printf(\"Call tool: %s\\n\", toolCall.Function.Name)\n        }\n    }\n\n    // Completion event.\n    if event.Done {\n        break\n    }\n}\n</code></pre>"},{"location":"runner/#complete-event-handling-example","title":"Complete Event Handling Example","text":"<pre><code>import (\n    \"fmt\"\n    \"strings\"\n)\n\nfunc processEvents(eventChan &lt;-chan *event.Event) error {\n    var fullResponse strings.Builder\n\n    for event := range eventChan {\n        // Handle errors.\n        if event.Error != nil {\n            return fmt.Errorf(\"Event error: %w\", event.Error)\n        }\n\n        // Handle tool calls.\n        if len(event.Response.Choices) &gt; 0 &amp;&amp; len(event.Response.Choices[0].Message.ToolCalls) &gt; 0 {\n            fmt.Println(\"\ud83d\udd27 Tool Call:\")\n            for _, toolCall := range event.Response.Choices[0].Message.ToolCalls {\n                fmt.Printf(\"  \u2022 %s (ID: %s)\\n\",\n                    toolCall.Function.Name, toolCall.ID)\n                fmt.Printf(\"    Params: %s\\n\",\n                    string(toolCall.Function.Arguments))\n            }\n        }\n\n        // Handle tool responses.\n        if event.Response != nil {\n            for _, choice := range event.Response.Choices {\n                if choice.Message.Role == model.RoleTool {\n                    fmt.Printf(\"\u2705 Tool Response (ID: %s): %s\\n\",\n                        choice.Message.ToolID, choice.Message.Content)\n                }\n            }\n        }\n\n        // Handle streaming content.\n        if len(event.Response.Choices) &gt; 0 {\n            content := event.Response.Choices[0].Delta.Content\n            if content != \"\" {\n                fmt.Print(content)\n                fullResponse.WriteString(content)\n            }\n        }\n\n        if event.Done {\n            fmt.Println() // New line.\n            break\n        }\n    }\n\n    return nil\n}\n</code></pre>"},{"location":"runner/#execution-context-management","title":"\ud83d\udd2e Execution Context Management","text":"<p>Runner creates and manages the Invocation structure:</p> <pre><code>// The Invocation created by Runner contains the following fields.\ninvocation := agent.NewInvocation(\n    agent.WithInvocationAgent(r.agent),                               // Agent instance.\n    agent.WithInvocationSession(&amp;session.Session{ID: \"session-001\"}), // Session object.\n    agent.WithInvocationEndInvocation(false),                         // End flag.\n    agent.WithInvocationMessage(model.NewUserMessage(\"User input\")),  // User message.\n    agent.WithInvocationRunOptions(ro),                               // Run options.\n)\n// Note: Invocation also includes other fields such as AgentName, Branch, Model,\n// TransferInfo, AgentCallbacks, ModelCallbacks, ToolCallbacks, etc.,\n// but these fields are used and managed internally by the Agent.\n</code></pre>"},{"location":"runner/#best-practices","title":"\u2705 Best Practices","text":""},{"location":"runner/#error-handling","title":"Error Handling","text":"<pre><code>// Handle errors from Runner.Run.\neventChan, err := r.Run(ctx, userID, sessionID, message, agent.WithRequestID(\"request-ID\"))\nif err != nil {\n    log.Printf(\"Runner execution failed: %v\", err)\n    return err\n}\n\n// Handle errors in the event stream.\nfor event := range eventChan {\n    if event.Error != nil {\n        log.Printf(\"Event error: %s\", event.Error.Message)\n        continue\n    }\n    // Handle normal events.\n}\n</code></pre>"},{"location":"runner/#stopping-a-run-safely","title":"Stopping a Run Safely","text":"<ul> <li>Cancel the context: Wrap <code>runner.Run</code> with <code>context.WithCancel</code>.   Call <code>cancel()</code> when turn count or token budget is hit. <code>llmflow</code>   treats <code>context.Canceled</code> as graceful exit and closes the agent event   channel, so the runner loop finishes cleanly without blocking writers.</li> </ul> <pre><code>ctx, cancel := context.WithCancel(context.Background())\ndefer cancel()\n\neventCh, err := r.Run(ctx, userID, sessionID, message)\nif err != nil {\n    return err\n}\n\nturns := 0\nfor evt := range eventCh {\n    if evt.Error != nil {\n        log.Printf(\"event error: %s\", evt.Error.Message)\n        continue\n    }\n    // ... handle evt ...\n    if evt.IsFinalResponse() {\n        break\n    }\n    turns++\n    if turns &gt;= maxTurns {\n        cancel() // stop further model/tool calls.\n    }\n}\n</code></pre> <ul> <li>Emit a stop event: Inside custom processors or tools, return <code>agent.NewStopError(\"reason\")</code>. <code>llmflow</code> converts it into a   <code>stop_agent_error</code> event and stops the flow. Still pair with context cancel for hard cutoffs.</li> </ul> <ul> <li>Avoid breaking the runner loop directly: Breaking the event-loop reader leaves the agent goroutine running and can block on channel   writes. Prefer context cancellation or <code>StopError</code>.</li> </ul>"},{"location":"runner/#resource-management","title":"Resource Management","text":""},{"location":"runner/#closing-runner-important","title":"\ud83d\udd12 Closing Runner (Important)","text":"<p>You MUST call <code>Close()</code> when the Runner is no longer needed to prevent goroutine leaks(<code>trpc-agent-go &gt;= v0.5.0</code>).</p> <p>Runner Only Closes Resources It Created</p> <p>When a Runner is created without providing a Session Service, it automatically creates a default inmemory Session Service. This service starts background goroutines internally (for asynchronous summary processing, TTL-based session cleanup, etc.). Runner only manages the lifecycle of this self-created inmemory Session Service. If you provide your own Session Service via <code>WithSessionService()</code>, you are responsible for managing its lifecycle\u2014Runner won't close it.</p> <p>If you don't call <code>Close()</code> on a Runner that owns an inmemory Session Service, the background goroutines will run forever, causing resource leaks.</p> <p>Recommended Practice:</p> <pre><code>// \u2705 Recommended: Use defer to ensure cleanup\nr := runner.NewRunner(\"my-app\", agent)\ndefer r.Close()  // Ensure cleanup on function exit (trpc-agent-go &gt;= v0.5.0)\n\n// Use the runner\neventChan, err := r.Run(ctx, userID, sessionID, message)\nif err != nil {\n    return err\n}\n\nfor event := range eventChan {\n    // Process events\n    if event.IsRunnerCompletion() {\n        break\n    }\n}\n</code></pre> <p>When You Provide Your Own Session Service:</p> <pre><code>// You create and manage the session service lifecycle\nsessionService := redis.NewService(redis.WithRedisClientURL(\"redis://localhost:6379\"))\ndefer sessionService.Close()  // YOU are responsible for closing it\n\n// Runner uses but doesn't own this session service\nr := runner.NewRunner(\"my-app\", agent,\n    runner.WithSessionService(sessionService))\ndefer r.Close()  // This will NOT close sessionService (you provided it) (trpc-agent-go &gt;= v0.5.0)\n\n// ... use the runner\n</code></pre> <p>Long-Running Services:</p> <pre><code>type Service struct {\n    runner runner.Runner\n    sessionService session.Service  // If you manage it yourself\n}\n\nfunc NewService() *Service {\n    r := runner.NewRunner(\"my-app\", agent)\n    return &amp;Service{runner: r}\n}\n\nfunc (s *Service) Start() error {\n    // Service startup logic\n    return nil\n}\n\n// Call Close when shutting down the service\nfunc (s *Service) Stop() error {\n    // Close runner (which closes its owned inmemory session service)\n    // trpc-agent-go &gt;= v0.5.0\n    if err := s.runner.Close(); err != nil {\n        return err\n    }\n\n    // If you provided your own session service, close it here\n    if s.sessionService != nil {\n        return s.sessionService.Close()\n    }\n\n    return nil\n}\n</code></pre> <p>Important Notes:</p> <ul> <li>\u2705 <code>Close()</code> is idempotent; calling it multiple times is safe</li> <li>\u2705 Runner only closes the inmemory Session Service it creates by default</li> <li>\u2705 If you provide your own Session Service via <code>WithSessionService()</code>, Runner won't close it (you manage it yourself)</li> <li>\u274c Not calling <code>Close()</code> when Runner owns an inmemory Session Service will cause goroutine leaks</li> </ul>"},{"location":"runner/#context-lifecycle-control","title":"Context Lifecycle Control","text":"<pre><code>// Use context to control the lifecycle of a single run\nctx, cancel := context.WithCancel(context.Background())\ndefer cancel()\n\n// Ensure all events are consumed\neventChan, err := r.Run(ctx, userID, sessionID, message)\nif err != nil {\n    return err\n}\n\nfor event := range eventChan {\n    // Process events\n    if event.Done {\n        break\n    }\n}\n</code></pre>"},{"location":"runner/#health-check","title":"Health Check","text":"<pre><code>import (\n    \"context\"\n    \"fmt\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/model\"\n    \"trpc.group/trpc-go/trpc-agent-go/runner\"\n)\n\n// Check whether Runner works properly.\nfunc checkRunner(r runner.Runner, ctx context.Context) error {\n    testMessage := model.NewUserMessage(\"test\")\n    eventChan, err := r.Run(ctx, \"test-user\", \"test-session\", testMessage)\n    if err != nil {\n        return fmt.Errorf(\"Runner.Run failed: %v\", err)\n    }\n\n    // Check the event stream.\n    for event := range eventChan {\n        if event.Error != nil {\n            return fmt.Errorf(\"Received error event: %s\", event.Error.Message)\n        }\n        if event.Done {\n            break\n        }\n    }\n\n    return nil\n}\n</code></pre>"},{"location":"runner/#summary","title":"\ud83d\udcdd Summary","text":"<p>The Runner component is a core part of the tRPC-Agent-Go framework, providing complete conversation management and Agent orchestration capabilities. By properly using session management, tool integration, and event handling, you can build powerful intelligent conversational applications.</p>"},{"location":"session/","title":"Session Management","text":""},{"location":"session/#overview","title":"Overview","text":"<p>tRPC-Agent-Go provides powerful session management capabilities to maintain conversation history and context information during Agent-user interactions. Through automatic persistence of conversation records, intelligent summary compression, and flexible storage backends, session management offers complete infrastructure for building stateful intelligent Agents.</p>"},{"location":"session/#positioning","title":"Positioning","text":"<p>A Session manages the context of the current conversation, with isolation dimensions <code>&lt;appName, userID, SessionID&gt;</code>. It stores user messages, Agent responses, tool call results, and brief summaries generated based on this content within the conversation, supporting multi-turn question-and-answer scenarios.</p> <p>Within the same conversation, it allows for seamless transitions between multiple turns of question-and-answer, preventing users from restating the same question or providing the same parameters in each turn.</p>"},{"location":"session/#key-features","title":"\ud83c\udfaf Key Features","text":"<ul> <li>Context Management: Automatically load conversation history for true multi-turn dialogues</li> <li>Session Summary: Automatically compress long conversation history using LLM while preserving key context and significantly reducing token consumption</li> <li>Event Limiting: Control maximum number of events stored per session to prevent memory overflow</li> <li>TTL Management: Support automatic expiration and cleanup of session data</li> <li>Multiple Storage Backends: Support Memory, Redis, PostgreSQL, MySQL storage</li> <li>Concurrency Safety: Built-in read-write locks ensure safe concurrent access</li> <li>Automatic Management: Automatically handle session creation, loading, and updates after Runner integration</li> <li>Soft Delete Support: PostgreSQL/MySQL support soft delete with data recovery capability</li> </ul>"},{"location":"session/#quick-start","title":"Quick Start","text":""},{"location":"session/#integration-with-runner","title":"Integration with Runner","text":"<p>tRPC-Agent-Go's session management integrates with Runner through <code>runner.WithSessionService</code>. Runner automatically handles session creation, loading, updates, and persistence.</p> <p>Supported Storage Backends: Memory, Redis, PostgreSQL, MySQL</p> <p>Default Behavior: If <code>runner.WithSessionService</code> is not configured, Runner defaults to using memory storage (Memory), and data will be lost after process restarts.</p>"},{"location":"session/#basic-example","title":"Basic Example","text":"<pre><code>package main\n\nimport (\n    \"context\"\n    \"fmt\"\n    \"time\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/agent/llmagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/model\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/openai\"\n    \"trpc.group/trpc-go/trpc-agent-go/runner\"\n    \"trpc.group/trpc-go/trpc-agent-go/session/inmemory\"\n    \"trpc.group/trpc-go/trpc-agent-go/session/summary\" // Optional: required when enabling summary feature\n)\n\nfunc main() {\n    // 1. Create LLM model\n    llm := openai.New(\"gpt-4\", openai.WithAPIKey(\"your-api-key\"))\n\n    // 2. (Optional) Create summarizer - automatically compress long conversation history\n    summarizer := summary.NewSummarizer(\n        llm, // Use same LLM model for summary generation\n        summary.WithChecksAny(                         // Trigger when any condition is met\n            summary.CheckEventThreshold(20),           // Trigger when 20+ new events since last summary\n            summary.CheckTokenThreshold(4000),         // Trigger when 4000+ new tokens since last summary\n            summary.CheckTimeThreshold(5*time.Minute), // Trigger after 5 minutes of inactivity\n        ),\n        summary.WithMaxSummaryWords(200), // Limit summary to 200 words\n    )\n\n    // 3. Create Session Service (optional, defaults to memory storage if not configured)\n    sessionService := inmemory.NewSessionService(\n        inmemory.WithSummarizer(summarizer),     // Optional: inject summarizer\n        inmemory.WithAsyncSummaryNum(2),         // Optional: 2 async workers\n        inmemory.WithSummaryQueueSize(100),      // Optional: queue size 100\n    )\n\n    // 4. Create Agent\n    agent := llmagent.New(\n        \"my-agent\",\n        llmagent.WithModel(llm),\n        llmagent.WithInstruction(\"You are a helpful assistant\"),\n        llmagent.WithAddSessionSummary(true), // Optional: enable summary injection to context\n        // Note: WithAddSessionSummary(true) ignores WithMaxHistoryRuns configuration\n        // Summary includes all history, incremental events fully retained\n    )\n\n    // 5. Create Runner and inject Session Service\n    r := runner.NewRunner(\n        \"my-agent\",\n        agent,\n        runner.WithSessionService(sessionService),\n    )\n\n    // 6. First conversation\n    ctx := context.Background()\n    userMsg1 := model.NewUserMessage(\"My name is Alice\")\n    eventChan, err := r.Run(ctx, \"user123\", \"session-001\", userMsg1)\n    if err != nil {\n        fmt.Printf(\"Error: %v\\n\", err)\n        return\n    }\n    fmt.Print(\"AI: \")\n    for event := range eventChan {\n        if event == nil || event.Response == nil {\n            continue\n        }\n        if event.Response.Error != nil {\n            fmt.Printf(\"\\nError: %s (type: %s)\\n\", event.Response.Error.Message, event.Response.Error.Type)\n            continue\n        }\n        if len(event.Response.Choices) &gt; 0 {\n            choice := event.Response.Choices[0]\n            // Streaming output, prefer Delta.Content, fallback to Message.Content\n            if choice.Delta.Content != \"\" {\n                fmt.Print(choice.Delta.Content)\n            } else if choice.Message.Content != \"\" {\n                fmt.Print(choice.Message.Content)\n            }\n        }\n        if event.IsFinalResponse() {\n            break\n        }\n    }\n    fmt.Println()\n\n    // 7. Second conversation - automatically load history, AI remembers user's name\n    userMsg2 := model.NewUserMessage(\"What's my name?\")\n    eventChan, err = r.Run(ctx, \"user123\", \"session-001\", userMsg2)\n    if err != nil {\n        fmt.Printf(\"Error: %v\\n\", err)\n        return\n    }\n    fmt.Print(\"AI: \")\n    for event := range eventChan {\n        if event == nil || event.Response == nil {\n            continue\n        }\n        if event.Response.Error != nil {\n            fmt.Printf(\"\\nError: %s (type: %s)\\n\", event.Response.Error.Message, event.Response.Error.Type)\n            continue\n        }\n        if len(event.Response.Choices) &gt; 0 {\n            choice := event.Response.Choices[0]\n            // Streaming output, prefer Delta.Content, fallback to Message.Content\n            if choice.Delta.Content != \"\" {\n                fmt.Print(choice.Delta.Content)\n            } else if choice.Message.Content != \"\" {\n                fmt.Print(choice.Message.Content)\n            }\n        }\n        if event.IsFinalResponse() {\n            break\n        }\n    }\n    fmt.Println() // Output: Your name is Alice\n}\n</code></pre>"},{"location":"session/#runner-automatic-capabilities","title":"Runner Automatic Capabilities","text":"<p>After integrating Session Service, Runner automatically provides the following capabilities without needing to manually call any Session API:</p> <ol> <li>Automatic Session Creation: Automatically create session on first conversation (generates UUID if SessionID is empty)</li> <li>Automatic Session Loading: Automatically load historical context at the start of each conversation</li> <li>Automatic Session Updates: Automatically save new events after conversation ends</li> <li>Context Continuity: Automatically inject conversation history into LLM input for multi-turn dialogues</li> <li>Automatic Summary Generation (Optional): Generate summaries asynchronously in background when trigger conditions are met, no manual intervention required</li> </ol>"},{"location":"session/#core-capabilities","title":"Core Capabilities","text":""},{"location":"session/#1-context-management","title":"1\ufe0f\u20e3 Context Management","text":"<p>The core function of session management is to maintain conversation context, ensuring the Agent can remember historical interactions and provide intelligent responses based on history.</p> <p>How it Works:</p> <ul> <li>Automatically save user input and AI responses from each conversation round</li> <li>Automatically load historical events when new conversations begin</li> <li>Runner automatically injects historical context into LLM input</li> </ul> <p>Default Behavior: After Runner integration, context management is fully automated without manual intervention.</p>"},{"location":"session/#2-session-summary","title":"2\ufe0f\u20e3 Session Summary","text":"<p>As conversations continue to grow, maintaining complete event history can consume significant memory and may exceed LLM context window limits. The session summary feature uses LLM to automatically compress historical conversations into concise summaries, significantly reducing memory usage and token consumption while preserving important context.</p> <p>Core Features:</p> <ul> <li>Automatic Triggering: Automatically generate summaries based on event count, token count, or time thresholds</li> <li>Incremental Processing: Only process new events since the last summary, avoiding redundant computation</li> <li>LLM-Driven: Use configured LLM model to generate high-quality, context-aware summaries</li> <li>Non-Destructive: Original events are fully preserved, summaries stored separately</li> <li>Asynchronous Processing: Execute asynchronously in background without blocking conversation flow</li> <li>Flexible Configuration: Support custom trigger conditions, prompts, and word limits</li> </ul> <p>Quick Configuration:</p> <pre><code>import (\n    \"time\"\n    \"trpc.group/trpc-go/trpc-agent-go/session/summary\"\n    \"trpc.group/trpc-go/trpc-agent-go/session/inmemory\"\n)\n\n// 1. Create summarizer\nsummarizer := summary.NewSummarizer(\n    summaryModel,\n    summary.WithChecksAny(                         // Trigger when any condition is met\n        summary.CheckEventThreshold(20),           // Trigger when 20+ new events since last summary\n        summary.CheckTokenThreshold(4000),         // Trigger when 4000+ new tokens since last summary\n        summary.CheckTimeThreshold(5*time.Minute), // Trigger after 5 minutes of inactivity\n    ),\n    summary.WithMaxSummaryWords(200),              // Limit summary to 200 words\n)\n\n// 2. Configure session service\nsessionService := inmemory.NewSessionService(\n    inmemory.WithSummarizer(summarizer),\n    inmemory.WithAsyncSummaryNum(2),               // 2 async workers\n    inmemory.WithSummaryQueueSize(100),            // Queue size 100\n)\n\n// 3. Enable summary injection to Agent\nllmAgent := llmagent.New(\n    \"my-agent\",\n    llmagent.WithModel(llm),\n    llmagent.WithAddSessionSummary(true),          // Enable summary injection\n)\n\n// 4. Create Runner\nr := runner.NewRunner(\"my-agent\", llmAgent,\n    runner.WithSessionService(sessionService))\n</code></pre>"},{"location":"session/#summary-hooks-prepost","title":"Summary hooks (pre/post)","text":"<p>You can inject hooks to tweak summary input or output:</p> <pre><code>summarizer := summary.NewSummarizer(\n    summaryModel,\n    summary.WithPreSummaryHook(func(ctx *summary.PreSummaryHookContext) error {\n        // Optionally modify ctx.Text or ctx.Events before summarization.\n        return nil\n    }),\n    summary.WithPostSummaryHook(func(ctx *summary.PostSummaryHookContext) error {\n        // Optionally modify ctx.Summary before returning to caller.\n        return nil\n    }),\n    summary.WithSummaryHookAbortOnError(true), // Abort when hook returns error (optional).\n)\n</code></pre> <p>Notes:</p> <ul> <li>Pre-hook can mutate <code>ctx.Text</code> (preferred) or <code>ctx.Events</code>; post-hook can mutate <code>ctx.Summary</code>.</li> <li>Default behavior ignores hook errors; enable abort with   <code>WithSummaryHookAbortOnError(true)</code>.</li> </ul> <p>Context Injection Mechanism:</p> <p>After enabling summary, the framework prepends the summary as a system message to the LLM input, while including all incremental events after the summary timestamp to ensure complete context:</p> <pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 System Prompt                           \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Session Summary (system message)        \u2502 \u2190 Compressed version of historical conversations\n\u2502 - Updated at: 2024-01-10 14:30          \u2502   (events before updated_at)\n\u2502 - Includes: Event1 ~ Event20            \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Event 21 (user message)                 \u2502 \u2510\n\u2502 Event 22 (assistant response)           \u2502 \u2502\n\u2502 Event 23 (user message)                 \u2502 \u2502 All new conversations after summary\n\u2502 Event 24 (assistant response)           \u2502 \u2502 (fully retained, no truncation)\n\u2502 ...                                     \u2502 \u2502\n\u2502 Event N (current message)               \u2502 \u2518\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre> <p>Important Note: When <code>WithAddSessionSummary(true)</code> is enabled, the <code>WithMaxHistoryRuns</code> parameter is ignored, and all events after the summary are fully retained.</p> <p>For detailed configuration and advanced usage, see the Session Summary section.</p>"},{"location":"session/#3-event-limiting-eventlimit","title":"3\ufe0f\u20e3 Event Limiting (EventLimit)","text":"<p>Control the maximum number of events stored per session to prevent memory overflow from long conversations.</p> <p>How it Works:</p> <ul> <li>Automatically evict oldest events (FIFO) when limit is exceeded</li> <li>Only affects storage, not business logic</li> <li>Applies to all storage backends</li> </ul> <p>Configuration Example:</p> <pre><code>// Limit each session to maximum 500 events\nsessionService := inmemory.NewSessionService(\n    inmemory.WithSessionEventLimit(500),\n)\n</code></pre> <p>Recommended Configuration:</p> Scenario Recommended Value Description Short-term conversations 100-200 Customer service, single tasks Medium-term sessions 500-1000 Daily assistant, multi-turn collaboration Long-term sessions 1000-2000 Personal assistant, ongoing projects (use with summary) Debug/testing 50-100 Quick validation, reduce noise"},{"location":"session/#4-ttl-management-auto-expiration","title":"4\ufe0f\u20e3 TTL Management (Auto-Expiration)","text":"<p>Support setting Time To Live (TTL) for session data, automatically cleaning expired data.</p> <p>Supported TTL Types:</p> <ul> <li>SessionTTL: Expiration time for session state and events</li> <li>AppStateTTL: Expiration time for application-level state</li> <li>UserStateTTL: Expiration time for user-level state</li> </ul> <p>Configuration Example:</p> <pre><code>sessionService := inmemory.NewSessionService(\n    inmemory.WithSessionTTL(30*time.Minute),     // Session expires after 30 minutes of inactivity\n    inmemory.WithAppStateTTL(24*time.Hour),      // App state expires after 24 hours\n    inmemory.WithUserStateTTL(7*24*time.Hour),   // User state expires after 7 days\n)\n</code></pre> <p>Expiration Behavior:</p> Storage Type Expiration Mechanism Auto Cleanup Memory Periodic scanning + access-time checking Yes Redis Redis native TTL Yes PostgreSQL Periodic scanning (soft delete or hard delete) Yes MySQL Periodic scanning (soft delete or hard delete) Yes"},{"location":"session/#storage-backend-comparison","title":"Storage Backend Comparison","text":"<p>tRPC-Agent-Go provides four session storage backends to meet different scenario requirements:</p> Storage Type Use Case Advantages Disadvantages Memory Development/testing, small-scale Simple and fast, no external dependencies Data not persistent, no distributed support Redis Production, distributed High performance, distributed support, auto-expiration Requires Redis service PostgreSQL Production, complex queries Relational database, supports complex queries, JSONB Relatively heavy, requires database MySQL Production, complex queries Widely used, supports complex queries, JSON Relatively heavy, requires database"},{"location":"session/#memory-storage","title":"Memory Storage","text":"<p>Suitable for development environments and small-scale applications, no external dependencies required, ready to use out of the box.</p>"},{"location":"session/#configuration-options","title":"Configuration Options","text":"<ul> <li><code>WithSessionEventLimit(limit int)</code>: Set maximum number of events stored per session. Default is 1000, evicts old events when exceeded.</li> <li><code>WithSessionTTL(ttl time.Duration)</code>: Set TTL for session state and event list. Default is 0 (no expiration).</li> <li><code>WithAppStateTTL(ttl time.Duration)</code>: Set TTL for application-level state. Default is 0 (no expiration).</li> <li><code>WithUserStateTTL(ttl time.Duration)</code>: Set TTL for user-level state. Default is 0 (no expiration).</li> <li><code>WithCleanupInterval(interval time.Duration)</code>: Set interval for automatic cleanup of expired data. Default is 0 (auto-determined), if any TTL is configured, default cleanup interval is 5 minutes.</li> <li><code>WithSummarizer(s summary.SessionSummarizer)</code>: Inject session summarizer.</li> <li><code>WithAsyncSummaryNum(num int)</code>: Set number of summary processing workers. Default is 3.</li> <li><code>WithSummaryQueueSize(size int)</code>: Set summary task queue size. Default is 100.</li> <li><code>WithSummaryJobTimeout(timeout time.Duration)</code>: Set timeout for single summary task. Default is 30 seconds.</li> </ul>"},{"location":"session/#basic-configuration-example","title":"Basic Configuration Example","text":"<pre><code>import \"trpc.group/trpc-go/trpc-agent-go/session/inmemory\"\n\n// Default configuration (development environment)\nsessionService := inmemory.NewSessionService()\n// Effect:\n// - Each session max 1000 events\n// - All data never expires\n// - No automatic cleanup\n\n// Production environment configuration\nsessionService := inmemory.NewSessionService(\n    inmemory.WithSessionEventLimit(500),\n    inmemory.WithSessionTTL(30*time.Minute),\n    inmemory.WithAppStateTTL(24*time.Hour),\n    inmemory.WithUserStateTTL(7*24*time.Hour),\n    inmemory.WithCleanupInterval(10*time.Minute),\n)\n// Effect:\n// - Each session max 500 events\n// - Session expires after 30 minutes of inactivity\n// - App state expires after 24 hours\n// - User state expires after 7 days\n// - Cleanup every 10 minutes\n</code></pre>"},{"location":"session/#use-with-summary","title":"Use with Summary","text":"<pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/session/inmemory\"\n    \"trpc.group/trpc-go/trpc-agent-go/session/summary\"\n)\n\n// Create summarizer\nsummarizer := summary.NewSummarizer(\n    summaryModel,\n    summary.WithEventThreshold(20),\n    summary.WithMaxSummaryWords(200),\n)\n\n// Create session service and inject summarizer\nsessionService := inmemory.NewSessionService(\n    inmemory.WithSessionEventLimit(1000),\n    inmemory.WithSummarizer(summarizer),\n    inmemory.WithAsyncSummaryNum(2),\n    inmemory.WithSummaryQueueSize(100),\n    inmemory.WithSummaryJobTimeout(30*time.Second),\n)\n</code></pre>"},{"location":"session/#redis-storage","title":"Redis Storage","text":"<p>Suitable for production environments and distributed applications, provides high performance and auto-expiration capabilities.</p>"},{"location":"session/#configuration-options_1","title":"Configuration Options","text":"<ul> <li><code>WithRedisClientURL(url string)</code>: Create Redis client via URL. Format: <code>redis://[username:password@]host:port[/database]</code>.</li> <li><code>WithRedisInstance(instanceName string)</code>: Use pre-configured Redis instance. Note: <code>WithRedisClientURL</code> has higher priority than <code>WithRedisInstance</code>.</li> <li><code>WithSessionEventLimit(limit int)</code>: Set maximum number of events stored per session. Default is 1000.</li> <li><code>WithSessionTTL(ttl time.Duration)</code>: Set TTL for session state and events. Default is 0 (no expiration).</li> <li><code>WithAppStateTTL(ttl time.Duration)</code>: Set TTL for application-level state. Default is 0 (no expiration).</li> <li><code>WithUserStateTTL(ttl time.Duration)</code>: Set TTL for user-level state. Default is 0 (no expiration).</li> <li><code>WithSummarizer(s summary.SessionSummarizer)</code>: Inject session summarizer.</li> <li><code>WithAsyncSummaryNum(num int)</code>: Set number of summary processing workers. Default is 3.</li> <li><code>WithSummaryQueueSize(size int)</code>: Set summary task queue size. Default is 100.</li> <li><code>WithExtraOptions(extraOptions ...interface{})</code>: Set extra options for Redis client.</li> </ul>"},{"location":"session/#basic-configuration-example_1","title":"Basic Configuration Example","text":"<pre><code>import \"trpc.group/trpc-go/trpc-agent-go/session/redis\"\n\n// Create using URL (recommended)\nsessionService, err := redis.NewService(\n    redis.WithRedisClientURL(\"redis://username:password@127.0.0.1:6379/0\"),\n    redis.WithSessionEventLimit(500),\n)\n\n// Complete production environment configuration\nsessionService, err := redis.NewService(\n    redis.WithRedisClientURL(\"redis://localhost:6379/0\"),\n    redis.WithSessionEventLimit(1000),\n    redis.WithSessionTTL(30*time.Minute),\n    redis.WithAppStateTTL(24*time.Hour),\n    redis.WithUserStateTTL(7*24*time.Hour),\n)\n// Effect:\n// - Connect to local Redis database 0\n// - Each session max 1000 events\n// - Session auto-expires after 30 minutes of inactivity (Redis TTL)\n// - App state expires after 24 hours\n// - User state expires after 7 days\n// - Uses Redis native TTL mechanism, no manual cleanup needed\n</code></pre>"},{"location":"session/#configuration-reuse","title":"Configuration Reuse","text":"<p>If multiple components need to use the same Redis instance, you can register and reuse:</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/storage\"\n    \"trpc.group/trpc-go/trpc-agent-go/session/redis\"\n)\n\n// Register Redis instance\nredisURL := \"redis://127.0.0.1:6379\"\nstorage.RegisterRedisInstance(\"my-redis-instance\",\n    storage.WithClientBuilderURL(redisURL))\n\n// Use in session service\nsessionService, err := redis.NewService(\n    redis.WithRedisInstance(\"my-redis-instance\"),\n    redis.WithSessionEventLimit(500),\n)\n</code></pre>"},{"location":"session/#use-with-summary_1","title":"Use with Summary","text":"<pre><code>sessionService, err := redis.NewService(\n    redis.WithRedisClientURL(\"redis://localhost:6379\"),\n    redis.WithSessionEventLimit(1000),\n    redis.WithSessionTTL(30*time.Minute),\n\n    // Summary configuration\n    redis.WithSummarizer(summarizer),\n    redis.WithAsyncSummaryNum(4),\n    redis.WithSummaryQueueSize(200),\n)\n</code></pre>"},{"location":"session/#storage-structure","title":"Storage Structure","text":"<pre><code># Application data\nappdata:{appName} -&gt; Hash {key: value}\n\n# User data\nuserdata:{appName}:{userID} -&gt; Hash {key: value}\n\n# Session data\nsession:{appName}:{userID} -&gt; Hash {sessionID: SessionData(JSON)}\n\n# Event records\nevents:{appName}:{userID}:{sessionID} -&gt; SortedSet {score: timestamp, value: Event(JSON)}\n\n# Summary data (optional)\nsummary:{appName}:{userID}:{sessionID}:{filterKey} -&gt; String (JSON)\n</code></pre>"},{"location":"session/#postgresql-storage","title":"PostgreSQL Storage","text":"<p>Suitable for production environments and applications requiring complex queries, provides full relational database capabilities.</p>"},{"location":"session/#configuration-options_2","title":"Configuration Options","text":"<p>Connection Configuration:</p> <ul> <li><code>WithPostgresClientDSN(dsn string)</code>: PostgreSQL DSN connection string (recommended). Supports two formats:<ul> <li>Key-Value format: <code>host=localhost port=5432 user=postgres password=secret dbname=mydb sslmode=disable</code></li> <li>URL format: <code>postgres://user:password@localhost:5432/dbname?sslmode=disable</code></li> </ul> </li> <li><code>WithHost(host string)</code>: PostgreSQL server address. Default is <code>localhost</code>.</li> <li><code>WithPort(port int)</code>: PostgreSQL server port. Default is <code>5432</code>.</li> <li><code>WithUser(user string)</code>: Database username. Default is <code>postgres</code>.</li> <li><code>WithPassword(password string)</code>: Database password. Default is empty string.</li> <li><code>WithDatabase(database string)</code>: Database name. Default is <code>postgres</code>.</li> <li><code>WithSSLMode(sslMode string)</code>: SSL mode. Default is <code>disable</code>. Options: <code>disable</code>, <code>require</code>, <code>verify-ca</code>, <code>verify-full</code>.</li> <li><code>WithPostgresInstance(name string)</code>: Use pre-configured PostgreSQL instance.</li> </ul> <p>Priority: <code>WithPostgresClientDSN</code> &gt; Direct connection settings (<code>WithHost</code>, etc.) &gt; <code>WithPostgresInstance</code></p> <p>Session Configuration:</p> <ul> <li><code>WithSessionEventLimit(limit int)</code>: Maximum events per session. Default is 1000.</li> <li><code>WithSessionTTL(ttl time.Duration)</code>: Session TTL. Default is 0 (no expiration).</li> <li><code>WithAppStateTTL(ttl time.Duration)</code>: App state TTL. Default is 0 (no expiration).</li> <li><code>WithUserStateTTL(ttl time.Duration)</code>: User state TTL. Default is 0 (no expiration).</li> <li><code>WithCleanupInterval(interval time.Duration)</code>: TTL cleanup interval. Default is 5 minutes.</li> <li><code>WithSoftDelete(enable bool)</code>: Enable or disable soft delete. Default is <code>true</code>.</li> </ul> <p>Async Persistence Configuration:</p> <ul> <li><code>WithEnableAsyncPersist(enable bool)</code>: Enable async persistence. Default is <code>false</code>.</li> <li><code>WithAsyncPersisterNum(num int)</code>: Number of async persistence workers. Default is 10.</li> </ul> <p>Summary Configuration:</p> <ul> <li><code>WithSummarizer(s summary.SessionSummarizer)</code>: Inject session summarizer.</li> <li><code>WithAsyncSummaryNum(num int)</code>: Number of summary processing workers. Default is 3.</li> <li><code>WithSummaryQueueSize(size int)</code>: Summary task queue size. Default is 100.</li> <li><code>WithSummaryJobTimeout(timeout time.Duration)</code>: Set timeout for single summary task. Default is 30 seconds.</li> </ul> <p>Schema and Table Configuration:</p> <ul> <li><code>WithSchema(schema string)</code>: Specify schema name.</li> <li><code>WithTablePrefix(prefix string)</code>: Table name prefix.</li> <li><code>WithSkipDBInit(skip bool)</code>: Skip automatic table creation.</li> </ul>"},{"location":"session/#basic-configuration-example_2","title":"Basic Configuration Example","text":"<pre><code>import \"trpc.group/trpc-go/trpc-agent-go/session/postgres\"\n\n// Using DSN connection (recommended)\nsessionService, err := postgres.NewService(\n    postgres.WithPostgresClientDSN(\"postgres://user:password@localhost:5432/mydb?sslmode=disable\"),\n)\n\n// Or using Key-Value format DSN\nsessionService, err := postgres.NewService(\n    postgres.WithPostgresClientDSN(\"host=localhost port=5432 user=postgres password=secret dbname=mydb sslmode=disable\"),\n)\n\n// Using individual configuration options (traditional way)\nsessionService, err := postgres.NewService(\n    postgres.WithHost(\"localhost\"),\n    postgres.WithPort(5432),\n    postgres.WithUser(\"postgres\"),\n    postgres.WithPassword(\"your-password\"),\n    postgres.WithDatabase(\"trpc_sessions\"),\n)\n\n// Complete production environment configuration\nsessionService, err := postgres.NewService(\n    // Connection configuration (DSN recommended)\n    postgres.WithPostgresClientDSN(\"postgres://user:password@localhost:5432/trpc_sessions?sslmode=require\"),\n\n    // Session configuration\n    postgres.WithSessionEventLimit(1000),\n    postgres.WithSessionTTL(30*time.Minute),\n    postgres.WithAppStateTTL(24*time.Hour),\n    postgres.WithUserStateTTL(7*24*time.Hour),\n\n    // TTL cleanup configuration\n    postgres.WithCleanupInterval(10*time.Minute),\n    postgres.WithSoftDelete(true),  // Soft delete mode\n\n    // Async persistence configuration\n    postgres.WithAsyncPersisterNum(4),\n)\n// Effect:\n// - Use SSL encrypted connection\n// - Session expires after 30 minutes of inactivity\n// - Cleanup expired data every 10 minutes (soft delete)\n// - 4 async workers for writes\n</code></pre>"},{"location":"session/#configuration-reuse_1","title":"Configuration Reuse","text":"<pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/storage/postgres\"\n    sessionpg \"trpc.group/trpc-go/trpc-agent-go/session/postgres\"\n)\n\n// Register PostgreSQL instance\npostgres.RegisterPostgresInstance(\"my-postgres-instance\",\n    postgres.WithClientConnString(\"postgres://user:password@localhost:5432/trpc_sessions?sslmode=disable\"),\n)\n\n// Use in session service\nsessionService, err := sessionpg.NewService(\n    sessionpg.WithPostgresInstance(\"my-postgres-instance\"),\n    sessionpg.WithSessionEventLimit(500),\n)\n</code></pre>"},{"location":"session/#schema-and-table-prefix","title":"Schema and Table Prefix","text":"<p>PostgreSQL supports schema and table prefix configuration for multi-tenant and multi-environment scenarios:</p> <pre><code>// Use schema\nsessionService, err := postgres.NewService(\n    postgres.WithHost(\"localhost\"),\n    postgres.WithDatabase(\"mydb\"),\n    postgres.WithSchema(\"my_schema\"),  // Table name: my_schema.session_states\n)\n\n// Use table prefix\nsessionService, err := postgres.NewService(\n    postgres.WithHost(\"localhost\"),\n    postgres.WithTablePrefix(\"app1_\"),  // Table name: app1_session_states\n)\n\n// Combined usage\nsessionService, err := postgres.NewService(\n    postgres.WithHost(\"localhost\"),\n    postgres.WithSchema(\"tenant_a\"),\n    postgres.WithTablePrefix(\"app1_\"),  // Table name: tenant_a.app1_session_states\n)\n</code></pre> <p>Table Naming Rules:</p> Schema Prefix Final Table Name (none) (none) <code>session_states</code> (none) <code>app1_</code> <code>app1_session_states</code> <code>my_schema</code> (none) <code>my_schema.session_states</code> <code>my_schema</code> <code>app1_</code> <code>my_schema.app1_session_states</code>"},{"location":"session/#soft-delete-and-ttl-cleanup","title":"Soft Delete and TTL Cleanup","text":"<p>Soft Delete Configuration:</p> <pre><code>// Enable soft delete (default)\nsessionService, err := postgres.NewService(\n    postgres.WithHost(\"localhost\"),\n    postgres.WithSoftDelete(true),\n)\n\n// Disable soft delete (physical delete)\nsessionService, err := postgres.NewService(\n    postgres.WithHost(\"localhost\"),\n    postgres.WithSoftDelete(false),\n)\n</code></pre> <p>Delete Behavior Comparison:</p> Configuration Delete Operation Query Behavior Data Recovery <code>softDelete=true</code> <code>UPDATE SET deleted_at = NOW()</code> Queries include <code>WHERE deleted_at IS NULL</code>, returning only non-soft-deleted rows Recoverable <code>softDelete=false</code> <code>DELETE FROM ...</code> Query all records Not recoverable <p>TTL Auto Cleanup:</p> <pre><code>sessionService, err := postgres.NewService(\n    postgres.WithHost(\"localhost\"),\n    postgres.WithSessionTTL(30*time.Minute),      // Session expires after 30 minutes\n    postgres.WithAppStateTTL(24*time.Hour),       // App state expires after 24 hours\n    postgres.WithUserStateTTL(7*24*time.Hour),    // User state expires after 7 days\n    postgres.WithCleanupInterval(10*time.Minute), // Cleanup every 10 minutes\n    postgres.WithSoftDelete(true),                // Soft delete mode\n)\n// Cleanup behavior:\n// - softDelete=true: Expired data marked as deleted_at = NOW()\n// - softDelete=false: Expired data physically deleted\n// - Queries always append `WHERE deleted_at IS NULL`, returning only non-soft-deleted rows.\n</code></pre>"},{"location":"session/#use-with-summary_2","title":"Use with Summary","text":"<pre><code>sessionService, err := postgres.NewService(\n    postgres.WithHost(\"localhost\"),\n    postgres.WithPassword(\"your-password\"),\n    postgres.WithSessionEventLimit(1000),\n    postgres.WithSessionTTL(30*time.Minute),\n\n    // Summary configuration\n    postgres.WithSummarizer(summarizer),\n    postgres.WithAsyncSummaryNum(2),\n    postgres.WithSummaryQueueSize(100),\n)\n</code></pre>"},{"location":"session/#storage-structure_1","title":"Storage Structure","text":"<p>PostgreSQL uses relational table structure with JSON data stored using JSONB type:</p> <pre><code>-- Session states table\nCREATE TABLE session_states (\n    id BIGSERIAL PRIMARY KEY,\n    app_name VARCHAR(255) NOT NULL,\n    user_id VARCHAR(255) NOT NULL,\n    session_id VARCHAR(255) NOT NULL,\n    state JSONB,\n    created_at TIMESTAMP NOT NULL,\n    updated_at TIMESTAMP NOT NULL,\n    expires_at TIMESTAMP,\n    deleted_at TIMESTAMP\n);\n\n-- Partial unique index (only applies to non-deleted records)\nCREATE UNIQUE INDEX idx_session_states_unique_active\nON session_states(app_name, user_id, session_id)\nWHERE deleted_at IS NULL;\n\n-- Session events table\nCREATE TABLE session_events (\n    id BIGSERIAL PRIMARY KEY,\n    app_name VARCHAR(255) NOT NULL,\n    user_id VARCHAR(255) NOT NULL,\n    session_id VARCHAR(255) NOT NULL,\n    event JSONB NOT NULL,\n    created_at TIMESTAMP NOT NULL,\n    updated_at TIMESTAMP NOT NULL,\n    expires_at TIMESTAMP,\n    deleted_at TIMESTAMP\n);\n\n-- Track events table.\nCREATE TABLE session_track_events (\n    id BIGSERIAL PRIMARY KEY,\n    app_name VARCHAR(255) NOT NULL,\n    user_id VARCHAR(255) NOT NULL,\n    session_id VARCHAR(255) NOT NULL,\n    track VARCHAR(255) NOT NULL,\n    event JSONB NOT NULL,\n    created_at TIMESTAMP NOT NULL,\n    updated_at TIMESTAMP NOT NULL,\n    expires_at TIMESTAMP,\n    deleted_at TIMESTAMP\n);\n\n-- Session summaries table\nCREATE TABLE session_summaries (\n    id BIGSERIAL PRIMARY KEY,\n    app_name VARCHAR(255) NOT NULL,\n    user_id VARCHAR(255) NOT NULL,\n    session_id VARCHAR(255) NOT NULL,\n    filter_key VARCHAR(255) NOT NULL,\n    summary JSONB NOT NULL,\n    updated_at TIMESTAMP NOT NULL,\n    expires_at TIMESTAMP,\n    deleted_at TIMESTAMP,\n    UNIQUE(app_name, user_id, session_id, filter_key)\n);\n\n-- Application states table\nCREATE TABLE app_states (\n    id BIGSERIAL PRIMARY KEY,\n    app_name VARCHAR(255) NOT NULL,\n    key VARCHAR(255) NOT NULL,\n    value TEXT DEFAULT NULL,\n    created_at TIMESTAMP NOT NULL,\n    updated_at TIMESTAMP NOT NULL,\n    expires_at TIMESTAMP,\n    deleted_at TIMESTAMP,\n    UNIQUE(app_name, key)\n);\n\n-- User states table\nCREATE TABLE user_states (\n    id BIGSERIAL PRIMARY KEY,\n    app_name VARCHAR(255) NOT NULL,\n    user_id VARCHAR(255) NOT NULL,\n    key VARCHAR(255) NOT NULL,\n    value TEXT DEFAULT NULL,\n    created_at TIMESTAMP NOT NULL,\n    updated_at TIMESTAMP NOT NULL,\n    expires_at TIMESTAMP,\n    deleted_at TIMESTAMP,\n    UNIQUE(app_name, user_id, key)\n);\n</code></pre>"},{"location":"session/#mysql-storage","title":"MySQL Storage","text":"<p>Suitable for production environments and applications requiring complex queries, MySQL is a widely used relational database.</p>"},{"location":"session/#configuration-options_3","title":"Configuration Options","text":"<p>Connection Configuration:</p> <ul> <li><code>WithMySQLClientDSN(dsn string)</code>\uff1aMySQL config</li> <li><code>WithInstanceName(name string)</code>: Use pre-configured MySQL instance.</li> </ul> <p>Session Configuration:</p> <ul> <li><code>WithSessionEventLimit(limit int)</code>: Maximum events per session. Default is 1000.</li> <li><code>WithSessionTTL(ttl time.Duration)</code>: Session TTL. Default is 0 (no expiration).</li> <li><code>WithAppStateTTL(ttl time.Duration)</code>: App state TTL. Default is 0 (no expiration).</li> <li><code>WithUserStateTTL(ttl time.Duration)</code>: User state TTL. Default is 0 (no expiration).</li> <li><code>WithCleanupInterval(interval time.Duration)</code>: TTL cleanup interval. Default is 5 minutes.</li> <li><code>WithSoftDelete(enable bool)</code>: Enable or disable soft delete. Default is <code>true</code>.</li> </ul> <p>Async Persistence Configuration:</p> <ul> <li><code>WithEnableAsyncPersist(enable bool)</code>: Enable async persistence. Default is <code>false</code>.</li> <li><code>WithAsyncPersisterNum(num int)</code>: Number of async persistence workers. Default is 10.</li> </ul> <p>Summary Configuration:</p> <ul> <li><code>WithSummarizer(s summary.SessionSummarizer)</code>: Inject session summarizer.</li> <li><code>WithAsyncSummaryNum(num int)</code>: Number of summary processing workers. Default is 3.</li> <li><code>WithSummaryQueueSize(size int)</code>: Summary task queue size. Default is 100.</li> <li><code>WithSummaryJobTimeout(timeout time.Duration)</code>: Set timeout for single summary task. Default is 30 seconds.</li> </ul> <p>Table Configuration:</p> <ul> <li><code>WithTablePrefix(prefix string)</code>: Table name prefix.</li> <li><code>WithSkipDBInit(skip bool)</code>: Skip automatic table creation.</li> </ul>"},{"location":"session/#basic-configuration-example_3","title":"Basic Configuration Example","text":"<pre><code>import \"trpc.group/trpc-go/trpc-agent-go/session/mysql\"\n\n// Default configuration (minimal)\nsessionService, err := mysql.NewService(\n    mysql.WithMySQLClientDSN(\"user:password@tcp(localhost:3306)/db?charset=utf8mb4&amp;parseTime=True&amp;loc=Local\"),\n)\n// Effect:\n// - Connect to localhost:3306, database trpc_sessions\n// - Each session max 1000 events\n// - Data never expires\n// - 2 async persistence workers\n\n// Complete production environment configuration\nsessionService, err := mysql.NewService(\n    // Connection configuration\n    mysql.WithMySQLClientDSN(\"user:password@tcp(localhost:3306)/db?charset=utf8mb4&amp;parseTime=True&amp;loc=Local\"),\n\n    // Session configuration\n    mysql.WithSessionEventLimit(1000),\n    mysql.WithSessionTTL(30*time.Minute),\n    mysql.WithAppStateTTL(24*time.Hour),\n    mysql.WithUserStateTTL(7*24*time.Hour),\n\n    // TTL cleanup configuration\n    mysql.WithCleanupInterval(10*time.Minute),\n    mysql.WithSoftDelete(true),  // Soft delete mode\n\n    // Async persistence configuration\n    mysql.WithAsyncPersisterNum(4),\n)\n// Effect:\n// - Session expires after 30 minutes of inactivity\n// - Cleanup expired data every 10 minutes (soft delete)\n// - 4 async workers for writes\n</code></pre>"},{"location":"session/#configuration-reuse_2","title":"Configuration Reuse","text":"<pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/storage/mysql\"\n    sessionmysql \"trpc.group/trpc-go/trpc-agent-go/session/mysql\"\n)\n\n// Register MySQL instance\nmysql.RegisterMySQLInstance(\"my-mysql-instance\",\n    mysql.WithClientBuilderDSN(\"root:password@tcp(localhost:3306)/trpc_sessions?parseTime=true&amp;charset=utf8mb4\"),\n)\n\n// Use in session service\nsessionService, err := sessionmysql.NewService(\n    sessionmysql.WithMySQLInstance(\"my-mysql-instance\"),\n    sessionmysql.WithSessionEventLimit(500),\n)\n</code></pre>"},{"location":"session/#table-prefix","title":"Table Prefix","text":"<p>MySQL supports table prefix configuration for multi-application shared database scenarios:</p> <pre><code>// Use table prefix\nsessionService, err := mysql.NewService(\n    mysql.WithMySQLClientDSN(\"user:password@tcp(localhost:3306)/db?charset=utf8mb4&amp;parseTime=True&amp;loc=Local\"),\n    mysql.WithTablePrefix(\"app1_\"),  // Table name: app1_session_states\n)\n</code></pre>"},{"location":"session/#soft-delete-and-ttl-cleanup_1","title":"Soft Delete and TTL Cleanup","text":"<p>Soft Delete Configuration:</p> <pre><code>// Enable soft delete (default)\nsessionService, err := mysql.NewService(\n    mysql.WithMySQLClientDSN(\"user:password@tcp(localhost:3306)/db?charset=utf8mb4&amp;parseTime=True&amp;loc=Local\"),\n    mysql.WithSoftDelete(true),\n)\n\n// Disable soft delete (physical delete)\nsessionService, err := mysql.NewService(\n    mysql.WithMySQLClientDSN(\"user:password@tcp(localhost:3306)/db?charset=utf8mb4&amp;parseTime=True&amp;loc=Local\"),\n    mysql.WithSoftDelete(false),\n)\n</code></pre> <p>Delete Behavior Comparison:</p> Configuration Delete Operation Query Behavior Data Recovery <code>softDelete=true</code> <code>UPDATE SET deleted_at = NOW()</code> Queries include <code>WHERE deleted_at IS NULL</code>, returning only non-soft-deleted rows Recoverable <code>softDelete=false</code> <code>DELETE FROM ...</code> Query all records Not recoverable <p>TTL Auto Cleanup:</p> <pre><code>sessionService, err := mysql.NewService(\n    mysql.WithMySQLClientDSN(\"user:password@tcp(localhost:3306)/db?charset=utf8mb4&amp;parseTime=True&amp;loc=Local\"),\n    mysql.WithSessionTTL(30*time.Minute),      // Session expires after 30 minutes\n    mysql.WithAppStateTTL(24*time.Hour),       // App state expires after 24 hours\n    mysql.WithUserStateTTL(7*24*time.Hour),    // User state expires after 7 days\n    mysql.WithCleanupInterval(10*time.Minute), // Cleanup every 10 minutes\n    mysql.WithSoftDelete(true),                // Soft delete mode\n)\n// Cleanup behavior:\n// - softDelete=true: Expired data marked as deleted_at = NOW()\n// - softDelete=false: Expired data physically deleted\n// - Queries always append `WHERE deleted_at IS NULL`, returning only non-soft-deleted rows.\n</code></pre>"},{"location":"session/#use-with-summary_3","title":"Use with Summary","text":"<pre><code>sessionService, err := mysql.NewService(\n    mysql.WithMySQLClientDSN(\"user:password@tcp(localhost:3306)/db?charset=utf8mb4&amp;parseTime=True&amp;loc=Local\"),\n    mysql.WithSessionEventLimit(1000),\n    mysql.WithSessionTTL(30*time.Minute),\n\n    // Summary configuration\n    mysql.WithSummarizer(summarizer),\n    mysql.WithAsyncSummaryNum(2),\n    mysql.WithSummaryQueueSize(100),\n)\n</code></pre>"},{"location":"session/#storage-structure_2","title":"Storage Structure","text":"<p>MySQL uses relational table structure with JSON data stored using JSON type:</p> <pre><code>-- Session states table\nCREATE TABLE session_states (\n    id BIGINT AUTO_INCREMENT PRIMARY KEY,\n    app_name VARCHAR(255) NOT NULL,\n    user_id VARCHAR(255) NOT NULL,\n    session_id VARCHAR(255) NOT NULL,\n    state JSON,\n    created_at TIMESTAMP(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),\n    updated_at TIMESTAMP(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6),\n    expires_at TIMESTAMP(6) NULL,\n    deleted_at TIMESTAMP(6) NULL,\n    UNIQUE KEY idx_session_states_unique (app_name, user_id, session_id, deleted_at)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n\n-- Session events table\nCREATE TABLE session_events (\n    id BIGINT AUTO_INCREMENT PRIMARY KEY,\n    app_name VARCHAR(255) NOT NULL,\n    user_id VARCHAR(255) NOT NULL,\n    session_id VARCHAR(255) NOT NULL,\n    event JSON NOT NULL,\n    created_at TIMESTAMP(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),\n    updated_at TIMESTAMP(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6),\n    expires_at TIMESTAMP(6) NULL,\n    deleted_at TIMESTAMP(6) NULL,\n    KEY idx_session_events (app_name, user_id, session_id, deleted_at, created_at)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n\n-- Session track events table\nCREATE TABLE session_track_events (\n    id BIGINT AUTO_INCREMENT PRIMARY KEY,\n    app_name VARCHAR(255) NOT NULL,\n    user_id VARCHAR(255) NOT NULL,\n    session_id VARCHAR(255) NOT NULL,\n    track VARCHAR(255) NOT NULL,\n    event JSON NOT NULL,\n    created_at TIMESTAMP(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),\n    updated_at TIMESTAMP(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6),\n    expires_at TIMESTAMP(6) NULL,\n    deleted_at TIMESTAMP(6) NULL,\n    KEY idx_session_track_events (app_name, user_id, session_id, track, deleted_at, created_at)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n\n-- Session summaries table\nCREATE TABLE session_summaries (\n    id BIGINT AUTO_INCREMENT PRIMARY KEY,\n    app_name VARCHAR(255) NOT NULL,\n    user_id VARCHAR(255) NOT NULL,\n    session_id VARCHAR(255) NOT NULL,\n    filter_key VARCHAR(255) NOT NULL,\n    summary JSON NOT NULL,\n    updated_at TIMESTAMP(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6),\n    expires_at TIMESTAMP(6) NULL,\n    deleted_at TIMESTAMP(6) NULL,\n    UNIQUE KEY idx_session_summaries_unique (app_name, user_id, session_id, filter_key, deleted_at)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n\n-- Application states table\nCREATE TABLE app_states (\n    id BIGINT AUTO_INCREMENT PRIMARY KEY,\n    app_name VARCHAR(255) NOT NULL,\n    `key` VARCHAR(255) NOT NULL,\n    value TEXT DEFAULT NULL,\n    created_at TIMESTAMP(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),\n    updated_at TIMESTAMP(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6),\n    expires_at TIMESTAMP(6) NULL,\n    deleted_at TIMESTAMP(6) NULL,\n    UNIQUE KEY idx_app_states_unique (app_name, `key`, deleted_at)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n\n-- User states table\nCREATE TABLE user_states (\n    id BIGINT AUTO_INCREMENT PRIMARY KEY,\n    app_name VARCHAR(255) NOT NULL,\n    user_id VARCHAR(255) NOT NULL,\n    `key` VARCHAR(255) NOT NULL,\n    value TEXT DEFAULT NULL,\n    created_at TIMESTAMP(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),\n    updated_at TIMESTAMP(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6),\n    expires_at TIMESTAMP(6) NULL,\n    deleted_at TIMESTAMP(6) NULL,\n    UNIQUE KEY idx_user_states_unique (app_name, user_id, `key`, deleted_at)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n</code></pre> <p>Key Differences Between MySQL and PostgreSQL:</p> <ul> <li>MySQL doesn't support partial index with <code>WHERE deleted_at IS NULL</code>, requires including <code>deleted_at</code> in unique index</li> <li>MySQL uses <code>JSON</code> type instead of <code>JSONB</code> (similar functionality, different storage format)</li> <li>MySQL uses <code>ON DUPLICATE KEY UPDATE</code> syntax for UPSERT</li> </ul>"},{"location":"session/#advanced-usage","title":"Advanced Usage","text":""},{"location":"session/#hook-capabilities-appendget","title":"Hook Capabilities (Append/Get)","text":"<ul> <li>AppendEventHook: Intercept/modify/abort events before they are stored. Useful for content safety or auditing (e.g., tagging <code>violation=&lt;word&gt;</code>), or short-circuiting persistence. For filterKey usage, see the \u201cSession Summarization / FilterKey with AppendEventHook\u201d section below.</li> <li>GetSessionHook: Intercept/modify/filter sessions after they are read. Useful for removing tagged events or dynamically augmenting the returned session state.</li> <li>Chain-of-responsibility: Hooks call <code>next()</code> to continue; returning early short-circuits later hooks, and errors bubble up.</li> <li>Backend parity: Memory, Redis, MySQL, and PostgreSQL share the same hook interface\u2014inject hook slices when constructing the service.</li> <li>Example: See <code>examples/session/hook</code> (code)</li> </ul>"},{"location":"session/#direct-use-of-session-service-api","title":"Direct Use of Session Service API","text":"<p>In most cases, you should use session management through Runner, which automatically handles all details. However, in some special scenarios (such as session management backend, data migration, statistical analysis, etc.), you may need to directly operate the Session Service.</p> <p>Note: The following APIs are only for special scenarios, daily use of Runner is sufficient.</p>"},{"location":"session/#query-session-list","title":"Query Session List","text":"<pre><code>// List all sessions of a user\nsessions, err := sessionService.ListSessions(ctx, session.UserKey{\n    AppName: \"my-agent\",\n    UserID:  \"user123\",\n})\n\nfor _, sess := range sessions {\n    fmt.Printf(\"SessionID: %s, Events: %d\\n\", sess.ID, len(sess.Events))\n}\n</code></pre>"},{"location":"session/#manually-delete-session","title":"Manually Delete Session","text":"<pre><code>// Delete specified session\nerr := sessionService.DeleteSession(ctx, session.Key{\n    AppName:   \"my-agent\",\n    UserID:    \"user123\",\n    SessionID: \"session-id-123\",\n})\n</code></pre>"},{"location":"session/#manually-get-session-details","title":"Manually Get Session Details","text":"<pre><code>// Get complete session\nsess, err := sessionService.GetSession(ctx, session.Key{\n    AppName:   \"my-agent\",\n    UserID:    \"user123\",\n    SessionID: \"session-id-123\",\n})\n\n// Get session with latest 10 events only\nsess, err := sessionService.GetSession(ctx, key,\n    session.WithEventNum(10))\n\n// Get events after specified time\nsess, err := sessionService.GetSession(ctx, key,\n    session.WithEventTime(time.Now().Add(-1*time.Hour)))\n</code></pre>"},{"location":"session/#session-summarization","title":"Session Summarization","text":""},{"location":"session/#overview_1","title":"Overview","text":"<p>As conversations grow longer, maintaining full event history can become memory-intensive and may exceed LLM context windows. The session summarization feature automatically compresses historical conversation content into concise summaries using LLM-based summarization, reducing memory usage while preserving important context for future interactions.</p>"},{"location":"session/#key-features_1","title":"Key Features","text":"<ul> <li>Automatic summarization: Automatically trigger summaries based on configurable conditions such as event count, token count, or time threshold.</li> <li>Incremental summarization: Only new events since the last summary are processed, avoiding redundant computation.</li> <li>LLM-powered: Uses any configured LLM model to generate high-quality, context-aware summaries.</li> <li>Non-destructive: Original events remain unchanged; summaries are stored separately.</li> <li>Asynchronous processing: Summary jobs are processed asynchronously to avoid blocking the main conversation flow.</li> <li>Customizable prompts: Configure custom summarization prompts and word limits.</li> </ul>"},{"location":"session/#basic-usage","title":"Basic Usage","text":""},{"location":"session/#configure-summarizer","title":"Configure Summarizer","text":"<p>Create a summarizer with an LLM model and configure trigger conditions:</p> <pre><code>import (\n    \"time\"\n    \"trpc.group/trpc-go/trpc-agent-go/session/summary\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/openai\"\n)\n\n// Create LLM model for summarization.\nsummaryModel := openai.New(\"gpt-4\", openai.WithAPIKey(\"your-api-key\"))\n\n// Create summarizer with trigger conditions.\nsummarizer := summary.NewSummarizer(\n    summaryModel,\n    summary.WithEventThreshold(20),        // Trigger when 20+ new events since last summary.\n    summary.WithTokenThreshold(4000),      // Trigger when 4000+ new tokens since last summary.\n    summary.WithMaxSummaryWords(200),      // Limit summary to 200 words.\n)\n</code></pre>"},{"location":"session/#integrate-with-session-service","title":"Integrate with Session Service","text":"<p>Attach the summarizer to your session service (in-memory or Redis):</p> <pre><code>import (\n    \"time\"\n    \"trpc.group/trpc-go/trpc-agent-go/session/inmemory\"\n    \"trpc.group/trpc-go/trpc-agent-go/session/redis\"\n)\n\n// Option 1: In-memory session service with summarizer.\nsessionService := inmemory.NewSessionService(\n    inmemory.WithSummarizer(summarizer),\n    inmemory.WithAsyncSummaryNum(2),                // 2 async workers.\n    inmemory.WithSummaryQueueSize(100),             // Queue size 100.\n    inmemory.WithSummaryJobTimeout(30*time.Second), // 30s timeout per job.\n)\n\n// Option 2: Redis session service with summarizer.\nsessionService, err := redis.NewService(\n    redis.WithRedisClientURL(\"redis://localhost:6379\"),\n    redis.WithSummarizer(summarizer),\n    redis.WithAsyncSummaryNum(4),           // 4 async workers.\n    redis.WithSummaryQueueSize(200),        // Queue size 200.\n)\n</code></pre>"},{"location":"session/#automatic-summarization-in-runner","title":"Automatic Summarization in Runner","text":"<p>Once configured, the Runner automatically triggers summarization. You can also configure the LLM agent to use summaries in context:</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/agent/llmagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/runner\"\n)\n\n// Create agent with summary injection enabled.\nllmAgent := llmagent.New(\n    \"my-agent\",\n    llmagent.WithModel(summaryModel),\n    llmagent.WithAddSessionSummary(true),   // Inject summary as system message.\n    llmagent.WithMaxHistoryRuns(10),        // Limit history runs when AddSessionSummary=false\n)\n\n// Create runner with session service.\nrunner := runner.NewRunner(\n    \"my-agent\",\n    llmAgent,\n    runner.WithSessionService(sessionService),\n)\n\n// Summaries are automatically created and injected during conversation.\neventChan, err := runner.Run(ctx, userID, sessionID, userMessage)\n</code></pre> <p>How it works:</p> <p>The framework provides two distinct modes for managing conversation context sent to the LLM:</p> <p>Mode 1: With Summary (<code>WithAddSessionSummary(true)</code>)</p> <ul> <li>The session summary is inserted as a separate system message after the first existing system message (or prepended if no system message exists).</li> <li>All incremental events after the summary timestamp are included (no truncation).</li> <li>This ensures complete context: condensed history (summary) + all new conversations since summarization.</li> <li><code>WithMaxHistoryRuns</code> is ignored in this mode.</li> </ul> <p>Mode 2: Without Summary (<code>WithAddSessionSummary(false)</code>)</p> <ul> <li>No summary is prepended.</li> <li>Only the most recent <code>MaxHistoryRuns</code> conversation turns are included.</li> <li>When <code>MaxHistoryRuns=0</code> (default), no limit is applied and all history is included.</li> <li>Use this mode for short sessions or when you want direct control over context window size.</li> </ul> <p>Context Construction Details:</p> <pre><code>When AddSessionSummary = true:\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 Existing System Message (optional)  \u2502 \u2190 If present\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Session Summary (system message)    \u2502 \u2190 Inserted after first system message\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Event 1 (after summary timestamp)   \u2502 \u2510\n\u2502 Event 2                             \u2502 \u2502 All incremental\n\u2502 Event 3                             \u2502 \u2502 events since\n\u2502 ...                                 \u2502 \u2502 last summary\n\u2502 Event N (current)                   \u2502 \u2518\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\nWhen AddSessionSummary = false:\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 System Prompt                       \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Event N-k+1                         \u2502 \u2510\n\u2502 Event N-k+2                         \u2502 \u2502 Last k turns\n\u2502 ...                                 \u2502 \u2502 (if MaxHistoryRuns=k)\n\u2502 Event N (current)                   \u2502 \u2518\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre> <p>Best Practices:</p> <ul> <li>For long-running sessions, use <code>WithAddSessionSummary(true)</code> to maintain full context while managing token usage.</li> <li>For short sessions or when testing, use <code>WithAddSessionSummary(false)</code> with appropriate <code>MaxHistoryRuns</code>.</li> <li>The Runner automatically enqueues async summary jobs after appending events to the session.</li> </ul>"},{"location":"session/#configuration-options_4","title":"Configuration Options","text":""},{"location":"session/#summarizer-options","title":"Summarizer Options","text":"<p>Configure the summarizer behavior with the following options:</p> <p>Trigger Conditions:</p> <ul> <li><code>WithEventThreshold(eventCount int)</code>: Trigger summarization when the number of new events since last summary exceeds the threshold. Example: <code>WithEventThreshold(20)</code> triggers when 20+ new events have occurred since last summary.</li> <li><code>WithTokenThreshold(tokenCount int)</code>: Trigger summarization when the new token count since last summary exceeds the threshold. Example: <code>WithTokenThreshold(4000)</code> triggers when 4000+ new tokens have been added since last summary.</li> <li><code>WithTimeThreshold(interval time.Duration)</code>: Trigger summarization when time elapsed since the last event exceeds the interval. Example: <code>WithTimeThreshold(5*time.Minute)</code> triggers after 5 minutes of inactivity.</li> </ul> <p>Composite Conditions:</p> <ul> <li><code>WithChecksAll(checks ...Checker)</code>: Require all conditions to be met (AND logic). Use with <code>Check*</code> functions (not <code>With*</code>). Example:   <pre><code>summary.WithChecksAll(\n    summary.CheckEventThreshold(10),\n    summary.CheckTokenThreshold(2000),\n)\n</code></pre></li> <li><code>WithChecksAny(checks ...Checker)</code>: Trigger if any condition is met (OR logic). Use with <code>Check*</code> functions (not <code>With*</code>). Example:   <pre><code>summary.WithChecksAny(\n    summary.CheckEventThreshold(50),\n    summary.CheckTimeThreshold(10*time.Minute),\n)\n</code></pre></li> </ul> <p>Note: Use <code>Check*</code> functions (like <code>CheckEventThreshold</code>) inside <code>WithChecksAll</code> and <code>WithChecksAny</code>. Use <code>With*</code> functions (like <code>WithEventThreshold</code>) as direct options to <code>NewSummarizer</code>. The <code>Check*</code> functions create checker instances, while <code>With*</code> functions are option setters.</p> <p>Summary Generation:</p> <ul> <li><code>WithMaxSummaryWords(maxWords int)</code>: Limit the summary to a maximum word count. The limit is included in the prompt to guide the model's generation. Example: <code>WithMaxSummaryWords(150)</code> requests summaries within 150 words.</li> <li><code>WithPrompt(prompt string)</code>: Provide a custom summarization prompt. The prompt must include the placeholder <code>{conversation_text}</code>, which will be replaced with the conversation content. Optionally include <code>{max_summary_words}</code> for word limit instructions.</li> <li><code>WithSkipRecent(skipFunc SkipRecentFunc)</code>: Skip the most recent events during summarization using a custom function. The function receives all events and returns how many tail events to skip. Return 0 to skip none. Useful for avoiding summarizing very recent/incomplete conversations, or applying time/content-based skipping strategies.</li> </ul> <p>Example with custom prompt:</p> <pre><code>customPrompt := `Analyze the following conversation and provide a concise summary\nfocusing on key decisions, action items, and important context.\nKeep it within {max_summary_words} words.\n\n&lt;conversation&gt;\n{conversation_text}\n&lt;/conversation&gt;\n\nSummary:`\n\nsummarizer := summary.NewSummarizer(\n    summaryModel,\n    summary.WithPrompt(customPrompt), // Custom Prompt\n    summary.WithMaxSummaryWords(100), // Inject into {max_summary_words}\n    summary.WithEventThreshold(15),\n)\n\n// Skip a fixed number of recent events (compatible with old behavior)\nsummarizer := summary.NewSummarizer(\n    summaryModel,\n    summary.WithSkipRecent(func(_ []event.Event) int { return 2 }), // skip last 2 events\n    summary.WithEventThreshold(10),\n)\n\n// Skip events from the last 5 minutes (time window)\nsummarizer := summary.NewSummarizer(\n    summaryModel,\n    summary.WithSkipRecent(func(events []event.Event) int {\n        cutoff := time.Now().Add(-5 * time.Minute)\n        skip := 0\n        for i := len(events) - 1; i &gt;= 0; i-- {\n            if events[i].Timestamp.After(cutoff) {\n                skip++\n            } else {\n                break\n            }\n        }\n        return skip\n    }),\n    summary.WithEventThreshold(10),\n)\n\n// Skip trailing tool-call messages only\nsummarizer := summary.NewSummarizer(\n    summaryModel,\n    summary.WithSkipRecent(func(events []event.Event) int {\n        skip := 0\n        for i := len(events) - 1; i &gt;= 0; i-- {\n            if events[i].Response != nil &amp;&amp; len(events[i].Response.Choices) &gt; 0 &amp;&amp;\n                events[i].Response.Choices[0].Message.Role == model.RoleTool {\n                skip++\n            } else {\n                break\n            }\n        }\n        return skip\n    }),\n    summary.WithEventThreshold(10),\n)\n</code></pre>"},{"location":"session/#session-service-options","title":"Session Service Options","text":"<p>Configure async summary processing in session services:</p> <ul> <li><code>WithSummarizer(s summary.SessionSummarizer)</code>: Inject the summarizer into the session service.</li> <li><code>WithAsyncSummaryNum(num int)</code>: Set the number of async worker goroutines for summary processing. Default is 2. More workers allow higher concurrency but consume more resources.</li> <li><code>WithSummaryQueueSize(size int)</code>: Set the size of the summary job queue. Default is 100. Larger queues allow more pending jobs but consume more memory.</li> <li><code>WithSummaryJobTimeout(timeout time.Duration)</code>: Set the timeout for processing a single summary job. Default is 30 seconds.</li> </ul>"},{"location":"session/#manual-summarization","title":"Manual Summarization","text":"<p>You can manually trigger summarization using the session service APIs:</p> <pre><code>// Asynchronous summarization (recommended) - background processing, non-blocking.\nerr := sessionService.EnqueueSummaryJob(\n    ctx,\n    sess,\n    session.SummaryFilterKeyAllContents, // Full session summary.\n    false,                                // force=false, respects trigger conditions.\n)\n\n// Synchronous summarization - immediate processing, blocking.\nerr := sessionService.CreateSessionSummary(\n    ctx,\n    sess,\n    session.SummaryFilterKeyAllContents,\n    false, // force=false, respects trigger conditions.\n)\n\n// Asynchronous force summarization - bypass trigger conditions.\nerr := sessionService.EnqueueSummaryJob(\n    ctx,\n    sess,\n    session.SummaryFilterKeyAllContents,\n    true, // force=true, bypass all trigger condition checks.\n)\n\n// Synchronous force summarization - immediate forced generation.\nerr := sessionService.CreateSessionSummary(\n    ctx,\n    sess,\n    session.SummaryFilterKeyAllContents,\n    true, // force=true, bypass all trigger condition checks.\n)\n</code></pre> <p>API Description:</p> <ul> <li> <p><code>EnqueueSummaryJob</code>: Asynchronous summarization (recommended)</p> <ul> <li>Background processing, non-blocking</li> <li>Automatic fallback to sync processing on failure</li> <li>Suitable for production environments</li> </ul> </li> </ul> <ul> <li><code>CreateSessionSummary</code>: Synchronous summarization<ul> <li>Immediate processing, blocking current operation</li> <li>Direct result return</li> <li>Suitable for debugging or scenarios requiring immediate results</li> </ul> </li> </ul> <p>Parameter Description:</p> <ul> <li>filterKey: <code>session.SummaryFilterKeyAllContents</code> indicates generating summary for the complete session</li> <li>force parameter:<ul> <li><code>false</code>: Respects configured trigger conditions (event count, token count, time threshold, etc.), only generates summary when conditions are met</li> <li><code>true</code>: Forces summary generation, completely ignores all trigger condition checks, executes regardless of session state</li> </ul> </li> </ul> <p>Usage Scenarios:</p> Scenario API force Description Normal auto-summary Automatically called by Runner <code>false</code> Auto-generates when trigger conditions met Session end <code>EnqueueSummaryJob</code> <code>true</code> Force generate final complete summary User requests view <code>CreateSessionSummary</code> <code>true</code> Immediately generate and return Scheduled batch processing <code>EnqueueSummaryJob</code> <code>false</code> Batch check and process qualified sessions Debug/testing <code>CreateSessionSummary</code> <code>true</code> Immediate execution, convenient for verification"},{"location":"session/#retrieve-summary","title":"Retrieve Summary","text":"<p>Get the latest summary text from a session:</p> <pre><code>// Get the full-session summary (default behavior)\nsummaryText, found := sessionService.GetSessionSummaryText(ctx, sess)\nif found {\n    fmt.Printf(\"Summary: %s\\n\", summaryText)\n}\n\n// Get summary for a specific filter key\nuserSummary, found := sessionService.GetSessionSummaryText(\n    ctx, sess, session.WithSummaryFilterKey(\"user-messages\"),\n)\nif found {\n    fmt.Printf(\"User messages summary: %s\\n\", userSummary)\n}\n</code></pre> <p>Filter Key Support:</p> <p>The <code>GetSessionSummaryText</code> method supports an optional <code>WithSummaryFilterKey</code> option to retrieve summaries for specific event filters:</p> <ul> <li>When no option is provided, returns the full-session summary (<code>SummaryFilterKeyAllContents</code>)</li> <li>When a specific filter key is provided but not found, falls back to the full-session summary</li> <li>If neither exists, returns any available summary as a last resort</li> </ul>"},{"location":"session/#how-it-works","title":"How It Works","text":"<ol> <li> <p>Incremental Processing: The summarizer tracks the last summarization time for each session. On subsequent runs, it only processes events that occurred after the last summary.</p> </li> <li> <p>Delta Summarization: New events are combined with the previous summary (prepended as a system event) to generate an updated summary that incorporates both old context and new information.</p> </li> <li> <p>Trigger Evaluation: Before generating a summary, the summarizer evaluates configured trigger conditions (based on incremental event count, token count, and time threshold since last summary). If conditions aren't met and <code>force=false</code>, summarization is skipped.</p> </li> <li> <p>Async Workers: Summary jobs are distributed across multiple worker goroutines using hash-based distribution. This ensures jobs for the same session are processed sequentially while different sessions can be processed in parallel.</p> </li> <li> <p>Fallback Mechanism: If async enqueueing fails (queue full, context cancelled, or workers not initialized), the system automatically falls back to synchronous processing.</p> </li> </ol>"},{"location":"session/#best-practices","title":"Best Practices","text":"<ol> <li> <p>Choose appropriate thresholds: Set event/token thresholds based on your LLM's context window and conversation patterns. For GPT-4 (8K context), consider <code>WithTokenThreshold(4000)</code> to leave room for responses.</p> </li> <li> <p>Use async processing: Always use <code>EnqueueSummaryJob</code> instead of <code>CreateSessionSummary</code> in production to avoid blocking the conversation flow.</p> </li> <li> <p>Monitor queue sizes: If you see frequent \"queue is full\" warnings, increase <code>WithSummaryQueueSize</code> or <code>WithAsyncSummaryNum</code>.</p> </li> <li> <p>Customize prompts: Tailor the summarization prompt to your application's needs. For example, if you're building a customer support agent, focus on key issues and resolutions.</p> </li> <li> <p>Balance word limits: Set <code>WithMaxSummaryWords</code> to balance between preserving context and reducing token usage. Typical values range from 100-300 words.</p> </li> <li> <p>Test trigger conditions: Experiment with different combinations of <code>WithChecksAny</code> and <code>WithChecksAll</code> to find the right balance between summary frequency and cost.</p> </li> </ol>"},{"location":"session/#summarizing-by-event-type","title":"Summarizing by Event Type","text":"<p>In real-world applications, you may want to generate separate summaries for different types of events. For example:</p> <ul> <li>User Message Summary: Summarize user needs and questions</li> <li>Tool Call Summary: Record which tools were used and their results</li> <li>System Event Summary: Track system state changes</li> </ul> <p>To achieve this, you need to set the <code>FilterKey</code> field on events to identify their type.</p>"},{"location":"session/#setting-filterkey-with-appendeventhook","title":"Setting FilterKey with AppendEventHook","text":"<p>The recommended approach is to use <code>AppendEventHook</code> to automatically set <code>FilterKey</code> before events are persisted:</p> <pre><code>sessionService := inmemory.NewSessionService(\n    inmemory.WithAppendEventHook(func(ctx *session.AppendEventContext, next func() error) error {\n        // Auto-categorize by event author\n        prefix := \"my-app/\"  // Must add appName prefix\n        switch ctx.Event.Author {\n        case \"user\":\n            ctx.Event.FilterKey = prefix + \"user-messages\"\n        case \"tool\":\n            ctx.Event.FilterKey = prefix + \"tool-calls\"\n        default:\n            ctx.Event.FilterKey = prefix + \"misc\"\n        }\n        return next()\n    }),\n)\n</code></pre> <p>Once FilterKey is set, you can generate independent summaries for different event types:</p> <pre><code>// Generate summary for user messages\nerr := sessionService.CreateSessionSummary(ctx, sess, \"my-app/user-messages\", false)\n\n// Generate summary for tool calls\nerr := sessionService.CreateSessionSummary(ctx, sess, \"my-app/tool-calls\", false)\n\n// Retrieve summary for specific type\nuserSummary, found := sessionService.GetSessionSummaryText(\n    ctx, sess, session.WithSummaryFilterKey(\"my-app/user-messages\"))\n</code></pre>"},{"location":"session/#filterkey-prefix-convention","title":"FilterKey Prefix Convention","text":"<p>\u26a0\ufe0f Important: FilterKey must include the <code>appName + \"/\"</code> prefix.</p> <p>Why: The Runner uses <code>appName + \"/\"</code> as the filter prefix when filtering events. If your FilterKey lacks this prefix, events will be filtered out, causing:</p> <ul> <li>LLM cannot see conversation history, may repeatedly trigger tool calls</li> <li>Summary content is incomplete, losing important context</li> </ul> <p>Example:</p> <pre><code>// \u2705 Correct: with appName prefix\nevt.FilterKey = \"my-app/user-messages\"\n\n// \u274c Wrong: no prefix, events will be filtered out\nevt.FilterKey = \"user-messages\"\n</code></pre> <p>Technical Details: The framework uses prefix matching (<code>strings.HasPrefix</code>) to determine which events should be included in the context. See <code>ContentRequestProcessor</code> filtering logic for details.</p>"},{"location":"session/#complete-examples","title":"Complete Examples","text":"<p>See the following examples for complete FilterKey usage scenarios:</p> <ul> <li>examples/session/hook - Hook basics</li> <li>examples/summary/filterkey - Summarizing by FilterKey</li> </ul>"},{"location":"session/#performance-considerations","title":"Performance Considerations","text":"<ul> <li>LLM costs: Each summary generation calls the LLM. Monitor your trigger conditions to balance cost and context preservation.</li> <li>Memory usage: Summaries are stored in addition to events. Configure appropriate TTLs to manage memory in long-running sessions.</li> <li>Async workers: More workers increase throughput but consume more resources. Start with 2-4 workers and scale based on load.</li> <li>Queue capacity: Size the queue based on your expected concurrency and summary generation time.</li> </ul>"},{"location":"session/#complete-example","title":"Complete Example","text":"<p>Here's a complete example demonstrating all components together:</p> <pre><code>package main\n\nimport (\n    \"context\"\n    \"time\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/agent/llmagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/model\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/openai\"\n    \"trpc.group/trpc-go/trpc-agent-go/runner\"\n    \"trpc.group/trpc-go/trpc-agent-go/session/inmemory\"\n    \"trpc.group/trpc-go/trpc-agent-go/session/summary\"\n)\n\nfunc main() {\n    ctx := context.Background()\n\n    // Create LLM model for both chat and summarization.\n    llm := openai.New(\"gpt-4\", openai.WithAPIKey(\"your-api-key\"))\n\n    // Create summarizer with flexible trigger conditions.\n    summarizer := summary.NewSummarizer(\n        llm,\n        summary.WithMaxSummaryWords(200),\n        summary.WithChecksAny(\n            summary.CheckEventThreshold(20),\n            summary.CheckTokenThreshold(4000),\n            summary.CheckTimeThreshold(5*time.Minute),\n        ),\n    )\n\n    // Create session service with summarizer.\n    sessionService := inmemory.NewSessionService(\n        inmemory.WithSummarizer(summarizer),\n        inmemory.WithAsyncSummaryNum(2),\n        inmemory.WithSummaryQueueSize(100),\n        inmemory.WithSummaryJobTimeout(30*time.Second),\n    )\n\n    // Create agent with summary injection enabled.\n    agent := llmagent.New(\n        \"my-agent\",\n        llmagent.WithModel(llm),\n        llmagent.WithAddSessionSummary(true),\n        llmagent.WithMaxHistoryRuns(10),        // Limit history runs when AddSessionSummary=false\n    )\n\n    // Create runner.\n    r := runner.NewRunner(\"my-app\", agent,\n        runner.WithSessionService(sessionService))\n\n    // Run conversation - summaries are automatically managed.\n    userMsg := model.NewUserMessage(\"Tell me about AI\")\n    eventChan, _ := r.Run(ctx, \"user123\", \"session456\", userMsg)\n\n    // Consume events.\n    for event := range eventChan {\n        // Handle events...\n    }\n}\n</code></pre>"},{"location":"session/#references","title":"References","text":"<ul> <li>Session example</li> <li>Summary example</li> </ul> <p>By properly using session management, in combination with session summarization mechanisms, you can build stateful intelligent Agents that maintain conversation context while efficiently managing memory, providing users with continuous and personalized interaction experiences while ensuring the long-term sustainability of your system.</p>"},{"location":"skill/","title":"Skill (Agent Skills)","text":"<p>Agent Skills package reusable workflows as folders with a <code>SKILL.md</code> spec plus optional docs and scripts. During a conversation, the agent injects a low\u2011cost \u201coverview\u201d first, then loads the full body/docs only when actually needed, and runs scripts inside an isolated workspace.</p> <p>Background references: - Engineering blog:   https://www.anthropic.com/engineering/equipping-agents-for-the-real-world-with-agent-skills - Open Skills repository (structure to emulate):   https://github.com/anthropics/skills</p>"},{"location":"skill/#overview","title":"Overview","text":""},{"location":"skill/#what-you-get","title":"\ud83c\udfaf What You Get","text":"<ul> <li>\ud83d\udd0e Overview injection (name + description) to guide selection</li> <li>\ud83d\udce5 <code>skill_load</code> to pull <code>SKILL.md</code> body and selected docs on demand</li> <li>\ud83d\udcda <code>skill_select_docs</code> to add/replace/clear docs</li> <li>\ud83e\uddfe <code>skill_list_docs</code> to list available docs</li> <li>\ud83c\udfc3 <code>skill_run</code> to execute commands, returning stdout/stderr and   output files</li> <li>\ud83d\uddc2\ufe0f Output file collection via glob patterns with MIME detection</li> <li>\ud83e\udde9 Pluggable local or container workspace executors (local by default)</li> <li>\ud83e\uddf1 Declarative <code>inputs</code>/<code>outputs</code>: map inputs and collect/inline/   save outputs via a manifest</li> </ul>"},{"location":"skill/#threelayer-information-model","title":"Three\u2011Layer Information Model","text":"<p>1) Initial \u201coverview\u201d (very low cost)    - Inject only <code>name</code> and <code>description</code> from <code>SKILL.md</code> into the      system message so the model knows what skills exist.</p> <p>2) Full body (on demand)    - When a task truly needs a skill, the model calls <code>skill_load</code> and      the framework injects that skill\u2019s full <code>SKILL.md</code> body.</p> <p>3) Docs/Scripts (selective + isolated execution)    - Docs are included only when requested; scripts are not inlined but      executed inside a workspace, returning results and output files.</p>"},{"location":"skill/#file-layout","title":"File Layout","text":"<pre><code>skills/\n  demo-skill/\n    SKILL.md        # YAML (name/description) + Markdown body\n    USAGE.md        # optional docs (.md/.txt)\n    scripts/build.sh\n    ...\n</code></pre> <p>Repository and parsing: skill/repository.go</p>"},{"location":"skill/#quickstart","title":"Quickstart","text":""},{"location":"skill/#1-requirements","title":"1) Requirements","text":"<ul> <li>Go 1.21+</li> <li>Model provider API key (OpenAI\u2011compatible)</li> <li>Optional Docker for the container executor</li> </ul> <p>Common env vars:</p> <pre><code>export OPENAI_API_KEY=\"your-api-key\"\n# Optional: read\u2011only mount for container runtime\nexport SKILLS_ROOT=/path/to/skills\n</code></pre>"},{"location":"skill/#2-enable-skills-in-an-agent","title":"2) Enable Skills in an Agent","text":"<p>Provide a repository and an executor. If not set, a local executor is used for convenience during development.</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/agent/llmagent\"\n    local \"trpc.group/trpc-go/trpc-agent-go/codeexecutor/local\"\n    \"trpc.group/trpc-go/trpc-agent-go/skill\"\n)\n\nrepo, _ := skill.NewFSRepository(\"./skills\")\nexec := local.New()\n\nagent := llmagent.New(\n    \"skills-assistant\",\n    llmagent.WithSkills(repo),\n    llmagent.WithCodeExecutor(exec),\n)\n</code></pre> <p>Key points: - Request processor injects overview and on\u2011demand content:   [internal/flow/processor/skills.go]   (https://github.com/trpc-group/trpc-agent-go/blob/main/internal/flow/processor/skills.go) - Tools are auto\u2011registered with <code>WithSkills</code>: <code>skill_load</code>,   <code>skill_select_docs</code>, <code>skill_list_docs</code>, and <code>skill_run</code> show up   automatically; no manual wiring required. - Auto prompt guidance is injected in the system message so the model   learns to <code>skill_load</code> first, select docs with <code>skill_select_docs</code>   as needed, and then <code>skill_run</code> at the right time.   - Loader: tool/skill/load.go   - Runner: tool/skill/run.go</p>"},{"location":"skill/#3-run-the-example","title":"3) Run the Example","text":"<p>Interactive demo: examples/skillrun/main.go</p> <pre><code>cd examples/skillrun\nexport OPENAI_API_KEY=\"your-api-key\"\ngo run . -executor local     # or: -executor container\n</code></pre> <p>Sample skill (excerpt): [examples/skillrun/skills/python_math/SKILL.md] (https://github.com/trpc-group/trpc-agent-go/blob/main/examples/skillrun/skills/python_math/SKILL.md)</p> <p>Natural prompts: - Say what you want to accomplish; the model will decide if a skill is   needed based on the overview. - When needed, the model calls <code>skill_load</code> for body/docs, then   <code>skill_run</code> to execute and return output files.</p>"},{"location":"skill/#skillmd-anatomy","title":"SKILL.md Anatomy","text":"<p><code>SKILL.md</code> uses YAML front matter + Markdown body:</p> <pre><code>---\nname: python-math\ndescription: Small Python utilities for math and text files.\n---\n\nOverview\nRun short Python scripts inside the skill workspace...\n\nExamples\n1) Print the first N Fibonacci numbers\n   Command: python3 scripts/fib.py 10 &gt; out/fib.txt\n\nOutput Files\n- out/fib.txt\n</code></pre> <p>Recommendations: - Keep <code>name</code>/<code>description</code> succinct for the overview - In the body, include when\u2011to\u2011use, steps/commands, output file paths - Put scripts under <code>scripts/</code> and reference them in commands</p> <p>For more examples, see: https://github.com/anthropics/skills</p>"},{"location":"skill/#tools-in-detail","title":"Tools in Detail","text":""},{"location":"skill/#skill_load","title":"<code>skill_load</code>","text":"<p>Declaration: tool/skill/load.go</p> <p>Input: - <code>skill</code> (required) - <code>docs</code> (optional array of doc filenames) - <code>include_all_docs</code> (optional bool)</p> <p>Behavior: - Writes ephemeral session keys (per turn):   - <code>temp:skill:loaded:&lt;name&gt;</code> = \"1\"   - <code>temp:skill:docs:&lt;name&gt;</code> = \"*\" or JSON array - Request processor injects <code>SKILL.md</code> body and docs into system message</p> <p>Notes: - Safe to call multiple times to add or replace docs.</p>"},{"location":"skill/#skill_select_docs","title":"<code>skill_select_docs</code>","text":"<p>Declaration: tool/skill/select_docs.go</p> <p>Input: - <code>skill</code> (required) - <code>docs</code> (optional array) - <code>include_all_docs</code> (optional bool) - <code>mode</code> (optional string): <code>add</code> | <code>replace</code> | <code>clear</code></p> <p>Behavior: - Updates <code>temp:skill:docs:&lt;name&gt;</code> accordingly:   - <code>*</code> for include all   - JSON array for explicit list</p>"},{"location":"skill/#skill_list_docs","title":"<code>skill_list_docs</code>","text":"<p>Declaration: tool/skill/list_docs.go</p> <p>Input: - <code>skill</code> (required)</p> <p>Output: - Array of available doc filenames</p> <p>Note: These keys are managed by the framework; you rarely need to touch them directly when driving the conversation naturally.</p>"},{"location":"skill/#skill_run","title":"<code>skill_run</code>","text":"<p>Declaration: tool/skill/run.go</p> <p>Input: - <code>skill</code> (required) - <code>command</code> (required, runs via <code>bash -lc</code>) - <code>cwd</code>, <code>env</code> (optional) - <code>output_files</code> (optional, legacy collection): glob patterns (e.g.,   <code>out/*.txt</code>). Patterns are workspace\u2011relative; env\u2011style prefixes   like <code>$OUTPUT_DIR/*.txt</code> are also accepted and normalized to   <code>out/*.txt</code>. - <code>inputs</code> (optional, declarative inputs): map external sources into   the workspace. Each item supports:   - <code>from</code> with schemes:     - <code>artifact://name[@version]</code> to load from the Artifact service     - <code>host://abs/path</code> to copy/link from a host absolute path     - <code>workspace://rel/path</code> to copy/link from current workspace     - <code>skill://&lt;name&gt;/rel/path</code> to copy/link from a staged skill   - <code>to</code> workspace\u2011relative destination; defaults to     <code>WORK_DIR/inputs/&lt;basename&gt;</code>   - <code>mode</code>: <code>copy</code> (default) or <code>link</code> when feasible</p> <ul> <li><code>outputs</code> (optional, declarative outputs): a manifest to collect   results with limits and persistence:<ul> <li><code>globs</code> workspace\u2011relative patterns (supports <code>**</code> and env\u2011style   prefixes like <code>$OUTPUT_DIR/**</code> mapping to <code>out/**</code>)</li> <li><code>inline</code> to inline file contents into the result</li> <li><code>save</code> to persist via the Artifact service</li> <li><code>name_template</code> prefix for artifact names (e.g., <code>pref/</code>)</li> <li>Limits: <code>max_files</code> (default 100), <code>max_file_bytes</code> (default   4 MiB/file), <code>max_total_bytes</code> (default 64 MiB)</li> </ul> </li> </ul> <ul> <li><code>timeout</code> (optional seconds)</li> <li><code>save_as_artifacts</code> (optional, legacy path): persist files collected   via <code>output_files</code> and return <code>artifact_files</code> in the result</li> <li><code>omit_inline_content</code> (optional): with <code>save_as_artifacts</code>, omit   <code>output_files[*].content</code> and return metadata only</li> <li><code>artifact_prefix</code> (optional): prefix for the legacy artifact path</li> </ul> <p>Output: - <code>stdout</code>, <code>stderr</code>, <code>exit_code</code>, <code>timed_out</code>, <code>duration_ms</code> - <code>output_files</code> with <code>name</code>, <code>content</code>, <code>mime_type</code> - <code>artifact_files</code> with <code>name</code>, <code>version</code> appears in two cases:   - Legacy path: when <code>save_as_artifacts</code> is set   - Manifest path: when <code>outputs.save=true</code> (executor persists files)</p> <p>Typical flow: 1) Call <code>skill_load</code> to inject body/docs 2) Call <code>skill_run</code> and collect outputs:    - Legacy: use <code>output_files</code> globs    - Declarative: use <code>outputs</code> to drive collect/inline/save    - Use <code>inputs</code> to stage upstream files when needed</p> <p>Environment and CWD: - When <code>cwd</code> is omitted, runs at the skill root: <code>/skills/&lt;name&gt;</code> - A relative <code>cwd</code> is resolved under the skill root - Runtime injects env vars: <code>WORKSPACE_DIR</code>, <code>SKILLS_DIR</code>, <code>WORK_DIR</code>,   <code>OUTPUT_DIR</code>, <code>RUN_DIR</code>; the tool injects <code>SKILL_NAME</code> - Convenience symlinks are created under the skill root: <code>out/</code>,   <code>work/</code>, and <code>inputs/</code> point to workspace\u2011level dirs</p>"},{"location":"skill/#executor","title":"Executor","text":"<p>Interface: codeexecutor/codeexecutor.go</p> <p>Implementations: - Local: [codeexecutor/local/workspace_runtime.go]   (https://github.com/trpc-group/trpc-agent-go/blob/main/codeexecutor/local/workspace_runtime.go) - Container (Docker):   [codeexecutor/container/workspace_runtime.go]   (https://github.com/trpc-group/trpc-agent-go/blob/main/codeexecutor/container/workspace_runtime.go)</p> <p>Container notes: - Writable run base; <code>$SKILLS_ROOT</code> mounted read\u2011only when present - Network disabled by default for repeatability and safety</p> <p>Security &amp; limits: - Reads/writes confined to the workspace - Timeouts and read\u2011only skill trees reduce risk - Output file read size is capped to prevent oversized payloads</p>"},{"location":"skill/#events-and-tracing","title":"Events and Tracing","text":"<p>Tools emit <code>tool.response</code> events and may carry state deltas (used by <code>skill_load</code>). Merging/parallel execution logic: [internal/flow/processor/functioncall.go] (internal/flow/processor/functioncall.go)</p> <p>Common spans: - <code>workspace.create</code>, <code>workspace.stage.*</code>, <code>workspace.run</code> - <code>workspace.collect</code>, <code>workspace.cleanup</code>, <code>workspace.inline</code></p>"},{"location":"skill/#rationale-and-design-brief","title":"Rationale and Design (brief)","text":"<ul> <li>Motivation: Skills often contain lengthy instructions and scripts.   Inlining all of them is costly and risky. The three\u2011layer model keeps   the prompt lean while loading details and running code only when needed.</li> <li>Injection &amp; state: Tools write temporary keys (via <code>StateDelta</code>), and   the next request processor builds the system message accordingly.</li> <li>Isolation: Scripts run within a workspace boundary and only selected   output files are brought back, not the script source.</li> </ul>"},{"location":"skill/#troubleshooting","title":"Troubleshooting","text":"<ul> <li>Unknown skill: verify name and repository path; ensure the overview   lists the skill before calling <code>skill_load</code></li> <li>Nil executor: configure <code>WithCodeExecutor</code> or rely on the local   default</li> <li>Timeouts/non\u2011zero exit codes: inspect command/deps/<code>timeout</code>; in   container mode, network is disabled by default</li> <li>Missing output files: check your glob patterns and output locations</li> </ul>"},{"location":"skill/#references-and-examples","title":"References and Examples","text":"<ul> <li>Background:<ul> <li>Blog:   https://www.anthropic.com/engineering/equipping-agents-for-the-real-world-with-agent-skills</li> <li>Open repo: https://github.com/anthropics/skills</li> </ul> </li> <li>This repo:<ul> <li>Interactive demo: [examples/skillrun/main.go]   (https://github.com/trpc-group/trpc-agent-go/blob/main/examples/skillrun/main.go)</li> <li>Sample skill: [examples/skillrun/skills/python_math/SKILL.md]   (https://github.com/trpc-group/trpc-agent-go/blob/main/examples/skillrun/skills/python_math/SKILL.md)</li> </ul> </li> </ul>"},{"location":"tool/","title":"Tool Usage Guide","text":"<p>The Tool system is a core component of the tRPC-Agent-Go framework, enabling Agents to interact with external services and functions. The framework supports multiple tool types, including Function Tools and external tools integrated via the MCP (Model Context Protocol) standard.</p>"},{"location":"tool/#overview","title":"Overview","text":""},{"location":"tool/#key-features","title":"\ud83c\udfaf Key Features","text":"<ul> <li>\ud83d\udd27 Multiple Tool Types: Supports Function Tools and MCP standard tools.</li> <li>\ud83c\udf0a Streaming Responses: Supports both real-time streaming responses and normal responses.</li> <li>\u26a1 Parallel Execution: Tool invocations support parallel execution to improve performance.</li> <li>\ud83d\udd04 MCP Protocol: Full support for STDIO, SSE, and Streamable HTTP transports.</li> <li>\ud83d\udee0\ufe0f Configuration Support: Provides configuration options and filter support.</li> </ul>"},{"location":"tool/#core-concepts","title":"Core Concepts","text":""},{"location":"tool/#tool","title":"\ud83d\udd27 Tool","text":"<p>A Tool is an abstraction of a single capability that implements the <code>tool.Tool</code> interface. Each Tool provides specific functionality such as mathematical calculation, search, time query, etc.</p> <pre><code>type Tool interface {\n    Declaration() *Declaration  // Return tool metadata.\n}\n\ntype CallableTool interface {\n    Call(ctx context.Context, jsonArgs []byte) (any, error)\n    Tool\n}\n</code></pre>"},{"location":"tool/#toolset","title":"\ud83d\udce6 ToolSet","text":"<p>A ToolSet is a collection of related tools that implements the <code>tool.ToolSet</code> interface. A ToolSet manages the lifecycle of tools, connections, and resource cleanup.</p> <pre><code>type ToolSet interface {\n    // Tools returns the current tools in this set.\n    Tools(context.Context) []tool.Tool\n\n    // Close releases any resources held by the ToolSet.\n    Close() error\n\n    // Name returns the identifier of the ToolSet, used for\n    // identification and conflict resolution.\n    Name() string\n}\n</code></pre> <p>Relationship between Tool and ToolSet:</p> <ul> <li>One \"Tool\" = one concrete capability (e.g., calculator).</li> <li>One \"ToolSet\" = a group of related Tools (e.g., all tools provided by an MCP server).</li> <li>An Agent can use multiple Tools and multiple ToolSets simultaneously.</li> </ul>"},{"location":"tool/#streaming-tool-support","title":"\ud83c\udf0a Streaming Tool Support","text":"<p>The framework supports streaming tools to provide real-time responses:</p> <pre><code>// Streaming tool interface.\ntype StreamableTool interface {\n    StreamableCall(ctx context.Context, jsonArgs []byte) (*StreamReader, error)\n    Tool\n}\n\n// Streaming data unit.\ntype StreamChunk struct {\n    Content  any      `json:\"content\"`\n    Metadata Metadata `json:\"metadata,omitempty\"`\n}\n</code></pre> <p>Streaming tool characteristics:</p> <ul> <li>\ud83d\ude80 Real-time responses: Data is returned progressively without waiting for the complete result.</li> <li>\ud83d\udcca Large data handling: Suitable for scenarios such as log queries and data analysis.</li> <li>\u26a1 User experience: Provides instant feedback and progress display.</li> </ul>"},{"location":"tool/#tool-types","title":"Tool Types","text":"Tool Type Definition Integration Method Function Tools Tools implemented by directly calling Go functions <code>Tool</code> interface, in-process calls Agent Tool (AgentTool) Wrap any Agent as a callable tool <code>Tool</code> interface, supports streaming inner forwarding DuckDuckGo Tool Search tool based on DuckDuckGo API <code>Tool</code> interface, HTTP API MCP ToolSet External toolset based on MCP protocol <code>ToolSet</code> interface, multiple transports <p>\ud83d\udcd6 Related docs: For Agent Tool and Transfer Tool used in multi-Agent collaboration, see the Multi-Agent System document.</p>"},{"location":"tool/#function-tools","title":"Function Tools","text":"<p>Function Tools implement tool logic directly via Go functions and are the simplest tool type.</p>"},{"location":"tool/#basic-usage","title":"Basic Usage","text":"<pre><code>import \"trpc.group/trpc-go/trpc-agent-go/tool/function\"\n\n// 1. Define a tool function.\nfunc calculator(ctx context.Context, req struct {\n    Operation string  `json:\"operation\"`\n    A         float64 `json:\"a\"`\n    B         float64 `json:\"b\"`\n}) (map[string]interface{}, error) {\n    switch req.Operation {\n    case \"add\":\n        return map[string]interface{}{\"result\": req.A + req.B}, nil\n    case \"multiply\":\n        return map[string]interface{}{\"result\": req.A * req.B}, nil\n    default:\n        return nil, fmt.Errorf(\"unsupported operation: %s\", req.Operation)\n    }\n}\n\n// 2. Create the tool.\ncalculatorTool := function.NewFunctionTool(\n    calculator,\n    function.WithName(\"calculator\"),\n    function.WithDescription(\"Perform mathematical operations.\"),\n)\n\n// 3. Integrate into an Agent.\nagent := llmagent.New(\"math-assistant\",\n    llmagent.WithModel(model),\n    llmagent.WithTools([]tool.Tool{calculatorTool}))\n</code></pre>"},{"location":"tool/#streaming-tool-example","title":"Streaming Tool Example","text":"<pre><code>// 1. Define input and output structures.\ntype weatherInput struct {\n    Location string `json:\"location\"`\n}\n\ntype weatherOutput struct {\n    Weather string `json:\"weather\"`\n}\n\n// 2. Implement the streaming tool function.\nfunc getStreamableWeather(input weatherInput) *tool.StreamReader {\n    stream := tool.NewStream(10)\n    go func() {\n        defer stream.Writer.Close()\n\n        // Simulate progressively returning weather data.\n        result := \"Sunny, 25\u00b0C in \" + input.Location\n        for i := 0; i &lt; len(result); i++ {\n            chunk := tool.StreamChunk{\n                Content: weatherOutput{\n                    Weather: result[i : i+1],\n                },\n                Metadata: tool.Metadata{CreatedAt: time.Now()},\n            }\n\n            if closed := stream.Writer.Send(chunk, nil); closed {\n                break\n            }\n            time.Sleep(10 * time.Millisecond) // Simulate latency.\n        }\n    }()\n\n    return stream.Reader\n}\n\n// 3. Create the streaming tool.\nweatherStreamTool := function.NewStreamableFunctionTool[weatherInput, weatherOutput](\n    getStreamableWeather,\n    function.WithName(\"get_weather_stream\"),\n    function.WithDescription(\"Get weather information as a stream.\"),\n)\n\n// 4. Use the streaming tool.\nreader, err := weatherStreamTool.StreamableCall(ctx, jsonArgs)\nif err != nil {\n    return err\n}\n\n// Receive streaming data.\nfor {\n    chunk, err := reader.Recv()\n    if err == io.EOF {\n        break // End of stream.\n    }\n    if err != nil {\n        return err\n    }\n\n    // Process each chunk.\n    fmt.Printf(\"Received: %v\\n\", chunk.Content)\n}\nreader.Close()\n</code></pre>"},{"location":"tool/#built-in-tools","title":"Built-in Tools","text":""},{"location":"tool/#duckduckgo-search-tool","title":"DuckDuckGo Search Tool","text":"<p>The DuckDuckGo tool is based on the DuckDuckGo Instant Answer API and provides factual and encyclopedia-style information search capabilities.</p>"},{"location":"tool/#basic-usage_1","title":"Basic Usage","text":"<pre><code>import \"trpc.group/trpc-go/trpc-agent-go/tool/duckduckgo\"\n\n// Create a DuckDuckGo search tool.\nsearchTool := duckduckgo.NewTool()\n\n// Integrate into an Agent.\nsearchAgent := llmagent.New(\"search-assistant\",\n    llmagent.WithModel(model),\n    llmagent.WithTools([]tool.Tool{searchTool}))\n</code></pre>"},{"location":"tool/#advanced-configuration","title":"Advanced Configuration","text":"<pre><code>import (\n    \"net/http\"\n    \"time\"\n    \"trpc.group/trpc-go/trpc-agent-go/tool/duckduckgo\"\n)\n\n// Custom configuration.\nsearchTool := duckduckgo.NewTool(\n    duckduckgo.WithBaseURL(\"https://api.duckduckgo.com\"),\n    duckduckgo.WithUserAgent(\"my-app/1.0\"),\n    duckduckgo.WithHTTPClient(&amp;http.Client{\n        Timeout: 15 * time.Second,\n    }),\n)\n</code></pre>"},{"location":"tool/#mcp-tools","title":"MCP Tools","text":"<p>MCP (Model Context Protocol) is an open protocol that standardizes how applications provide context to LLMs. MCP tools are based on JSON-RPC 2.0 and provide standardized integration with external services for Agents.</p> <p>MCP ToolSet Features:</p> <ul> <li>\ud83d\udd17 Unified interface: All MCP tools are created via <code>mcp.NewMCPToolSet()</code>.</li> <li>\u2705 Explicit initialization: <code>(*mcp.ToolSet).Init(ctx)</code> lets you fail fast on MCP connection / tool loading errors during startup.</li> <li>\ud83d\ude80 Multiple transports: Supports STDIO, SSE, and Streamable HTTP.</li> <li>\ud83d\udd27 Tool filters: Supports including/excluding specific tools.</li> </ul>"},{"location":"tool/#basic-usage_2","title":"Basic Usage","text":"<pre><code>import \"trpc.group/trpc-go/trpc-agent-go/tool/mcp\"\n\n// Create an MCP ToolSet (STDIO example).\nmcpToolSet := mcp.NewMCPToolSet(\n    mcp.ConnectionConfig{\n        Transport: \"stdio\",           // Transport method.\n        Command:   \"go\",              // Command to execute.\n        Args:      []string{\"run\", \"./stdio_server/main.go\"},\n        Timeout:   10 * time.Second,\n    },\n    mcp.WithToolFilterFunc(tool.NewIncludeToolNamesFilter(\"echo\", \"add\")), // Optional: tool filter.\n)\n\n// (Optional but recommended) Explicitly initialize MCP: connect + initialize + list tools.\nif err := mcpToolSet.Init(ctx); err != nil {\n    log.Fatalf(\"failed to initialize MCP toolset: %v\", err)\n}\n\n// Integrate into an Agent.\nagent := llmagent.New(\"mcp-assistant\",\n    llmagent.WithModel(model),\n    llmagent.WithToolSets([]tool.ToolSet{mcpToolSet}))\n</code></pre>"},{"location":"tool/#transport-configuration","title":"Transport Configuration","text":"<p>MCP ToolSet supports three transports via the <code>Transport</code> field:</p>"},{"location":"tool/#1-stdio-transport","title":"1. STDIO Transport","text":"<p>Communicates with external processes via standard input/output. Suitable for local scripts and CLI tools.</p> <pre><code>mcpToolSet := mcp.NewMCPToolSet(\n    mcp.ConnectionConfig{\n        Transport: \"stdio\",\n        Command:   \"python\",\n        Args:      []string{\"-m\", \"my_mcp_server\"},\n        Timeout:   10 * time.Second,\n    },\n)\n</code></pre>"},{"location":"tool/#2-sse-transport","title":"2. SSE Transport","text":"<p>Uses Server-Sent Events for communication, supporting real-time data push and streaming responses.</p> <pre><code>mcpToolSet := mcp.NewMCPToolSet(\n    mcp.ConnectionConfig{\n        Transport: \"sse\",\n        ServerURL: \"http://localhost:8080/sse\",\n        Timeout:   10 * time.Second,\n        Headers: map[string]string{\n            \"Authorization\": \"Bearer your-token\",\n        },\n    },\n)\n</code></pre>"},{"location":"tool/#3-streamable-http-transport","title":"3. Streamable HTTP Transport","text":"<p>Uses standard HTTP for communication, supporting both regular HTTP and streaming responses.</p> <pre><code>mcpToolSet := mcp.NewMCPToolSet(\n    mcp.ConnectionConfig{\n        Transport: \"streamable_http\",  // Use the full name.\n        ServerURL: \"http://localhost:3000/mcp\",\n        Timeout:   10 * time.Second,\n    },\n)\n</code></pre>"},{"location":"tool/#session-reconnection-support","title":"Session Reconnection Support","text":"<p>MCP ToolSet supports automatic session reconnection to recover from server restarts or session expiration.</p> <pre><code>// SSE/Streamable HTTP transports support session reconnection\nsseToolSet := mcp.NewMCPToolSet(\n    mcp.ConnectionConfig{\n        Transport: \"sse\",\n        ServerURL: \"http://localhost:8080/sse\",\n        Timeout:   10 * time.Second,\n    },\n    mcp.WithSessionReconnect(3), // Enable session reconnection with max 3 attempts\n)\n</code></pre> <p>Reconnection Features:</p> <ul> <li>\ud83d\udd04 Auto Reconnect: Automatically recreates session when connection loss or expiration is detected</li> <li>\ud83c\udfaf Independent Retries: Each tool call gets independent reconnection attempts</li> <li>\ud83d\udee1\ufe0f Conservative Strategy: Only triggers reconnection for clear connection/session errors to avoid infinite loops</li> </ul>"},{"location":"tool/#dynamic-mcp-tool-discovery-llmagent-option","title":"Dynamic MCP Tool Discovery (LLMAgent Option)","text":"<p>For MCP ToolSets, the list of tools on the server side can change over time (for example, when a new MCP tool is registered). To let an LLMAgent automatically see the latest tools from a ToolSet on each run, use <code>llmagent.WithRefreshToolSetsOnRun(true)</code> together with <code>WithToolSets</code>.</p>"},{"location":"tool/#llmagent-configuration-example","title":"LLMAgent configuration example","text":"<pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/agent/llmagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/openai\"\n    \"trpc.group/trpc-go/trpc-agent-go/tool\"\n    \"trpc.group/trpc-go/trpc-agent-go/tool/mcp\"\n)\n\n// 1. Create an MCP ToolSet (can be STDIO, SSE, or Streamable HTTP).\nmcpToolSet := mcp.NewMCPToolSet(connectionConfig)\n\n// 2. Create an LLMAgent and enable dynamic ToolSets refresh.\nagent := llmagent.New(\n    \"mcp-assistant\",\n    llmagent.WithModel(openai.New(\"gpt-4o-mini\")),\n    llmagent.WithToolSets([]tool.ToolSet{mcpToolSet}),\n    llmagent.WithRefreshToolSetsOnRun(true),\n)\n</code></pre> <p>When <code>WithRefreshToolSetsOnRun(true)</code> is enabled:</p> <ul> <li>Each time the LLMAgent builds its tool list, it calls   <code>ToolSet.Tools(context.Background())</code> again.</li> <li>If the MCP server adds or removes tools, the next run of this   LLMAgent will use the updated tool list automatically.</li> </ul> <p>This option focuses on dynamic discovery of tools. If you also need per-request HTTP headers (for example, authentication headers that come from <code>context.Context</code>), keep using the pattern shown in the <code>examples/mcptool/http_headers</code> example, where you manually call <code>toolSet.Tools(ctx)</code> and pass the tools via <code>WithTools</code>.</p>"},{"location":"tool/#agent-tool-agenttool","title":"Agent Tool (AgentTool)","text":"<p>AgentTool lets you expose an existing Agent as a tool to be used by a parent Agent. Compared with a plain function tool, AgentTool provides:</p> <ul> <li>\u2705 Reuse: Wrap complex Agent capabilities as a standard tool</li> <li>\ud83c\udf0a Streaming: Optionally forward the child Agent\u2019s streaming events inline to the parent flow</li> <li>\ud83e\udded Control: Options to skip post-tool summarization and to enable/disable inner forwarding</li> </ul>"},{"location":"tool/#basic-usage_3","title":"Basic Usage","text":"<pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/agent/llmagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/model\"\n    \"trpc.group/trpc-go/trpc-agent-go/tool\"\n    agenttool \"trpc.group/trpc-go/trpc-agent-go/tool/agent\"\n)\n\n// 1) Define a reusable child Agent (streaming recommended)\nmathAgent := llmagent.New(\n    \"math-specialist\",\n    llmagent.WithModel(modelInstance),\n    llmagent.WithInstruction(\"You are a math specialist...\"),\n    llmagent.WithGenerationConfig(model.GenerationConfig{Stream: true}),\n)\n\n// 2) Wrap as an Agent tool\nmathTool := agenttool.NewTool(\n    mathAgent,\n    // Optional, defaults to false. When set to true, the outer model summary will be skipped, \n    // and the current round will end directly after tool.response.\n    agenttool.WithSkipSummarization(false),\n    // forward child Agent streaming events to parent flow.\n    agenttool.WithStreamInner(true),\n)\n\n// 3) Use in parent Agent\nparent := llmagent.New(\n    \"assistant\",\n    llmagent.WithModel(modelInstance),\n    llmagent.WithGenerationConfig(model.GenerationConfig{Stream: true}),\n    llmagent.WithTools([]tool.Tool{mathTool}),\n)\n</code></pre>"},{"location":"tool/#streaming-inner-forwarding","title":"Streaming Inner Forwarding","text":"<p>When <code>WithStreamInner(true)</code> is enabled, AgentTool forwards child Agent events to the parent flow as they happen:</p> <ul> <li>Forwarded items are actual <code>event.Event</code> instances, carrying incremental text in <code>choice.Delta.Content</code></li> <li>To avoid duplication, the child Agent\u2019s final full message is not forwarded again; it is aggregated into the final <code>tool.response</code> content for the next LLM turn (to satisfy providers requiring tool messages)</li> <li>UI guidance: show forwarded child deltas; avoid printing the aggregated final <code>tool.response</code> content unless debugging</li> </ul> <p>Example: Only show tool fragments when needed to avoid duplicates</p> <pre><code>if ev.Response != nil &amp;&amp; ev.Object == model.ObjectTypeToolResponse {\n    // Tool response contains aggregated content; skip printing by default to avoid duplicates\n}\n\n// Child Agent forwarded deltas (author != parent)\nif ev.Author != parentName &amp;&amp; len(ev.Choices) &gt; 0 {\n    if delta := ev.Choices[0].Delta.Content; delta != \"\" {\n        fmt.Print(delta)\n    }\n}\n</code></pre>"},{"location":"tool/#options","title":"Options","text":"<ul> <li> <p>WithSkipSummarization(bool):</p> <ul> <li>false (default): Allow an additional summarization/answer call after the tool result</li> <li>true: Skip the outer summarization LLM call once the tool returns</li> </ul> </li> </ul> <ul> <li> <p>WithStreamInner(bool):</p> <ul> <li>true: Forward child Agent events to the parent flow (recommended: enable <code>GenerationConfig{Stream: true}</code> for both parent and child Agents)</li> <li>false: Treat as a callable-only tool, without inner event forwarding</li> </ul> </li> </ul> <ul> <li>WithHistoryScope(HistoryScope):<ul> <li><code>HistoryScopeIsolated</code> (default): Keep the child Agent fully isolated; it only sees the current tool arguments (no inherited history).</li> <li><code>HistoryScopeParentBranch</code>: Inherit parent conversation history by using a hierarchical filter key <code>parent/child-uuid</code>. This allows the content processor to include parent events via prefix matching while keeping child events isolated under a sub-branch. Typical use cases: \u201cedit/optimize/continue previous output\u201d.</li> </ul> </li> </ul> <p>Example:</p> <pre><code>child := agenttool.NewTool(\n    childAgent,\n    agenttool.WithSkipSummarization(false),\n    agenttool.WithStreamInner(true),\n    agenttool.WithHistoryScope(agenttool.HistoryScopeParentBranch),\n)\n</code></pre>"},{"location":"tool/#notes","title":"Notes","text":"<ul> <li>Completion signaling: Tool response events are marked <code>RequiresCompletion=true</code>; Runner sends completion automatically</li> <li>De-duplication: When inner deltas are forwarded, avoid printing the aggregated final <code>tool.response</code> text again by default</li> <li>Model compatibility: Some providers require a tool message after tool_calls; AgentTool automatically supplies the aggregated content</li> </ul>"},{"location":"tool/#tool-integration-and-usage","title":"Tool Integration and Usage","text":""},{"location":"tool/#create-an-agent-and-integrate-tools","title":"Create an Agent and Integrate Tools","text":"<pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/agent/llmagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/tool\"\n    \"trpc.group/trpc-go/trpc-agent-go/tool/function\"\n    \"trpc.group/trpc-go/trpc-agent-go/tool/duckduckgo\"\n    \"trpc.group/trpc-go/trpc-agent-go/tool/mcp\"\n)\n\n// Create function tools.\ncalculatorTool := function.NewFunctionTool(calculator,\n    function.WithName(\"calculator\"),\n    function.WithDescription(\"Perform basic mathematical operations.\"))\n\ntimeTool := function.NewFunctionTool(getCurrentTime,\n    function.WithName(\"current_time\"),\n    function.WithDescription(\"Get the current time.\"))\n\n// Create a built-in tool.\nsearchTool := duckduckgo.NewTool()\n\n// Create MCP ToolSets (examples for different transports).\nstdioToolSet := mcp.NewMCPToolSet(\n    mcp.ConnectionConfig{\n        Transport: \"stdio\",\n        Command:   \"python\",\n        Args:      []string{\"-m\", \"my_mcp_server\"},\n        Timeout:   10 * time.Second,\n    },\n)\nif err := stdioToolSet.Init(ctx); err != nil {\n    return fmt.Errorf(\"failed to initialize stdio MCP toolset: %w\", err)\n}\n\nsseToolSet := mcp.NewMCPToolSet(\n    mcp.ConnectionConfig{\n        Transport: \"sse\",\n        ServerURL: \"http://localhost:8080/sse\",\n        Timeout:   10 * time.Second,\n    },\n)\nif err := sseToolSet.Init(ctx); err != nil {\n    return fmt.Errorf(\"failed to initialize sse MCP toolset: %w\", err)\n}\n\nstreamableToolSet := mcp.NewMCPToolSet(\n    mcp.ConnectionConfig{\n        Transport: \"streamable_http\",\n        ServerURL: \"http://localhost:3000/mcp\",\n        Timeout:   10 * time.Second,\n    },\n)\nif err := streamableToolSet.Init(ctx); err != nil {\n    return fmt.Errorf(\"failed to initialize streamable MCP toolset: %w\", err)\n}\n\n// Create an Agent and integrate all tools.\nagent := llmagent.New(\"ai-assistant\",\n    llmagent.WithModel(model),\n    llmagent.WithInstruction(\"You are a helpful AI assistant that can use various tools to help users.\"),\n    // Add single tools (Tool interface).\n    llmagent.WithTools([]tool.Tool{\n        calculatorTool, timeTool, searchTool,\n    }),\n    // Add ToolSets (ToolSet interface).\n    llmagent.WithToolSets([]tool.ToolSet{\n        stdioToolSet, sseToolSet, streamableToolSet,\n    }),\n)\n</code></pre>"},{"location":"tool/#mcp-tool-filters","title":"MCP Tool Filters","text":"<p>MCP ToolSets support filtering tools at creation time. It's recommended to use the unified <code>tool.FilterFunc</code> interface:</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/tool\"\n    \"trpc.group/trpc-go/trpc-agent-go/tool/mcp\"\n)\n\n// \u2705 Recommended: Use the unified filter interface\nincludeFilter := tool.NewIncludeToolNamesFilter(\"get_weather\", \"get_news\", \"calculator\")\nexcludeFilter := tool.NewExcludeToolNamesFilter(\"deprecated_tool\", \"slow_tool\")\n\n// Apply filter\ntoolSet := mcp.NewMCPToolSet(\n    connectionConfig,\n    mcp.WithToolFilterFunc(includeFilter),\n)\n\n// Optional: initialize once at startup to catch MCP connection / tool loading errors early.\nif err := toolSet.Init(ctx); err != nil {\n    return fmt.Errorf(\"failed to initialize MCP toolset: %w\", err)\n}\n</code></pre>"},{"location":"tool/#per-run-tool-filtering","title":"Per-Run Tool Filtering","text":"<ul> <li>Option one: Per-run tool filtering enables dynamic control of tool availability for each <code>runner.Run</code> invocation without modifying Agent configuration. This is a \"soft constraint\" mechanism for optimizing token consumption and implementing role-based tool access control. apply to all agents</li> <li>Option two: Configure the runtime filtering function through 'llmagent. WhatToolFilter' to only apply to the current agent Key Features:</li> </ul> <ul> <li>\ud83c\udfaf Per-Run Control: Independent configuration per invocation, no Agent modification needed</li> <li>\ud83d\udcb0 Cost Optimization: Reduce tool descriptions sent to LLM, lowering token costs</li> <li>\ud83d\udee1\ufe0f Smart Protection: Framework tools (<code>transfer_to_agent</code>, <code>knowledge_search</code>) automatically preserved, never filtered</li> <li>\ud83d\udd27 Flexible Customization: Support for built-in filters and custom FilterFunc</li> </ul>"},{"location":"tool/#basic-usage_4","title":"Basic Usage","text":"<p>1. Exclude Specific Tools (Exclude Filter)</p> <p>Use blacklist approach to exclude unwanted tools:</p> <pre><code>import \"trpc.group/trpc-go/trpc-agent-go/tool\"\n\n// Option 1:\n// Exclude text_tool and dangerous_tool, all other tools available\nfilter := tool.NewExcludeToolNamesFilter(\"text_tool\", \"dangerous_tool\")\neventChan, err := runner.Run(ctx, userID, sessionID, message,\n    agent.WithToolFilter(filter),\n)\n\n// Option 2:\nagent := llmagent.New(\"ai-assistant\",\n    llmagent.WithModel(model),\n    llmagent.WithInstruction(\"You are a helpful AI assistant that can use various tools to help users.\"),\n    llmagent.WithTools([]tool.Tool{\n        calculatorTool, timeTool, searchTool,\n    }),\n    llmagent.WithToolSets([]tool.ToolSet{\n        stdioToolSet, sseToolSet, streamableToolSet,\n    }),\n    llmagent.WithToolFilter(filter),\n)\n</code></pre> <p>2. Include Only Specific Tools (Include Filter)</p> <p>Use whitelist approach to allow only specified tools:</p> <pre><code>// Only allow calculator and time tool\nfilter := tool.NewIncludeToolNamesFilter(\"calculator\", \"time_tool\")\neventChan, err := runner.Run(ctx, userID, sessionID, message,\n    agent.WithToolFilter(filter),\n)\n</code></pre> <p>3. Custom Filtering Logic (Custom FilterFunc)</p> <p>Implement custom filter function for complex filtering logic:</p> <pre><code>// Option 1:\n// Custom filter: only allow tools with names starting with \"safe_\"\nfilter := func(ctx context.Context, t tool.Tool) bool {\n    declaration := t.Declaration()\n    if declaration == nil {\n        return false\n    }\n    return strings.HasPrefix(declaration.Name, \"safe_\")\n}\n\neventChan, err := runner.Run(ctx, userID, sessionID, message,\n    agent.WithToolFilter(filter),\n)\n\n// Option 2:\nagent := llmagent.New(\"ai-assistant\",\n    llmagent.WithModel(model),\n    llmagent.WithInstruction(\"You are a helpful AI assistant that can use various tools to help users.\"),\n    llmagent.WithTools([]tool.Tool{\n        calculatorTool, timeTool, searchTool,\n    }),\n    llmagent.WithToolSets([]tool.ToolSet{\n        stdioToolSet, sseToolSet, streamableToolSet,\n    }),\n    llmagent.WithToolFilter(filter),\n</code></pre> <p>4. Per-Agent Filtering</p> <p>Use <code>agent.InvocationFromContext</code> to implement different tool sets for different Agents:</p> <pre><code>// Define allowed tools for each Agent\nagentAllowedTools := map[string]map[string]bool{\n    \"math-agent\": {\n        \"calculator\": true,\n    },\n    \"time-agent\": {\n        \"time_tool\": true,\n    },\n}\n\n// Custom filter function: filter based on current Agent name\nfilter := func(ctx context.Context, t tool.Tool) bool {\n    declaration := t.Declaration()\n    if declaration == nil {\n        return false\n    }\n    toolName := declaration.Name\n\n    // Get current Agent information from context\n    inv, ok := agent.InvocationFromContext(ctx)\n    if !ok || inv == nil {\n        return true // fallback: allow all tools\n    }\n\n    agentName := inv.AgentName\n\n    // Check if this tool is in the current Agent's allowed list\n    allowedTools, exists := agentAllowedTools[agentName]\n    if !exists {\n        return true // fallback: allow all tools\n    }\n\n    return allowedTools[toolName]\n}\n\neventChan, err := runner.Run(ctx, userID, sessionID, message,\n    agent.WithToolFilter(filter),\n)\n</code></pre> <p>Complete Example: See <code>examples/toolfilter/</code> directory</p>"},{"location":"tool/#smart-filtering-mechanism","title":"Smart Filtering Mechanism","text":"<p>The framework automatically distinguishes user tools from framework tools, filtering only user tools:</p> Tool Category Includes Filtered? User Tools Tools registered via <code>WithTools</code>Tools registered via <code>WithToolSets</code> \u2705 Subject to filtering Framework Tools <code>transfer_to_agent</code> (multi-Agent coordination)<code>knowledge_search</code> (knowledge base retrieval)<code>agentic_knowledge_search</code> \u274c Never filtered, auto-preserved <p>Example:</p> <pre><code>// Agent registers multiple tools\nagent := llmagent.New(\"assistant\",\n    llmagent.WithTools([]tool.Tool{\n        calculatorTool,  // User tool\n        textTool,        // User tool\n    }),\n    llmagent.WithSubAgents([]agent.Agent{subAgent1, subAgent2}), // Auto-adds transfer_to_agent\n    llmagent.WithKnowledge(kb),                                   // Auto-adds knowledge_search\n)\n\n// Runtime filtering: only allow calculator\nfilter := tool.NewIncludeToolNamesFilter(\"calculator\")\nrunner.Run(ctx, userID, sessionID, message,\n    agent.WithToolFilter(filter),\n)\n\n// Tools actually sent to LLM:\n// \u2705 calculator        - User tool, in allowed list\n// \u274c textTool          - User tool, filtered out\n// \u2705 transfer_to_agent - Framework tool, auto-preserved\n// \u2705 knowledge_search  - Framework tool, auto-preserved\n</code></pre>"},{"location":"tool/#important-notes","title":"Important Notes","text":"<p>\u26a0\ufe0f Security Notice: Per-run tool filtering is a \"soft constraint\" primarily for optimization and user experience. Tools must still implement their own authorization logic:</p> <pre><code>func sensitiveOperation(ctx context.Context, req Request) (Result, error) {\n    // \u2705 Required: internal tool authorization\n    if !hasPermission(ctx, req.UserID, \"sensitive_operation\") {\n        return nil, fmt.Errorf(\"permission denied\")\n    }\n\n    // Execute operation\n    return performOperation(req)\n}\n</code></pre> <p>Reason: LLMs may know about tool existence and usage from context or memory and attempt to call them. Tool filtering reduces this possibility but cannot completely prevent it.</p>"},{"location":"tool/#parallel-tool-execution","title":"Parallel Tool Execution","text":"<pre><code>// Enable parallel tool execution (optional, for performance optimization).\nagent := llmagent.New(\"ai-assistant\",\n    llmagent.WithModel(model),\n    llmagent.WithTools(tools),\n    llmagent.WithToolSets(toolSets),\n    llmagent.WithEnableParallelTools(true), // Enable parallel execution.\n)\n</code></pre> <p>Graph workflows can also enable parallelism for a Tools node:</p> <pre><code>stateGraph.AddToolsNode(\"tools\", tools, graph.WithEnableParallelTools(true))\n</code></pre> <p>Parallel execution effect:</p> <pre><code># Parallel execution (enabled).\nTool 1: get_weather     [====] 50ms\nTool 2: get_population  [====] 50ms\nTool 3: get_time       [====] 50ms\nTotal time: ~50ms (executed simultaneously)\n\n# Serial execution (default).\nTool 1: get_weather     [====] 50ms\nTool 2: get_population       [====] 50ms\nTool 3: get_time                  [====] 50ms\nTotal time: ~150ms (executed sequentially)\n</code></pre>"},{"location":"tool/#dynamic-toolset-management-runtime","title":"Dynamic ToolSet Management (Runtime)","text":"<p><code>WithToolSets</code> is a static configuration: it wires ToolSets when constructing the Agent. In many real\u2011world scenarios you also need to add, remove, or replace ToolSets at runtime without recreating the Agent.</p> <p>LLMAgent exposes three methods for this:</p> <ul> <li><code>AddToolSet(toolSet tool.ToolSet)</code> \u2014 add or replace a ToolSet by <code>ToolSet.Name()</code>.</li> <li><code>RemoveToolSet(name string) bool</code> \u2014 remove all ToolSets whose <code>Name()</code> matches <code>name</code>.</li> <li><code>SetToolSets(toolSets []tool.ToolSet)</code> \u2014 replace all ToolSets with the provided slice.</li> </ul> <p>These methods are concurrency\u2011safe and automatically recompute:</p> <ul> <li>Aggregated tools (direct tools + ToolSets + knowledge tools + skill tools)</li> <li>User tool tracking (used by the smart filtering logic above)</li> </ul> <p>Typical usage pattern:</p> <pre><code>// 1. Create Agent with base tools only.\nagent := llmagent.New(\"dynamic-assistant\",\n    llmagent.WithModel(model),\n    llmagent.WithTools([]tool.Tool{calculatorTool}),\n)\n\n// 2. Later, attach an MCP ToolSet at runtime.\nmcpToolSet := mcp.NewMCPToolSet(connectionConfig)\nif err := mcpToolSet.Init(ctx); err != nil {\n    return fmt.Errorf(\"failed to init MCP ToolSet: %w\", err)\n}\nagent.AddToolSet(mcpToolSet)\n\n// 3. Replace all ToolSets from configuration (declarative control plane).\ntoolSetsFromConfig := []tool.ToolSet{mcpToolSet, fileToolSet}\nagent.SetToolSets(toolSetsFromConfig)\n\n// 4. Remove a ToolSet by name (e.g., feature rollback).\nremoved := agent.RemoveToolSet(mcpToolSet.Name())\nif !removed {\n    log.Printf(\"ToolSet %q not found\", mcpToolSet.Name())\n}\n</code></pre> <p>Runtime ToolSet updates integrate seamlessly with the tool filtering logic described earlier:</p> <ul> <li>Tools coming from <code>WithTools</code> or any ToolSet (including dynamically added ones) are treated as user tools and are subject to <code>WithToolFilter</code> and per\u2011run filters.</li> <li>Framework tools such as <code>transfer_to_agent</code>, <code>knowledge_search</code>, and <code>agentic_knowledge_search</code> remain never filtered and are always available.</li> </ul>"},{"location":"tool/#quick-start","title":"Quick Start","text":""},{"location":"tool/#environment-setup","title":"Environment Setup","text":"<pre><code># Set API key.\nexport OPENAI_API_KEY=\"your-api-key\"\n</code></pre>"},{"location":"tool/#simple-example","title":"Simple Example","text":"<pre><code>package main\n\nimport (\n    \"context\"\n    \"fmt\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/runner\"\n    \"trpc.group/trpc-go/trpc-agent-go/agent/llmagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/openai\"\n    \"trpc.group/trpc-go/trpc-agent-go/model\"\n    \"trpc.group/trpc-go/trpc-agent-go/tool/function\"\n)\n\nfunc main() {\n    // 1. Create a simple tool.\n    calculatorTool := function.NewFunctionTool(\n        func(ctx context.Context, req struct {\n            Operation string  `json:\"operation\"`\n            A         float64 `json:\"a\"`\n            B         float64 `json:\"b\"`\n        }) (map[string]interface{}, error) {\n            var result float64\n            switch req.Operation {\n            case \"add\":\n                result = req.A + req.B\n            case \"multiply\":\n                result = req.A * req.B\n            default:\n                return nil, fmt.Errorf(\"unsupported operation\")\n            }\n            return map[string]interface{}{\"result\": result}, nil\n        },\n        function.WithName(\"calculator\"),\n        function.WithDescription(\"Simple calculator.\"),\n    )\n\n    // 2. Create model and Agent.\n    llmModel := openai.New(\"DeepSeek-V3-Online-64K\")\n    agent := llmagent.New(\"calculator-assistant\",\n        llmagent.WithModel(llmModel),\n        llmagent.WithInstruction(\"You are a math assistant.\"),\n        llmagent.WithTools([]tool.Tool{calculatorTool}),\n        llmagent.WithGenerationConfig(model.GenerationConfig{Stream: true}), // Enable streaming output.\n    )\n\n    // 3. Create Runner and execute.\n    r := runner.NewRunner(\"math-app\", agent)\n\n    ctx := context.Background()\n    userMessage := model.NewUserMessage(\"Please calculate 25 times 4.\")\n\n    eventChan, err := r.Run(ctx, \"user1\", \"session1\", userMessage)\n    if err != nil {\n        panic(err)\n    }\n\n    // 4. Handle responses.\n    for event := range eventChan {\n        if event.Error != nil {\n            fmt.Printf(\"Error: %s\\n\", event.Error.Message)\n            continue\n        }\n\n        // Display tool calls.\n        if len(event.Response.Choices) &gt; 0 &amp;&amp; len(event.Response.Choices[0].Message.ToolCalls) &gt; 0 {\n            for _, toolCall := range event.Response.Choices[0].Message.ToolCalls {\n                fmt.Printf(\"\ud83d\udd27 Call tool: %s\\n\", toolCall.Function.Name)\n                fmt.Printf(\"   Params: %s\\n\", string(toolCall.Function.Arguments))\n            }\n        }\n\n        // Display streaming content.\n        if len(event.Response.Choices) &gt; 0 {\n            fmt.Print(event.Response.Choices[0].Delta.Content)\n        }\n\n        if event.Done {\n            break\n        }\n    }\n}\n</code></pre>"},{"location":"tool/#run-the-examples","title":"Run the Examples","text":"<pre><code># Enter the tool example directory.\ncd examples/tool\ngo run .\n\n# Enter the MCP tool example directory.\ncd examples/mcp_tool\n\n# Start the external server.\ncd streamalbe_server &amp;&amp; go run main.go &amp;\n\n# Run the main program.\ngo run main.go -model=\"deepseek-chat\"\n</code></pre>"},{"location":"tool/#summary","title":"Summary","text":"<p>The Tool system provides rich extensibility for tRPC-Agent-Go, supporting Function Tools, the DuckDuckGo Search Tool, and MCP protocol tools.</p>"},{"location":"zh/","title":"tRPC-Agent-Go\uff1a\u8ba9 Go \u5f00\u53d1\u8005\u8f7b\u677e\u6784\u5efa\u667a\u80fd AI \u5e94\u7528","text":""},{"location":"zh/#1","title":"1\u3001\u9879\u76ee\u7b80\u4ecb","text":"<p>tRPC \u56e2\u961f\u4e4b\u524d\u5f00\u6e90\u4e86 A2A \u5f00\u53d1\u6846\u67b6 tRPC-A2A-Go \u548c MCP \u5f00\u53d1\u6846\u67b6 tRPC-MCP-Go\uff0c\u5c24\u5176\u662f tRPC-A2A-Go\uff0c\u5728\u56fd\u5185\u5916\u90fd\u6709\u4e0d\u5c11\u7528\u6237\u8fdb\u884c\u5e94\u7528\u548c\u8d21\u732e\u3002 \u73b0\u5728\u6211\u4eec\u63a8\u51fa tRPC-Agent-Go \u5f00\u53d1\u6846\u67b6\uff0c\u5b9e\u73b0 Go \u8bed\u8a00 AI \u751f\u6001\u5f00\u53d1\u6846\u67b6\u7684\u95ed\u73af\u3002</p> <p>\u5f53\u524d\u4e3b\u6d41 Agent \u6846\u67b6\uff08AutoGen\u3001CrewAI \u3001Agno\u3001ADK \u7b49\uff09\u5927\u90e8\u5206\u90fd\u662f\u57fa\u4e8e Python\uff0c\u800c  Go \u5728\u5fae\u670d\u52a1\u3001\u5e76\u53d1\u4e0e\u90e8\u7f72\u65b9\u9762\u6709\u5929\u7136\u4f18\u52bf\uff0cGo \u5728\u817e\u8baf\u5185\u90e8\u4e5f\u6709\u5927\u89c4\u6a21\u5e94\u7528\uff0c\u4e1a\u754c\u57fa\u4e8e Go \u8bed\u8a00\u7684 Agent \u6846\u67b6\u8f83\u5c11\uff0c\u5927\u90e8\u5206\u90fd\u662f\u7f16\u6392\u5f0f\u7684 workflow \u6846\u67b6\uff0c\u7f3a\u5c11\u771f\u6b63\u7684\u201c\u53bb\u4e2d\u5fc3\u5316\u3001\u53ef\u534f\u4f5c\u3001\u80fd\u6d8c\u73b0\u201d\u7684\u81ea\u4e3b\u591a Agent \u80fd\u529b\u3002tRPC-Agent-Go \u76f4\u63a5\u5229\u7528 Go \u7684\u9ad8\u5e76\u53d1\u4e0e tRPC \u751f\u6001\uff0c\u628a LLM \u7684\u63a8\u7406\u3001\u534f\u5546\u548c\u81ea\u9002\u5e94\u6027\u5e26\u5230 Go \u573a\u666f\uff0c\u6ee1\u8db3\u590d\u6742\u4e1a\u52a1\u5bf9\u201c\u667a\u80fd+\u6027\u80fd\u201d\u7684\u53cc\u91cd\u9700\u6c42\u3002</p>"},{"location":"zh/#2","title":"2\u3001\u67b6\u6784\u8bbe\u8ba1","text":"<p>tRPC-Agent-Go \u91c7\u7528\u6a21\u5757\u5316\u67b6\u6784\u8bbe\u8ba1\uff0c\u7531\u591a\u4e2a\u6838\u5fc3\u7ec4\u4ef6\u7ec4\u6210\uff0c\u7ec4\u4ef6\u90fd\u53ef\u63d2\u62d4\uff0c\u901a\u8fc7\u4e8b\u4ef6\u9a71\u52a8\u673a\u5236\u5b9e\u73b0\u7ec4\u4ef6\u95f4\u7684\u89e3\u8026\u901a\u4fe1\uff0c\u652f\u6301callback\u63d2\u5165\u81ea\u5b9a\u4e49\u903b\u8f91\uff1a</p> <ul> <li>Agent: \u6838\u5fc3\u6267\u884c\u5355\u5143\uff0c\u8d1f\u8d23\u5904\u7406\u7528\u6237\u8f93\u5165\u5e76\u751f\u6210\u54cd\u5e94</li> <li>Runner: Agent \u7684\u6267\u884c\u5668\uff0c\u8d1f\u8d23\u7ba1\u7406\u6267\u884c\u6d41\u7a0b\uff0c\u4e32\u8054 Session/Memory Service \u7b49\u80fd\u529b</li> <li>Model: \u652f\u6301\u591a\u79cd LLM \u6a21\u578b\uff08OpenAI\u3001DeepSeek \u7b49\uff09</li> <li>Tool: \u63d0\u4f9b\u5404\u79cd\u5de5\u5177\u80fd\u529b\uff08Function\u3001MCP\u3001DuckDuckGo \u7b49\uff09</li> <li>Session: \u7ba1\u7406\u7528\u6237\u4f1a\u8bdd\u72b6\u6001\u548c\u4e8b\u4ef6</li> <li>Memory: \u8bb0\u5f55\u7528\u6237\u7684\u957f\u671f\u8bb0\u5fc6\u548c\u4e2a\u6027\u5316\u4fe1\u606f</li> <li>Knowledge: \u5b9e\u73b0 RAG \u77e5\u8bc6\u68c0\u7d22\u80fd\u529b</li> <li>Planner: \u63d0\u4f9b Agent \u7684\u8ba1\u5212\u548c\u63a8\u7406\u80fd\u529b</li> </ul> <p>\u4ee5\u4e0b\u662f\u5404\u4e2a\u7ec4\u4ef6\u7684\u67b6\u6784\u56fe</p> <p></p>"},{"location":"zh/#3","title":"3\u3001\u6838\u5fc3\u7279\u70b9","text":"<p>\u591a\u6837\u5316 Agent \u7cfb\u7edf</p> <ul> <li>LLMAgent: \u57fa\u4e8e\u5927\u8bed\u8a00\u6a21\u578b\uff0c\u652f\u6301\u5de5\u5177\u8c03\u7528\u548c\u63a8\u7406</li> <li>ChainAgent: \u94fe\u5f0f\u6267\u884c\uff0c\u652f\u6301\u591a\u6b65\u9aa4\u4efb\u52a1\u5206\u89e3</li> <li>ParallelAgent: \u5e76\u884c\u5904\u7406\uff0c\u652f\u6301\u591a\u4e13\u5bb6\u534f\u4f5c</li> <li>CycleAgent: \u5faa\u73af\u8fed\u4ee3\uff0c\u652f\u6301\u81ea\u6211\u4f18\u5316</li> <li>GraphAgent: \u56fe\u5de5\u4f5c\u6d41\uff0c\u517c\u5bb9\u73b0\u6709\u7f16\u6392\u4e60\u60ef</li> </ul> <p>\u4e30\u5bcc\u5de5\u5177\u751f\u6001</p> <ul> <li>\u5185\u7f6e\u5e38\u7528\u5de5\u5177</li> <li>\u652f\u6301 Function\u3001MCP \u534f\u8bae\u7b49\u591a\u79cd\u6269\u5c55\u65b9\u5f0f</li> <li>\u7075\u6d3b\u7684\u5de5\u5177\u7ec4\u5408\u548c\u8c03\u7528\u7b56\u7565</li> </ul> <p>\u667a\u80fd\u4f1a\u8bdd\u7ba1\u7406</p> <ul> <li>\u652f\u6301 Redis \u548c\u5185\u5b58\u5b58\u50a8\u7684\u4f1a\u8bdd\u6301\u4e45\u5316</li> <li>\u957f\u671f\u8bb0\u5fc6\u548c\u4e2a\u6027\u5316\u4fe1\u606f\u4fdd\u6301</li> <li>RAG \u68c0\u7d22\u589e\u5f3a\u751f\u6210\u80fd\u529b</li> <li>\u5b9e\u65f6\u4e8b\u4ef6\u9a71\u52a8\u67b6\u6784</li> </ul> <p>\u5168\u94fe\u8def\u53ef\u89c2\u6d4b\u6027</p> <ul> <li>OpenTelemetry \u5168\u94fe\u8def\u8ffd\u8e2a\u548c\u6027\u80fd\u76d1\u63a7</li> <li>\u53ef\u89c6\u5316\u8c03\u8bd5\u754c\u9762\u548c\u5b9e\u65f6\u76d1\u63a7</li> <li>\u7ed3\u6784\u5316\u65e5\u5fd7\u548c\u9519\u8bef\u8ffd\u8e2a</li> </ul>"},{"location":"zh/#4","title":"4\u3001\u5feb\u901f\u5f00\u59cb","text":""},{"location":"zh/#_1","title":"\u57fa\u672c\u7528\u6cd5","text":"<pre><code>package main\n\nimport (\n    \"context\"\n    \"fmt\"\n    \"log\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/agent/llmagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/model\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/openai\"\n    \"trpc.group/trpc-go/trpc-agent-go/runner\"\n    \"trpc.group/trpc-go/trpc-agent-go/tool\"\n    \"trpc.group/trpc-go/trpc-agent-go/tool/function\"\n)\n\nfunc main() {\n    // \u521b\u5efa\u6a21\u578b\n    modelInstance := openai.New(\"deepseek-chat\")\n\n    // \u521b\u5efa\u5de5\u5177\n    calculatorTool := function.NewFunctionTool(\n        calculator,\n        function.WithName(\"calculator\"),\n        function.WithDescription(\"\u6267\u884c\u52a0\u51cf\u4e58\u9664\u3002\u53c2\u6570\uff1aa\u3001b \u4e3a\u6570\u503c\uff0cop \u53d6\u503c add/sub/mul/div\uff1b\u8fd4\u56de result \u4e3a\u8ba1\u7b97\u7ed3\u679c\u3002\"),\n    )\n\n    // \u542f\u7528\u6d41\u5f0f\u8f93\u51fa\n    genConfig := model.GenerationConfig{\n        Stream: true,\n    }\n\n    // \u521b\u5efa Agent\n    agent := llmagent.New(\"assistant\",\n        llmagent.WithModel(modelInstance),\n        llmagent.WithTools([]tool.Tool{calculatorTool}),\n        llmagent.WithGenerationConfig(genConfig),\n    )\n\n    // \u521b\u5efa Runner\n    runner := runner.NewRunner(\"calculator-app\", agent)\n\n    // \u6267\u884c\u5bf9\u8bdd\n    ctx := context.Background()\n    events, err := runner.Run(ctx,\n        \"user-001\",\n        \"session-001\",\n        model.NewUserMessage(\"\u8ba1\u7b97 2+3 \u7b49\u4e8e\u591a\u5c11\"),\n    )\n    if err != nil {\n        log.Fatal(err)\n    }\n\n    // \u5904\u7406\u4e8b\u4ef6\u6d41\n    for event := range events {\n        if event.Object == \"chat.completion.chunk\" {\n            fmt.Print(event.Response.Choices[0].Delta.Content)\n        }\n    }\n    fmt.Println()\n}\n\nfunc calculator(ctx context.Context, req calculatorReq) (calculatorRsp, error) {\n    var result float64\n    switch req.Op {\n    case \"add\", \"+\":\n        result = req.A + req.B\n    case \"sub\", \"-\":\n        result = req.A - req.B\n    case \"mul\", \"*\":\n        result = req.A * req.B\n    case \"div\", \"/\":\n        result = req.A / req.B\n    }\n    return calculatorRsp{Result: result}, nil\n}\n\ntype calculatorReq struct {\n    A  float64 `json:\"a\"`\n    B  float64 `json:\"b\"`\n    Op string  `json:\"op\"`\n}\n\ntype calculatorRsp struct {\n    Result float64 `json:\"result\"`\n}\n</code></pre>"},{"location":"zh/#agent","title":"\u591a Agent \u534f\u52a9\u4f8b\u5b50","text":"<pre><code>// \u521b\u5efa\u94fe\u5f0f Agent\nchainAgent := chainagent.New(\"problem-solver\",\n    chainagent.WithSubAgents([]agent.Agent{\n        analysisAgent,   // \u5206\u6790 Agent\n        executionAgent,  // \u6267\u884c Agent\n    }))\n\n// \u4f7f\u7528 Runner \u6267\u884c\nrunner := runner.NewRunner(\"multi-agent-app\", chainAgent)\nevents, _ := runner.Run(ctx, userID, sessionID, message)\n</code></pre>"},{"location":"zh/#5","title":"5\u3001\u81f4\u8c22","text":"<p>\u611f\u8c22\u817e\u8baf\u5185\u90e8\u4e1a\u52a1\u5982\u817e\u8baf\u5143\u5b9d\uff0c\u817e\u8baf\u89c6\u9891\uff0c\u817e\u8baf\u65b0\u95fb\uff0cIMA\u3001QQ \u97f3\u4e50\u7b49\u7b49\u4e1a\u52a1\u7684\u652f\u6301\uff0c\u4e1a\u52a1\u7684\u573a\u666f\u6253\u78e8\u662f\u5bf9\u6846\u67b6\u6700\u597d\u7684\u9a8c\u8bc1\u3002</p> <p>\u611f\u8c22 ADK\uff0cAgno\uff0cCrewAI\uff0cAutoGen \u7b49\u4f18\u79c0\u5f00\u6e90\u6846\u67b6\u7684\u542f\u53d1\uff0c\u4e3a tRPC-Agent-Go \u5f00\u53d1\u63d0\u4f9b\u7075\u611f\u3002</p>"},{"location":"zh/#6","title":"6\u3001\u9879\u76ee\u5730\u5740","text":"<p>github\uff1atRPC-Agent-Go</p>"},{"location":"zh/a2a/","title":"tRPC-Agent-Go A2A \u96c6\u6210\u6307\u5357","text":""},{"location":"zh/a2a/#_1","title":"\u6982\u8ff0","text":"<p>tRPC-Agent-Go \u63d0\u4f9b\u4e86\u5b8c\u6574\u7684 A2A (Agent-to-Agent) \u89e3\u51b3\u65b9\u6848\uff0c\u5305\u542b\u4e24\u4e2a\u6838\u5fc3\u7ec4\u4ef6\uff1a</p> <ul> <li>A2A Server: \u5c06\u672c\u5730 Agent \u66b4\u9732\u4e3a A2A \u670d\u52a1\uff0c\u4f9b\u5176\u4ed6 Agent \u8c03\u7528</li> <li>A2A Agent: \u8c03\u7528\u8fdc\u7a0b A2A \u670d\u52a1\u7684\u5ba2\u6237\u7aef\u4ee3\u7406\uff0c\u50cf\u4f7f\u7528\u672c\u5730 Agent \u4e00\u6837\u4f7f\u7528\u8fdc\u7a0b Agent</li> </ul>"},{"location":"zh/a2a/#_2","title":"\u6838\u5fc3\u80fd\u529b","text":"<ul> <li>\u96f6\u534f\u8bae\u611f\u77e5: \u5f00\u53d1\u8005\u53ea\u9700\u5173\u6ce8 Agent \u7684\u4e1a\u52a1\u903b\u8f91\uff0c\u65e0\u9700\u4e86\u89e3 A2A \u534f\u8bae\u7ec6\u8282</li> <li>\u81ea\u52a8\u9002\u914d: \u6846\u67b6\u81ea\u52a8\u5c06 Agent \u4fe1\u606f\u8f6c\u6362\u4e3a A2A AgentCard</li> <li>\u6d88\u606f\u8f6c\u6362: \u81ea\u52a8\u5904\u7406 A2A \u534f\u8bae\u6d88\u606f\u4e0e Agent \u6d88\u606f\u683c\u5f0f\u7684\u8f6c\u6362</li> </ul>"},{"location":"zh/a2a/#a2a-server-agent","title":"A2A Server\uff1a\u66b4\u9732 Agent \u4e3a\u670d\u52a1","text":""},{"location":"zh/a2a/#_3","title":"\u6982\u5ff5\u4ecb\u7ecd","text":"<p>A2A Server \u662f tRPC-Agent-Go \u63d0\u4f9b\u7684\u670d\u52a1\u7aef\u7ec4\u4ef6\uff0c\u7528\u4e8e\u5c06\u4efb\u4f55\u672c\u5730 Agent \u5feb\u901f\u8f6c\u6362\u4e3a\u7b26\u5408 A2A \u534f\u8bae\u7684\u7f51\u7edc\u670d\u52a1\u3002</p>"},{"location":"zh/a2a/#_4","title":"\u6838\u5fc3\u7279\u6027","text":"<ul> <li>\u4e00\u952e\u8f6c\u6362: \u901a\u8fc7\u7b80\u5355\u914d\u7f6e\u5c06 Agent \u66b4\u9732\u4e3a A2A \u670d\u52a1</li> <li>\u81ea\u52a8\u534f\u8bae\u9002\u914d: \u81ea\u52a8\u5904\u7406 A2A \u534f\u8bae\u4e0e Agent \u63a5\u53e3\u7684\u8f6c\u6362</li> <li>AgentCard \u751f\u6210: \u81ea\u52a8\u751f\u6210\u670d\u52a1\u53d1\u73b0\u6240\u9700\u7684 AgentCard</li> <li>\u6d41\u5f0f\u652f\u6301: \u652f\u6301\u6d41\u5f0f\u548c\u975e\u6d41\u5f0f\u4e24\u79cd\u54cd\u5e94\u6a21\u5f0f</li> </ul>"},{"location":"zh/a2a/#agent-a2a","title":"Agent \u5230 A2A \u7684\u81ea\u52a8\u8f6c\u6362","text":"<p>tRPC-Agent-Go \u901a\u8fc7 <code>server/a2a</code> \u5305\u5b9e\u73b0\u4e86\u4ece Agent \u5230 A2A \u670d\u52a1\u7684\u65e0\u7f1d\u8f6c\u6362\uff1a</p> <pre><code>func New(opts ...Option) (*a2a.A2AServer, error) {}\n</code></pre>"},{"location":"zh/a2a/#agentcard","title":"AgentCard \u81ea\u52a8\u751f\u6210","text":"<p>\u6846\u67b6\u4f1a\u81ea\u52a8\u63d0\u53d6 Agent \u7684\u5143\u6570\u636e\uff08\u540d\u79f0\u3001\u63cf\u8ff0\u3001\u5de5\u5177\u7b49\uff09\uff0c\u751f\u6210\u7b26\u5408 A2A \u534f\u8bae\u7684 AgentCard\uff0c\u5305\u62ec\uff1a - Agent \u57fa\u672c\u4fe1\u606f\uff08\u540d\u79f0\u3001\u63cf\u8ff0\u3001URL\uff09 - \u80fd\u529b\u58f0\u660e\uff08\u662f\u5426\u652f\u6301\u6d41\u5f0f\uff09 - \u6280\u80fd\u5217\u8868\uff08\u57fa\u4e8e Agent \u7684\u5de5\u5177\u81ea\u52a8\u751f\u6210\uff09</p>"},{"location":"zh/a2a/#_5","title":"\u6d88\u606f\u534f\u8bae\u8f6c\u6362","text":"<p>\u6846\u67b6\u5185\u7f6e <code>messageProcessor</code> \u5b9e\u73b0 A2A \u534f\u8bae\u6d88\u606f\u4e0e Agent \u6d88\u606f\u683c\u5f0f\u7684\u53cc\u5411\u8f6c\u6362\uff0c\u7528\u6237\u65e0\u9700\u5173\u5fc3\u6d88\u606f\u683c\u5f0f\u8f6c\u6362\u7684\u7ec6\u8282\u3002</p>"},{"location":"zh/a2a/#a2a-server","title":"A2A Server \u5feb\u901f\u5f00\u59cb","text":""},{"location":"zh/a2a/#a2a-server-agent_1","title":"\u4f7f\u7528 A2A Server \u66b4\u9732 Agent \u670d\u52a1","text":"<p>\u53ea\u9700\u51e0\u884c\u4ee3\u7801\uff0c\u5c31\u53ef\u4ee5\u5c06\u4efb\u610f Agent \u8f6c\u6362\u4e3a A2A \u670d\u52a1\uff1a</p>"},{"location":"zh/a2a/#a2a-server_1","title":"\u57fa\u7840\u793a\u4f8b\uff1a\u521b\u5efa A2A Server","text":"<pre><code>package main\n\nimport (\n    \"trpc.group/trpc-go/trpc-agent-go/agent/llmagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/openai\"\n    a2aserver \"trpc.group/trpc-go/trpc-agent-go/server/a2a\"\n)\n\nfunc main() {\n    // 1. \u521b\u5efa\u4e00\u4e2a\u666e\u901a\u7684 Agent\n    model := openai.New(\"gpt-4o-mini\")\n    agent := llmagent.New(\"MyAgent\",\n        llmagent.WithModel(model),\n        llmagent.WithDescription(\"\u4e00\u4e2a\u667a\u80fd\u52a9\u624b\"),\n    )\n\n    // 2. \u4e00\u952e\u8f6c\u6362\u4e3a A2A \u670d\u52a1\n    server, _ := a2aserver.New(\n        a2aserver.WithHost(\"localhost:8080\"),\n        a2aserver.WithAgent(agent), // \u4f20\u5165\u4efb\u610f Agent\n    )\n\n    // 3. \u542f\u52a8\u670d\u52a1\uff0c\u5373\u53ef\u63a5\u53d7 A2A \u8bf7\u6c42\n    server.Start(\":8080\")\n}\n</code></pre>"},{"location":"zh/a2a/#a2a","title":"\u76f4\u63a5\u4f7f\u7528 A2A \u534f\u8bae\u5ba2\u6237\u7aef\u8c03\u7528","text":"<pre><code>import (\n    \"trpc.group/trpc-go/trpc-a2a-go/client\"\n    \"trpc.group/trpc-go/trpc-a2a-go/protocol\"\n)\n\nfunc main() {\n    // \u8fde\u63a5\u5230 A2A \u670d\u52a1\n    client, _ := client.NewA2AClient(\"http://localhost:8080/\")\n\n    // \u53d1\u9001\u6d88\u606f\u7ed9 Agent\n    message := protocol.NewMessage(\n        protocol.MessageRoleUser,\n        []protocol.Part{protocol.NewTextPart(\"\u4f60\u597d\uff0c\u8bf7\u5e2e\u6211\u5206\u6790\u8fd9\u6bb5\u4ee3\u7801\")},\n    )\n\n    // Agent \u4f1a\u81ea\u52a8\u5904\u7406\u5e76\u8fd4\u56de\u7ed3\u679c\n    response, _ := client.SendMessage(context.Background(),\n        protocol.SendMessageParams{Message: message})\n}\n</code></pre>"},{"location":"zh/a2a/#a2aagent-a2a","title":"A2AAgent\uff1a\u8c03\u7528\u8fdc\u7a0b A2A \u670d\u52a1","text":"<p>\u4e0e A2A Server \u76f8\u5bf9\u5e94\uff0ctRPC-Agent-Go \u8fd8\u63d0\u4f9b\u4e86 <code>A2AAgent</code>\uff0c\u7528\u4e8e\u8c03\u7528\u8fdc\u7a0b\u7684 A2A \u670d\u52a1\uff0c\u5b9e\u73b0 Agent \u95f4\u7684\u901a\u4fe1\u3002</p>"},{"location":"zh/a2a/#_6","title":"\u6982\u5ff5\u4ecb\u7ecd","text":"<p><code>A2AAgent</code> \u662f\u4e00\u4e2a\u7279\u6b8a\u7684 Agent \u5b9e\u73b0\uff0c\u5b83\u4e0d\u76f4\u63a5\u5904\u7406\u7528\u6237\u8bf7\u6c42\uff0c\u800c\u662f\u5c06\u8bf7\u6c42\u8f6c\u53d1\u7ed9\u8fdc\u7a0b\u7684 A2A \u670d\u52a1\u3002\u4ece\u4f7f\u7528\u8005\u89d2\u5ea6\u770b\uff0c<code>A2AAgent</code> \u5c31\u50cf\u4e00\u4e2a\u666e\u901a\u7684 Agent\uff0c\u4f46\u5b9e\u9645\u4e0a\u5b83\u662f\u8fdc\u7a0b Agent \u7684\u672c\u5730\u4ee3\u7406\u3002</p> <p>\u7b80\u5355\u7406\u89e3\uff1a - A2A Server: \u6211\u6709\u4e00\u4e2a Agent\uff0c\u60f3\u8ba9\u522b\u4eba\u8c03\u7528 \u2192 \u66b4\u9732\u4e3a A2A \u670d\u52a1 - A2AAgent: \u6211\u60f3\u8c03\u7528\u522b\u4eba\u7684 Agent \u2192 \u901a\u8fc7 A2AAgent \u4ee3\u7406\u8c03\u7528</p>"},{"location":"zh/a2a/#_7","title":"\u6838\u5fc3\u7279\u6027","text":"<ul> <li>\u900f\u660e\u4ee3\u7406: \u50cf\u4f7f\u7528\u672c\u5730 Agent \u4e00\u6837\u4f7f\u7528\u8fdc\u7a0b Agent</li> <li>\u81ea\u52a8\u53d1\u73b0: \u901a\u8fc7 AgentCard \u81ea\u52a8\u53d1\u73b0\u8fdc\u7a0b Agent \u7684\u80fd\u529b</li> <li>\u534f\u8bae\u8f6c\u6362: \u81ea\u52a8\u5904\u7406\u672c\u5730\u6d88\u606f\u683c\u5f0f\u4e0e A2A \u534f\u8bae\u7684\u8f6c\u6362</li> <li>\u6d41\u5f0f\u652f\u6301: \u652f\u6301\u6d41\u5f0f\u548c\u975e\u6d41\u5f0f\u4e24\u79cd\u901a\u4fe1\u6a21\u5f0f</li> <li>\u72b6\u6001\u4f20\u9012: \u652f\u6301\u5c06\u672c\u5730\u72b6\u6001\u4f20\u9012\u7ed9\u8fdc\u7a0b Agent</li> <li>\u9519\u8bef\u5904\u7406: \u5b8c\u5584\u7684\u9519\u8bef\u5904\u7406\u548c\u91cd\u8bd5\u673a\u5236</li> </ul>"},{"location":"zh/a2a/#_8","title":"\u4f7f\u7528\u573a\u666f","text":"<ol> <li>\u5206\u5e03\u5f0f Agent \u7cfb\u7edf: \u5728\u5fae\u670d\u52a1\u67b6\u6784\u4e2d\u8c03\u7528\u5176\u4ed6\u670d\u52a1\u7684 Agent</li> <li>Agent \u7f16\u6392: \u5c06\u591a\u4e2a\u4e13\u4e1a Agent \u7ec4\u5408\u6210\u590d\u6742\u7684\u5de5\u4f5c\u6d41</li> <li>\u8de8\u56e2\u961f\u534f\u4f5c: \u8c03\u7528\u5176\u4ed6\u56e2\u961f\u63d0\u4f9b\u7684 Agent \u670d\u52a1</li> </ol>"},{"location":"zh/a2a/#a2aagent","title":"A2AAgent \u5feb\u901f\u5f00\u59cb","text":""},{"location":"zh/a2a/#_9","title":"\u57fa\u672c\u7528\u6cd5","text":"<pre><code>package main\n\nimport (\n    \"context\"\n    \"fmt\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/agent/a2aagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/runner\"\n    \"trpc.group/trpc-go/trpc-agent-go/model\"\n    \"trpc.group/trpc-go/trpc-agent-go/session/inmemory\"\n)\n\nfunc main() {\n    // 1. \u521b\u5efa A2AAgent\uff0c\u6307\u5411\u8fdc\u7a0b A2A \u670d\u52a1\n    a2aAgent, err := a2aagent.New(\n        a2aagent.WithAgentCardURL(\"http://localhost:8888\"),\n    )\n    if err != nil {\n        panic(err)\n    }\n\n    // 2. \u50cf\u4f7f\u7528\u666e\u901a Agent \u4e00\u6837\u4f7f\u7528\n    sessionService := inmemory.NewSessionService()\n    runner := runner.NewRunner(\"test\", a2aAgent, \n        runner.WithSessionService(sessionService))\n\n    // 3. \u53d1\u9001\u6d88\u606f\n    events, err := runner.Run(\n        context.Background(),\n        \"user1\",\n        \"session1\", \n        model.NewUserMessage(\"\u8bf7\u5e2e\u6211\u8bb2\u4e2a\u7b11\u8bdd\"),\n    )\n    if err != nil {\n        panic(err)\n    }\n\n    // 4. \u5904\u7406\u54cd\u5e94\n    for event := range events {\n        if event.Response != nil &amp;&amp; len(event.Response.Choices) &gt; 0 {\n            fmt.Print(event.Response.Choices[0].Message.Content)\n        }\n    }\n}\n</code></pre> <p>\u5728\u591a Agent \u7cfb\u7edf\u4e2d\uff0c<code>A2AAgent</code> \u901a\u5e38\u4f5c\u4e3a\u672c\u5730\u534f\u8c03\u8005 Agent \uff08\u4f8b\u5982 <code>LLMAgent</code>\uff09\u7684 SubAgent \u4f7f\u7528\u3002\u4f60\u53ef\u4ee5\u5c06 <code>A2AAgent</code> \u4e0e <code>LLMAgent.SetSubAgents</code> \u7ed3\u5408\uff0c\u4ece\u6ce8\u518c\u4e2d\u5fc3\u52a8\u6001\u52a0\u8f7d\u5e76\u66f4\u65b0 \u8fdc\u7a0b SubAgent\uff0c\u800c\u65e0\u9700\u91cd\u5efa\u534f\u8c03\u8005\u5b9e\u4f8b\u3002</p>"},{"location":"zh/a2a/#_10","title":"\u9ad8\u7ea7\u914d\u7f6e","text":"<pre><code>// \u521b\u5efa\u5e26\u6709\u9ad8\u7ea7\u914d\u7f6e\u7684 A2AAgent\na2aAgent, err := a2aagent.New(\n    // \u6307\u5b9a\u8fdc\u7a0b\u670d\u52a1\u5730\u5740\n    a2aagent.WithAgentCardURL(\"http://remote-agent:8888\"),\n\n    // \u8bbe\u7f6e\u6d41\u5f0f\u7f13\u51b2\u533a\u5927\u5c0f\n    a2aagent.WithStreamingChannelBufSize(2048),\n\n    // \u81ea\u5b9a\u4e49\u534f\u8bae\u8f6c\u6362\n    a2aagent.WithCustomEventConverter(curtomEventConverter),\n\n    a2aagent.WithCustomA2AConverter(cursomA2AConverter)\n\n)\n</code></pre>"},{"location":"zh/a2a/#a2a-server-a2aagent","title":"\u5b8c\u6574\u793a\u4f8b\uff1aA2A Server + A2AAgent \u7efc\u5408\u4f7f\u7528","text":"<p>\u4ee5\u4e0b\u662f\u4e00\u4e2a\u5b8c\u6574\u7684\u793a\u4f8b\uff0c\u5c55\u793a\u4e86\u5982\u4f55\u5728\u540c\u4e00\u4e2a\u7a0b\u5e8f\u4e2d\u540c\u65f6\u8fd0\u884c A2A Server\uff08\u66b4\u9732\u672c\u5730 Agent\uff09\u548c A2AAgent\uff08\u8c03\u7528\u8fdc\u7a0b\u670d\u52a1\uff09\uff1a</p> <pre><code>package main\n\nimport (\n    \"context\"\n    \"fmt\"\n    \"time\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/agent/a2aagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/agent/llmagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/openai\"\n    \"trpc.group/trpc-go/trpc-agent-go/runner\"\n    \"trpc.group/trpc-go/trpc-agent-go/server/a2a\"\n    \"trpc.group/trpc-go/trpc-agent-go/session/inmemory\"\n)\n\nfunc main() {\n    // 1. \u521b\u5efa\u5e76\u542f\u52a8\u8fdc\u7a0b Agent \u670d\u52a1\n    remoteAgent := createRemoteAgent()\n    startA2AServer(remoteAgent, \"localhost:8888\")\n\n    time.Sleep(1 * time.Second) // \u7b49\u5f85\u670d\u52a1\u542f\u52a8\n\n    // 2. \u521b\u5efa A2AAgent \u8fde\u63a5\u5230\u8fdc\u7a0b\u670d\u52a1\n    a2aAgent, err := a2aagent.New(\n        a2aagent.WithAgentCardURL(\"http://localhost:8888\"),\n        a2aagent.WithTransferStateKey(\"user_context\"),\n    )\n    if err != nil {\n        panic(err)\n    }\n\n    // 3. \u521b\u5efa\u672c\u5730 Agent\n    localAgent := createLocalAgent()\n\n    // 4. \u5bf9\u6bd4\u672c\u5730\u548c\u8fdc\u7a0b Agent \u7684\u54cd\u5e94\n    compareAgents(localAgent, a2aAgent)\n}\n\nfunc createRemoteAgent() agent.Agent {\n    model := openai.New(\"gpt-4o-mini\")\n    return llmagent.New(\"JokeAgent\",\n        llmagent.WithModel(model),\n        llmagent.WithDescription(\"I am a joke-telling agent\"),\n        llmagent.WithInstruction(\"Always respond with a funny joke\"),\n    )\n}\n\nfunc createLocalAgent() agent.Agent {\n    model := openai.New(\"gpt-4o-mini\") \n    return llmagent.New(\"LocalAgent\",\n        llmagent.WithModel(model),\n        llmagent.WithDescription(\"I am a local assistant\"),\n    )\n}\n\nfunc startA2AServer(agent agent.Agent, host string) {\n    server, err := a2a.New(\n        a2a.WithHost(host),\n        a2a.WithAgent(agent, true), // \u542f\u7528\u6d41\u5f0f\n    )\n    if err != nil {\n        panic(err)\n    }\n\n    go func() {\n        server.Start(host)\n    }()\n}\n\nfunc compareAgents(localAgent, remoteAgent agent.Agent) {\n    sessionService := inmemory.NewSessionService()\n\n    localRunner := runner.NewRunner(\"local\", localAgent,\n        runner.WithSessionService(sessionService))\n    remoteRunner := runner.NewRunner(\"remote\", remoteAgent,\n        runner.WithSessionService(sessionService))\n\n    userMessage := \"\u8bf7\u5e2e\u6211\u8bb2\u4e2a\u7b11\u8bdd\"\n\n    // \u8c03\u7528\u672c\u5730 Agent\n    fmt.Println(\"=== Local Agent Response ===\")\n    processAgent(localRunner, userMessage)\n\n    // \u8c03\u7528\u8fdc\u7a0b Agent (\u901a\u8fc7 A2AAgent)\n    fmt.Println(\"\\n=== Remote Agent Response (via A2AAgent) ===\")\n    processAgent(remoteRunner, userMessage)\n}\n\nfunc processAgent(runner runner.Runner, message string) {\n    events, err := runner.Run(\n        context.Background(),\n        \"user1\",\n        \"session1\",\n        model.NewUserMessage(message),\n        agent.WithRuntimeState(map[string]any{\n            \"user_context\": \"test_context\",\n        }),\n    )\n    if err != nil {\n        fmt.Printf(\"Error: %v\\n\", err)\n        return\n    }\n\n    for event := range events {\n        if event.Response != nil &amp;&amp; len(event.Response.Choices) &gt; 0 {\n            content := event.Response.Choices[0].Message.Content\n            if content == \"\" {\n                content = event.Response.Choices[0].Delta.Content\n            }\n            if content != \"\" {\n                fmt.Print(content)\n            }\n        }\n    }\n    fmt.Println()\n}\n</code></pre>"},{"location":"zh/a2a/#agentcard_1","title":"AgentCard \u81ea\u52a8\u53d1\u73b0","text":"<p><code>A2AAgent</code> \u652f\u6301\u901a\u8fc7\u6807\u51c6\u7684 AgentCard \u53d1\u73b0\u673a\u5236\u81ea\u52a8\u83b7\u53d6\u8fdc\u7a0b Agent \u7684\u4fe1\u606f\uff1a</p> <pre><code>// A2AAgent \u4f1a\u81ea\u52a8\u4ece\u4ee5\u4e0b\u8def\u5f84\u83b7\u53d6 AgentCard\n// http://remote-agent:8888/.well-known/agent.json\n\ntype AgentCard struct {\n    Name         string                 `json:\"name\"`\n    Description  string                 `json:\"description\"`\n    URL          string                 `json:\"url\"`\n    Capabilities AgentCardCapabilities  `json:\"capabilities\"`\n}\n\ntype AgentCardCapabilities struct {\n    Streaming *bool `json:\"streaming,omitempty\"`\n}\n</code></pre>"},{"location":"zh/a2a/#_11","title":"\u72b6\u6001\u4f20\u9012","text":"<p><code>A2AAgent</code> \u652f\u6301\u5c06\u672c\u5730\u8fd0\u884c\u65f6\u72b6\u6001\u4f20\u9012\u7ed9\u8fdc\u7a0b Agent\uff1a</p> <pre><code>a2aAgent, _ := a2aagent.New(\n    a2aagent.WithAgentCardURL(\"http://remote-agent:8888\"),\n    // \u6307\u5b9a\u8981\u4f20\u9012\u7684\u72b6\u6001\u952e\n    a2aagent.WithTransferStateKey(\"user_id\", \"session_context\", \"preferences\"),\n)\n\n// \u8fd0\u884c\u65f6\u72b6\u6001\u4f1a\u901a\u8fc7 A2A \u534f\u8bae\u7684 metadata \u5b57\u6bb5\u4f20\u9012\u7ed9\u8fdc\u7a0b Agent\nevents, _ := runner.Run(ctx, userID, sessionID, message,\n    agent.WithRuntimeState(map[string]any{\n        \"user_id\":         \"12345\",\n        \"session_context\": \"shopping_cart\",\n        \"preferences\":     map[string]string{\"language\": \"zh\"},\n    }),\n)\n</code></pre>"},{"location":"zh/a2a/#http-headers","title":"\u81ea\u5b9a\u4e49 HTTP Headers","text":"<p>\u4f60\u53ef\u4ee5\u4f7f\u7528 <code>WithA2ARequestOptions</code> \u4e3a\u6bcf\u6b21\u8bf7\u6c42\u4f20\u9012\u81ea\u5b9a\u4e49\u7684 HTTP headers\uff1a</p> <pre><code>import \"trpc.group/trpc-go/trpc-a2a-go/client\"\n\nevents, err := runner.Run(\n    context.Background(),\n    userID,\n    sessionID,\n    model.NewUserMessage(\"\u4f60\u7684\u95ee\u9898\"),\n    // \u4e3a\u672c\u6b21\u8bf7\u6c42\u4f20\u9012\u81ea\u5b9a\u4e49 HTTP headers\n    agent.WithA2ARequestOptions(\n        client.WithRequestHeader(\"X-Custom-Header\", \"custom-value\"),\n        client.WithRequestHeader(\"X-Request-ID\", fmt.Sprintf(\"req-%d\", time.Now().UnixNano())),\n        client.WithRequestHeader(\"Authorization\", \"Bearer your-token\"),\n    ),\n)\n</code></pre> <p>\u5e38\u89c1\u4f7f\u7528\u573a\u666f\uff1a</p> <ol> <li> <p>\u8eab\u4efd\u8ba4\u8bc1\uff1a\u4f20\u9012\u8ba4\u8bc1 token    <pre><code>agent.WithA2ARequestOptions(\n    client.WithRequestHeader(\"Authorization\", \"Bearer \"+token),\n)\n</code></pre></p> </li> <li> <p>\u5206\u5e03\u5f0f\u8ffd\u8e2a\uff1a\u6dfb\u52a0\u8bf7\u6c42/\u8ffd\u8e2a ID    <pre><code>agent.WithA2ARequestOptions(\n    client.WithRequestHeader(\"X-Request-ID\", requestID),\n    client.WithRequestHeader(\"X-Trace-ID\", traceID),\n)\n</code></pre></p> </li> </ol> <p>\u914d\u7f6e UserID Header\uff1a</p> <p>\u5ba2\u6237\u7aef\u548c\u670d\u52a1\u7aef\u90fd\u652f\u6301\u914d\u7f6e\u4f7f\u7528\u54ea\u4e2a HTTP header \u6765\u4f20\u9012 UserID\uff0c\u9ed8\u8ba4\u4f7f\u7528 X-User-ID\uff1a</p> <pre><code>// \u5ba2\u6237\u7aef\uff1a\u914d\u7f6e\u901a\u8fc7\u54ea\u4e2a header \u53d1\u9001 UserID\na2aAgent, _ := a2aagent.New(\n    a2aagent.WithAgentCardURL(\"http://remote-agent:8888\"),\n    // \u9ed8\u8ba4\u662f \"X-User-ID\"\uff0c\u53ef\u4ee5\u81ea\u5b9a\u4e49\n    a2aagent.WithUserIDHeader(\"X-Custom-User-ID\"),\n)\n\n// \u670d\u52a1\u7aef\uff1a\u914d\u7f6e\u4ece\u54ea\u4e2a header \u8bfb\u53d6 UserID\nserver, _ := a2a.New(\n    a2a.WithHost(\"localhost:8888\"),\n    a2a.WithAgent(agent, true),\n    // \u9ed8\u8ba4\u662f \"X-User-ID\"\uff0c\u53ef\u4ee5\u81ea\u5b9a\u4e49\n    a2a.WithUserIDHeader(\"X-Custom-User-ID\"),\n)\n</code></pre> <p>\u6765\u81ea <code>invocation.Session.UserID</code> \u7684 UserID \u4f1a\u81ea\u52a8\u901a\u8fc7\u914d\u7f6e\u7684 header \u53d1\u9001\u7ed9 A2A server\u3002</p>"},{"location":"zh/a2a/#_12","title":"\u81ea\u5b9a\u4e49\u8f6c\u6362\u5668","text":"<p>\u5bf9\u4e8e\u7279\u6b8a\u9700\u6c42\uff0c\u53ef\u4ee5\u81ea\u5b9a\u4e49\u6d88\u606f\u548c\u4e8b\u4ef6\u8f6c\u6362\u5668\uff1a</p> <pre><code>// \u81ea\u5b9a\u4e49 A2A \u6d88\u606f\u8f6c\u6362\u5668\ntype CustomA2AConverter struct{}\n\nfunc (c *CustomA2AConverter) ConvertToA2AMessage(\n    isStream bool, \n    agentName string, \n    invocation *agent.Invocation,\n) (*protocol.Message, error) {\n    // \u81ea\u5b9a\u4e49\u6d88\u606f\u8f6c\u6362\u903b\u8f91\n    return &amp;protocol.Message{\n        MessageID: invocation.InvocationID,\n        Role:      protocol.MessageRoleUser,\n        Parts:     []protocol.Part{/* \u81ea\u5b9a\u4e49\u5185\u5bb9 */},\n    }, nil\n}\n\n// \u81ea\u5b9a\u4e49\u4e8b\u4ef6\u8f6c\u6362\u5668  \ntype CustomEventConverter struct{}\n\nfunc (c *CustomEventConverter) ConvertToEvent(\n    result protocol.MessageResult,\n    agentName string,\n    invocation *agent.Invocation,\n) (*event.Event, error) {\n    // \u81ea\u5b9a\u4e49\u4e8b\u4ef6\u8f6c\u6362\u903b\u8f91\n    return event.New(invocation.InvocationID, agentName), nil\n}\n\n// \u4f7f\u7528\u81ea\u5b9a\u4e49\u8f6c\u6362\u5668\na2aAgent, _ := a2aagent.New(\n    a2aagent.WithAgentCardURL(\"http://remote-agent:8888\"),\n    a2aagent.WithA2AMessageConverter(&amp;CustomA2AConverter{}),\n    a2aagent.WithEventConverter(&amp;CustomEventConverter{}),\n)\n</code></pre>"},{"location":"zh/a2a/#a2a-server-vs-a2aagent","title":"\u603b\u7ed3\uff1aA2A Server vs A2AAgent","text":"\u7ec4\u4ef6 \u804c\u8d23 \u4f7f\u7528\u573a\u666f \u6838\u5fc3\u529f\u80fd A2A Server \u670d\u52a1\u63d0\u4f9b\u8005 \u5c06\u672c\u5730 Agent \u66b4\u9732\u7ed9\u5176\u4ed6\u7cfb\u7edf\u8c03\u7528 \u2022 \u534f\u8bae\u8f6c\u6362\u2022 AgentCard \u751f\u6210\u2022 \u6d88\u606f\u8def\u7531\u2022 \u6d41\u5f0f\u652f\u6301 A2AAgent \u670d\u52a1\u6d88\u8d39\u8005 \u8c03\u7528\u8fdc\u7a0b A2A \u670d\u52a1 \u2022 \u900f\u660e\u4ee3\u7406\u2022 \u81ea\u52a8\u53d1\u73b0\u2022 \u72b6\u6001\u4f20\u9012\u2022 \u534f\u8bae\u9002\u914d"},{"location":"zh/a2a/#_13","title":"\u5178\u578b\u67b6\u6784\u6a21\u5f0f","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 A2A protocol  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502   Client    \u2502\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2192\u2502 A2A Server    |\n\u2502 (A2AAgent)  \u2502               \u2502 (local Agent) \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518               \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n      \u2191                              \u2191\n      \u2502                              \u2502\n   \u8c03\u7528\u8fdc\u7a0b                       \u66b4\u9732\u672c\u5730\n   Agent\u670d\u52a1                     Agent\u670d\u52a1\n</code></pre> <p>\u901a\u8fc7 A2A Server \u548c A2AAgent \u7684\u914d\u5408\u4f7f\u7528\uff0c\u53ef\u4ee5\u6bd4\u8f83\u65b9\u4fbf\u7684\u6784\u5efa\u7684\u8fdc\u7a0b\u7684 Agent \u7cfb\u7edf\u3002</p>"},{"location":"zh/agent/","title":"Agent \u4f7f\u7528\u6587\u6863","text":"<p>Agent \u662f tRPC-Agent-Go \u6846\u67b6\u7684\u6838\u5fc3\u6267\u884c\u5355\u5143\uff0c\u8d1f\u8d23\u5904\u7406\u7528\u6237\u8f93\u5165\u5e76\u751f\u6210\u76f8\u5e94\u7684\u54cd\u5e94\u3002\u6bcf\u4e2a Agent \u90fd\u5b9e\u73b0\u4e86\u7edf\u4e00\u7684\u63a5\u53e3\uff0c\u652f\u6301\u6d41\u5f0f\u8f93\u51fa\u548c\u56de\u8c03\u673a\u5236\u3002</p> <p>\u6846\u67b6\u63d0\u4f9b\u4e86\u591a\u79cd\u7c7b\u578b\u7684 Agent\uff0c\u5305\u62ec LLMAgent\u3001ChainAgent\u3001ParallelAgent\u3001CycleAgent \u548c GraphAgent\u3002\u672c\u6587\u91cd\u70b9\u4ecb\u7ecd LLMAgent\uff0c\u5176\u4ed6 Agent \u7c7b\u578b\u4ee5\u53ca\u591a Agent \u7cfb\u7edf\u7684\u8be6\u7ec6\u4ecb\u7ecd\u8bf7\u53c2\u8003 Multi-Agent\u3002</p>"},{"location":"zh/agent/#_1","title":"\u5feb\u901f\u5f00\u59cb","text":"<p>\u63a8\u8350\u4f7f\u7528\u65b9\u5f0f\uff1aRunner</p> <p>\u6211\u4eec\u5f3a\u70c8\u63a8\u8350\u4f7f\u7528 Runner \u6765\u6267\u884c Agent\uff0c\u800c\u4e0d\u662f\u76f4\u63a5\u8c03\u7528 Agent \u63a5\u53e3\u3002Runner \u63d0\u4f9b\u4e86\u66f4\u53cb\u597d\u7684\u63a5\u53e3\uff0c\u96c6\u6210\u4e86 Session\u3001Memory \u7b49\u670d\u52a1\uff0c\u8ba9\u4f7f\u7528\u66f4\u52a0\u7b80\u5355\u3002</p> <p>\ud83d\udcd6 \u4e86\u89e3\u66f4\u591a\uff1a \u8be6\u7ec6\u7684\u4f7f\u7528\u65b9\u6cd5\u8bf7\u53c2\u8003 Runner</p> <p>\u672c\u793a\u4f8b\u4f7f\u7528 OpenAI \u7684 GPT-4o-mini \u6a21\u578b\u3002\u5728\u5f00\u59cb\u4e4b\u524d\uff0c\u8bf7\u786e\u4fdd\u60a8\u5df2\u51c6\u5907\u597d\u76f8\u5e94\u7684 <code>OPENAI_API_KEY</code> \u5e76\u901a\u8fc7\u73af\u5883\u53d8\u91cf\u5bfc\u51fa\uff1a</p> <pre><code>export OPENAI_API_KEY=\"your_api_key\"\n</code></pre> <p>\u6b64\u5916\uff0c\u6846\u67b6\u8fd8\u652f\u6301\u517c\u5bb9 OpenAI API \u7684\u6a21\u578b\uff0c\u53ef\u901a\u8fc7\u73af\u5883\u53d8\u91cf\u8fdb\u884c\u914d\u7f6e\uff1a</p> <pre><code>export OPENAI_BASE_URL=\"your_api_base_url\"\nexport OPENAI_API_KEY=\"your_api_key\"\n</code></pre>"},{"location":"zh/agent/#_2","title":"\u521b\u5efa\u6a21\u578b\u5b9e\u4f8b","text":"<p>\u9996\u5148\u9700\u8981\u521b\u5efa\u4e00\u4e2a\u6a21\u578b\u5b9e\u4f8b\uff0c\u8fd9\u91cc\u4f7f\u7528 OpenAI \u7684 GPT-4o-mini \u6a21\u578b\uff1a</p> <pre><code>import \"trpc.group/trpc-go/trpc-agent-go/model/openai\"\n\nmodelName := flag.String(\"model\", \"gpt-4o-mini\", \"Name of the model to use\")\nflag.Parse()\n// \u521b\u5efa OpenAI \u6a21\u578b\u5b9e\u4f8b\nmodelInstance := openai.New(*modelName, openai.Options{})\n</code></pre>"},{"location":"zh/agent/#_3","title":"\u914d\u7f6e\u751f\u6210\u53c2\u6570","text":"<p>\u8bbe\u7f6e\u6a21\u578b\u7684\u751f\u6210\u53c2\u6570\uff0c\u5305\u62ec\u6700\u5927 token \u6570\u3001\u6e29\u5ea6\u4ee5\u53ca\u662f\u5426\u4f7f\u7528\u6d41\u5f0f\u8f93\u51fa\u7b49\uff1a</p> <pre><code>import \"trpc.group/trpc-go/trpc-agent-go/model\"\n\nmaxTokens := 1000\ntemperature := 0.7\ngenConfig := model.GenerationConfig{\n    MaxTokens:   &amp;maxTokens,   // \u6700\u5927\u751f\u6210 token \u6570\n    Temperature: &amp;temperature, // \u6e29\u5ea6\u53c2\u6570\uff0c\u63a7\u5236\u8f93\u51fa\u7684\u968f\u673a\u6027\n    Stream:      true,         // \u542f\u7528\u6d41\u5f0f\u8f93\u51fa\n}\n</code></pre>"},{"location":"zh/agent/#llmagent","title":"\u521b\u5efa LLMAgent","text":"<p>\u4f7f\u7528\u6a21\u578b\u5b9e\u4f8b\u548c\u914d\u7f6e\u521b\u5efa LLMAgent\uff0c\u540c\u65f6\u8bbe\u7f6e Agent \u7684 Description \u4e0e Instruction\u3002</p> <p>Description \u7528\u4e8e\u63cf\u8ff0 Agent \u7684\u57fa\u672c\u529f\u80fd\u548c\u7279\u6027\uff0cInstruction \u5219\u5b9a\u4e49\u4e86 Agent \u5728\u6267\u884c\u4efb\u52a1\u65f6\u5e94\u9075\u5faa\u7684\u5177\u4f53\u6307\u4ee4\u548c\u884c\u4e3a\u51c6\u5219\u3002</p> <pre><code>import \"trpc.group/trpc-go/trpc-agent-go/agent/llmagent\"\n\nllmAgent := llmagent.New(\n    \"demo-agent\",                      // Agent \u540d\u79f0\n    llmagent.WithModel(modelInstance), // \u8bbe\u7f6e\u6a21\u578b\n    llmagent.WithDescription(\"A helpful AI assistant for demonstrations\"),              // \u8bbe\u7f6e\u63cf\u8ff0\n    llmagent.WithInstruction(\"Be helpful, concise, and informative in your responses\"), // \u8bbe\u7f6e\u6307\u4ee4\n    llmagent.WithGenerationConfig(genConfig),                                           // \u8bbe\u7f6e\u751f\u6210\u53c2\u6570\n)\n</code></pre>"},{"location":"zh/agent/#_4","title":"\u5360\u4f4d\u7b26\u53d8\u91cf\uff08\u4f1a\u8bdd\u72b6\u6001\u6ce8\u5165\uff09","text":"<p>LLMAgent \u4f1a\u81ea\u52a8\u5728 <code>Instruction</code> \u548c\u53ef\u9009\u7684 <code>SystemPrompt</code> \u4e2d\u6ce8\u5165\u4f1a\u8bdd\u72b6\u6001\u3002\u652f\u6301\u7684\u5360\u4f4d\u7b26\u8bed\u6cd5\uff1a</p> <ul> <li><code>{key}</code>\uff1a\u66ff\u6362\u4e3a <code>session.State[\"key\"]</code> \u7684\u5b57\u7b26\u4e32\u503c</li> <li><code>{key?}</code>\uff1a\u53ef\u9009\uff1b\u5982\u679c\u4e0d\u5b58\u5728\uff0c\u66ff\u6362\u4e3a\u7a7a\u5b57\u7b26\u4e32</li> <li><code>{user:subkey}</code> / <code>{app:subkey}</code> / <code>{temp:subkey}</code>\uff1a\u8bbf\u95ee\u7528\u6237/\u5e94\u7528/\u4e34\u65f6\u547d\u540d\u7a7a\u95f4\uff08SessionService \u4f1a\u628a app/user \u4f5c\u7528\u57df\u7684\u72b6\u6001\u5408\u5e76\u8fdb session\uff0c\u5e76\u5e26\u4e0a\u524d\u7f00\uff09</li> <li><code>{invocation:subkey}</code> \uff1a\u66ff\u6362\u4e3afmt.Sprintf(\"%+v\",<code>invocation.state[\"subkey\"]</code>)\u7684\u503c\uff0c\uff08\u53ef\u4ee5\u901a\u8fc7invocation.SetState(k,v)\u6765\u8bbe\u7f6e\uff09\u3002</li> </ul> <p>\u6ce8\u610f\uff1a</p> <ul> <li>\u5bf9\u4e8e\u975e\u53ef\u9009\u7684 <code>{key}</code>\uff0c\u82e5\u627e\u4e0d\u5230\u5219\u4fdd\u7559\u539f\u6837\uff08\u4fbf\u4e8e LLM \u611f\u77e5\u7f3a\u5931\u4e0a\u4e0b\u6587\uff09</li> <li>\u503c\u8bfb\u53d6\u81ea <code>invocation.Session.State</code>\uff08Runner + SessionService \u4f1a\u81ea\u52a8\u8bbe\u7f6e/\u5408\u5e76\uff09</li> </ul> <p>\u793a\u4f8b\uff1a</p> <pre><code>llm := llmagent.New(\n  \"research-agent\",\n  llmagent.WithModel(modelInstance),\n  llmagent.WithInstruction(\n    \"You are a research assistant. Focus: {research_topics}. \" +\n    \"User interests: {user:topics?}. App banner: {app:banner?}.\" +\n    \"Invocation case: {invocation:case}\",\n  ),\n)\n\ninv := agent.NewInvoction()\ninv.SetState(\"case\", \"case-1\")\n\n// \u901a\u8fc7 SessionService \u521d\u59cb\u5316\u72b6\u6001\uff08\u7528\u6237\u6001/\u5e94\u7528\u6001 + \u4f1a\u8bdd\u672c\u5730\u952e\uff09\n_ = sessionService.UpdateUserState(ctx, session.UserKey{AppName: app, UserID: user}, session.StateMap{\n  \"topics\": []byte(\"quantum computing, cryptography\"),\n})\n_ = sessionService.UpdateAppState(ctx, app, session.StateMap{\n  \"banner\": []byte(\"Research Mode\"),\n})\n// \u65e0\u524d\u7f00\u952e\u76f4\u63a5\u5b58\u5230 session.State\n_, _ = sessionService.CreateSession(ctx, session.Key{AppName: app, UserID: user, SessionID: sid}, session.StateMap{\n  \"research_topics\": []byte(\"AI, ML, DL\"),\n})\n</code></pre> <p>\u8fdb\u4e00\u6b65\u9605\u8bfb\uff1a</p> <ul> <li>\u793a\u4f8b\uff1a<code>examples/placeholder</code>\u3001<code>examples/outputkey</code></li> <li>Session API\uff1a<code>docs/mkdocs/zh/session.md</code></li> </ul>"},{"location":"zh/agent/#runner-agent","title":"\u4f7f\u7528 Runner \u6267\u884c Agent","text":"<p>\u4f7f\u7528 Runner \u6765\u6267\u884c Agent\uff0c\u8fd9\u662f\u63a8\u8350\u7684\u4f7f\u7528\u65b9\u5f0f\uff1a</p> <pre><code>import \"trpc.group/trpc-go/trpc-agent-go/runner\"\n\n// \u521b\u5efa Runner\nrunner := runner.NewRunner(\"demo-app\", llmAgent)\n\n// \u76f4\u63a5\u53d1\u9001\u6d88\u606f\uff0c\u65e0\u9700\u521b\u5efa\u590d\u6742\u7684 Invocation\nmessage := model.NewUserMessage(\"Hello! Can you tell me about yourself?\")\neventChan, err := runner.Run(ctx, \"user-001\", \"session-001\", message)\nif err != nil {\n    log.Fatalf(\"\u6267\u884c Agent \u5931\u8d25: %v\", err)\n}\n</code></pre>"},{"location":"zh/agent/#_5","title":"\u6d88\u606f\u53ef\u89c1\u6027\u9009\u9879","text":"<p>\u5f53\u524dAgent\u53ef\u5728\u9700\u8981\u65f6\u6839\u636e\u4e0d\u540c\u573a\u666f\u63a7\u5236\u5176\u5bf9\u5176\u4ed6Agent\u751f\u6210\u7684\u6d88\u606f\u4ee5\u53ca\u5386\u53f2\u4f1a\u8bdd\u6d88\u606f\u7684\u53ef\u89c1\u6027\u8fdb\u884c\u7ba1\u7406\uff0c\u53ef\u901a\u8fc7\u76f8\u5173\u9009\u9879\u914d\u7f6e\u8fdb\u884c\u7ba1\u7406\u3002 \u5728\u4e0emodel\u4ea4\u4e92\u65f6\u4ec5\u5c06\u53ef\u89c1\u7684\u5185\u5bb9\u8f93\u5165\u7ed9\u6a21\u578b\u3002 </p> <p>TIPS:  - \u4e0d\u540csessionID\u7684\u6d88\u606f\u5728\u4efb\u4f55\u573a\u666f\u4e0b\u90fd\u662f\u4e92\u4e0d\u53ef\u89c1\u7684\uff0c\u4ee5\u4e0b\u7ba1\u63a7\u7b56\u7565\u5747\u9488\u5bf9\u540c\u4e00\u4e2asessionID\u7684\u6d88\u606f  - invocation.Message\u5728\u4efb\u4f55\u573a\u666f\u4e0b\u5747\u53ef\u89c1  - \u672a\u914d\u7f6e\u9009\u9879\u65f6\uff0c\u9ed8\u8ba4\u503c\u4e3aFullContext</p> <p>\u914d\u7f6e: - <code>llmagent.WithMessageFilterMode(MessageFilterMode)</code>:   - <code>FullContext</code>: \u6240\u6709\u80fd\u901a\u8fc7filterKey\u505a\u524d\u7f00\u5339\u914d\u7684\u6d88\u606f   - <code>RequestContext</code>: \u4ec5\u5305\u542b\u5f53\u524d\u8bf7\u6c42\u5468\u671f\u5185\u901a\u8fc7filterKey\u524d\u7f00\u5339\u914d\u7684\u6d88\u606f   - <code>IsolatedRequest</code>: \u4ec5\u5305\u542b\u5f53\u524d\u8bf7\u6c42\u5468\u671f\u5185\u901a\u8fc7filterKey\u5b8c\u5168\u5339\u914d\u7684\u6d88\u606f   - <code>IsolatedInvocation</code>: \u4ec5\u5305\u542b\u5f53\u524dinvocation\u5468\u671f\u5185\u901a\u8fc7filterKey\u5b8c\u5168\u5339\u914d\u7684\u6d88\u606f</p> <p>\u63a8\u8350\u7528\u6cd5\u793a\u4f8b\uff08\u8be5\u7528\u6cd5\u4ec5\u57fa\u4e8e\u9ad8\u7ea7\u7528\u6cd5\u57fa\u7840\u4e4b\u4e0a\u505a\u4e86\u7b80\u5316\u914d\u7f6e\uff09:</p> <pre><code>taskagentA := llmagent.New(\n  \"coordinator\",\n  llmagent.WithModel(modelInstance),\n  // \u5bf9taskagentA\u3001taskagentB\u751f\u6210\u7684\u6240\u6709\u6d88\u606f\u53ef\u89c1\uff08\u5305\u542b\u540c\u4e00sessionID\u7684\u5386\u53f2\u4f1a\u8bdd\u6d88\u606f\uff09\n  llmagent.WithMessageFilterMode(llmagent.FullContext)\n  // \u5bf9taskagentA\u3001taskagentB\u5f53\u524drunner.Run\u671f\u95f4\u751f\u6210\u7684\u6240\u6709\u6d88\u606f\u53ef\u89c1\uff08\u4e0d\u5305\u542b\u5386\u53f2\u4f1a\u8bdd\u6d88\u606f\uff09\n  llmagent.WithMessageFilterMode(llmagent.RequestContext)\n  // \u4ec5\u5bf9taskagentA\u5f53\u524drunner.Run\u671f\u95f4\u751f\u6210\u7684\u6d88\u606f\u53ef\u89c1\uff08\u4e0d\u5305\u542b\u81ea\u5df1\u7684\u5386\u53f2\u4f1a\u8bdd\u6d88\u606f\uff09\n  llmagent.WithMessageFilterMode(llmagent.IsolatedRequest)\n  // agent\u6267\u6027\u987a\u5e8f\uff1ataskagentA-invocation1 -&gt; taskagentB-invocation2 -&gt; taskagentA-invocation3(\u5f53\u524d\u6267\u884c\u9636\u6bb5)\n  // \u4ec5\u5bf9taskagentA\u5f53\u524dtaskagentA-invocation3\u671f\u95f4\u751f\u6210\u7684\u6d88\u606f\u53ef\u89c1\uff08\u4e0d\u5305\u542b\u81ea\u5df1\u7684\u5386\u53f2\u4f1a\u8bdd\u6d88\u606f\u4ee5\u53cataskagentA-invocation1\u671f\u95f4\u751f\u6210\u7684\u6d88\u606f\uff09\n  llmagent.WithMessageFilterMode(llmagent.IsolatedInvocation)\n)\n\ntaskagentB := llmagent.New(\n  \"coordinator\",\n  llmagent.WithModel(modelInstance),\n  // \u5bf9taskagentA\u3001taskagentB\u751f\u6210\u7684\u6240\u6709\u6d88\u606f\u53ef\u89c1\uff08\u5305\u542b\u540c\u4e00sessionID\u7684\u5386\u53f2\u4f1a\u8bdd\u6d88\u606f\uff09\n  llmagent.WithMessageFilterMode(llmagent.FullContext),\n  // \u5bf9taskagentA\u3001taskagentB\u5f53\u524drunner.Run\u671f\u95f4\u751f\u6210\u7684\u6240\u6709\u6d88\u606f\u53ef\u89c1\uff08\u4e0d\u5305\u542b\u5386\u53f2\u4f1a\u8bdd\u6d88\u606f\uff09\n  llmagent.WithMessageFilterMode(llmagent.RequestContext),\n  // \u4ec5\u5bf9taskagentB\u5f53\u524drunner.Run\u671f\u95f4\u751f\u6210\u7684\u6d88\u606f\u53ef\u89c1\uff08\u4e0d\u5305\u542b\u81ea\u5df1\u7684\u5386\u53f2\u4f1a\u8bdd\u6d88\u606f\uff09\n  llmagent.WithMessageFilterMode(llmagent.IsolatedRequest),\n  // agent\u6267\u6027\u987a\u5e8f\uff1ataskagentA-invocation1 -&gt; taskagentB-invocation2 -&gt; taskagentA-invocation3 -&gt; taskagentB-invocation4(\u5f53\u524d\u6267\u884c\u9636\u6bb5)\n  // \u4ec5\u5bf9taskagentB\u5f53\u524dtaskagentB-invocation4\u671f\u95f4\u751f\u6210\u7684\u6d88\u606f\u53ef\u89c1\uff08\u4e0d\u5305\u542b\u81ea\u5df1\u7684\u5386\u53f2\u4f1a\u8bdd\u6d88\u606f\u4ee5\u53cataskagentB-invocation2\u671f\u95f4\u751f\u6210\u7684\u6d88\u606f\uff09\n  llmagent.WithMessageFilterMode(llmagent.IsolatedInvocation),\n)\n\n// \u5faa\u73af\u6267\u884ctaskagentA\u3001taskagentB\ncycleAgent := cycleagent.New(\n  \"coordinator\",\n  llmagent.WithModel(modelInstance),\n  llmagent.WithSubAgents([]agent.Agent{taskagentA, taskagentB}),\n  llmagent.WithMessageFilterMode(llmagent.FullContext)\n)\n\n// \u521b\u5efa Runner\nrunner := runner.NewRunner(\"demo-app\", cycleAgent)\n\n// \u76f4\u63a5\u53d1\u9001\u6d88\u606f\uff0c\u65e0\u9700\u521b\u5efa\u590d\u6742\u7684 Invocation\nmessage := model.NewUserMessage(\"Hello! Can you tell me about yourself?\")\neventChan, err := runner.Run(ctx, \"user-001\", \"session-001\", message)\nif err != nil {\n    log.Fatalf(\"\u6267\u884c Agent \u5931\u8d25: %v\", err)\n}\n</code></pre> <p>\u9ad8\u9636\u7528\u6cd5\u793a\u4f8b\uff1a \u53ef\u4ee5\u5355\u72ec\u901a\u8fc7 <code>WithMessageTimelineFilterMode</code>\u3001<code>WithMessageBranchFilterMode</code>\u63a7\u5236\u5f53\u524dagent\u5bf9\u5386\u53f2\u6d88\u606f\u4e0e\u5176\u4ed6agent\u751f\u6210\u7684\u6d88\u606f\u53ef\u89c1\u6027\u3002 \u5f53\u524dagent\u5728\u4e0e\u6a21\u578b\u4ea4\u4e92\u65f6\uff0c\u6700\u7ec8\u5c06\u540c\u65f6\u6ee1\u8db3\u4e24\u4e2a\u6761\u4ef6\u7684\u6d88\u606f\u8f93\u5165\u7ed9\u6a21\u578b\u3002</p> <p><code>\u914d\u7f6e:</code> - <code>WithMessageTimelineFilterMode</code>: \u65f6\u95f4\u7ef4\u5ea6\u53ef\u89c1\u6027\u63a7\u5236   - <code>TimelineFilterAll</code>: \u5305\u542b\u5386\u53f2\u6d88\u606f\u4ee5\u53ca\u5f53\u524d\u8bf7\u6c42\u4e2d\u6240\u751f\u6210\u7684\u6d88\u606f   - <code>TimelineFilterCurrentRequest</code>: \u4ec5\u5305\u542b\u5f53\u524d\u8bf7\u6c42(\u4e00\u6b21runner.Run\u4e3a\u4e00\u6b21\u8bf7\u6c42)\u4e2d\u6240\u751f\u6210\u7684\u6d88\u606f   - <code>TimelineFilterCurrentInvocation</code>: \u4ec5\u5305\u542b\u5f53\u524dinvocation\u4e0a\u4e0b\u6587\u4e2d\u751f\u6210\u7684\u6d88\u606f - <code>WithMessageBranchFilterMode</code>: \u5206\u652f\u7ef4\u5ea6\u53ef\u89c1\u6027\u63a7\u5236\uff08\u7528\u4e8e\u63a7\u5236\u5bf9\u5176\u4ed6agent\u751f\u6210\u6d88\u606f\u7684\u53ef\u89c1\u6027\uff09   - <code>BranchFilterModePrefix</code>: \u901a\u8fc7Event.FilterKey\u4e0eInvocation.eventFilterKey\u505a\u524d\u7f00\u5339\u914d   - <code>BranchFilterModeAll</code>: \u6240\u6709agent\u7684\u5747\u6d88\u606f   - <code>BranchFilterModeExact</code>: \u4ec5\u81ea\u5df1\u751f\u6210\u7684\u6d88\u606f\u53ef\u89c1</p> <pre><code>llmAgent := llmagent.New(\n    \"demo-agent\",                      // Agent \u540d\u79f0\n    llmagent.WithModel(modelInstance), // \u8bbe\u7f6e\u6a21\u578b\n    llmagent.WithDescription(\"A helpful AI assistant for demonstrations\"),              // \u8bbe\u7f6e\u63cf\u8ff0\n    llmagent.WithInstruction(\"Be helpful, concise, and informative in your responses\"), // \u8bbe\u7f6e\u6307\u4ee4\n    llmagent.WithGenerationConfig(genConfig),                                           // \u8bbe\u7f6e\u751f\u6210\u53c2\u6570\n\n    // \u8bbe\u7f6e\u4f20\u7ed9\u6a21\u578b\u7684\u6d88\u606f\u8fc7\u6ee4\u6a21\u5f0f\uff0c\u6700\u7ec8\u4f20\u7ed9\u6a21\u578b\u7684\u6d88\u606f\u9700\u540c\u65f6\u6ee1\u8db3WithMessageTimelineFilterMode\u4e0eWithMessageBranchFilterMode\u6761\u4ef6\n    // \u65f6\u95f4\u7ef4\u5ea6\u8fc7\u6ee4\u6761\u4ef6\n    // \u9ed8\u8ba4\u503c: llmagent.TimelineFilterAll\n    // \u53ef\u9009\u503c:\n    //  - llmagent.TimelineFilterAll: \u5305\u542b\u5386\u53f2\u6d88\u606f\u4ee5\u53ca\u5f53\u524d\u8bf7\u6c42\u4e2d\u6240\u751f\u6210\u7684\u6d88\u606f\n    //  - llmagent.TimelineFilterCurrentRequest: \u4ec5\u5305\u542b\u5f53\u524d\u8bf7\u6c42\u4e2d\u6240\u751f\u6210\u7684\u6d88\u606f\n    //  - llmagent.TimelineFilterCurrentInvocation: \u4ec5\u5305\u542b\u5f53\u524dinvocation\u4e0a\u4e0b\u6587\u4e2d\u751f\u6210\u7684\u6d88\u606f\n    llmagent.WithMessageTimelineFilterMode(llmagent.TimelineFilterAll),\n    // \u5206\u652f\u7ef4\u5ea6\u8fc7\u6ee4\u6761\u4ef6\n    // \u9ed8\u8ba4\u503c: llmagent.BranchFilterModePrefix\n    // \u53ef\u9009\u503c:\n    //  - llmagent.BranchFilterModeAll: \u5305\u542b\u6240\u6709agent\u7684\u6d88\u606f, \u5f53\u524dagent\u4e0e\u6a21\u578b\u4ea4\u4e92\u65f6,\u5982\u9700\u5c06\u6240\u6709agent\u751f\u6210\u7684\u6709\u6548\u5185\u5bb9\u6d88\u606f\u540c\u6b65\u7ed9\u6a21\u578b\u65f6\u53ef\u8bbe\u7f6e\u8be5\u503c\n    //  - llmagent.BranchFilterModePrefix: \u901a\u8fc7Event.FilterKey\u4e0eInvocation.eventFilterKey\u505a\u524d\u7f00\u5339\u914d\u8fc7\u6ee4\u6d88\u606f, \u671f\u671b\u5c06\u4e0e\u5f53\u524dagent\u4ee5\u53ca\u76f8\u5173\u4e0a\u4e0b\u6e38agent\u751f\u6210\u7684\u6d88\u606f\u4f20\u9012\u7ed9\u6a21\u578b\u65f6\uff0c\u53ef\u8bbe\u7f6e\u8be5\u503c\n    //  - llmagent.BranchFilterModeExact: \u901a\u8fc7Event.FilterKey==Invocation.eventFilterKey\u8fc7\u6ee4\u6d88\u606f\uff0c\u5f53\u524dagent\u4e0e\u6a21\u578b\u4ea4\u4e92\u65f6,\u4ec5\u9700\u4f7f\u7528\u5f53\u524dagent\u751f\u6210\u7684\u6d88\u606f\u65f6\u53ef\u8bbe\u7f6e\u8be5\u503c\n    llmagent.WithMessageBranchFilterMode(llmagent.BranchFilterModePrefix),\n)\n</code></pre>"},{"location":"zh/agent/#deepseek","title":"\u63a8\u7406\u5185\u5bb9\u6a21\u5f0f\uff08DeepSeek \u601d\u8003\u6a21\u5f0f\uff09","text":"<p>\u5f53\u4f7f\u7528\u5177\u6709\u601d\u8003/\u63a8\u7406\u80fd\u529b\u7684\u6a21\u578b\uff08\u5982 DeepSeek\uff09\u65f6\uff0c\u6a21\u578b\u4f1a\u540c\u65f6\u8f93\u51fa <code>reasoning_content</code>\uff08\u601d\u7ef4\u94fe\uff09\u548c <code>content</code>\uff08\u6700\u7ec8\u56de\u7b54\uff09\u3002\u6839\u636e DeepSeek API \u6587\u6863\uff0c\u5728\u591a\u8f6e\u5bf9\u8bdd\u4e2d\uff0c\u4e0d\u5e94\u5c06\u4e0a\u4e00\u8f6e\u7684 <code>reasoning_content</code> \u53d1\u9001\u7ed9\u6a21\u578b\u3002</p> <p>LLMAgent \u63d0\u4f9b <code>WithReasoningContentMode</code> \u6765\u63a7\u5236\u5bf9\u8bdd\u5386\u53f2\u4e2d <code>reasoning_content</code> \u7684\u5904\u7406\u65b9\u5f0f\uff1a</p> <p>\u53ef\u7528\u6a21\u5f0f\uff1a</p> \u6a21\u5f0f \u5e38\u91cf \u63cf\u8ff0 \u4e22\u5f03\u4e4b\u524d\u8f6e\u6b21 <code>ReasoningContentModeDiscardPreviousTurns</code> \u4e22\u5f03\u4e4b\u524d\u8bf7\u6c42\u8f6e\u6b21\u7684 <code>reasoning_content</code>\uff0c\u4fdd\u7559\u5f53\u524d\u8bf7\u6c42\u7684\u3002\uff08\u9ed8\u8ba4\uff0c\u63a8\u8350\uff09 \u4fdd\u7559\u5168\u90e8 <code>ReasoningContentModeKeepAll</code> \u4fdd\u7559\u5386\u53f2\u4e2d\u7684\u6240\u6709 <code>reasoning_content</code>\uff08\u7528\u4e8e\u8c03\u8bd5\uff09\u3002 \u5168\u90e8\u4e22\u5f03 <code>ReasoningContentModeDiscardAll</code> \u4e22\u5f03\u5386\u53f2\u4e2d\u7684\u6240\u6709 <code>reasoning_content</code>\uff0c\u4ee5\u6700\u5927\u5316\u8282\u7701\u5e26\u5bbd\u3002 <p>\u4f7f\u7528\u793a\u4f8b\uff1a</p> <pre><code>// DeepSeek \u601d\u8003\u6a21\u5f0f\u7684\u63a8\u8350\u914d\u7f6e\u3002\nagent := llmagent.New(\n    \"deepseek-agent\",\n    llmagent.WithModel(deepseekModel),\n    llmagent.WithInstruction(\"You are a helpful assistant.\"),\n    // \u4e22\u5f03\u4e4b\u524d\u8f6e\u6b21\u7684 reasoning_content\uff08\u63a8\u8350\u7528\u4e8e DeepSeek\uff09\u3002\n    llmagent.WithReasoningContentMode(llmagent.ReasoningContentModeDiscardPreviousTurns),\n)\n</code></pre> <p>\u5de5\u4f5c\u539f\u7406\uff1a</p> <ul> <li><code>keep_all</code>\uff1a\u6240\u6709 <code>reasoning_content</code> \u90fd\u4fdd\u7559\u5728\u4f1a\u8bdd\u5386\u53f2\u4e2d\u3002\u5982\u679c\u9700\u8981\u4fdd\u7559\u601d\u7ef4\u94fe\u7528\u4e8e\u8c03\u8bd5\u6216\u5206\u6790\uff0c\u8bf7\u4f7f\u7528\u6b64\u6a21\u5f0f\u3002</li> <li><code>discard_previous_turns</code>\uff1a\u5728\u6784\u5efa\u65b0\u8bf7\u6c42\u7684\u6d88\u606f\u5217\u8868\u65f6\uff0c\u5c5e\u4e8e\u4e4b\u524d\u8bf7\u6c42\u7684\u6d88\u606f\u7684 <code>reasoning_content</code> \u4f1a\u88ab\u6e05\u9664\u3002\u5f53\u524d\u8bf7\u6c42\u5185\u7684\u6d88\u606f\uff08\u4f8b\u5982\u5728\u5de5\u5177\u8c03\u7528\u5faa\u73af\u671f\u95f4\uff09\u4fdd\u7559\u5176 <code>reasoning_content</code>\u3002\u8fd9\u9075\u5faa DeepSeek \u7684\u5efa\u8bae\u3002</li> <li><code>discard_all</code>\uff1a\u5728\u53d1\u9001\u7ed9\u6a21\u578b\u4e4b\u524d\uff0c\u6240\u6709\u5386\u53f2\u6d88\u606f\u7684 <code>reasoning_content</code> \u90fd\u4f1a\u88ab\u6e05\u9664\u3002</li> </ul> <p>\u6ce8\u610f\uff1a \u6b64\u9009\u9879\u4ec5\u5f71\u54cd\u53d1\u9001\u7ed9\u6a21\u578b\u4e4b\u524d\u5bf9\u5386\u53f2\u6d88\u606f\u7684\u5904\u7406\u65b9\u5f0f\u3002\u5f53\u524d\u54cd\u5e94\u7684 <code>reasoning_content</code> \u59cb\u7ec8\u4f1a\u88ab\u6355\u83b7\u5e76\u5b58\u50a8\u5728\u4f1a\u8bdd\u4e8b\u4ef6\u4e2d\u3002</p>"},{"location":"zh/agent/#_6","title":"\u59d4\u6258\u53ef\u89c1\u6027\u9009\u9879","text":"<p>\u5728\u6784\u5efa\u591a Agent\uff08\u667a\u80fd\u4f53\uff09\u7cfb\u7edf\uff08Agent \u4e4b\u95f4\u7684\u4efb\u52a1\u59d4\u6258\uff09\u65f6\uff0cLLMAgent \u63d0\u4f9b\u201c\u9ed8\u8ba4\u5360\u4f4d\u6d88\u606f\u201d\u7684\u7edf\u4e00\u914d\u7f6e\u3002\u8f6c\u79fb\uff08transfer\uff09\u4e8b\u4ef6\u59cb\u7ec8\u5305\u542b\u63d0\u793a\u6587\u672c\uff0c\u5e76\u7edf\u4e00\u6253\u4e0a <code>transfer</code> \u6807\u7b7e\uff0c\u524d\u7aef\uff08UI, User Interface\uff09\u53ef\u6309\u6807\u7b7e\u8fc7\u6ee4\u3002</p> <ul> <li><code>llmagent.WithDefaultTransferMessage(string)</code><ul> <li>\u914d\u7f6e\u5f53\u6a21\u578b\u672a\u63d0\u4f9b <code>message</code> \u65f6\u7684\u201c\u8f6c\u79fb\u9ed8\u8ba4\u6d88\u606f\u201d\u3002</li> <li>\u4f20\u5165\u7a7a\u5b57\u7b26\u4e32\u8868\u793a\u201c\u7981\u7528\u9ed8\u8ba4\u6d88\u606f\u6ce8\u5165\u201d\uff1b\u4f20\u5165\u975e\u7a7a\u5b57\u7b26\u4e32\u8868\u793a\u201c\u542f\u7528\u5e76\u4f7f\u7528\u8be5\u5b57\u7b26\u4e32\u4f5c\u4e3a\u9ed8\u8ba4\u6d88\u606f\u201d\u3002</li> </ul> </li> </ul> <p>\u7528\u6cd5\u793a\u4f8b\uff1a</p> <pre><code>coordinator := llmagent.New(\n  \"coordinator\",\n  llmagent.WithModel(modelInstance),\n  llmagent.WithSubAgents([]agent.Agent{mathAgent, weatherAgent}),\n  // \u8f6c\u79fb\u63d0\u793a\u4e8b\u4ef6\u603b\u662f\u4f1a\u8f93\u51fa\uff08\u5e26\u6709 `transfer` \u6807\u7b7e\uff09\uff0c\u5982\u9700\u9690\u85cf\u53ef\u5728 UI \u5c42\u6309\u6807\u7b7e\u8fc7\u6ee4\n  // \u5f53\u6a21\u578b\u672a\u4f20 message \u65f6\uff0c\u81ea\u5b9a\u4e49\u9ed8\u8ba4\u6d88\u606f\uff08\u4f20\u7a7a\u5b57\u7b26\u4e32\u53ef\u7981\u7528\uff09\n  llmagent.WithDefaultTransferMessage(\"Handing off to the specialist\"),\n)\n</code></pre> <p>\u8bf4\u660e\uff1a</p> <ul> <li>\u8fd9\u4e9b\u9009\u9879\u4e0d\u4f1a\u6539\u53d8\u771f\u5b9e\u7684\u59d4\u6258/\u5207\u6362\u903b\u8f91\uff0c\u53ea\u5f71\u54cd\u201c\u5bf9\u5916\u53ef\u89c1\u7684\u63d0\u793a\u6587\u672c\u201d\u6216\u201c\u662f\u5426\u6ce8\u5165\u9ed8\u8ba4\u5360\u4f4d\u6d88\u606f\u201d\u3002</li> <li>\u8f6c\u79fb\u63d0\u793a\u4e8b\u4ef6\u7edf\u4e00\u4ee5 <code>Response.Object == \"agent.transfer\"</code> \u8f93\u51fa\uff1b\u5982\u9700\u5728 UI \u5c42\u9690\u85cf\u7cfb\u7edf\u7ea7\u63d0\u793a\uff0c\u53ef\u76f4\u63a5\u8fc7\u6ee4\u8be5\u5bf9\u8c61\u7c7b\u578b\u7684\u4e8b\u4ef6\u3002</li> </ul>"},{"location":"zh/agent/#_7","title":"\u5904\u7406\u4e8b\u4ef6\u6d41","text":"<p><code>runner.Run()</code> \u8fd4\u56de\u7684 <code>eventChan</code> \u662f\u4e00\u4e2a\u4e8b\u4ef6\u901a\u9053\uff0cAgent \u6267\u884c\u8fc7\u7a0b\u4e2d\u4f1a\u6301\u7eed\u5411\u8fd9\u4e2a\u901a\u9053\u53d1\u9001 Event \u5bf9\u8c61\u3002</p> <p>\u6bcf\u4e2a Event \u5305\u542b\u4e86\u67d0\u4e2a\u65f6\u523b\u7684\u6267\u884c\u72b6\u6001\u4fe1\u606f\uff1aLLM \u751f\u6210\u7684\u5185\u5bb9\u3001\u5de5\u5177\u8c03\u7528\u7684\u8bf7\u6c42\u548c\u7ed3\u679c\u3001\u9519\u8bef\u4fe1\u606f\u7b49\u3002\u901a\u8fc7\u904d\u5386\u4e8b\u4ef6\u901a\u9053\uff0c\u4f60\u53ef\u4ee5\u5b9e\u65f6\u83b7\u53d6 Agent \u7684\u6267\u884c\u8fdb\u5c55\uff08\u8be6\u89c1\u4e0b\u65b9 Event \u7ae0\u8282\uff09\u3002</p> <p>\u901a\u8fc7\u4e8b\u4ef6\u901a\u9053\u63a5\u6536\u6267\u884c\u7ed3\u679c\uff1a</p> <pre><code>// 1. \u83b7\u53d6\u4e8b\u4ef6\u901a\u9053\uff08\u7acb\u5373\u8fd4\u56de\uff0c\u5f00\u59cb\u5f02\u6b65\u6267\u884c\uff09\neventChan, err := runner.Run(ctx, userID, sessionID, message)\nif err != nil {\n    log.Fatalf(\"failed to run agent: %v\", err)\n}\n\n// 2. \u5904\u7406\u4e8b\u4ef6\u6d41\uff08\u5b9e\u65f6\u63a5\u6536\u6267\u884c\u7ed3\u679c\uff09\nfor event := range eventChan {\n    // \u68c0\u67e5\u9519\u8bef\n    if event.Error != nil {\n        log.Printf(\"error: %s\", event.Error.Message)\n        continue\n    }\n\n    // \u5904\u7406\u54cd\u5e94\u5185\u5bb9\n    if len(event.Response.Choices) &gt; 0 {\n        choice := event.Response.Choices[0]\n\n        // \u6d41\u5f0f\u5185\u5bb9\uff08\u5b9e\u65f6\u663e\u793a\uff09\n        if choice.Delta.Content != \"\" {\n            fmt.Print(choice.Delta.Content)\n        }\n\n        // \u5de5\u5177\u8c03\u7528\u4fe1\u606f\n        for _, toolCall := range choice.Message.ToolCalls {\n            fmt.Printf(\"calling tool: %s\\n\", toolCall.Function.Name)\n        }\n    }\n\n    // \u68c0\u67e5\u662f\u5426\u5b8c\u6210\uff08\u6ce8\u610f\uff1a\u5de5\u5177\u8c03\u7528\u5b8c\u6210\u65f6\u4e0d\u5e94\u8be5 break\uff09\n    if event.IsFinalResponse() {\n        fmt.Println()\n        break\n    }\n}\n</code></pre> <p>\u8be5\u793a\u4f8b\u7684\u5b8c\u6574\u4ee3\u7801\u53ef\u89c1 examples/runner</p> <p>\u4e3a\u4ec0\u4e48\u63a8\u8350\u4f7f\u7528 Runner\uff1f</p> <ol> <li>\u66f4\u7b80\u5355\u7684\u63a5\u53e3\uff1a\u65e0\u9700\u521b\u5efa\u590d\u6742\u7684 Invocation \u5bf9\u8c61</li> <li>\u96c6\u6210\u670d\u52a1\uff1a\u81ea\u52a8\u96c6\u6210 Session\u3001Memory \u7b49\u670d\u52a1</li> <li>\u66f4\u597d\u7684\u7ba1\u7406\uff1a\u7edf\u4e00\u7ba1\u7406 Agent \u7684\u6267\u884c\u6d41\u7a0b</li> <li>\u751f\u4ea7\u5c31\u7eea\uff1a\u9002\u5408\u751f\u4ea7\u73af\u5883\u4f7f\u7528</li> </ol> <p>\ud83d\udca1 \u63d0\u793a\uff1a \u60f3\u4e86\u89e3\u66f4\u591a Runner \u7684\u8be6\u7ec6\u7528\u6cd5\u548c\u9ad8\u7ea7\u529f\u80fd\uff1f\u8bf7\u67e5\u770b Runner</p> <p>\u9ad8\u7ea7\u7528\u6cd5\uff1a\u76f4\u63a5\u4f7f\u7528 Agent</p> <p>\u5982\u679c\u4f60\u9700\u8981\u66f4\u7ec6\u7c92\u5ea6\u7684\u63a7\u5236\uff0c\u4e5f\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528 Agent \u63a5\u53e3\uff0c\u4f46\u8fd9\u9700\u8981\u521b\u5efa Invocation \u5bf9\u8c61\uff1a</p>"},{"location":"zh/agent/#_8","title":"\u6838\u5fc3\u6982\u5ff5","text":""},{"location":"zh/agent/#invocation","title":"Invocation\uff08\u9ad8\u7ea7\u7528\u6cd5\uff09","text":"<p>Invocation \u662f Agent \u6267\u884c\u6d41\u7a0b\u7684\u4e0a\u4e0b\u6587\u5bf9\u8c61\uff0c\u5305\u542b\u4e86\u5355\u6b21\u8c03\u7528\u6240\u9700\u7684\u6240\u6709\u4fe1\u606f\u3002\u6ce8\u610f\uff1a\u8fd9\u662f\u9ad8\u7ea7\u7528\u6cd5\uff0c\u63a8\u8350\u4f7f\u7528 Runner \u6765\u7b80\u5316\u64cd\u4f5c\u3002</p> <pre><code>import \"trpc.group/trpc-go/trpc-agent-go/agent\"\n\n// \u521b\u5efa Invocation \u5bf9\u8c61\uff08\u9ad8\u7ea7\u7528\u6cd5\uff09\ninvocation := agent.NewInvocation(\n    agent.WithInvocationAgent(r.agent),                               // Agent \u5b9e\u4f8b\n    agent.WithInvocationSession(&amp;session.Session{ID: \"session-001\"}), // Session\n    agent.WithInvocationEndInvocation(false),                         // \u662f\u5426\u7ed3\u675f\u8c03\u7528\n    agent.WithInvocationMessage(model.NewUserMessage(\"User input\")),  // \u7528\u6237\u6d88\u606f\n    agent.WithInvocationModel(modelInstance),                         // \u4f7f\u7528\u7684\u6a21\u578b\n)\n\n// \u76f4\u63a5\u8c03\u7528 Agent\uff08\u9ad8\u7ea7\u7528\u6cd5\uff09\nctx := context.Background()\neventChan, err := llmAgent.Run(ctx, invocation)\nif err != nil {\n    log.Fatalf(\"\u6267\u884c Agent \u5931\u8d25: %v\", err)\n}\n</code></pre> <p>\u4ec0\u4e48\u65f6\u5019\u4f7f\u7528\u76f4\u63a5\u8c03\u7528\uff1f</p> <ul> <li>\u9700\u8981\u5b8c\u5168\u63a7\u5236\u6267\u884c\u6d41\u7a0b</li> <li>\u81ea\u5b9a\u4e49 Session \u548c Memory \u7ba1\u7406</li> <li>\u5b9e\u73b0\u7279\u6b8a\u7684\u8c03\u7528\u903b\u8f91</li> <li>\u8c03\u8bd5\u548c\u6d4b\u8bd5\u573a\u666f</li> </ul> <pre><code>// Invocation \u662f Agent \u6267\u884c\u6d41\u7a0b\u7684\u4e0a\u4e0b\u6587\u5bf9\u8c61\uff0c\u5305\u542b\u5355\u6b21\u8c03\u7528\u6240\u9700\u7684\u5168\u90e8\u4fe1\u606f\ntype Invocation struct {\n    // Agent \u6307\u5b9a\u8981\u8c03\u7528\u7684 Agent \u5b9e\u4f8b\n    Agent Agent\n    // AgentName \u6807\u8bc6\u8981\u8c03\u7528\u7684 Agent \u5b9e\u4f8b\u540d\u79f0\n    AgentName string\n    // InvocationID \u4e3a\u6bcf\u6b21\u8c03\u7528\u63d0\u4f9b\u552f\u4e00\u6807\u8bc6\n    InvocationID string\n    // Branch \u7528\u4e8e\u5206\u5c42\u4e8b\u4ef6\u8fc7\u6ee4\u7684\u5206\u652f\u6807\u8bc6\u7b26\n    Branch string\n    // EndInvocation \u6807\u8bc6\u662f\u5426\u7ed3\u675f\u8c03\u7528\n    EndInvocation bool\n\n    // Session \u7ef4\u62a4\u5bf9\u8bdd\u4e0a\u4e0b\u6587\u72b6\u6001\n    Session *session.Session\n    // Model \u6307\u5b9a\u8981\u4f7f\u7528\u7684\u6a21\u578b\u5b9e\u4f8b\n    Model model.Model\n    // Message \u662f\u7528\u6237\u53d1\u9001\u7ed9 Agent \u7684\u5177\u4f53\u5185\u5bb9\n    Message model.Message\n    // RunOptions \u662f Run \u65b9\u6cd5\u7684\u9009\u9879\u914d\u7f6e\n    RunOptions RunOptions\n    // TransferInfo \u652f\u6301 Agent \u95f4\u7684\u63a7\u5236\u6743\u8f6c\u79fb\n    TransferInfo *TransferInfo\n\n    // \u7ed3\u6784\u5316\u8f93\u51fa\u914d\u7f6e\uff08\u53ef\u9009\uff09\n    StructuredOutput     *model.StructuredOutput\n    StructuredOutputType reflect.Type\n\n    // \u4e3a\u672c\u6b21\u8c03\u7528\u6ce8\u5165\u7684\u670d\u52a1\n    MemoryService   memory.Service\n    ArtifactService artifact.Service\n\n    // \u5185\u90e8\u901a\u77e5\uff1a\u5f53\u4e8b\u4ef6\u5199\u5165\u4f1a\u8bdd\u65f6\u53d1\u51fa\u901a\u77e5\n    noticeChanMap map[string]chan any\n    noticeMu      *sync.Mutex\n\n    // \u5185\u90e8\uff1a\u4e8b\u4ef6\u8fc7\u6ee4\u952e\u4e0e\u7236\u8c03\u7528\uff08\u7528\u4e8e\u5d4c\u5957\u6d41\u7a0b\uff09\n    eventFilterKey string\n    parent         *Invocation\n\n    // \u8c03\u7528\u7ea7\u72b6\u6001\uff08\u5ef6\u8fdf\u521d\u59cb\u5316\uff0c\u901a\u8fc7 stateMu \u4fdd\u62a4\u5e76\u53d1\uff09\n    state   map[string]any\n    stateMu sync.RWMutex\n\n    // \u53ef\u9009\u7684\u8c03\u7528\u7ea7\u5b89\u5168\u9650\u5236\uff08\u901a\u5e38\u7531 LLMAgent \u5728 setupInvocation \u4e2d\u8bbe\u7f6e\uff09\u3002\n    MaxLLMCalls      int\n    MaxToolIterations int\n\n    // \u4e0e MaxLLMCalls / MaxToolIterations \u914d\u5957\u4f7f\u7528\u7684\u5185\u90e8\u8ba1\u6570\u5668\u3002\n    llmCallCount       int\n    toolIterationCount int\n}\n</code></pre>"},{"location":"zh/agent/#invocation-state","title":"Invocation State","text":"<p><code>Invocation</code> \u63d0\u4f9b\u4e86\u901a\u7528\u7684\u72b6\u6001\u5b58\u50a8\u673a\u5236\uff0c\u7528\u4e8e\u5728\u5355\u6b21\u8c03\u7528\u7684\u751f\u547d\u5468\u671f\u5185\u5171\u4eab\u6570\u636e\u3002\u8fd9\u5bf9\u4e8e callbacks\u3001middleware \u6216\u4efb\u4f55\u9700\u8981\u5728 invocation \u7ea7\u522b\u5b58\u50a8\u4e34\u65f6\u6570\u636e\u7684\u573a\u666f\u90fd\u5f88\u6709\u7528\u3002</p> <p>\u6838\u5fc3\u65b9\u6cd5\uff1a</p> <pre><code>// \u8bbe\u7f6e\u72b6\u6001\u503c\ninv.SetState(key string, value any)\n\n// \u83b7\u53d6\u72b6\u6001\u503c\nvalue, ok := inv.GetState(key string)\n\n// \u5220\u9664\u72b6\u6001\u503c\ninv.DeleteState(key string)\n</code></pre> <p>\u7279\u70b9\uff1a</p> <ul> <li>Invocation \u7ea7\u4f5c\u7528\u57df\uff1a\u72b6\u6001\u81ea\u52a8\u9650\u5b9a\u5728\u5355\u6b21 Invocation \u5185</li> <li>\u7ebf\u7a0b\u5b89\u5168\uff1a\u5185\u7f6e RWMutex \u4fdd\u62a4\uff0c\u652f\u6301\u5e76\u53d1\u8bbf\u95ee</li> <li>\u61d2\u521d\u59cb\u5316\uff1a\u9996\u6b21\u4f7f\u7528\u65f6\u624d\u5206\u914d\u5185\u5b58</li> <li>\u901a\u7528\u6027\u5f3a\uff1a\u53ef\u7528\u4e8e callbacks\u3001middleware\u3001\u81ea\u5b9a\u4e49\u903b\u8f91\u7b49\u591a\u79cd\u573a\u666f</li> </ul> <p>\u4f7f\u7528\u793a\u4f8b\uff1a</p> <p>\u7248\u672c\u8981\u6c42 \u7ed3\u6784\u5316\u56de\u8c03 API\uff08\u63a8\u8350\uff09\u9700\u8981 trpc-agent-go &gt;= 0.6.0\u3002</p> <pre><code>// \u5728 BeforeAgentCallback \u4e2d\u5b58\u50a8\u6570\u636e\n// \u6ce8\u610f\uff1a\u7ed3\u6784\u5316\u56de\u8c03 API \u9700\u8981 trpc-agent-go &gt;= 0.6.0\ncallbacks := agent.NewCallbacks()\ncallbacks.RegisterBeforeAgent(func(ctx context.Context, args *agent.BeforeAgentArgs) (*agent.BeforeAgentResult, error) {\n    args.Invocation.SetState(\"agent:start_time\", time.Now())\n    args.Invocation.SetState(\"custom:request_id\", \"req-123\")\n    return nil, nil\n})\n\n// \u5728 AfterAgentCallback \u4e2d\u8bfb\u53d6\u6570\u636e\ncallbacks.RegisterAfterAgent(func(ctx context.Context, args *agent.AfterAgentArgs) (*agent.AfterAgentResult, error) {\n    if startTime, ok := args.Invocation.GetState(\"agent:start_time\"); ok {\n        duration := time.Since(startTime.(time.Time))\n        log.Printf(\"Execution took: %v\", duration)\n        args.Invocation.DeleteState(\"agent:start_time\")\n    }\n    return nil, nil\n})\n</code></pre> <p>\u63a8\u8350\u7684\u952e\u540d\u7ea6\u5b9a\uff1a</p> <ul> <li>Agent \u56de\u8c03\uff1a<code>\"agent:xxx\"</code></li> <li>Model \u56de\u8c03\uff1a<code>\"model:xxx\"</code></li> <li>Tool \u56de\u8c03\uff1a<code>\"tool:toolName:xxx\"</code></li> <li>\u4e2d\u95f4\u4ef6\uff1a<code>\"middleware:xxx\"</code></li> <li>\u81ea\u5b9a\u4e49\u903b\u8f91\uff1a<code>\"custom:xxx\"</code></li> </ul> <p>\u8be6\u7ec6\u7684\u4f7f\u7528\u8bf4\u660e\u548c\u66f4\u591a\u793a\u4f8b\u8bf7\u53c2\u8003 Callbacks\u3002</p>"},{"location":"zh/agent/#event","title":"Event","text":"<p>Event \u662f Agent \u6267\u884c\u8fc7\u7a0b\u4e2d\u4ea7\u751f\u7684\u5b9e\u65f6\u53cd\u9988\uff0c\u901a\u8fc7 Event \u6d41\u5b9e\u65f6\u62a5\u544a\u6267\u884c\u8fdb\u5c55\u3002</p> <p>Event \u4e3b\u8981\u6709\u4ee5\u4e0b\u7c7b\u578b\uff1a</p> <ul> <li>\u6a21\u578b\u5bf9\u8bdd\u4e8b\u4ef6</li> <li>\u5de5\u5177\u8c03\u7528\u4e0e\u54cd\u5e94\u4e8b\u4ef6</li> <li>Agent \u8f6c\u79fb\u4e8b\u4ef6</li> <li>\u9519\u8bef\u4e8b\u4ef6</li> </ul> <pre><code>// Event \u662f Agent \u6267\u884c\u8fc7\u7a0b\u4e2d\u4ea7\u751f\u7684\u5b9e\u65f6\u53cd\u9988\uff0c\u901a\u8fc7 Event \u6d41\u5b9e\u65f6\u62a5\u544a\u6267\u884c\u8fdb\u5c55\ntype Event struct {\n    // Response \u5305\u542b\u6a21\u578b\u7684\u54cd\u5e94\u5185\u5bb9\u3001\u5de5\u5177\u8c03\u7528\u7ed3\u679c\u548c\u7edf\u8ba1\u4fe1\u606f\n    *model.Response\n    // InvocationID \u5173\u8054\u5230\u5177\u4f53\u7684\u8c03\u7528\n    InvocationID string `json:\"invocationId\"`\n    // Author \u662f\u4e8b\u4ef6\u7684\u6765\u6e90\uff0c\u4f8b\u5982 Agent \u6216\u5de5\u5177\n    Author string `json:\"author\"`\n    // ID \u662f\u4e8b\u4ef6\u7684\u552f\u4e00\u6807\u8bc6\n    ID string `json:\"id\"`\n    // Timestamp \u8bb0\u5f55\u4e8b\u4ef6\u53d1\u751f\u7684\u65f6\u95f4\n    Timestamp time.Time `json:\"timestamp\"`\n    // Branch \u7528\u4e8e\u5206\u5c42\u4e8b\u4ef6\u8fc7\u6ee4\u7684\u5206\u652f\u6807\u8bc6\u7b26\n    Branch string `json:\"branch,omitempty\"`\n    // RequiresCompletion \u6807\u8bc6\u6b64\u4e8b\u4ef6\u662f\u5426\u9700\u8981\u5b8c\u6210\u4fe1\u53f7\n    RequiresCompletion bool `json:\"requiresCompletion,omitempty\"`\n    // LongRunningToolIDs \u662f\u957f\u65f6\u95f4\u8fd0\u884c\u51fd\u6570\u8c03\u7528\u7684 ID \u96c6\u5408\uff0cAgent \u5ba2\u6237\u7aef\u53ef\u4ee5\u901a\u8fc7\u6b64\u5b57\u6bb5\u4e86\u89e3\u54ea\u4e2a\u51fd\u6570\u8c03\u7528\u662f\u957f\u65f6\u95f4\u8fd0\u884c\u7684\uff0c\u4ec5\u5bf9\u51fd\u6570\u8c03\u7528\u4e8b\u4ef6\u6709\u6548\n    LongRunningToolIDs map[string]struct{} `json:\"longRunningToolIDs,omitempty\"`\n}\n</code></pre> <p>Event \u7684\u6d41\u5f0f\u7279\u6027\u8ba9\u4f60\u80fd\u591f\u5b9e\u65f6\u770b\u5230 Agent \u7684\u5de5\u4f5c\u8fc7\u7a0b\uff0c\u5c31\u50cf\u548c\u4e00\u4e2a\u771f\u4eba\u5bf9\u8bdd\u4e00\u6837\u81ea\u7136\u3002\u4f60\u53ea\u9700\u8981\u904d\u5386 Event \u6d41\uff0c\u68c0\u67e5\u6bcf\u4e2a Event \u7684\u5185\u5bb9\u548c\u72b6\u6001\uff0c\u5c31\u80fd\u5b8c\u6574\u5730\u5904\u7406 Agent \u7684\u6267\u884c\u7ed3\u679c\u3002</p>"},{"location":"zh/agent/#agent_1","title":"Agent \u63a5\u53e3","text":"<p>Agent \u63a5\u53e3\u5b9a\u4e49\u4e86\u6240\u6709 Agent \u5fc5\u987b\u5b9e\u73b0\u7684\u6838\u5fc3\u884c\u4e3a\u3002\u8fd9\u4e2a\u63a5\u53e3\u8ba9\u4f60\u80fd\u591f\u7edf\u4e00\u4f7f\u7528\u4e0d\u540c\u7c7b\u578b\u7684 Agent\uff0c\u540c\u65f6\u652f\u6301\u5de5\u5177\u8c03\u7528\u548c\u5b50 Agent \u7ba1\u7406\u3002</p> <pre><code>type Agent interface {\n    // Run \u63a5\u6536\u6267\u884c\u4e0a\u4e0b\u6587\u548c\u8c03\u7528\u4fe1\u606f\uff0c\u8fd4\u56de\u4e00\u4e2a\u4e8b\u4ef6\u901a\u9053\u3002\u901a\u8fc7\u8fd9\u4e2a\u901a\u9053\uff0c\u4f60\u53ef\u4ee5\u5b9e\u65f6\u63a5\u6536 Agent \u7684\u6267\u884c\u8fdb\u5c55\u548c\u7ed3\u679c\n    Run(ctx context.Context, invocation *Invocation) (&lt;-chan *event.Event, error)\n    // Tools \u8fd4\u56de\u6b64 Agent \u53ef\u4ee5\u8bbf\u95ee\u548c\u6267\u884c\u7684\u5de5\u5177\u5217\u8868\n    Tools() []tool.Tool\n    // Info \u65b9\u6cd5\u63d0\u4f9b Agent \u7684\u57fa\u672c\u4fe1\u606f\uff0c\u5305\u62ec\u540d\u79f0\u548c\u63cf\u8ff0\uff0c\u4fbf\u4e8e\u8bc6\u522b\u548c\u7ba1\u7406\n    Info() Info\n    // SubAgents \u8fd4\u56de\u6b64 Agent \u53ef\u7528\u7684\u5b50 Agent \u5217\u8868\n    // SubAgents \u548c FindSubAgent \u65b9\u6cd5\u652f\u6301 Agent \u4e4b\u95f4\u7684\u534f\u4f5c\u3002\u4e00\u4e2a Agent \u53ef\u4ee5\u5c06\u4efb\u52a1\u59d4\u6258\u7ed9\u5176\u4ed6 Agent\uff0c\u6784\u5efa\u590d\u6742\u7684\u591a Agent \u7cfb\u7edf\n    SubAgents() []Agent\n    // FindSubAgent \u901a\u8fc7\u540d\u79f0\u67e5\u627e\u5b50 Agent\n    FindSubAgent(name string) Agent\n}\n</code></pre> <p>\u6846\u67b6\u63d0\u4f9b\u4e86\u591a\u79cd\u7c7b\u578b\u7684 Agent \u5b9e\u73b0\uff0c\u5305\u62ec LLMAgent\u3001ChainAgent\u3001ParallelAgent\u3001CycleAgent \u548c GraphAgent\uff0c\u4e0d\u540c\u7c7b\u578b Agent \u4ee5\u53ca\u591a Agent \u7cfb\u7edf\u7684\u8be6\u7ec6\u4ecb\u7ecd\u8bf7\u53c2\u8003 Multi-Agent\u3002</p>"},{"location":"zh/agent/#callbacks","title":"Callbacks","text":"<p>Callbacks \u63d0\u4f9b\u4e86\u4e30\u5bcc\u7684\u56de\u8c03\u673a\u5236\uff0c\u8ba9\u4f60\u80fd\u591f\u5728 Agent \u6267\u884c\u7684\u5173\u952e\u8282\u70b9\u6ce8\u5165\u81ea\u5b9a\u4e49\u903b\u8f91\u3002</p> <p>\u7248\u672c\u8981\u6c42 \u7ed3\u6784\u5316\u56de\u8c03 API\uff08\u63a8\u8350\uff09\u9700\u8981 trpc-agent-go &gt;= 0.6.0\u3002</p>"},{"location":"zh/agent/#_9","title":"\u56de\u8c03\u7c7b\u578b","text":"<p>\u6846\u67b6\u63d0\u4f9b\u4e86\u4e09\u79cd\u7c7b\u578b\u7684\u56de\u8c03\uff1a</p> <p>Agent Callbacks\uff1a\u5728 Agent \u6267\u884c\u524d\u540e\u89e6\u53d1</p> <pre><code>// \u4f7f\u7528 agent.NewCallbacks() \u521b\u5efa\u56de\u8c03\ncallbacks := agent.NewCallbacks()\n</code></pre> <p>Model Callbacks\uff1a\u5728\u6a21\u578b\u8c03\u7528\u524d\u540e\u89e6\u53d1</p> <pre><code>// \u4f7f\u7528 model.NewCallbacks() \u521b\u5efa\u56de\u8c03\ncallbacks := model.NewCallbacks()\n</code></pre> <p>Tool Callbacks\uff1a\u5728\u5de5\u5177\u8c03\u7528\u524d\u540e\u89e6\u53d1</p> <pre><code>// \u4f7f\u7528 tool.NewCallbacks() \u521b\u5efa\u56de\u8c03\ncallbacks := tool.NewCallbacks()\n</code></pre>"},{"location":"zh/agent/#_10","title":"\u4f7f\u7528\u793a\u4f8b","text":"<pre><code>// \u521b\u5efa Agent \u56de\u8c03\uff08\u4f7f\u7528\u7ed3\u6784\u5316 API\uff09\n// \u6ce8\u610f\uff1a\u7ed3\u6784\u5316\u56de\u8c03 API \u9700\u8981 trpc-agent-go &gt;= 0.6.0\ncallbacks := agent.NewCallbacks()\ncallbacks.RegisterBeforeAgent(func(ctx context.Context, args *agent.BeforeAgentArgs) (*agent.BeforeAgentResult, error) {\n    log.Printf(\"Agent %s \u5f00\u59cb\u6267\u884c\", args.Invocation.AgentName)\n    return nil, nil\n})\ncallbacks.RegisterAfterAgent(func(ctx context.Context, args *agent.AfterAgentArgs) (*agent.AfterAgentResult, error) {\n    if args.Error != nil {\n        log.Printf(\"Agent %s \u6267\u884c\u51fa\u9519: %v\", args.Invocation.AgentName, args.Error)\n    } else {\n        log.Printf(\"Agent %s \u6267\u884c\u5b8c\u6210\", args.Invocation.AgentName)\n    }\n    return nil, nil\n})\n\n// \u5728 llmAgent \u4e2d\u4f7f\u7528\u56de\u8c03\nllmagent := llmagent.New(\"llmagent\", llmagent.WithAgentCallbacks(callbacks))\n</code></pre> <p>\u56de\u8c03\u673a\u5236\u8ba9\u4f60\u80fd\u591f\u7cbe\u786e\u63a7\u5236 Agent \u7684\u6267\u884c\u8fc7\u7a0b\uff0c\u5b9e\u73b0\u66f4\u590d\u6742\u7684\u4e1a\u52a1\u903b\u8f91\u3002</p>"},{"location":"zh/agent/#_11","title":"\u8fdb\u9636\u4f7f\u7528","text":"<p>\u6846\u67b6\u63d0\u4f9b\u4e86 Runner\u3001Session \u548c Memory \u7b49\u9ad8\u7ea7\u529f\u80fd\uff0c\u7528\u4e8e\u6784\u5efa\u66f4\u590d\u6742\u7684 Agent \u7cfb\u7edf\u3002</p> <p>Runner \u662f\u63a8\u8350\u7684\u4f7f\u7528\u65b9\u5f0f\uff0c\u5b83\u8d1f\u8d23\u7ba1\u7406 Agent \u7684\u6267\u884c\u6d41\u7a0b\uff0c\u4e32\u8054\u4e86 Session/Memory Service \u7b49\u80fd\u529b\uff0c\u63d0\u4f9b\u4e86\u66f4\u53cb\u597d\u7684\u63a5\u53e3\u3002</p> <p>Session Service \u7528\u4e8e\u7ba1\u7406\u4f1a\u8bdd\u72b6\u6001\uff0c\u652f\u6301\u5bf9\u8bdd\u5386\u53f2\u8bb0\u5f55\u548c\u4e0a\u4e0b\u6587\u7ef4\u62a4\u3002</p> <p>Memory Service \u7528\u4e8e\u8bb0\u5f55\u7528\u6237\u7684\u504f\u597d\u4fe1\u606f\uff0c\u652f\u6301\u4e2a\u6027\u5316\u4f53\u9a8c\u3002</p> <p>\u63a8\u8350\u9605\u8bfb\u987a\u5e8f\uff1a</p> <ol> <li>Runner - \u5b66\u4e60\u63a8\u8350\u7684\u4f7f\u7528\u65b9\u5f0f</li> <li>Session - \u4e86\u89e3\u4f1a\u8bdd\u7ba1\u7406</li> <li>Multi-Agent - \u5b66\u4e60\u591a Agent \u7cfb\u7edf</li> </ol>"},{"location":"zh/agent/#instruction","title":"\u8fd0\u884c\u65f6\u52a8\u6001\u66f4\u65b0 Instruction","text":"<p>\u4f60\u53ef\u4ee5\u5728 Agent \u5df2\u7ecf\u521b\u5efa\u5e76\u88ab Runner \u4f7f\u7528\u7684\u60c5\u51b5\u4e0b\uff0c\u52a8\u6001\u66f4\u65b0\u5176\u884c\u4e3a\u6587\u6848\uff1a</p> <ul> <li>Instruction\uff1a\u7528\u4e8e\u7ea6\u675f Agent \u884c\u4e3a\u7684\u8bf4\u660e\u6587\u672c\uff08\u8ffd\u52a0\u5230\u7cfb\u7edf\u6d88\u606f\u4e2d\uff09\u3002</li> <li>Global Instruction\uff08\u7cfb\u7edf\u63d0\u793a\u8bcd\uff09\uff1a\u7cfb\u7edf\u7ea7\u524d\u8a00\uff08\u4f5c\u4e3a\u7cfb\u7edf\u6d88\u606f\u7684\u524d\u7f00\uff09\u3002</li> </ul> <p>\u4e24\u8005\u90fd\u53ef\u4ee5\u5728\u5df2\u6709\u7684 <code>LLMAgent</code> \u5b9e\u4f8b\u4e0a\u52a8\u6001\u8bbe\u7f6e\uff0c\u65b0\u503c\u4f1a\u4f5c\u7528\u4e8e\u540e\u7eed\u7684\u6a21\u578b\u8bf7\u6c42\u3002</p> <p>\u793a\u4f8b</p> <pre><code>import (\n    \"context\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/agent/llmagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/model\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/openai\"\n    \"trpc.group/trpc-go/trpc-agent-go/runner\"\n)\n\n// 1\uff09\u670d\u52a1\u542f\u52a8\u65f6\u53ea\u6784\u5efa\u4e00\u6b21\u6a21\u578b\u4e0e Agent\nmdl := openai.New(\"gpt-4o-mini\", openai.Options{})\nllm := llmagent.New(\n    \"support-bot\",\n    llmagent.WithModel(mdl),\n    llmagent.WithInstruction(\"Be helpful and concise.\"),\n)\nrun := runner.NewRunner(\"my-app\", llm)\n\n// 2\uff09\u8fd0\u884c\u4e2d\u6839\u636e\u7528\u6237\u5728\u540e\u53f0\u4fee\u6539\u7684\u63d0\u793a\u8bcd\uff0c\u52a8\u6001\u66f4\u65b0\nllm.SetInstruction(\"Translate all user inputs to French.\")\nllm.SetGlobalInstruction(\"System: Safety first. No PII leakage.\")\n\n// 3\uff09\u4e4b\u540e\u7684\u5bf9\u8bdd\u8f6e\u6b21\u5c06\u4f7f\u7528\u6700\u65b0\u7684\u63d0\u793a\u8bcd\nmsg := model.NewUserMessage(\"Where is the nearest museum?\")\nch, err := run.Run(context.Background(), \"u1\", \"s1\", msg)\n_ = ch; _ = err\n</code></pre> <p>\u6ce8\u610f</p> <ul> <li>\u7ebf\u7a0b\u5b89\u5168\uff1a\u4e0a\u8ff0\u8bbe\u7f6e\u65b9\u6cd5\u662f\u5e76\u53d1\u5b89\u5168\u7684\uff0c\u53ef\u5728\u670d\u52a1\u5904\u7406\u8bf7\u6c42\u65f6\u8c03\u7528\u3002</li> <li>\u540c\u4e00\u8f6e\u6b21\u5185\u7684\u6548\u679c\uff1a\u82e5\u4e00\u6b21\u8c03\u7528\u8fc7\u7a0b\u4e2d\u4f1a\u89e6\u53d1\u591a\u6b21\u6a21\u578b\u8bf7\u6c42\uff08\u4f8b\u5982\u5de5\u5177\u8c03\u7528\u540e\u518d\u6b21\u63d0\u95ee\uff09\uff0c\u66f4\u65b0\u53ef\u80fd\u4f1a\u5bf9\u540c\u4e00\u8f6e\u540e\u7eed\u7684\u8bf7\u6c42\u751f\u6548\u3002\u82e5\u9700\u8981\u201c\u6bcf\u6b21\u8c03\u7528\u5185\u4fdd\u6301\u7a33\u5b9a\u201d\uff0c\u53ef\u5728\u8c03\u7528\u5f00\u59cb\u65f6\u786e\u5b9a\u6216\u51bb\u7ed3\u63d0\u793a\u8bcd\u3002</li> <li>\u4e2a\u6027\u5316\u4e0a\u4e0b\u6587\uff1a\u82e5\u9700\u6309\u7528\u6237/\u4f1a\u8bdd\u52a8\u6001\u6ce8\u5165\u5185\u5bb9\uff0c\u4f18\u5148\u4f7f\u7528\u6307\u4ee4\u4e2d\u7684\u5360\u4f4d\u7b26\u52a0\u4f1a\u8bdd\u72b6\u6001\u6ce8\u5165\uff08\u89c1\u4e0a\u6587\u201c\u5360\u4f4d\u7b26\u53d8\u91cf\u201d\u4e00\u8282\uff09\u3002</li> </ul>"},{"location":"zh/agent/#system-prompt","title":"\u53e6\u4e00\u79cd\u65b9\u5f0f\uff1a\u7528\u5360\u4f4d\u7b26\u9a71\u52a8\u52a8\u6001 System Prompt","text":"<p>\u5982\u679c\u4e0d\u60f3\u5728\u8fd0\u884c\u65f6\u8c03\u7528 setter\uff0c\u4e5f\u53ef\u4ee5\u628a Instruction \u5199\u6210\u6a21\u677f\uff0c\u7136\u540e\u7528\u4f1a\u8bdd\u72b6\u6001\uff08Session/App/User/Temp\uff09\u6765\u201c\u5582\u201d\u503c\u3002\u6307\u4ee4\u5904\u7406\u5668\u4f1a\u5728\u6bcf\u6b21\u8bf7\u6c42\u65f6\u6ce8\u5165\u5360\u4f4d\u7b26\u3002</p> <p>\u6a21\u5f0f</p> <ul> <li>\u6301\u4e45\u5316\u201c\u6309\u7528\u6237\u201d\uff1a\u5199\u5230 <code>user:*</code>\uff0c\u5728\u6a21\u677f\u91cc\u7528 <code>{user:key}</code> \u5f15\u7528</li> <li>\u6301\u4e45\u5316\u201c\u6309\u5e94\u7528\u201d\uff1a\u5199\u5230 <code>app:*</code>\uff0c\u5728\u6a21\u677f\u91cc\u7528 <code>{app:key}</code> \u5f15\u7528</li> <li>\u6bcf\u8f6e\u4e00\u6b21\uff08\u4e34\u65f6\uff09\uff1a\u5199\u5165\u4f1a\u8bdd\u7684 <code>temp:*</code> \u547d\u540d\u7a7a\u95f4\uff0c\u6a21\u677f\u7528 <code>{temp:key}</code>\uff08\u4e0d\u4f1a\u6301\u4e45\u5316\uff09</li> </ul> <p>\u793a\u4f8b\uff1a\u6309\u7528\u6237\u52a8\u6001\u63d0\u793a\u8bcd</p> <pre><code>import (\n    \"context\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/agent/llmagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/runner\"\n    \"trpc.group/trpc-go/trpc-agent-go/session\"\n    \"trpc.group/trpc-go/trpc-agent-go/session/inmemory\"\n)\n\nsvc := inmemory.NewSessionService()\napp, user, sid := \"my-app\", \"u1\", \"s1\"\n\n// 1\uff09\u5728\u6307\u4ee4\u6a21\u677f\u91cc\u5f15\u7528\u7528\u6237\u6001 key\nllm := llmagent.New(\n  \"dyn-agent\",\n  llmagent.WithInstruction(\"{user:system_prompt}\"),\n)\nrun := runner.NewRunner(app, llm, runner.WithSessionService(svc))\n\n// 2\uff09\u5f53\u7528\u6237\u5728\u540e\u53f0\u6539\u8bbe\u7f6e\u65f6\uff0c\u66f4\u65b0\u7528\u6237\u6001\u72b6\u6001\n_ = svc.UpdateUserState(context.Background(), session.UserKey{AppName: app, UserID: user}, session.StateMap{\n  \"system_prompt\": []byte(\"You are a helpful assistant. Always answer in English.\"),\n})\n\n// 3\uff09\u540e\u7eed\u8fd0\u884c\u4f1a\u901a\u8fc7\u5360\u4f4d\u7b26\u8bfb\u53d6\u6700\u65b0\u503c\n_, _ = run.Run(context.Background(), user, sid, model.NewUserMessage(\"Hi!\"))\n</code></pre> <p>\u793a\u4f8b\uff1a\u901a\u8fc7\u524d\u7f6e\u56de\u8c03\u6ce8\u5165\u672c\u8f6e\u4e34\u65f6\u503c\uff08temp\uff09</p> <p>\u7248\u672c\u8981\u6c42 \u7ed3\u6784\u5316\u56de\u8c03 API\uff08\u63a8\u8350\uff09\u9700\u8981 trpc-agent-go &gt;= 0.6.0\u3002</p> <pre><code>// \u6ce8\u610f\uff1a\u7ed3\u6784\u5316\u56de\u8c03 API \u9700\u8981 trpc-agent-go &gt;= 0.6.0\ncallbacks := agent.NewCallbacks()\ncallbacks.RegisterBeforeAgent(func(ctx context.Context, args *agent.BeforeAgentArgs) (*agent.BeforeAgentResult, error) {\n  if args.Invocation != nil &amp;&amp; args.Invocation.Session != nil {\n    if args.Invocation.Session.State == nil {\n      args.Invocation.Session.State = make(map[string][]byte)\n    }\n    // \u4e3a\"\u672c\u8f6e\"\u4e34\u65f6\u6307\u5b9a\u6307\u4ee4\n    args.Invocation.Session.State[\"temp:sys\"] = []byte(\"Translate to French.\")\n  }\n  return nil, nil\n})\n\nllm := llmagent.New(\n  \"temp-agent\",\n  llmagent.WithInstruction(\"{temp:sys}\"),\n  llmagent.WithAgentCallbacks(callbacks), // \u9700\u8981 trpc-agent-go &gt;= 0.6.0\n)\n</code></pre> <p>\u6ce8\u610f\u4e8b\u9879</p> <ul> <li>\u5185\u5b58\u7248 <code>UpdateUserState</code> \u51fa\u4e8e\u5b89\u5168\u8bbe\u8ba1\u7981\u6b62\u5199 <code>temp:*</code>\uff1b\u9700\u8981\u4e34\u65f6\u503c\u65f6\uff0c\u76f4\u63a5\u5f80 <code>invocation.Session.State</code> \u5199\uff08\u4f8b\u5982\u901a\u8fc7\u56de\u8c03\uff09\u3002</li> <li>\u5360\u4f4d\u7b26\u662f\u5728\u201c\u8bf7\u6c42\u65f6\u201d\u89e3\u6790\uff1b\u53ea\u8981\u4f60\u6362\u4e86\u5b58\u50a8\u7684\u503c\uff0c\u4e0b\u4e00\u6b21\u6a21\u578b\u8bf7\u6c42\u5c31\u4f1a\u7528\u65b0\u503c\uff0c\u65e0\u9700\u91cd\u5efa Agent\u3002</li> </ul>"},{"location":"zh/agui/","title":"AG-UI \u4f7f\u7528\u6307\u5357","text":"<p>AG-UI\uff08Agent-User Interaction\uff09\u534f\u8bae\u7531\u5f00\u6e90\u793e\u533a AG-UI Protocol \u7ef4\u62a4\uff0c\u65e8\u5728\u8ba9\u4e0d\u540c\u8bed\u8a00\u3001\u4e0d\u540c\u6846\u67b6\u3001\u4e0d\u540c\u6267\u884c\u73af\u5883\u7684 Agent\uff0c\u90fd\u80fd\u591f\u901a\u8fc7\u7edf\u4e00\u7684\u4e8b\u4ef6\u6d41\u628a\u6267\u884c\u8fc7\u7a0b\u4e2d\u4ea7\u751f\u7684\u5185\u5bb9\u4f20\u9012\u7ed9\u7528\u6237\u754c\u9762\uff0c\u5141\u8bb8\u677e\u6563\u7684\u4e8b\u4ef6\u683c\u5f0f\u5339\u914d\uff0c\u652f\u6301 SSE \u548c WebSocket \u7b49\u591a\u79cd\u901a\u4fe1\u534f\u8bae\u3002</p> <p><code>tRPC-Agent-Go</code> \u63a5\u5165\u4e86 AG-UI \u534f\u8bae\uff0c\u9ed8\u8ba4\u63d0\u4f9b SSE \u670d\u52a1\u7aef\u5b9e\u73b0\uff0c\u4e5f\u652f\u6301\u901a\u8fc7\u81ea\u5b9a\u4e49 <code>service.Service</code> \u5207\u6362\u5230 WebSocket \u7b49\u901a\u4fe1\u534f\u8bae\uff0c\u5e76\u6269\u5c55\u4e8b\u4ef6\u7ffb\u8bd1\u903b\u8f91\u3002</p>"},{"location":"zh/agui/#_1","title":"\u5feb\u901f\u4e0a\u624b","text":"<p>\u5047\u8bbe\u4f60\u5df2\u5b9e\u73b0\u4e00\u4e2a Agent\uff0c\u53ef\u4ee5\u6309\u5982\u4e0b\u65b9\u5f0f\u63a5\u5165 AG-UI \u534f\u8bae\u5e76\u542f\u52a8\u670d\u52a1\uff1a</p> <pre><code>import (\n    \"net/http\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/runner\"\n    \"trpc.group/trpc-go/trpc-agent-go/server/agui\"\n)\n\n// \u521b\u5efa Agent\nagent := newAgent()\n// \u521b\u5efa Runner\nrunner := runner.NewRunner(agent.Info().Name, agent)\n// \u521b\u5efa AG-UI \u670d\u52a1\uff0c\u6307\u5b9a HTTP \u8def\u7531\nserver, err := agui.New(runner, agui.WithPath(\"/agui\"))\nif err != nil {\n    log.Fatalf(\"create agui server failed: %v\", err)\n}\n// \u542f\u52a8 HTTP \u670d\u52a1\nif err := http.ListenAndServe(\"127.0.0.1:8080\", server.Handler()); err != nil {\n    log.Fatalf(\"server stopped with error: %v\", err)\n}\n</code></pre> <p>\u6ce8\u610f\uff1a\u82e5\u672a\u663e\u5f0f\u6307\u5b9a <code>WithPath</code>\uff0cAG-UI \u670d\u52a1\u9ed8\u8ba4\u8def\u7531\u4e3a <code>/</code>\u3002</p> <p>\u5b8c\u6574\u4ee3\u7801\u793a\u4f8b\u53c2\u89c1 examples/agui/server/default\u3002</p> <p>Runner \u5168\u9762\u7684\u4f7f\u7528\u65b9\u6cd5\u53c2\u89c1 runner\u3002</p> <p>\u5728\u524d\u7aef\u4fa7\uff0c\u53ef\u4ee5\u914d\u5408 CopilotKit \u7b49\u652f\u6301 AG-UI \u534f\u8bae\u7684\u5ba2\u6237\u7aef\u6846\u67b6\uff0c\u5b83\u63d0\u4f9b React/Next.js \u7ec4\u4ef6\u5e76\u5185\u7f6e SSE \u8ba2\u9605\u80fd\u529b\u3002examples/agui/client/copilotkit \u4f7f\u7528 CopilotKit \u642d\u5efa\u4e86 Web UI \u754c\u9762\uff0c\u901a\u8fc7 AG-UI \u534f\u8bae\u4e0e Agent \u901a\u4fe1\uff0c\u6548\u679c\u5982\u4e0b\u56fe\u6240\u793a\u3002</p> <p></p>"},{"location":"zh/agui/#_2","title":"\u8fdb\u9636\u7528\u6cd5","text":""},{"location":"zh/agui/#_3","title":"\u81ea\u5b9a\u4e49\u901a\u4fe1\u534f\u8bae","text":"<p>AG-UI \u534f\u8bae\u672a\u5f3a\u5236\u89c4\u5b9a\u901a\u4fe1\u534f\u8bae\uff0c\u6846\u67b6\u4f7f\u7528 SSE \u4f5c\u4e3a AG-UI \u7684\u9ed8\u8ba4\u901a\u4fe1\u534f\u8bae\uff0c\u5982\u679c\u5e0c\u671b\u6539\u7528 WebSocket \u7b49\u5176\u4ed6\u534f\u8bae\uff0c\u53ef\u4ee5\u5b9e\u73b0 <code>service.Service</code> \u63a5\u53e3\uff1a</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/runner\"\n    \"trpc.group/trpc-go/trpc-agent-go/server/agui\"\n    aguirunner \"trpc.group/trpc-go/trpc-agent-go/server/agui/runner\"\n    \"trpc.group/trpc-go/trpc-agent-go/server/agui/service\"\n)\n\ntype wsService struct {\n    path    string\n    runner  aguirunner.Runner\n    handler http.Handler\n}\n\nfunc NewWSService(runner aguirunner.Runner, opt ...service.Option) service.Service {\n    opts := service.NewOptions(opt...)\n    s := &amp;wsService{\n        path:   opts.Path,\n        runner: runner,\n    }\n    h := http.NewServeMux()\n    h.HandleFunc(s.path, s.handle)\n    s.handler = h\n    return s\n}\n\nfunc (s *wsService) Handler() http.Handler { /* HTTP Handler */ }\n\nrunner := runner.NewRunner(agent.Info().Name, agent)\nserver, _ := agui.New(runner, agui.WithServiceFactory(NewWSService))\n</code></pre>"},{"location":"zh/agui/#translator","title":"\u81ea\u5b9a\u4e49 Translator","text":"<p>\u9ed8\u8ba4\u7684 <code>translator.New</code> \u4f1a\u628a\u5185\u90e8\u4e8b\u4ef6\u7ffb\u8bd1\u6210\u534f\u8bae\u91cc\u5b9a\u4e49\u7684\u6807\u51c6\u4e8b\u4ef6\u96c6\u3002\u82e5\u60f3\u5728\u4fdd\u7559\u9ed8\u8ba4\u884c\u4e3a\u7684\u57fa\u7840\u4e0a\u8ffd\u52a0\u81ea\u5b9a\u4e49\u4fe1\u606f\uff0c\u53ef\u4ee5\u5b9e\u73b0 <code>translator.Translator</code> \u63a5\u53e3\uff0c\u5e76\u501f\u52a9 AG-UI \u7684 <code>Custom</code> \u4e8b\u4ef6\u7c7b\u578b\u643a\u5e26\u6269\u5c55\u6570\u636e\uff1a</p> <pre><code>import (\n    aguievents \"github.com/ag-ui-protocol/ag-ui/sdks/community/go/pkg/core/events\"\n    \"trpc.group/trpc-go/trpc-agent-go/runner\"\n    \"trpc.group/trpc-go/trpc-agent-go/server/agui\"\n    \"trpc.group/trpc-go/trpc-agent-go/server/agui/adapter\"\n    aguirunner \"trpc.group/trpc-go/trpc-agent-go/server/agui/runner\"\n    \"trpc.group/trpc-go/trpc-agent-go/server/agui/translator\"\n)\n\ntype customTranslator struct {\n    inner translator.Translator\n}\n\nfunc (t *customTranslator) Translate(ctx context.Context, event *event.Event) ([]aguievents.Event, error) {\n    out, err := t.inner.Translate(event)\n    if err != nil {\n        return nil, err\n    }\n    if payload := buildCustomPayload(event); payload != nil {\n        out = append(out, aguievents.NewCustomEvent(\"trace.metadata\", aguievents.WithValue(payload)))\n    }\n    return out, nil\n}\n\nfunc buildCustomPayload(event *event.Event) map[string]any {\n    if event == nil || event.Response == nil {\n        return nil\n    }\n    return map[string]any{\n        \"object\":    event.Response.Object,\n        \"timestamp\": event.Response.Timestamp,\n    }\n}\n\nfactory := func(ctx context.Context, input *adapter.RunAgentInput) translator.Translator {\n    return &amp;customTranslator{inner: translator.New(input.ThreadID, input.RunID)}\n}\n\nrunner := runner.NewRunner(agent.Info().Name, agent)\nserver, _ := agui.New(runner, agui.WithAGUIRunnerOptions(aguirunner.WithTranslatorFactory(factory)))\n</code></pre> <p>\u4f8b\u5982\uff0c\u5728\u4f7f\u7528 React Planner \u65f6\uff0c\u5982\u679c\u5e0c\u671b\u4e3a\u4e0d\u540c\u6807\u7b7e\u5e94\u7528\u4e0d\u540c\u7684\u81ea\u5b9a\u4e49\u4e8b\u4ef6\uff0c\u53ef\u4ee5\u901a\u8fc7\u5b9e\u73b0\u81ea\u5b9a\u4e49 Translator \u6765\u5b9e\u73b0\uff0c\u6548\u679c\u5982\u4e0b\u56fe\u6240\u793a\u3002</p> <p></p> <p>\u5b8c\u6574\u7684\u4ee3\u7801\u793a\u4f8b\u53ef\u4ee5\u53c2\u8003 examples/agui/server/react\u3002</p>"},{"location":"zh/agui/#useridresolver","title":"\u81ea\u5b9a\u4e49 <code>UserIDResolver</code>","text":"<p>\u9ed8\u8ba4\u6240\u6709\u8bf7\u6c42\u90fd\u4f1a\u5f52\u5230\u56fa\u5b9a\u7684 <code>\"user\"</code> \u7528\u6237 ID\uff0c\u53ef\u4ee5\u901a\u8fc7\u81ea\u5b9a\u4e49 <code>UserIDResolver</code> \u4ece <code>RunAgentInput</code> \u4e2d\u63d0\u53d6 <code>UserID</code>\uff1a</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/runner\"\n    \"trpc.group/trpc-go/trpc-agent-go/server/agui\"\n    \"trpc.group/trpc-go/trpc-agent-go/server/agui/adapter\"\n    aguirunner \"trpc.group/trpc-go/trpc-agent-go/server/agui/runner\"\n)\n\nresolver := func(ctx context.Context, input *adapter.RunAgentInput) (string, error) {\n    if user, ok := input.ForwardedProps[\"userId\"].(string); ok &amp;&amp; user != \"\" {\n        return user, nil\n    }\n    return \"anonymous\", nil\n}\n\nrunner := runner.NewRunner(agent.Info().Name, agent)\nserver, _ := agui.New(runner, agui.WithAGUIRunnerOptions(aguirunner.WithUserIDResolver(resolver)))\n</code></pre>"},{"location":"zh/agui/#runoptionresolver","title":"\u81ea\u5b9a\u4e49 <code>RunOptionResolver</code>","text":"<p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cAG-UI Runner \u4e0d\u4f1a\u4e3a\u5e95\u5c42 <code>runner.Run</code> \u9644\u52a0\u989d\u5916\u7684 <code>agent.RunOption</code>\u3002</p> <p>\u5982\u679c\u5e0c\u671b\u4e3a <code>runner.Run</code> \u8bbe\u7f6e <code>agent.RunOption</code>\uff0c\u53ef\u4ee5\u5b9e\u73b0 <code>RunOptionResolver</code> \u5e76\u901a\u8fc7 <code>aguirunner.WithRunOptionResolver</code> \u6ce8\u5165\uff0c\u4f8b\u5982\u4ece <code>ForwardedProps</code> \u4e2d\u8bfb\u53d6\u6a21\u578b\u540d\u79f0\u548c\u77e5\u8bc6\u8fc7\u6ee4\u6761\u4ef6\u3002</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/agent\"\n    \"trpc.group/trpc-go/trpc-agent-go/runner\"\n    \"trpc.group/trpc-go/trpc-agent-go/server/agui\"\n    \"trpc.group/trpc-go/trpc-agent-go/server/agui/adapter\"\n    aguirunner \"trpc.group/trpc-go/trpc-agent-go/server/agui/runner\"\n)\n\nresolver := func(_ context.Context, input *adapter.RunAgentInput) ([]agent.RunOption, error) {\n    if input == nil {\n        return nil, errors.New(\"empty input\")\n    }\n    if input.ForwardedProps == nil {\n        return nil, nil\n    }\n    opts := make([]agent.RunOption, 0, 2)\n    if modelName, ok := input.ForwardedProps[\"modelName\"].(string); ok &amp;&amp; modelName != \"\" {\n        opts = append(opts, agent.WithModelName(modelName))\n    }\n    if filter, ok := input.ForwardedProps[\"knowledgeFilter\"].(map[string]any); ok {\n        opts = append(opts, agent.WithKnowledgeFilter(filter))\n    }\n    return opts, nil\n}\n\nrunner := runner.NewRunner(agent.Info().Name, agent)\nserver, _ := agui.New(runner, agui.WithAGUIRunnerOptions(aguirunner.WithRunOptionResolver(resolver)))\n</code></pre> <p><code>RunOptionResolver</code> \u4f1a\u5728\u6bcf\u6b21 <code>RunAgentInput</code> \u88ab\u5904\u7406\u65f6\u6267\u884c\uff0c\u8fd4\u56de\u7684 <code>RunOption</code> \u5217\u8868\u4f1a\u4f9d\u6b21\u4f20\u5165\u5e95\u5c42 <code>runner.Run</code>\u3002</p> <p>\u82e5\u8fd4\u56de\u9519\u8bef\uff0c\u5219\u4f1a\u53d1\u9001 <code>RunError</code> \u4e8b\u4ef6\uff1b\u8fd4\u56de <code>nil</code> \u5219\u8868\u793a\u4e0d\u8ffd\u52a0\u4efb\u4f55 <code>RunOption</code>\u3002</p>"},{"location":"zh/agui/#_4","title":"\u53ef\u89c2\u6d4b\u5e73\u53f0\u4e0a\u62a5","text":"<p>AG-UI Runner \u63d0\u4f9b <code>WithStartSpan</code>\uff0c\u7528\u4e8e\u5728\u6bcf\u6b21 run \u5f00\u59cb\u65f6\u7edf\u4e00\u521b\u5efa\u8ffd\u8e2a span \u5e76\u5199\u5165\u8bf7\u6c42\u76f8\u5173\u5c5e\u6027\u3002</p> <pre><code>import (\n    \"go.opentelemetry.io/otel/attribute\"\n    \"go.opentelemetry.io/otel/trace\"\n    \"trpc.group/trpc-go/trpc-agent-go/server/agui\"\n    aguirunner \"trpc.group/trpc-go/trpc-agent-go/server/agui/runner\"\n    \"trpc.group/trpc-go/trpc-agent-go/server/agui/adapter\"\n    \"trpc.group/trpc-go/trpc-agent-go/runner\"\n    atrace \"trpc.group/trpc-go/trpc-agent-go/telemetry/trace\"\n)\n\n// \u81ea\u5b9a\u4e49 StartSpan\uff0c\u8bbe\u7f6e threadId/userId/input \u7b49\u5c5e\u6027\nfunc startSpan(ctx context.Context, input *adapter.RunAgentInput) (context.Context, trace.Span, error) {\n    userID, err := userIDResolver(ctx, input)\n    if err != nil {\n        return nil, nil, err\n    }\n    attrs := []attribute.KeyValue{\n        attribute.String(\"session.id\", input.ThreadID),\n        attribute.String(\"user.id\", userID),\n        attribute.String(\"trace.input\", input.Messages[len(input.Messages)-1].Content),\n    }\n    ctx, span := atrace.Tracer.Start(ctx, \"agui-run\", trace.WithAttributes(attrs...))\n    return ctx, span, nil\n}\n\nfunc userIDResolver(ctx context.Context, input *adapter.RunAgentInput) (string, error) {\n    if user, ok := input.ForwardedProps[\"userId\"].(string); ok &amp;&amp; user != \"\" {\n        return user, nil\n    }\n    return \"anonymous\", nil\n}\n\nr := runner.NewRunner(agent.Info().Name, agent)\nserver, err := agui.New(r,\n    agui.WithAGUIRunnerOptions(\n        aguirunner.WithUserIDResolver(userIDResolver),\n        aguirunner.WithStartSpan(startSpan),\n    ),\n)\n</code></pre> <p>\u914d\u5408\u4e8b\u4ef6\u7ffb\u8bd1\u56de\u8c03 <code>AfterTranslate</code>\uff0c\u53ef\u5728\u7d2f\u79ef\u8f93\u51fa\u5e76\u5199\u5165 <code>trace.output</code>\u3002\u8fd9\u6837\u524d\u7aef\u6d41\u5f0f\u4e8b\u4ef6\u4e0e\u540e\u7aef trace \u5bf9\u9f50\uff0c\u4fbf\u4e8e\u5728\u53ef\u89c2\u6d4b\u5e73\u53f0\u4e2d\u540c\u65f6\u67e5\u770b\u8f93\u5165\u548c\u6700\u7ec8\u8f93\u51fa\u3002 </p> <p>\u4e0e Langfuse \u53ef\u89c2\u6d4b\u5e73\u53f0\u7684\u7ed3\u5408\u793a\u4f8b\u53ef\u53c2\u8003 examples/agui/server/langfuse\u3002</p>"},{"location":"zh/agui/#_5","title":"\u4e8b\u4ef6\u7ffb\u8bd1\u56de\u8c03","text":"<p>AG-UI \u63d0\u4f9b\u4e86\u4e8b\u4ef6\u7ffb\u8bd1\u7684\u56de\u8c03\u673a\u5236\uff0c\u4fbf\u4e8e\u5728\u4e8b\u4ef6\u7ffb\u8bd1\u6d41\u7a0b\u7684\u524d\u540e\u63d2\u5165\u81ea\u5b9a\u4e49\u903b\u8f91\u3002</p> <ul> <li><code>translator.BeforeTranslateCallback</code>\uff1a\u5728\u5185\u90e8\u4e8b\u4ef6\u88ab\u7ffb\u8bd1\u4e3a AG-UI \u4e8b\u4ef6\u4e4b\u524d\u89e6\u53d1\u3002\u8fd4\u56de\u503c\u7ea6\u5b9a\uff1a<ul> <li>\u8fd4\u56de <code>(customEvent, nil)</code>\uff1a\u4f7f\u7528 <code>customEvent</code> \u4f5c\u4e3a\u7ffb\u8bd1\u7684\u8f93\u5165\u4e8b\u4ef6\u3002</li> <li>\u8fd4\u56de <code>(nil, nil)</code>\uff1a\u4fdd\u7559\u5f53\u524d\u4e8b\u4ef6\u5e76\u7ee7\u7eed\u6267\u884c\u540e\u7eed\u56de\u8c03\uff1b\u82e5\u6240\u6709\u56de\u8c03\u90fd\u8fd4\u56de <code>nil</code>\uff0c\u5219\u6700\u7ec8\u4f7f\u7528\u539f\u4e8b\u4ef6\u3002</li> <li>\u8fd4\u56de\u9519\u8bef\uff1a\u7ec8\u6b62\u5f53\u524d\u7684\u6267\u884c\u6d41\u7a0b\uff0c\u5ba2\u6237\u7aef\u5c06\u63a5\u6536\u5230 <code>RunError</code>\u3002</li> </ul> </li> <li><code>translator.AfterTranslateCallback</code>\uff1a\u5728 AG-UI \u4e8b\u4ef6\u7ffb\u8bd1\u5b8c\u6210\uff0c\u51c6\u5907\u53d1\u9001\u5230\u5ba2\u6237\u7aef\u4e4b\u524d\u89e6\u53d1\u3002\u8fd4\u56de\u503c\u7ea6\u5b9a\uff1a<ul> <li>\u8fd4\u56de <code>(customEvent, nil)</code>\uff1a\u4f7f\u7528 <code>customEvent</code> \u4f5c\u4e3a\u6700\u7ec8\u53d1\u9001\u7ed9\u5ba2\u6237\u7aef\u7684\u4e8b\u4ef6\u3002</li> <li>\u8fd4\u56de <code>(nil, nil)</code>\uff1a\u4fdd\u7559\u5f53\u524d\u4e8b\u4ef6\u5e76\u7ee7\u7eed\u6267\u884c\u540e\u7eed\u56de\u8c03\uff1b\u82e5\u6240\u6709\u56de\u8c03\u90fd\u8fd4\u56de <code>nil</code>\uff0c\u5219\u6700\u7ec8\u53d1\u9001\u539f\u4e8b\u4ef6\u3002</li> <li>\u8fd4\u56de\u9519\u8bef\uff1a\u7ec8\u6b62\u5f53\u524d\u7684\u6267\u884c\u6d41\u7a0b\uff0c\u5ba2\u6237\u7aef\u5c06\u63a5\u6536\u5230 <code>RunError</code>\u3002</li> </ul> </li> </ul> <p>\u4f7f\u7528\u793a\u4f8b\uff1a</p> <pre><code>import (\n    aguievents \"github.com/ag-ui-protocol/ag-ui/sdks/community/go/pkg/core/events\"\n    \"trpc.group/trpc-go/trpc-agent-go/event\"\n    \"trpc.group/trpc-go/trpc-agent-go/server/agui\"\n    aguirunner \"trpc.group/trpc-go/trpc-agent-go/server/agui/runner\"\n    \"trpc.group/trpc-go/trpc-agent-go/server/agui/translator\"\n)\n\ncallbacks := translator.NewCallbacks().\n    RegisterBeforeTranslate(func(ctx context.Context, event *event.Event) (*event.Event, error) {\n        // \u5728\u4e8b\u4ef6\u7ffb\u8bd1\u524d\u6267\u884c\u7684\u903b\u8f91\n        return nil, nil\n    }).\n    RegisterAfterTranslate(func(ctx context.Context, event aguievents.Event) (aguievents.Event, error) {\n        // \u5728\u4e8b\u4ef6\u7ffb\u8bd1\u540e\u6267\u884c\u7684\u903b\u8f91\n        if msg, ok := event.(*aguievents.TextMessageContentEvent); ok {\n            // \u5728\u4e8b\u4ef6\u4e2d\u4fee\u6539\u6d88\u606f\u5185\u5bb9\n            return aguievents.NewTextMessageContentEvent(msg.MessageID, msg.Delta+\" [via callback]\"), nil\n        }\n        return nil, nil\n    })\n\nserver, err := agui.New(runner, agui.WithAGUIRunnerOptions(aguirunner.WithTranslateCallbacks(callbacks)))\n</code></pre> <p>\u4e8b\u4ef6\u7ffb\u8bd1\u56de\u8c03\u53ef\u4ee5\u7528\u4e8e\u591a\u79cd\u573a\u666f\uff0c\u6bd4\u5982\uff1a</p> <ul> <li>\u81ea\u5b9a\u4e49\u4e8b\u4ef6\u5904\u7406\uff1a\u5728\u4e8b\u4ef6\u7ffb\u8bd1\u8fc7\u7a0b\u4e2d\u4fee\u6539\u4e8b\u4ef6\u6570\u636e\uff0c\u6dfb\u52a0\u989d\u5916\u7684\u4e1a\u52a1\u903b\u8f91\u3002</li> <li>\u76d1\u63a7\u4e0a\u62a5\uff1a\u5728\u7ffb\u8bd1\u524d\u540e\u63d2\u5165\u76d1\u63a7\u4e0a\u62a5\u903b\u8f91\uff0c\u4e0e Langfuse \u53ef\u89c2\u6d4b\u5e73\u53f0\u7684\u7ed3\u5408\u793a\u4f8b\u53ef\u53c2\u8003 examples/agui/server/langfuse\u3002</li> </ul>"},{"location":"zh/agui/#runagentinput-hook","title":"RunAgentInput Hook","text":"<p>\u53ef\u4ee5\u4f7f\u7528 <code>WithRunAgentInputHook</code> \u5bf9 AG-UI \u8bf7\u6c42\u4f53\u8fdb\u884c\u7edf\u4e00\u6539\u5199\uff0c\u793a\u4f8b\u4e2d\u6f14\u793a\u4e86\u5982\u4f55\u4ece <code>ForwardedProps</code> \u8bfb\u53d6\u63d0\u793a\u8bcd\u5e76\u5408\u5e76\u5230\u6700\u540e\u4e00\u6761\u7528\u6237\u6d88\u606f\u4e2d\uff1a</p> <p><pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/runner\"\n    \"trpc.group/trpc-go/trpc-agent-go/server/agui\"\n    \"trpc.group/trpc-go/trpc-agent-go/server/agui/adapter\"\n    aguirunner \"trpc.group/trpc-go/trpc-agent-go/server/agui/runner\"\n)\n\nhook := func(ctx context.Context, input *adapter.RunAgentInput) (*adapter.RunAgentInput, error) {\n    if input == nil {\n        return nil, errors.New(\"empty input\")\n    }\n    if len(input.Messages) == 0 {\n        return nil, errors.New(\"missing messages\")\n    }\n    if input.ForwardedProps == nil {\n        return input, nil\n    }\n    otherContent, ok := input.ForwardedProps[\"other_content\"].(string)\n    if !ok {\n        return input, nil\n    }\n\n    input.Messages[len(input.Messages)-1].Content += otherContent\n    return input, nil\n}\n\nrunner := runner.NewRunner(agent.Info().Name, agent)\nserver, _ := agui.New(runner, agui.WithAGUIRunnerOptions(aguirunner.WithRunAgentInputHook(hook)))\n</code></pre> \u8981\u70b9\uff1a</p> <ul> <li>\u8fd4\u56de <code>nil</code> \u4f1a\u4fdd\u7559\u539f\u59cb\u8f93\u5165\uff0c\u4f46\u4fdd\u7559\u539f\u4f4d\u4fee\u6539\u3002</li> <li>\u8fd4\u56de\u81ea\u5b9a\u4e49\u7684 <code>*adapter.RunAgentInput</code> \u4f1a\u8986\u76d6\u539f\u59cb\u8f93\u5165\uff1b\u8fd4\u56de <code>nil</code> \u8868\u793a\u4f7f\u7528\u539f\u8f93\u5165\u3002</li> <li>\u8fd4\u56de\u9519\u8bef\u4f1a\u4e2d\u6b62\u672c\u6b21\u8bf7\u6c42\uff0c\u5ba2\u6237\u7aef\u4f1a\u6536\u5230 <code>RunError</code> \u4e8b\u4ef6\u3002</li> </ul>"},{"location":"zh/agui/#session","title":"Session \u5b58\u50a8\u4e0e\u4e8b\u4ef6\u805a\u5408","text":"<p>\u5728\u6784\u9020 AG-UI Runner \u65f6\u4f20\u5165 <code>SessionService</code>\uff0c\u5b9e\u65f6\u5bf9\u8bdd\u4ea7\u751f\u7684\u4e8b\u4ef6\u4f1a\u901a\u8fc7 <code>SessionService</code> \u5199\u5165\u4f1a\u8bdd\uff0c\u4fbf\u4e8e\u540e\u7eed\u901a\u8fc7 <code>MessagesSnapshot</code> \u56de\u653e\u5386\u53f2\u8bb0\u5f55\u3002</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/runner\"\n    \"trpc.group/trpc-go/trpc-agent-go/server/agui\"\n    aguirunner \"trpc.group/trpc-go/trpc-agent-go/server/agui/runner\"\n    \"trpc.group/trpc-go/trpc-agent-go/session/inmemory\"\n)\n\nrunner := runner.NewRunner(agent.Info().Name, agent)\nsessionService := inmemory.NewSessionService()\n\nserver, err := agui.New(\n    runner,\n    agui.WithPath(\"/agui\"),\n    agui.WithMessagesSnapshotPath(\"/history\"),\n    agui.WithMessagesSnapshotEnabled(true),\n    agui.WithAppName(appName),\n    agui.WithSessionService(sessionService),\n    agui.WithAGUIRunnerOptions(aguirunner.WithUserIDResolver(userIDResolver)),\n)\n</code></pre> <p>\u5728\u6d41\u5f0f\u54cd\u5e94\u573a\u666f\u4e0b\uff0c\u540c\u4e00\u6761\u56de\u590d\u901a\u5e38\u4f1a\u5305\u542b\u591a\u4e2a\u589e\u91cf\u6587\u672c\u4e8b\u4ef6\uff0c\u5982\u679c\u5c06\u5b83\u4eec\u5168\u90e8\u76f4\u63a5\u5199\u5165\u4f1a\u8bdd\uff0c\u4f1a\u7ed9 <code>SessionService</code> \u5e26\u6765\u8f83\u5927\u538b\u529b\u3002</p> <p>\u4e3a\u4e86\u89e3\u51b3\u4e0a\u8ff0\u95ee\u9898\uff0c\u6846\u67b6\u4f1a\u5148\u5bf9\u4e8b\u4ef6\u8fdb\u884c\u805a\u5408\uff0c\u518d\u5199\u5165\u4f1a\u8bdd\u3002\u6b64\u5916\uff0c\u9ed8\u8ba4\u6bcf\u79d2\u5b9a\u65f6\u5237\u65b0\u4e00\u6b21\uff0c\u6bcf\u6b21\u5237\u65b0\u5c06\u5f53\u524d\u7684\u805a\u5408\u7ed3\u679c\u5199\u5165\u4f1a\u8bdd\u3002</p> <ul> <li><code>aggregator.WithEnabled(true)</code> \u7528\u4e8e\u63a7\u5236\u662f\u5426\u5f00\u542f\u4e8b\u4ef6\u805a\u5408\uff0c\u9ed8\u8ba4\u4e3a\u5f00\u542f\u72b6\u6001\u3002\u5f00\u542f\u540e\uff0c\u4f1a\u5c06\u8fde\u7eed\u4e14\u5177\u6709\u76f8\u540c <code>messageId</code> \u7684\u6587\u672c\u4e8b\u4ef6\u8fdb\u884c\u805a\u5408\uff1b\u5173\u95ed\u65f6\u5219\u4e0d\u5bf9 AG-UI \u4e8b\u4ef6\u505a\u805a\u5408\u3002</li> <li><code>aguirunner.WithFlushInterval(time.Second)</code> \u7528\u4e8e\u63a7\u5236\u4e8b\u4ef6\u805a\u5408\u7ed3\u679c\u7684\u5b9a\u65f6\u5237\u65b0\u95f4\u9694\uff0c\u9ed8\u8ba4\u4e3a 1 \u79d2\u3002\u8bbe\u7f6e\u4e3a 0 \u65f6\u8868\u793a\u4e0d\u5f00\u542f\u5b9a\u65f6\u5237\u65b0\u529f\u80fd\u3002</li> </ul> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/runner\"\n    \"trpc.group/trpc-go/trpc-agent-go/server/agui\"\n    \"trpc.group/trpc-go/trpc-agent-go/server/agui/aggregator\"\n    aguirunner \"trpc.group/trpc-go/trpc-agent-go/server/agui/runner\"\n    \"trpc.group/trpc-go/trpc-agent-go/session/inmemory\"\n)\n\nrunner := runner.NewRunner(agent.Info().Name, agent)\nsessionService := inmemory.NewSessionService()\n\nserver, err := agui.New(\n    runner,\n    agui.WithPath(\"/agui\"),\n    agui.WithMessagesSnapshotPath(\"/history\"),\n    agui.WithMessagesSnapshotEnabled(true),\n    agui.WithAppName(appName),\n    agui.WithSessionService(sessionService),\n    agui.WithAGUIRunnerOptions(\n        aguirunner.WithUserIDResolver(userIDResolver),\n        aguirunner.WithAggregationOption(aggregator.WithEnabled(true)), // \u5f00\u542f\u4e8b\u4ef6\u805a\u5408\uff0c\u9ed8\u8ba4\u5f00\u542f\n        aguirunner.WithFlushInterval(time.Second),                      // \u8bbe\u7f6e\u4e8b\u4ef6\u805a\u5408\u7ed3\u679c\u7684\u5b9a\u65f6\u5237\u65b0\u95f4\u9694\uff0c\u9ed8\u8ba4 1 \u79d2\n    ),\n)\n</code></pre> <p>\u5982\u679c\u9700\u8981\u66f4\u590d\u6742\u7684\u805a\u5408\u7b56\u7565\uff0c\u53ef\u4ee5\u5b9e\u73b0 <code>aggregator.Aggregator</code> \u5e76\u901a\u8fc7\u81ea\u5b9a\u4e49\u5de5\u5382\u6ce8\u5165\u3002\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u867d\u7136\u6bcf\u4e2a\u4f1a\u8bdd\u90fd\u4f1a\u5355\u72ec\u521b\u5efa\u4e00\u4e2a\u805a\u5408\u5668\uff0c\u7701\u53bb\u4e86\u8de8\u4f1a\u8bdd\u7684\u72b6\u6001\u7ef4\u62a4\u548c\u5e76\u53d1\u5904\u7406\uff0c\u4f46\u805a\u5408\u65b9\u6cd5\u672c\u8eab\u4ecd\u6709\u53ef\u80fd\u88ab\u5e76\u53d1\u8c03\u7528\uff0c\u56e0\u6b64\u4ecd\u9700\u59a5\u5584\u5904\u7406\u5e76\u53d1\u3002</p> <p>\u4f8b\u5982\uff0c\u5728\u517c\u5bb9\u9ed8\u8ba4\u6587\u672c\u805a\u5408\u7684\u540c\u65f6\uff0c\u5c06\u7c7b\u578b\u4e3a <code>\"think\"</code> \u7684\u81ea\u5b9a\u4e49\u4e8b\u4ef6\u5185\u5bb9\u7d2f\u8ba1\u540e\u518d\u843d\u5e93\u3002</p> <p>\u5b8c\u6574\u793a\u4f8b\u4ee3\u7801\u53ef\u89c1 examples/agui/server/thinkaggregator</p> <pre><code>import (\n    aguievents \"github.com/ag-ui-protocol/ag-ui/sdks/community/go/pkg/core/events\"\n    \"trpc.group/trpc-go/trpc-agent-go/runner\"\n    \"trpc.group/trpc-go/trpc-agent-go/server/agui\"\n    \"trpc.group/trpc-go/trpc-agent-go/server/agui/aggregator\"\n    aguirunner \"trpc.group/trpc-go/trpc-agent-go/server/agui/runner\"\n    \"trpc.group/trpc-go/trpc-agent-go/session/inmemory\"\n)\n\ntype thinkAggregator struct {\n    mu    sync.Mutex\n    inner aggregator.Aggregator\n    think strings.Builder\n}\n\nfunc newAggregator(ctx context.Context, opt ...aggregator.Option) aggregator.Aggregator {\n    return &amp;thinkAggregator{inner: aggregator.New(ctx, opt...)}\n}\n\n\nfunc (c *thinkAggregator) Append(ctx context.Context, event aguievents.Event) ([]aguievents.Event, error) {\n    // \u901a\u8fc7\u4e92\u65a5\u9501\u4fdd\u8bc1\u5185\u90e8\u805a\u5408\u5668\u548c think \u7f13\u51b2\u533a\u7684\u5e76\u53d1\u5b89\u5168\uff0c\u907f\u514d\u591a\u4e2a\u4e8b\u4ef6\u5e76\u53d1\u8ffd\u52a0\u65f6\u51fa\u73b0\u7ade\u6001\u6761\u4ef6\u3002\n    c.mu.Lock()\n    defer c.mu.Unlock()\n\n    // \u9488\u5bf9\u81ea\u5b9a\u4e49\u7684 \"think\" \u4e8b\u4ef6\u7c7b\u578b\uff0c\u91c7\u53d6\u201c\u53ea\u7d2f\u8ba1\u4e0d\u7acb\u523b\u4e0b\u53d1\u201d\u7684\u7b56\u7565\uff1a\n    // 1. \u5148\u5f3a\u5236\u5237\u65b0 inner\uff0c\u5c06\u4e4b\u524d\u7d2f\u79ef\u7684\u666e\u901a\u4e8b\u4ef6\u5b8c\u6574\u8f93\u51fa\uff1b\n    // 2. \u5f53\u524d\u7684 think \u5185\u5bb9\u53ea\u7d2f\u52a0\u5230\u7f13\u51b2\u533a\uff0c\u4e0d\u7acb\u5373\u8fd4\u56de\uff1b\n    // \u8fd9\u6837\u53ef\u4ee5\u4fdd\u8bc1 think \u7247\u6bb5\u4e4b\u95f4\u4e0d\u4f1a\u88ab\u666e\u901a\u4e8b\u4ef6\u6253\u65ad\uff0c\u4e14\u4e4b\u524d\u7684\u666e\u901a\u4e8b\u4ef6\u5148\u4e8e\u65b0\u7684\u601d\u8003\u5185\u5bb9\u8f93\u51fa\u3002\n    if custom, ok := event.(*aguievents.CustomEvent); ok &amp;&amp; custom.Name == string(thinkEventTypeContent) {\n        flushed, err := c.inner.Flush(ctx)\n        if err != nil {\n            return nil, err\n        }\n        // \u4ec5\u5728\u503c\u4e3a\u5b57\u7b26\u4e32\u65f6\u53c2\u4e0e\u7d2f\u79ef\uff0c\u907f\u514d\u4e0d\u7b26\u5408\u9884\u671f\u7c7b\u578b\u7684\u6570\u636e\u6c61\u67d3\u7f13\u51b2\u533a\u3002\n        if v, ok := custom.Value.(string); ok {\n            c.think.WriteString(v)\n        }\n        // \u5f53\u524d think \u4e8b\u4ef6\u53ea\u53c2\u4e0e\u5185\u90e8\u7d2f\u79ef\uff0c\u4e0d\u7acb\u523b\u5bf9\u5916\u53ef\u89c1\uff0c\u8fd4\u56de\u7684\u662f\u4e4b\u524d inner \u5df2\u6709\u7684\u805a\u5408\u7ed3\u679c\u3002\n        return flushed, nil\n    }\n\n    // \u975e think \u4e8b\u4ef6\u8d70\u9ed8\u8ba4\u7684 inner \u805a\u5408\u903b\u8f91\uff0c\u4fdd\u8bc1\u539f\u6709\u6587\u672c\u805a\u5408\u884c\u4e3a\u4e0d\u88ab\u7834\u574f\u3002\n    events, err := c.inner.Append(ctx, event)\n    if err != nil {\n        return nil, err\n    }\n\n    // \u82e5\u5c1a\u65e0\u7d2f\u79ef\u7684 think \u5185\u5bb9\uff0c\u76f4\u63a5\u8fd4\u56de inner \u7684\u805a\u5408\u7ed3\u679c\uff0c\u65e0\u9700\u989d\u5916\u5c01\u88c5\u3002\n    if c.think.Len() == 0 {\n        return events, nil\n    }\n\n    // \u82e5\u5b58\u5728\u5df2\u7d2f\u79ef\u7684 think \u5185\u5bb9\uff0c\u5219\u5728\u5f53\u524d\u6279\u6b21\u4e8b\u4ef6\u524d\u63d2\u5165\u4e00\u4e2a\u805a\u5408\u540e\u7684 think \u4e8b\u4ef6\uff1a\n    // 1. \u5c06\u7f13\u51b2\u533a\u5185\u5bb9\u6253\u5305\u6210\u4e00\u4e2a\u6574\u4f53\u7684 CustomEvent\uff1b\n    // 2. \u6e05\u7a7a\u7f13\u51b2\u533a\uff0c\u907f\u514d\u91cd\u590d\u4e0b\u53d1\uff1b\n    // 3. \u5c06\u8be5 think \u4e8b\u4ef6\u653e\u5728\u5f53\u524d events \u4e4b\u524d\uff0c\u4fdd\u6301\u65f6\u95f4\u987a\u5e8f\uff1a\u5148\u8f93\u51fa\u5b8c\u6574\u601d\u8003\uff0c\u518d\u8f93\u51fa\u540e\u7eed\u4e8b\u4ef6\u3002\n    think := aguievents.NewCustomEvent(string(thinkEventTypeContent), aguievents.WithValue(c.think.String()))\n    c.think.Reset()\n\n    out := make([]aguievents.Event, 0, len(events)+1)\n    out = append(out, think)\n    out = append(out, events...)\n    return out, nil\n}\n\nfunc (c *thinkAggregator) Flush(ctx context.Context) ([]aguievents.Event, error) {\n    // Flush \u540c\u6837\u9700\u8981\u4fdd\u8bc1\u5185\u805a\u5408\u5668\u4e0e think \u7f13\u51b2\u7684\u5e76\u53d1\u5b89\u5168\u3002\n    c.mu.Lock()\n    defer c.mu.Unlock()\n\n    // \u5148\u5237\u65b0 inner\uff0c\u786e\u4fdd\u6240\u6709\u666e\u901a\u4e8b\u4ef6\u6309\u7167\u5176\u81ea\u8eab\u7684\u805a\u5408\u7b56\u7565\u8f93\u51fa\u3002\n    events, err := c.inner.Flush(ctx)\n    if err != nil {\n        return nil, err\n    }\n\n    // \u82e5 think \u7f13\u51b2\u533a\u4e2d\u4ecd\u6709\u672a\u8f93\u51fa\u7684\u5185\u5bb9\uff0c\n    // \u5219\u5c06\u5176\u5c01\u88c5\u4e3a\u4e00\u4e2a\u805a\u5408\u540e\u7684 think \u4e8b\u4ef6\u5e76\u63d2\u5165\u5f53\u524d\u6279\u6b21\u7684\u6700\u524d\u9762\uff0c\n    // \u4fdd\u8bc1\u805a\u5408\u540e\u7684\u601d\u8003\u5185\u5bb9\u4e0d\u4f1a\u88ab\u540e\u7eed\u5237\u65b0\u4ea7\u751f\u7684\u4e8b\u4ef6\u6253\u4e71\u987a\u5e8f\u3002\n    if c.think.Len() &gt; 0 {\n        think := aguievents.NewCustomEvent(string(thinkEventTypeContent), aguievents.WithValue(c.think.String()))\n        c.think.Reset()\n        events = append([]aguievents.Event{think}, events...)\n    }\n    return events, nil\n}\n\nrunner := runner.NewRunner(agent.Info().Name, agent)\nsessionService := inmemory.NewSessionService()\n\nserver, err := agui.New(\n    runner,\n    agui.WithPath(\"/agui\"),\n    agui.WithMessagesSnapshotPath(\"/history\"),\n    agui.WithMessagesSnapshotEnabled(true),\n    agui.WithAppName(appName),\n    agui.WithSessionService(sessionService),\n    agui.WithAGUIRunnerOptions(\n        aguirunner.WithUserIDResolver(userIDResolver),\n        aguirunner.WithAggregatorFactory(newAggregator),\n    ),\n)\n</code></pre>"},{"location":"zh/agui/#_6","title":"\u6d88\u606f\u5feb\u7167","text":"<p>\u6d88\u606f\u5feb\u7167\u7528\u4e8e\u5728\u9875\u9762\u521d\u59cb\u5316\u6216\u65ad\u7ebf\u91cd\u8fde\u65f6\u6062\u590d\u5386\u53f2\u5bf9\u8bdd\uff0c\u901a\u8fc7 <code>agui.WithMessagesSnapshotEnabled(true)</code> \u63a7\u5236\u529f\u80fd\u662f\u5426\u5f00\u542f\uff0c\u9ed8\u8ba4\u5173\u95ed\u3002\u542f\u7528\u8be5\u80fd\u529b\u540e\uff0cAG-UI \u4f1a\u540c\u65f6\u63d0\u4f9b\u804a\u5929\u8def\u7531\u548c\u6d88\u606f\u5feb\u7167\u8def\u7531\uff1a</p> <ul> <li>\u804a\u5929\u8def\u7531\u9ed8\u8ba4\u662f <code>/</code>\uff0c\u53ef\u901a\u8fc7 <code>agui.WithPath</code> \u81ea\u5b9a\u4e49\uff1b</li> <li>\u6d88\u606f\u5feb\u7167\u8def\u7531\u9ed8\u8ba4\u662f <code>/history</code>\uff0c \u53ef\u901a\u8fc7 <code>WithMessagesSnapshotPath</code> \u81ea\u5b9a\u4e49\uff0c\u8d1f\u8d23\u8fd4\u56de <code>RUN_STARTED \u2192 MESSAGES_SNAPSHOT \u2192 RUN_FINISHED</code> \u7684\u4e8b\u4ef6\u6d41\u3002</li> </ul> <p>\u542f\u7528\u6d88\u606f\u5feb\u7167\u529f\u80fd\u65f6\u9700\u8981\u914d\u7f6e\u4e0b\u5217\u53c2\u6570\uff1a</p> <ul> <li><code>agui.WithMessagesSnapshotEnabled(true)</code> \u542f\u7528\u6d88\u606f\u5feb\u7167\u529f\u80fd\uff1b</li> <li><code>agui.WithMessagesSnapshotPath</code> \u8bbe\u7f6e\u6d88\u606f\u5feb\u7167\u8def\u7531\u7684\u81ea\u5b9a\u4e49\u8def\u5f84\uff0c\u9ed8\u8ba4\u4e3a <code>/history</code>\uff1b</li> <li><code>agui.WithAppName(name)</code> \u6307\u5b9a\u5e94\u7528\u540d\uff1b</li> <li><code>agui.WithSessionService(service)</code> \u6ce8\u5165 <code>session.Service</code> \u7528\u4e8e\u67e5\u8be2\u5386\u53f2\u4e8b\u4ef6\uff1b</li> <li><code>aguirunner.WithUserIDResolver(resolver)</code> \u81ea\u5b9a\u4e49 <code>userID</code> \u89e3\u6790\u903b\u8f91\uff0c\u9ed8\u8ba4\u6052\u4e3a <code>\"user\"</code>\u3002</li> </ul> <p>\u6846\u67b6\u5728\u5904\u7406\u6d88\u606f\u5feb\u7167\u8bf7\u6c42\u65f6\u4f1a\u4ece AG-UI \u8bf7\u6c42\u4f53 <code>RunAgentInput</code> \u4e2d\u89e3\u6790 <code>threadId</code> \u4f5c\u4e3a <code>SessionID</code>\uff0c\u7ed3\u5408\u81ea\u5b9a\u4e49 <code>UserIDResolver</code> \u5f97\u5230 <code>userID</code>\uff0c\u518d\u4e0e <code>appName</code> \u7ec4\u88c5\u5f97\u5230 <code>session.Key</code>\uff0c\u7136\u540e\u901a\u8fc7 <code>session.Service</code> \u67e5\u8be2 <code>Session</code>\u3002\u5c06 <code>Session</code> \u4e2d\u5b58\u50a8\u7684\u4e8b\u4ef6 <code>Session.Events</code> \u8f6c\u6362\u4e3a AG-UI \u6d88\u606f\u5e76\u5c01\u88c5\u6210 <code>MESSAGES_SNAPSHOT</code> \u4e8b\u4ef6\uff0c\u540c\u65f6\u53d1\u9001\u914d\u5957\u7684 <code>RUN_STARTED</code>\u3001<code>RUN_FINISHED</code> \u4e8b\u4ef6\u3002</p> <p>\u4ee3\u7801\u793a\u4f8b\u5982\u4e0b\uff1a</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/server/agui\"\n    \"trpc.group/trpc-go/trpc-agent-go/server/agui/adapter\"\n    aguirunner \"trpc.group/trpc-go/trpc-agent-go/server/agui/runner\"\n    \"trpc.group/trpc-go/trpc-agent-go/session/inmemory\"\n)\n\nresolver := func(ctx context.Context, input *adapter.RunAgentInput) (string, error) {\n    if user, ok := input.ForwardedProps[\"userId\"].(string); ok &amp;&amp; user != \"\" {\n        return user, nil\n    }\n    return \"anonymous\", nil\n}\n\nsessionService := inmemory.NewService(context.Background())\nserver, err := agui.New(\n    runner,\n    agui.WithPath(\"/chat\"),                    // \u81ea\u5b9a\u4e49\u804a\u5929\u8def\u7531\uff0c\u9ed8\u8ba4\u4e3a \"/\"\n    agui.WithAppName(\"demo-app\"),              // \u8bbe\u7f6e AppName\uff0c\u7528\u4e8e\u6784\u9020 Session Key\n    agui.WithSessionService(sessionService),   // \u8bbe\u7f6e Session Service\uff0c\u7528\u4e8e\u67e5\u8be2 Session\n    agui.WithMessagesSnapshotEnabled(true),    // \u5f00\u542f\u6d88\u606f\u5feb\u7167\u529f\u80fd\n    agui.WithMessagesSnapshotPath(\"/history\"), // \u8bbe\u7f6e\u6d88\u606f\u5feb\u7167\u8def\u7531\uff0c\u9ed8\u8ba4\u4e3a \"/history\"\n    agui.WithAGUIRunnerOptions(\n        aguirunner.WithUserIDResolver(resolver), // \u81ea\u5b9a\u4e49 UserID \u89e3\u6790\u903b\u8f91\n    ),\n)\nif err != nil {\n    log.Fatalf(\"create agui server failed: %v\", err)\n}\nif err := http.ListenAndServe(\"127.0.0.1:8080\", server.Handler()); err != nil {\n    log.Fatalf(\"server stopped with error: %v\", err)\n}\n</code></pre> <p>\u5b8c\u6574\u7684\u793a\u4f8b\u53ef\u53c2\u8003 examples/agui/messagessnapshot\u3002</p> <p>AG-UI \u7684 MessagesSnapshotEvent \u4e8b\u4ef6\u683c\u5f0f\u53ef\u89c1 messages\u3002</p>"},{"location":"zh/agui/#basepath","title":"\u8bbe\u7f6e\u8def\u7531\u524d\u7f00 BasePath","text":"<p><code>agui.WithBasePath</code> \u8bbe\u7f6e AG-UI \u670d\u52a1\u7684\u57fa\u7840\u8def\u7531\u524d\u7f00\uff0c\u9ed8\u8ba4\u503c\u4e3a <code>/</code>\uff0c\u7528\u4e8e\u5728\u7edf\u4e00\u524d\u7f00\u4e0b\u6302\u8f7d\u804a\u5929\u8def\u7531\u4e0e\u6d88\u606f\u5feb\u7167\u8def\u7531\uff0c\u907f\u514d\u4e0e\u73b0\u6709\u670d\u52a1\u51b2\u7a81.</p> <p><code>agui.WithPath</code> \u4e0e <code>agui.WithMessagesSnapshotPath</code> \u4ec5\u5b9a\u4e49\u57fa\u7840\u8def\u5f84\u4e0b\u7684\u5b50\u8def\u7531\uff0c\u6846\u67b6\u4f1a\u901a\u8fc7 <code>url.JoinPath</code> \u5c06\u5b83\u4eec\u4e0e\u57fa\u7840\u8def\u5f84\u62fc\u63a5\u6210\u6700\u7ec8\u53ef\u8bbf\u95ee\u7684\u8def\u7531.</p> <p>\u4f7f\u7528\u793a\u4f8b\u5982\u4e0b\u6240\u793a</p> <pre><code>server, err := agui.New(\n    runner,\n    agui.WithBasePath(\"/agui\"),                // \u8bbe\u7f6e AG-UI \u524d\u7f00\u8def\u7531\n    agui.WithPath(\"/chat\"),                    // \u8bbe\u7f6e\u804a\u5929\u8def\u7531\uff0c\u9ed8\u8ba4\u4e3a \"/\"\n    agui.WithMessagesSnapshotEnabled(true),    // \u5f00\u542f\u6d88\u606f\u5feb\u7167\u529f\u80fd\n    agui.WithMessagesSnapshotPath(\"/history\"), // \u8bbe\u7f6e\u6d88\u606f\u5feb\u7167\u8def\u7531\uff0c\u9ed8\u8ba4\u4e3a \"/history\"\n)\nif err != nil {\n    log.Fatalf(\"create agui server failed: %v\", err)\n}\n</code></pre> <p>\u6b64\u65f6\u804a\u5929\u8def\u7531\u4e3a <code>/agui/chat</code>\uff0c\u7528\u6d88\u606f\u5feb\u7167\u8def\u7531\u4e3a <code>/agui/history</code>\u3002</p>"},{"location":"zh/agui/#_7","title":"\u6700\u4f73\u5b9e\u8df5","text":""},{"location":"zh/agui/#_8","title":"\u751f\u6210\u6587\u6863","text":"<p>\u957f\u7bc7\u6587\u6863\u5982\u679c\u76f4\u63a5\u63d2\u5165\u5230\u5bf9\u8bdd\u6b63\u6587\uff0c\u5f88\u5bb9\u6613\u628a\u4e3b\u5bf9\u8bdd\u201c\u5237\u5c4f\u201d\uff0c\u7528\u6237\u4e5f\u96be\u4ee5\u533a\u5206\u5bf9\u8bdd\u5185\u5bb9\u548c\u6587\u6863\u5185\u5bb9\u3002\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\uff0c\u5efa\u8bae\u4f7f\u7528\u201c\u6587\u6863\u9762\u677f\u201d\u6765\u627f\u8f7d\u957f\u6587\u6863\u3002\u901a\u8fc7 AG-UI \u7684\u4e8b\u4ef6\u6d41\u7ea6\u5b9a\u4e00\u5957\u201c\u6253\u5f00\u6587\u6863\u9762\u677f \u2192 \u5199\u5165\u6587\u6863\u5185\u5bb9 \u2192 \u5173\u95ed\u6587\u6863\u9762\u677f\u201d\u7684\u5de5\u4f5c\u6d41\uff0c\u5c06\u957f\u6587\u6863\u4ece\u5bf9\u8bdd\u4e2d\u201c\u62bd\u79bb\u201d\u51fa\u6765\uff0c\u907f\u514d\u5e72\u6270\u6b63\u5e38\u4ea4\u6d41\uff0c\u793a\u4f8b\u65b9\u6848\u5982\u4e0b\u3002</p> <ol> <li> <p>\u540e\u7aef\uff1a\u5b9a\u4e49\u5de5\u5177\u5e76\u7ea6\u675f\u8c03\u7528\u987a\u5e8f</p> <p>\u4e3a Agent \u63d0\u4f9b\u4e24\u4e2a\u5de5\u5177\uff1a\u6253\u5f00\u6587\u6863\u9762\u677f \u548c \u5173\u95ed\u6587\u6863\u9762\u677f\uff0c\u5e76\u5728 prompt \u4e2d\u7ea6\u675f\u751f\u6210\u987a\u5e8f\uff1a  \u5f53\u8fdb\u5165\u6587\u6863\u751f\u6210\u6d41\u7a0b\u65f6\uff0c\u6309\u4ee5\u4e0b\u987a\u5e8f\u6267\u884c\uff1a</p> <ol> <li>\u5148\u8c03\u7528\u201c\u6253\u5f00\u6587\u6863\u9762\u677f\u201d\u5de5\u5177</li> <li>\u7d27\u63a5\u7740\u8f93\u51fa\u6587\u6863\u5185\u5bb9</li> <li>\u6700\u540e\u8c03\u7528\u201c\u5173\u95ed\u6587\u6863\u9762\u677f\u201d\u5de5\u5177</li> </ol> <p>\u8f6c\u6362\u4e3a AG-UI \u4e8b\u4ef6\u6d41\uff0c\u5927\u81f4\u5f62\u6001\u5982\u4e0b\uff1a</p> <pre><code>\u6253\u5f00\u6587\u6863\u9762\u677f\u5de5\u5177\n  \u2192 ToolCallStart\n  \u2192 ToolCallArgs\n  \u2192 ToolCallEnd\n  \u2192 ToolCallResult\n\n\u6587\u6863\u5185\u5bb9\n  \u2192 TextMessageStart\n  \u2192 TextMessageContent\n  \u2192 TextMessageEnd\n\n\u5173\u95ed\u6587\u6863\u9762\u677f\u5de5\u5177\n  \u2192 ToolCallStart\n  \u2192 ToolCallArgs\n  \u2192 ToolCallEnd\n  \u2192 ToolCallResult\n</code></pre> </li> <li> <p>\u524d\u7aef\uff1a\u76d1\u542c\u5de5\u5177\u4e8b\u4ef6\u5e76\u7ef4\u62a4\u6587\u6863\u9762\u677f</p> <p>\u5728\u524d\u7aef\u76d1\u542c\u4e8b\u4ef6\u6d41\uff1a</p> <ul> <li>\u5f53\u6355\u6349\u5230 <code>open_report_document</code> \u5de5\u5177\u4e8b\u4ef6\u65f6\uff1a\u521b\u5efa\u6587\u6863\u9762\u677f\uff0c\u5e76\u5c06\u5176\u540e\u7684\u6587\u672c\u6d88\u606f\u5185\u5bb9\u5199\u5165\u8be5\u6587\u6863\u9762\u677f\uff1b</li> <li>\u5f53\u6355\u6349\u5230 <code>close_report_document</code> \u5de5\u5177\u4e8b\u4ef6\u65f6\uff1a\u5173\u95ed\u6587\u6863\u9762\u677f\uff08\u6216\u5c06\u5176\u6807\u8bb0\u4e3a\u751f\u6210\u5b8c\u6210\uff09\u3002</li> </ul> </li> </ol> <p>\u5b9e\u9645\u6548\u679c\u5982\u4e0b\u56fe\u6240\u793a\uff0c\u5b8c\u6574\u793a\u4f8b\u53ef\u53c2\u8003 examples/agui/server/report\u3002</p> <p></p>"},{"location":"zh/artifact/","title":"Artifacts","text":"<p>Artifacts\uff08\u5236\u54c1\uff09\u662f trpc-agent-go \u4e2d\u7684\u547d\u540d\u3001\u7248\u672c\u5316\u4e8c\u8fdb\u5236\u6570\u636e\u5bf9\u8c61\uff0c\u53ef\u4ee5\u4e0e\u7528\u6237\u4f1a\u8bdd\u5173\u8054\u6216\u8de8\u4f1a\u8bdd\u6301\u4e45\u5316\u5b58\u50a8\u3002\u5236\u54c1\u7cfb\u7edf\u7531\u4e24\u4e2a\u4e3b\u8981\u7ec4\u4ef6\u7ec4\u6210\uff1a</p> <ol> <li>Artifacts\uff08\u5236\u54c1\uff09\uff1a\u6570\u636e\u5bf9\u8c61\u672c\u8eab - \u5305\u542b\u4e8c\u8fdb\u5236\u5185\u5bb9\u3001\u5143\u6570\u636e\u548c\u7248\u672c\u4fe1\u606f</li> <li>Artifact Service\uff08\u5236\u54c1\u670d\u52a1\uff09\uff1a\u5904\u7406\u4fdd\u5b58\u3001\u68c0\u7d22\u548c\u7ec4\u7ec7\u5236\u54c1\u7684\u5b58\u50a8\u7ba1\u7406\u670d\u52a1</li> </ol> <p>\u8be5\u7cfb\u7edf\u4f7f Agent \u80fd\u591f\u5b58\u50a8\u3001\u68c0\u7d22\u548c\u7ba1\u7406\u5404\u79cd\u7c7b\u578b\u7684\u5185\u5bb9\uff0c\u5305\u62ec\u56fe\u50cf\u3001\u6587\u6863\u3001\u6587\u672c\u6587\u4ef6\u548c\u5176\u4ed6\u4e8c\u8fdb\u5236\u6570\u636e\u3002</p>"},{"location":"zh/artifact/#artifacts_1","title":"\u4ec0\u4e48\u662f Artifacts\uff08\u5236\u54c1\uff09\uff1f","text":"<p>Artifacts\uff08\u5236\u54c1\uff09\u662f\u5305\u542b\u4ee5\u4e0b\u5185\u5bb9\u7684\u6570\u636e\u5bb9\u5668\uff1a</p> <ul> <li>\u4e8c\u8fdb\u5236\u5185\u5bb9\uff08\u56fe\u50cf\u3001\u6587\u6863\u3001\u6587\u4ef6\u7b49\uff09</li> <li>\u5143\u6570\u636e\uff08MIME \u7c7b\u578b\u3001\u540d\u79f0\u3001URL\uff09</li> <li>\u7248\u672c\u4fe1\u606f</li> <li>\u4e0e\u7528\u6237\u548c\u4f1a\u8bdd\u7684\u5173\u8054</li> </ul>"},{"location":"zh/artifact/#artifact-service","title":"\u4ec0\u4e48\u662f Artifact Service\uff08\u5236\u54c1\u670d\u52a1\uff09\uff1f","text":"<p>Artifact Service\uff08\u5236\u54c1\u670d\u52a1\uff09\u662f\u540e\u7aef\u7cfb\u7edf\uff0c\u8d1f\u8d23\uff1a</p> <ul> <li>\u5b58\u50a8\u548c\u68c0\u7d22\u5236\u54c1</li> <li>\u7ba1\u7406\u7248\u672c</li> <li>\u5904\u7406\u547d\u540d\u7a7a\u95f4\u7ec4\u7ec7\uff08\u4f1a\u8bdd\u8303\u56f4 vs \u7528\u6237\u8303\u56f4\uff09</li> <li>\u63d0\u4f9b\u4e0d\u540c\u7684\u5b58\u50a8\u540e\u7aef\uff08\u5185\u5b58\u3001\u4e91\u5b58\u50a8\uff09</li> </ul>"},{"location":"zh/artifact/#_1","title":"\u7cfb\u7edf\u6982\u8ff0","text":"<p>\u5236\u54c1\u7cfb\u7edf\u63d0\u4f9b\uff1a</p> <ul> <li>\u7248\u672c\u5316\u5b58\u50a8\uff1a\u6bcf\u4e2a\u5236\u54c1\u90fd\u4f1a\u81ea\u52a8\u7248\u672c\u5316\uff0c\u5141\u8bb8\u60a8\u8ddf\u8e2a\u968f\u65f6\u95f4\u7684\u53d8\u5316</li> <li>\u57fa\u4e8e\u4f1a\u8bdd\u7684\u7ec4\u7ec7\uff1a\u5236\u54c1\u53ef\u4ee5\u9650\u5b9a\u5728\u7279\u5b9a\u7528\u6237\u4f1a\u8bdd\u8303\u56f4\u5185</li> <li>\u7528\u6237\u6301\u4e45\u5316\u5b58\u50a8\uff1a\u5236\u54c1\u53ef\u4ee5\u4f7f\u7528 <code>user:</code> \u547d\u540d\u7a7a\u95f4\u4e3a\u7528\u6237\u8de8\u4f1a\u8bdd\u6301\u4e45\u5316\u5b58\u50a8</li> <li>\u591a\u79cd\u5b58\u50a8\u540e\u7aef\uff1a\u652f\u6301\u5185\u5b58\u5b58\u50a8\uff08\u5f00\u53d1\u73af\u5883\uff09\u548c\u4e91\u5b58\u50a8\uff08\u751f\u4ea7\u73af\u5883\uff09</li> <li>MIME \u7c7b\u578b\u652f\u6301\uff1a\u4e3a\u4e0d\u540c\u6587\u4ef6\u683c\u5f0f\u63d0\u4f9b\u9002\u5f53\u7684\u5185\u5bb9\u7c7b\u578b\u5904\u7406</li> </ul>"},{"location":"zh/artifact/#_2","title":"\u6838\u5fc3\u7ec4\u4ef6","text":""},{"location":"zh/artifact/#artifact","title":"Artifact \u6570\u636e\u7ed3\u6784","text":"<p>Artifact\uff08\u5236\u54c1\uff09\u662f\u5305\u542b\u60a8\u5185\u5bb9\u7684\u57fa\u672c\u6570\u636e\u5bf9\u8c61\uff1a</p> <pre><code>type Artifact struct {\n    // Data \u5305\u542b\u539f\u59cb\u5b57\u8282\u6570\u636e\uff08\u5fc5\u9700\uff09\n    Data []byte `json:\"data,omitempty\"`\n    // MimeType \u662f IANA \u6807\u51c6 MIME \u7c7b\u578b\uff08\u5fc5\u9700\uff09\n    MimeType string `json:\"mime_type,omitempty\"`\n    // URL \u662f\u53ef\u8bbf\u95ee\u5236\u54c1\u7684\u53ef\u9009 URL\n    URL string `json:\"url,omitempty\"`\n    // Name \u662f\u5236\u54c1\u7684\u53ef\u9009\u663e\u793a\u540d\u79f0\n    Name string `json:\"name,omitempty\"`\n}\n</code></pre>"},{"location":"zh/artifact/#_3","title":"\u4f1a\u8bdd\u4fe1\u606f","text":"<pre><code>type SessionInfo struct {\n    // AppName \u662f\u5e94\u7528\u7a0b\u5e8f\u540d\u79f0\n    AppName string\n    // UserID \u662f\u7528\u6237 ID\n    UserID string\n    // SessionID \u662f\u4f1a\u8bdd ID\n    SessionID string\n}\n</code></pre>"},{"location":"zh/artifact/#artifact-service_1","title":"Artifact Service \u5b58\u50a8\u540e\u7aef","text":"<p>Artifact Service \u63d0\u4f9b\u4e0d\u540c\u7684\u5b58\u50a8\u5b9e\u73b0\u6765\u7ba1\u7406\u5236\u54c1\uff1a</p>"},{"location":"zh/artifact/#_4","title":"\u5185\u5b58\u5b58\u50a8","text":"<p>\u9002\u7528\u4e8e\u5f00\u53d1\u548c\u6d4b\u8bd5\uff1a</p> <pre><code>import \"trpc.group/trpc-go/trpc-agent-go/artifact/inmemory\"\n\nservice := inmemory.NewService()\n</code></pre>"},{"location":"zh/artifact/#cos","title":"\u817e\u8baf\u4e91\u5bf9\u8c61\u5b58\u50a8 (COS)","text":"<p>\u7528\u4e8e\u817e\u8baf\u4e91\u751f\u4ea7\u90e8\u7f72\uff1a</p> <pre><code>import \"trpc.group/trpc-go/trpc-agent-go/artifact/cos\"\n\n// \u8bbe\u7f6e\u73af\u5883\u53d8\u91cf\n// export COS_SECRETID=\"your-secret-id\"\n// export COS_SECRETKEY=\"your-secret-key\"\n\nservice := cos.NewService(\"https://bucket.cos.region.myqcloud.com\")\n</code></pre>"},{"location":"zh/artifact/#s3","title":"S3 \u517c\u5bb9\u5b58\u50a8","text":"<p>S3 \u540e\u7aef\u652f\u6301 AWS S3 \u548c S3 \u517c\u5bb9\u670d\u52a1\uff08MinIO\u3001DigitalOcean Spaces\u3001Cloudflare R2 \u7b49\uff09\u3002</p> <pre><code>import \"trpc.group/trpc-go/trpc-agent-go/artifact/s3\"\n</code></pre>"},{"location":"zh/artifact/#_5","title":"\u4f7f\u7528\u65b9\u6cd5","text":"<pre><code>// \u521b\u5efa\u670d\u52a1\nservice, err := s3.NewService(os.Getenv(\"S3_BUCKET\"))\nif err != nil {\n    log.Fatal(err)\n}\n\n// \u4f7f\u7528\u81ea\u5b9a\u4e49\u7aef\u70b9\uff08\u7528\u4e8e S3 \u517c\u5bb9\u670d\u52a1\uff09\nservice, err := s3.NewService(os.Getenv(\"S3_BUCKET\"),\n    s3.WithEndpoint(os.Getenv(\"S3_ENDPOINT\")),\n    s3.WithCredentials(os.Getenv(\"S3_ACCESS_KEY\"), os.Getenv(\"S3_SECRET_KEY\")),\n    s3.WithPathStyle(),  // MinIO \u548c\u67d0\u4e9b S3 \u517c\u5bb9\u670d\u52a1\u9700\u8981\n)\n</code></pre> <p>\u6ce8\u610f\uff1a\u5728\u4f7f\u7528\u670d\u52a1\u4e4b\u524d\uff0c\u5b58\u50a8\u6876\u5fc5\u987b\u5df2\u5b58\u5728\u3002</p>"},{"location":"zh/artifact/#_6","title":"\u914d\u7f6e\u9009\u9879","text":"\u9009\u9879 \u63cf\u8ff0 \u9ed8\u8ba4\u503c <code>WithEndpoint(url)</code> S3 \u517c\u5bb9\u670d\u52a1\u7684\u81ea\u5b9a\u4e49\u7aef\u70b9\uff08\u4f7f\u7528 <code>http://</code> \u7981\u7528 SSL\uff09 AWS S3 <code>WithRegion(region)</code> AWS \u533a\u57df <code>AWS_REGION</code> \u73af\u5883\u53d8\u91cf\u6216 <code>us-east-1</code> <code>WithCredentials(key, secret)</code> \u9759\u6001\u51ed\u8bc1 AWS \u51ed\u8bc1\u94fe <code>WithSessionToken(token)</code> \u4e34\u65f6\u51ed\u8bc1\u7684 STS \u4f1a\u8bdd\u4ee4\u724c - <code>WithPathStyle()</code> \u4f7f\u7528\u8def\u5f84\u6837\u5f0f URL\uff08MinIO\u3001R2 \u9700\u8981\uff09 \u865a\u62df\u4e3b\u673a\u6837\u5f0f <code>WithRetries(n)</code> \u6700\u5927\u91cd\u8bd5\u6b21\u6570 3"},{"location":"zh/artifact/#_7","title":"\u51ed\u8bc1\u89e3\u6790\u987a\u5e8f","text":"<p>\u5f53\u672a\u901a\u8fc7 <code>WithCredentials()</code> \u63d0\u4f9b\u663e\u5f0f\u51ed\u8bc1\u65f6\uff0cAWS SDK \u6309\u4ee5\u4e0b\u4f18\u5148\u7ea7\u987a\u5e8f\u89e3\u6790\u51ed\u8bc1\uff1a</p> <ol> <li>\u73af\u5883\u53d8\u91cf\uff1a<code>AWS_ACCESS_KEY_ID</code> \u548c <code>AWS_SECRET_ACCESS_KEY</code></li> <li>\u5171\u4eab\u51ed\u8bc1\u6587\u4ef6\uff1a<code>~/.aws/credentials</code>\uff08\u53ef\u9009\u914d\u5408 <code>AWS_PROFILE</code>\uff09</li> <li>IAM \u89d2\u8272\uff1aEC2 \u5b9e\u4f8b\u914d\u7f6e\u6587\u4ef6\u3001ECS \u4efb\u52a1\u89d2\u8272\u3001Lambda \u6267\u884c\u89d2\u8272\u7b49</li> </ol>"},{"location":"zh/artifact/#agent","title":"\u5728 Agent \u4e2d\u7684\u4f7f\u7528","text":""},{"location":"zh/artifact/#artifact-service-runner","title":"\u914d\u7f6e Artifact Service \u4e0e Runner","text":"<pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/artifact/inmemory\"\n    \"trpc.group/trpc-go/trpc-agent-go/runner\"\n)\n\n// \u521b\u5efa\u5236\u54c1\u670d\u52a1\nartifactService := inmemory.NewService()\n\n// \u521b\u5efa\u5e26\u5236\u54c1\u670d\u52a1\u7684 runner\nr := runner.NewRunner(\n    \"my-app\",\n    myAgent,\n    runner.WithArtifactService(artifactService),\n)\n</code></pre>"},{"location":"zh/artifact/#artifacts_2","title":"\u5728\u5de5\u5177\u4e2d\u521b\u5efa\u548c\u7ba1\u7406 Artifacts","text":"<p>\u5de5\u5177\u53ef\u4ee5\u521b\u5efa\u5236\u54c1\u5e76\u901a\u8fc7\u5de5\u5177\u4e0a\u4e0b\u6587\u4f7f\u7528 Artifact Service\uff1a</p> <pre><code>func myTool(ctx context.Context, input MyInput) (MyOutput, error) {\n    // \u83b7\u53d6\u5de5\u5177\u4e0a\u4e0b\u6587\n    toolCtx, err := agent.NewToolContext(ctx)\n    if err != nil {\n        return MyOutput{}, err\n    }\n\n    // \u521b\u5efa\u5236\u54c1\n    artifact := &amp;artifact.Artifact{\n        Data:     []byte(\"\u4f60\u597d\uff0c\u4e16\u754c\uff01\"),\n        MimeType: \"text/plain\",\n        Name:     \"greeting.txt\",\n    }\n\n    // \u4fdd\u5b58\u5236\u54c1\n    version, err := toolCtx.SaveArtifact(\"greeting.txt\", artifact)\n    if err != nil {\n        return MyOutput{}, err\n    }\n\n    // \u7a0d\u540e\u52a0\u8f7d\u5236\u54c1\n    loadedArtifact, err := toolCtx.LoadArtifact(\"greeting.txt\", nil) // nil \u8868\u793a\u6700\u65b0\u7248\u672c\n    if err != nil {\n        return MyOutput{}, err\n    }\n\n    return MyOutput{}, nil\n}\n</code></pre>"},{"location":"zh/artifact/#_8","title":"\u547d\u540d\u7a7a\u95f4\u548c\u7248\u672c\u7ba1\u7406","text":""},{"location":"zh/artifact/#_9","title":"\u4f1a\u8bdd\u8303\u56f4\u7684\u5236\u54c1","text":"<p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u5236\u54c1\u9650\u5b9a\u5728\u5f53\u524d\u4f1a\u8bdd\u8303\u56f4\u5185\uff1a</p> <pre><code>// \u6b64\u6587\u4ef6\u53ea\u80fd\u5728\u5f53\u524d\u4f1a\u8bdd\u4e2d\u8bbf\u95ee\nversion, err := toolCtx.SaveArtifact(\"session-file.txt\", artifact)\n</code></pre>"},{"location":"zh/artifact/#_10","title":"\u7528\u6237\u6301\u4e45\u5316\u5236\u54c1","text":"<p>\u4f7f\u7528 <code>user:</code> \u524d\u7f00\u521b\u5efa\u8de8\u4f1a\u8bdd\u6301\u4e45\u5316\u7684\u5236\u54c1\uff1a</p> <pre><code>// \u6b64\u6587\u4ef6\u5728\u7528\u6237\u7684\u6240\u6709\u4f1a\u8bdd\u4e2d\u6301\u4e45\u5316\nversion, err := toolCtx.SaveArtifact(\"user:profile.json\", artifact)\n</code></pre>"},{"location":"zh/artifact/#_11","title":"\u7248\u672c\u7ba1\u7406","text":"<p>\u6bcf\u6b21\u4fdd\u5b58\u64cd\u4f5c\u90fd\u4f1a\u521b\u5efa\u65b0\u7248\u672c\uff1a</p> <pre><code>// \u4fdd\u5b58\u7248\u672c 0\nv0, _ := toolCtx.SaveArtifact(\"document.txt\", artifact1)\n\n// \u4fdd\u5b58\u7248\u672c 1\nv1, _ := toolCtx.SaveArtifact(\"document.txt\", artifact2)\n\n// \u52a0\u8f7d\u7279\u5b9a\u7248\u672c\noldVersion := 0\nartifact, _ := toolCtx.LoadArtifact(\"document.txt\", &amp;oldVersion)\n\n// \u52a0\u8f7d\u6700\u65b0\u7248\u672c\nartifact, _ := toolCtx.LoadArtifact(\"document.txt\", nil)\n</code></pre>"},{"location":"zh/artifact/#artifact-service_2","title":"Artifact Service \u63a5\u53e3","text":"<p>Artifact Service \u63d0\u4f9b\u4ee5\u4e0b\u64cd\u4f5c\u6765\u7ba1\u7406\u5236\u54c1\uff1a</p> <pre><code>type Service interface {\n    // \u4fdd\u5b58\u5236\u54c1\u5e76\u8fd4\u56de\u7248\u672c ID\n    SaveArtifact(ctx context.Context, sessionInfo SessionInfo, filename string, artifact *Artifact) (int, error)\n\n    // \u52a0\u8f7d\u5236\u54c1\uff08\u5982\u679c version \u4e3a nil \u5219\u52a0\u8f7d\u6700\u65b0\u7248\u672c\uff09\n    LoadArtifact(ctx context.Context, sessionInfo SessionInfo, filename string, version *int) (*Artifact, error)\n\n    // \u5217\u51fa\u4f1a\u8bdd\u4e2d\u7684\u6240\u6709\u5236\u54c1\u6587\u4ef6\u540d\n    ListArtifactKeys(ctx context.Context, sessionInfo SessionInfo) ([]string, error)\n\n    // \u5220\u9664\u5236\u54c1\uff08\u6240\u6709\u7248\u672c\uff09\n    DeleteArtifact(ctx context.Context, sessionInfo SessionInfo, filename string) error\n\n    // \u5217\u51fa\u5236\u54c1\u7684\u6240\u6709\u7248\u672c\n    ListVersions(ctx context.Context, sessionInfo SessionInfo, filename string) ([]int, error)\n}\n</code></pre>"},{"location":"zh/artifact/#_12","title":"\u793a\u4f8b","text":""},{"location":"zh/artifact/#_13","title":"\u56fe\u50cf\u751f\u6210\u548c\u5b58\u50a8","text":"<pre><code>// \u751f\u6210\u5e76\u4fdd\u5b58\u56fe\u50cf\u7684\u5de5\u5177\nfunc generateImageTool(ctx context.Context, input GenerateImageInput) (GenerateImageOutput, error) {\n    // \u751f\u6210\u56fe\u50cf\uff08\u5b9e\u73b0\u7ec6\u8282\u7701\u7565\uff09\n    imageData := generateImage(input.Prompt)\n\n    // \u521b\u5efa\u5236\u54c1\n    artifact := &amp;artifact.Artifact{\n        Data:     imageData,\n        MimeType: \"image/png\",\n        Name:     \"generated-image.png\",\n    }\n\n    // \u4fdd\u5b58\u5230\u5236\u54c1\u5b58\u50a8\n    toolCtx, _ := agent.NewToolContext(ctx)\n    version, err := toolCtx.SaveArtifact(\"generated-image.png\", artifact)\n\n    return GenerateImageOutput{\n        ImagePath: \"generated-image.png\",\n        Version:   version,\n    }, err\n}\n</code></pre>"},{"location":"zh/artifact/#_14","title":"\u6587\u672c\u5904\u7406\u548c\u5b58\u50a8","text":"<pre><code>// \u5904\u7406\u5e76\u4fdd\u5b58\u6587\u672c\u7684\u5de5\u5177\nfunc processTextTool(ctx context.Context, input ProcessTextInput) (ProcessTextOutput, error) {\n    // \u5904\u7406\u6587\u672c\n    processedText := strings.ToUpper(input.Text)\n\n    // \u521b\u5efa\u5236\u54c1\n    artifact := &amp;artifact.Artifact{\n        Data:     []byte(processedText),\n        MimeType: \"text/plain\",\n        Name:     \"processed-text.txt\",\n    }\n\n    // \u4fdd\u5b58\u5230\u7528\u6237\u547d\u540d\u7a7a\u95f4\u4ee5\u5b9e\u73b0\u6301\u4e45\u5316\n    toolCtx, _ := agent.NewToolContext(ctx)\n    version, err := toolCtx.SaveArtifact(\"user:processed-text.txt\", artifact)\n\n    return ProcessTextOutput{\n        ProcessedText: processedText,\n        Version:       version,\n    }, err\n}\n</code></pre>"},{"location":"zh/artifact/#_15","title":"\u6700\u4f73\u5b9e\u8df5","text":"<ol> <li> <p>\u4f7f\u7528\u9002\u5f53\u7684\u547d\u540d\u7a7a\u95f4\uff1a\u5bf9\u4e34\u65f6\u6570\u636e\u4f7f\u7528\u4f1a\u8bdd\u8303\u56f4\u7684\u5236\u54c1\uff0c\u5bf9\u9700\u8981\u8de8\u4f1a\u8bdd\u4fdd\u5b58\u7684\u6570\u636e\u4f7f\u7528\u7528\u6237\u6301\u4e45\u5316\u5236\u54c1\u3002</p> </li> <li> <p>\u8bbe\u7f6e\u6b63\u786e\u7684 MIME \u7c7b\u578b\uff1a\u59cb\u7ec8\u4e3a\u5236\u54c1\u6307\u5b9a\u6b63\u786e\u7684 MIME \u7c7b\u578b\u4ee5\u786e\u4fdd\u6b63\u786e\u5904\u7406\u3002</p> </li> <li> <p>\u5904\u7406\u7248\u672c\uff1a\u8003\u8651\u662f\u5426\u9700\u8981\u8ddf\u8e2a\u7248\u672c\u5e76\u9002\u5f53\u4f7f\u7528\u7248\u672c\u7ba1\u7406\u7cfb\u7edf\u3002</p> </li> <li> <p>\u9009\u62e9\u5408\u9002\u7684\u5b58\u50a8\u540e\u7aef\uff1a\u5f00\u53d1\u73af\u5883\u4f7f\u7528\u5185\u5b58\u5b58\u50a8\uff0c\u751f\u4ea7\u73af\u5883\u4f7f\u7528\u4e91\u5b58\u50a8\u3002</p> </li> <li> <p>\u9519\u8bef\u5904\u7406\uff1a\u4fdd\u5b58\u548c\u52a0\u8f7d\u5236\u54c1\u65f6\u59cb\u7ec8\u5904\u7406\u9519\u8bef\uff0c\u56e0\u4e3a\u5b58\u50a8\u64cd\u4f5c\u53ef\u80fd\u5931\u8d25\u3002</p> </li> <li> <p>\u8d44\u6e90\u7ba1\u7406\uff1a\u4f7f\u7528\u4e91\u5b58\u50a8\u540e\u7aef\u65f6\u8981\u6ce8\u610f\u5b58\u50a8\u6210\u672c\u548c\u6570\u636e\u751f\u547d\u5468\u671f\u3002</p> </li> </ol>"},{"location":"zh/artifact/#_16","title":"\u914d\u7f6e","text":""},{"location":"zh/artifact/#s3_1","title":"S3 \u7684\u73af\u5883\u53d8\u91cf","text":"<p>\u4f7f\u7528 AWS S3 \u6216 S3 \u517c\u5bb9\u670d\u52a1\u65f6\uff1a</p> <pre><code>export AWS_ACCESS_KEY_ID=\"your-access-key\"\nexport AWS_SECRET_ACCESS_KEY=\"your-secret-key\"\nexport AWS_REGION=\"your-region\"\nexport S3_BUCKET=\"your-bucket-name\"\n\n# \u53ef\u9009\uff1a\u7528\u4e8e S3 \u517c\u5bb9\u670d\u52a1\uff08MinIO\u3001R2\u3001Spaces \u7b49\uff09\nexport S3_ENDPOINT=\"https://your-endpoint.com\"\n</code></pre>"},{"location":"zh/artifact/#cos_1","title":"COS \u7684\u73af\u5883\u53d8\u91cf","text":"<p>\u4f7f\u7528\u817e\u8baf\u4e91\u5bf9\u8c61\u5b58\u50a8\u65f6\uff1a</p> <pre><code>export COS_SECRETID=\"your-secret-id\"\nexport COS_SECRETKEY=\"your-secret-key\"\n</code></pre>"},{"location":"zh/artifact/#_17","title":"\u5b58\u50a8\u8def\u5f84\u7ed3\u6784","text":"<p>\u5236\u54c1\u7cfb\u7edf\u4f7f\u7528\u4ee5\u4e0b\u8def\u5f84\u7ed3\u6784\u7ec4\u7ec7\u6587\u4ef6\uff1a</p> <ul> <li>\u4f1a\u8bdd\u8303\u56f4\uff1a<code>{app_name}/{user_id}/{session_id}/{filename}/{version}</code></li> <li>\u7528\u6237\u6301\u4e45\u5316\uff1a<code>{app_name}/{user_id}/user/{filename}/{version}</code></li> </ul> <p>\u6b64\u7ed3\u6784\u786e\u4fdd\u5e94\u7528\u7a0b\u5e8f\u3001\u7528\u6237\u548c\u4f1a\u8bdd\u4e4b\u95f4\u7684\u9002\u5f53\u9694\u79bb\uff0c\u540c\u65f6\u7ef4\u62a4\u7248\u672c\u5386\u53f2\u3002</p>"},{"location":"zh/callbacks/#callbacks","title":"\u56de\u8c03\uff08Callbacks\uff09","text":"<p>\u7248\u672c\u8981\u6c42 \u7ed3\u6784\u5316\u56de\u8c03 API\uff08\u63a8\u8350\uff09\u9700\u8981 trpc-agent-go &gt;= 0.6.0\u3002</p> <p>\u672c\u6587\u4ecb\u7ecd\u9879\u76ee\u4e2d\u7684\u56de\u8c03\u7cfb\u7edf\uff0c\u7528\u4e8e\u62e6\u622a\u3001\u89c2\u6d4b\u4e0e\u5b9a\u5236\u6a21\u578b\u63a8\u7406\u3001\u5de5\u5177\u8c03\u7528\u3001Agent \u6267\u884c\u4ee5\u53ca AG-UI \u4e8b\u4ef6\u7ffb\u8bd1\u3002</p> <p>\u56de\u8c03\u5206\u4e3a\u56db\u7c7b\uff1a</p> <ul> <li>ModelCallbacks\uff08\u6a21\u578b\u56de\u8c03\uff09</li> <li>ToolCallbacks\uff08\u5de5\u5177\u56de\u8c03\uff09</li> <li>AgentCallbacks\uff08Agent \u56de\u8c03\uff09</li> <li>TranslateCallbacks\uff08AGUI \u4e8b\u4ef6\u7ffb\u8bd1\u56de\u8c03\uff09</li> </ul> <p>\u6bcf\u7c7b\u90fd\u6709 Before \u4e0e After \u4e24\u79cd\u56de\u8c03\u3002Before \u56de\u8c03\u53ef\u4ee5\u901a\u8fc7\u8fd4\u56de\u975e\u7a7a\u7ed3\u679c\u63d0\u524d\u8fd4\u56de\uff0c\u8df3\u8fc7\u9ed8\u8ba4\u6267\u884c\u3002</p> <p>\u6240\u6709\u56de\u8c03\u5c06\u6309\u7167\u6ce8\u518c\u987a\u5e8f\u4f9d\u6b21\u6267\u884c\uff0c\u4e14\u4e00\u65e6\u6709\u56de\u8c03\u8fd4\u56de\u975e <code>nil</code> \u503c\uff0c\u56de\u8c03\u94fe\u8def\u5c06\u7acb\u5373\u505c\u6b62\u3002\u5982\u679c\u9700\u8981\u53e0\u52a0\u591a\u4e2a\u56de\u8c03\u6548\u679c\uff0c\u8bf7\u5728\u5355\u4e00\u56de\u8c03\u4e2d\u5b9e\u73b0\u76f8\u5e94\u7684\u903b\u8f91\u3002</p>"},{"location":"zh/callbacks/#_1","title":"\u7ed3\u6784\u5316\u6a21\u578b\u56de\u8c03\uff08\u63a8\u8350\uff09","text":"<ul> <li>BeforeModelCallbackStructured\uff1a\u6a21\u578b\u63a8\u7406\u524d\u89e6\u53d1\uff0c\u4f7f\u7528\u7ed3\u6784\u5316\u53c2\u6570</li> <li>AfterModelCallbackStructured\uff1a\u6a21\u578b\u5b8c\u6210\u540e\u89e6\u53d1\uff0c\u4f7f\u7528\u7ed3\u6784\u5316\u53c2\u6570</li> </ul> <p>\u53c2\u6570\uff1a</p> <pre><code>type BeforeModelArgs struct {\n    Request *model.Request  // \u5373\u5c06\u53d1\u9001\u7684\u8bf7\u6c42\uff08\u53ef\u4fee\u6539\uff09\n}\n\ntype BeforeModelResult struct {\n    Context        context.Context  // \u53ef\u9009\uff0c\u7528\u4e8e\u540e\u7eed\u64cd\u4f5c\u7684\u4e0a\u4e0b\u6587\n    CustomResponse *model.Response  // \u975e\u7a7a\u65f6\u8df3\u8fc7\u6a21\u578b\u8c03\u7528\u5e76\u8fd4\u56de\u6b64\u54cd\u5e94\n}\n\ntype AfterModelArgs struct {\n    Request  *model.Request   // \u53d1\u9001\u7ed9\u6a21\u578b\u7684\u539f\u59cb\u8bf7\u6c42\n    Response *model.Response  // \u6a21\u578b\u8fd4\u56de\u7684\u54cd\u5e94\uff08\u53ef\u80fd\u4e3a nil\uff09\n    Error    error            // \u6a21\u578b\u8c03\u7528\u8fc7\u7a0b\u4e2d\u53d1\u751f\u7684\u9519\u8bef\n}\n\ntype AfterModelResult struct {\n    Context        context.Context  // \u53ef\u9009\uff0c\u7528\u4e8e\u540e\u7eed\u64cd\u4f5c\u7684\u4e0a\u4e0b\u6587\n    CustomResponse *model.Response  // \u975e\u7a7a\u65f6\u66ff\u6362\u539f\u59cb\u54cd\u5e94\n}\n</code></pre> <p>\u7b7e\u540d\uff1a</p> <pre><code>type BeforeModelCallbackStructured func(ctx context.Context, args *model.BeforeModelArgs) (*model.BeforeModelResult, error)\ntype AfterModelCallbackStructured  func(ctx context.Context, args *model.AfterModelArgs) (*model.AfterModelResult, error)\n</code></pre> <p>\u8981\u70b9\uff1a</p> <ul> <li>\u7ed3\u6784\u5316\u53c2\u6570\u63d0\u4f9b\u66f4\u597d\u7684\u7c7b\u578b\u5b89\u5168\u6027\u548c\u66f4\u6e05\u6670\u7684\u610f\u56fe</li> <li><code>BeforeModelResult.Context</code> \u53ef\u7528\u4e8e\u5411\u540e\u7eed\u64cd\u4f5c\u4f20\u9012\u4e0a\u4e0b\u6587</li> <li><code>AfterModelResult.Context</code> \u5141\u8bb8\u5728\u56de\u8c03\u4e4b\u95f4\u4f20\u9012\u4e0a\u4e0b\u6587</li> <li>Before \u53ef\u8fd4\u56de\u975e\u7a7a\u54cd\u5e94\u4ee5\u8df3\u8fc7\u6a21\u578b\u8c03\u7528</li> <li>After \u53ef\u83b7\u53d6\u539f\u59cb\u8bf7\u6c42 <code>req</code>\uff0c\u4fbf\u4e8e\u5185\u5bb9\u8fd8\u539f\u4e0e\u540e\u5904\u7406</li> </ul>"},{"location":"zh/callbacks/#_2","title":"\u56de\u8c03\u6267\u884c\u63a7\u5236","text":"<p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u56de\u8c03\u6267\u884c\u4f1a\u5728\u4ee5\u4e0b\u60c5\u51b5\u7acb\u5373\u505c\u6b62\uff1a</p> <ul> <li>\u56de\u8c03\u8fd4\u56de\u9519\u8bef</li> <li>\u56de\u8c03\u8fd4\u56de\u975e\u7a7a\u7684 <code>CustomResponse</code>\uff08\u5bf9\u4e8e Before \u56de\u8c03\uff09\u6216 <code>CustomResult</code>\uff08\u5bf9\u4e8e Tool \u56de\u8c03\uff09</li> </ul> <p>\u4f60\u53ef\u4ee5\u5728\u521b\u5efa\u56de\u8c03\u65f6\u4f7f\u7528\u9009\u9879\u6765\u63a7\u5236\u6b64\u884c\u4e3a\uff1a</p> <pre><code>// \u5373\u4f7f\u53d1\u751f\u9519\u8bef\u4e5f\u7ee7\u7eed\u6267\u884c\u5269\u4f59\u7684\u56de\u8c03\nmodelCallbacks := model.NewCallbacks(\n    model.WithContinueOnError(true),\n)\n\n// \u5373\u4f7f\u8fd4\u56de\u4e86 CustomResponse \u4e5f\u7ee7\u7eed\u6267\u884c\u5269\u4f59\u7684\u56de\u8c03\nmodelCallbacks := model.NewCallbacks(\n    model.WithContinueOnResponse(true),\n)\n\n// \u542f\u7528\u4e24\u4e2a\u9009\u9879\uff1a\u5728\u9519\u8bef\u548c CustomResponse \u65f6\u90fd\u7ee7\u7eed\u6267\u884c\nmodelCallbacks := model.NewCallbacks(\n    model.WithContinueOnError(true),\n    model.WithContinueOnResponse(true),\n)\n</code></pre> <p>\u6267\u884c\u6a21\u5f0f\uff1a</p> <ol> <li>\u9ed8\u8ba4\uff08\u4e24\u8005\u5747\u4e3a false\uff09\uff1a\u9047\u5230\u7b2c\u4e00\u4e2a\u9519\u8bef\u6216 CustomResponse \u65f6\u505c\u6b62</li> <li>\u7ee7\u7eed\u6267\u884c\uff08\u9519\u8bef\uff09\uff1a\u5373\u4f7f\u67d0\u4e2a\u56de\u8c03\u8fd4\u56de\u9519\u8bef\uff0c\u4e5f\u7ee7\u7eed\u6267\u884c\u5269\u4f59\u7684\u56de\u8c03</li> <li>\u7ee7\u7eed\u6267\u884c\uff08\u54cd\u5e94\uff09\uff1a\u5373\u4f7f\u67d0\u4e2a\u56de\u8c03\u8fd4\u56de\u4e86 CustomResponse\uff0c\u4e5f\u7ee7\u7eed\u6267\u884c\u5269\u4f59\u7684\u56de\u8c03</li> <li>\u7ee7\u7eed\u6267\u884c\uff08\u4e24\u8005\uff09\uff1a\u65e0\u8bba\u53d1\u751f\u9519\u8bef\u6216\u8fd4\u56de CustomResponse\uff0c\u90fd\u7ee7\u7eed\u6267\u884c\u6240\u6709\u56de\u8c03</li> </ol> <p>\u4f18\u5148\u7ea7\u89c4\u5219\uff1a</p> <ul> <li>\u5982\u679c\u540c\u65f6\u53d1\u751f\u9519\u8bef\u548c CustomResponse\uff0c\u9519\u8bef\u4f18\u5148\uff0c\u5c06\u88ab\u8fd4\u56de\uff08\u9664\u975e <code>continueOnError</code> \u4e3a true\uff09</li> <li>\u5f53 <code>continueOnError</code> \u4e3a true \u4e14\u53d1\u751f\u9519\u8bef\u65f6\uff0c\u6267\u884c\u4f1a\u7ee7\u7eed\uff0c\u4f46\u7b2c\u4e00\u4e2a\u9519\u8bef\u4f1a\u88ab\u4fdd\u7559\u5e76\u5728\u6700\u540e\u8fd4\u56de</li> <li>\u5f53 <code>continueOnResponse</code> \u4e3a true \u4e14\u8fd4\u56de\u4e86 CustomResponse \u65f6\uff0c\u6267\u884c\u4f1a\u7ee7\u7eed\uff0c\u4f46\u6700\u540e\u4e00\u4e2a CustomResponse \u4f1a\u88ab\u4f7f\u7528</li> </ul> <p>\u793a\u4f8b\uff1a</p> <pre><code>modelCallbacks := model.NewCallbacks().\n  // Before\uff1a\u5bf9\u7279\u5b9a\u63d0\u793a\u76f4\u63a5\u8fd4\u56de\u56fa\u5b9a\u54cd\u5e94\uff0c\u8df3\u8fc7\u771f\u5b9e\u6a21\u578b\u8c03\u7528\n  RegisterBeforeModel(func(ctx context.Context, args *model.BeforeModelArgs) (*model.BeforeModelResult, error) {\n    if len(args.Request.Messages) &gt; 0 &amp;&amp; strings.Contains(args.Request.Messages[len(args.Request.Messages)-1].Content, \"/ping\") {\n      return &amp;model.BeforeModelResult{\n        CustomResponse: &amp;model.Response{Choices: []model.Choice{{Message: model.Message{Role: model.RoleAssistant, Content: \"pong\"}}}},\n      }, nil\n    }\n    return nil, nil\n  }).\n  // After\uff1a\u5728\u6210\u529f\u65f6\u8ffd\u52a0\u63d0\u793a\u4fe1\u606f\uff0c\u6216\u5728\u51fa\u9519\u65f6\u5305\u88c5\u9519\u8bef\u4fe1\u606f\n  RegisterAfterModel(func(ctx context.Context, args *model.AfterModelArgs) (*model.AfterModelResult, error) {\n    if args.Error != nil {\n      return nil, args.Error\n    }\n    if args.Response != nil &amp;&amp; len(args.Response.Choices) &gt; 0 {\n      args.Response.Choices[0].Message.Content += \"\\n\\n-- answered by callback\"\n      return &amp;model.AfterModelResult{CustomResponse: args.Response}, nil\n    }\n    return nil, nil\n  })\n</code></pre> <p>\u4f7f\u7528\u65b9\u5f0f\uff1a\u521b\u5efa callbacks \u540e\uff0c\u9700\u8981\u5728\u521b\u5efa LLM Agent \u65f6\u901a\u8fc7 <code>llmagent.WithModelCallbacks()</code> \u9009\u9879\u4f20\u5165\uff1a</p> <pre><code>// \u521b\u5efa\u6a21\u578b\u56de\u8c03\nmodelCallbacks := model.NewCallbacks().\n  RegisterBeforeModel(...).\n  RegisterAfterModel(...)\n\n// \u521b\u5efa LLM Agent \u5e76\u4f20\u5165\u6a21\u578b\u56de\u8c03\nllmAgent := llmagent.New(\n  \"chat-assistant\",\n  llmagent.WithModel(modelInstance),\n  llmagent.WithModelCallbacks(modelCallbacks),  // \u4f20\u5165\u6a21\u578b\u56de\u8c03\n)\n</code></pre> <p>\u5b8c\u6574\u793a\u4f8b\u8bf7\u53c2\u8003 <code>examples/callbacks/main.go</code>\u3002</p>"},{"location":"zh/callbacks/#_3","title":"\u4f20\u7edf\u6a21\u578b\u56de\u8c03\uff08\u5df2\u5f03\u7528\uff09","text":"<p>\u26a0\ufe0f \u5df2\u5f03\u7528 \u4f20\u7edf\u56de\u8c03\u5df2\u5f03\u7528\u3002\u8bf7\u5728\u65b0\u4ee3\u7801\u4e2d\u4f7f\u7528\u7ed3\u6784\u5316\u56de\u8c03\u3002</p>"},{"location":"zh/callbacks/#_4","title":"\u7ed3\u6784\u5316\u5de5\u5177\u56de\u8c03\uff08\u63a8\u8350\uff09","text":"<ul> <li>BeforeToolCallbackStructured\uff1a\u5de5\u5177\u8c03\u7528\u524d\u89e6\u53d1\uff0c\u4f7f\u7528\u7ed3\u6784\u5316\u53c2\u6570</li> <li>AfterToolCallbackStructured\uff1a\u5de5\u5177\u8c03\u7528\u540e\u89e6\u53d1\uff0c\u4f7f\u7528\u7ed3\u6784\u5316\u53c2\u6570</li> </ul> <p>\u53c2\u6570\uff1a</p> <pre><code>type BeforeToolArgs struct {\n    ToolName     string               // \u5de5\u5177\u540d\u79f0\n    Declaration  *tool.Declaration    // \u5de5\u5177\u58f0\u660e\u5143\u6570\u636e\n    Arguments    []byte               // JSON \u53c2\u6570\uff08\u53ef\u4fee\u6539\uff09\n}\n\ntype BeforeToolResult struct {\n    Context       context.Context     // \u53ef\u9009\uff0c\u7528\u4e8e\u540e\u7eed\u64cd\u4f5c\u7684\u4e0a\u4e0b\u6587\n    CustomResult  any                 // \u975e\u7a7a\u65f6\u8df3\u8fc7\u5de5\u5177\u6267\u884c\u5e76\u8fd4\u56de\u6b64\u7ed3\u679c\n    ModifiedArguments []byte          // \u53ef\u9009\uff0c\u4fee\u6539\u540e\u7684\u53c2\u6570\u7528\u4e8e\u5de5\u5177\u6267\u884c\n}\n\ntype AfterToolArgs struct {\n    ToolName     string               // \u5de5\u5177\u540d\u79f0\n    Declaration  *tool.Declaration    // \u5de5\u5177\u58f0\u660e\u5143\u6570\u636e\n    Arguments    []byte               // \u539f\u59cb JSON \u53c2\u6570\n    Result       any                  // \u5de5\u5177\u6267\u884c\u7ed3\u679c\uff08\u53ef\u80fd\u4e3a nil\uff09\n    Error        error                // \u5de5\u5177\u6267\u884c\u8fc7\u7a0b\u4e2d\u53d1\u751f\u7684\u9519\u8bef\n}\n\ntype AfterToolResult struct {\n    Context       context.Context     // \u53ef\u9009\uff0c\u7528\u4e8e\u540e\u7eed\u64cd\u4f5c\u7684\u4e0a\u4e0b\u6587\n    CustomResult  any                 // \u975e\u7a7a\u65f6\u66ff\u6362\u539f\u59cb\u7ed3\u679c\n}\n</code></pre> <p>\u7b7e\u540d\uff1a</p> <pre><code>type BeforeToolCallbackStructured func(ctx context.Context, args *tool.BeforeToolArgs) (*tool.BeforeToolResult, error)\ntype AfterToolCallbackStructured  func(ctx context.Context, args *tool.AfterToolArgs) (*tool.AfterToolResult, error)\n</code></pre> <p>\u8981\u70b9\uff1a</p> <ul> <li>\u7ed3\u6784\u5316\u53c2\u6570\u63d0\u4f9b\u66f4\u597d\u7684\u7c7b\u578b\u5b89\u5168\u6027\u548c\u66f4\u6e05\u6670\u7684\u610f\u56fe</li> <li><code>BeforeToolResult.ModifiedArguments</code> \u5141\u8bb8\u4fee\u6539\u5de5\u5177\u53c2\u6570</li> <li><code>BeforeToolResult.Context</code> \u548c <code>AfterToolResult.Context</code> \u53ef\u5728\u64cd\u4f5c\u4e4b\u95f4\u4f20\u9012\u4e0a\u4e0b\u6587</li> <li>\u53ef\u901a\u8fc7 <code>args.Arguments</code> \u76f4\u63a5\u4fee\u6539\u53c2\u6570</li> <li>BeforeToolCallbackStructured \u8fd4\u56de\u975e\u7a7a\u81ea\u5b9a\u4e49\u7ed3\u679c\u65f6\uff0c\u4f1a\u8df3\u8fc7\u5de5\u5177\u6267\u884c\u5e76\u76f4\u63a5\u4f7f\u7528\u8be5\u7ed3\u679c</li> </ul>"},{"location":"zh/callbacks/#_5","title":"\u56de\u8c03\u6267\u884c\u63a7\u5236","text":"<p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u56de\u8c03\u6267\u884c\u4f1a\u5728\u4ee5\u4e0b\u60c5\u51b5\u7acb\u5373\u505c\u6b62\uff1a</p> <ul> <li>\u56de\u8c03\u8fd4\u56de\u9519\u8bef</li> <li>\u56de\u8c03\u8fd4\u56de\u975e\u7a7a\u7684 <code>CustomResult</code></li> </ul> <p>\u4f60\u53ef\u4ee5\u5728\u521b\u5efa\u56de\u8c03\u65f6\u4f7f\u7528\u9009\u9879\u6765\u63a7\u5236\u6b64\u884c\u4e3a\uff1a</p> <pre><code>// \u5373\u4f7f\u53d1\u751f\u9519\u8bef\u4e5f\u7ee7\u7eed\u6267\u884c\u5269\u4f59\u7684\u56de\u8c03\ntoolCallbacks := tool.NewCallbacks(\n    tool.WithContinueOnError(true),\n)\n\n// \u5373\u4f7f\u8fd4\u56de\u4e86 CustomResult \u4e5f\u7ee7\u7eed\u6267\u884c\u5269\u4f59\u7684\u56de\u8c03\ntoolCallbacks := tool.NewCallbacks(\n    tool.WithContinueOnResponse(true),\n)\n\n// \u542f\u7528\u4e24\u4e2a\u9009\u9879\uff1a\u5728\u9519\u8bef\u548c CustomResult \u65f6\u90fd\u7ee7\u7eed\u6267\u884c\ntoolCallbacks := tool.NewCallbacks(\n    tool.WithContinueOnError(true),\n    tool.WithContinueOnResponse(true),\n)\n</code></pre> <p>\u6267\u884c\u6a21\u5f0f\uff1a</p> <ol> <li>\u9ed8\u8ba4\uff08\u4e24\u8005\u5747\u4e3a false\uff09\uff1a\u9047\u5230\u7b2c\u4e00\u4e2a\u9519\u8bef\u6216 CustomResult \u65f6\u505c\u6b62</li> <li>\u7ee7\u7eed\u6267\u884c\uff08\u9519\u8bef\uff09\uff1a\u5373\u4f7f\u67d0\u4e2a\u56de\u8c03\u8fd4\u56de\u9519\u8bef\uff0c\u4e5f\u7ee7\u7eed\u6267\u884c\u5269\u4f59\u7684\u56de\u8c03</li> <li>\u7ee7\u7eed\u6267\u884c\uff08\u54cd\u5e94\uff09\uff1a\u5373\u4f7f\u67d0\u4e2a\u56de\u8c03\u8fd4\u56de\u4e86 CustomResult\uff0c\u4e5f\u7ee7\u7eed\u6267\u884c\u5269\u4f59\u7684\u56de\u8c03</li> <li>\u7ee7\u7eed\u6267\u884c\uff08\u4e24\u8005\uff09\uff1a\u65e0\u8bba\u53d1\u751f\u9519\u8bef\u6216\u8fd4\u56de CustomResult\uff0c\u90fd\u7ee7\u7eed\u6267\u884c\u6240\u6709\u56de\u8c03</li> </ol> <p>\u4f18\u5148\u7ea7\u89c4\u5219\uff1a</p> <ul> <li>\u5982\u679c\u540c\u65f6\u53d1\u751f\u9519\u8bef\u548c CustomResult\uff0c\u9519\u8bef\u4f18\u5148\uff0c\u5c06\u88ab\u8fd4\u56de\uff08\u9664\u975e <code>continueOnError</code> \u4e3a true\uff09</li> <li>\u5f53 <code>continueOnError</code> \u4e3a true \u4e14\u53d1\u751f\u9519\u8bef\u65f6\uff0c\u6267\u884c\u4f1a\u7ee7\u7eed\uff0c\u4f46\u7b2c\u4e00\u4e2a\u9519\u8bef\u4f1a\u88ab\u4fdd\u7559\u5e76\u5728\u6700\u540e\u8fd4\u56de</li> <li>\u5f53 <code>continueOnResponse</code> \u4e3a true \u4e14\u8fd4\u56de\u4e86 CustomResult \u65f6\uff0c\u6267\u884c\u4f1a\u7ee7\u7eed\uff0c\u4f46\u6700\u540e\u4e00\u4e2a CustomResult \u4f1a\u88ab\u4f7f\u7528</li> </ul> <p>\u793a\u4f8b\uff1a</p> <pre><code>toolCallbacks := tool.NewCallbacks().\n  RegisterBeforeTool(func(ctx context.Context, args *tool.BeforeToolArgs) (*tool.BeforeToolResult, error) {\n    if args.Arguments != nil &amp;&amp; args.ToolName == \"calculator\" {\n      // \u4e30\u5bcc\u53c2\u6570\n      original := string(args.Arguments)\n      enriched := []byte(fmt.Sprintf(`{\"original\":%s,\"ts\":%d}`, original, time.Now().Unix()))\n      args.Arguments = enriched\n    }\n    return nil, nil\n  }).\n  RegisterAfterTool(func(ctx context.Context, args *tool.AfterToolArgs) (*tool.AfterToolResult, error) {\n    if args.Error != nil {\n      return nil, args.Error\n    }\n    if s, ok := args.Result.(string); ok {\n      return &amp;tool.AfterToolResult{\n        CustomResult: s + \"\\n-- post processed by tool callback\",\n      }, nil\n    }\n    return nil, nil\n  })\n</code></pre> <p>\u4f7f\u7528\u65b9\u5f0f\uff1a\u521b\u5efa callbacks \u540e\uff0c\u9700\u8981\u5728\u521b\u5efa LLM Agent \u65f6\u901a\u8fc7 <code>llmagent.WithToolCallbacks()</code> \u9009\u9879\u4f20\u5165\uff1a</p> <pre><code>// \u521b\u5efa\u5de5\u5177\u56de\u8c03\ntoolCallbacks := tool.NewCallbacks().\n  RegisterBeforeTool(...).\n  RegisterAfterTool(...)\n\n// \u521b\u5efa LLM Agent \u5e76\u4f20\u5165\u5de5\u5177\u56de\u8c03\nllmAgent := llmagent.New(\n  \"chat-assistant\",\n  llmagent.WithModel(modelInstance),\n  llmagent.WithTools(tools),\n  llmagent.WithToolCallbacks(toolCallbacks),  // \u4f20\u5165\u5de5\u5177\u56de\u8c03\n)\n</code></pre> <p>\u5b8c\u6574\u793a\u4f8b\u8bf7\u53c2\u8003 <code>examples/callbacks/main.go</code>\u3002</p> <p>\u53ef\u89c2\u6d4b\u4e0e\u4e8b\u4ef6\uff1a</p> <ul> <li>\u4fee\u6539\u540e\u7684\u53c2\u6570\u4f1a\u540c\u6b65\u5230\uff1a<ul> <li><code>TraceToolCall</code> \u53ef\u89c2\u6d4b\u5c5e\u6027</li> <li>\u56fe\u4e8b\u4ef6 <code>emitToolStartEvent</code> \u4e0e <code>emitToolCompleteEvent</code></li> </ul> </li> </ul>"},{"location":"zh/callbacks/#_6","title":"\u4f20\u7edf\u5de5\u5177\u56de\u8c03\uff08\u5df2\u5f03\u7528\uff09","text":"<p>\u26a0\ufe0f \u5df2\u5f03\u7528 \u4f20\u7edf\u56de\u8c03\u5df2\u5f03\u7528\u3002\u8bf7\u5728\u65b0\u4ee3\u7801\u4e2d\u4f7f\u7528\u7ed3\u6784\u5316\u56de\u8c03\u3002</p>"},{"location":"zh/callbacks/#agent","title":"\u7ed3\u6784\u5316 Agent \u56de\u8c03\uff08\u63a8\u8350\uff09","text":"<ul> <li>BeforeAgentCallbackStructured\uff1aAgent \u6267\u884c\u524d\u89e6\u53d1\uff0c\u4f7f\u7528\u7ed3\u6784\u5316\u53c2\u6570</li> <li>AfterAgentCallbackStructured\uff1aAgent \u6267\u884c\u540e\u89e6\u53d1\uff0c\u4f7f\u7528\u7ed3\u6784\u5316\u53c2\u6570</li> </ul> <p>\u53c2\u6570\uff1a</p> <pre><code>type BeforeAgentArgs struct {\n    Invocation *agent.Invocation  // \u8c03\u7528\u4e0a\u4e0b\u6587\n}\n\ntype BeforeAgentResult struct {\n    Context        context.Context  // \u53ef\u9009\uff0c\u7528\u4e8e\u540e\u7eed\u64cd\u4f5c\u7684\u4e0a\u4e0b\u6587\n    CustomResponse *model.Response  // \u975e\u7a7a\u65f6\u8df3\u8fc7 Agent \u6267\u884c\u5e76\u8fd4\u56de\u6b64\u54cd\u5e94\n}\n\ntype AfterAgentArgs struct {\n    Invocation        *agent.Invocation  // \u8c03\u7528\u4e0a\u4e0b\u6587\n    FullResponseEvent *event.Event       // Agent \u6267\u884c\u540e\u7684\u6700\u7ec8\u54cd\u5e94\u4e8b\u4ef6\uff08\u53ef\u80fd\u4e3a nil\uff09\n    Error             error              // Agent \u6267\u884c\u8fc7\u7a0b\u4e2d\u53d1\u751f\u7684\u9519\u8bef\uff08\u53ef\u80fd\u4e3a nil\uff09\n}\n\ntype AfterAgentResult struct {\n    Context        context.Context  // \u53ef\u9009\uff0c\u7528\u4e8e\u540e\u7eed\u64cd\u4f5c\u7684\u4e0a\u4e0b\u6587\n    CustomResponse *model.Response  // \u975e\u7a7a\u65f6\u66ff\u6362\u539f\u59cb\u54cd\u5e94\n}\n</code></pre> <p>\u7b7e\u540d\uff1a</p> <pre><code>type BeforeAgentCallbackStructured func(ctx context.Context, args *agent.BeforeAgentArgs) (*agent.BeforeAgentResult, error)\ntype AfterAgentCallbackStructured  func(ctx context.Context, args *agent.AfterAgentArgs) (*agent.AfterAgentResult, error)\n</code></pre> <p>\u8981\u70b9\uff1a</p> <ul> <li>\u7ed3\u6784\u5316\u53c2\u6570\u63d0\u4f9b\u66f4\u597d\u7684\u7c7b\u578b\u5b89\u5168\u6027\u548c\u66f4\u6e05\u6670\u7684\u610f\u56fe</li> <li><code>BeforeAgentResult.Context</code> \u548c <code>AfterAgentResult.Context</code> \u53ef\u5728\u64cd\u4f5c\u4e4b\u95f4\u4f20\u9012\u4e0a\u4e0b\u6587</li> <li>\u53ef\u8bbf\u95ee\u5b8c\u6574\u7684\u8c03\u7528\u4e0a\u4e0b\u6587\uff0c\u4fbf\u4e8e\u5b9e\u73b0\u4e30\u5bcc\u7684\u6309\u6b21\u903b\u8f91</li> <li>Before \u53ef\u8fd4\u56de\u81ea\u5b9a\u4e49 <code>*model.Response</code> \u4ee5\u4e2d\u6b62\u540e\u7eed\u6a21\u578b\u8c03\u7528</li> <li>After \u53ef\u8fd4\u56de\u66ff\u6362\u54cd\u5e94</li> <li><code>AfterAgentArgs.FullResponseEvent</code> \u63d0\u4f9b\u5bf9 agent \u6700\u7ec8\u8f93\u51fa\u7ed3\u679c\u7684\u8bbf\u95ee\uff0c\u53ef\u7528\u4e8e\u65e5\u5fd7\u8bb0\u5f55\u3001\u76d1\u63a7\u3001\u540e\u5904\u7406\u7b49\u573a\u666f</li> </ul>"},{"location":"zh/callbacks/#_7","title":"\u56de\u8c03\u6267\u884c\u63a7\u5236","text":"<p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u56de\u8c03\u6267\u884c\u4f1a\u5728\u4ee5\u4e0b\u60c5\u51b5\u7acb\u5373\u505c\u6b62\uff1a</p> <ul> <li>\u56de\u8c03\u8fd4\u56de\u9519\u8bef</li> <li>\u56de\u8c03\u8fd4\u56de\u975e\u7a7a\u7684 <code>CustomResponse</code></li> </ul> <p>\u4f60\u53ef\u4ee5\u5728\u521b\u5efa\u56de\u8c03\u65f6\u4f7f\u7528\u9009\u9879\u6765\u63a7\u5236\u6b64\u884c\u4e3a\uff1a</p> <pre><code>// \u5373\u4f7f\u53d1\u751f\u9519\u8bef\u4e5f\u7ee7\u7eed\u6267\u884c\u5269\u4f59\u7684\u56de\u8c03\nagentCallbacks := agent.NewCallbacks(\n    agent.WithContinueOnError(true),\n)\n\n// \u5373\u4f7f\u8fd4\u56de\u4e86 CustomResponse \u4e5f\u7ee7\u7eed\u6267\u884c\u5269\u4f59\u7684\u56de\u8c03\nagentCallbacks := agent.NewCallbacks(\n    agent.WithContinueOnResponse(true),\n)\n\n// \u542f\u7528\u4e24\u4e2a\u9009\u9879\uff1a\u5728\u9519\u8bef\u548c CustomResponse \u65f6\u90fd\u7ee7\u7eed\u6267\u884c\nagentCallbacks := agent.NewCallbacks(\n    agent.WithContinueOnError(true),\n    agent.WithContinueOnResponse(true),\n)\n</code></pre> <p>\u6267\u884c\u6a21\u5f0f\uff1a</p> <ol> <li>\u9ed8\u8ba4\uff08\u4e24\u8005\u5747\u4e3a false\uff09\uff1a\u9047\u5230\u7b2c\u4e00\u4e2a\u9519\u8bef\u6216 CustomResponse \u65f6\u505c\u6b62</li> <li>\u7ee7\u7eed\u6267\u884c\uff08\u9519\u8bef\uff09\uff1a\u5373\u4f7f\u67d0\u4e2a\u56de\u8c03\u8fd4\u56de\u9519\u8bef\uff0c\u4e5f\u7ee7\u7eed\u6267\u884c\u5269\u4f59\u7684\u56de\u8c03</li> <li>\u7ee7\u7eed\u6267\u884c\uff08\u54cd\u5e94\uff09\uff1a\u5373\u4f7f\u67d0\u4e2a\u56de\u8c03\u8fd4\u56de\u4e86 CustomResponse\uff0c\u4e5f\u7ee7\u7eed\u6267\u884c\u5269\u4f59\u7684\u56de\u8c03</li> <li>\u7ee7\u7eed\u6267\u884c\uff08\u4e24\u8005\uff09\uff1a\u65e0\u8bba\u53d1\u751f\u9519\u8bef\u6216\u8fd4\u56de CustomResponse\uff0c\u90fd\u7ee7\u7eed\u6267\u884c\u6240\u6709\u56de\u8c03</li> </ol> <p>\u4f18\u5148\u7ea7\u89c4\u5219\uff1a</p> <ul> <li>\u5982\u679c\u540c\u65f6\u53d1\u751f\u9519\u8bef\u548c CustomResponse\uff0c\u9519\u8bef\u4f18\u5148\uff0c\u5c06\u88ab\u8fd4\u56de\uff08\u9664\u975e <code>continueOnError</code> \u4e3a true\uff09</li> <li>\u5f53 <code>continueOnError</code> \u4e3a true \u4e14\u53d1\u751f\u9519\u8bef\u65f6\uff0c\u6267\u884c\u4f1a\u7ee7\u7eed\uff0c\u4f46\u7b2c\u4e00\u4e2a\u9519\u8bef\u4f1a\u88ab\u4fdd\u7559\u5e76\u5728\u6700\u540e\u8fd4\u56de</li> <li>\u5f53 <code>continueOnResponse</code> \u4e3a true \u4e14\u8fd4\u56de\u4e86 CustomResponse \u65f6\uff0c\u6267\u884c\u4f1a\u7ee7\u7eed\uff0c\u4f46\u6700\u540e\u4e00\u4e2a CustomResponse \u4f1a\u88ab\u4f7f\u7528</li> </ul> <p>\u793a\u4f8b\uff1a</p> <pre><code>agentCallbacks := agent.NewCallbacks().\n  // Before\uff1a\u5f53\u7528\u6237\u6d88\u606f\u5305\u542b /abort \u65f6\uff0c\u76f4\u63a5\u8fd4\u56de\u56fa\u5b9a\u54cd\u5e94\uff0c\u8df3\u8fc7\u540e\u7eed\u6d41\u7a0b\n  RegisterBeforeAgent(func(ctx context.Context, args *agent.BeforeAgentArgs) (*agent.BeforeAgentResult, error) {\n    if args.Invocation != nil &amp;&amp; strings.Contains(args.Invocation.GetUserMessageContent(), \"/abort\") {\n      return &amp;agent.BeforeAgentResult{\n        CustomResponse: &amp;model.Response{Choices: []model.Choice{{Message: model.Message{Role: model.RoleAssistant, Content: \"aborted by callback\"}}}},\n      }, nil\n    }\n    return nil, nil\n  }).\n  // After\uff1a\u5728\u6210\u529f\u54cd\u5e94\u672b\u5c3e\u8ffd\u52a0\u6807\u6ce8\uff0c\u53ef\u4ee5\u8bbf\u95ee FullResponseEvent \u83b7\u53d6\u6700\u7ec8\u54cd\u5e94\u4e8b\u4ef6\n  RegisterAfterAgent(func(ctx context.Context, args *agent.AfterAgentArgs) (*agent.AfterAgentResult, error) {\n    if args.Error != nil {\n      return nil, args.Error\n    }\n    // \u53ef\u4ee5\u901a\u8fc7 FullResponseEvent \u8bbf\u95ee agent \u7684\u6700\u7ec8\u8f93\u51fa\u7ed3\u679c\n    if args.FullResponseEvent != nil &amp;&amp; args.FullResponseEvent.Response != nil {\n      if len(args.FullResponseEvent.Response.Choices) &gt; 0 {\n        c := args.FullResponseEvent.Response.Choices[0]\n        c.Message.Content = c.Message.Content + \"\\n\\n-- handled by agent callback\"\n        args.FullResponseEvent.Response.Choices[0] = c\n        return &amp;agent.AfterAgentResult{CustomResponse: args.FullResponseEvent.Response}, nil\n      }\n    }\n    return nil, nil\n  })\n</code></pre> <p>\u4f7f\u7528\u65b9\u5f0f\uff1a\u521b\u5efa callbacks \u540e\uff0c\u9700\u8981\u5728\u521b\u5efa LLM Agent \u65f6\u901a\u8fc7 <code>llmagent.WithAgentCallbacks()</code> \u9009\u9879\u4f20\u5165\uff1a</p> <pre><code>// \u521b\u5efa Agent \u56de\u8c03\nagentCallbacks := agent.NewCallbacks().\n  RegisterBeforeAgent(...).\n  RegisterAfterAgent(...)\n\n// \u521b\u5efa LLM Agent \u5e76\u4f20\u5165 Agent \u56de\u8c03\nllmAgent := llmagent.New(\n  \"chat-assistant\",\n  llmagent.WithModel(modelInstance),\n  llmagent.WithAgentCallbacks(agentCallbacks),  // \u4f20\u5165 Agent \u56de\u8c03\n)\n</code></pre>"},{"location":"zh/callbacks/#agent-stop-agent-via-callbacks","title":"\u5728\u56de\u8c03\u4e2d\u505c\u6b62 agent {#stop-agent-via-callbacks}","text":"<p>\u5f53\u9700\u8981\u7ec8\u6b62\u6267\u884c\u5e76\u5411 runner \u4e8b\u4ef6\u6d41\u53d1\u51fa <code>stop_agent_error</code> \u65f6\uff0c\u5728\u56de\u8c03\u4e2d\u8fd4\u56de <code>agent.NewStopError</code>\u3002\u9002\u7528\u4e8e\u914d\u989d\u6821\u9a8c\u3001\u98ce\u63a7\u3001\u4eba\u5de5\u4e2d\u65ad\u7b49\u573a\u666f\u3002</p> <pre><code>agentCallbacks := agent.NewCallbacks().\n  RegisterBeforeAgent(func(ctx context.Context, args *agent.BeforeAgentArgs) (*agent.BeforeAgentResult, error) {\n    if args.Invocation != nil &amp;&amp; args.Invocation.TokenUsage.Total &gt;= maxTokens {\n      return nil, agent.NewStopError(\"token limit reached\")\n    }\n    return nil, nil\n  }).\n  RegisterAfterAgent(func(ctx context.Context, args *agent.AfterAgentArgs) (*agent.AfterAgentResult, error) {\n    if args.Error != nil {\n      return nil, args.Error\n    }\n    if args.FullResponseEvent != nil &amp;&amp; args.FullResponseEvent.Response != nil &amp;&amp;\n      args.FullResponseEvent.Response.Usage.TotalTokens &gt;= maxTokens {\n      return nil, agent.NewStopError(\"token limit reached after response\")\n    }\n    return nil, nil\n  })\n</code></pre> <p>\u8bf4\u660e\uff1a</p> <ul> <li>Flow \u4f1a\u628a <code>StopError</code> \u8f6c\u6362\u6210 <code>stop_agent_error</code> \u4e8b\u4ef6\u5e76\u505c\u6b62\u5faa\u73af\u3002\u4e0b\u6e38\u53ef\u4ee5\u901a\u8fc7 <code>event.Error.Type == agent.ErrorTypeStopAgentError</code> \u8bc6\u522b\u3002</li> <li>\u82e5\u9700\u8981\u5bf9\u6b63\u5728\u8fdb\u884c\u7684\u6a21\u578b\u6216\u5de5\u5177\u8c03\u7528\u505a\u786c\u622a\u6b62\uff0c\u8bf7\u540c\u65f6\u4f7f\u7528 context \u53d6\u6d88\uff1b\u5173\u4e8e\u4e0a\u4e0b\u6587\u53d6\u6d88\u7684\u6a21\u5f0f\u89c1 runner \u6587\u6863\u7684\u4e2d\u65ad\u8bf4\u660e\u3002</li> </ul> <p>\u5b8c\u6574\u793a\u4f8b\u8bf7\u53c2\u8003 <code>examples/callbacks/main.go</code>\u3002</p>"},{"location":"zh/callbacks/#agent_1","title":"\u4f20\u7edf Agent \u56de\u8c03\uff08\u5df2\u5f03\u7528\uff09","text":"<p>\u26a0\ufe0f \u5df2\u5f03\u7528 \u4f20\u7edf\u56de\u8c03\u5df2\u5f03\u7528\u3002\u8bf7\u5728\u65b0\u4ee3\u7801\u4e2d\u4f7f\u7528\u7ed3\u6784\u5316\u56de\u8c03\u3002</p>"},{"location":"zh/callbacks/#translatecallbacks","title":"TranslateCallbacks","text":"<p>TranslateCallbacks \u4f5c\u4e3a AG-UI \u4e8b\u4ef6 translate \u7684\u56de\u8c03\uff0c\u5206\u4e3a\u4e24\u7c7b\uff1a</p> <ul> <li>BeforeTranslateCallback\uff1a\u5185\u90e8\u4e8b\u4ef6\u7ffb\u8bd1\u4e3a AG-UI \u4e8b\u4ef6\u4e4b\u524d\u89e6\u53d1</li> <li>AfterTranslateCallback\uff1aAG-UI \u4e8b\u4ef6\u7ffb\u8bd1\u5b8c\u6210\uff0c\u53d1\u5f80\u5ba2\u6237\u7aef\u524d\u89e6\u53d1</li> </ul> <p>\u7b7e\u540d\uff1a</p> <pre><code>import (\n    aguievents \"github.com/ag-ui-protocol/ag-ui/sdks/community/go/pkg/core/events\"\n    \"trpc.group/trpc-go/trpc-agent-go/event\"\n)\n\ntype BeforeTranslateCallback func(ctx context.Context, evt *event.Event) (*event.Event, error)\ntype AfterTranslateCallback  func(ctx context.Context, evt aguievents.Event) (aguievents.Event, error)\n</code></pre> <p>\u8981\u70b9\uff1a</p> <ul> <li>Before \u56de\u8c03\u8fd4\u56de\u975e\u7a7a\u81ea\u5b9a\u4e49\u4e8b\u4ef6\u65f6\uff0c\u4e8b\u4ef6\u7ffb\u8bd1\u7684\u8f93\u5165\u88ab\u66ff\u6362\u4e3a\u8be5\u81ea\u5b9a\u4e49\u4e8b\u4ef6</li> <li>After \u56de\u8c03\u8fd4\u56de\u975e\u7a7a\u81ea\u5b9a\u4e49\u4e8b\u4ef6\u65f6\uff0c\u4e8b\u4ef6\u7ffb\u8bd1\u7684\u8f93\u51fa\u88ab\u66ff\u6362\u4e3a\u8be5\u81ea\u5b9a\u4e49\u4e8b\u4ef6\uff0c\u6700\u7ec8\u53d1\u9001\u7ed9\u5ba2\u6237\u7aef</li> <li>Before/After \u56de\u8c03\u9075\u5faa\u5168\u5c40\u77ed\u8def\u89c4\u5219\uff0c\u82e5\u8981\u53e0\u52a0\u4fee\u6539\u8bf7\u5728\u5355\u4e2a\u56de\u8c03\u5185\u5b8c\u6210\u5408\u5e76\u903b\u8f91</li> </ul> <p>\u793a\u4f8b\uff1a</p> <pre><code>import (\n    aguievents \"github.com/ag-ui-protocol/ag-ui/sdks/community/go/pkg/core/events\"\n    \"trpc.group/trpc-go/trpc-agent-go/event\"\n    \"trpc.group/trpc-go/trpc-agent-go/server/agui/translator\"\n)\n\ntranslateCallbacks := translator.NewCallbacks().\n  // \u89c2\u6d4b\u5185\u90e8\u4e8b\u4ef6\n  RegisterBeforeTranslate(func(ctx context.Context, event *event.Event) (*event.Event, error) {\n    fmt.Println(event)\n    return nil, nil\n  }).\n  // \u89c2\u6d4b AG-UI \u4e8b\u4ef6\n  RegisterAfterTranslate(func(ctx context.Context, event aguievents.Event) (aguievents.Event, error) {\n    fmt.Println(event)\n    return nil, nil\n  })\n</code></pre> <p>TranslateCallbacks \u7684\u8be6\u7ec6\u4ecb\u7ecd\u53c2\u89c1 agui</p>"},{"location":"zh/callbacks/#invocation","title":"\u5728\u56de\u8c03\u4e2d\u8bbf\u95ee Invocation","text":"<p>\u56de\u8c03\u53ef\u901a\u8fc7 context \u83b7\u53d6\u5f53\u524d\u7684 Invocation \u4ee5\u4fbf\u505a\u5173\u8054\u65e5\u5fd7\u3001\u8ffd\u8e2a\u6216\u6309\u6b21\u903b\u8f91\u3002</p> <pre><code>if inv, ok := agent.InvocationFromContext(ctx); ok &amp;&amp; inv != nil {\n  fmt.Printf(\"invocation id=%s, agent=%s\\n\", inv.InvocationID, inv.AgentName)\n}\n</code></pre> <p>\u793a\u4f8b\u5de5\u7a0b\u5728 Before/After \u56de\u8c03\u4e2d\u6253\u5370\u4e86 Invocation \u7684\u5b58\u5728\u6027\u3002</p>"},{"location":"zh/callbacks/#invocation-state","title":"Invocation State\uff1a\u5728\u56de\u8c03\u95f4\u5171\u4eab\u72b6\u6001","text":"<p><code>Invocation</code> \u63d0\u4f9b\u4e86\u901a\u7528\u7684 <code>State</code> \u673a\u5236\uff0c\u7528\u4e8e\u5b58\u50a8 invocation \u7ea7\u522b\u7684\u72b6\u6001\u6570\u636e\u3002\u5b83\u4e0d\u4ec5\u53ef\u4ee5\u5728 Before \u548c After \u56de\u8c03\u4e4b\u95f4\u5171\u4eab\u6570\u636e\uff0c\u4e5f\u53ef\u4ee5\u7528\u4e8e\u4e2d\u95f4\u4ef6\u3001\u81ea\u5b9a\u4e49\u903b\u8f91\u7b49\u573a\u666f\u3002</p>"},{"location":"zh/callbacks/#_8","title":"\u6838\u5fc3\u65b9\u6cd5","text":"<pre><code>// \u8bbe\u7f6e\u72b6\u6001\u503c\nfunc (inv *Invocation) SetState(key string, value any)\n\n// \u83b7\u53d6\u72b6\u6001\u503c\uff0c\u8fd4\u56de\u503c\u548c\u662f\u5426\u5b58\u5728\nfunc (inv *Invocation) GetState(key string) (any, bool)\n\n// \u5220\u9664\u72b6\u6001\u503c\nfunc (inv *Invocation) DeleteState(key string)\n</code></pre>"},{"location":"zh/callbacks/#_9","title":"\u7279\u70b9","text":"<ul> <li>Invocation \u7ea7\u4f5c\u7528\u57df\uff1a\u72b6\u6001\u81ea\u52a8\u9650\u5b9a\u5728\u5355\u6b21 Invocation \u5185</li> <li>\u7ebf\u7a0b\u5b89\u5168\uff1a\u5185\u7f6e RWMutex \u4fdd\u62a4\uff0c\u652f\u6301\u5e76\u53d1\u8bbf\u95ee</li> <li>\u61d2\u521d\u59cb\u5316\uff1a\u9996\u6b21\u4f7f\u7528\u65f6\u624d\u5206\u914d\u5185\u5b58\uff0c\u8282\u7701\u8d44\u6e90</li> <li>\u6e05\u6670\u751f\u547d\u5468\u671f\uff1a\u4f7f\u7528\u5b8c\u6bd5\u540e\u53ef\u663e\u5f0f\u5220\u9664\uff0c\u907f\u514d\u5185\u5b58\u6cc4\u6f0f</li> <li>\u901a\u7528\u6027\u5f3a\uff1a\u4e0d\u9650\u4e8e callbacks\uff0c\u53ef\u7528\u4e8e\u4efb\u4f55 invocation \u7ea7\u522b\u7684\u72b6\u6001\u5b58\u50a8</li> </ul>"},{"location":"zh/callbacks/#_10","title":"\u547d\u540d\u7ea6\u5b9a","text":"<p>\u4e3a\u907f\u514d\u4e0d\u540c\u4f7f\u7528\u573a\u666f\u4e4b\u95f4\u7684\u952e\u51b2\u7a81\uff0c\u5efa\u8bae\u4f7f\u7528\u524d\u7f00\uff1a</p> <ul> <li>Agent \u56de\u8c03\uff1a<code>\"agent:xxx\"</code>\uff08\u5982 <code>\"agent:start_time\"</code>\uff09</li> <li>Model \u56de\u8c03\uff1a<code>\"model:xxx\"</code>\uff08\u5982 <code>\"model:start_time\"</code>\uff09</li> <li>Tool \u56de\u8c03\uff1a<code>\"tool:&lt;toolName&gt;:&lt;toolCallID&gt;:xxx\"</code>\uff08\u5982 <code>\"tool:calculator:call_abc123:start_time\"</code>\uff09<ul> <li>\u6ce8\u610f\uff1aTool \u56de\u8c03\u9700\u8981\u5305\u542b tool call ID \u4ee5\u652f\u6301\u5e76\u53d1\u8c03\u7528</li> </ul> </li> <li>\u4e2d\u95f4\u4ef6\uff1a<code>\"middleware:xxx\"</code>\uff08\u5982 <code>\"middleware:request_id\"</code>\uff09</li> <li>\u81ea\u5b9a\u4e49\u903b\u8f91\uff1a<code>\"custom:xxx\"</code>\uff08\u5982 <code>\"custom:user_context\"</code>\uff09</li> </ul>"},{"location":"zh/callbacks/#agent_2","title":"\u793a\u4f8b\uff1aAgent \u56de\u8c03\u8ba1\u65f6","text":"<pre><code>agentCallbacks := agent.NewCallbacks().\n  // BeforeAgentCallback\uff1a\u8bb0\u5f55\u5f00\u59cb\u65f6\u95f4\n  RegisterBeforeAgent(func(ctx context.Context, args *agent.BeforeAgentArgs) (*agent.BeforeAgentResult, error) {\n    args.Invocation.SetState(\"agent:start_time\", time.Now())\n    return nil, nil\n  }).\n  // AfterAgentCallback\uff1a\u8ba1\u7b97\u6267\u884c\u65f6\u957f\n  RegisterAfterAgent(func(ctx context.Context, args *agent.AfterAgentArgs) (*agent.AfterAgentResult, error) {\n    if startTimeVal, ok := args.Invocation.GetState(\"agent:start_time\"); ok {\n      startTime := startTimeVal.(time.Time)\n      duration := time.Since(startTime)\n      fmt.Printf(\"Agent execution took: %v\\n\", duration)\n      args.Invocation.DeleteState(\"agent:start_time\") // \u6e05\u7406\u72b6\u6001\n    }\n    return nil, nil\n  })\n</code></pre>"},{"location":"zh/callbacks/#model","title":"\u793a\u4f8b\uff1aModel \u56de\u8c03\u8ba1\u65f6","text":"<p>Model \u548c Tool \u56de\u8c03\u9700\u8981\u5148\u4ece context \u4e2d\u83b7\u53d6 Invocation\uff1a</p> <pre><code>modelCallbacks := model.NewCallbacks().\n  // BeforeModelCallback\uff1a\u8bb0\u5f55\u5f00\u59cb\u65f6\u95f4\n  RegisterBeforeModel(func(ctx context.Context, args *model.BeforeModelArgs) (*model.BeforeModelResult, error) {\n    if inv, ok := agent.InvocationFromContext(ctx); ok &amp;&amp; inv != nil {\n      inv.SetState(\"model:start_time\", time.Now())\n    }\n    return nil, nil\n  }).\n  // AfterModelCallback\uff1a\u8ba1\u7b97\u6267\u884c\u65f6\u957f\n  RegisterAfterModel(func(ctx context.Context, args *model.AfterModelArgs) (*model.AfterModelResult, error) {\n    if inv, ok := agent.InvocationFromContext(ctx); ok &amp;&amp; inv != nil {\n      if startTimeVal, ok := inv.GetState(\"model:start_time\"); ok {\n        startTime := startTimeVal.(time.Time)\n        duration := time.Since(startTime)\n        fmt.Printf(\"Model inference took: %v\\n\", duration)\n        inv.DeleteState(\"model:start_time\") // \u6e05\u7406\u72b6\u6001\n      }\n    }\n    return nil, nil\n  })\n</code></pre>"},{"location":"zh/callbacks/#tool","title":"\u793a\u4f8b\uff1aTool \u56de\u8c03\u8ba1\u65f6\uff08\u652f\u6301\u5e76\u53d1\u5de5\u5177\u8c03\u7528\uff09","text":"<p>\u5f53 LLM \u5728\u4e00\u6b21\u54cd\u5e94\u4e2d\u8fd4\u56de\u591a\u4e2a\u5de5\u5177\u8c03\u7528\uff08\u5305\u62ec\u540c\u4e00\u5de5\u5177\u7684\u591a\u6b21\u8c03\u7528\uff09\u65f6\uff0c\u6846\u67b6\u4f1a\u5e76\u53d1\u6267\u884c\u8fd9\u4e9b\u5de5\u5177\u3002\u4e3a\u4e86\u6b63\u786e\u8ffd\u8e2a\u6bcf\u4e2a\u5de5\u5177\u8c03\u7528\u7684\u72b6\u6001\uff0c\u9700\u8981\u4f7f\u7528 tool call ID \u6765\u533a\u5206\uff1a</p> <pre><code>toolCallbacks := tool.NewCallbacks().\n  // BeforeToolCallback\uff1a\u8bb0\u5f55\u5de5\u5177\u5f00\u59cb\u65f6\u95f4\n  RegisterBeforeTool(func(ctx context.Context, args *tool.BeforeToolArgs) (*tool.BeforeToolResult, error) {\n    if inv, ok := agent.InvocationFromContext(ctx); ok &amp;&amp; inv != nil {\n      // \u83b7\u53d6 tool call ID \u4ee5\u652f\u6301\u5e76\u53d1\u8c03\u7528\n      toolCallID, ok := tool.ToolCallIDFromContext(ctx)\n      if !ok || toolCallID == \"\" {\n        toolCallID = \"default\" // \u964d\u7ea7\u65b9\u6848\n      }\n\n      // \u4f7f\u7528 tool call ID \u6784\u5efa\u552f\u4e00\u952e\n      key := fmt.Sprintf(\"tool:%s:%s:start_time\", args.ToolName, toolCallID)\n      inv.SetState(key, time.Now())\n    }\n    return nil, nil\n  }).\n  // AfterToolCallback\uff1a\u8ba1\u7b97\u5de5\u5177\u6267\u884c\u65f6\u957f\n  RegisterAfterTool(func(ctx context.Context, args *tool.AfterToolArgs) (*tool.AfterToolResult, error) {\n    if inv, ok := agent.InvocationFromContext(ctx); ok &amp;&amp; inv != nil {\n      // \u4f7f\u7528\u76f8\u540c\u7684\u903b\u8f91\u83b7\u53d6 tool call ID\n      toolCallID, ok := tool.ToolCallIDFromContext(ctx)\n      if !ok || toolCallID == \"\" {\n        toolCallID = \"default\"\n      }\n\n      key := fmt.Sprintf(\"tool:%s:%s:start_time\", args.ToolName, toolCallID)\n      if startTimeVal, ok := inv.GetState(key); ok {\n        startTime := startTimeVal.(time.Time)\n        duration := time.Since(startTime)\n        fmt.Printf(\"Tool %s (call %s) took: %v\\n\", args.ToolName, toolCallID, duration)\n        inv.DeleteState(key) // \u6e05\u7406\u72b6\u6001\n      }\n    }\n    return nil, nil\n  })\n</code></pre> <p>\u5173\u952e\u70b9\uff1a</p> <ol> <li>\u83b7\u53d6 tool call ID\uff1a\u4f7f\u7528 <code>tool.ToolCallIDFromContext(ctx)</code> \u4ece context \u4e2d\u83b7\u53d6\u552f\u4e00\u7684\u5de5\u5177\u8c03\u7528 ID</li> <li>\u952e\u540d\u683c\u5f0f\uff1a<code>\"tool:&lt;toolName&gt;:&lt;toolCallID&gt;:&lt;key&gt;\"</code> \u786e\u4fdd\u5e76\u53d1\u8c03\u7528\u7684\u72b6\u6001\u9694\u79bb</li> <li>\u964d\u7ea7\u5904\u7406\uff1a\u5982\u679c\u83b7\u53d6\u4e0d\u5230 tool call ID\uff08\u65e7\u7248\u672c\u6216\u7279\u6b8a\u573a\u666f\uff09\uff0c\u4f7f\u7528 <code>\"default\"</code> \u4f5c\u4e3a\u964d\u7ea7</li> <li>\u4e00\u81f4\u6027\uff1aBefore \u548c After \u56de\u8c03\u5fc5\u987b\u4f7f\u7528\u76f8\u540c\u7684\u903b\u8f91\u83b7\u53d6 tool call ID</li> </ol> <p>\u8fd9\u6837\u53ef\u4ee5\u786e\u4fdd\u5f53 LLM \u540c\u65f6\u8c03\u7528 <code>calculator</code> \u591a\u6b21\uff08\u5982 <code>calculator(1,2)</code> \u548c <code>calculator(3,4)</code>\uff09\u65f6\uff0c\u6bcf\u4e2a\u8c03\u7528\u90fd\u6709\u72ec\u7acb\u7684\u8ba1\u65f6\u6570\u636e\u3002</p>"},{"location":"zh/callbacks/#_11","title":"\u5b8c\u6574\u793a\u4f8b","text":"<p>\u5b8c\u6574\u7684\u8ba1\u65f6\u793a\u4f8b\uff08\u5305\u542b OpenTelemetry \u96c6\u6210\uff09\u8bf7\u53c2\u8003\uff1a examples/callbacks/timer</p> <p>\u7528\u6237\u8ba4\u8bc1\u4e0e\u6388\u6743\u793a\u4f8b\uff08\u4f7f\u7528 Invocation State \u8fdb\u884c\u6743\u9650\u68c0\u67e5\u548c\u5ba1\u8ba1\u65e5\u5fd7\uff09\u8bf7\u53c2\u8003\uff1a examples/callbacks/auth</p>"},{"location":"zh/callbacks/#_12","title":"\u5168\u5c40\u56de\u8c03\u4e0e\u94fe\u5f0f\u6ce8\u518c","text":"<p>\u53ef\u901a\u8fc7\u94fe\u5f0f\u6ce8\u518c\u6784\u5efa\u53ef\u590d\u7528\u7684\u5168\u5c40\u56de\u8c03\u914d\u7f6e\u3002</p> <pre><code>_ = model.NewCallbacks().\n  RegisterBeforeModel(func(ctx context.Context, args *model.BeforeModelArgs) (*model.BeforeModelResult, error) {\n    fmt.Printf(\"Global BeforeModel: %d messages.\\n\", len(args.Request.Messages))\n    return nil, nil\n  }).\n  RegisterAfterModel(func(ctx context.Context, args *model.AfterModelArgs) (*model.AfterModelResult, error) {\n    fmt.Println(\"Global AfterModel: completed.\")\n    return nil, nil\n  })\n\n_ = tool.NewCallbacks().\n  RegisterBeforeTool(func(ctx context.Context, args *tool.BeforeToolArgs) (*tool.BeforeToolResult, error) {\n    fmt.Printf(\"Global BeforeTool: %s.\\n\", args.ToolName)\n    return nil, nil\n  }).\n  RegisterAfterTool(func(ctx context.Context, args *tool.AfterToolArgs) (*tool.AfterToolResult, error) {\n    fmt.Printf(\"Global AfterTool: %s done.\\n\", args.ToolName)\n    return nil, nil\n  })\n\n_ = agent.NewCallbacks().\n  RegisterBeforeAgent(func(ctx context.Context, args *agent.BeforeAgentArgs) (*agent.BeforeAgentResult, error) {\n    fmt.Printf(\"Global BeforeAgent: %s.\\n\", args.Invocation.AgentName)\n    return nil, nil\n  }).\n  RegisterAfterAgent(func(ctx context.Context, args *agent.AfterAgentArgs) (*agent.AfterAgentResult, error) {\n    fmt.Println(\"Global AfterAgent: completed.\")\n    return nil, nil\n  })\n</code></pre>"},{"location":"zh/callbacks/#mock","title":"Mock \u4e0e\u53c2\u6570\u4fee\u6539\u793a\u4f8b","text":"<p>Mock \u5de5\u5177\u7ed3\u679c\u5e76\u4e2d\u6b62\u540e\u7eed\u5de5\u5177\u8c03\u7528\uff1a</p> <pre><code>toolCallbacks := tool.NewCallbacks().\n  RegisterBeforeTool(func(ctx context.Context, args *tool.BeforeToolArgs) (*tool.BeforeToolResult, error) {\n    if args.ToolName == \"calculator\" &amp;&amp; args.Arguments != nil &amp;&amp; strings.Contains(string(args.Arguments), \"42\") {\n      return &amp;tool.BeforeToolResult{\n        CustomResult: calculatorResult{Operation: \"custom\", A: 42, B: 42, Result: 4242},\n      }, nil\n    }\n    return nil, nil\n  })\n</code></pre> <p>\u6267\u884c\u524d\u4fee\u6539\u53c2\u6570\uff08\u5e76\u5728\u53ef\u89c2\u6d4b/\u4e8b\u4ef6\u4e2d\u4f53\u73b0\uff09\uff1a</p> <pre><code>toolCallbacks := tool.NewCallbacks().\n  RegisterBeforeTool(func(ctx context.Context, args *tool.BeforeToolArgs) (*tool.BeforeToolResult, error) {\n    if args.Arguments != nil &amp;&amp; args.ToolName == \"calculator\" {\n      originalArgs := string(args.Arguments)\n      modifiedArgs := fmt.Sprintf(`{\"original\":%s,\"timestamp\":\"%d\"}`, originalArgs, time.Now().Unix())\n      args.Arguments = []byte(modifiedArgs)\n    }\n    return nil, nil\n  })\n</code></pre> <p>\u4ee5\u4e0a\u793a\u4f8b\u4e0e <code>examples/callbacks</code> \u53ef\u8fd0\u884c\u793a\u4f8b\u4fdd\u6301\u4e00\u81f4\u3002</p>"},{"location":"zh/callbacks/#_13","title":"\u8fd0\u884c\u793a\u4f8b","text":"<pre><code>cd examples/callbacks\nexport OPENAI_API_KEY=\"your-api-key\"\n\n# \u57fa\u672c\u8fd0\u884c\ngo run .\n\n# \u6307\u5b9a\u6a21\u578b\ngo run . -model gpt-4o-mini\n\n# \u5173\u95ed\u6d41\u5f0f\ngo run . -streaming=false\n</code></pre> <p>\u53ef\u5728\u65e5\u5fd7\u4e2d\u89c2\u5bdf Before/After \u56de\u8c03\u3001\u53c2\u6570\u4fee\u6539\u4e0e\u5de5\u5177\u8fd4\u56de\u4fe1\u606f\u3002</p>"},{"location":"zh/custom-agent/","title":"\u81ea\u5b9a\u4e49 Agent","text":"<p>\u5f53\u4f60\u4e0d\u60f3\u4e00\u5f00\u59cb\u5c31\u4e0a Graph \u6216\u591a Agent \u7f16\u6392\uff0c\u53c8\u9700\u8981\u628a LLM \u80fd\u529b\u201c\u5d4c\u5165\u5230\u201d\u5df2\u6709\u7684\u4e1a\u52a1\u6d41\u7a0b\u91cc\u65f6\uff0c\u53ef\u4ee5\u76f4\u63a5\u5b9e\u73b0 <code>agent.Agent</code> \u63a5\u53e3\uff0c\u81ea\u5df1\u638c\u63a7\u5206\u652f\u4e0e\u6d41\u7a0b\u3002</p> <p>\u672c\u6587\u5c55\u793a\u4e00\u4e2a\u6700\u5c0f\u53ef\u7528\u7684\u201c\u610f\u56fe\u5206\u6d41\u201d\u81ea\u5b9a\u4e49 Agent\uff1a</p> <ul> <li>\u5148\u7528 LLM \u505a\u610f\u56fe\u8bc6\u522b\uff1a<code>chitchat</code> \u6216 <code>task</code></li> <li>\u5982\u679c\u662f\u95f2\u804a\uff1a\u76f4\u63a5\u5bf9\u8bdd\u56de\u590d</li> <li>\u5982\u679c\u662f\u4efb\u52a1\uff1a\u7ed9\u51fa 3\u20135 \u6b65\u7684\u6267\u884c\u8ba1\u5212\uff08\u771f\u5b9e\u4e1a\u52a1\u91cc\u53ef\u7ee7\u7eed\u4e32\u5de5\u5177\u6216\u4e0b\u6e38\u903b\u8f91\uff09</li> </ul>"},{"location":"zh/custom-agent/#agent_1","title":"\u4f55\u65f6\u9009\u62e9\u81ea\u5b9a\u4e49 Agent","text":"<ul> <li>\u4e1a\u52a1\u6d41\u7a0b\u7b80\u5355\u4f46\u9700\u8981\u7cbe\u7ec6\u63a7\u5236\u5206\u652f\u3001\u6821\u9a8c\u3001\u515c\u5e95\u7b49</li> <li>\u4e0d\u9700\u8981\u53ef\u89c6\u5316\u7f16\u6392\u548c\u590d\u6742\u7f16\u961f\u534f\u4f5c\uff08\u540e\u7eed\u518d\u6f14\u8fdb\u5230 Chain/Parallel/Graph \u4e5f\u5f88\u81ea\u7136\uff09</li> </ul>"},{"location":"zh/custom-agent/#_1","title":"\u5b9e\u73b0\u8981\u70b9","text":"<p>\u5fc5\u987b\u5b9e\u73b0\u4ee5\u4e0b\u65b9\u6cd5\uff1a</p> <ul> <li><code>Run(ctx, *Invocation) (&lt;-chan *event.Event, error)</code>: \u6267\u884c\u4e1a\u52a1\u903b\u8f91\uff0c\u4ea7\u51fa\u4e8b\u4ef6\u6d41\uff08\u63a8\u8350\u8f6c\u53d1\u6a21\u578b\u6d41\u5f0f\u54cd\u5e94\u5230\u4e8b\u4ef6\uff09</li> <li><code>Tools() []tool.Tool</code>: \u8fd4\u56de\u53ef\u7528\u5de5\u5177\uff08\u65e0\u5de5\u5177\u53ef\u4ee5\u8fd4\u56de\u7a7a\u5207\u7247\uff09</li> <li><code>Info() Info</code>: \u8fd4\u56de Agent \u540d\u79f0\u4e0e\u63cf\u8ff0</li> <li><code>SubAgents()/FindSubAgent()</code>: \u65e0\u5b50 Agent \u8fd4\u56de\u7a7a/<code>nil</code></li> </ul> <p>\u6838\u5fc3\u6a21\u5f0f\uff1a</p> <p>1) \u4f7f\u7528 <code>invocation.Message</code> \u4f5c\u4e3a\u7528\u6237\u8f93\u5165</p> <p>2) \u901a\u8fc7 <code>invocation</code> \u643a\u5e26\u7684\u4e0a\u4e0b\u6587\uff08Session\u3001Callbacks\u3001Artifact \u7b49\uff09\u5171\u4eab\u6846\u67b6\u80fd\u529b</p> <p>3) \u8c03\u7528 <code>model.Model.GenerateContent(ctx, *model.Request)</code> \u83b7\u53d6\u6d41\u5f0f\u54cd\u5e94\uff1b\u7528 <code>event.NewResponseEvent(...)</code> \u9010\u6761\u8f6c\u53d1</p>"},{"location":"zh/custom-agent/#_2","title":"\u4ee3\u7801\u793a\u4f8b","text":"<p>\u5b8c\u6574\u793a\u4f8b\u89c1\uff1a<code>examples/customagent</code></p> <p>\u5173\u952e\u7247\u6bb5\uff08\u7b80\u5316\u7248\uff09\uff1a</p> <pre><code>type SimpleIntentAgent struct {\n    name        string\n    description string\n    model       model.Model\n}\n\nfunc (a *SimpleIntentAgent) Run(ctx context.Context, inv *agent.Invocation) (&lt;-chan *event.Event, error) {\n    out := make(chan *event.Event, 64)\n    go func() {\n        defer close(out)\n        intent := a.classifyIntent(ctx, inv) // chitchat | task\n        if intent == \"task\" {\n            a.replyTaskPlan(ctx, inv, out)\n        } else {\n            a.replyChitChat(ctx, inv, out)\n        }\n    }()\n    return out, nil\n}\n\nfunc (a *SimpleIntentAgent) replyChitChat(ctx context.Context, inv *agent.Invocation, out chan&lt;- *event.Event) {\n    req := &amp;model.Request{\n        Messages: []model.Message{\n            model.NewSystemMessage(\"Be concise and friendly.\"),\n            inv.Message,\n        },\n        GenerationConfig: model.GenerationConfig{Stream: true},\n    }\n    rspCh, _ := a.model.GenerateContent(ctx, req)\n    for rsp := range rspCh {\n        out &lt;- event.NewResponseEvent(inv.InvocationID, a.name, rsp)\n    }\n}\n</code></pre>"},{"location":"zh/custom-agent/#runner","title":"\u4e0e Runner \u914d\u5408","text":"<p>\u867d\u7136\u53ef\u4ee5\u76f4\u63a5\u8c03\u7528 Agent \u63a5\u53e3\uff0c\u4f46\u63a8\u8350\u7528 <code>Runner</code> \u6765\u6267\u884c\uff0c\u5b83\u4f1a\u81ea\u52a8\u7ba1\u7406\u4f1a\u8bdd\u4e0e\u4e8b\u4ef6\u5165\u5e93\uff0c\u63a5\u53e3\u4e5f\u66f4\u53cb\u597d\u3002</p> <p>\u793a\u4f8b\uff1a</p> <pre><code>// \u6784\u9020\u6a21\u578b\u4e0e\u81ea\u5b9a\u4e49 Agent\nm := openai.New(\"deepseek-chat\")\nag := NewSimpleIntentAgent(\"biz-agent\", \"intent branching\", m)\n\n// \u7528 Runner \u6267\u884c\nr := runner.NewRunner(\"customagent-app\", ag)\nch, err := r.Run(ctx, \"user-001\", \"session-001\", model.NewUserMessage(\"\u4f60\u597d\uff0c\u968f\u4fbf\u804a\u804a\"))\n// \u5904\u7406\u4e8b\u4ef6\u6d41...\n</code></pre>"},{"location":"zh/custom-agent/#_3","title":"\u8fd0\u884c\u793a\u4f8b\uff08\u4ea4\u4e92\u5f0f\uff09","text":"<pre><code>cd examples/customagent\nexport OPENAI_API_KEY=\"your_api_key\"\ngo run . -model deepseek-chat\n\n# \u8fdb\u5165\u4ea4\u4e92\u540e\u53ef\u4f7f\u7528\u547d\u4ee4\uff1a\n# /history  \u663e\u793a\u5bf9\u8bdd\u5386\u53f2\uff08\u901a\u8fc7\u63d0\u793a\uff09\n# /new      \u5f00\u542f\u65b0\u4f1a\u8bdd\n# /exit     \u9000\u51fa\n</code></pre>"},{"location":"zh/custom-agent/#_4","title":"\u6269\u5c55\u5efa\u8bae","text":"<ul> <li>\u5f15\u5165\u5de5\u5177\uff1a\u8fd4\u56de <code>[]tool.Tool</code>\uff0c\u5982 <code>function.NewFunctionTool(...)</code> \u4e32\u63a5\u6570\u636e\u5e93/HTTP/\u5185\u90e8\u670d\u52a1</li> <li>\u589e\u52a0\u6821\u9a8c\uff1a\u5728\u5206\u652f\u524d\u5148\u505a\u53c2\u6570\u6821\u9a8c\u3001\u98ce\u63a7\u3001\u5f00\u5173\u63a7\u5236</li> <li>\u6e10\u8fdb\u6f14\u8fdb\uff1a\u5f53 if-else \u8fc7\u591a\u6216\u9700\u8981\u534f\u4f5c\u65f6\uff0c\u5e73\u6ed1\u5207\u6362\u5230 <code>ChainAgent</code>/<code>ParallelAgent</code> \u6216 <code>Graph</code></li> </ul>"},{"location":"zh/dify/","title":"tRPC-Agent-Go Dify \u96c6\u6210\u6307\u5357","text":""},{"location":"zh/dify/#_1","title":"\u6982\u8ff0","text":"<p>tRPC-Agent-Go \u63d0\u4f9b\u4e86\u4e0e Dify \u5e73\u53f0\u7684\u5b8c\u6574\u96c6\u6210\u65b9\u6848\uff0c\u901a\u8fc7 <code>DifyAgent</code> \u7ec4\u4ef6\uff0c\u5f00\u53d1\u8005\u53ef\u4ee5\u8f7b\u677e\u8c03\u7528 Dify \u5e73\u53f0\u4e0a\u7684\u5de5\u4f5c\u6d41\uff08Workflow\uff09\u548c\u804a\u5929\u6d41\uff08Chatflow\uff09\uff0c\u5c06 Dify \u5f3a\u5927\u7684 AI \u80fd\u529b\u65e0\u7f1d\u96c6\u6210\u5230 tRPC-Agent-Go \u5e94\u7528\u4e2d\u3002</p>"},{"location":"zh/dify/#dify","title":"\u4ec0\u4e48\u662f Dify\uff1f","text":"<p>Dify \u662f\u4e00\u4e2a\u5f00\u6e90\u7684 LLM \u5e94\u7528\u5f00\u53d1\u5e73\u53f0\uff0c\u63d0\u4f9b\u4e86\u53ef\u89c6\u5316\u7684 AI \u5de5\u4f5c\u6d41\u7f16\u6392\u3001\u63d0\u793a\u8bcd\u5de5\u7a0b\u3001RAG\uff08\u68c0\u7d22\u589e\u5f3a\u751f\u6210\uff09\u7b49\u4f01\u4e1a\u7ea7\u529f\u80fd\u3002\u901a\u8fc7 Dify\uff0c\u60a8\u53ef\u4ee5\u5feb\u901f\u6784\u5efa\u548c\u90e8\u7f72\u590d\u6742\u7684 AI \u5e94\u7528\u3002</p>"},{"location":"zh/dify/#_2","title":"\u6838\u5fc3\u80fd\u529b","text":"<ul> <li>\u7edf\u4e00\u63a5\u53e3: \u50cf\u4f7f\u7528\u666e\u901a Agent \u4e00\u6837\u4f7f\u7528 Dify \u670d\u52a1\uff0c\u65e0\u9700\u4e86\u89e3 Dify API \u7ec6\u8282</li> <li>\u534f\u8bae\u8f6c\u6362: \u81ea\u52a8\u5904\u7406 tRPC-Agent-Go \u6d88\u606f\u683c\u5f0f\u4e0e Dify API \u7684\u8f6c\u6362</li> <li>\u6d41\u5f0f\u652f\u6301: \u652f\u6301\u6d41\u5f0f\u548c\u975e\u6d41\u5f0f\u4e24\u79cd\u54cd\u5e94\u6a21\u5f0f\uff0c\u5b9e\u73b0\u5b9e\u65f6\u4ea4\u4e92</li> <li>\u72b6\u6001\u4f20\u9012: \u652f\u6301\u5c06\u4f1a\u8bdd\u72b6\u6001\u4f20\u9012\u7ed9 Dify \u5de5\u4f5c\u6d41</li> <li>\u81ea\u5b9a\u4e49\u6269\u5c55: \u652f\u6301\u81ea\u5b9a\u4e49\u8bf7\u6c42\u548c\u54cd\u5e94\u8f6c\u6362\u5668</li> </ul>"},{"location":"zh/dify/#difyagent-dify","title":"DifyAgent\uff1a\u8c03\u7528 Dify \u670d\u52a1","text":""},{"location":"zh/dify/#_3","title":"\u6982\u5ff5\u4ecb\u7ecd","text":"<p><code>DifyAgent</code> \u662f tRPC-Agent-Go \u63d0\u4f9b\u7684\u7279\u6b8a Agent \u5b9e\u73b0\uff0c\u5b83\u5c06\u8bf7\u6c42\u8f6c\u53d1\u7ed9 Dify \u5e73\u53f0\u7684\u5de5\u4f5c\u6d41\u6216\u804a\u5929\u6d41\u670d\u52a1\u3002\u4ece\u4f7f\u7528\u8005\u89d2\u5ea6\u770b\uff0c<code>DifyAgent</code> \u5c31\u50cf\u4e00\u4e2a\u666e\u901a\u7684 Agent\uff0c\u4f46\u5b9e\u9645\u4e0a\u5b83\u662f Dify \u670d\u52a1\u7684\u672c\u5730\u4ee3\u7406\u3002</p> <p>\u7b80\u5355\u7406\u89e3\uff1a - \u6211\u6709\u4e00\u4e2a Dify \u5de5\u4f5c\u6d41/\u804a\u5929\u6d41 \u2192 \u901a\u8fc7 DifyAgent \u5728 tRPC-Agent-Go \u4e2d\u8c03\u7528 - \u50cf\u4f7f\u7528\u672c\u5730 Agent \u4e00\u6837\u4f7f\u7528 Dify \u7684 AI \u80fd\u529b</p>"},{"location":"zh/dify/#_4","title":"\u6838\u5fc3\u7279\u6027","text":"<ul> <li>\u900f\u660e\u4ee3\u7406: \u50cf\u4f7f\u7528\u672c\u5730 Agent \u4e00\u6837\u4f7f\u7528 Dify \u670d\u52a1</li> <li>\u81ea\u52a8\u534f\u8bae\u8f6c\u6362: \u81ea\u52a8\u5904\u7406\u6d88\u606f\u683c\u5f0f\u4e0e Dify API \u7684\u8f6c\u6362</li> <li>\u6d41\u5f0f\u652f\u6301: \u652f\u6301\u6d41\u5f0f\u548c\u975e\u6d41\u5f0f\u4e24\u79cd\u901a\u4fe1\u6a21\u5f0f</li> <li>\u72b6\u6001\u4f20\u9012: \u652f\u6301\u5c06\u4f1a\u8bdd\u72b6\u6001\u4f20\u9012\u7ed9 Dify \u5de5\u4f5c\u6d41</li> <li>\u81ea\u5b9a\u4e49\u5904\u7406: \u652f\u6301\u81ea\u5b9a\u4e49\u6d41\u5f0f\u54cd\u5e94\u5904\u7406\u5668</li> <li>\u7075\u6d3b\u914d\u7f6e: \u652f\u6301\u81ea\u5b9a\u4e49 Dify \u5ba2\u6237\u7aef\u914d\u7f6e</li> </ul>"},{"location":"zh/dify/#_5","title":"\u4f7f\u7528\u573a\u666f","text":"<ol> <li>\u4f01\u4e1a AI \u5e94\u7528: \u8c03\u7528\u4f01\u4e1a\u5185\u90e8\u90e8\u7f72\u7684 Dify \u670d\u52a1</li> <li>\u5de5\u4f5c\u6d41\u7f16\u6392: \u4f7f\u7528 Dify \u7684\u53ef\u89c6\u5316\u5de5\u4f5c\u6d41\u80fd\u529b\u5904\u7406\u590d\u6742\u4e1a\u52a1\u903b\u8f91</li> <li>RAG \u5e94\u7528: \u5229\u7528 Dify \u7684\u77e5\u8bc6\u5e93\u548c RAG \u80fd\u529b\u6784\u5efa\u667a\u80fd\u95ee\u7b54\u7cfb\u7edf</li> <li>\u591a\u6a21\u578b\u96c6\u6210: \u901a\u8fc7 Dify \u7edf\u4e00\u7ba1\u7406\u548c\u8c03\u7528\u591a\u4e2a LLM \u6a21\u578b</li> </ol>"},{"location":"zh/dify/#_6","title":"\u5feb\u901f\u5f00\u59cb","text":""},{"location":"zh/dify/#_7","title":"\u524d\u7f6e\u51c6\u5907","text":"<ol> <li> <p>\u83b7\u53d6 Dify \u670d\u52a1\u4fe1\u606f:</p> <ul> <li>Dify \u670d\u52a1\u5730\u5740\uff08\u5982 <code>https://api.dify.ai/v1</code>\uff09</li> <li>API Secret\uff08\u4ece Dify \u5e94\u7528\u8bbe\u7f6e\u4e2d\u83b7\u53d6\uff09</li> </ul> </li> <li> <p>\u5b89\u88c5\u4f9d\u8d56:    <pre><code>go get trpc.group/trpc-go/trpc-agent-go\ngo get github.com/cloudernative/dify-sdk-go\n</code></pre></p> </li> </ol>"},{"location":"zh/dify/#_8","title":"\u57fa\u672c\u7528\u6cd5","text":""},{"location":"zh/dify/#1","title":"\u793a\u4f8b 1\uff1a\u975e\u6d41\u5f0f\u5bf9\u8bdd","text":"<pre><code>package main\n\nimport (\n    \"context\"\n    \"fmt\"\n    \"log\"\n    \"time\"\n\n    \"github.com/cloudernative/dify-sdk-go\"\n    \"trpc.group/trpc-go/trpc-agent-go/agent\"\n    \"trpc.group/trpc-go/trpc-agent-go/agent/difyagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/model\"\n    \"trpc.group/trpc-go/trpc-agent-go/runner\"\n    \"trpc.group/trpc-go/trpc-agent-go/session/inmemory\"\n)\n\nfunc main() {\n    // 1. \u521b\u5efa DifyAgent\n    difyAgent, err := difyagent.New(\n        difyagent.WithBaseUrl(\"https://api.dify.ai/v1\"),\n        difyagent.WithName(\"dify-chat-assistant\"),\n        difyagent.WithDescription(\"Dify \u667a\u80fd\u52a9\u624b\"),\n        difyagent.WithEnableStreaming(false), // \u975e\u6d41\u5f0f\u6a21\u5f0f\n        difyagent.WithGetDifyClientFunc(func(invocation *agent.Invocation) (*dify.Client, error) {\n            return dify.NewClientWithConfig(&amp;dify.ClientConfig{\n                Host:             \"https://api.dify.ai/v1\",\n                DefaultAPISecret: \"your-api-secret\",\n                Timeout:          30 * time.Second,\n            }), nil\n        }),\n    )\n    if err != nil {\n        log.Fatal(err)\n    }\n\n    // 2. \u521b\u5efa\u4f1a\u8bdd\u670d\u52a1\n    sessionService := inmemory.NewSessionService()\n\n    // 3. \u521b\u5efa Runner\n    chatRunner := runner.NewRunner(\n        \"dify-runner\",\n        difyAgent,\n        runner.WithSessionService(sessionService),\n    )\n\n    // 4. \u53d1\u9001\u6d88\u606f\n    events, err := chatRunner.Run(\n        context.Background(),\n        \"user-1\",\n        \"session-1\",\n        model.NewUserMessage(\"\u4f60\u597d\uff0c\u8bf7\u4ecb\u7ecd\u4e00\u4e0b\u81ea\u5df1\"),\n    )\n    if err != nil {\n        log.Fatal(err)\n    }\n\n    // 5. \u5904\u7406\u54cd\u5e94\n    for event := range events {\n        if event.Response != nil &amp;&amp; len(event.Response.Choices) &gt; 0 {\n            if event.Response.Done {\n                fmt.Println(event.Response.Choices[0].Message.Content)\n            }\n        }\n    }\n}\n</code></pre>"},{"location":"zh/dify/#2","title":"\u793a\u4f8b 2\uff1a\u6d41\u5f0f\u5bf9\u8bdd","text":"<pre><code>package main\n\nimport (\n    \"context\"\n    \"fmt\"\n    \"log\"\n    \"time\"\n\n    \"github.com/cloudernative/dify-sdk-go\"\n    \"trpc.group/trpc-go/trpc-agent-go/agent\"\n    \"trpc.group/trpc-go/trpc-agent-go/agent/difyagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/model\"\n    \"trpc.group/trpc-go/trpc-agent-go/runner\"\n    \"trpc.group/trpc-go/trpc-agent-go/session/inmemory\"\n)\n\nfunc main() {\n    // \u81ea\u5b9a\u4e49\u6d41\u5f0f\u54cd\u5e94\u5904\u7406\u5668\n    streamingHandler := func(resp *model.Response) (string, error) {\n        if len(resp.Choices) &gt; 0 {\n            content := resp.Choices[0].Delta.Content\n            if content != \"\" {\n                fmt.Print(content) // \u5b9e\u65f6\u6253\u5370\n            }\n            return content, nil\n        }\n        return \"\", nil\n    }\n\n    // \u521b\u5efa\u652f\u6301\u6d41\u5f0f\u7684 DifyAgent\n    difyAgent, err := difyagent.New(\n        difyagent.WithBaseUrl(\"https://api.dify.ai/v1\"),\n        difyagent.WithName(\"dify-streaming-assistant\"),\n        difyagent.WithDescription(\"Dify \u6d41\u5f0f\u52a9\u624b\"),\n        difyagent.WithEnableStreaming(true), // \u542f\u7528\u6d41\u5f0f\n        difyagent.WithStreamingRespHandler(streamingHandler),\n        difyagent.WithStreamingChannelBufSize(2048), // \u6d41\u5f0f\u7f13\u51b2\u533a\u5927\u5c0f\n        difyagent.WithGetDifyClientFunc(func(invocation *agent.Invocation) (*dify.Client, error) {\n            return dify.NewClientWithConfig(&amp;dify.ClientConfig{\n                Host:             \"https://api.dify.ai/v1\",\n                DefaultAPISecret: \"your-api-secret\",\n                Timeout:          60 * time.Second,\n            }), nil\n        }),\n    )\n    if err != nil {\n        log.Fatal(err)\n    }\n\n    // \u521b\u5efa\u4f1a\u8bdd\u670d\u52a1\u548c Runner\n    sessionService := inmemory.NewSessionService()\n    chatRunner := runner.NewRunner(\n        \"dify-streaming-runner\",\n        difyAgent,\n        runner.WithSessionService(sessionService),\n    )\n\n    // \u53d1\u9001\u6d88\u606f\n    fmt.Print(\"\ud83e\udd16 \u52a9\u624b: \")\n    events, err := chatRunner.Run(\n        context.Background(),\n        \"user-1\",\n        \"session-1\",\n        model.NewUserMessage(\"\u8bf7\u5199\u4e00\u4e2a\u5173\u4e8e\u673a\u5668\u4eba\u5b66\u4e60\u7ed8\u753b\u7684\u77ed\u6545\u4e8b\"),\n    )\n    if err != nil {\n        log.Fatal(err)\n    }\n\n    // \u5904\u7406\u6d41\u5f0f\u54cd\u5e94\n    for event := range events {\n        if event.Error != nil {\n            log.Printf(\"Error: %s\", event.Error.Message)\n        }\n        // streamingHandler \u4f1a\u81ea\u52a8\u5904\u7406\u5e76\u6253\u5370\u5185\u5bb9\n    }\n    fmt.Println() // \u6362\u884c\n}\n</code></pre>"},{"location":"zh/dify/#_9","title":"\u914d\u7f6e\u9009\u9879\u8be6\u89e3","text":""},{"location":"zh/dify/#_10","title":"\u57fa\u7840\u914d\u7f6e","text":"\u914d\u7f6e\u9879 \u8bf4\u660e \u5fc5\u586b <code>WithBaseUrl(url)</code> Dify \u670d\u52a1\u5730\u5740 \u5426 <code>WithName(name)</code> Agent \u540d\u79f0 \u662f <code>WithDescription(desc)</code> Agent \u63cf\u8ff0 \u5426"},{"location":"zh/dify/#_11","title":"\u5ba2\u6237\u7aef\u914d\u7f6e","text":"\u914d\u7f6e\u9879 \u8bf4\u660e \u9ed8\u8ba4\u503c <code>WithGetDifyClientFunc(fn)</code> \u81ea\u5b9a\u4e49 Dify \u5ba2\u6237\u7aef\u521b\u5efa\u51fd\u6570 \u4f7f\u7528\u9ed8\u8ba4\u914d\u7f6e"},{"location":"zh/dify/#_12","title":"\u6d41\u5f0f\u914d\u7f6e","text":"\u914d\u7f6e\u9879 \u8bf4\u660e \u9ed8\u8ba4\u503c <code>WithEnableStreaming(bool)</code> \u662f\u5426\u542f\u7528\u6d41\u5f0f\u6a21\u5f0f false <code>WithStreamingChannelBufSize(size)</code> \u6d41\u5f0f\u7f13\u51b2\u533a\u5927\u5c0f 1024 <code>WithStreamingRespHandler(handler)</code> \u81ea\u5b9a\u4e49\u6d41\u5f0f\u54cd\u5e94\u5904\u7406\u5668 \u9ed8\u8ba4\u5904\u7406\u5668"},{"location":"zh/dify/#_13","title":"\u9ad8\u7ea7\u914d\u7f6e","text":"\u914d\u7f6e\u9879 \u8bf4\u660e <code>WithCustomEventConverter(converter)</code> \u81ea\u5b9a\u4e49\u4e8b\u4ef6\u8f6c\u6362\u5668 <code>WithCustomRequestConverter(converter)</code> \u81ea\u5b9a\u4e49\u8bf7\u6c42\u8f6c\u6362\u5668 <code>WithTransferStateKey(keys...)</code> \u8bbe\u7f6e\u9700\u8981\u4f20\u9012\u7684\u4f1a\u8bdd\u72b6\u6001\u952e"},{"location":"zh/dify/#_14","title":"\u9ad8\u7ea7\u7528\u6cd5","text":""},{"location":"zh/dify/#_15","title":"\u81ea\u5b9a\u4e49\u72b6\u6001\u4f20\u9012","text":"<p>\u5c06\u4f1a\u8bdd\u72b6\u6001\u4f20\u9012\u7ed9 Dify \u5de5\u4f5c\u6d41\uff1a</p> <pre><code>difyAgent, _ := difyagent.New(\n    difyagent.WithName(\"stateful-agent\"),\n    // \u6307\u5b9a\u9700\u8981\u4f20\u9012\u7684\u72b6\u6001\u952e\n    difyagent.WithTransferStateKey(\"user_profile\", \"conversation_context\"),\n    // ... \u5176\u4ed6\u914d\u7f6e\n)\n\n// \u5728 Runner \u4e2d\u8bbe\u7f6e\u72b6\u6001\nrunner.Run(\n    ctx,\n    userID,\n    sessionID,\n    model.NewUserMessage(\"\u67e5\u8be2\u6211\u7684\u8ba2\u5355\"),\n    // \u8fd9\u4e9b\u72b6\u6001\u4f1a\u88ab\u4f20\u9012\u5230 Dify\n    runner.WithRuntimeState(map[string]interface{}{\n        \"user_profile\": map[string]string{\n            \"name\": \"\u5f20\u4e09\",\n            \"vip_level\": \"gold\",\n        },\n        \"conversation_context\": \"\u6b63\u5728\u8ba8\u8bba\u8ba2\u5355\u95ee\u9898\",\n    }),\n)\n</code></pre>"},{"location":"zh/dify/#_16","title":"\u81ea\u5b9a\u4e49\u54cd\u5e94\u5904\u7406","text":"<p>\u5b9e\u73b0\u81ea\u5b9a\u4e49\u6d41\u5f0f\u54cd\u5e94\u5904\u7406\u5668\uff1a</p> <pre><code>// \u81ea\u5b9a\u4e49\u5904\u7406\u5668\uff1a\u8fc7\u6ee4\u654f\u611f\u8bcd\u3001\u683c\u5f0f\u5316\u8f93\u51fa\u7b49\ncustomHandler := func(resp *model.Response) (string, error) {\n    if len(resp.Choices) == 0 {\n        return \"\", nil\n    }\n\n    content := resp.Choices[0].Delta.Content\n\n    // 1. \u8fc7\u6ee4\u654f\u611f\u8bcd\n    filtered := filterSensitiveWords(content)\n\n    // 2. \u5b9e\u65f6\u65e5\u5fd7\u8bb0\u5f55\n    log.Printf(\"Received chunk: %s\", filtered)\n\n    // 3. \u5b9e\u65f6\u663e\u793a\n    fmt.Print(filtered)\n\n    // \u8fd4\u56de\u5904\u7406\u540e\u7684\u5185\u5bb9\uff08\u4f1a\u88ab\u805a\u5408\u5230\u6700\u7ec8\u54cd\u5e94\uff09\n    return filtered, nil\n}\n\ndifyAgent, _ := difyagent.New(\n    difyagent.WithStreamingRespHandler(customHandler),\n    // ... \u5176\u4ed6\u914d\u7f6e\n)\n</code></pre>"},{"location":"zh/dify/#_17","title":"\u81ea\u5b9a\u4e49\u8bf7\u6c42\u8f6c\u6362\u5668","text":"<p>\u5b9e\u73b0\u81ea\u5b9a\u4e49\u7684\u8bf7\u6c42\u8f6c\u6362\u903b\u8f91\uff1a</p> <pre><code>type MyRequestConverter struct{}\n\nfunc (c *MyRequestConverter) ConvertToDifyRequest(\n    ctx context.Context,\n    invocation *agent.Invocation,\n    isStream bool,\n) (*dify.ChatMessageRequest, error) {\n    // \u81ea\u5b9a\u4e49\u8bf7\u6c42\u6784\u5efa\u903b\u8f91\n    req := &amp;dify.ChatMessageRequest{\n        Query:           extractQuery(invocation),\n        ResponseMode:    getResponseMode(isStream),\n        ConversationID:  getConversationID(invocation),\n        User:            invocation.RunOptions.UserID,\n        Inputs:          customInputs(invocation),\n    }\n    return req, nil\n}\n\ndifyAgent, _ := difyagent.New(\n    difyagent.WithCustomRequestConverter(&amp;MyRequestConverter{}),\n    // ... \u5176\u4ed6\u914d\u7f6e\n)\n</code></pre>"},{"location":"zh/dify/#_18","title":"\u81ea\u5b9a\u4e49\u4e8b\u4ef6\u8f6c\u6362\u5668","text":"<p>\u5b9e\u73b0\u81ea\u5b9a\u4e49\u7684\u54cd\u5e94\u8f6c\u6362\u903b\u8f91\uff1a</p> <pre><code>type MyEventConverter struct{}\n\nfunc (c *MyEventConverter) ConvertToEvent(\n    resp *dify.ChatMessageResponse,\n    agentName string,\n    invocation *agent.Invocation,\n) *event.Event {\n    // \u81ea\u5b9a\u4e49\u4e8b\u4ef6\u8f6c\u6362\u903b\u8f91\n    return event.New(\n        invocation.InvocationID,\n        agentName,\n        event.WithResponse(&amp;model.Response{\n            Done: true,\n            Choices: []model.Choice{{\n                Message: model.Message{\n                    Role:    model.RoleAssistant,\n                    Content: customFormat(resp.Answer),\n                },\n            }},\n        }),\n    )\n}\n\nfunc (c *MyEventConverter) ConvertStreamingToEvent(\n    resp *dify.ChatMessageStreamResponse,\n    agentName string,\n    invocation *agent.Invocation,\n) *event.Event {\n    // \u81ea\u5b9a\u4e49\u6d41\u5f0f\u4e8b\u4ef6\u8f6c\u6362\u903b\u8f91\n    // ...\n}\n\ndifyAgent, _ := difyagent.New(\n    difyagent.WithCustomEventConverter(&amp;MyEventConverter{}),\n    // ... \u5176\u4ed6\u914d\u7f6e\n)\n</code></pre>"},{"location":"zh/dify/#_19","title":"\u73af\u5883\u53d8\u91cf\u914d\u7f6e","text":"<p>\u63a8\u8350\u4f7f\u7528\u73af\u5883\u53d8\u91cf\u7ba1\u7406\u654f\u611f\u4fe1\u606f\uff1a</p> <pre><code>export DIFY_BASE_URL=\"https://api.dify.ai/v1\"\nexport DIFY_API_SECRET=\"app-xxxxxxxxxx\"\n</code></pre> <p>\u4ee3\u7801\u4e2d\u8bfb\u53d6\uff1a</p> <pre><code>import \"os\"\n\ndifyAgent, _ := difyagent.New(\n    difyagent.WithGetDifyClientFunc(func(invocation *agent.Invocation) (*dify.Client, error) {\n        return dify.NewClientWithConfig(&amp;dify.ClientConfig{\n            Host:             os.Getenv(\"DIFY_BASE_URL\"),\n            DefaultAPISecret: os.Getenv(\"DIFY_API_SECRET\"),\n            Timeout:          30 * time.Second,\n        }), nil\n    }),\n    // ... \u5176\u4ed6\u914d\u7f6e\n)\n</code></pre>"},{"location":"zh/dify/#_20","title":"\u9519\u8bef\u5904\u7406","text":""},{"location":"zh/dify/#_21","title":"\u5e38\u89c1\u9519\u8bef\u53ca\u89e3\u51b3\u65b9\u6848","text":"\u9519\u8bef \u539f\u56e0 \u89e3\u51b3\u65b9\u6848 <code>agent name is required</code> \u672a\u8bbe\u7f6e Agent \u540d\u79f0 \u4f7f\u7528 <code>WithName()</code> \u8bbe\u7f6e\u540d\u79f0 <code>request converter not set</code> \u672a\u8bbe\u7f6e\u8bf7\u6c42\u8f6c\u6362\u5668 \u4f7f\u7528\u9ed8\u8ba4\u8f6c\u6362\u5668\u6216\u81ea\u5b9a\u4e49 <code>Dify request failed</code> Dify API \u8c03\u7528\u5931\u8d25 \u68c0\u67e5\u7f51\u7edc\u3001API Secret\u3001\u670d\u52a1\u5730\u5740 <code>event converter not set</code> \u672a\u8bbe\u7f6e\u4e8b\u4ef6\u8f6c\u6362\u5668 \u4f7f\u7528\u9ed8\u8ba4\u8f6c\u6362\u5668\u6216\u81ea\u5b9a\u4e49"},{"location":"zh/dify/#_22","title":"\u9519\u8bef\u4e8b\u4ef6\u5904\u7406","text":"<pre><code>for event := range events {\n    // \u68c0\u67e5\u9519\u8bef\n    if event.Error != nil {\n        log.Printf(\"Error: %s\", event.Error.Message)\n        continue\n    }\n\n    // \u68c0\u67e5\u54cd\u5e94\u9519\u8bef\n    if event.Response != nil &amp;&amp; event.Response.Error != nil {\n        log.Printf(\"Response Error: %s\", event.Response.Error.Message)\n        continue\n    }\n\n    // \u6b63\u5e38\u5904\u7406\n    // ...\n}\n</code></pre>"},{"location":"zh/dify/#_23","title":"\u6700\u4f73\u5b9e\u8df5","text":""},{"location":"zh/dify/#1_1","title":"1. \u8d85\u65f6\u914d\u7f6e","text":"<p>\u6839\u636e Dify \u5de5\u4f5c\u6d41\u7684\u590d\u6742\u5ea6\u8bbe\u7f6e\u5408\u7406\u7684\u8d85\u65f6\u65f6\u95f4\uff1a</p> <pre><code>difyagent.WithGetDifyClientFunc(func(invocation *agent.Invocation) (*dify.Client, error) {\n    return dify.NewClientWithConfig(&amp;dify.ClientConfig{\n        Host:             baseURL,\n        DefaultAPISecret: apiSecret,\n        Timeout:          60 * time.Second, // \u590d\u6742\u5de5\u4f5c\u6d41\u4f7f\u7528\u66f4\u957f\u8d85\u65f6\n    }), nil\n})\n</code></pre>"},{"location":"zh/dify/#2_1","title":"2. \u6d41\u5f0f\u7f13\u51b2\u533a\u5927\u5c0f","text":"<p>\u6839\u636e\u9884\u671f\u54cd\u5e94\u957f\u5ea6\u8c03\u6574\u7f13\u51b2\u533a\uff1a</p> <pre><code>// \u77ed\u54cd\u5e94\ndifyagent.WithStreamingChannelBufSize(512)\n\n// \u957f\u54cd\u5e94\uff08\u5982\u751f\u6210\u6587\u7ae0\uff09\ndifyagent.WithStreamingChannelBufSize(4096)\n</code></pre>"},{"location":"zh/dify/#3","title":"3. \u9519\u8bef\u91cd\u8bd5","text":"<p>\u5728\u751f\u4ea7\u73af\u5883\u4e2d\u5b9e\u73b0\u91cd\u8bd5\u673a\u5236\uff1a</p> <pre><code>func runWithRetry(runner *runner.Runner, maxRetries int) error {\n    for i := 0; i &lt; maxRetries; i++ {\n        events, err := runner.Run(ctx, userID, sessionID, msg)\n        if err == nil {\n            // \u5904\u7406 events\n            return nil\n        }\n        log.Printf(\"Retry %d/%d: %v\", i+1, maxRetries, err)\n        time.Sleep(time.Second * time.Duration(i+1))\n    }\n    return fmt.Errorf(\"max retries exceeded\")\n}\n</code></pre>"},{"location":"zh/dify/#4","title":"4. \u4f1a\u8bdd\u7ba1\u7406","text":"<p>\u6b63\u786e\u7ba1\u7406\u4f1a\u8bdd ID \u4ee5\u7ef4\u6301\u5bf9\u8bdd\u4e0a\u4e0b\u6587\uff1a</p> <pre><code>// \u6bcf\u4e2a\u7528\u6237\u6bcf\u6b21\u5bf9\u8bdd\u4f7f\u7528\u552f\u4e00\u7684 session ID\nsessionID := fmt.Sprintf(\"user-%s-conv-%d\", userID, time.Now().Unix())\n\n// \u6216\u4f7f\u7528\u6301\u4e45\u5316\u7684 session ID \u7ef4\u6301\u957f\u671f\u5bf9\u8bdd\nsessionID := getUserSessionID(userID)\n</code></pre>"},{"location":"zh/dify/#_24","title":"\u793a\u4f8b\u4ee3\u7801","text":"<p>\u5b8c\u6574\u793a\u4f8b\u4ee3\u7801\u4f4d\u4e8e\u9879\u76ee\u7684 <code>examples/dify/</code> \u76ee\u5f55\uff1a</p> <ul> <li><code>basic_chat/</code>: \u57fa\u7840\u975e\u6d41\u5f0f\u5bf9\u8bdd\u793a\u4f8b</li> <li><code>streaming_chat/</code>: \u6d41\u5f0f\u5bf9\u8bdd\u793a\u4f8b</li> <li><code>advanced_usage/</code>: \u9ad8\u7ea7\u7528\u6cd5\u793a\u4f8b\uff08\u72b6\u6001\u4f20\u9012\u3001\u81ea\u5b9a\u4e49\u8f6c\u6362\u5668\u7b49\uff09</li> </ul> <p>\u8fd0\u884c\u793a\u4f8b\uff1a</p> <pre><code>cd examples/dify/basic_chat\nexport DIFY_BASE_URL=\"https://api.dify.ai/v1\"\nexport DIFY_API_SECRET=\"your-api-secret\"\ngo run main.go\n</code></pre>"},{"location":"zh/dify/#_25","title":"\u5e38\u89c1\u95ee\u9898","text":"<p>Q: DifyAgent \u548c A2AAgent \u6709\u4ec0\u4e48\u533a\u522b\uff1f</p> <p>A:  - <code>DifyAgent</code>: \u4e13\u95e8\u7528\u4e8e\u8c03\u7528 Dify \u5e73\u53f0\u670d\u52a1\uff0c\u4f7f\u7528 Dify API - <code>A2AAgent</code>: \u7528\u4e8e\u8c03\u7528\u7b26\u5408 A2A \u534f\u8bae\u7684\u8fdc\u7a0b Agent \u670d\u52a1 - \u9009\u62e9\u53d6\u51b3\u4e8e\u540e\u7aef\u670d\u52a1\u7c7b\u578b</p> <p>Q: \u5982\u4f55\u5728\u4f01\u4e1a\u5185\u7f51\u4f7f\u7528\u81ea\u90e8\u7f72\u7684 Dify\uff1f</p> <p>A: \u53ea\u9700\u5c06 <code>WithBaseUrl()</code> \u8bbe\u7f6e\u4e3a\u5185\u7f51 Dify \u670d\u52a1\u5730\u5740\u5373\u53ef\uff0c\u4f8b\u5982\uff1a <pre><code>difyagent.WithBaseUrl(\"http://dify.internal.company.com/v1\")\n</code></pre></p> <p>Q: \u6d41\u5f0f\u548c\u975e\u6d41\u5f0f\u6a21\u5f0f\u5982\u4f55\u9009\u62e9\uff1f</p> <p>A: - \u6d41\u5f0f: \u9002\u5408\u957f\u6587\u672c\u751f\u6210\u3001\u9700\u8981\u5b9e\u65f6\u53cd\u9988\u7684\u573a\u666f - \u975e\u6d41\u5f0f: \u9002\u5408\u77ed\u54cd\u5e94\u3001\u6279\u91cf\u5904\u7406\u7684\u573a\u666f</p> <p>Q: \u5982\u4f55\u8c03\u8bd5 Dify \u8bf7\u6c42\uff1f</p> <p>A: \u53ef\u4ee5\u5b9e\u73b0\u81ea\u5b9a\u4e49\u8bf7\u6c42\u8f6c\u6362\u5668\uff0c\u5728\u5176\u4e2d\u6dfb\u52a0\u65e5\u5fd7\uff1a <pre><code>func (c *MyConverter) ConvertToDifyRequest(...) (*dify.ChatMessageRequest, error) {\n    req := &amp;dify.ChatMessageRequest{...}\n    log.Printf(\"Dify Request: %+v\", req)\n    return req, nil\n}\n</code></pre></p>"},{"location":"zh/dify/#_26","title":"\u76f8\u5173\u8d44\u6e90","text":"<ul> <li>Dify \u5b98\u65b9\u6587\u6863</li> <li>Dify SDK Go</li> <li>tRPC-Agent-Go \u6587\u6863</li> <li>A2A \u96c6\u6210\u6307\u5357</li> </ul>"},{"location":"zh/ecosystem/","title":"tRPC-Agent-Go \u751f\u6001\u5efa\u8bbe\u6307\u5357","text":"<p>\u672c\u6587\u6863\u5206\u6790 tRPC-Agent-Go \u6846\u67b6\u4e2d\u9700\u8981\u751f\u6001\u5efa\u8bbe\u7684\u6a21\u5757\uff0c\u8bf4\u660e\u9700\u8981\u5b9e\u73b0\u7684\u63a5\u53e3\uff0c\u5e76\u63d0\u4f9b\u8d21\u732e\u6307\u5bfc\u3002</p> <p>\u6ce8\u610f\uff1a\u6240\u6709\u5171\u5efa\u7ec4\u4ef6\u90fd\u76f4\u63a5\u8d21\u732e\u5230 GitHub \u5f00\u6e90\u4ed3\u5e93\u7684\u5bf9\u5e94\u76ee\u5f55\u4e0b\uff0c\u6bd4\u5982 <code>model/somemodel</code>\u3001<code>tool/sometool</code>\u3001<code>agent/someagent</code> \u7b49\u3002</p> <p>\u8d21\u732e\u65f6\u5728\u5bf9\u5e94\u7684\u8d21\u732e\u6a21\u5757\u76ee\u5f55\u4e0b\u65b0\u5efa\u5408\u7406\u547d\u540d\u7684\u5b50\u6587\u4ef6\u5939\uff0c\u7136\u540e\u5b9e\u73b0\u5bf9\u5e94\u6a21\u5757\u63a5\u53e3\uff0c\u5e76\u63d0\u4f9b\u4e30\u5bcc\u7684\u6d4b\u8bd5\u7528\u4f8b\u4ee5\u53ca example \u793a\u4f8b\u3002</p>"},{"location":"zh/ecosystem/#_1","title":"\u751f\u6001\u5efa\u8bbe\u6a21\u5757\u5206\u6790","text":""},{"location":"zh/ecosystem/#1-agent","title":"1. Agent \u751f\u6001\u5316","text":"<p>\u76ee\u6807\uff1a \u5c01\u88c5\u548c\u9002\u914d\u7b2c\u4e09\u65b9 Agent \u6846\u67b6</p> <p>\u63a5\u53e3\u5b9a\u4e49\uff1a agent.Agent</p> <p>\u73b0\u6709\u5b9e\u73b0\u53c2\u8003\uff1a LLMAgent</p> <p>\u5b9e\u73b0\u6ce8\u610f\u4e8b\u9879\uff1a</p> <ul> <li><code>Run</code> \u65b9\u6cd5\u5fc5\u987b\u8fd4\u56de\u4e8b\u4ef6\u901a\u9053\uff0c\u652f\u6301\u6d41\u5f0f\u54cd\u5e94</li> <li><code>Tools</code> \u65b9\u6cd5\u8fd4\u56de Agent \u53ef\u7528\u7684\u5de5\u5177\u5217\u8868</li> <li><code>Info</code> \u65b9\u6cd5\u63d0\u4f9b Agent \u7684\u57fa\u672c\u4fe1\u606f</li> <li><code>SubAgents</code> \u548c <code>FindSubAgent</code> \u652f\u6301 Agent \u7ec4\u5408\u6a21\u5f0f</li> <li>\u53c2\u8003 LLMAgent \u5b9e\u73b0\uff0c\u4e86\u89e3\u4e8b\u4ef6\u5904\u7406\u548c\u9519\u8bef\u5904\u7406\u673a\u5236</li> </ul> <p>\u5b9e\u73b0\u793a\u4f8b\uff1a</p> <pre><code>package langchain\n\nimport (\n    \"context\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/agent\"\n    \"trpc.group/trpc-go/trpc-agent-go/event\"\n    \"trpc.group/trpc-go/trpc-agent-go/tool\"\n)\n\ntype LangChainAdapter struct {\n    config *Config\n    client *langchain.Client\n}\n\nfunc New(config *Config) (agent.Agent, error) {\n    client := langchain.NewClient(config.Endpoint, config.APIKey)\n\n    return &amp;LangChainAdapter{\n        config: config,\n        client: client,\n    }, nil\n}\n\nfunc (a *LangChainAdapter) Run(ctx context.Context, invocation *agent.Invocation) (&lt;-chan *event.Event, error) {\n    events := make(chan *event.Event)\n\n    go func() {\n        defer close(events)\n\n        response, err := a.client.Call(ctx, invocation.Messages)\n        if err != nil {\n            events &lt;- &amp;event.Event{\n                Type: event.TypeError,\n                Error: err,\n            }\n            return\n        }\n\n        events &lt;- &amp;event.Event{\n            Type: event.TypeResponse,\n            Response: &amp;model.Response{\n                Content: response.Content,\n            },\n        }\n    }()\n\n    return events, nil\n}\n\nfunc (a *LangChainAdapter) Tools() []tool.Tool {\n    return a.config.Tools\n}\n\nfunc (a *LangChainAdapter) Info() agent.Info {\n    return agent.Info{\n        Name:        \"langchain-adapter\",\n        Description: \"LangChain framework adapter\",\n    }\n}\n\nfunc (a *LangChainAdapter) SubAgents() []agent.Agent {\n    return nil\n}\n\nfunc (a *LangChainAdapter) FindSubAgent(name string) agent.Agent {\n    return nil\n}\n</code></pre> <p>\u53ef\u4ee5\u96c6\u6210\u5f00\u6e90\u7ec4\u4ef6\u793a\u4f8b\uff1a</p> <ul> <li>LangChain \u9002\u914d\u5668</li> <li>LangGraph \u9002\u914d\u5668</li> </ul> <p>\u8d21\u732e\u65b9\u5f0f\uff1a</p> <ul> <li>\u5728\u5bf9\u5e94\u76ee\u5f55\u4e0b\u521b\u5efa\u7ec4\u4ef6\uff08\u65b0\u5efa\u4e00\u4e2a\u5bf9\u5e94\u7ec4\u4ef6\u540d\u79f0\u7684\u5b50\u76ee\u5f55\uff09</li> <li>\u76f4\u63a5\u8d21\u732e\u5230 <code>https://github.com/trpc-group/trpc-agent-go/agent/</code></li> </ul>"},{"location":"zh/ecosystem/#2-model","title":"2. \u6a21\u578b\uff08Model\uff09\u751f\u6001\u5316","text":"<p>\u76ee\u6807\uff1a \u652f\u6301\u66f4\u591a\u6a21\u578b\u63d0\u4f9b\u5546</p> <p>\u63a5\u53e3\u5b9a\u4e49\uff1a model.Model</p> <p>\u73b0\u6709\u5b9e\u73b0\u53c2\u8003\uff1a OpenAI Model</p> <p>\u5b9e\u73b0\u6ce8\u610f\u4e8b\u9879\uff1a</p> <ul> <li><code>GenerateContent</code> \u65b9\u6cd5\u5fc5\u987b\u652f\u6301\u6d41\u5f0f\u54cd\u5e94\uff0c\u8fd4\u56de\u4e8b\u4ef6\u901a\u9053</li> <li>\u533a\u5206\u7cfb\u7edf\u7ea7\u9519\u8bef\uff08\u8fd4\u56de error\uff09\u548c API \u7ea7\u9519\u8bef\uff08Response.Error\uff09</li> <li>\u5b9e\u73b0 <code>Info</code> \u65b9\u6cd5\u63d0\u4f9b\u6a21\u578b\u57fa\u672c\u4fe1\u606f</li> <li>\u53c2\u8003 OpenAI \u5b9e\u73b0\uff0c\u4e86\u89e3\u8bf7\u6c42\u6784\u5efa\u548c\u54cd\u5e94\u5904\u7406</li> <li>\u652f\u6301\u4e0a\u4e0b\u6587\u53d6\u6d88\u548c\u8d85\u65f6\u63a7\u5236</li> </ul> <p>\u5b9e\u73b0\u793a\u4f8b\uff1a</p> <pre><code>package gemini\n\nimport (\n    \"context\"\n    \"fmt\"\n    \"trpc.group/trpc-go/trpc-agent-go/model\"\n)\n\ntype GeminiModel struct {\n    config *Config\n    client *gemini.Client\n}\n\nfunc New(config *Config) (model.Model, error) {\n    client := gemini.NewClient(config.APIKey)\n\n    return &amp;GeminiModel{\n        config: config,\n        client: client,\n    }, nil\n}\n\nfunc (g *GeminiModel) GenerateContent(ctx context.Context, request *model.Request) (&lt;-chan *model.Response, error) {\n    if request == nil {\n        return nil, fmt.Errorf(\"request cannot be nil\")\n    }\n\n    responses := make(chan *model.Response)\n\n    go func() {\n        defer close(responses)\n\n        // \u8c03\u7528 Gemini API\n        stream, err := g.client.GenerateContent(ctx, request.Messages)\n        if err != nil {\n            responses &lt;- &amp;model.Response{\n                Error: &amp;model.Error{\n                    Message: err.Error(),\n                },\n            }\n            return\n        }\n\n        for chunk := range stream {\n            responses &lt;- &amp;model.Response{\n                Content: chunk.Content,\n            }\n        }\n    }()\n\n    return responses, nil\n}\n\nfunc (g *GeminiModel) Info() model.Info {\n    return model.Info{\n        Name: \"gemini-pro\",\n    }\n}\n</code></pre> <p>\u53ef\u4ee5\u96c6\u6210\u7684\u5f00\u6e90\u7ec4\u4ef6\u793a\u4f8b\uff1a</p> <ul> <li>Google Gemini \u6a21\u578b\u652f\u6301</li> <li>Anthropic Claude \u6a21\u578b\u652f\u6301</li> <li>Ollama \u672c\u5730\u6a21\u578b\u652f\u6301</li> </ul> <p>\u8d21\u732e\u65b9\u5f0f\uff1a</p> <ul> <li>\u5728\u5bf9\u5e94\u76ee\u5f55\u4e0b\u521b\u5efa\u7ec4\u4ef6\uff08\u65b0\u5efa\u4e00\u4e2a\u5bf9\u5e94\u7ec4\u4ef6\u540d\u79f0\u7684\u5b50\u76ee\u5f55\uff09</li> <li>\u76f4\u63a5\u8d21\u732e\u5230 <code>https://github.com/trpc-group/trpc-agent-go/model/</code></li> </ul>"},{"location":"zh/ecosystem/#3-tool","title":"3. \u5de5\u5177\uff08Tool\uff09\u751f\u6001\u5316","text":"<p>\u76ee\u6807\uff1a \u96c6\u6210\u66f4\u591a\u7b2c\u4e09\u65b9\u5de5\u5177</p> <p>\u63a5\u53e3\u5b9a\u4e49\uff1a </p> <ul> <li>tool.Tool - \u5355\u4e2a\u5de5\u5177\u63a5\u53e3</li> <li>tool.ToolSet - \u5de5\u5177\u96c6\u5408\u63a5\u53e3</li> </ul> <p>\u73b0\u6709\u5b9e\u73b0\u53c2\u8003\uff1a DuckDuckGo Tool</p> <p>\u5b9e\u73b0\u6ce8\u610f\u4e8b\u9879\uff1a</p> <p>\u5355\u4e2a\u5de5\u5177\u5b9e\u73b0\uff1a</p> <ul> <li><code>Declaration</code> \u65b9\u6cd5\u5fc5\u987b\u8fd4\u56de\u5b8c\u6574\u7684\u5de5\u5177\u5143\u6570\u636e</li> <li><code>Call</code> \u65b9\u6cd5\u63a5\u6536 JSON \u683c\u5f0f\u7684\u53c2\u6570\uff0c\u8fd4\u56de\u4efb\u610f\u7c7b\u578b\u7ed3\u679c</li> <li>\u4f7f\u7528 JSON Schema \u5b9a\u4e49\u8f93\u5165\u8f93\u51fa\u683c\u5f0f</li> <li>\u53c2\u8003 DuckDuckGo \u5b9e\u73b0\uff0c\u4e86\u89e3\u5de5\u5177\u8c03\u7528\u548c\u9519\u8bef\u5904\u7406</li> <li>\u652f\u6301\u4e0a\u4e0b\u6587\u53d6\u6d88\u548c\u8d85\u65f6\u63a7\u5236</li> </ul> <p>\u5de5\u5177\u96c6\u5408\u5b9e\u73b0\uff1a</p> <ul> <li><code>Tools</code> \u65b9\u6cd5\u6839\u636e\u4e0a\u4e0b\u6587\u8fd4\u56de\u53ef\u7528\u7684\u5de5\u5177\u5217\u8868</li> <li><code>Close</code> \u65b9\u6cd5\u91ca\u653e\u5de5\u5177\u96c6\u5408\u6301\u6709\u7684\u8d44\u6e90</li> <li>\u652f\u6301\u52a8\u6001\u5de5\u5177\u52a0\u8f7d\u548c\u914d\u7f6e</li> <li>\u5b9e\u73b0\u5de5\u5177\u7684\u751f\u547d\u5468\u671f\u7ba1\u7406</li> </ul> <p>\u5b9e\u73b0\u793a\u4f8b\uff1a</p> <p>\u5355\u4e2a\u5de5\u5177\u5b9e\u73b0\uff1a</p> <pre><code>package weather\n\nimport (\n    \"context\"\n    \"encoding/json\"\n    \"fmt\"\n    \"net/http\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/tool\"\n)\n\ntype WeatherTool struct {\n    apiKey string\n    client *http.Client\n}\n\nfunc New(apiKey string) tool.CallableTool {\n    return &amp;WeatherTool{\n        apiKey: apiKey,\n        client: &amp;http.Client{},\n    }\n}\n\nfunc (w *WeatherTool) Declaration() *tool.Declaration {\n    return &amp;tool.Declaration{\n        Name:        \"get_weather\",\n        Description: \"Get current weather information for a location\",\n        InputSchema: &amp;tool.Schema{\n            Type: \"object\",\n            Properties: map[string]*tool.Schema{\n                \"location\": {\n                    Type:        \"string\",\n                    Description: \"City name or coordinates\",\n                },\n            },\n            Required: []string{\"location\"},\n        },\n        OutputSchema: &amp;tool.Schema{\n            Type: \"object\",\n            Properties: map[string]*tool.Schema{\n                \"temperature\": {Type: \"number\"},\n                \"condition\":   {Type: \"string\"},\n                \"humidity\":    {Type: \"number\"},\n            },\n        },\n    }\n}\n\nfunc (w *WeatherTool) Call(ctx context.Context, jsonArgs []byte) (any, error) {\n    var args struct {\n        Location string `json:\"location\"`\n    }\n\n    if err := json.Unmarshal(jsonArgs, &amp;args); err != nil {\n        return nil, fmt.Errorf(\"invalid arguments: %w\", err)\n    }\n\n    url := fmt.Sprintf(\"https://api.weatherapi.com/v1/current.json?key=%s&amp;q=%s\", w.apiKey, args.Location)\n\n    req, err := http.NewRequestWithContext(ctx, \"GET\", url, nil)\n    if err != nil {\n        return nil, err\n    }\n\n    resp, err := w.client.Do(req)\n    if err != nil {\n        return nil, err\n    }\n    defer resp.Body.Close()\n\n    var weatherData map[string]interface{}\n    if err := json.NewDecoder(resp.Body).Decode(&amp;weatherData); err != nil {\n        return nil, err\n    }\n\n    return weatherData, nil\n}\n</code></pre> <p>\u5de5\u5177\u96c6\u5408\u5b9e\u73b0\uff1a</p> <pre><code>package apitools\n\nimport (\n    \"context\"\n    \"sync\"\n    \"trpc.group/trpc-go/trpc-agent-go/tool\"\n)\n\ntype APIToolSet struct {\n    tools map[string]tool.Tool\n    mu    sync.RWMutex\n}\n\nfunc New() *APIToolSet {\n    return &amp;APIToolSet{\n        tools: make(map[string]tool.Tool),\n    }\n}\n\nfunc (a *APIToolSet) AddTool(name string, t tool.Tool) {\n    a.mu.Lock()\n    defer a.mu.Unlock()\n    a.tools[name] = t\n}\n\nfunc (a *APIToolSet) RemoveTool(name string) {\n    a.mu.Lock()\n    defer a.mu.Unlock()\n    delete(a.tools, name)\n}\n\nfunc (a *APIToolSet) Tools(ctx context.Context) []tool.Tool {\n    a.mu.RLock()\n    defer a.mu.RUnlock()\n\n    var result []tool.Tool\n    for _, t := range a.tools {\n        result = append(result, t)\n    }\n    return result\n}\n\nfunc (a *APIToolSet) Close() error {\n    a.mu.Lock()\n    defer a.mu.Unlock()\n\n    // \u6e05\u7406\u8d44\u6e90\n    a.tools = make(map[string]tool.Tool)\n    return nil\n}\n\n// Name \u8fd4\u56de\u8be5\u5de5\u5177\u96c6\u7684\u540d\u79f0\nfunc (a *APIToolSet) Name() string { return \"api-tools\" }\n</code></pre> <p>\u53ef\u4ee5\u96c6\u6210\u7684\u5f00\u6e90\u7ec4\u4ef6\u793a\u4f8b\uff1a</p> <ul> <li>\u641c\u7d22\u5f15\u64ce\u5de5\u5177\uff08Google\u3001Bing\uff09</li> <li>\u5929\u6c14\u67e5\u8be2\u5de5\u5177</li> <li>\u8ba1\u7b97\u5668\u5de5\u5177</li> <li>\u6587\u4ef6\u64cd\u4f5c\u5de5\u5177</li> <li>API \u5de5\u5177\u96c6\u5408\uff08REST API \u5de5\u5177\u5305\uff09</li> <li>\u6570\u636e\u5e93\u64cd\u4f5c\u5de5\u5177\u96c6\u5408</li> <li>\u6587\u4ef6\u5904\u7406\u5de5\u5177\u96c6\u5408</li> </ul> <p>\u8d21\u732e\u65b9\u5f0f\uff1a</p> <ul> <li>\u5728\u5bf9\u5e94\u76ee\u5f55\u4e0b\u521b\u5efa\u7ec4\u4ef6\uff08\u65b0\u5efa\u4e00\u4e2a\u5bf9\u5e94\u7ec4\u4ef6\u540d\u79f0\u7684\u5b50\u76ee\u5f55\uff09</li> <li>\u76f4\u63a5\u8d21\u732e\u5230 <code>https://github.com/trpc-group/trpc-agent-go/tool/</code></li> </ul>"},{"location":"zh/ecosystem/#4-knowledge","title":"4. \u77e5\u8bc6\u5e93\uff08Knowledge\uff09\u751f\u6001\u5316","text":"<p>\u76ee\u6807\uff1a \u96c6\u6210\u6210\u719f\u7684 RAG \u7ec4\u4ef6</p> <p>\u63a5\u53e3\u5b9a\u4e49\uff1a knowledge.Knowledge</p> <p>\u73b0\u6709\u5b9e\u73b0\u53c2\u8003\uff1a </p> <ul> <li>InMemory Knowledge</li> </ul> <p>\u5b9e\u73b0\u6ce8\u610f\u4e8b\u9879\uff1a</p> <ul> <li><code>Search</code> \u65b9\u6cd5\u652f\u6301\u4e0a\u4e0b\u6587\u548c\u5386\u53f2\u8bb0\u5f55</li> <li>\u8fd4\u56de\u76f8\u5173\u6587\u6863\u548c\u76f8\u5173\u6027\u8bc4\u5206</li> <li>\u652f\u6301\u641c\u7d22\u53c2\u6570\u548c\u7ed3\u679c\u9650\u5236</li> <li>\u53c2\u8003 InMemory \u5b9e\u73b0\uff0c\u4e86\u89e3\u641c\u7d22\u903b\u8f91\u548c\u7ed3\u679c\u5904\u7406</li> <li>\u652f\u6301\u5411\u91cf\u5316\u641c\u7d22\u548c\u8bed\u4e49\u5339\u914d</li> </ul> <p>\u5b9e\u73b0\u793a\u4f8b\uff1a</p> <pre><code>package weaviate\n\nimport (\n    \"context\"\n    \"fmt\"\n    \"trpc.group/trpc-go/trpc-agent-go/knowledge\"\n    \"trpc.group/trpc-go/trpc-agent-go/knowledge/document\"\n)\n\ntype WeaviateKnowledge struct {\n    config *Config\n    client *weaviate.Client\n}\n\nfunc New(config *Config) (knowledge.Knowledge, error) {\n    client := weaviate.NewClient(config.Endpoint, config.APIKey)\n\n    return &amp;WeaviateKnowledge{\n        config: config,\n        client: client,\n    }, nil\n}\n\nfunc (w *WeaviateKnowledge) Search(ctx context.Context, req *knowledge.SearchRequest) (*knowledge.SearchResult, error) {\n    if req.Query == \"\" {\n        return nil, fmt.Errorf(\"query cannot be empty\")\n    }\n\n    // \u6784\u5efa\u641c\u7d22\u67e5\u8be2\n    query := w.buildQuery(req)\n\n    // \u6267\u884c\u5411\u91cf\u641c\u7d22\n    results, err := w.client.Search(ctx, query)\n    if err != nil {\n        return nil, err\n    }\n\n    if len(results) == 0 {\n        return nil, fmt.Errorf(\"no results found\")\n    }\n\n    // \u8fd4\u56de\u6700\u4f73\u5339\u914d\u7ed3\u679c\n    bestResult := results[0]\n\n    return &amp;knowledge.SearchResult{\n        Document: &amp;document.Document{\n            ID:      bestResult.ID,\n            Content: bestResult.Content,\n            Metadata: bestResult.Metadata,\n        },\n        Score: bestResult.Score,\n        Text:  bestResult.Content,\n    }, nil\n}\n\nfunc (w *WeaviateKnowledge) buildQuery(req *knowledge.SearchRequest) *weaviate.Query {\n    // \u6784\u5efa Weaviate \u67e5\u8be2\u903b\u8f91\n    return &amp;weaviate.Query{\n        Query: req.Query,\n        Limit: req.MaxResults,\n        Filter: w.buildFilter(req),\n    }\n}\n</code></pre> <p>\u53ef\u4ee5\u96c6\u6210\u7684\u5f00\u6e90\u7ec4\u4ef6\u793a\u4f8b\uff1a</p> <ul> <li>Weaviate \u5411\u91cf\u6570\u636e\u5e93</li> <li>Pinecone \u5411\u91cf\u6570\u636e\u5e93</li> <li>Qdrant \u5411\u91cf\u6570\u636e\u5e93</li> </ul> <p>\u8d21\u732e\u65b9\u5f0f\uff1a</p> <ul> <li>\u5728\u5bf9\u5e94\u76ee\u5f55\u4e0b\u521b\u5efa\u7ec4\u4ef6\uff08\u65b0\u5efa\u4e00\u4e2a\u5bf9\u5e94\u7ec4\u4ef6\u540d\u79f0\u7684\u5b50\u76ee\u5f55\uff09</li> <li>\u76f4\u63a5\u8d21\u732e\u5230 <code>https://github.com/trpc-group/trpc-agent-go/knowledge/</code></li> </ul>"},{"location":"zh/ecosystem/#5-session","title":"5. Session \u751f\u6001\u5316","text":"<p>\u76ee\u6807\uff1a \u652f\u6301\u591a\u79cd\u4f1a\u8bdd\u5b58\u50a8\u540e\u7aef\uff0c\u7ba1\u7406\u7528\u6237\u4f1a\u8bdd\u72b6\u6001\u548c\u4e8b\u4ef6</p> <p>\u63a5\u53e3\u5b9a\u4e49\uff1a session.Service</p> <p>\u73b0\u6709\u5b9e\u73b0\u53c2\u8003\uff1a</p> <ul> <li>InMemory Session</li> <li>Redis Session</li> </ul> <p>\u5b9e\u73b0\u6ce8\u610f\u4e8b\u9879\uff1a</p> <ul> <li>\u5b9e\u73b0\u5b8c\u6574\u7684 Session \u751f\u547d\u5468\u671f\u7ba1\u7406\uff08\u521b\u5efa\u3001\u83b7\u53d6\u3001\u5220\u9664\u3001\u5217\u8868\uff09</li> <li>\u652f\u6301\u72b6\u6001\u5b58\u50a8\u548c\u4e8b\u4ef6\u8bb0\u5f55</li> <li>\u5b9e\u73b0\u8fde\u63a5\u6c60\u548c\u9519\u8bef\u5904\u7406</li> <li>\u652f\u6301\u4e8b\u52a1\u548c\u4e00\u81f4\u6027</li> <li>\u53ef\u4ee5\u590d\u7528 storage \u6a21\u5757\u7684\u5ba2\u6237\u7aef</li> <li>\u53c2\u8003 InMemory \u548c Redis \u5b9e\u73b0\uff0c\u4e86\u89e3 Session \u7ba1\u7406\u903b\u8f91</li> </ul> <p>\u5b9e\u73b0\u793a\u4f8b\uff1a</p> <pre><code>package postgresql\n\nimport (\n    \"context\"\n    \"database/sql\"\n    \"encoding/json\"\n    \"fmt\"\n    \"time\"\n    \"trpc.group/trpc-go/trpc-agent-go/event\"\n    \"trpc.group/trpc-go/trpc-agent-go/session\"\n)\n\ntype PostgreSQLService struct {\n    db *sql.DB\n}\n\nfunc New(dsn string) (session.Service, error) {\n    db, err := sql.Open(\"postgres\", dsn)\n    if err != nil {\n        return nil, err\n    }\n\n    if err := db.Ping(); err != nil {\n        return nil, err\n    }\n\n    return &amp;PostgreSQLService{db: db}, nil\n}\n\nfunc (p *PostgreSQLService) CreateSession(ctx context.Context, key session.Key, state session.StateMap, options ...session.Option) (*session.Session, error) {\n    if err := key.CheckSessionKey(); err != nil {\n        return nil, err\n    }\n\n    now := time.Now()\n    session := &amp;session.Session{\n        ID:        key.SessionID,\n        AppName:   key.AppName,\n        UserID:    key.UserID,\n        State:     state,\n        Events:    []event.Event{},\n        UpdatedAt: now,\n        CreatedAt: now,\n    }\n\n    // \u63d2\u5165\u5230\u6570\u636e\u5e93\n    _, err := p.db.ExecContext(ctx, `\n        INSERT INTO sessions (id, app_name, user_id, state, created_at, updated_at)\n        VALUES ($1, $2, $3, $4, $5, $6)\n    `, session.ID, session.AppName, session.UserID, p.marshalState(state), session.CreatedAt, session.UpdatedAt)\n\n    if err != nil {\n        return nil, err\n    }\n\n    return session, nil\n}\n\nfunc (p *PostgreSQLService) GetSession(ctx context.Context, key session.Key, options ...session.Option) (*session.Session, error) {\n    if err := key.CheckSessionKey(); err != nil {\n        return nil, err\n    }\n\n    var session session.Session\n    var stateData []byte\n\n    err := p.db.QueryRowContext(ctx, `\n        SELECT id, app_name, user_id, state, created_at, updated_at\n        FROM sessions WHERE id = $1\n    `, key.SessionID).Scan(&amp;session.ID, &amp;session.AppName, &amp;session.UserID, &amp;stateData, &amp;session.CreatedAt, &amp;session.UpdatedAt)\n\n    if err != nil {\n        return nil, err\n    }\n\n    session.State = p.unmarshalState(stateData)\n\n    return &amp;session, nil\n}\n\nfunc (p *PostgreSQLService) Close() error {\n    return p.db.Close()\n}\n\nfunc (p *PostgreSQLService) marshalState(state session.StateMap) []byte {\n    data, _ := json.Marshal(state)\n    return data\n}\n\nfunc (p *PostgreSQLService) unmarshalState(data []byte) session.StateMap {\n    var state session.StateMap\n    json.Unmarshal(data, &amp;state)\n    return state\n}\n</code></pre> <p>\u53ef\u4ee5\u96c6\u6210\u7684\u5f00\u6e90\u7ec4\u4ef6\u793a\u4f8b\uff1a</p> <ul> <li>PostgreSQL \u4f1a\u8bdd\u5b58\u50a8</li> <li>MongoDB \u4f1a\u8bdd\u5b58\u50a8</li> <li>MySQL \u4f1a\u8bdd\u5b58\u50a8</li> <li>Cassandra \u4f1a\u8bdd\u5b58\u50a8</li> </ul> <p>\u8d21\u732e\u65b9\u5f0f\uff1a</p> <ul> <li>\u5728\u5bf9\u5e94\u76ee\u5f55\u4e0b\u521b\u5efa\u7ec4\u4ef6\uff08\u65b0\u5efa\u4e00\u4e2a\u5bf9\u5e94\u7ec4\u4ef6\u540d\u79f0\u7684\u5b50\u76ee\u5f55\uff09</li> <li>\u76f4\u63a5\u8d21\u732e\u5230 <code>https://github.com/trpc-group/trpc-agent-go/session/</code></li> </ul>"},{"location":"zh/ecosystem/#6-memory","title":"6. Memory \u751f\u6001\u5316","text":"<p>\u76ee\u6807\uff1a \u652f\u6301\u591a\u79cd\u8bb0\u5fc6\u5b58\u50a8\u540e\u7aef\uff0c\u7ba1\u7406\u7528\u6237\u957f\u671f\u8bb0\u5fc6\u548c\u4e2a\u6027\u5316\u4fe1\u606f</p> <p>\u63a5\u53e3\u5b9a\u4e49\uff1a memory.Service</p> <p>\u73b0\u6709\u5b9e\u73b0\u53c2\u8003\uff1a InMemory Memory</p> <p>\u5b9e\u73b0\u6ce8\u610f\u4e8b\u9879\uff1a</p> <ul> <li>\u5b9e\u73b0\u5b8c\u6574\u7684 Memory \u751f\u547d\u5468\u671f\u7ba1\u7406\uff08\u6dfb\u52a0\u3001\u66f4\u65b0\u3001\u5220\u9664\u3001\u641c\u7d22\u3001\u8bfb\u53d6\uff09</li> <li>\u652f\u6301\u8bb0\u5fc6\u4e3b\u9898\u5206\u7c7b\u548c\u641c\u7d22</li> <li>\u63d0\u4f9b\u8bb0\u5fc6\u5de5\u5177\u96c6\u6210\uff08memory_add, memory_search \u7b49\uff09</li> <li>\u5b9e\u73b0\u8fde\u63a5\u6c60\u548c\u9519\u8bef\u5904\u7406</li> <li>\u53ef\u4ee5\u590d\u7528 storage \u6a21\u5757\u7684\u5ba2\u6237\u7aef</li> <li>\u652f\u6301\u8bb0\u5fc6\u9650\u5236\u548c\u6e05\u7406\u673a\u5236</li> <li>\u53c2\u8003 InMemory \u5b9e\u73b0\uff0c\u4e86\u89e3\u8bb0\u5fc6\u7ba1\u7406\u903b\u8f91</li> </ul> <p>\u5b9e\u73b0\u793a\u4f8b\uff1a</p> <pre><code>package postgresql\n\nimport (\n    \"context\"\n    \"database/sql\"\n    \"encoding/json\"\n    \"fmt\"\n    \"time\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/memory\"\n    memorytool \"trpc.group/trpc-go/trpc-agent-go/memory/tool\"\n    \"trpc.group/trpc-go/trpc-agent-go/tool\"\n)\n\ntype PostgreSQLMemoryService struct {\n    db *sql.DB\n    cachedTools map[string]tool.Tool\n}\n\nfunc New(dsn string) (memory.Service, error) {\n    db, err := sql.Open(\"postgres\", dsn)\n    if err != nil {\n        return nil, err\n    }\n\n    if err := db.Ping(); err != nil {\n        return nil, err\n    }\n\n    service := &amp;PostgreSQLMemoryService{\n        db: db,\n        cachedTools: make(map[string]tool.Tool),\n    }\n\n    // \u521d\u59cb\u5316\u5de5\u5177\n    service.initTools()\n\n    return service, nil\n}\n\nfunc (p *PostgreSQLMemoryService) AddMemory(ctx context.Context, userKey memory.UserKey, memoryStr string, topics []string) error {\n    if err := userKey.CheckUserKey(); err != nil {\n        return err\n    }\n\n    now := time.Now()\n    memoryID := p.generateMemoryID(memoryStr)\n\n    // \u63d2\u5165\u8bb0\u5fc6\u5230\u6570\u636e\u5e93\n    _, err := p.db.ExecContext(ctx, `\n        INSERT INTO memories (id, app_name, user_id, memory, topics, created_at, updated_at)\n        VALUES ($1, $2, $3, $4, $5, $6, $7)\n    `, memoryID, userKey.AppName, userKey.UserID, memoryStr, p.marshalTopics(topics), now, now)\n\n    return err\n}\n\nfunc (p *PostgreSQLMemoryService) SearchMemories(ctx context.Context, userKey memory.UserKey, query string) ([]*memory.Entry, error) {\n    if err := userKey.CheckUserKey(); err != nil {\n        return nil, err\n    }\n\n    // \u6267\u884c\u5168\u6587\u641c\u7d22\n    rows, err := p.db.QueryContext(ctx, `\n        SELECT id, app_name, user_id, memory, topics, created_at, updated_at\n        FROM memories \n        WHERE app_name = $1 AND user_id = $2 \n        AND (memory ILIKE $3 OR topics::text ILIKE $3)\n        ORDER BY updated_at DESC\n        LIMIT 10\n    `, userKey.AppName, userKey.UserID, \"%\"+query+\"%\")\n\n    if err != nil {\n        return nil, err\n    }\n    defer rows.Close()\n\n    var entries []*memory.Entry\n    for rows.Next() {\n        var entry memory.Entry\n        var topicsData []byte\n\n        err := rows.Scan(&amp;entry.ID, &amp;entry.AppName, &amp;entry.UserID, &amp;entry.Memory.Memory, &amp;topicsData, &amp;entry.CreatedAt, &amp;entry.UpdatedAt)\n    if err != nil {\n        return nil, err\n    }\n\n        entry.Memory.Topics = p.unmarshalTopics(topicsData)\n        entries = append(entries, &amp;entry)\n    }\n\n    return entries, nil\n}\n\nfunc (p *PostgreSQLMemoryService) Tools() []tool.Tool {\n    var tools []tool.Tool\n    for _, t := range p.cachedTools {\n        tools = append(tools, t)\n    }\n    return tools\n}\n\nfunc (p *PostgreSQLMemoryService) initTools() {\n    p.cachedTools[memory.AddToolName] = memorytool.NewAddTool(p)\n    p.cachedTools[memory.SearchToolName] = memorytool.NewSearchTool(p)\n    p.cachedTools[memory.LoadToolName] = memorytool.NewLoadTool(p)\n}\n\nfunc (p *PostgreSQLMemoryService) generateMemoryID(memoryStr string) string {\n    // \u751f\u6210\u552f\u4e00\u8bb0\u5fc6 ID\n    return fmt.Sprintf(\"mem_%d\", time.Now().UnixNano())\n}\n\nfunc (p *PostgreSQLMemoryService) marshalTopics(topics []string) []byte {\n    data, _ := json.Marshal(topics)\n    return data\n}\n\nfunc (p *PostgreSQLMemoryService) unmarshalTopics(data []byte) []string {\n    var topics []string\n    json.Unmarshal(data, &amp;topics)\n    return topics\n}\n</code></pre> <p>\u4e3a\u4fbf\u4e8e\u5feb\u901f\u843d\u5730\uff0c\u53ef\u76f4\u63a5\u5bf9\u63a5\u73b0\u6709 Memory \u5e73\u53f0/\u670d\u52a1\uff08\u5982 mem0\uff09\u3002\u5efa\u8bae\uff1a</p> <ul> <li>\u5728 <code>memory/mem0/</code> \u63d0\u4f9b\u5b9e\u73b0\uff0c\u9075\u5faa <code>memory.Service</code> \u63a5\u53e3\u3002</li> <li>\u590d\u7528\u73b0\u6709 <code>memory/tool</code> \u5de5\u5177\uff08<code>memory_add</code>\u3001<code>memory_search</code>\u3001   <code>memory_load</code> \u7b49\uff09\uff0c\u901a\u8fc7 <code>Tools()</code> \u66b4\u9732\u3002</li> <li>\u4e3b\u9898\uff08topics\uff09\u4e0e\u68c0\u7d22\uff08search\uff09\u6309\u76ee\u6807\u670d\u52a1\u80fd\u529b\u505a\u6620\u5c04\uff0c\u5fc5\u8981\u65f6\u5728\u672c\u5730   \u7ef4\u62a4\u8f7b\u91cf\u7d22\u5f15\u4ee5\u589e\u5f3a\u67e5\u8be2\u4f53\u9a8c\u3002</li> <li>\u53ef\u9009\uff1a\u590d\u7528 <code>storage</code> \u6a21\u5757\u7684\u5ba2\u6237\u7aef\u7ba1\u7406\u7edf\u4e00\u9274\u6743\u3001\u8fde\u63a5\u4e0e\u590d\u7528\u3002</li> </ul> <p>\u793a\u4f8b\u9aa8\u67b6\uff08\u7b80\u5316\uff09\uff1a</p> <pre><code>package mem0\n\nimport (\n    \"context\"\n    \"net/http\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/memory\"\n    memorytool \"trpc.group/trpc-go/trpc-agent-go/memory/tool\"\n    \"trpc.group/trpc-go/trpc-agent-go/tool\"\n)\n\ntype Service struct {\n    client  *http.Client\n    baseURL string\n    apiKey  string\n    tools   map[string]tool.Tool\n}\n\nfunc New(baseURL, apiKey string) *Service {\n    s := &amp;Service{\n        client:  &amp;http.Client{},\n        baseURL: baseURL,\n        apiKey:  apiKey,\n        tools:   make(map[string]tool.Tool),\n    }\n    s.tools[memory.AddToolName] = memorytool.NewAddTool(s)\n    s.tools[memory.SearchToolName] = memorytool.NewSearchTool(s)\n    s.tools[memory.LoadToolName] = memorytool.NewLoadTool(s)\n    return s\n}\n\nfunc (s *Service) Tools() []tool.Tool {\n    var ts []tool.Tool\n    for _, t := range s.tools {\n        ts = append(ts, t)\n    }\n    return ts\n}\n\nfunc (s *Service) AddMemory(ctx context.Context, key memory.UserKey, m string, topics []string) error {\n    if err := key.CheckUserKey(); err != nil {\n        return err\n    }\n    // \u8c03\u7528 mem0 API \u5199\u5165\u8bb0\u5fc6\n    return nil\n}\n\nfunc (s *Service) SearchMemories(ctx context.Context, key memory.UserKey, q string) ([]*memory.Entry, error) {\n    if err := key.CheckUserKey(); err != nil {\n        return nil, err\n    }\n    // \u8c03\u7528 mem0 API \u68c0\u7d22, \u5e76\u8f6c\u6362\u4e3a []*memory.Entry\n    return nil, nil\n}\n\n// \u5176\u4f59\u63a5\u53e3 Update/Delete/Clear/Read \u6309 mem0 \u80fd\u529b\u505a\u6620\u5c04\u5b9e\u73b0\n</code></pre> <p>\u5b9e\u73b0\u8981\u70b9\uff1a</p> <ul> <li>\u9274\u6743\u4e0e\u9650\u6d41\u6309\u76ee\u6807\u670d\u52a1\u6307\u5357\u914d\u7f6e\u3002</li> <li>\u8fd4\u56de\u503c\u4e25\u683c\u5bf9\u9f50 <code>memory.Entry</code> \u4e0e <code>memory.Memory</code>\uff0c\u65f6\u95f4\u5b57\u6bb5\u4f7f\u7528 UTC\u3002</li> <li>\u5de5\u5177\u58f0\u660e\uff08Declaration\uff09\u5e94\u51c6\u786e\u63cf\u8ff0\u8f93\u5165\u8f93\u51fa\uff0c\u4fbf\u4e8e\u524d\u7aef\u4e0e\u6a21\u578b\u7406\u89e3\u3002</li> <li>\u8865\u5145 README\u3001\u793a\u4f8b\u4e0e\u6d4b\u8bd5\uff0c\u786e\u4fdd\u4e0e runner \u76f8\u5173\u96c6\u6210\u53ef\u7528\u3002</li> </ul> <p>\u53ef\u4ee5\u96c6\u6210\u7684\u5f00\u6e90\u7ec4\u4ef6\u793a\u4f8b\uff1a</p> <ul> <li>PostgreSQL \u8bb0\u5fc6\u5b58\u50a8</li> <li>MongoDB \u8bb0\u5fc6\u5b58\u50a8</li> <li>Elasticsearch \u8bb0\u5fc6\u5b58\u50a8</li> <li>Redis \u8bb0\u5fc6\u5b58\u50a8</li> </ul> <p>\u8d21\u732e\u65b9\u5f0f\uff1a</p> <ul> <li>\u5728\u5bf9\u5e94\u76ee\u5f55\u4e0b\u521b\u5efa\u7ec4\u4ef6\uff08\u65b0\u5efa\u4e00\u4e2a\u5bf9\u5e94\u7ec4\u4ef6\u540d\u79f0\u7684\u5b50\u76ee\u5f55\uff09</li> <li>\u76f4\u63a5\u8d21\u732e\u5230 <code>https://github.com/trpc-group/trpc-agent-go/memory/</code></li> </ul>"},{"location":"zh/ecosystem/#7-observability","title":"7. \u53ef\u89c2\u6d4b\uff08Observability\uff09\u751f\u6001\u5316","text":"<p>\u76ee\u6807\uff1a \u57fa\u4e8e OpenTelemetry \u6807\u51c6\u63d0\u4f9b\u7edf\u4e00\u7684\u53ef\u89c2\u6d4b\u80fd\u529b\uff0c\u8986\u76d6 Logging\u3001Metrics\u3001Tracing\uff0c\u4fbf\u4e8e\u751f\u6001\u6269\u5c55\u4e0e\u66ff\u6362\u3002</p> <p>\u6838\u5fc3\u5305\u4e0e\u63a5\u53e3\uff1a</p> <ul> <li>Logging: <code>trpc-agent-go/log</code>\uff08<code>log.Logger</code> \u63a5\u53e3\u4e0e <code>log.Default</code> \u5168\u5c40   \u65e5\u5fd7\u5668\uff09\u3002</li> <li>Metrics: <code>trpc-agent-go/telemetry/metric</code>\uff08<code>metric.Meter</code> \u5168\u5c40 Meter \u4e0e   <code>metric.Start</code> \u521d\u59cb\u5316\uff09\u3002</li> <li>Tracing: <code>trpc-agent-go/telemetry/trace</code>\uff08<code>trace.Tracer</code> \u5168\u5c40 Tracer \u4e0e   <code>trace.Start</code> \u521d\u59cb\u5316\uff09\u3002</li> <li>tRPC \u96c6\u6210\uff1a<code>trpc/log.go</code>\u3001<code>trpc/telemetry/galileo/</code>\u3002</li> </ul>"},{"location":"zh/ecosystem/#logging","title":"Logging\uff08\u65e5\u5fd7\uff09","text":"<ul> <li>\u63a5\u53e3\u5b9a\u4e49\uff1a<code>log.Logger</code> \u5b9a\u4e49\u4e86 <code>Debug/Info/Warn/Error/Fatal</code> \u53ca\u5176 <code>*f</code>   \u53d8\u4f53\u65b9\u6cd5\uff0c\u4fbf\u4e8e\u66ff\u6362\u4e3a\u4efb\u610f\u5b9e\u73b0\u3002</li> <li>\u9ed8\u8ba4\u5b9e\u73b0\uff1a<code>log.Default</code> \u9ed8\u8ba4\u4f7f\u7528 <code>zap</code> \u7684 <code>SugaredLogger</code>\u3002</li> <li>\u52a8\u6001\u7ea7\u522b\uff1a<code>log.SetLevel(level)</code> \u652f\u6301 <code>debug/info/warn/error/fatal</code>\u3002</li> <li>tRPC \u96c6\u6210\uff1a<code>trpc/log.go</code> \u5c06 <code>tlog.DefaultLogger</code> \u6ce8\u5165\u4e3a   <code>log.Default</code>\uff0c\u5e76\u968f tRPC \u63d2\u4ef6\u751f\u547d\u5468\u671f\u5237\u65b0\u3002</li> </ul> <p>\u793a\u4f8b\uff08\u4f7f\u7528\u5168\u5c40\u65e5\u5fd7\u5668\uff09\uff1a</p> <pre><code>package main\n\nimport (\n    \"context\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/log\"\n)\n\nfunc main() {\n    log.SetLevel(log.LevelInfo)\n    log.Info(\"app start\")\n    log.Debugf(\"ctx: %v\", context.Background())\n}\n</code></pre> <p>\u793a\u4f8b\uff08\u5728 tRPC \u4e2d\u901a\u8fc7\u914d\u7f6e\u843d\u76d8/\u8fdc\u7aef\uff09\uff1a</p> <pre><code>plugins:\n  log:\n    default:\n      - writer: console\n        level: info\n      - writer: file\n        level: warn\n        writer_config:\n          log_path: ./app.log\n</code></pre> <p>\u8d21\u732e\u65b9\u5411\uff1a</p> <ul> <li>\u9002\u914d\u4efb\u610f Logger\uff08\u5982 zerolog\u3001logrus\uff09\uff1a\u5b9e\u73b0 <code>log.Logger</code> \u63a5\u53e3\uff0c\u5e76\u5728   \u521d\u59cb\u5316\u65f6\u8bbe\u7f6e <code>log.Default = yourLogger</code>\u3002</li> <li>tRPC \u63d2\u4ef6\u5316\uff1a\u53c2\u8003 <code>trpc/log.go</code> \u7684 <code>plugin.RegisterSetupHook</code> \u7528\u6cd5\u3002</li> </ul>"},{"location":"zh/ecosystem/#metrics","title":"Metrics\uff08\u6307\u6807\uff09","text":"<ul> <li>\u5305\uff1a<code>telemetry/metric</code>\u3002</li> <li>\u5168\u5c40\u5bf9\u8c61\uff1a<code>metric.Meter</code>\uff0c\u9ed8\u8ba4 <code>noop</code>\uff0c\u8c03\u7528 <code>metric.Start</code> \u540e\u6307\u5411   OTel Meter\u3002</li> <li>\u521d\u59cb\u5316\uff1a<code>metric.Start(ctx, metric.WithEndpoint(\"host:4317\"))</code>\u3002</li> <li>OTLP \u5bfc\u51fa\uff1a\u4f7f\u7528 <code>otlpmetricgrpc</code>\uff0c\u652f\u6301\u73af\u5883\u53d8\u91cf\u8986\u76d6\uff1a<ul> <li><code>OTEL_EXPORTER_OTLP_METRICS_ENDPOINT</code>\u3002</li> <li><code>OTEL_EXPORTER_OTLP_ENDPOINT</code>\uff08\u515c\u5e95\uff09\u3002</li> </ul> </li> <li>\u8d44\u6e90\u6807\u8bc6\uff1a\u81ea\u52a8\u586b\u5145 <code>service.namespace/name/version</code>\u3002</li> </ul> <p>\u793a\u4f8b\uff08\u542f\u52a8\u6307\u6807\u4e0e\u4e0a\u62a5 Counter\uff09\uff1a</p> <pre><code>package main\n\nimport (\n    \"context\"\n\n    \"go.opentelemetry.io/otel/metric\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/telemetry/metric\" // alias ametric\n    ametric \"trpc.group/trpc-go/trpc-agent-go/telemetry/metric\"\n)\n\nfunc main() {\n    mp, err := ametric.NewMeterProvider(\n        context.Background(),\n        ametric.WithEndpoint(\"localhost:4318\"),\n        ametric.WithProtocol(\"http\"),\n    )\n    if err != nil {\n        log.Fatalf(\"Failed to create meter provider: %v\", err)\n    }\n    defer mp.Shutdown(context.Background())\n    ametric.InitMeterProvider(mp)\n    meter := mp.Meter(\"trpc_agent_go.app\")\n        counter, _ := meter.Int64Counter(\n        \"requests_total\",\n        metric.WithDescription(\"total requests\"),\n    )\n    counter.Add(context.Background(), 1)\n}\n</code></pre> <p>\u8d21\u732e\u65b9\u5411\uff1a</p> <ul> <li>\u5bfc\u51fa\u5668\u751f\u6001\uff1a\u5c01\u88c5\u66f4\u591a OTel Exporter \u7684\u4fbf\u6377\u542f\u52a8\u65b9\u6cd5\uff08\u5982 Prometheus pull/OTLP http\uff09\u3002</li> <li>\u6307\u6807\u5e93\uff1a\u7ea6\u5b9a\u5e38\u7528\u6307\u6807\u547d\u540d\u4e0e\u6807\u7b7e\u89c4\u8303\uff0c\u63d0\u4f9b helper \u65b9\u6cd5\u3002</li> </ul>"},{"location":"zh/ecosystem/#tracing","title":"Tracing\uff08\u94fe\u8def\u8ffd\u8e2a\uff09","text":"<ul> <li>\u5305\uff1a<code>telemetry/trace</code>\u3002</li> <li>\u5168\u5c40\u5bf9\u8c61\uff1a<code>trace.Tracer</code>\uff0c\u9ed8\u8ba4 <code>noop</code>\uff0c\u8c03\u7528 <code>trace.Start</code> \u540e\u6307\u5411   OTel Tracer\u3002</li> <li>\u521d\u59cb\u5316\uff1a<code>trace.Start(ctx, trace.WithEndpoint(\"host:4317\"))</code>\u3002</li> <li>OTLP \u5bfc\u51fa\uff1a\u4f7f\u7528 <code>otlptracegrpc</code>\uff0c\u652f\u6301\u73af\u5883\u53d8\u91cf\u8986\u76d6\uff1a<ul> <li><code>OTEL_EXPORTER_OTLP_TRACES_ENDPOINT</code>\u3002</li> <li><code>OTEL_EXPORTER_OTLP_ENDPOINT</code>\uff08\u515c\u5e95\uff09\u3002</li> </ul> </li> <li>Propagator\uff1a\u9ed8\u8ba4\u542f\u7528 <code>TraceContext</code>\u3002</li> </ul> <p>\u793a\u4f8b\uff08\u542f\u52a8\u8ffd\u8e2a\u4e0e\u521b\u5efa Span\uff09\uff1a</p> <pre><code>package main\n\nimport (\n    \"context\"\n\n    \"go.opentelemetry.io/otel/trace\"\n    atrace \"trpc.group/trpc-go/trpc-agent-go/telemetry/trace\"\n)\n\nfunc main() {\n    clean, _ := atrace.Start(context.Background(),\n        atrace.WithEndpoint(\"localhost:4317\"),\n    )\n    defer clean()\n\n    ctx, span := atrace.Tracer.Start(context.Background(), \"example\",\n        trace.WithAttributes(),\n    )\n    _ = ctx\n    span.End()\n}\n</code></pre> <p>\u8d21\u732e\u65b9\u5411\uff1a</p> <ul> <li>\u5bfc\u51fa\u5668\u751f\u6001\uff1a\u5c01\u88c5 Zipkin\u3001Jaeger\uff08\u76f4\u63a5\u63a8\u9001\uff09\u7b49\u542f\u52a8\u65b9\u6cd5\u3002</li> <li>Span \u89c4\u8303\uff1a\u7ea6\u5b9a\u5e38\u89c1 Span \u540d\u79f0/\u5c5e\u6027\u952e\uff0c\u63d0\u4f9b helper\uff08\u53ef\u653e\u5728   <code>telemetry/</code>\uff09\u3002</li> </ul>"},{"location":"zh/ecosystem/#8-api","title":"8. API \u670d\u52a1\u751f\u6001\u5316","text":"<p>\u76ee\u6807\uff1a \u9762\u5411\u524d\u7aef Chat \u754c\u9762\uff08\u5982 ADK Web\u3001AG-UI\u3001Agent UI\uff09\u63d0\u4f9b\u7edf\u4e00\u3001 \u53ef\u6269\u5c55\u7684 API \u670d\u52a1\u5c01\u88c5\uff0c\u8986\u76d6\u4f1a\u8bdd\u7ba1\u7406\u3001\u5bf9\u8bdd\u53d1\u9001\u3001\u6d41\u5f0f\u4f20\u8f93\u3001\u5de5\u5177\u8c03\u7528\u3001 \u53ef\u89c2\u6d4b\u4e0e\u9274\u6743\u7b49\u80fd\u529b\uff0c\u5e76\u5bf9\u9f50\u5404 UI \u534f\u8bae\u4ee5\u4fbf\u5373\u63d2\u5373\u7528\u3002</p> <p>\u73b0\u6709\u5b9e\u73b0\u53c2\u8003\uff1a</p> <ul> <li>A2A Server\uff1a<code>server/a2a</code>\u3002<ul> <li>\u9762\u5411 A2A \u534f\u8bae\u7684\u670d\u52a1\u5c01\u88c5\uff0c\u5185\u5efa <code>AuthProvider</code> \u4e0e\u4efb\u52a1\u7f16\u6392\uff0c\u9002\u5408   \u5e73\u53f0\u5230 Agent \u7684\u96c6\u6210\u573a\u666f\u3002</li> </ul> </li> </ul> <p>\u4e0e\u524d\u7aef\u534f\u8bae\u5bf9\u9f50\uff1a</p> <ul> <li>AG-UI\uff1a\u53c2\u8003 <code>https://github.com/ag-ui-protocol/ag-ui</code>\u3002<ul> <li>\u9700\u8981\u7684\u80fd\u529b\uff1a<ul> <li>\u4f1a\u8bdd\u5217\u8868/\u521b\u5efa/\u67e5\u8be2\u3002</li> <li>\u6587\u672c\u5bf9\u8bdd\u4e0e SSE \u6d41\u5f0f\u589e\u91cf\uff1b\u652f\u6301\u5de5\u5177\u8c03\u7528\u4e0e\u51fd\u6570\u54cd\u5e94\u7247\u6bb5\u5316\u5c55\u793a\u3002</li> <li>\u72b6\u6001/\u7528\u91cf\u5143\u6570\u636e\u3001\u9519\u8bef\u8868\u8fbe\u5bf9\u9f50\u3002</li> <li>\u6587\u4ef6/\u56fe\u7247\u7b49\u5bcc\u5a92\u4f53\u627f\u8f7d\uff08InlineData\uff09\u4e0e\u670d\u52a1\u7aef\u5b58\u50a8\u5bf9\u63a5\u3002</li> <li>\u9274\u6743\uff08API Key\u3001JWT\u3001Cookie \u4f1a\u8bdd\uff09\u4e0e CORS\u3002</li> </ul> </li> <li>\u5efa\u8bae\u5728 <code>server/agui/</code> \u63d0\u4f9b\u5b9e\u73b0\uff0c\u590d\u7528\u901a\u7528\u7684\u6a21\u578b\u4e0e\u4e8b\u4ef6   \u6620\u5c04\u5de5\u5177\uff0c\u5728 Handler \u4e2d\u5b8c\u6210\u534f\u8bae\u5c42\u9002\u914d\u3002</li> </ul> </li> <li>Agent UI\uff08agno\uff09\uff1a\u53c2\u8003 <code>https://docs.agno.com/agent-ui/introduction</code>\u3002<ul> <li>\u91cd\u70b9\uff1aSSE/WebSocket \u6d41\u3001Tool \u8c03\u7528\u6d41\u5f0f UI \u53cd\u9988\u3001\u4f1a\u8bdd/\u5de5\u4ef6\u6301\u4e45\u5316\u3002</li> </ul> </li> </ul> <p>\u5173\u952e\u8bbe\u8ba1\u8981\u70b9\uff1a</p> <ul> <li>Schema \u6620\u5c04\uff1a<ul> <li>\u8f93\u5165\uff1a\u5c06 UI \u7684 <code>Content</code>/<code>Part</code> \u6620\u5c04\u4e3a\u5185\u90e8 <code>model.Message</code>\u3002</li> <li>\u8f93\u51fa\u4e8b\u4ef6\uff1a\u5c06\u5185\u90e8 <code>event.Event</code> \u6620\u5c04\u4e3a UI \u671f\u671b\u7684 envelope/parts\uff0c   \u5bf9\u5de5\u5177\u8c03\u7528\u4e0e\u5de5\u5177\u54cd\u5e94\u8fdb\u884c\u7ed3\u6784\u5316\uff0c\u907f\u514d\u91cd\u590d\u6587\u672c\u5c55\u793a\u3002</li> </ul> </li> <li>\u6d41\u5f0f\u4f20\u8f93\uff1a<ul> <li>\u4f18\u5148\u4f7f\u7528 SSE\uff1bWebSocket \u53ef\u4f5c\u4e3a\u751f\u6001\u6269\u5c55\u3002</li> <li>\u975e\u6d41\u5f0f\u7aef\u70b9\u9700\u6309 UI \u671f\u671b\u805a\u5408\u6700\u7ec8\u6d88\u606f\u4e0e\u5de5\u5177\u54cd\u5e94\u3002</li> </ul> </li> <li>\u4f1a\u8bdd\u5b58\u50a8\uff1a<ul> <li>\u901a\u8fc7 <code>runner.WithSessionService</code> \u6ce8\u5165\u5177\u4f53\u5b9e\u73b0\uff0c\u590d\u7528 <code>session</code> \u6a21\u5757\u3002</li> </ul> </li> <li>\u53ef\u89c2\u6d4b\uff1a<ul> <li>\u590d\u7528 <code>telemetry/trace</code> \u4e0e <code>telemetry/metric</code>\uff0c\u5bfc\u51fa\u5173\u952e Span \u4e0e\u4e8b\u4ef6\u5c5e\u6027\uff0c\u4fbf\u4e8e UI \u4fa7\u8c03\u8bd5\u4e0e\u5b9a\u4f4d\u3002</li> </ul> </li> <li>\u9274\u6743\u4e0e\u5b89\u5168\uff1a<ul> <li>\u652f\u6301 API Key/JWT/\u81ea\u5b9a\u4e49 Header\uff1b\u5bf9\u654f\u611f\u7aef\u70b9\u52a0\u901f\u7387\u9650\u5236\u4e0e\u8de8\u57df\u63a7\u5236\u3002</li> </ul> </li> <li>\u5f00\u653e\u89c4\u8303\uff1a<ul> <li>\u5efa\u8bae\u5728\u5404 <code>server/*</code> \u5b50\u6a21\u5757\u9644\u5e26 <code>openapi.json</code>/<code>README.md</code>\uff0c   \u4fbf\u4e8e\u524d\u7aef/\u96c6\u6210\u65b9\u5bf9\u63a5\u3002</li> </ul> </li> </ul> <p>AG-UI \u9002\u914d\u5efa\u8bae\uff08\u9aa8\u67b6\uff09\uff1a</p> <pre><code>package agui\n\nimport (\n    \"net/http\"\n\n    \"github.com/gorilla/mux\"\n    \"trpc.group/trpc-go/trpc-agent-go/agent\"\n    \"trpc.group/trpc-go/trpc-agent-go/runner\"\n)\n\ntype Server struct {\n    router *mux.Router\n    ag     agent.Agent\n    run    runner.Runner\n}\n\nfunc New(ag agent.Agent, opts ...runner.Option) *Server {\n    r := runner.NewRunner(ag.Info().Name, ag, opts...)\n    s := &amp;Server{router: mux.NewRouter(), ag: ag, run: r}\n    s.routes()\n    return s\n}\n\nfunc (s *Server) Handler() http.Handler { return s.router }\n\nfunc (s *Server) routes() {\n    // GET /sessions, POST /sessions, GET /sessions/{id}\n    // POST /chat (non-stream), POST /chat/stream (SSE)\n}\n</code></pre> <p>\u751f\u6001\u5316\u65b9\u5411\u4e0e\u8d21\u732e\u89c4\u8303\uff1a</p> <ul> <li>\u76ee\u6807 UI/\u534f\u8bae\uff1a<ul> <li>AG-UI\uff1a\u5728 <code>server/agui/</code> \u63d0\u4f9b HTTP + SSE \u9002\u914d\uff0c\u9644\u5e26\u793a\u4f8b \u4e0e <code>openapi.json</code>\u3002</li> </ul> </li> <li>Agent UI\uff08agno\uff09\uff1a\u5728 <code>server/agentui/</code> \u63d0\u4f9b HTTP + SSE / WebSocket \u9002\u914d\u3002<ul> <li>WebSocket/Bidi Streaming\uff1a\u5bf9\u6807 ADK <code>run_live</code>\uff0c\u63d0\u4f9b\u5b9e\u65f6\u97f3\u89c6\u9891   \u901a\u9053\uff08\u4f9d\u8d56\u6a21\u578b\u4fa7\u652f\u6301\uff09\u3002</li> </ul> </li> <li>\u843d\u5730\u8981\u6c42\uff1a<ul> <li>\u4e8b\u4ef6 Schema \u660e\u786e\u3001\u6620\u5c04\u5b8c\u5907\uff0c\u786e\u4fdd\u5de5\u5177\u8c03\u7528/\u54cd\u5e94\u5728 UI \u7aef\u6709\u826f\u597d\u4f53\u9a8c\u3002</li> <li>\u652f\u6301\u4f1a\u8bdd\u5b58\u50a8\u53ef\u63d2\u62d4\uff0c\u9ed8\u8ba4 In-Memory\uff0c\u63a8\u8350\u652f\u6301 Redis/MySQL \u7b49\u3002</li> <li>\u5185\u7f6e CORS\u3001\u9274\u6743\u4e2d\u95f4\u4ef6\uff08API Key/JWT\uff09\uff0c\u66b4\u9732\u5065\u5eb7\u68c0\u67e5\u7aef\u70b9\u3002</li> <li>\u53ef\u89c2\u6d4b\uff1a\u6253\u901a <code>telemetry</code>\uff0c\u63d0\u4f9b\u6700\u5c0f Trace \u4e0e Metric \u6837\u4f8b\u3002</li> <li>\u6587\u6863\uff1aREADME\u3001OpenAPI\u3001\u7aef\u5230\u7aef\u793a\u4f8b\uff08\u5305\u542b\u7b80\u5355\u524d\u7aef\u6216 curl \u811a\u672c\uff09\u3002</li> </ul> </li> </ul> <p>\u94fe\u63a5\u53c2\u8003\uff1a</p> <ul> <li><code>server/a2a</code>\uff08A2A \u534f\u8bae\u5c01\u88c5\uff09\u3002 </li> </ul>"},{"location":"zh/ecosystem/#9-planner","title":"9. Planner \u751f\u6001\u5316","text":"<p>\u76ee\u6807\uff1a \u63d0\u4f9b\u591a\u6837\u5316\u7684\u89c4\u5212\u5668\u4ee5\u9002\u914d\u4e0d\u540c\u6a21\u578b\u4e0e\u5de5\u4f5c\u6d41\uff0c\u5305\u62ec\u5185\u7f6e\u601d\u7ef4 \u80fd\u529b\u9002\u914d\u4e0e\u663e\u5f0f\u89c4\u5212\uff08ReAct/Reflection \u7b49\uff09\u3002</p> <p>\u63a5\u53e3\u5b9a\u4e49\uff1a <code>planner.Planner</code>\u3002</p> <ul> <li><code>BuildPlanningInstruction(ctx, invocation, llmRequest) string</code>\uff1a\u6784\u5efa\u6216   \u6ce8\u5165\u7528\u4e8e\u89c4\u5212\u7684\u7cfb\u7edf\u63d0\u793a\u4e0e\u8bf7\u6c42\u914d\u7f6e\u3002</li> <li><code>ProcessPlanningResponse(ctx, invocation, response) *model.Response</code>\uff1a   \u5bf9\u6a21\u578b\u54cd\u5e94\u505a\u89c4\u5212\u540e\u5904\u7406\uff08\u53ef\u9009\uff09\u3002</li> </ul> <p>\u73b0\u6709\u5b9e\u73b0\u53c2\u8003\uff1a</p> <ul> <li><code>planner/builtin</code>\uff1a\u9002\u914d O \u7cfb\u5217\u3001Claude\u3001Gemini \u7b49\u5177\u5907\u63a8\u7406\u53c2\u6570\u7684\u6a21\u578b,   \u901a\u8fc7\u914d\u7f6e <code>ReasoningEffort</code>\u3001<code>ThinkingEnabled</code>\u3001<code>ThinkingTokens</code>\u3002</li> <li><code>planner/react</code>\uff1a\u63d0\u4f9b\u663e\u5f0f\u89c4\u5212\u6307\u4ee4\u4e0e\u54cd\u5e94\u540e\u5904\u7406, \u7ea6\u5b9a <code>/*PLANNING*/</code>\u3001   <code>/*ACTION*/</code>\u3001<code>/*REASONING*/</code>\u3001<code>/*FINAL_ANSWER*/</code> \u7b49\u6807\u7b7e\u3002</li> </ul> <p>\u751f\u6001\u5316\u65b9\u5411\uff1a</p> <ul> <li>Reflection Planner\uff1a\u81ea\u53cd\u5f0f\u4fee\u6b63\u4e0e\u591a\u8f6e\u518d\u89c4\u5212\u3002</li> <li>LangGraph \u98ce\u683c Planner\uff1a\u5bf9\u9f50 Pregel \u5e76\u884c\u4e0e\u68c0\u67e5\u70b9\u673a\u5236\u3002</li> <li>\u5de5\u5177\u4f18\u5148 Planner\uff1a\u9762\u5411 Tool-First \u6d41\u7a0b\u7684\u9009\u62e9\u4e0e\u7ea6\u675f\u3002</li> </ul> <p>\u63a5\u5165\u793a\u4f8b\uff08\u9aa8\u67b6\uff09\uff1a</p> <pre><code>package myplanner\n\nimport (\n    \"context\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/agent\"\n    \"trpc.group/trpc-go/trpc-agent-go/model\"\n    \"trpc.group/trpc-go/trpc-agent-go/planner\"\n)\n\ntype Planner struct{}\n\nvar _ planner.Planner = (*Planner)(nil)\n\nfunc New() *Planner { return &amp;Planner{} }\n\nfunc (p *Planner) BuildPlanningInstruction(ctx context.Context, inv *agent.Invocation, req *model.Request) string {\n    // \u53ef\u5411 req \u6ce8\u5165\u81ea\u5b9a\u4e49\u53c2\u6570, \u5e76\u8fd4\u56de\u7cfb\u7edf\u63d0\u793a\u4e32\n    return \"You must plan before action.\"\n}\n\nfunc (p *Planner) ProcessPlanningResponse(ctx context.Context, inv *agent.Invocation, rsp *model.Response) *model.Response {\n    if rsp == nil {\n        return nil\n    }\n    // \u53ef\u5bf9 rsp \u505a\u7ed3\u6784\u5316\u5207\u5206\u6216\u5de5\u5177\u8c03\u7528\u4fee\u6b63\n    return nil\n}\n</code></pre> <p>\u7ec4\u5408\u4e0e\u4f7f\u7528\uff1a \u5728 <code>agent/llmagent</code> \u521b\u5efa\u65f6\u6ce8\u5165 Planner\uff0c\u6216\u5728 <code>runner</code> \u5c42\u6309\u9700\u9009\u62e9\u4e0d\u540c Planner \u7b56\u7565\uff0c\u7ed3\u5408 <code>Tool</code> \u4e0e <code>Session</code> \u7ba1\u7406\u5b9e\u73b0\u7aef\u5230\u7aef\u3002</p> <p>\u8d21\u732e\u5efa\u8bae\uff1a</p> <ul> <li>\u5728 <code>planner/&lt;name&gt;/</code> \u63d0\u4f9b\u5b9e\u73b0\u4e0e README\u3001\u6d4b\u8bd5\u7528\u4f8b\u3001\u793a\u4f8b\u3002</li> <li>\u7ed3\u5408 <code>docs/overall-introduction.md</code> \u7684 Observability \u63d0\u4f9b\u7aef\u5230\u7aef\u793a\u4f8b\uff0c   \u4fbf\u4e8e\u524d\u7aef UI \u6f14\u793a\u3002</li> <li>\u9075\u5faa goimports \u4e0e\u9519\u8bef\u6d88\u606f\u98ce\u683c\uff0c\u6ce8\u91ca\u53e5\u672b\u52a0\u53e5\u53f7\uff0c\u4ee3\u7801\u6362\u884c\u7ea6 80 \u5217\u3002</li> </ul>"},{"location":"zh/ecosystem/#_2","title":"\u7ec4\u4ef6\u5173\u7cfb\u8bf4\u660e","text":""},{"location":"zh/ecosystem/#storagesessionmemory","title":"Storage\u3001Session\u3001Memory \u4e09\u8005\u7684\u5173\u7cfb","text":"<p>\u8fd9\u4e09\u4e2a\u7ec4\u4ef6\u5728\u67b6\u6784\u4e2d\u5177\u6709\u4e0d\u540c\u7684\u804c\u8d23\u548c\u5173\u7cfb\uff1a</p> <p>1. Storage\uff08\u5b58\u50a8\u5c42\uff09</p> <ul> <li>\u804c\u8d23\uff1a \u63d0\u4f9b\u7edf\u4e00\u7684\u5b58\u50a8\u5ba2\u6237\u7aef\u7ba1\u7406\uff0c\u4e3a Session \u548c Memory \u63d0\u4f9b\u57fa\u7840\u8bbe\u65bd\u652f\u6301</li> <li>\u529f\u80fd\uff1a \u6ce8\u518c\u3001\u7ba1\u7406\u548c\u83b7\u53d6\u5404\u79cd\u5b58\u50a8\u540e\u7aef\u7684\u5ba2\u6237\u7aef\uff08Redis\u3001PostgreSQL\u3001MongoDB \u7b49\uff09</li> <li>\u7279\u70b9\uff1a \u4f5c\u4e3a\u57fa\u7840\u8bbe\u65bd\u7ec4\u4ef6\uff0c\u53ef\u4ee5\u88ab Session \u548c Memory \u7ec4\u4ef6\u5171\u4eab\u4f7f\u7528</li> </ul> <p>2. Session\uff08\u4f1a\u8bdd\u5c42\uff09</p> <ul> <li>\u804c\u8d23\uff1a \u7ba1\u7406\u7528\u6237\u4f1a\u8bdd\u72b6\u6001\u548c\u4e8b\u4ef6</li> <li>\u529f\u80fd\uff1a \u521b\u5efa\u3001\u83b7\u53d6\u3001\u5220\u9664\u4f1a\u8bdd\uff0c\u7ba1\u7406\u4f1a\u8bdd\u72b6\u6001\uff0c\u8bb0\u5f55\u4f1a\u8bdd\u4e8b\u4ef6</li> <li>\u4f9d\u8d56\uff1a \u53ef\u4ee5\u590d\u7528 Storage \u6a21\u5757\u7684\u5ba2\u6237\u7aef</li> <li>\u6570\u636e\u7279\u70b9\uff1a \u4e34\u65f6\u6027\u6570\u636e\uff0c\u4f1a\u8bdd\u7ed3\u675f\u540e\u53ef\u4ee5\u6e05\u7406</li> </ul> <p>3. Memory\uff08\u8bb0\u5fc6\u5c42\uff09</p> <ul> <li>\u804c\u8d23\uff1a \u7ba1\u7406\u7528\u6237\u957f\u671f\u8bb0\u5fc6\u548c\u4e2a\u6027\u5316\u4fe1\u606f</li> <li>\u529f\u80fd\uff1a \u6dfb\u52a0\u3001\u641c\u7d22\u3001\u66f4\u65b0\u3001\u5220\u9664\u7528\u6237\u8bb0\u5fc6\uff0c\u63d0\u4f9b\u8bb0\u5fc6\u5de5\u5177</li> <li>\u4f9d\u8d56\uff1a \u53ef\u4ee5\u590d\u7528 Storage \u6a21\u5757\u7684\u5ba2\u6237\u7aef</li> <li>\u6570\u636e\u7279\u70b9\uff1a \u6301\u4e45\u6027\u6570\u636e\uff0c\u8de8\u4f1a\u8bdd\u4fdd\u6301</li> </ul> <p>\u5173\u7cfb\u56fe\uff1a</p> <pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502   Application   \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n          \u2502\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502   Session       \u2502    \u2502   Memory        \u2502\n\u2502   Service       \u2502    \u2502   Service       \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n          \u2502                      \u2502\n          \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                     \u2502\n          \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n          \u2502   Storage       \u2502\n          \u2502   Client        \u2502\n          \u2502   Management    \u2502\n          \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                     \u2502\n          \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n          \u2502   Storage       \u2502\n          \u2502   Backends      \u2502\n          \u2502   (Redis, DB)   \u2502\n          \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre> <p>\u4f7f\u7528\u793a\u4f8b\uff1a</p> <pre><code>// 1. \u6ce8\u518c\u5b58\u50a8\u5ba2\u6237\u7aef\nstorage.RegisterRedisInstance(\"default\", storage.WithClientBuilderURL(\"redis://localhost:6379\"))\n\n// 2. Session \u670d\u52a1\u4f7f\u7528\u5b58\u50a8\u5ba2\u6237\u7aef\nsessionService, err := session.NewRedisService(\n    session.WithRedisInstance(\"default\"),\n)\n\n// 3. Memory \u670d\u52a1\u4f7f\u7528\u5b58\u50a8\u5ba2\u6237\u7aef\nmemoryService, err := memory.NewRedisService(\n    memory.WithRedisInstance(\"default\"),\n)\n\n// 4. \u5e94\u7528\u4e2d\u4f7f\u7528\nsession, err := sessionService.CreateSession(ctx, sessionKey, state)\nmemory, err := memoryService.AddMemory(ctx, userKey, \"\u7528\u6237\u559c\u6b22\u5496\u5561\", []string{\"preferences\"})\n</code></pre>"},{"location":"zh/ecosystem/#_3","title":"\u8d21\u732e\u6307\u5bfc","text":""},{"location":"zh/ecosystem/#_4","title":"\u8d21\u732e\u6307\u5bfc","text":"<p>\u9002\u5408\u7684\u7ec4\u4ef6\uff1a</p> <ul> <li>\u5404\u79cd\u7b2c\u4e09\u65b9\u670d\u52a1\u548c\u5de5\u5177\u7684\u96c6\u6210</li> <li>\u5f00\u6e90\u7ec4\u4ef6\u9002\u914d\u5668</li> <li>\u6807\u51c6\u534f\u8bae\u652f\u6301</li> <li>\u6846\u67b6\u529f\u80fd\u6269\u5c55</li> </ul> <p>\u8d21\u732e\u6d41\u7a0b\uff1a</p> <ol> <li>Fork <code>https://github.com/trpc-group/trpc-agent-go</code></li> <li>\u5728\u5bf9\u5e94\u6a21\u5757\u7684\u6839\u76ee\u5f55\u4e0b\u521b\u5efa\u7ec4\u4ef6\uff08\u5982 <code>model/somemodel</code>\u3001<code>tool/sometool</code>\u3001<code>agent/someagent</code>\uff09</li> <li>\u5b9e\u73b0\u76f8\u5e94\u7684\u63a5\u53e3</li> <li>\u7f16\u5199\u6d4b\u8bd5\u548c\u6587\u6863</li> <li>\u63d0\u4ea4 Pull Request</li> </ol> <p>\u76ee\u5f55\u7ed3\u6784\u793a\u4f8b\uff1a</p> <pre><code>model/gemini/\n\u251c\u2500\u2500 model.go\n\u251c\u2500\u2500 config.go\n\u251c\u2500\u2500 examples/\n\u251c\u2500\u2500 README.md\n\u2514\u2500\u2500 gemini_test.go\n</code></pre>"},{"location":"zh/ecosystem/#_5","title":"\u603b\u7ed3","text":"<p>\u751f\u6001\u5efa\u8bbe\u662f tRPC-Agent-Go \u53d1\u5c55\u7684\u91cd\u8981\u65b9\u5411\u3002\u901a\u8fc7\u5b9e\u73b0\u6807\u51c6\u63a5\u53e3\uff0c\u53ef\u4ee5\u8f7b\u677e\u96c6\u6210\u5404\u79cd\u7b2c\u4e09\u65b9\u670d\u52a1\u548c\u5de5\u5177\uff0c\u6269\u5c55\u6846\u67b6\u7684\u80fd\u529b\u3002</p> <p>\u8d21\u732e\u8981\u70b9\uff1a</p> <ul> <li>\u53c2\u8003\u73b0\u6709\u5b9e\u73b0\uff0c\u4e86\u89e3\u63a5\u53e3\u4f7f\u7528\u65b9\u5f0f</li> <li>\u6839\u636e\u7ec4\u4ef6\u7c7b\u578b\u9009\u62e9\u5408\u9002\u7684\u8d21\u732e\u8def\u5f84</li> <li>\u9075\u5faa\u7edf\u4e00\u7684\u63a5\u53e3\u89c4\u8303\u548c\u4ee3\u7801\u6807\u51c6</li> <li>\u63d0\u4f9b\u5b8c\u6574\u7684\u6d4b\u8bd5\u7528\u4f8b\u548c\u6587\u6863</li> </ul> <p>\u5224\u65ad\u8d21\u732e\u4f4d\u7f6e\uff1a</p> <ul> <li>\u6838\u5fc3\u901a\u7528\u7ec4\u4ef6\uff1a\u5982\u679c\u662f\u6bd4\u8f83\u6838\u5fc3\u90fd\u80fd\u7528\u5f97\u5230\u7684\u7ec4\u4ef6\uff0c\u76f4\u63a5\u8d21\u732e\u5230 GitHub \u5bf9\u5e94\u6a21\u5757\u76ee\u5f55</li> <li>\u751f\u6001\u7ec4\u4ef6\uff08\u5f00\u6e90\u4f9d\u8d56\uff09\uff1a\u5982\u679c\u4f9d\u8d56\u516c\u5f00\u5f00\u6e90\u7ec4\u4ef6\uff0c\u8d21\u732e\u5230 GitHub \u7684 ecosystem \u76ee\u5f55</li> </ul> <p>Storage\u3001Session\u3001Memory \u7ec4\u4ef6\u7279\u70b9\uff1a</p> <ul> <li>Storage\uff1a \u63d0\u4f9b\u7edf\u4e00\u7684\u5ba2\u6237\u7aef\u7ba1\u7406\uff0c\u53ef\u4ee5\u88ab Session \u548c Memory \u5171\u4eab</li> <li>Session\uff1a \u7ba1\u7406\u4e34\u65f6\u4f1a\u8bdd\u6570\u636e\uff0c\u53ef\u4ee5\u590d\u7528 Storage \u5ba2\u6237\u7aef</li> <li>Memory\uff1a \u7ba1\u7406\u6301\u4e45\u8bb0\u5fc6\u6570\u636e\uff0c\u53ef\u4ee5\u590d\u7528 Storage \u5ba2\u6237\u7aef</li> <li>\u4e09\u4e2a\u7ec4\u4ef6\u901a\u8fc7\u63a5\u53e3\u89e3\u8026\uff0c\u652f\u6301\u72ec\u7acb\u5b9e\u73b0\u548c\u7ec4\u5408\u4f7f\u7528</li> </ul>"},{"location":"zh/evaluation/","title":"Evaluation \u4f7f\u7528\u6587\u6863","text":"<p>Evaluation \u63d0\u4f9b\u5b8c\u6574\u7684 Agent \u8bc4\u4f30\u6846\u67b6\uff0c\u652f\u6301\u672c\u5730\u6587\u4ef6\u548c\u5185\u5b58\u4e24\u79cd\u6a21\u5f0f\u7684\u8bc4\u4f30\u6570\u636e\u7ba1\u7406\uff0c\u63d0\u4f9b\u4e86 Agent \u7684\u591a\u7ef4\u5ea6\u8bc4\u4f30\u529f\u80fd\u3002</p>"},{"location":"zh/evaluation/#_1","title":"\u5feb\u901f\u5f00\u59cb","text":"<p>\u672c\u8282\u4ecb\u7ecd\u5982\u4f55\u5728\u672c\u5730\u6587\u4ef6\u7cfb\u7edf local \u6216\u5185\u5b58 inmemory \u6a21\u5f0f\u4e0b\u6267\u884c Agent \u8bc4\u4f30\u6d41\u7a0b\u3002</p>"},{"location":"zh/evaluation/#local","title":"\u672c\u5730\u6587\u4ef6\u7cfb\u7edf local","text":"<p>local \u5728\u672c\u5730\u6587\u4ef6\u7cfb\u7edf\u4e0a\u7ef4\u62a4\u8bc4\u4f30\u96c6\u3001\u8bc4\u4f30\u6307\u6807\u548c\u8bc4\u4f30\u7ed3\u679c\u3002</p> <p>\u5b8c\u6574\u793a\u4f8b\u53c2\u89c1 examples/evaluation/local\u3002</p>"},{"location":"zh/evaluation/#_2","title":"\u4ee3\u7801","text":"<pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation\"\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation/evalresult\"\n    evalresultlocal \"trpc.group/trpc-go/trpc-agent-go/evaluation/evalresult/local\"\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation/evalset\"\n    evalsetlocal \"trpc.group/trpc-go/trpc-agent-go/evaluation/evalset/local\"\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation/evaluator/registry\"\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation/metric\"\n    metriclocal \"trpc.group/trpc-go/trpc-agent-go/evaluation/metric/local\"\n    \"trpc.group/trpc-go/trpc-agent-go/runner\"\n)\n\n// \u521b\u5efa Runner\nrunner := runner.NewRunner(appName, agent)\n// \u521b\u5efa\u8bc4\u4f30\u96c6 EvalSet Manager\u3001\u8bc4\u4f30\u6307\u6807 Metric Manager\u3001\u8bc4\u4f30\u7ed3\u679c EvalResult Manager\u3001\u8bc4\u4f30\u5668\u6ce8\u518c\u4e2d\u5fc3 Registry\nevalSetManager := evalsetlocal.New(evalset.WithBaseDir(*inputDir))\nmetricManager := metriclocal.New(metric.WithBaseDir(*inputDir))\nevalResultManager := evalresultlocal.New(evalresult.WithBaseDir(*outputDir))\nregistry := registry.New()\n// \u521b\u5efa AgentEvaluator\nagentEvaluator, err := evaluation.New(\n    appName,\n    runner,\n    evaluation.WithEvalSetManager(evalSetManager),\n    evaluation.WithMetricManager(metricManager),\n    evaluation.WithEvalResultManager(evalResultManager),\n    evaluation.WithRegistry(registry),\n    evaluation.WithNumRuns(numRuns),\n)\nif err != nil {\n    log.Fatalf(\"create evaluator: %v\", err)\n}\n// \u6267\u884c\u8bc4\u4f30\nresult, err := agentEvaluator.Evaluate(context.Background(), evalSetID)\nif err != nil {\n    log.Fatalf(\"evaluate: %v\", err)\n}\n</code></pre>"},{"location":"zh/evaluation/#evalset","title":"\u8bc4\u4f30\u96c6 EvalSet \u6587\u4ef6\u793a\u4f8b","text":"<pre><code>{\n  \"evalSetId\": \"math-basic\",\n  \"name\": \"math-basic\",\n  \"evalCases\": [\n    {\n      \"evalId\": \"calc_add\",\n      \"conversation\": [\n        {\n          \"invocationId\": \"calc_add-1\",\n          \"userContent\": {\n            \"role\": \"user\",\n            \"content\": \"calc add 2 3\"\n          },\n          \"finalResponse\": {\n            \"role\": \"assistant\",\n            \"content\": \"calc result: 5\"\n          },\n          \"tools\": [\n            {\n              \"id\": \"tool_use_1\",\n              \"name\": \"calculator\",\n              \"arguments\": {\n                \"operation\": \"add\",\n                \"a\": 2,\n                \"b\": 3\n              },\n              \"result\": {\n                \"a\": 2,\n                \"b\": 3,\n                \"operation\": \"add\",\n                \"result\": 5\n              }\n            }\n          ]\n        }\n      ],\n      \"sessionInput\": {\n        \"appName\": \"math-eval-app\",\n        \"userId\": \"user\"\n      }\n    }\n  ],\n  \"creationTimestamp\": 1761134484.9804401\n}\n</code></pre>"},{"location":"zh/evaluation/#metric","title":"\u8bc4\u4f30\u6307\u6807 Metric \u6587\u4ef6\u793a\u4f8b","text":"<pre><code>[\n  {\n    \"metricName\": \"tool_trajectory_avg_score\",\n    \"threshold\": 1,\n    \"criterion\": {\n      \"toolTrajectory\": {\n        \"orderSensitive\": false,\n        \"defaultStrategy\": {\n          \"name\": {\n            \"matchStrategy\": \"exact\"\n          },\n          \"arguments\": {\n            \"matchStrategy\": \"exact\"\n          },\n          \"result\": {\n            \"matchStrategy\": \"exact\"\n          }\n        }\n      }\n    }\n  }\n]\n</code></pre>"},{"location":"zh/evaluation/#evalresult","title":"\u8bc4\u4f30\u7ed3\u679c EvalResult \u6587\u4ef6\u793a\u4f8b","text":"<pre><code>{\n  \"evalSetResultId\": \"math-eval-app_math-basic_538cdf6e-925d-41cf-943b-2849982b195e\",\n  \"evalSetResultName\": \"math-eval-app_math-basic_538cdf6e-925d-41cf-943b-2849982b195e\",\n  \"evalSetId\": \"math-basic\",\n  \"evalCaseResults\": [\n    {\n      \"evalSetId\": \"math-basic\",\n      \"evalId\": \"calc_add\",\n      \"finalEvalStatus\": \"passed\",\n      \"overallEvalMetricResults\": [\n        {\n          \"metricName\": \"tool_trajectory_avg_score\",\n          \"score\": 1,\n          \"evalStatus\": \"passed\",\n          \"threshold\": 1,\n          \"criterion\": {\n            \"toolTrajectory\": {\n              \"defaultStrategy\": {\n                \"name\": {\n                  \"matchStrategy\": \"exact\"\n                },\n                \"arguments\": {\n                  \"matchStrategy\": \"exact\"\n                },\n                \"result\": {\n                  \"matchStrategy\": \"exact\"\n                }\n              }\n            }\n          },\n          \"details\": {\n            \"score\": 1\n          }\n        }\n      ],\n      \"evalMetricResultPerInvocation\": [\n        {\n          \"actualInvocation\": {\n            \"invocationId\": \"5cc1f162-37e6-4d07-90e9-eb3ec5205b8d\",\n            \"userContent\": {\n              \"role\": \"user\",\n              \"content\": \"calc add 2 3\"\n            },\n            \"finalResponse\": {\n              \"role\": \"assistant\",\n              \"content\": \"The result of 2 + 3 is **5**.\"\n            },\n            \"tools\": [\n              {\n                \"id\": \"call_00_etTEEthmCocxvq7r3m2LJRXf\",\n                \"name\": \"calculator\",\n                \"arguments\": {\n                  \"a\": 2,\n                  \"b\": 3,\n                  \"operation\": \"add\"\n                },\n                \"result\": {\n                  \"a\": 2,\n                  \"b\": 3,\n                  \"operation\": \"add\",\n                  \"result\": 5\n                }\n              }\n            ]\n          },\n          \"expectedInvocation\": {\n            \"invocationId\": \"calc_add-1\",\n            \"userContent\": {\n              \"role\": \"user\",\n              \"content\": \"calc add 2 3\"\n            },\n            \"finalResponse\": {\n              \"role\": \"assistant\",\n              \"content\": \"calc result: 5\"\n            },\n            \"tools\": [\n              {\n                \"id\": \"tool_use_1\",\n                \"name\": \"calculator\",\n                \"arguments\": {\n                  \"a\": 2,\n                  \"b\": 3,\n                  \"operation\": \"add\"\n                },\n                \"result\": {\n                  \"a\": 2,\n                  \"b\": 3,\n                  \"operation\": \"add\",\n                  \"result\": 5\n                }\n              }\n            ]\n          },\n          \"evalMetricResults\": [\n            {\n              \"metricName\": \"tool_trajectory_avg_score\",\n              \"score\": 1,\n              \"evalStatus\": \"passed\",\n              \"threshold\": 1,\n              \"criterion\": {\n                \"toolTrajectory\": {\n                  \"defaultStrategy\": {\n                    \"name\": {\n                      \"matchStrategy\": \"exact\"\n                    },\n                    \"arguments\": {\n                      \"matchStrategy\": \"exact\"\n                    },\n                    \"result\": {\n                      \"matchStrategy\": \"exact\"\n                    }\n                  }\n                }\n              },\n              \"details\": {\n                \"score\": 1\n              }\n            }\n          ]\n        }\n      ],\n      \"sessionId\": \"19877398-9586-4a97-b1d3-f8ce636ea54f\",\n      \"userId\": \"user\"\n    }\n  ],\n  \"creationTimestamp\": 1766455261.342534\n}\n</code></pre>"},{"location":"zh/evaluation/#inmemory","title":"\u5185\u5b58 inmemory","text":"<p>inmemory \u5728\u5185\u5b58\u4e2d\u7ef4\u62a4\u8bc4\u4f30\u96c6\u3001\u8bc4\u4f30\u6307\u6807\u548c\u8bc4\u4f30\u7ed3\u679c\u3002</p> <p>\u5b8c\u6574\u793a\u4f8b\u53c2\u89c1 examples/evaluation/inmemory\u3002</p>"},{"location":"zh/evaluation/#_3","title":"\u4ee3\u7801","text":"<pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation\"\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation/evalresult\"\n    evalresultinmemory \"trpc.group/trpc-go/trpc-agent-go/evaluation/evalresult/inmemory\"\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation/evalset\"\n    evalsetinmemory \"trpc.group/trpc-go/trpc-agent-go/evaluation/evalset/inmemory\"\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation/evaluator/registry\"\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation/metric\"\n    metricinmemory \"trpc.group/trpc-go/trpc-agent-go/evaluation/metric/inmemory\"\n    \"trpc.group/trpc-go/trpc-agent-go/runner\"\n)\n\n// \u521b\u5efa Runner\nrun := runner.NewRunner(appName, agent)\n// \u521b\u5efa\u8bc4\u4f30\u96c6 EvalSet Manager\u3001\u8bc4\u4f30\u6307\u6807 Metric Manager\u3001\u8bc4\u4f30\u7ed3\u679c EvalResult Manager\u3001\u8bc4\u4f30\u5668\u6ce8\u518c\u4e2d\u5fc3 Registry\nevalSetManager := evalsetinmemory.New()\nmetricManager := metricinmemory.New()\nevalResultManager := evalresultinmemory.New()\nregistry := registry.New()\n// \u6784\u5efa\u8bc4\u4f30\u96c6\u6570\u636e\nif err := prepareEvalSet(ctx, evalSetManager); err != nil {\n    log.Fatalf(\"prepare eval set: %v\", err)\n}\n// \u6784\u5efa\u8bc4\u4f30\u6307\u6807\u6570\u636e\nif err := prepareMetric(ctx, metricManager); err != nil {\n    log.Fatalf(\"prepare metric: %v\", err)\n}\n// \u521b\u5efa AgentEvaluator\nagentEvaluator, err := evaluation.New(\n    appName,\n    run,\n    evaluation.WithEvalSetManager(evalSetManager),\n    evaluation.WithMetricManager(metricManager),\n    evaluation.WithEvalResultManager(evalResultManager),\n    evaluation.WithRegistry(registry),\n    evaluation.WithNumRuns(numRuns),\n)\nif err != nil {\n    log.Fatalf(\"create evaluator: %v\", err)\n}\n// \u6267\u884c\u8bc4\u4f30\nresult, err := agentEvaluator.Evaluate(ctx, evalSetID)\nif err != nil {\n    log.Fatalf(\"evaluate: %v\", err)\n}\n</code></pre>"},{"location":"zh/evaluation/#evalset_1","title":"\u8bc4\u4f30\u96c6 EvalSet \u6784\u5efa","text":"<pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/model\"\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation/evalset\"\n)\n\nif _, err := evalSetManager.Create(ctx, appName, evalSetID); err != nil {\n    return err\n}\ncases := []*evalset.EvalCase{\n    {\n        EvalID: \"calc_add\",\n        Conversation: []*evalset.Invocation{\n            {\n                InvocationID: \"calc_add-1\",\n                UserContent: &amp;model.Message{\n                    Role:    model.RoleUser,\n                    Content: \"calc add 2 3\",\n                },\n                FinalResponse: &amp;model.Message{\n                    Role:    model.RoleAssistant,\n                    Content: \"calc result: 5\",\n                },\n                Tools: []*evalset.Tool{\n                    {\n                        ID:   \"tool_use_1\",\n                        Name: \"calculator\",\n                        Arguments: map[string]any{\n                            \"operation\": \"add\",\n                            \"a\":         2,\n                            \"b\":         3,\n                        },\n                        Result: map[string]any{\n                            \"a\":         2,\n                            \"b\":         3,\n                            \"operation\": \"add\",\n                            \"result\":    5,\n                        },\n                    },\n                },\n            },\n        },\n        SessionInput: &amp;evalset.SessionInput{\n            AppName: appName,\n            UserID:  \"user\",\n        },\n    },\n}\nfor _, evalCase := range cases {\n    if err := evalSetManager.AddCase(ctx, appName, evalSetID, evalCase); err != nil {\n        return err\n    }\n}\n</code></pre>"},{"location":"zh/evaluation/#metric_1","title":"\u8bc4\u4f30\u6307\u6807 Metric \u6784\u5efa","text":"<pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation/metric\"\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation/metric/criterion\"\n    cjson \"trpc.group/trpc-go/trpc-agent-go/evaluation/metric/criterion/json\"\n    ctext \"trpc.group/trpc-go/trpc-agent-go/evaluation/metric/criterion/text\"\n    ctooltrajectory \"trpc.group/trpc-go/trpc-agent-go/evaluation/metric/criterion/tooltrajectory\"\n)\n\nevalMetric := &amp;metric.EvalMetric{\n    MetricName: \"tool_trajectory_avg_score\",\n    Threshold:  1.0,\n    Criterion: criterion.New(\n        criterion.WithToolTrajectory(\n            ctooltrajectory.New(\n                ctooltrajectory.WithDefault(\n                    &amp;ctooltrajectory.ToolTrajectoryStrategy{\n                        Name: &amp;ctext.TextCriterion{\n                            MatchStrategy: ctext.TextMatchStrategyExact,\n                        },\n                        Arguments: &amp;cjson.JSONCriterion{\n                            MatchStrategy: cjson.JSONMatchStrategyExact,\n                        },\n                        Result: &amp;cjson.JSONCriterion{\n                            MatchStrategy: cjson.JSONMatchStrategyExact,\n                        },\n                    },\n                ),\n            ),\n        ),\n    ),\n}\nmetricManager.Add(ctx, appName, evalSetID, evalMetric)\n</code></pre>"},{"location":"zh/evaluation/#_4","title":"\u6838\u5fc3\u6982\u5ff5","text":"<ul> <li>\u8bc4\u4f30\u96c6 EvalSet \u63d0\u4f9b\u8bc4\u4f30\u6240\u9700\u7684\u6570\u636e\u96c6\uff0c\u5305\u542b\u7528\u6237\u8f93\u5165\u53ca\u5176\u5bf9\u5e94\u7684\u9884\u671f Agent \u8f93\u51fa\u3002</li> <li>\u8bc4\u4f30\u6307\u6807 Metric \u5b9a\u4e49\u7528\u4e8e\u8861\u91cf\u6a21\u578b\u8868\u73b0\u7684\u6307\u6807\u4fe1\u606f\uff0c\u5305\u62ec\u6307\u6807\u540d\u79f0\u53ca\u5bf9\u5e94\u7684\u5206\u6570\u9608\u503c\u3002</li> <li>\u8bc4\u4f30\u5668 Evaluator \u8d1f\u8d23\u5bf9\u6bd4\u5b9e\u9645\u4f1a\u8bdd\u7ed3\u679c\u4e0e\u9884\u671f\u4f1a\u8bdd\u7ed3\u679c\uff0c\u8ba1\u7b97\u5177\u4f53\u5f97\u5206\uff0c\u5e76\u4f9d\u636e\u8bc4\u4f30\u6307\u6807\u9608\u503c\u5224\u65ad\u8bc4\u4f30\u72b6\u6001\u3002</li> <li>\u8bc4\u4f30\u5668\u6ce8\u518c\u4e2d\u5fc3 Registry \u7ef4\u62a4\u8bc4\u4f30\u6307\u6807\u540d\u79f0\u4e0e\u5bf9\u5e94\u8bc4\u4f30\u5668\u7684\u6620\u5c04\u5173\u7cfb\uff0c\u652f\u6301\u52a8\u6001\u6ce8\u518c\u4e0e\u67e5\u627e\u8bc4\u4f30\u5668\u3002</li> <li>\u8bc4\u4f30\u670d\u52a1 Service \u4f5c\u4e3a\u6838\u5fc3\u7ec4\u4ef6\uff0c\u6574\u5408\u4e86\u5f85\u8bc4\u4f30\u7684 Agent\u3001\u8bc4\u4f30\u96c6 EvalSet\u3001\u8bc4\u4f30\u6307\u6807 Metric\u3001\u8bc4\u4f30\u5668\u6ce8\u518c\u4e2d\u5fc3 Registry \u4ee5\u53ca\u8bc4\u4f30\u7ed3\u679c EvalResult Registry\u3002\u8bc4\u4f30\u6d41\u7a0b\u5206\u4e3a\u4e24\u4e2a\u9636\u6bb5\uff1a<ul> <li>\u63a8\u7406\u9636\u6bb5 Inference\uff1a\u4ece\u8bc4\u4f30\u96c6\u63d0\u53d6\u7528\u6237\u8f93\u5165\uff0c\u8c03\u7528 Agent \u6267\u884c\u63a8\u7406\uff0c\u5c06 Agent \u7684\u5b9e\u9645\u8f93\u51fa\u4e0e\u9884\u671f\u8f93\u51fa\u7ec4\u5408\u5f62\u6210\u63a8\u7406\u7ed3\u679c\u3002</li> <li>\u7ed3\u679c\u8bc4\u4f30\u9636\u6bb5 Evaluate\uff1a\u6839\u636e\u8bc4\u4f30\u6307\u6807\u540d\u79f0 Metric Name \u4ece\u6ce8\u518c\u4e2d\u5fc3\u83b7\u53d6\u76f8\u5e94\u7684\u8bc4\u4f30\u5668\uff0c\u5e76\u4f7f\u7528\u591a\u4e2a\u8bc4\u4f30\u5668\u5bf9\u63a8\u7406\u7ed3\u679c\u8fdb\u884c\u591a\u7ef4\u5ea6\u8bc4\u4f30\uff0c\u6700\u7ec8\u751f\u6210\u8bc4\u4f30\u7ed3\u679c  EvalResult\u3002</li> </ul> </li> <li>Agent Evaluator \u4e3a\u964d\u4f4e Agent \u8f93\u51fa\u7684\u5076\u7136\u6027\uff0c\u8bc4\u4f30\u670d\u52a1\u4f1a\u88ab\u8c03\u7528 NumRuns \u6b21\uff0c\u5e76\u805a\u5408\u591a\u6b21\u7ed3\u679c\uff0c\u4ee5\u83b7\u5f97\u66f4\u7a33\u5b9a\u7684\u8bc4\u4f30\u7ed3\u679c\u3002</li> </ul>"},{"location":"zh/evaluation/#-evalset","title":"\u8bc4\u4f30\u96c6 -- EvalSet","text":"<p>EvalSet \u662f\u4e00\u7ec4 EvalCase \u7684\u96c6\u5408\uff0c\u901a\u8fc7\u552f\u4e00\u7684 EvalSetID \u8fdb\u884c\u6807\u8bc6\uff0c\u4f5c\u4e3a\u8bc4\u4f30\u6d41\u7a0b\u4e2d\u7684\u4f1a\u8bdd\u6570\u636e\u3002</p> <p>\u800c EvalCase \u8868\u793a\u540c\u4e00 Session \u4e0b\u7684\u4e00\u7ec4\u8bc4\u4f30\u7528\u4f8b\uff0c\u5305\u542b\u552f\u4e00\u6807\u8bc6\u7b26 EvalID\u3001\u5bf9\u8bdd\u5185\u5bb9\u4ee5\u53ca Session \u521d\u59cb\u5316\u4fe1\u606f\u3002</p> <p>\u5bf9\u8bdd\u6570\u636e\u5305\u62ec\u4e09\u7c7b\u5185\u5bb9\uff1a</p> <ul> <li>\u7528\u6237\u8f93\u5165</li> <li>Agent \u6700\u7ec8\u54cd\u5e94</li> <li>\u5de5\u5177\u8c03\u7528\u4e0e\u7ed3\u679c</li> <li>\u4e2d\u95f4\u54cd\u5e94\u4fe1\u606f</li> </ul> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation/epochtime\"\n    \"trpc.group/trpc-go/trpc-agent-go/model\"\n)\n\n// EvalSet \u8868\u793a\u4e00\u4e2a\u8bc4\u4f30\u96c6\ntype EvalSet struct {\n    EvalSetID         string               // \u8bc4\u4f30\u96c6\u552f\u4e00\u6807\u8bc6\n    Name              string               // \u8bc4\u4f30\u96c6\u540d\u79f0\n    Description       string               // \u8bc4\u4f30\u96c6\u63cf\u8ff0\n    EvalCases         []*EvalCase          // \u6240\u6709\u8bc4\u4f30\u7528\u4f8b\n    CreationTimestamp *epochtime.EpochTime // \u521b\u5efa\u65f6\u95f4\n}\n\n// EvalCase \u8868\u793a\u5355\u4e2a\u8bc4\u4f30\u7528\u4f8b\ntype EvalCase struct {\n    EvalID            string               // \u7528\u4f8b\u552f\u4e00\u6807\u8bc6\n    Conversation      []*Invocation        // \u5bf9\u8bdd\u5e8f\u5217\n    SessionInput      *SessionInput        // Session \u521d\u59cb\u5316\u6570\u636e\n    CreationTimestamp *epochtime.EpochTime // \u521b\u5efa\u65f6\u95f4\n}\n\n// Invocation \u8868\u793a\u4e00\u6b21\u7528\u6237\u4e0e Agent \u7684\u4ea4\u4e92\ntype Invocation struct {\n    InvocationID          string\n    UserContent           *model.Message       // \u7528\u6237\u8f93\u5165\n    FinalResponse         *model.Message       // Agent \u6700\u7ec8\u54cd\u5e94\n    Tools                 []*Tool              // \u5de5\u5177\u8c03\u7528\u4e0e\u5de5\u5177\u6267\u884c\u7ed3\u679c\n    IntermediateResponses []*model.Message     // Agent \u4e2d\u95f4\u54cd\u5e94\u6570\u636e\n    CreationTimestamp     *epochtime.EpochTime // \u521b\u5efa\u65f6\u95f4\n}\n\n// Tool \u8868\u793a\u4e00\u6b21\u5de5\u5177\u8c03\u7528\u548c\u5de5\u5177\u6267\u884c\u7ed3\u679c\ntype Tool struct {\n    ID        string         // \u5de5\u5177\u8c03\u7528 ID\n    Name      string         // \u5de5\u5177\u540d\n    Arguments map[string]any // \u5de5\u5177\u8c03\u7528\u8f93\u5165\u53c2\u6570\n    Result    map[string]any // \u5de5\u5177\u6267\u884c\u7ed3\u679c\n}\n\n// SessionInput \u8868\u793a Session \u521d\u59cb\u5316\u8f93\u5165\ntype SessionInput struct {\n    AppName string         // \u5e94\u7528\u540d\n    UserID  string         // \u7528\u6237 ID\n    State   map[string]any // \u521d\u59cb\u72b6\u6001\n}\n</code></pre> <p>EvalSet Manager \u8d1f\u8d23\u5bf9\u8bc4\u4f30\u96c6\u8fdb\u884c\u589e\u5220\u6539\u67e5\u7b49\u64cd\u4f5c\uff0c\u63a5\u53e3\u5b9a\u4e49\u5982\u4e0b\uff1a</p> <pre><code>type Manager interface {\n    Get(ctx context.Context, appName, evalSetID string) (*EvalSet, error)                  // \u83b7\u53d6\u6307\u5b9a EvalSet\n    Create(ctx context.Context, appName, evalSetID string) (*EvalSet, error)               // \u521b\u5efa\u65b0 EvalSet\n    List(ctx context.Context, appName string) ([]string, error)                            // \u5217\u51fa\u6240\u6709 EvalSet ID\n    Delete(ctx context.Context, appName, evalSetID string) error                           // \u5220\u9664\u6307\u5b9a EvalSet\n    GetCase(ctx context.Context, appName, evalSetID, evalCaseID string) (*EvalCase, error) // \u83b7\u53d6\u6307\u5b9a\u7528\u4f8b\n    AddCase(ctx context.Context, appName, evalSetID string, evalCase *EvalCase) error      // \u5411\u8bc4\u4f30\u96c6\u6dfb\u52a0\u7528\u4f8b\n    UpdateCase(ctx context.Context, appName, evalSetID string, evalCase *EvalCase) error   // \u66f4\u65b0\u7528\u4f8b\n    DeleteCase(ctx context.Context, appName, evalSetID, evalCaseID string) error           // \u5220\u9664\u7528\u4f8b\n}\n</code></pre> <p>\u6846\u67b6\u4e3a EvalSet Manager \u63d0\u4f9b\u4e86\u4e24\u79cd\u5b9e\u73b0\uff1a</p> <ul> <li>local\uff1a\u5c06\u8bc4\u4f30\u96c6\u5b58\u50a8\u5728\u672c\u5730\u6587\u4ef6\u7cfb\u7edf\u4e2d\uff0c\u6587\u4ef6\u547d\u540d\u683c\u5f0f\u4e3a <code>&lt;EvalSetID&gt;.evalset.json</code>\u3002</li> <li>inmemory\uff1a\u5c06\u8bc4\u4f30\u96c6\u5b58\u50a8\u5728\u5185\u5b58\u4e2d\uff0c\u6240\u6709\u64cd\u4f5c\u5747\u4fdd\u8bc1\u6df1\u62f7\u8d1d\uff0c\u9002\u7528\u4e8e\u4e34\u65f6\u6d4b\u8bd5\u573a\u666f\u3002</li> </ul>"},{"location":"zh/evaluation/#-metric","title":"\u8bc4\u4f30\u6307\u6807 -- Metric","text":"<p>Metric \u8868\u793a\u4e00\u4e2a\u8bc4\u4f30\u6307\u6807\uff0c\u7528\u4e8e\u8861\u91cf EvalSet \u7684\u67d0\u4e00\u65b9\u9762\u8868\u73b0\uff0c\u6bcf\u4e2a\u8bc4\u4f30\u6307\u6807\u5305\u542b\u6307\u6807\u540d\u3001\u8bc4\u4f30\u51c6\u5219\u548c\u8bc4\u5206\u9608\u503c\u3002</p> <p>\u8bc4\u4f30\u8fc7\u7a0b\u4e2d\uff0c\u8bc4\u4f30\u5668\u4f1a\u6839\u636e\u914d\u7f6e\u7684\u8bc4\u4f30\u51c6\u5219\u5bf9\u5b9e\u9645\u4f1a\u8bdd\u4e0e\u9884\u671f\u4f1a\u8bdd\u8fdb\u884c\u6bd4\u8f83\uff0c\u8ba1\u7b97\u51fa\u8be5\u6307\u6807\u7684\u8bc4\u4f30\u5f97\u5206\uff0c\u5e76\u4e0e\u9608\u503c\u8fdb\u884c\u5bf9\u6bd4\uff1a</p> <ul> <li>\u5f53\u8bc4\u4f30\u5f97\u5206\u4f4e\u4e8e\u9608\u503c\u65f6\uff0c\u6307\u6807\u5224\u5b9a\u4e3a\u672a\u901a\u8fc7\u3002</li> <li>\u5f53\u8bc4\u4f30\u5f97\u5206\u8fbe\u5230\u6216\u8d85\u8fc7\u9608\u503c\u65f6\uff0c\u6307\u6807\u5224\u5b9a\u4e3a\u901a\u8fc7\u3002</li> </ul> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation/metric/criterion\"\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation/metric/criterion/tooltrajectory\"\n)\n\n// EvalMetric \u8868\u793a\u7528\u4e8e\u8bc4\u4f30 EvalCase \u7684\u5355\u9879\u6307\u6807\ntype EvalMetric struct {\n    MetricName string               // \u6307\u6807\u540d\u79f0\n    Threshold  float64              // \u8bc4\u5206\u9608\u503c\n    Criterion  *criterion.Criterion // \u8bc4\u4f30\u51c6\u5219\n}\n\n// Criterion \u805a\u5408\u5404\u7c7b\u8bc4\u4f30\u51c6\u5219\ntype Criterion struct {\n    ToolTrajectory *tooltrajectory.ToolTrajectoryCriterion // \u5de5\u5177\u8f68\u8ff9\u8bc4\u4f30\u51c6\u5219\n}\n</code></pre> <p>Metric Manager \u8d1f\u8d23\u7ba1\u7406\u8bc4\u4f30\u6307\u6807\u3002</p> <p>\u6bcf\u4e2a EvalSet \u53ef\u4ee5\u62e5\u6709\u591a\u4e2a\u8bc4\u4f30\u6307\u6807\uff0c\u901a\u8fc7 <code>MetricName</code> \u533a\u5206\u3002</p> <p>\u63a5\u53e3\u5b9a\u4e49\u5982\u4e0b:</p> <pre><code>type Manager interface {\n    List(ctx context.Context, appName, evalSetID string) ([]string, error)               // \u8fd4\u56de\u6307\u5b9a EvalSet \u4e0b\u6240\u6709\u7684 Metric Name\n    Get(ctx context.Context, appName, evalSetID, metricName string) (*EvalMetric, error) // \u83b7\u53d6\u6307\u5b9a EvalSet \u4e2d\u7684\u5355\u4e2a Metric\n    Add(ctx context.Context, appName, evalSetID string, metric *EvalMetric) error        // \u4e3a\u6307\u5b9a EvalSet \u6dfb\u52a0 Metric\n    Delete(ctx context.Context, appName, evalSetID, metricName string) error             // \u5220\u9664\u6307\u5b9a Metric\n    Update(ctx context.Context, appName, evalSetID string, metric *EvalMetric) error     // \u66f4\u65b0\u6307\u5b9a Metric\n}\n</code></pre> <p>\u6846\u67b6\u4e3a Metric Manager \u63d0\u4f9b\u4e86\u4e24\u79cd\u5b9e\u73b0:</p> <ul> <li>local: \u5c06\u8bc4\u4f30\u6307\u6807\u5b58\u50a8\u5728\u672c\u5730\u6587\u4ef6\u7cfb\u7edf\u4e2d\uff0c\u6587\u4ef6\u547d\u540d\u683c\u5f0f\u4e3a <code>&lt;EvalSetID&gt;.metric.json</code>\u3002</li> <li>inmemory: \u5c06\u8bc4\u4f30\u6307\u6807\u5b58\u50a8\u5728\u5185\u5b58\u4e2d\uff0c\u6240\u6709\u64cd\u4f5c\u5747\u4fdd\u8bc1\u6df1\u62f7\u8d1d\uff0c\u9002\u7528\u4e8e\u4e34\u65f6\u6d4b\u8bd5\u6216\u5feb\u901f\u9a8c\u8bc1\u573a\u666f\u3002</li> </ul>"},{"location":"zh/evaluation/#-evaluator","title":"\u8bc4\u4f30\u5668 -- Evaluator","text":"<p>Evaluator \u6839\u636e\u5b9e\u9645\u4f1a\u8bdd\u3001\u9884\u671f\u4f1a\u8bdd \u4e0e\u8bc4\u4f30\u6307\u6807\u8ba1\u7b97\u6700\u7ec8\u8bc4\u4f30\u7ed3\u679c\u3002</p> <p>\u8bc4\u4f30\u5668\u8f93\u51fa\u7684\u7ed3\u679c\u5305\u62ec\uff1a</p> <ul> <li>\u603b\u4f53\u8bc4\u4f30\u5f97\u5206</li> <li>\u603b\u4f53\u8bc4\u4f30\u72b6\u6001</li> <li>\u9010\u4f1a\u8bdd\u8bc4\u4f30\u7ed3\u679c\u5217\u8868</li> </ul> <p>\u5176\u4e2d\uff0c\u5355\u6761\u4f1a\u8bdd\u8bc4\u4f30\u7ed3\u679c\u5305\u542b\uff1a</p> <ul> <li>\u5b9e\u9645\u4f1a\u8bdd</li> <li>\u9884\u671f\u4f1a\u8bdd</li> <li>\u8bc4\u4f30\u5f97\u5206</li> <li>\u8bc4\u4f30\u72b6\u6001</li> </ul> <p>\u8bc4\u4f30\u72b6\u6001\u901a\u5e38\u7531\u5f97\u5206\u4e0e\u6307\u6807\u9608\u503c\u5171\u540c\u51b3\u5b9a\uff1a</p> <ul> <li>\u82e5\u8bc4\u4f30\u5f97\u5206 \u2265 \u8bc4\u4f30\u6307\u6807\u9608\u503c\uff0c\u5219\u72b6\u6001\u4e3a\u901a\u8fc7</li> <li>\u82e5\u8bc4\u4f30\u5f97\u5206 &lt; \u8bc4\u4f30\u6307\u6807\u9608\u503c\uff0c\u5219\u72b6\u6001\u4e3a\u672a\u901a\u8fc7</li> </ul> <p>\u6ce8\u610f\uff1a\u8bc4\u4f30\u5668\u540d\u79f0 <code>Evaluator.Name()</code> \u9700\u8981\u4e0e\u8bc4\u4f30\u6307\u6807\u540d <code>metric.MetricName</code> \u4e00\u81f4\u3002</p> <p>\u8bc4\u4f30\u5668 Evaluator \u63a5\u53e3\u5b9a\u4e49\u5982\u4e0b\uff1a</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation/evalset\"\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation/metric\"\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation/status\"\n)\n\n// Evaluator \u5b9a\u4e49\u8bc4\u4f30\u5668\u7684\u901a\u7528\u63a5\u53e3\ntype Evaluator interface {\n    // Name \u8fd4\u56de\u8bc4\u4f30\u5668\u540d\u79f0\n    Name() string\n    // Description \u8fd4\u56de\u8bc4\u4f30\u5668\u63cf\u8ff0\u4fe1\u606f\n    Description() string\n    // Evaluate \u6267\u884c\u8bc4\u4f30\u903b\u8f91\uff0c\u6bd4\u8f83\u5b9e\u9645\u4e0e\u9884\u671f\u4f1a\u8bdd\u5e76\u8fd4\u56de\u7ed3\u679c\n    Evaluate(ctx context.Context, actuals, expecteds []*evalset.Invocation,\n        evalMetric *metric.EvalMetric) (*EvaluateResult, error)\n}\n\n// EvaluateResult \u8868\u793a\u8bc4\u4f30\u5668\u5728\u591a\u6b21\u4f1a\u8bdd\u4e0a\u7684\u6c47\u603b\u7ed3\u679c\ntype EvaluateResult struct {\n    OverallScore         float64               // \u603b\u4f53\u5f97\u5206\n    OverallStatus        status.EvalStatus     // \u603b\u4f53\u72b6\u6001\uff0c\u5206\u4e3a\u901a\u8fc7/\u672a\u901a\u8fc7/\u672a\u8bc4\u4f30\n    PerInvocationResults []PerInvocationResult // \u5355\u6b21\u4f1a\u8bdd\u8bc4\u4f30\u7ed3\u679c\n}\n\n// PerInvocationResult \u8868\u793a\u5355\u6b21\u4f1a\u8bdd\u7684\u8bc4\u4f30\u7ed3\u679c\ntype PerInvocationResult struct {\n    ActualInvocation   *evalset.Invocation // \u5b9e\u9645\u4f1a\u8bdd\n    ExpectedInvocation *evalset.Invocation // \u9884\u671f\u4f1a\u8bdd\n    Score              float64             // \u5f53\u524d\u4f1a\u8bdd\u5f97\u5206\n    Status             status.EvalStatus   // \u5f53\u524d\u4f1a\u8bdd\u72b6\u6001\n}\n</code></pre>"},{"location":"zh/evaluation/#-registry","title":"\u8bc4\u4f30\u5668\u6ce8\u518c\u4e2d\u5fc3 -- Registry","text":"<p>Registry \u7528\u4e8e\u7edf\u4e00\u7ba1\u7406\u548c\u8bbf\u95ee\u5404\u7c7b\u8bc4\u4f30\u5668\u3002</p> <p>\u65b9\u6cd5\u5305\u62ec\uff1a</p> <ul> <li><code>Register(name string, e Evaluator)</code>\uff1a\u6ce8\u518c\u6307\u5b9a\u540d\u79f0\u7684\u8bc4\u4f30\u5668\u3002</li> <li><code>Get(name string)</code>\uff1a\u6839\u636e\u540d\u79f0\u83b7\u53d6\u8bc4\u4f30\u5668\u5b9e\u4f8b\u3002</li> </ul> <pre><code>import \"trpc.group/trpc-go/trpc-agent-go/evaluation/evaluator\"\n\n// Registry \u5b9a\u4e49\u8bc4\u4f30\u5668\u6ce8\u518c\u4e2d\u5fc3\u63a5\u53e3\ntype Registry interface {\n    // Register \u5c06\u8bc4\u4f30\u5668\u6ce8\u518c\u5230\u5168\u5c40\u6ce8\u518c\u4e2d\u5fc3\n    Register(name string, e evaluator.Evaluator) error\n    // Get \u6839\u636e\u8bc4\u4f30\u5668\u540d\u79f0\u83b7\u53d6\u5b9e\u4f8b\n    Get(name string) (evaluator.Evaluator, error)\n}\n</code></pre> <p>\u6846\u67b6\u9ed8\u8ba4\u6ce8\u518c\u4e86\u4ee5\u4e0b\u8bc4\u4f30\u5668\uff1a</p> <ul> <li><code>tool_trajectory_avg_score</code> \u5de5\u5177\u8f68\u8ff9\u4e00\u81f4\u6027\u8bc4\u4f30\u5668\u3002<ul> <li>\u5bf9\u4e8e\u5355\u6b21\u4f1a\u8bdd\uff1a<ul> <li>\u82e5\u5b9e\u9645\u5de5\u5177\u8c03\u7528\u5e8f\u5217\u4e0e\u9884\u671f\u5b8c\u5168\u4e00\u81f4\uff0c\u5219\u8ba1 1 \u5206\uff1b</li> <li>\u82e5\u4e0d\u4e00\u81f4\uff0c\u5219\u8ba1 0 \u5206\u3002</li> </ul> </li> <li>\u5bf9\u4e8e\u591a\u6b21\u4f1a\u8bdd\uff1a\u8ba1\u7b97\u5404\u4f1a\u8bdd\u5f97\u5206\u7684\u5e73\u5747\u503c\u4f5c\u4e3a\u6700\u7ec8\u5f97\u5206\u3002</li> </ul> </li> </ul>"},{"location":"zh/evaluation/#-evalresult","title":"\u8bc4\u4f30\u7ed3\u679c -- EvalResult","text":"<p>EvalResult \u6a21\u5757\u7528\u4e8e\u8bb0\u5f55\u5e76\u7ba1\u7406\u8bc4\u4f30\u6267\u884c\u540e\u7684\u7ed3\u679c\u6570\u636e\u3002</p> <p>EvalSetResult \u8bb0\u5f55\u8bc4\u4f30\u96c6 EvalSetID \u7684\u8bc4\u4f30\u7ed3\u679c\uff0c\u5305\u542b\u591a\u4e2a EvalCaseResult\uff0c\u7528\u4e8e\u5c55\u793a\u6bcf\u4e2a\u8bc4\u4f30\u7528\u4f8b\u7684\u6267\u884c\u60c5\u51b5\u4e0e\u5f97\u5206\u660e\u7ec6\u3002</p> <pre><code>import \"trpc.group/trpc-go/trpc-agent-go/evaluation/internal/epochtime\"\n\n// EvalSetResult \u8868\u793a\u8bc4\u4f30\u96c6\u7684\u6574\u4f53\u8bc4\u4f30\u7ed3\u679c\ntype EvalSetResult struct {\n    EvalSetResultID   string               // \u8bc4\u4f30\u7ed3\u679c\u552f\u4e00\u6807\u8bc6\n    EvalSetResultName string               // \u8bc4\u4f30\u7ed3\u679c\u540d\u79f0\n    EvalSetID         string               // \u5bf9\u5e94\u7684\u8bc4\u4f30\u96c6 ID\n    EvalCaseResults   []*EvalCaseResult    // \u5404\u8bc4\u4f30\u7528\u4f8b\u7684\u7ed3\u679c\n    CreationTimestamp *epochtime.EpochTime // \u7ed3\u679c\u521b\u5efa\u65f6\u95f4\n}\n</code></pre> <p>EvalCaseResult \u8868\u793a\u5355\u4e2a\u8bc4\u4f30\u7528\u4f8b\u7684\u8bc4\u4f30\u7ed3\u679c\uff0c\u5305\u542b\u603b\u4f53\u8bc4\u4f30\u72b6\u6001\u3001\u5404\u9879\u6307\u6807\u5f97\u5206\u4ee5\u53ca\u6bcf\u8f6e\u5bf9\u8bdd\u7684\u8bc4\u4f30\u8be6\u60c5\u3002</p> <pre><code>import \"trpc.group/trpc-go/trpc-agent-go/evaluation/status\"\n\n// EvalCaseResult \u8868\u793a\u5355\u4e2a\u8bc4\u4f30\u7528\u4f8b\u7684\u8bc4\u4f30\u7ed3\u679c\ntype EvalCaseResult struct {\n    EvalSetID                     string                           // \u6240\u5c5e\u8bc4\u4f30\u96c6 ID\n    EvalID                        string                           // \u7528\u4f8b\u552f\u4e00\u6807\u8bc6\n    FinalEvalStatus               status.EvalStatus                // \u7528\u4f8b\u6700\u7ec8\u8bc4\u4f30\u72b6\u6001\n    OverallEvalMetricResults      []*EvalMetricResult              // \u5404\u6307\u6807\u603b\u4f53\u5f97\u5206\u7ed3\u679c\n    EvalMetricResultPerInvocation []*EvalMetricResultPerInvocation // \u6309\u5bf9\u8bdd\u7c92\u5ea6\u7684\u6307\u6807\u8bc4\u4f30\u7ed3\u679c\n    SessionID                     string                           // \u63a8\u7406\u9636\u6bb5\u751f\u6210\u7684 Session ID\n    UserID                        string                           // \u63a8\u7406\u9636\u6bb5\u4f7f\u7528\u7684 User ID\n}\n</code></pre> <p>EvalMetricResult \u8868\u793a\u67d0\u4e00\u6307\u6807\u7684\u8bc4\u4f30\u7ed3\u679c\uff0c\u5305\u62ec\u5f97\u5206\u3001\u72b6\u6001\u3001\u9608\u503c\u53ca\u9644\u52a0\u4fe1\u606f\u3002</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation/metric/criterion\"\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation/status\"\n)\n\n// EvalMetricResult \u8868\u793a\u5355\u9879\u6307\u6807\u7684\u8bc4\u4f30\u7ed3\u679c\ntype EvalMetricResult struct {\n    MetricName string               // \u6307\u6807\u540d\u79f0\n    Score      float64              // \u5b9e\u9645\u5f97\u5206\n    EvalStatus status.EvalStatus    // \u8bc4\u6d4b\u72b6\u6001\n    Threshold  float64              // \u9608\u503c\n    Criterion  *criterion.Criterion // \u8bc4\u4f30\u51c6\u5219\n    Details    map[string]any       // \u989d\u5916\u4fe1\u606f\uff0c\u5982\u8bc4\u5206\u8fc7\u7a0b\u3001\u9519\u8bef\u63cf\u8ff0\u7b49\n}\n</code></pre> <p>EvalMetricResultPerInvocation \u8868\u793a\u5355\u8f6e\u5bf9\u8bdd\u7684\u9010\u6307\u6807\u8bc4\u4f30\u7ed3\u679c\uff0c\u7528\u4e8e\u5206\u6790\u5177\u4f53\u5bf9\u8bdd\u5728\u4e0d\u540c\u6307\u6807\u4e0b\u7684\u8868\u73b0\u5dee\u5f02\u3002</p> <pre><code>import \"trpc.group/trpc-go/trpc-agent-go/evaluation/evalset\"\n\n// EvalMetricResultPerInvocation \u8868\u793a\u5355\u8f6e\u5bf9\u8bdd\u7684\u9010\u6307\u6807\u8bc4\u4f30\u7ed3\u679c\ntype EvalMetricResultPerInvocation struct {\n    ActualInvocation   *evalset.Invocation // \u5b9e\u9645\u6267\u884c\u7684\u5bf9\u8bdd\n    ExpectedInvocation *evalset.Invocation // \u9884\u671f\u7684\u5bf9\u8bdd\u7ed3\u679c\n    EvalMetricResults  []*EvalMetricResult // \u5404\u6307\u6807\u8bc4\u4f30\u7ed3\u679c\n}\n</code></pre> <p>EvalResult Manager \u8d1f\u8d23\u7ba1\u7406\u8bc4\u4f30\u7ed3\u679c\u7684\u5b58\u50a8\u3001\u67e5\u8be2\u4e0e\u5217\u8868\u64cd\u4f5c\uff0c\u63a5\u53e3\u5b9a\u4e49\u5982\u4e0b\uff1a</p> <pre><code>// Manager \u5b9a\u4e49\u8bc4\u4f30\u7ed3\u679c\u7684\u7ba1\u7406\u63a5\u53e3\ntype Manager interface {\n    // Save \u4fdd\u5b58\u8bc4\u4f30\u7ed3\u679c\uff0c\u8fd4\u56de EvalSetResultID\n    Save(ctx context.Context, appName string, evalSetResult *EvalSetResult) (string, error)\n    // Get \u6839\u636e evalSetResultID \u83b7\u53d6\u6307\u5b9a\u8bc4\u4f30\u7ed3\u679c\n    Get(ctx context.Context, appName, evalSetResultID string) (*EvalSetResult, error)\n    // List \u8fd4\u56de\u6307\u5b9a\u5e94\u7528\u4e0b\u7684\u6240\u6709\u8bc4\u4f30\u7ed3\u679c ID\n    List(ctx context.Context, appName string) ([]string, error)\n}\n</code></pre> <p>\u6846\u67b6\u4e3a EvalResult Manager \u63d0\u4f9b\u4e24\u79cd\u5b9e\u73b0\u65b9\u5f0f\uff1a</p> <ul> <li>local\uff1a\u5c06\u8bc4\u4f30\u7ed3\u679c\u5b58\u50a8\u5728\u672c\u5730\u6587\u4ef6\u7cfb\u7edf\u4e2d\uff0c\u6587\u4ef6\u9ed8\u8ba4\u547d\u540d\u683c\u5f0f\u4e3a <code>&lt;EvalSetResultID&gt;.evalset_result.json</code>\u3002\u5176\u4e2d\uff0c<code>EvalSetResultID</code> \u9ed8\u8ba4\u547d\u540d\u89c4\u5219\u4e3a <code>&lt;appName&gt;_&lt;EvalSetID&gt;_&lt;UUID&gt;</code>\u3002</li> <li>inmemory\uff1a\u5c06\u8bc4\u4f30\u7ed3\u679c\u5b58\u50a8\u5728\u5185\u5b58\u4e2d\uff0c\u6240\u6709\u64cd\u4f5c\u5747\u4fdd\u8bc1\u6df1\u62f7\u8d1d\uff0c\u9002\u5408\u8c03\u8bd5\u4e0e\u5feb\u901f\u9a8c\u8bc1\u573a\u666f\u3002</li> </ul>"},{"location":"zh/evaluation/#-service","title":"\u8bc4\u4f30\u670d\u52a1 -- Service","text":"<p>Service \u662f\u8bc4\u4f30\u670d\u52a1\uff0c\u7528\u4e8e\u6574\u5408\u4ee5\u4e0b\u6a21\u5757\uff1a</p> <ul> <li>\u8bc4\u4f30\u96c6 EvalSet</li> <li>\u8bc4\u4f30\u6307\u6807 Metric</li> <li>\u8bc4\u4f30\u5668\u6ce8\u518c\u4e2d\u5fc3 Registry</li> <li>\u8bc4\u4f30\u5668 Evaluator</li> <li>\u8bc4\u4f30\u7ed3\u679c EvalSetResult</li> </ul> <p>Service \u63a5\u53e3\u5b9a\u4e49\u4e86\u5b8c\u6574\u7684\u8bc4\u6d4b\u6d41\u7a0b\uff0c\u5305\u62ec\u63a8\u7406\uff08Inference\uff09\u548c\u8bc4\u4f30\uff08Evaluate\uff09\u4e24\u4e2a\u9636\u6bb5\uff0c\u63a5\u53e3\u5b9a\u4e49\u5982\u4e0b\uff1a</p> <pre><code>import \"trpc.group/trpc-go/trpc-agent-go/evaluation/evalset\"\n\n// Service \u5b9a\u4e49\u4e86\u8bc4\u4f30\u670d\u52a1\u7684\u6838\u5fc3\u63a5\u53e3\u3002\ntype Service interface {\n    // Inference \u6267\u884c\u63a8\u7406\uff0c\u8c03\u7528 Agent \u5904\u7406\u6307\u5b9a\u7684\u8bc4\u6d4b\u7528\u4f8b\uff0c\u5e76\u8fd4\u56de\u63a8\u7406\u7ed3\u679c\u3002\n    Inference(ctx context.Context, request *InferenceRequest) ([]*InferenceResult, error)\n    // Evaluate \u5bf9\u63a8\u7406\u7ed3\u679c\u8fdb\u884c\u8bc4\u4f30\uff0c\u751f\u6210\u5e76\u6301\u4e45\u5316\u8bc4\u6d4b\u7ed3\u679c\u3002\n    Evaluate(ctx context.Context, request *EvaluateRequest) (*evalresult.EvalSetResult, error)\n}\n</code></pre> <p>\u6846\u67b6\u4e3a Service \u63a5\u53e3\u63d0\u4f9b\u4e86\u9ed8\u8ba4\u672c\u5730\u8bc4\u4f30\u670d\u52a1 <code>local</code> \u5b9e\u73b0: \u8c03\u7528\u672c\u5730 Agent\uff0c\u5728\u672c\u5730\u6267\u884c\u63a8\u7406\u4e0e\u8bc4\u4f30\u3002</p>"},{"location":"zh/evaluation/#-inference","title":"\u63a8\u7406\u9636\u6bb5 -- Inference","text":"<p>\u63a8\u7406\u9636\u6bb5\u8d1f\u8d23\u8fd0\u884c Agent\uff0c\u5e76\u6355\u83b7\u5bf9\u8bc4\u6d4b\u7528\u4f8b\u7684\u5b9e\u9645\u54cd\u5e94\u3002 \u8f93\u5165\u4e3a <code>InferenceRequest</code>\uff0c\u8f93\u51fa\u4e3a <code>InferenceResult</code> \u5217\u8868\u3002</p> <pre><code>// InferenceRequest \u8868\u793a\u4e00\u6b21\u63a8\u7406\u8bf7\u6c42\ntype InferenceRequest struct {\n    AppName     string   // \u5e94\u7528\u540d\u79f0\n    EvalSetID   string   // \u8bc4\u4f30\u96c6 ID\n    EvalCaseIDs []string // \u9700\u8981\u63a8\u7406\u7684\u8bc4\u4f30\u7528\u4f8b ID \u5217\u8868\n}\n</code></pre> <p>\u8bf4\u660e\uff1a</p> <ul> <li><code>AppName</code> \u6307\u5b9a\u5e94\u7528\u540d\u79f0\u3002</li> <li><code>EvalSetID</code> \u6307\u5b9a\u8bc4\u4f30\u96c6\u3002</li> <li><code>EvalCaseIDs</code> \u6307\u5b9a\u8981\u8bc4\u4f30\u7684\u7528\u4f8b\u5217\u8868\u3002\u82e5\u4e3a\u7a7a\uff0c\u5219\u9ed8\u8ba4\u8bc4\u4f30\u8be5\u8bc4\u4f30\u96c6\u4e0b\u7684\u5168\u90e8\u7528\u4f8b\u3002</li> </ul> <p>\u5728\u63a8\u7406\u9636\u6bb5\uff0c\u7cfb\u7edf\u4f1a\u4f9d\u6b21\u8bfb\u53d6\u6bcf\u4e2a\u8bc4\u4f30\u7528\u4f8b\u4e2d\u7684\u4f1a\u8bdd <code>Invocation</code>\uff0c\u5c06\u5176\u4e2d\u7684 <code>UserContent</code> \u4f5c\u4e3a\u7528\u6237\u8f93\u5165\u8c03\u7528 Agent\uff0c\u5e76\u8bb0\u5f55 Agent \u7684\u54cd\u5e94\u3002</p> <pre><code>import \"trpc.group/trpc-go/trpc-agent-go/evaluation/status\"\n\n// InferenceResult \u8868\u793a\u5355\u4e2a\u8bc4\u6d4b\u7528\u4f8b\u7684\u63a8\u7406\u7ed3\u679c\ntype InferenceResult struct {\n    AppName      string                // \u5e94\u7528\u540d\u79f0\n    EvalSetID    string                // \u6240\u5c5e\u8bc4\u4f30\u96c6 ID\n    EvalCaseID   string                // \u8bc4\u4f30\u7528\u4f8b ID\n    Inferences   []*evalset.Invocation // \u5b9e\u9645\u63a8\u7406\u5f97\u5230\u7684\u4f1a\u8bdd\n    SessionID    string                // \u63a8\u7406\u9636\u6bb5\u7684 Session ID\n    Status       status.EvalStatus     // \u63a8\u7406\u72b6\u6001\n    ErrorMessage string                // \u63a8\u7406\u5931\u8d25\u65f6\u7684\u9519\u8bef\u4fe1\u606f\n}\n</code></pre> <p>\u8bf4\u660e\uff1a</p> <ul> <li>\u6bcf\u4e2a <code>InferenceResult</code> \u5bf9\u5e94\u4e00\u4e2a <code>EvalCase</code>\u3002</li> <li>\u7531\u4e8e\u8bc4\u4f30\u96c6\u53ef\u80fd\u5305\u542b\u591a\u4e2a\u8bc4\u4f30\u7528\u4f8b\uff0c\u6240\u4ee5 <code>Inference</code> \u5c06\u8fd4\u56de <code>InferenceResult</code> \u5217\u8868\u3002</li> </ul>"},{"location":"zh/evaluation/#-evaluate","title":"\u8bc4\u4f30\u9636\u6bb5 -- Evaluate","text":"<p>\u8bc4\u4f30\u9636\u6bb5\u7528\u4e8e\u8bc4\u4f30\u63a8\u7406\u7ed3\u679c\uff0c\u8f93\u5165\u4e3a <code>EvaluateRequest</code>\uff0c\u8f93\u51fa\u4e3a\u8bc4\u4f30\u7ed3\u679c <code>EvalSetResult</code>\u3002</p> <pre><code>import \"trpc.group/trpc-go/trpc-agent-go/evaluation/metric\"\n\n// EvaluateRequest \u8868\u793a\u4e00\u6b21\u8bc4\u4f30\u8bf7\u6c42\ntype EvaluateRequest struct {\n    AppName          string             // \u5e94\u7528\u540d\u79f0\n    EvalSetID        string             // \u8bc4\u4f30\u96c6 ID\n    InferenceResults []*InferenceResult // \u63a8\u7406\u9636\u6bb5\u7684\u7ed3\u679c\n    EvaluateConfig   *EvaluateConfig    // \u8bc4\u4f30\u914d\u7f6e\n}\n\n// EvaluateConfig \u8868\u793a\u8bc4\u4f30\u9636\u6bb5\u7684\u914d\u7f6e\ntype EvaluateConfig struct {\n    EvalMetrics []*metric.EvalMetric // \u53c2\u4e0e\u8bc4\u4f30\u7684\u6307\u6807\u96c6\u5408\n}\n</code></pre> <p>\u8bf4\u660e\uff1a</p> <ul> <li>\u6846\u67b6\u5c06\u6839\u636e\u914d\u7f6e\u7684 <code>EvalMetrics</code> \u8c03\u7528\u5bf9\u5e94\u7684\u8bc4\u4f30\u5668 Evaluator \u8fdb\u884c\u8bc4\u4f30\u6253\u5206\u3002</li> <li>\u6bcf\u4e2a\u6307\u6807\u7ed3\u679c\u90fd\u4f1a\u88ab\u6c47\u603b\u81f3\u6700\u7ec8\u7684 <code>EvalSetResult</code> \u4e2d\u3002</li> </ul>"},{"location":"zh/evaluation/#agent-agentevaluator","title":"Agent \u8bc4\u4f30 -- AgentEvaluator","text":"<p><code>AgentEvaluator</code> \u7528\u4e8e\u6839\u636e\u914d\u7f6e\u7684\u8bc4\u4f30\u96c6 EvalSetID \u5bf9 Agent \u8fdb\u884c\u8bc4\u4f30\u3002</p> <pre><code>// AgentEvaluator \u6839\u636e\u8bc4\u4f30\u96c6\u8bc4\u4f30 Agent\ntype AgentEvaluator interface {\n    // Evaluate \u5bf9\u6307\u5b9a\u7684\u8bc4\u4f30\u96c6\u6267\u884c\u8bc4\u4f30\n    Evaluate(ctx context.Context, evalSetID string) (*EvaluationResult, error)\n}\n</code></pre> <p><code>EvaluationResult</code> \u8868\u793a\u4e00\u6b21\u5b8c\u6574\u8bc4\u4f30\u4efb\u52a1\u7684\u6700\u7ec8\u7ed3\u679c\uff0c\u5305\u542b\u6574\u4f53\u8bc4\u4f30\u72b6\u6001\u3001\u6267\u884c\u8017\u65f6\u4ee5\u53ca\u6240\u6709\u8bc4\u4f30\u7528\u4f8b\u7684\u7ed3\u679c\u6c47\u603b\u3002</p> <pre><code>import \"trpc.group/trpc-go/trpc-agent-go/evaluation/status\"\n\n// EvaluationResult \u5305\u542b\u591a\u6b21\u6267\u884c\u8bc4\u4f30\u7684\u6c47\u603b\u7ed3\u679c\ntype EvaluationResult struct {\n    AppName       string                  // \u5e94\u7528\u540d\u79f0\n    EvalSetID     string                  // \u5bf9\u5e94\u7684\u8bc4\u4f30\u96c6 ID\n    OverallStatus status.EvalStatus       // \u6574\u4f53\u8bc4\u4f30\u72b6\u6001\n    ExecutionTime time.Duration           // \u6267\u884c\u8017\u65f6\n    EvalCases     []*EvaluationCaseResult // \u5404\u8bc4\u4f30\u7528\u4f8b\u7684\u7ed3\u679c\n}\n</code></pre> <p><code>EvaluationCaseResult</code> \u805a\u5408\u5355\u4e2a\u8bc4\u4f30\u7528\u4f8b\u591a\u6b21\u8fd0\u884c\u7684\u7ed3\u679c\uff0c\u5305\u62ec\u6574\u4f53\u8bc4\u4f30\u72b6\u6001\u3001\u5404\u6b21\u8fd0\u884c\u7684\u8be6\u7ec6\u7ed3\u679c\u4ee5\u53ca\u6307\u6807\u7ea7\u522b\u7684\u7edf\u8ba1\u7ed3\u679c\u3002</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation/evalresult\"\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation/status\"\n)\n\n// EvaluationCaseResult \u6c47\u603b\u4e86\u591a\u6b21\u6267\u884c\u4e2d\u5355\u4e2a\u8bc4\u4f30\u7528\u4f8b\u7684\u7ed3\u679c\ntype EvaluationCaseResult struct {\n    EvalCaseID      string                         // \u8bc4\u4f30\u7528\u4f8b ID\n    OverallStatus   status.EvalStatus              // \u7efc\u5408\u8bc4\u4f30\u72b6\u6001\n    EvalCaseResults []*evalresult.EvalCaseResult   // \u5404\u6b21\u8fd0\u884c\u7684\u7ed3\u679c\n    MetricResults   []*evalresult.EvalMetricResult // \u6307\u6807\u7ea7\u7ed3\u679c\n}\n</code></pre> <p>\u53ef\u4ee5\u901a\u8fc7 <code>evaluation.New</code> \u521b\u5efa <code>AgentEvaluator</code> \u5b9e\u4f8b\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u5b83\u4f1a\u4f7f\u7528 <code>EvalSet Manager</code>\u3001<code>Metric Manager</code> \u4e0e <code>EvalResult Manager</code> \u7684 <code>local</code> \u5b9e\u73b0\u3002</p> <pre><code>agentEvaluator, err := evaluation.New(appName, runner, evaluation.WithNumRuns(numRuns))\n</code></pre> <p>\u7531\u4e8e Agent \u7684\u8fd0\u884c\u8fc7\u7a0b\u53ef\u80fd\u5b58\u4e0d\u786e\u5b9a\u6027\uff0c<code>evaluation.WithNumRuns</code> \u63d0\u4f9b\u4e86\u591a\u6b21\u8bc4\u4f30\u8fd0\u884c\u7684\u673a\u5236\uff0c\u7528\u4e8e\u964d\u4f4e\u5355\u6b21\u8fd0\u884c\u5e26\u6765\u7684\u5076\u7136\u6027\u3002</p> <ul> <li>\u9ed8\u8ba4\u8fd0\u884c\u6b21\u6570\u4e3a 1 \u6b21\uff1b</li> <li>\u901a\u8fc7\u6307\u5b9a <code>evaluation.WithNumRuns(n)</code>\uff0c\u53ef\u5bf9\u6bcf\u4e2a\u8bc4\u4f30\u7528\u4f8b\u8fd0\u884c\u591a\u6b21\uff1b</li> <li>\u6700\u7ec8\u7ed3\u679c\u5c06\u57fa\u4e8e\u591a\u6b21\u8fd0\u884c\u7684\u7efc\u5408\u7edf\u8ba1\u7ed3\u679c\u5f97\u51fa\uff0c\u9ed8\u8ba4\u7edf\u8ba1\u65b9\u6cd5\u662f\u591a\u6b21\u8fd0\u884c\u8bc4\u4f30\u5f97\u5206\u7684\u5e73\u5747\u503c\u3002</li> </ul>"},{"location":"zh/evaluation/#_5","title":"\u4f7f\u7528\u6307\u5357","text":""},{"location":"zh/evaluation/#_6","title":"\u672c\u5730\u6587\u4ef6\u8def\u5f84","text":"<p>\u672c\u5730\u6587\u4ef6\u6709\u4e09\u79cd\uff1a</p> <ul> <li>\u8bc4\u4f30\u96c6\u6587\u4ef6</li> <li>\u8bc4\u4f30\u6307\u6807\u6587\u4ef6</li> <li>\u8bc4\u4f30\u7ed3\u679c\u6587\u4ef6</li> </ul>"},{"location":"zh/evaluation/#_7","title":"\u8bc4\u4f30\u96c6\u6587\u4ef6","text":"<p>\u8bc4\u4f30\u96c6\u6587\u4ef6\u7684\u9ed8\u8ba4\u8def\u5f84\u4e3a <code>./&lt;AppName&gt;/&lt;EvalSetID&gt;.evalset.json</code>\u3002</p> <p>\u53ef\u4ee5\u901a\u8fc7 <code>WithBaseDir</code> \u8bbe\u7f6e\u81ea\u5b9a\u4e49 <code>BaseDir</code>\uff0c\u5373\u6587\u4ef6\u8def\u5f84\u4e3a <code>&lt;BaseDir&gt;/&lt;AppName&gt;/&lt;EvalSetID&gt;.evalset.json</code>\u3002</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation\"\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation/evalset\"\n    evalsetlocal \"trpc.group/trpc-go/trpc-agent-go/evaluation/evalset/local\"\n)\n\nevalSetManager := evalsetlocal.New(evalset.WithBaseDir(\"&lt;BaseDir&gt;\"))\nagentEvaluator, err := evaluation.New(appName, runner, evaluation.WithEvalSetManager(evalSetManager))\n</code></pre> <p>\u6b64\u5916\uff0c\u82e5\u9ed8\u8ba4\u8def\u5f84\u7ed3\u6784\u4e0d\u6ee1\u8db3\u9700\u6c42\uff0c\u53ef\u901a\u8fc7\u5b9e\u73b0 <code>Locator</code> \u63a5\u53e3\u81ea\u5b9a\u4e49\u6587\u4ef6\u8def\u5f84\u89c4\u5219\uff0c\u63a5\u53e3\u5b9a\u4e49\u5982\u4e0b\uff1a</p> <pre><code>// Locator \u7528\u4e8e\u5b9a\u4e49\u8bc4\u4f30\u96c6\u6587\u4ef6\u7684\u8def\u5f84\u751f\u6210\u4e0e\u679a\u4e3e\u903b\u8f91\ntype Locator interface {\n    // Build \u6784\u5efa\u6307\u5b9a appName \u548c evalSetID \u7684\u8bc4\u4f30\u96c6\u6587\u4ef6\u8def\u5f84\n    Build(baseDir, appName, evalSetID string) string\n    // List \u5217\u51fa\u6307\u5b9a appName \u4e0b\u7684\u6240\u6709\u8bc4\u4f30\u96c6 ID\n    List(baseDir, appName string) ([]string, error)\n}\n</code></pre> <p>\u4f8b\u5982\u5c06\u8bc4\u4f30\u96c6\u6587\u4ef6\u683c\u5f0f\u8bbe\u7f6e\u4e3a <code>custom-&lt;EvalSetID&gt;.evalset.json</code>\u3002</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation\"\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation/evalset\"\n    evalsetlocal \"trpc.group/trpc-go/trpc-agent-go/evaluation/evalset/local\"\n)\n\nevalSetManager := evalsetlocal.New(evalset.WithLocator(&amp;customLocator{}))\nagentEvaluator, err := evaluation.New(appName, runner, evaluation.WithEvalSetManager(evalSetManager))\n\ntype customLocator struct {\n}\n\n// Build \u8fd4\u56de\u81ea\u5b9a\u4e49\u6587\u4ef6\u8def\u5f84\u683c\u5f0f\uff1a&lt;BaseDir&gt;/&lt;AppName&gt;/custom-&lt;EvalSetID&gt;.evalset.json\nfunc (l *customLocator) Build(baseDir, appName, EvalSetID string) string {\n    return filepath.Join(baseDir, appName, \"custom-\"+evalSetID+\".evalset.json\")\n}\n\n// List \u5217\u51fa\u6307\u5b9a app \u4e0b\u7684\u6240\u6709\u8bc4\u4f30\u96c6 ID\nfunc (l *customLocator) List(baseDir, appName string) ([]string, error) {\n    dir := filepath.Join(baseDir, appName)\n    entries, err := os.ReadDir(dir)\n    if err != nil {\n        if errors.Is(err, os.ErrNotExist) {\n            return []string{}, nil\n        }\n        return nil, err\n    }\n    var results []string\n    for _, entry := range entries {\n        if entry.IsDir() {\n            continue\n        }\n        if strings.HasSuffix(entry.Name(), \".evalset.json\") {\n            name := strings.TrimPrefix(entry.Name(), \"custom-\")\n            name = strings.TrimSuffix(name, defaultResultFileSuffix)\n            results = append(results, name)\n        }\n    }\n    return results, nil\n}\n</code></pre>"},{"location":"zh/evaluation/#_8","title":"\u8bc4\u4f30\u6307\u6807\u6587\u4ef6","text":"<p>\u8bc4\u4f30\u6307\u6807\u6587\u4ef6\u7684\u9ed8\u8ba4\u8def\u5f84\u4e3a <code>./&lt;AppName&gt;/&lt;EvalSetID&gt;.metrics.json</code>\u3002</p> <p>\u53ef\u4ee5\u901a\u8fc7 <code>WithBaseDir</code> \u8bbe\u7f6e\u81ea\u5b9a\u4e49 <code>BaseDir</code>\uff0c\u5373\u6587\u4ef6\u8def\u5f84\u4e3a <code>&lt;BaseDir&gt;/&lt;AppName&gt;/&lt;EvalSetID&gt;.metrics.json</code>\u3002</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation\"\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation/metric\"\n    metriclocal \"trpc.group/trpc-go/trpc-agent-go/evaluation/metric/local\"\n)\n\nmetricManager := metriclocal.New(metric.WithBaseDir(\"&lt;BaseDir&gt;\"))\nagentEvaluator, err := evaluation.New(appName, runner, evaluation.WithMetricManager(metricManager))\n</code></pre> <p>\u6b64\u5916\uff0c\u82e5\u9ed8\u8ba4\u8def\u5f84\u7ed3\u6784\u4e0d\u6ee1\u8db3\u9700\u6c42\uff0c\u53ef\u901a\u8fc7\u5b9e\u73b0 <code>Locator</code> \u63a5\u53e3\u81ea\u5b9a\u4e49\u6587\u4ef6\u8def\u5f84\u89c4\u5219\uff0c\u63a5\u53e3\u5b9a\u4e49\u5982\u4e0b\uff1a</p> <pre><code>// Locator \u7528\u4e8e\u5b9a\u4e49\u8bc4\u4f30\u6307\u6807\u6587\u4ef6\u7684\u8def\u5f84\u751f\u6210\ntype Locator interface {\n    // Build \u6784\u5efa\u6307\u5b9a appName \u548c evalSetID \u7684\u8bc4\u4f30\u6307\u6807\u6587\u4ef6\u8def\u5f84\n    Build(baseDir, appName, evalSetID string) string\n}\n</code></pre> <p>\u4f8b\u5982\u5c06\u8bc4\u4f30\u96c6\u6587\u4ef6\u683c\u5f0f\u8bbe\u7f6e\u4e3a <code>custom-&lt;EvalSetID&gt;.metrics.json</code>\u3002</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation\"\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation/metric\"\n    metriclocal \"trpc.group/trpc-go/trpc-agent-go/evaluation/metric/local\"\n)\n\nmetricManager := metriclocal.New(metric.WithLocator(&amp;customLocator{}))\nagentEvaluator, err := evaluation.New(appName, runner, evaluation.WithMetricManager(metricManager))\n\ntype customLocator struct {\n}\n\n// Build \u8fd4\u56de\u81ea\u5b9a\u4e49\u6587\u4ef6\u8def\u5f84\u683c\u5f0f\uff1a&lt;BaseDir&gt;/&lt;AppName&gt;/custom-&lt;EvalSetID&gt;.metrics.json\nfunc (l *customLocator) Build(baseDir, appName, EvalSetID string) string {\n    return filepath.Join(baseDir, appName, \"custom-\"+evalSetID+\".metrics.json\")\n}\n</code></pre>"},{"location":"zh/evaluation/#_9","title":"\u8bc4\u4f30\u7ed3\u679c\u6587\u4ef6","text":"<p>\u8bc4\u4f30\u7ed3\u679c\u6587\u4ef6\u7684\u9ed8\u8ba4\u8def\u5f84\u4e3a <code>./&lt;AppName&gt;/&lt;EvalSetResultID&gt;.evalresult.json</code>\u3002</p> <p>\u53ef\u4ee5\u901a\u8fc7 <code>WithBaseDir</code> \u8bbe\u7f6e\u81ea\u5b9a\u4e49 <code>BaseDir</code>\uff0c\u5373\u6587\u4ef6\u8def\u5f84\u4e3a <code>&lt;BaseDir&gt;/&lt;AppName&gt;/&lt;EvalSetResultID&gt;.evalresult.json</code>\u3002\u5176\u4e2d\uff0c<code>EvalSetResultID</code> \u9ed8\u8ba4\u547d\u540d\u89c4\u5219\u4e3a <code>&lt;appName&gt;_&lt;EvalSetID&gt;_&lt;UUID&gt;</code>\u3002</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation\"\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation/evalresult\"\n    evalresultlocal \"trpc.group/trpc-go/trpc-agent-go/evaluation/evalresult/local\"\n)\n\nevalResultManager := evalresultlocal.New(evalresult.WithBaseDir(\"&lt;BaseDir&gt;\"))\nagentEvaluator, err := evaluation.New(appName, runner, evaluation.WithEvalResultManager(evalResultManager))\n</code></pre> <p>\u6b64\u5916\uff0c\u82e5\u9ed8\u8ba4\u8def\u5f84\u7ed3\u6784\u4e0d\u6ee1\u8db3\u9700\u6c42\uff0c\u53ef\u901a\u8fc7\u5b9e\u73b0 <code>Locator</code> \u63a5\u53e3\u81ea\u5b9a\u4e49\u6587\u4ef6\u8def\u5f84\u89c4\u5219\uff0c\u63a5\u53e3\u5b9a\u4e49\u5982\u4e0b\uff1a</p> <pre><code>// Locator \u7528\u4e8e\u5b9a\u4e49\u8bc4\u4f30\u7ed3\u679c\u6587\u4ef6\u7684\u8def\u5f84\u751f\u6210\u4e0e\u679a\u4e3e\u903b\u8f91\ntype Locator interface {\n    // Build \u6784\u5efa\u6307\u5b9a appName \u548c evalSetResultID \u7684\u8bc4\u4f30\u7ed3\u679c\u6587\u4ef6\u8def\u5f84\n    Build(baseDir, appName, evalSetResultID string) string\n    // List \u5217\u51fa\u6307\u5b9a appName \u4e0b\u7684\u6240\u6709\u8bc4\u4f30\u7ed3\u679c ID\n    List(baseDir, appName string) ([]string, error)\n}\n</code></pre> <p>\u4f8b\u5982\u5c06\u8bc4\u4f30\u7ed3\u679c\u6587\u4ef6\u683c\u5f0f\u8bbe\u7f6e\u4e3a <code>custom-&lt;EvalSetResultID&gt;.evalresult.json</code>\u3002</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation\"\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation/evalresult\"\n    evalresultlocal \"trpc.group/trpc-go/trpc-agent-go/evaluation/evalresult/local\"\n)\n\nevalResultManager := evalresultlocal.New(evalresult.WithLocator(&amp;customLocator{}))\nagentEvaluator, err := evaluation.New(appName, runner, evaluation.WithEvalResultManager(evalResultManager))\n\ntype customLocator struct {\n}\n\n// Build \u8fd4\u56de\u81ea\u5b9a\u4e49\u6587\u4ef6\u8def\u5f84\u683c\u5f0f\uff1a&lt;BaseDir&gt;/&lt;AppName&gt;/custom-&lt;EvalSetResultID&gt;.evalresult.json\nfunc (l *customLocator) Build(baseDir, appName, evalSetResultID string) string {\n    return filepath.Join(baseDir, appName, \"custom-\"+evalSetResultID+\".evalresult.json\")\n}\n\n// List \u5217\u51fa\u6307\u5b9a app \u4e0b\u7684\u6240\u6709\u8bc4\u4f30\u7ed3\u679c ID\nfunc (l *customLocator) List(baseDir, appName string) ([]string, error) {\n    dir := filepath.Join(baseDir, appName)\n    entries, err := os.ReadDir(dir)\n    if err != nil {\n        if errors.Is(err, os.ErrNotExist) {\n            return []string{}, nil\n        }\n        return nil, err\n    }\n    var results []string\n    for _, entry := range entries {\n        if entry.IsDir() {\n            continue\n        }\n        if strings.HasSuffix(entry.Name(), \".evalresult.json\") {\n            name := strings.TrimPrefix(entry.Name(), \"custom-\")\n            name = strings.TrimSuffix(name, \".evalresult.json\")\n            results = append(results, name)\n        }\n    }\n    return results, nil\n}\n</code></pre>"},{"location":"zh/evaluation/#_10","title":"\u8bc4\u4f30\u51c6\u5219","text":"<p>\u8bc4\u4f30\u51c6\u5219\u63cf\u8ff0\u5177\u4f53\u7684\u8bc4\u4f30\u65b9\u5f0f\uff0c\u53ef\u6309\u9700\u7ec4\u5408\u4f7f\u7528\u3002</p> <p>\u6846\u67b6\u5185\u7f6e\u4e86\u4ee5\u4e0b\u8bc4\u4f30\u51c6\u5219\u7c7b\u578b\uff1a</p> \u51c6\u5219\u7c7b\u578b \u9002\u7528\u5bf9\u8c61 TextCriterion \u6587\u672c\u5b57\u7b26\u4e32 JSONCriterion JSON \u5bf9\u8c61\uff0c\u901a\u5e38\u7528\u4e8e\u6bd4\u8f83 map[string]any ToolTrajectoryCriterion \u5de5\u5177\u8c03\u7528\u8f68\u8ff9 Criterion \u591a\u79cd\u51c6\u5219\u7684\u805a\u5408"},{"location":"zh/evaluation/#textcriterion","title":"TextCriterion","text":"<p>TextCriterion \u7528\u4e8e\u5b57\u7b26\u4e32\u5339\u914d\uff0c\u53ef\u914d\u7f6e\u662f\u5426\u5ffd\u7565\u5927\u5c0f\u5199\u548c\u5177\u4f53\u7684\u5339\u914d\u7b56\u7565\u3002</p> <pre><code>// TextCriterion \u5b9a\u4e49\u5b57\u7b26\u4e32\u7684\u5339\u914d\u65b9\u5f0f\u3002\ntype TextCriterion struct {\n    Ignore          bool              // \u662f\u5426\u8df3\u8fc7\u5339\u914d\n    CaseInsensitive bool              // \u662f\u5426\u5927\u5c0f\u5199\u4e0d\u654f\u611f\n    MatchStrategy   TextMatchStrategy // \u5339\u914d\u7b56\u7565\n    Compare         func(actual, expected string) (bool, error) // \u81ea\u5b9a\u4e49\u6bd4\u8f83\n}\n</code></pre> <p>TextMatchStrategy \u53d6\u503c\u8bf4\u660e\uff1a</p> TextMatchStrategy \u53d6\u503c \u8bf4\u660e exact \u5b9e\u9645\u5b57\u7b26\u4e32\u4e0e\u9884\u671f\u5b57\u7b26\u4e32\u5b8c\u5168\u4e00\u81f4\uff08\u9ed8\u8ba4\uff09\u3002 contains \u5b9e\u9645\u5b57\u7b26\u4e32\u5305\u542b\u9884\u671f\u5b57\u7b26\u4e32\u3002 regex \u5b9e\u9645\u5b57\u7b26\u4e32\u6ee1\u8db3\u9884\u671f\u5b57\u7b26\u4e32\u4f5c\u4e3a\u6b63\u5219\u8868\u8fbe\u5f0f\u3002"},{"location":"zh/evaluation/#jsoncriterion","title":"JSONCriterion","text":"<p>JSONCriterion \u7528\u4e8e\u5bf9\u6bd4\u7ed3\u6784\u5316 JSON \u6570\u636e\uff0c\u53ef\u914d\u7f6e\u662f\u5426\u5ffd\u7565\u6bd4\u8f83\u4ee5\u53ca\u5177\u4f53\u7684\u5339\u914d\u7b56\u7565\u3002</p> <pre><code>// JSONCriterion \u5b9a\u4e49 JSON \u5bf9\u8c61\u7684\u5339\u914d\u65b9\u5f0f\u3002\ntype JSONCriterion struct {\n    Ignore          bool                                                // \u662f\u5426\u8df3\u8fc7\u5339\u914d\n    IgnoreTree      map[string]any                                      // \u5ffd\u7565\u7684\u5b57\u6bb5\u6811\uff0c\u503c\u4e3a true \u65f6\u8df3\u8fc7\u8be5\u5b57\u6bb5\u53ca\u5176\u5b50\u6811\n    MatchStrategy   JSONMatchStrategy                                   // \u5339\u914d\u7b56\u7565\n    NumberTolerance *float64                                            // \u6570\u503c\u5bb9\u5dee\uff0c\u9ed8\u8ba4 1e-6\uff0c\u5bf9\u53f6\u5b50\u4e0a\u7684\u6570\u5b57\u505a\u8fd1\u4f3c\u6bd4\u8f83\n    Compare         func(actual, expected map[string]any) (bool, error) // \u81ea\u5b9a\u4e49\u6bd4\u8f83\n}\n</code></pre> <p>JSONMatchStrategy \u53d6\u503c\u8bf4\u660e\uff1a</p> JSONMatchStrategy \u53d6\u503c \u8bf4\u660e exact \u5b9e\u9645 JSON \u4e0e\u9884\u671f JSON \u5b8c\u5168\u4e00\u81f4\uff08\u9ed8\u8ba4\uff09\u3002 <p><code>IgnoreTree</code> \u652f\u6301\u5728\u6bd4\u8f83\u65f6\u8df3\u8fc7\u7279\u5b9a\u5b57\u6bb5\u4ee5\u53ca\u5176\u5b50\u6811\uff0c\u53ea\u6821\u9a8c\u672a\u88ab\u5ffd\u7565\u7684\u5b57\u6bb5\u3002</p> <p>\u4f8b\u5982\u5ffd\u7565 <code>metadata.updatedAt</code> \u4f46\u6821\u9a8c\u5176\u4ed6\u5b57\u6bb5\uff1a</p> <pre><code>criterion := &amp;json.JSONCriterion{\n    IgnoreTree: map[string]any{\n        \"metadata\": map[string]any{\n            \"updatedAt\": true,\n        },\n    },\n    NumberTolerance: 1e-6,\n}\n</code></pre> <p>\u914d\u7f6e\u6587\u4ef6\u793a\u4f8b\u5982\u4e0b\uff1a</p> <pre><code>[\n  {\n    \"metricName\": \"tool_trajectory_avg_score\",\n    \"threshold\": 1,\n    \"criterion\": {\n      \"toolTrajectory\": {\n        \"orderSensitive\": false,\n        \"defaultStrategy\": {\n          \"name\": {\n            \"matchStrategy\": \"exact\"\n          },\n          \"arguments\": {\n            \"matchStrategy\": \"exact\",\n            \"numberTolerance\": 1e-6,\n          },\n          \"result\": {\n            \"matchStrategy\": \"exact\",\n            \"numberTolerance\": 1e-6,\n            \"ignoreTree\": {\n              \"metadata\": {\n                \"updatedAt\": true\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n]\n</code></pre>"},{"location":"zh/evaluation/#tooltrajectorycriterion","title":"ToolTrajectoryCriterion","text":"<p>ToolTrajectoryCriterion \u7528\u4e8e\u914d\u7f6e\u5de5\u5177\u8c03\u7528\u4e0e\u7ed3\u679c\u7684\u8bc4\u4f30\u51c6\u5219\uff0c\u53ef\u8bbe\u7f6e\u9ed8\u8ba4\u7b56\u7565\u3001\u6309\u5de5\u5177\u540d\u5b9a\u5236\u7b56\u7565\u4ee5\u53ca\u662f\u5426\u8981\u6c42\u4fdd\u6301\u8c03\u7528\u987a\u5e8f\u3002</p> <pre><code>// ToolTrajectoryCriterion \u5b9a\u4e49\u5de5\u5177\u8c03\u7528\u4e0e\u7ed3\u679c\u7684\u8bc4\u4f30\u51c6\u5219\u3002\ntype ToolTrajectoryCriterion struct {\n    DefaultStrategy *ToolTrajectoryStrategy                                  // \u9ed8\u8ba4\u7b56\u7565\n    ToolStrategy    map[string]*ToolTrajectoryStrategy                       // \u6309\u5de5\u5177\u540d\u5b9a\u5236\u7b56\u7565\n    OrderSensitive  bool                                                     // \u662f\u5426\u8981\u6c42\u6309\u987a\u5e8f\u4e25\u683c\u5339\u914d\n    SubsetMatching  bool                                                     // \u662f\u5426\u5141\u8bb8\u9884\u671f\u8c03\u7528\u4e3a\u5b9e\u9645\u8c03\u7528\u7684\u5b50\u96c6\n    Compare         func(actual, expected *evalset.Invocation) (bool, error) // \u81ea\u5b9a\u4e49\u6bd4\u8f83\n}\n\n// ToolTrajectoryStrategy \u5b9a\u4e49\u5355\u4e2a\u5de5\u5177\u7684\u5339\u914d\u7b56\u7565\u3002\ntype ToolTrajectoryStrategy struct {\n    Name      *TextCriterion // \u5de5\u5177\u540d\u5339\u914d\n    Arguments *JSONCriterion // \u8c03\u7528\u53c2\u6570\u5339\u914d\n    Result    *JSONCriterion // \u5de5\u5177\u7ed3\u679c\u5339\u914d\n}\n</code></pre> <p>DefaultStrategy \u7528\u4e8e\u914d\u7f6e\u5168\u5c40\u9ed8\u8ba4\u8bc4\u4f30\u51c6\u5219\uff0c\u9002\u7528\u4e8e\u6240\u6709\u5de5\u5177\u3002</p> <p>ToolStrategy \u6309\u5de5\u5177\u540d\u8986\u76d6\u7279\u5b9a\u5de5\u5177\u7684\u8bc4\u4f30\u51c6\u5219\uff0c\u672a\u8bbe\u7f6e ToolStrategy \u65f6\u6240\u6709\u5de5\u5177\u8c03\u7528\u90fd\u4f7f\u7528 DefaultStrategy\u3002</p> <p>\u82e5\u672a\u8bbe\u7f6e\u4efb\u4f55\u8bc4\u4f30\u51c6\u5219\uff0c\u6846\u67b6\u4f1a\u4f7f\u7528\u9ed8\u8ba4\u8bc4\u4f30\u51c6\u5219\uff1a\u5de5\u5177\u540d\u6309 TextCriterion \u7684 exact \u7b56\u7565\u6bd4\u8f83\uff0c\u53c2\u6570\u548c\u7ed3\u679c\u6309 JSONCriterion \u7684 exact \u7b56\u7565\u6bd4\u8f83\uff0c\u4fdd\u8bc1\u5de5\u5177\u8f68\u8ff9\u8bc4\u4f30\u59cb\u7ec8\u6709\u5408\u7406\u7684\u515c\u5e95\u884c\u4e3a\u3002</p> <p>\u4e0b\u9762\u7684\u793a\u4f8b\u5c55\u793a\u4e86\u4e00\u4e2a\u5178\u578b\u573a\u666f\uff0c\u5927\u90e8\u5206\u5de5\u5177\u5e0c\u671b\u4e25\u683c\u5bf9\u9f50\u5de5\u5177\u8c03\u7528\u548c\u7ed3\u679c\uff0c\u4f46 current_time \u8fd9\u7c7b\u65f6\u95f4\u76f8\u5173\u5de5\u5177\u7684\u54cd\u5e94\u503c\u672c\u8eab\u4e0d\u7a33\u5b9a\uff0c\u56e0\u6b64\u53ea\u9700\u8981\u68c0\u67e5\u662f\u5426\u6309\u9884\u671f\u8c03\u7528\u4e86\u6b63\u786e\u7684\u5de5\u5177\u548c\u53c2\u6570\uff0c\u800c\u4e0d\u8981\u6c42\u65f6\u95f4\u503c\u672c\u8eab\u5b8c\u5168\u4e00\u81f4\u3002</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation/metric/criterion\"\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation/metric/criterion/json\"\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation/metric/criterion/text\"\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation/metric/criterion/tooltrajectory\"\n)\n\ncriterion := criterion.New(\n    criterion.WithToolTrajectory(\n        tooltrajectory.New(\n            tooltrajectory.WithDefault(\n                &amp;tooltrajectory.ToolTrajectoryStrategy{\n                    Name: &amp;text.TextCriterion{\n                        MatchStrategy: text.TextMatchStrategyExact,\n                    },\n                    Arguments: &amp;json.JSONCriterion{\n                        MatchStrategy: json.JSONMatchStrategyExact,\n                    },\n                    Result: &amp;json.JSONCriterion{\n                        MatchStrategy: json.JSONMatchStrategyExact,\n                    },\n                },\n            ),\n            tooltrajectory.WithTool(map[string]*tooltrajectory.ToolTrajectoryStrategy{\n                \"current_time\": {\n                    Name: &amp;text.TextCriterion{\n                        MatchStrategy: text.TextMatchStrategyExact,\n                    },\n                    Arguments: &amp;json.JSONCriterion{\n                        MatchStrategy: json.JSONMatchStrategyExact,\n                    },\n                    Result: &amp;json.JSONCriterion{\n                        Ignore: true, // \u5ffd\u7565\u8be5\u5de5\u5177\u7ed3\u679c\u7684\u5339\u914d\n                    },\n                },\n            }),\n        ),\n    ),\n)\n</code></pre> <p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u5de5\u5177\u8c03\u7528\u5339\u914d\u5bf9\u987a\u5e8f\u4e0d\u654f\u611f\uff0c\u6bcf\u4e2a\u9884\u671f\u5de5\u5177\u4f1a\u4e0e\u4efb\u610f\u4e00\u4e2a\u6ee1\u8db3\u7b56\u7565\u7684\u5b9e\u9645\u5de5\u5177\u5c1d\u8bd5\u914d\u5bf9\uff0c\u540c\u4e00\u4e2a\u5de5\u5177\u8c03\u7528\u4e0d\u4f1a\u88ab\u91cd\u590d\u590d\u7528\uff0c\u5f53\u6240\u6709\u9884\u671f\u5de5\u5177\u90fd\u80fd\u627e\u5230\u5339\u914d\u65f6\u89c6\u4e3a\u901a\u8fc7\u3002\u5177\u4f53\u6765\u8bf4\uff0c\u6b64\u65f6\u4f1a\u901a\u8fc7\u4e8c\u5206\u56fe\u6700\u5927\u5339\u914d\u8ba1\u7b97\u6700\u5927\u5339\u914d\u6570\uff0c\u5c06\u9884\u671f\u5de5\u5177\u8c03\u7528\u89c6\u4e3a\u5de6\u8282\u70b9\uff0c\u5b9e\u9645\u5de5\u5177\u8c03\u7528\u89c6\u4e3a\u53f3\u8282\u70b9\uff0c\u5bf9\u4e8e\u6bcf\u5bf9\u9884\u671f/\u5b9e\u9645\u5de5\u5177\u8c03\u7528\uff0c\u82e5\u4e24\u8005\u6ee1\u8db3\u5de5\u5177\u5339\u914d\u7b56\u7565\uff0c\u5219\u4ece\u9884\u671f\u5de5\u5177\u8282\u70b9\u5411\u5b9e\u9645\u5de5\u5177\u8282\u70b9\u5efa\u4e00\u6761\u8fb9\u3002\u5efa\u56fe\u5b8c\u6210\u4e4b\u540e\uff0c\u901a\u8fc7 Kuhn \u7b97\u6cd5\u6c42\u89e3\u4e8c\u5206\u56fe\u6700\u5927\u5339\u914d\uff0c\u7136\u540e\u626b\u63cf\u672a\u5339\u914d\u7684\u9884\u671f\u5de5\u5177\u8282\u70b9\u3002\u82e5\u8fbe\u6210\u5b8c\u7f8e\u5339\u914d\uff0c\u5373\u6240\u6709\u9884\u671f\u5de5\u5177\u8282\u70b9\u90fd\u6709\u5339\u914d\u7684\u5b9e\u9645\u5de5\u5177\u8282\u70b9\uff0c\u5219\u8ba4\u4e3a\u5de5\u5177\u5339\u914d\u901a\u8fc7\uff1b\u5426\u5219\uff0c\u6846\u67b6\u5c06\u8fd4\u56de\u672a\u6210\u529f\u5339\u914d\u7684\u9884\u671f\u8282\u70b9\u3002</p> <p>\u82e5\u5e0c\u671b\u4e25\u683c\u6309\u9884\u671f\u5de5\u5177\u7684\u51fa\u73b0\u987a\u5e8f\u9010\u6761\u6bd4\u5bf9\uff0c\u53ef\u5f00\u542f <code>WithOrderSensitive(true)</code>\uff0c\u6b64\u65f6\u8bc4\u4f30\u5668\u6309\u9884\u671f/\u5b9e\u9645\u5217\u8868\u987a\u5e8f\u626b\u63cf\uff0c\u82e5\u9884\u671f\u5de5\u5177\u8c03\u7528\u627e\u4e0d\u5230\u5bf9\u5e94\u7684\u5b9e\u9645\u5de5\u5177\u8c03\u7528\u5339\u914d\uff0c\u5219\u5224\u5b9a\u4e3a\u5931\u8d25\u3002</p> <p>\u5f00\u542f\u987a\u5e8f\u4e25\u683c\u5339\u914d\u7684\u4ee3\u7801\u793a\u4f8b\u5982\u4e0b\uff1a</p> <pre><code>criterion := criterion.New(\n    criterion.WithToolTrajectory(\n        ctooltrajectory.New(\n            ctooltrajectory.WithOrderSensitive(true), // \u5f00\u542f\u987a\u5e8f\u654f\u611f\u5339\u914d.\n        ),\n    ),\n)\n</code></pre> <p>\u5f00\u542f\u987a\u5e8f\u4e25\u683c\u5339\u914d\u7684\u914d\u7f6e\u6587\u4ef6\u793a\u4f8b\u5982\u4e0b\uff1a</p> <pre><code>[\n  {\n    \"metricName\": \"tool_trajectory_avg_score\",\n    \"threshold\": 1,\n    \"criterion\": {\n      \"toolTrajectory\": {\n        \"orderSensitive\": true,\n        \"defaultStrategy\": {\n          \"name\": {\n            \"matchStrategy\": \"exact\"\n          },\n          \"arguments\": {\n            \"matchStrategy\": \"exact\"\n          },\n          \"result\": {\n            \"matchStrategy\": \"exact\"\n          }\n        }\n      }\n    }\n  }\n]\n</code></pre> <p>SubsetMatching \u63a7\u5236\u9884\u671f\u5de5\u5177\u5e8f\u5217\u662f\u5426\u53ef\u4ee5\u53ea\u662f\u5b9e\u9645\u5de5\u5177\u5e8f\u5217\u7684\u5b50\u96c6\uff0c\u9ed8\u8ba4\u5173\u95ed\u3002</p> <ul> <li>\u5173\u95ed\u65f6\uff0c\u9884\u671f\u548c\u5b9e\u9645\u7684\u5de5\u5177\u8c03\u7528\u6570\u91cf\u5fc5\u987b\u4e00\u81f4\u3002</li> <li>\u5f00\u542f\u65f6\uff0c\u5b9e\u9645\u5de5\u5177\u8c03\u7528\u6570\u91cf\u53ef\u4ee5\u6bd4\u9884\u671f\u66f4\u591a\uff0c\u5141\u8bb8\u9884\u671f\u5de5\u5177\u5e8f\u5217\u4f5c\u4e3a\u5b9e\u9645\u5de5\u5177\u5e8f\u5217\u7684\u5b50\u96c6\u3002</li> </ul> <p>\u5f00\u542f\u5b50\u96c6\u5339\u914d\u7684\u4ee3\u7801\u793a\u4f8b\u5982\u4e0b\uff1a</p> <pre><code>criterion := criterion.New(\n    criterion.WithToolTrajectory(\n        ctooltrajectory.New(\n            ctooltrajectory.WithSubsetMatching(true),\n        ),\n    ),\n)\n</code></pre> <p>\u5f00\u542f\u5b50\u96c6\u5339\u914d\u7684\u914d\u7f6e\u6587\u4ef6\u5982\u4e0b\uff1a</p> <pre><code>[\n  {\n    \"metricName\": \"tool_trajectory_avg_score\",\n    \"threshold\": 1,\n    \"criterion\": {\n      \"toolTrajectory\": {\n        \"subsetMatching\": true,\n        \"defaultStrategy\": {\n          \"name\": {\n            \"matchStrategy\": \"exact\"\n          },\n          \"arguments\": {\n            \"matchStrategy\": \"exact\"\n          },\n          \"result\": {\n            \"matchStrategy\": \"exact\"\n          }\n        }\n      }\n    }\n  }\n]\n</code></pre> <p>\u5047\u8bbe <code>A</code>\u3001<code>B</code>\u3001<code>C</code> \u548c <code>D</code> \u5404\u81ea\u662f\u4e00\u7ec4\u5de5\u5177\u8c03\u7528\uff0c\u5339\u914d\u60c5\u51b5\u793a\u4f8b\u5982\u4e0b\u3002</p> SubsetMatching OrderSensitive \u9884\u671f\u5e8f\u5217 \u5b9e\u9645\u5e8f\u5217 \u7ed3\u679c \u8bf4\u660e \u5173 \u5173 <code>[A]</code> <code>[A, B]</code> \u4e0d\u5339\u914d \u6570\u91cf\u4e0d\u7b49 \u5f00 \u5173 <code>[A]</code> <code>[A, B]</code> \u5339\u914d \u9884\u671f\u662f\u5b50\u96c6 \u5f00 \u5173 <code>[C, A]</code> <code>[A, B, C]</code> \u5339\u914d \u9884\u671f\u662f\u5b50\u96c6\u4e14\u65e0\u5e8f\u5339\u914d \u5f00 \u5f00 <code>[A, C]</code> <code>[A, B, C]</code> \u5339\u914d \u9884\u671f\u662f\u5b50\u96c6\u4e14\u987a\u5e8f\u5339\u914d \u5f00 \u5f00 <code>[C, A]</code> <code>[A, B, C]</code> \u4e0d\u5339\u914d \u987a\u5e8f\u4e0d\u6ee1\u8db3 \u5f00 \u5173 <code>[C, D]</code> <code>[A, B, C]</code> \u4e0d\u5339\u914d \u5b9e\u9645\u5de5\u5177\u5e8f\u5217\u7f3a\u5c11 D \u4efb\u610f \u4efb\u610f <code>[A, A]</code> <code>[A]</code> \u4e0d\u5339\u914d \u5b9e\u9645\u8c03\u7528\u4e0d\u8db3\uff0c\u540c\u4e00\u8c03\u7528\u4e0d\u80fd\u91cd\u590d\u5339\u914d"},{"location":"zh/evaluation/#_11","title":"\u8bc4\u4f30\u5668","text":""},{"location":"zh/evaluation/#_12","title":"\u5de5\u5177\u8f68\u8ff9\u8bc4\u4f30\u5668","text":"<p>\u5de5\u5177\u8f68\u8ff9\u8bc4\u4f30\u5668\u5bf9\u5e94\u7684\u6307\u6807\u540d\u79f0\u4e3a <code>tool_trajectory_avg_score</code>\uff0c\u7528\u4e8e\u8bc4\u4f30 Agent \u5728\u591a\u6b21\u4f1a\u8bdd\u4e2d\u5bf9\u5de5\u5177\u7684\u4f7f\u7528\u662f\u5426\u7b26\u5408\u9884\u671f\u3002</p> <p>\u5728\u5355\u6b21\u4f1a\u8bdd\u4e2d\uff0c\u8bc4\u4f30\u5668\u4f1a\u4f7f\u7528 <code>ToolTrajectoryCriterion</code> \u5bf9\u5b9e\u9645\u5de5\u5177\u8c03\u7528\u8f68\u8ff9\u4e0e\u9884\u671f\u8f68\u8ff9\u8fdb\u884c\u6bd4\u8f83\uff1a</p> <ul> <li>\u82e5\u6574\u6761\u5de5\u5177\u8c03\u7528\u8f68\u8ff9\u6ee1\u8db3\u8bc4\u4f30\u51c6\u5219\uff0c\u5219\u8be5\u4f1a\u8bdd\u5728\u6b64\u6307\u6807\u4e0a\u7684\u5f97\u5206\u4e3a 1\u3002  </li> <li>\u82e5\u4efb\u610f\u4e00\u6b65\u8c03\u7528\u4e0d\u6ee1\u8db3\u8bc4\u4f30\u51c6\u5219\uff0c\u5219\u8be5\u4f1a\u8bdd\u5728\u6b64\u6307\u6807\u4e0a\u7684\u5f97\u5206\u4e3a 0\u3002</li> </ul> <p>\u5728\u591a\u6b21\u4f1a\u8bdd\u7684\u573a\u666f\u4e0b\uff0c\u8bc4\u4f30\u5668\u4f1a\u5bf9\u6240\u6709\u4f1a\u8bdd\u5728\u8be5\u6307\u6807\u4e0a\u7684\u5f97\u5206\u53d6\u5e73\u5747\u503c\uff0c\u4f5c\u4e3a\u6700\u7ec8\u7684 <code>tool_trajectory_avg_score</code>\uff0c\u5e76\u4e0e <code>EvalMetric.Threshold</code> \u6bd4\u8f83\uff0c\u5f97\u5230\u901a\u8fc7/\u672a\u901a\u8fc7\u7684\u5224\u5b9a\u7ed3\u679c\u3002</p> <p>\u5de5\u5177\u8f68\u8ff9\u8bc4\u4f30\u5668\u4e0e Metric\u3001Criterion \u7684\u5178\u578b\u7ec4\u5408\u65b9\u5f0f\u5982\u4e0b\uff1a</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation/metric\"\n    \"trpc.group/trpc-go/trpc-agent-go/evaluation/metric/criterion\"\n    ctooltrajectory \"trpc.group/trpc-go/trpc-agent-go/evaluation/metric/criterion/tooltrajectory\"\n)\n\nevalMetric := &amp;metric.EvalMetric{\n    MetricName: \"tool_trajectory_avg_score\",\n    Threshold:  1.0,\n    Criterion: criterion.New(\n        criterion.WithToolTrajectory(\n            // \u4f7f\u7528\u9ed8\u8ba4\u8bc4\u4f30\u51c6\u5219\uff0c\u5de5\u5177\u7684\u540d\u79f0\u3001\u53c2\u6570\u548c\u6267\u884c\u7ed3\u679c\u9700\u4e25\u683c\u4e00\u81f4\n            ctooltrajectory.New(),\n        ),\n    ),\n}\n</code></pre> <p>\u5b8c\u6574\u793a\u4f8b\u53c2\u89c1 examples/evaluation/tooltrajectory\u3002</p>"},{"location":"zh/event/","title":"Event \u4f7f\u7528\u6587\u6863","text":"<p>Event \u662f trpc-agent-go \u4e2d Agent \u4e0e\u7528\u6237\u4e4b\u95f4\u901a\u4fe1\u7684\u6838\u5fc3\u673a\u5236\u3002\u5b83\u5c31\u50cf\u4e00\u4e2a\u6d88\u606f\u4fe1\u5c01\uff0c\u627f\u8f7d\u7740 Agent \u7684\u54cd\u5e94\u5185\u5bb9\u3001\u5de5\u5177\u8c03\u7528\u7ed3\u679c\u3001\u9519\u8bef\u4fe1\u606f\u7b49\u3002\u901a\u8fc7 Event\uff0c\u4f60\u53ef\u4ee5\u5b9e\u65f6\u4e86\u89e3 Agent \u7684\u5de5\u4f5c\u72b6\u6001\uff0c\u5904\u7406\u6d41\u5f0f\u54cd\u5e94\uff0c\u5b9e\u73b0\u591a Agent \u534f\u4f5c\uff0c\u4ee5\u53ca\u8ffd\u8e2a\u5de5\u5177\u6267\u884c\u3002</p>"},{"location":"zh/event/#event_1","title":"Event \u6982\u8ff0","text":"<p>Event \u662f Agent \u4e0e\u7528\u6237\u4e4b\u95f4\u901a\u4fe1\u7684\u8f7d\u4f53\u3002</p> <p>\u7528\u6237\u901a\u8fc7 <code>runner.Run()</code> \u65b9\u6cd5\u83b7\u53d6\u4e8b\u4ef6\u6d41\uff0c\u7136\u540e\u76d1\u542c\u4e8b\u4ef6\u901a\u9053\u6765\u5904\u7406 Agent \u7684\u54cd\u5e94\u3002</p>"},{"location":"zh/event/#event_2","title":"Event \u7ed3\u6784","text":"<p><code>Event</code> \u8868\u793a Agent \u4e0e\u7528\u6237\u4e4b\u95f4\u7684\u4e00\u6b21\u4e8b\u4ef6\uff0c\u7ed3\u6784\u5b9a\u4e49\u5982\u4e0b\uff1a</p> <pre><code>type Event struct {\n    // Response \u662f Event \u7684\u57fa\u7840\u54cd\u5e94\u7ed3\u6784\uff0c\u627f\u8f7d LLM \u7684\u54cd\u5e94\n    *model.Response\n\n    // RequestID \u8bb0\u5f55\u5173\u8054\u672c\u6b21\u8bf7\u6c42\u7684ID\uff0c\u53ef\u7531runner.Run\u901a\u8fc7agent.WithRequestID(\"request-ID\")\u4f20\u9012.\n    RequestID string `json:\"requestID,omitempty\"`\n\n    // InvocationID \u5f53\u524d\u6267\u884c\u4e0a\u4e0b\u6587\u7684ID.\n    InvocationID string `json:\"invocationId\"`\n\n    // ParentInvocationID \u4e0a\u4e00\u7ea7\u6267\u884c\u4e0a\u4e0b\u6587ID.\n    ParentInvocationID string `json:\"parentInvocationId,omitempty\"`\n\n    // Author \u662f\u4e8b\u4ef6\u7684\u53d1\u8d77\u8005\n    Author string `json:\"author\"`\n\n    // ID \u662f\u4e8b\u4ef6\u7684\u552f\u4e00\u6807\u8bc6\u7b26\n    ID string `json:\"id\"`\n\n    // Timestamp \u662f\u4e8b\u4ef6\u7684\u65f6\u95f4\u6233\n    Timestamp time.Time `json:\"timestamp\"`\n\n    // Branch \u662f\u5206\u652f\u6807\u8bc6\u7b26\uff0c\u7528\u4e8e\u591a Agent \u534f\u4f5c\n    Branch string `json:\"branch,omitempty\"`\n\n    // RequiresCompletion \u8868\u793a\u6b64\u4e8b\u4ef6\u662f\u5426\u9700\u8981\u5b8c\u6210\u4fe1\u53f7\n    RequiresCompletion bool `json:\"requiresCompletion,omitempty\"`\n\n    // LongRunningToolIDs \u662f\u957f\u8fd0\u884c\u51fd\u6570\u8c03\u7528\u7684 ID \u96c6\u5408\n    // Agent \u5ba2\u6237\u7aef\u5c06\u4ece\u6b64\u5b57\u6bb5\u4e86\u89e3\u54ea\u4e9b\u51fd\u6570\u8c03\u7528\u662f\u957f\u65f6\u95f4\u8fd0\u884c\u7684\n    // \u4ec5\u5bf9\u51fd\u6570\u8c03\u7528\u4e8b\u4ef6\u6709\u6548\n    LongRunningToolIDs map[string]struct{} `json:\"longRunningToolIDs,omitempty\"`\n\n    // StateDelta \u662f\u9700\u8981\u5199\u5165\u4f1a\u8bdd\u72b6\u6001\u7684\u589e\u91cf\uff08\u4f8b\u5982 Processor \u4ea7\u51fa\u7684\u72b6\u6001\u53d8\u66f4\uff09\n    StateDelta map[string][]byte `json:\"stateDelta,omitempty\"`\n\n    // StructuredOutput \u643a\u5e26\u7c7b\u578b\u5316\u7684\u5185\u5b58\u5185\u7ed3\u6784\u5316\u8f93\u51fa\uff0c\u4e0d\u53c2\u4e0e\u5e8f\u5217\u5316\n    StructuredOutput any `json:\"-\"`\n\n    // Actions \u643a\u5e26\u5bf9 Flow \u7684\u884c\u4e3a\u63d0\u793a\uff08\u4f8b\u5982\uff1a\u8df3\u8fc7\u5de5\u5177\u540e\u7684\u603b\u7ed3\uff09\n    Actions *EventActions `json:\"actions,omitempty\"`\n}\n\n// EventActions \u4e3a\u4e8b\u4ef6\u9644\u5e26\u7684\u53ef\u9009\u884c\u4e3a\u63d0\u793a\ntype EventActions struct {\n    // SkipSummarization \u8868\u793a Flow \u5728 tool.response \u540e\u4e0d\u518d\u8fdb\u884c\u603b\u7ed3\u578b LLM \u8c03\u7528\n    SkipSummarization bool `json:\"skipSummarization,omitempty\"`\n}\n</code></pre> <p><code>model.Response</code> \u662f Event \u7684\u57fa\u7840\u54cd\u5e94\u7ed3\u6784\uff0c\u627f\u8f7d\u4e86 LLM \u7684\u54cd\u5e94\u3001\u5de5\u5177\u8c03\u7528\u4ee5\u53ca\u9519\u8bef\u7b49\u4fe1\u606f\uff0c\u5b9a\u4e49\u5982\u4e0b\uff1a</p> <pre><code>type Response struct {\n    // \u54cd\u5e94\u552f\u4e00\u6807\u8bc6\n    ID string `json:\"id\"`\n\n    // \u5bf9\u8c61\u7c7b\u578b\uff08\u5982 \"chat.completion\", \"error\" \u7b49\uff09\uff0c\u5e2e\u52a9\u5ba2\u6237\u7aef\u8bc6\u522b\u5904\u7406\u65b9\u5f0f\n    Object string `json:\"object\"`\n\n    // \u521b\u5efa\u65f6\u95f4\u6233\n    Created int64 `json:\"created\"`\n\n    // \u4f7f\u7528\u7684\u6a21\u578b\u540d\u79f0\n    Model string `json:\"model\"`\n\n    // \u54cd\u5e94\u53ef\u9009\u9879\uff0cLLM \u53ef\u80fd\u751f\u6210\u591a\u4e2a\u5019\u9009\u54cd\u5e94\u4f9b\u7528\u6237\u9009\u62e9\uff0c\u9ed8\u8ba4\u53ea\u6709 1 \u4e2a\n    Choices []Choice `json:\"choices\"`\n\n    // \u4f7f\u7528\u7edf\u8ba1\u4fe1\u606f\uff0c\u8bb0\u5f55 token \u4f7f\u7528\u60c5\u51b5\n    Usage *Usage `json:\"usage,omitempty\"`\n\n    // \u7cfb\u7edf\u6307\u7eb9\n    SystemFingerprint *string `json:\"system_fingerprint,omitempty\"`\n\n    // \u9519\u8bef\u4fe1\u606f\n    Error *ResponseError `json:\"error,omitempty\"`\n\n    // \u65f6\u95f4\u6233\n    Timestamp time.Time `json:\"timestamp\"`\n\n    // \u8868\u793a\u6574\u4e2a\u5bf9\u8bdd\u662f\u5426\u5b8c\u6210\n    Done bool `json:\"done\"`\n\n    // \u662f\u5426\u4e3a\u90e8\u5206\u54cd\u5e94\n    IsPartial bool `json:\"is_partial\"`\n}\n\ntype Choice struct {\n    // \u9009\u62e9\u7d22\u5f15\n    Index int `json:\"index\"`\n\n    // \u5b8c\u6574\u6d88\u606f\uff0c\u5305\u542b\u6574\u4e2a\u54cd\u5e94\n    Message Message `json:\"message,omitempty\"`\n\n    // \u589e\u91cf\u6d88\u606f\uff0c\u7528\u4e8e\u6d41\u5f0f\u54cd\u5e94\uff0c\u53ea\u5305\u542b\u5f53\u524d\u5757\u7684\u65b0\u5185\u5bb9\n    // \u4f8b\u5982\uff1a\u5b8c\u6574\u54cd\u5e94 \"Hello, how can I help you?\" \u5728\u6d41\u5f0f\u54cd\u5e94\u4e2d\uff1a\n    // \u7b2c\u4e00\u4e2a\u4e8b\u4ef6\uff1aDelta.Content = \"Hello\"\n    // \u7b2c\u4e8c\u4e2a\u4e8b\u4ef6\uff1aDelta.Content = \", how\"  \n    // \u7b2c\u4e09\u4e2a\u4e8b\u4ef6\uff1aDelta.Content = \" can I help you?\"\n    Delta Message `json:\"delta,omitempty\"`\n\n    // \u5b8c\u6210\u539f\u56e0\n    FinishReason *string `json:\"finish_reason,omitempty\"`\n}\n\ntype Message struct {\n    // \u6d88\u606f\u53d1\u8d77\u4eba\u7684\u89d2\u8272\uff0c\u4f8b\u5982 \"system\", \"user\", \"assistant\", \"tool\"\n    Role string `json:\"role\"`\n\n    // \u6d88\u606f\u5185\u5bb9\n    Content string `json:\"content\"`\n\n    // \u591a\u6a21\u5f0f\u6d88\u606f\u7684\u5185\u5bb9\u7247\u6bb5\n    ContentParts []ContentPart `json:\"content_parts,omitempty\"`\n\n    // \u5de5\u5177\u54cd\u5e94\u6240\u4f7f\u7528\u7684\u5de5\u5177\u7684 ID\n    ToolID string `json:\"tool_id,omitempty\"`\n\n    // \u5de5\u5177\u54cd\u5e94\u6240\u4f7f\u7528\u7684\u5de5\u5177\u7684\u540d\u79f0\n    ToolName string `json:\"tool_name,omitempty\"`\n\n    // \u53ef\u9009\u7684\u5de5\u5177\u8c03\u7528\n    ToolCalls []ToolCall `json:\"tool_calls,omitempty\"`\n}\n\ntype Usage struct {\n    // \u63d0\u793a\u8bcd\u4f7f\u7528\u7684 Token \u6570\u91cf.\n    PromptTokens int `json:\"prompt_tokens\"`\n\n    // \u8865\u5168\u4f7f\u7528\u7684 Token \u6570\u91cf.\n    CompletionTokens int `json:\"completion_tokens\"`\n\n    // \u54cd\u5e94\u4e2d\u4f7f\u7528\u7684\u603b Token \u6570\u91cf.\n    TotalTokens int `json:\"total_tokens\"`\n\n    // \u65f6\u95f4\u7edf\u8ba1\u4fe1\u606f\uff08\u53ef\u9009\uff09\n    TimingInfo *TimingInfo `json:\"timing_info,omitempty\"`\n}\n\ntype TimingInfo struct {\n    // FirstTokenDuration \u662f\u4ece\u8bf7\u6c42\u5f00\u59cb\u5230\u7b2c\u4e00\u4e2a\u6709\u610f\u4e49 token \u7684\u7d2f\u79ef\u65f6\u957f\n    // \"\u6709\u610f\u4e49\u7684 token\" \u5b9a\u4e49\u4e3a\uff1a\u5305\u542b reasoning \u5185\u5bb9\u3001\u5e38\u89c4\u5185\u5bb9\u6216\u5de5\u5177\u8c03\u7528\u7684\u7b2c\u4e00\u4e2a chunk\n    // \n    // \u8fd4\u56de\u65f6\u673a\uff1a\n    // - \u6d41\u5f0f\u8bf7\u6c42\uff1a\u5728\u6536\u5230\u7b2c\u4e00\u4e2a\u6709\u610f\u4e49\u7684 chunk \u65f6\u7acb\u5373\u8ba1\u7b97\u5e76\u8fd4\u56de\n    // - \u975e\u6d41\u5f0f\u8bf7\u6c42\uff1a\u5728\u6536\u5230\u5b8c\u6574\u54cd\u5e94\u65f6\u8ba1\u7b97\u5e76\u8fd4\u56de\n    FirstTokenDuration time.Duration `json:\"time_to_first_token,omitempty\"`\n\n    // ReasoningDuration \u662f reasoning \u9636\u6bb5\u7684\u7d2f\u79ef\u65f6\u957f\uff08\u4ec5\u6d41\u5f0f\u6a21\u5f0f\uff09\n    // \u4ece\u6bcf\u6b21 LLM \u8c03\u7528\u7684\u7b2c\u4e00\u4e2a reasoning chunk \u5230\u6700\u540e\u4e00\u4e2a reasoning chunk \u7684\u65f6\u95f4\n    //\n    // \u6d4b\u91cf\u7ec6\u8282\uff1a\n    // - \u6536\u5230\u7b2c\u4e00\u4e2a\u5305\u542b reasoning \u5185\u5bb9\u7684 chunk \u65f6\u5f00\u59cb\u8ba1\u65f6\n    // - \u6301\u7eed\u8ba1\u65f6\u6240\u6709\u540e\u7eed\u7684 reasoning chunks\n    // - \u6536\u5230\u7b2c\u4e00\u4e2a\u975e reasoning chunk\uff08\u5e38\u89c4\u5185\u5bb9\u6216\u5de5\u5177\u8c03\u7528\uff09\u65f6\u505c\u6b62\u8ba1\u65f6\n    //\n    // \u8fd4\u56de\u65f6\u673a\uff1a\n    // - \u6d41\u5f0f\u8bf7\u6c42\uff1a\u5728\u68c0\u6d4b\u5230 reasoning \u7ed3\u675f\u65f6\uff08\u5373\u6536\u5230\u7b2c\u4e00\u4e2a\u975e reasoning \u7684 content/tool call chunk\uff09\n    //   \u7acb\u5373\u8ba1\u7b97\u5e76\u8fd4\u56de\n    // - \u975e\u6d41\u5f0f\u8bf7\u6c42\uff1a\u65e0\u6cd5\u7cbe\u786e\u6d4b\u91cf\uff0c\u6b64\u5b57\u6bb5\u5c06\u4fdd\u6301\u4e3a 0\n    ReasoningDuration time.Duration `json:\"reasoning_duration,omitempty\"`\n}\n</code></pre>"},{"location":"zh/event/#event_3","title":"Event \u7c7b\u578b","text":"<p>Event \u5728\u4ee5\u4e0b\u573a\u666f\u4e2d\u4f1a\u88ab\u521b\u5efa\u548c\u53d1\u9001\uff1a</p> <ol> <li>\u7528\u6237\u6d88\u606f\u4e8b\u4ef6\uff1a\u7528\u6237\u53d1\u9001\u6d88\u606f\u65f6\u81ea\u52a8\u521b\u5efa</li> <li>Agent \u54cd\u5e94\u4e8b\u4ef6\uff1aAgent \u751f\u6210\u54cd\u5e94\u65f6\u521b\u5efa</li> <li>\u6d41\u5f0f\u54cd\u5e94\u4e8b\u4ef6\uff1a\u6d41\u5f0f\u6a21\u5f0f\u4e0b\u6bcf\u4e2a\u54cd\u5e94\u5757\u90fd\u4f1a\u521b\u5efa</li> <li>\u5de5\u5177\u8c03\u7528\u4e8b\u4ef6\uff1aAgent \u8c03\u7528\u5de5\u5177\u65f6\u521b\u5efa</li> <li>\u9519\u8bef\u4e8b\u4ef6\uff1a\u53d1\u751f\u9519\u8bef\u65f6\u521b\u5efa</li> <li>Agent \u8f6c\u79fb\u4e8b\u4ef6\uff1aAgent \u8f6c\u79fb\u7ed9\u5176\u4ed6 Agent \u65f6\u521b\u5efa</li> <li>\u5b8c\u6210\u4e8b\u4ef6\uff1aAgent \u6267\u884c\u5b8c\u6210\u65f6\u521b\u5efa</li> </ol> <p>\u6839\u636e <code>model.Response.Object</code> \u5b57\u6bb5\uff0cEvent \u53ef\u4ee5\u5206\u4e3a\u4ee5\u4e0b\u7c7b\u578b\uff1a</p> <pre><code>const (\n    // \u9519\u8bef\u4e8b\u4ef6\n    ObjectTypeError = \"error\"\n\n    // \u5de5\u5177\u54cd\u5e94\u4e8b\u4ef6\n    ObjectTypeToolResponse = \"tool.response\"\n\n    // \u9884\u5904\u7406\u4e8b\u4ef6\n    ObjectTypePreprocessingBasic = \"preprocessing.basic\"\n    ObjectTypePreprocessingContent = \"preprocessing.content\"\n    ObjectTypePreprocessingIdentity = \"preprocessing.identity\"\n    ObjectTypePreprocessingInstruction = \"preprocessing.instruction\"\n    ObjectTypePreprocessingPlanning = \"preprocessing.planning\"\n\n    // \u540e\u5904\u7406\u4e8b\u4ef6\n    ObjectTypePostprocessingPlanning = \"postprocessing.planning\"\n    ObjectTypePostprocessingCodeExecution = \"postprocessing.code_execution\"\n\n    // Agent \u8f6c\u79fb\u4e8b\u4ef6\n    ObjectTypeTransfer = \"agent.transfer\"\n\n    // Runner \u5b8c\u6210\u4e8b\u4ef6\n    ObjectTypeRunnerCompletion = \"runner.completion\"\n)\n</code></pre>"},{"location":"zh/event/#transfer-announcements","title":"\u8fc7\u6ee4\u59d4\u6258\u63d0\u793a\uff08Transfer Announcements\uff09","text":"<p>\u59d4\u6258\u63d0\u793a\uff08Agent \u59d4\u6258/\u8f6c\u79fb\u8bf4\u660e\uff09\u7edf\u4e00\u4ee5 <code>Response.Object == \"agent.transfer\"</code> \u7684\u4e8b\u4ef6\u8f93\u51fa\u3002</p> <p>\u5e38\u89c1\u5f62\u5f0f\u4e3a\uff1a - \u4ea4\u63a5\u63d0\u793a\uff1a<code>Transferring control to agent: &lt;name&gt;</code></p> <p>\u5982\u9700\u5728 UI \u5c42\u9690\u85cf\u8fd9\u4e9b\u7cfb\u7edf\u7ea7\u63d0\u793a\uff0c\u53ef\u4ee5\u91c7\u7528\u4e24\u79cd\u517c\u5bb9\u65b9\u5f0f\uff1a  - \u6309\u5bf9\u8c61\u7c7b\u578b\u8fc7\u6ee4\uff1a\u9690\u85cf <code>Response.Object == \"agent.transfer\"</code> \u7684\u4e8b\u4ef6\u3002  - \u6309\u6807\u7b7e\uff08Tag\uff09\u8fc7\u6ee4\uff1a\u9690\u85cf <code>Event.Tag</code> \u4e2d\u5305\u542b <code>transfer</code> \u7684\u4e8b\u4ef6\u3002\u6846\u67b6\u4f1a\u4e3a\u4e0e\u59d4\u6258\u76f8\u5173\u7684\u4e8b\u4ef6\uff08\u5305\u62ec transfer \u5de5\u5177\u7ed3\u679c\uff09\u7edf\u4e00\u6253\u4e0a <code>transfer</code> \u6807\u7b7e\uff0c\u6309\u6807\u7b7e\u8fc7\u6ee4\u4e0d\u4f1a\u7834\u574f ToolCall/ToolResult \u7684\u914d\u5bf9\u5173\u7cfb\u3002</p> <p>\u6807\u7b7e\u4ee5\u5206\u53f7\uff08<code>;</code>\uff09\u5206\u9694\u3002\u81ea\u5b9a\u4e49\u4e8b\u4ef6\u53ef\u4f7f\u7528 <code>event.WithTag(tag)</code> \u8ffd\u52a0\u6807\u7b7e\uff0c\u591a\u6807\u7b7e\u683c\u5f0f\u4e3a <code>tag1;tag2;...</code>\u3002</p>"},{"location":"zh/event/#_1","title":"\u4ee3\u7801\u6267\u884c\u4e8b\u4ef6\u6807\u7b7e","text":"<p>\u5bf9\u4e8e\u4ee3\u7801\u6267\u884c\uff08Code Execution\uff09\u76f8\u5173\u7684\u4e8b\u4ef6\uff0c\u53ef\u901a\u8fc7 <code>Event.Tag</code> \u533a\u5206\u4ee3\u7801\u548c\u6267\u884c\u7ed3\u679c\uff1a</p> <ul> <li>\u4ee3\u7801\u6267\u884c\u4e8b\u4ef6\uff1a<code>Response.Object == \"postprocessing.code_execution\"</code> \u4e14 <code>Event.ContainsTag(event.TagCodeExecution)</code></li> <li>\u6267\u884c\u7ed3\u679c\u4e8b\u4ef6\uff1a<code>Response.Object == \"postprocessing.code_execution\"</code> \u4e14 <code>Event.ContainsTag(event.TagCodeExecutionResult)</code></li> </ul> <p>\u76f8\u5173\u5e38\u91cf\u5b9a\u4e49\u5728 <code>trpc.group/trpc-go/trpc-agent-go/event</code> \u5305\u4e2d\u3002</p>"},{"location":"zh/event/#runner","title":"\u8f85\u52a9\u65b9\u6cd5\uff1a\u68c0\u6d4b Runner \u5b8c\u6210","text":"<p>\u4f7f\u7528\u4fbf\u6377\u65b9\u6cd5\u6765\u5224\u65ad\u6574\u6b21\u8fd0\u884c\u662f\u5426\u5df2\u5b8c\u6210\uff0c\u65e0\u8bba Agent \u7c7b\u578b\u5982\u4f55\uff1a</p> <pre><code>// e.IsRunnerCompletion() \u4f1a\u5728\u7ec8\u6b62\u7684 runner-completion \u4e8b\u4ef6\u4e0a\u8fd4\u56de true\u3002\nif e.IsRunnerCompletion() {\n    // \u53ef\u5b89\u5168\u505c\u6b62\u8bfb\u53d6\u4e8b\u4ef6\u901a\u9053\u7684\u65f6\u673a\n}\n</code></pre>"},{"location":"zh/event/#event_4","title":"Event \u521b\u5efa","text":"<p>\u5728\u5f00\u53d1\u81ea\u5b9a\u4e49 Agent \u7c7b\u578b\u6216 Processor \u65f6\uff0c\u9700\u8981\u521b\u5efa Event\u3002</p> <p>Event \u63d0\u4f9b\u4e86\u4e09\u79cd\u521b\u5efa\u65b9\u6cd5\uff0c\u9002\u7528\u4e8e\u4e0d\u540c\u573a\u666f\u3002</p> <pre><code>// \u521b\u5efa\u65b0\u4e8b\u4ef6\nfunc New(invocationID, author string, opts ...Option) *Event\n\n// \u521b\u5efa\u9519\u8bef\u4e8b\u4ef6\nfunc NewErrorEvent(invocationID, author, errorType, errorMessage string) *Event\n\n// \u4ece\u54cd\u5e94\u521b\u5efa\u4e8b\u4ef6\nfunc NewResponseEvent(invocationID, author string, response *model.Response) *Event\n</code></pre> <p>\u53c2\u6570\u8bf4\u660e\uff1a</p> <ul> <li><code>invocationID string</code>\uff1a\u8c03\u7528\u552f\u4e00\u6807\u8bc6</li> <li><code>author string</code>\uff1a\u4e8b\u4ef6\u53d1\u8d77\u8005</li> <li><code>opts ...Option</code>\uff1a\u53ef\u9009\u7684\u914d\u7f6e\u9009\u9879\uff08\u4ec5 New \u65b9\u6cd5\uff09</li> <li><code>errorType string</code>\uff1a\u9519\u8bef\u7c7b\u578b\uff08\u4ec5 NewErrorEvent \u65b9\u6cd5\uff09</li> <li><code>errorMessage string</code>\uff1a\u9519\u8bef\u6d88\u606f\uff08\u4ec5 NewErrorEvent \u65b9\u6cd5\uff09</li> <li><code>response *model.Response</code>\uff1a\u54cd\u5e94\u5bf9\u8c61\uff08\u4ec5 NewResponseEvent \u65b9\u6cd5\uff09</li> </ul> <p>\u6846\u67b6\u652f\u6301\u4ee5\u4e0b Option \u7528\u4ee5\u914d\u7f6e Event\uff1a</p> <ul> <li><code>WithBranch(branch string)</code>\uff1a\u8bbe\u7f6e\u4e8b\u4ef6\u7684\u5206\u652f\u6807\u8bc6</li> <li><code>WithResponse(response *model.Response)</code>\uff1a\u8bbe\u7f6e\u4e8b\u4ef6\u7684\u54cd\u5e94\u5185\u5bb9</li> <li><code>WithObject(o string)</code>\uff1a\u8bbe\u7f6e\u4e8b\u4ef6\u7684\u7c7b\u578b</li> </ul> <p>\u793a\u4f8b\uff1a <pre><code>// \u521b\u5efa\u57fa\u672c\u4e8b\u4ef6\nevt := event.New(\"invoke-123\", \"agent\")\n\n// \u521b\u5efa\u5e26\u5206\u652f\u7684\u4e8b\u4ef6\nevt := event.New(\"invoke-123\", \"agent\", event.WithBranch(\"main\"))\n\n// \u521b\u5efa\u9519\u8bef\u4e8b\u4ef6\nevt := event.NewErrorEvent(\"invoke-123\", \"agent\", \"api_error\", \"\u8bf7\u6c42\u8d85\u65f6\")\n\n// \u4ece\u54cd\u5e94\u521b\u5efa\u4e8b\u4ef6\nresponse := &amp;model.Response{\n    Object: \"chat.completion\",\n    Done:   true,\n    Choices: []model.Choice{{Message: model.Message{Role: \"assistant\", Content: \"Hello!\"}}},\n}\nevt := event.NewResponseEvent(\"invoke-123\", \"agent\", response)\n</code></pre></p>"},{"location":"zh/event/#agenttool","title":"\u5de5\u5177\u54cd\u5e94\u6d41\u5f0f\u8f93\u51fa\uff08\u542b AgentTool \u8f6c\u53d1\uff09","text":"<p>\u5f53\u8c03\u7528\u652f\u6301\u6d41\u5f0f\u7684\u5de5\u5177\uff08\u5305\u62ec AgentTool\uff09\u65f6\uff0c\u6846\u67b6\u4f1a\u53d1\u9001 <code>tool.response</code> \u4e8b\u4ef6\uff1a</p> <ul> <li>\u6d41\u5f0f\u5206\u7247\uff1a\u5185\u5bb9\u5728 <code>choice.Delta.Content</code>\uff0c\u5e76\u4e14 <code>Done=false</code>\u3001<code>IsPartial=true</code></li> <li>\u6700\u7ec8\u6d88\u606f\uff1a<code>choice.Message.Role=tool</code>\uff0c\u5185\u5bb9\u5728 <code>choice.Message.Content</code></li> </ul> <p>\u5f53 AgentTool \u5f00\u542f <code>WithStreamInner(true)</code> \u65f6\uff0c\u8fd8\u4f1a\u628a\u5b50 Agent \u7684\u4e8b\u4ef6\u76f4\u63a5\u8f6c\u53d1\u5230\u7236\u6d41\u7a0b\uff1a</p> <ul> <li>\u5b50 Agent \u8f6c\u53d1\u4e8b\u4ef6\u4f9d\u7136\u662f <code>event.Event</code>\uff0c\u5176\u4e2d\u589e\u91cf\u5185\u5bb9\u540c\u6837\u5728 <code>choice.Delta.Content</code></li> <li>\u4e3a\u907f\u514d\u91cd\u590d\u6253\u5370\uff0c\u5b50 Agent \u6700\u7ec8\u6574\u6bb5\u6587\u672c\u4e0d\u4f1a\u518d\u6b21\u4f5c\u4e3a\u8f6c\u53d1\u4e8b\u4ef6\u51fa\u73b0\uff0c\u4f46\u4f1a\u88ab\u805a\u5408\u5230\u6700\u7ec8\u7684 <code>tool.response</code> \u5185\u5bb9\u4e2d\uff0c\u4f9b\u4e0b\u4e00\u8f6e LLM \u4f7f\u7528</li> </ul> <p>Runner \u4f1a\u81ea\u52a8\u9488\u5bf9\u9700\u8981\u5b8c\u6210\u4fe1\u53f7\u7684\u4e8b\u4ef6\uff08<code>RequiresCompletion=true</code>\uff09\u53d1\u9001\u5b8c\u6210\u4fe1\u53f7\uff0c\u4f7f\u7528\u8005\u65e0\u9700\u989d\u5916\u5904\u7406\u3002</p> <p>\u4e8b\u4ef6\u5faa\u73af\u4e2d\u7684\u5904\u7406\u793a\u4f8b\uff1a</p> <pre><code>if evt.Response != nil &amp;&amp; evt.Object == model.ObjectTypeToolResponse &amp;&amp; len(evt.Response.Choices) &gt; 0 {\n    for _, ch := range evt.Response.Choices {\n        if ch.Delta.Content != \"\" { // \u90e8\u5206\u7247\u6bb5\n            fmt.Print(ch.Delta.Content)\n            continue\n        }\n        if ch.Message.Role == model.RoleTool &amp;&amp; ch.Message.Content != \"\" { // \u6700\u7ec8\u5185\u5bb9\n            fmt.Println(strings.TrimSpace(ch.Message.Content))\n        }\n    }\n    continue // \u4e0d\u8981\u628a\u5de5\u5177\u54cd\u5e94\u5f53\u6210\u52a9\u624b\u5185\u5bb9\u6253\u5370\n}\n</code></pre> <p>\u63d0\u793a\uff1a\u81ea\u5b9a\u4e49\u4e8b\u4ef6\u65f6\uff0c\u4f18\u5148\u4f7f\u7528 <code>event.New(...)</code> \u642d\u914d <code>WithResponse</code>\u3001<code>WithBranch</code> \u7b49\uff0c\u4ee5\u4fdd\u8bc1 ID \u548c\u65f6\u95f4\u6233\u7b49\u5143\u6570\u636e\u4e00\u81f4\u3002</p>"},{"location":"zh/event/#tags","title":"\u6807\u7b7e\uff08Tags\uff09","text":"<p>Event \u652f\u6301\u901a\u8fc7 <code>Event.Tag</code> \u6dfb\u52a0\u7b80\u5355\u6807\u7b7e\uff0c\u4fbf\u4e8e\u8fc7\u6ee4\u4e0e\u7edf\u8ba1\uff1a</p> <ul> <li>\u5206\u9694\u7b26\uff1a<code>;</code>\uff08\u5206\u53f7\uff09\u3002\u591a\u6807\u7b7e\u62fc\u63a5\u4e3a <code>tag1;tag2</code>\u3002</li> <li>\u8f85\u52a9\u51fd\u6570\uff1a<code>event.WithTag(\"&lt;tag&gt;\")</code> \u5728\u4e0d\u8986\u76d6\u5df2\u6709\u6807\u7b7e\u7684\u60c5\u51b5\u4e0b\u8ffd\u52a0\u65b0\u6807\u7b7e\u3002</li> <li>\u5185\u7f6e\u7528\u6cd5\uff1a\u4e0e\u59d4\u6258\u76f8\u5173\u7684\u4e8b\u4ef6\u4f1a\u7edf\u4e00\u6253\u4e0a <code>transfer</code> \u6807\u7b7e\u3002UI \u53ef\u636e\u6b64\u9690\u85cf\u5185\u90e8\u59d4\u6258\u7c7b\u6d88\u606f\uff0c\u540c\u65f6\u4fdd\u7559\u5b8c\u6574\u4e8b\u4ef6\u6d41\uff0c\u4fbf\u4e8e\u8c03\u8bd5\u4e0e\u5904\u7406\u3002</li> </ul>"},{"location":"zh/event/#event_5","title":"Event \u65b9\u6cd5","text":"<p>Event \u63d0\u4f9b\u4e86 <code>Clone</code> \u65b9\u6cd5\uff0c\u7528\u4e8e\u521b\u5efa Event \u7684\u6df1\u62f7\u8d1d\u3002</p> <pre><code>func (e *Event) Clone() *Event\n</code></pre>"},{"location":"zh/event/#event_6","title":"Event \u4f7f\u7528\u793a\u4f8b","text":"<p>\u8fd9\u4e2a\u793a\u4f8b\u5c55\u793a\u4e86\u5982\u4f55\u5728\u5b9e\u9645\u5e94\u7528\u4e2d\u4f7f\u7528 Event \u5904\u7406 Agent \u7684\u6d41\u5f0f\u54cd\u5e94\u3001\u5de5\u5177\u8c03\u7528\u548c\u9519\u8bef\u5904\u7406\u3002</p>"},{"location":"zh/event/#_2","title":"\u6838\u5fc3\u6d41\u7a0b","text":"<ol> <li>\u53d1\u9001\u7528\u6237\u6d88\u606f\uff1a\u901a\u8fc7 <code>runner.Run()</code> \u542f\u52a8 Agent \u5904\u7406</li> <li>\u63a5\u6536\u4e8b\u4ef6\u6d41\uff1a\u5b9e\u65f6\u5904\u7406 Agent \u8fd4\u56de\u7684\u4e8b\u4ef6</li> <li>\u5904\u7406\u4e0d\u540c\u7c7b\u578b\u4e8b\u4ef6\uff1a\u533a\u5206\u6d41\u5f0f\u5185\u5bb9\u3001\u5de5\u5177\u8c03\u7528\u3001\u9519\u8bef\u7b49</li> <li>\u53ef\u89c6\u5316\u8f93\u51fa\uff1a\u4e3a\u7528\u6237\u63d0\u4f9b\u53cb\u597d\u7684\u4ea4\u4e92\u4f53\u9a8c</li> </ol>"},{"location":"zh/event/#_3","title":"\u4ee3\u7801\u793a\u4f8b","text":"<pre><code>// processMessage \u5904\u7406\u5355\u6b21\u6d88\u606f\u4ea4\u4e92\nfunc (c *multiTurnChat) processMessage(ctx context.Context, userMessage string) error {\n    message := model.NewUserMessage(userMessage)\n\n    // \u901a\u8fc7 runner \u8fd0\u884c agent\n    eventChan, err := c.runner.Run(ctx, c.userID, c.sessionID, message)\n    if err != nil {\n        return fmt.Errorf(\"failed to run agent: %w\", err)\n    }\n\n    // \u5904\u7406\u54cd\u5e94\n    return c.processResponse(eventChan)\n}\n\n// processResponse \u5904\u7406\u54cd\u5e94\uff0c\u5305\u62ec\u6d41\u5f0f\u54cd\u5e94\u548c\u5de5\u5177\u8c03\u7528\u53ef\u89c6\u5316\nfunc (c *multiTurnChat) processResponse(eventChan &lt;-chan *event.Event) error {\n    fmt.Print(\"\ud83e\udd16 Assistant: \")\n\n    var (\n        fullContent       string        // \u7d2f\u79ef\u7684\u5b8c\u6574\u5185\u5bb9\n        toolCallsDetected bool          // \u662f\u5426\u68c0\u6d4b\u5230\u5de5\u5177\u8c03\u7528\n        assistantStarted  bool          // Assistant \u662f\u5426\u5df2\u5f00\u59cb\u56de\u590d\n    )\n\n    for event := range eventChan {\n        // \u5904\u7406\u5355\u4e2a\u4e8b\u4ef6\n        if err := c.handleEvent(event, &amp;toolCallsDetected, &amp;assistantStarted, &amp;fullContent); err != nil {\n            return err\n        }\n\n        // \u68c0\u67e5\u662f\u5426\u4e3a\u6700\u7ec8\u4e8b\u4ef6\n        if event.IsFinalResponse() {\n            fmt.Printf(\"\\n\")\n            break\n        }\n    }\n\n    return nil\n}\n\n// handleEvent \u5904\u7406\u5355\u4e2a\u4e8b\u4ef6\nfunc (c *multiTurnChat) handleEvent(\n    event *event.Event,\n    toolCallsDetected *bool,\n    assistantStarted *bool,\n    fullContent *string,\n) error {\n    // 1. \u5904\u7406\u9519\u8bef\u4e8b\u4ef6\n    if event.Error != nil {\n        fmt.Printf(\"\\n\u274c Error: %s\\n\", event.Error.Message)\n        return nil\n    }\n\n    // 2. \u5904\u7406\u5de5\u5177\u8c03\u7528\n    if c.handleToolCalls(event, toolCallsDetected, assistantStarted) {\n        return nil\n    }\n\n    // 3. \u5904\u7406\u5de5\u5177\u54cd\u5e94\n    if c.handleToolResponses(event) {\n        return nil\n    }\n\n    // 4. \u5904\u7406\u5185\u5bb9\n    c.handleContent(event, toolCallsDetected, assistantStarted, fullContent)\n\n    return nil\n}\n\n// handleToolCalls \u68c0\u6d4b\u5e76\u663e\u793a\u5de5\u5177\u8c03\u7528\nfunc (c *multiTurnChat) handleToolCalls(\n    event *event.Event,\n    toolCallsDetected *bool,\n    assistantStarted *bool,\n) bool {\n    if len(event.Response.Choices) &gt; 0 &amp;&amp; len(event.Response.Choices[0].Message.ToolCalls) &gt; 0 {\n        *toolCallsDetected = true\n        if *assistantStarted {\n            fmt.Printf(\"\\n\")\n        }\n        fmt.Printf(\"\ud83d\udd27 Tool calls initiated:\\n\")\n        for _, toolCall := range event.Response.Choices[0].Message.ToolCalls {\n            fmt.Printf(\"   \u2022 %s (ID: %s)\\n\", toolCall.Function.Name, toolCall.ID)\n            if len(toolCall.Function.Arguments) &gt; 0 {\n                fmt.Printf(\"     Args: %s\\n\", string(toolCall.Function.Arguments))\n            }\n        }\n        fmt.Printf(\"\\n\ud83d\udd04 Executing tools...\\n\")\n        return true\n    }\n    return false\n}\n\n// handleToolResponses \u68c0\u6d4b\u5e76\u663e\u793a\u5de5\u5177\u54cd\u5e94\nfunc (c *multiTurnChat) handleToolResponses(event *event.Event) bool {\n    if event.Response != nil &amp;&amp; len(event.Response.Choices) &gt; 0 {\n        for _, choice := range event.Response.Choices {\n            if choice.Message.Role == model.RoleTool &amp;&amp; choice.Message.ToolID != \"\" {\n                fmt.Printf(\"\u2705 Tool response (ID: %s): %s\\n\",\n                    choice.Message.ToolID,\n                    strings.TrimSpace(choice.Message.Content))\n                return true\n            }\n        }\n    }\n    return false\n}\n\n// handleContent \u5904\u7406\u5e76\u663e\u793a\u5185\u5bb9\nfunc (c *multiTurnChat) handleContent(\n    event *event.Event,\n    toolCallsDetected *bool,\n    assistantStarted *bool,\n    fullContent *string,\n) {\n    if len(event.Response.Choices) &gt; 0 {\n        choice := event.Response.Choices[0]\n        content := c.extractContent(choice)\n\n        if content != \"\" {\n            c.displayContent(content, toolCallsDetected, assistantStarted, fullContent)\n        }\n    }\n}\n\n// extractContent \u6839\u636e\u6d41\u5f0f\u6a21\u5f0f\u63d0\u53d6\u5185\u5bb9\nfunc (c *multiTurnChat) extractContent(choice model.Choice) string {\n    if c.streaming {\n        // \u6d41\u5f0f\u6a21\u5f0f\uff1a\u4f7f\u7528\u589e\u91cf\u5185\u5bb9\n        return choice.Delta.Content\n    }\n    // \u975e\u6d41\u5f0f\u6a21\u5f0f\uff1a\u4f7f\u7528\u5b8c\u6574\u6d88\u606f\u5185\u5bb9\n    return choice.Message.Content\n}\n\n// displayContent \u5c06\u5185\u5bb9\u6253\u5370\u5230\u63a7\u5236\u53f0\nfunc (c *multiTurnChat) displayContent(\n    content string,\n    toolCallsDetected *bool,\n    assistantStarted *bool,\n    fullContent *string,\n) {\n    if !*assistantStarted {\n        if *toolCallsDetected {\n            fmt.Printf(\"\\n\ud83e\udd16 Assistant: \")\n        }\n        *assistantStarted = true\n    }\n    fmt.Print(content)\n    *fullContent += content\n}\n</code></pre>"},{"location":"zh/event/#requestidparentinvocationidinvocationid","title":"RequestID,ParentInvocationID,InvocationID\u4e09\u8005\u7684\u5173\u7cfb\u4e0e\u4f7f\u7528\u573a\u666f","text":"<ul> <li><code>RequestID string</code>\uff1a\u7528\u4e8e\u6807\u8bc6\u533a\u5206\u540c\u4e00session\u4f1a\u8bdd\u4e0b\u7684\u591a\u6b21\u7528\u6237\u4ea4\u4e92\u8bf7\u6c42\uff0c\u53ef\u7531runner.Run\u901a\u8fc7agent.WithRequestID\u7ed1\u5b9a\u4e1a\u52a1\u5c42\u81ea\u5df1\u7684\u8bf7\u6c42ID\u3002</li> <li><code>ParentInvocationID string</code>\uff1a\u7528\u4e8e\u5173\u8054\u7236\u7ea7\u6267\u884c\u4e0a\u4e0b\u6587\uff0c\u53ef\u901a\u8fc7\u6b64ID\u5173\u8054\u5230\u7236\u7ea7\u6267\u884c\u4e2d\u7684\u76f8\u5173\u4e8b\u4ef6</li> <li><code>InvocationID string</code>\uff1a\u5f53\u524d\u6267\u884c\u4e0a\u4e0b\u6587ID\u3002\u53ef\u901a\u8fc7\u6b64ID\u5173\u8054\u540c\u4e00\u4e2a\u6267\u884c\u4e0a\u4e0b\u6587\u4e2d\u7684\u76f8\u5173\u4e8b\u4ef6</li> </ul> <p>\u53ef\u901a\u8fc7\u4ee5\u4e0a\u4e09\u4e2aID\uff0c\u5c06\u4e8b\u4ef6\u6d41\u6309\u7167\u5c42\u7ea7\u7ed3\u6784\u7ec4\u7ec7\uff0c\u5982\u4e0b\uff1a - requestID-1:   - invocationID-1:     - invocationID-2     - invocationID-3   - invocationID-1   - invocationID-4   - invocationID-5 - requestID-2:   - invocationID-6     - invocationID-7   - invocationID-8   - invocationID-9</p>"},{"location":"zh/graph/","title":"Graph \u5305\u4f7f\u7528\u6307\u5357","text":""},{"location":"zh/graph/#_1","title":"\u6982\u8ff0","text":"<p>Graph \u5c06\u53ef\u63a7\u7684\u5de5\u4f5c\u6d41\u7f16\u6392\u4e0e\u53ef\u6269\u5c55\u7684 Agent \u80fd\u529b\u7ed3\u5408\uff0c\u9002\u7528\u4e8e\uff1a</p> <ul> <li>\u7c7b\u578b\u5b89\u5168\u7684\u72b6\u6001\u7ba1\u7406\u4e0e\u53ef\u9884\u6d4b\u8def\u7531\uff1b</li> <li>LLM \u51b3\u7b56\u3001\u5de5\u5177\u8c03\u7528\u5faa\u73af\u3001\u53ef\u9009\u7684 Human in the Loop\uff08HITL\uff09\uff1b</li> <li>\u53ef\u590d\u7528\u7684\u7ec4\u4ef6\uff0c\u65e2\u53ef\u72ec\u7acb\u8fd0\u884c\uff0c\u4e5f\u53ef\u4f5c\u4e3a\u5b50 Agent \u7ec4\u5408\u3002</li> </ul> <p>\u7279\u70b9\uff1a</p> <ul> <li>Schema \u9a71\u52a8\u7684 State \u4e0e Reducer\uff0c\u907f\u514d\u5e76\u53d1\u5206\u652f\u5199\u5165\u540c\u4e00\u5b57\u6bb5\u65f6\u7684\u6570\u636e\u7ade\u4e89\uff1b</li> <li>BSP \u98ce\u683c\uff08\u8ba1\u5212/\u6267\u884c/\u5408\u5e76\uff09\u7684\u786e\u5b9a\u6027\u5e76\u884c\uff1b</li> <li>\u5185\u7f6e\u8282\u70b9\u7c7b\u578b\u5c01\u88c5 LLM\u3001\u5de5\u5177\u4e0e Agent\uff0c\u51cf\u5c11\u91cd\u590d\u4ee3\u7801\uff1b</li> <li>\u6d41\u5f0f\u4e8b\u4ef6\u3001\u68c0\u67e5\u70b9\u4e0e\u4e2d\u65ad\uff0c\u4fbf\u4e8e\u89c2\u6d4b\u4e0e\u6062\u590d\u3002</li> <li>\u8282\u70b9\u7ea7\u91cd\u8bd5/\u9000\u907f\uff08\u6307\u6570\u9000\u907f\u4e0e\u6296\u52a8\uff09\uff0c\u652f\u6301\u6267\u884c\u5668\u9ed8\u8ba4\u91cd\u8bd5\u7b56\u7565\u4e0e\u5e26\u91cd\u8bd5\u5143\u6570\u636e\u7684\u4e8b\u4ef6\u89c2\u6d4b\u3002</li> <li>\u8282\u70b9\u4e3b\u52a8\u5916\u629b\u4e8b\u4ef6\uff08EventEmitter\uff09\uff0c\u652f\u6301\u5728 NodeFunc \u4e2d\u53d1\u5c04\u81ea\u5b9a\u4e49\u4e8b\u4ef6\u3001\u8fdb\u5ea6\u66f4\u65b0\u548c\u6d41\u5f0f\u6587\u672c\u3002</li> </ul>"},{"location":"zh/graph/#_2","title":"\u5feb\u901f\u5f00\u59cb","text":""},{"location":"zh/graph/#_3","title":"\u6700\u5c0f\u5de5\u4f5c\u6d41","text":"<p>\u4e0b\u9762\u662f\u4e00\u4e2a\u7ecf\u5178\u7684\u201cprepare \u2192 ask LLM \u2192 \u53ef\u80fd\u8c03\u7528\u5de5\u5177\u201d\u7684\u5faa\u73af\uff0c\u4f7f\u7528 <code>graph.MessagesStateSchema()</code>\uff08\u5df2\u5b9a\u4e49 <code>graph.StateKeyMessages</code>\u3001<code>graph.StateKeyUserInput</code>\u3001<code>graph.StateKeyLastResponse</code> \u7b49\u952e\uff09\u3002</p> <pre><code>flowchart LR\n    START([start]):::startNode --&gt; P[prepare]:::processNode\n    P --&gt; A[ask LLM]:::llmNode\n    A -. tool_calls .-&gt; T[tools]:::toolNode\n    A -- no tool_calls --&gt; F[fallback]:::processNode\n    T --&gt; A\n    F --&gt; END([finish]):::endNode\n\n    classDef startNode fill:#e1f5e1,stroke:#4caf50,stroke-width:2px\n    classDef endNode fill:#ffe1e1,stroke:#f44336,stroke-width:2px\n    classDef llmNode fill:#e3f2fd,stroke:#2196f3,stroke-width:2px\n    classDef toolNode fill:#fff3e0,stroke:#ff9800,stroke-width:2px\n    classDef processNode fill:#f3e5f5,stroke:#9c27b0,stroke-width:2px</code></pre> <p>Graph \u5305\u5141\u8bb8\u60a8\u5c06\u590d\u6742\u7684 AI \u5de5\u4f5c\u6d41\u5efa\u6a21\u4e3a\u6709\u5411\u56fe\uff0c\u5176\u4e2d\u8282\u70b9\u4ee3\u8868\u5904\u7406\u6b65\u9aa4\uff0c\u8fb9\u4ee3\u8868\u6570\u636e\u6d41\u548c\u63a7\u5236\u6d41\u3002\u5b83\u7279\u522b\u9002\u5408\u6784\u5efa\u9700\u8981\u6761\u4ef6\u8def\u7531\u3001\u72b6\u6001\u7ba1\u7406\u548c\u591a\u6b65\u9aa4\u5904\u7406\u7684 AI \u5e94\u7528\u3002</p>"},{"location":"zh/graph/#_4","title":"\u4f7f\u7528\u6a21\u5f0f","text":"<p>Graph \u5305\u7684\u4f7f\u7528\u9075\u5faa\u4ee5\u4e0b\u6a21\u5f0f\uff1a</p> <ol> <li>\u521b\u5efa Graph\uff1a\u4f7f\u7528 <code>StateGraph</code> \u6784\u5efa\u5668\u5b9a\u4e49\u5de5\u4f5c\u6d41\u7ed3\u6784</li> <li>\u521b\u5efa GraphAgent\uff1a\u5c06\u7f16\u8bd1\u540e\u7684 Graph \u5305\u88c5\u4e3a Agent</li> <li>\u521b\u5efa Runner\uff1a\u4f7f\u7528 Runner \u7ba1\u7406\u4f1a\u8bdd\u548c\u6267\u884c\u73af\u5883</li> <li>\u6267\u884c\u5de5\u4f5c\u6d41\uff1a\u901a\u8fc7 Runner \u6267\u884c\u5de5\u4f5c\u6d41\u5e76\u5904\u7406\u7ed3\u679c</li> </ol> <p>\u8fd9\u79cd\u6a21\u5f0f\u63d0\u4f9b\u4e86\uff1a</p> <ul> <li>\u7c7b\u578b\u5b89\u5168\uff1a\u901a\u8fc7\u72b6\u6001\u6a21\u5f0f\u786e\u4fdd\u6570\u636e\u4e00\u81f4\u6027</li> <li>\u4f1a\u8bdd\u7ba1\u7406\uff1a\u652f\u6301\u591a\u7528\u6237\u3001\u591a\u4f1a\u8bdd\u7684\u5e76\u53d1\u6267\u884c</li> <li>\u4e8b\u4ef6\u6d41\uff1a\u5b9e\u65f6\u76d1\u63a7\u5de5\u4f5c\u6d41\u6267\u884c\u8fdb\u5ea6</li> <li>\u9519\u8bef\u5904\u7406\uff1a\u7edf\u4e00\u7684\u9519\u8bef\u5904\u7406\u548c\u6062\u590d\u673a\u5236</li> </ul>"},{"location":"zh/graph/#agent","title":"Agent \u96c6\u6210","text":"<p>GraphAgent \u5b9e\u73b0\u4e86 <code>agent.Agent</code> \u63a5\u53e3\uff0c\u53ef\u4ee5\uff1a</p> <ul> <li>\u4f5c\u4e3a\u72ec\u7acb Agent\uff1a\u901a\u8fc7 Runner \u76f4\u63a5\u6267\u884c</li> <li>\u4f5c\u4e3a SubAgent\uff1a\u88ab\u5176\u4ed6 Agent\uff08\u5982 LLMAgent\uff09\u4f5c\u4e3a\u5b50 Agent \u4f7f\u7528</li> <li>\u6302\u8f7d SubAgent\uff1a\u901a\u8fc7 <code>graphagent.WithSubAgents</code> \u914d\u7f6e\u5b50 Agent\uff0c\u5e76\u5728\u56fe\u4e2d\u4f7f\u7528 <code>AddAgentNode</code> \u59d4\u6258\u6267\u884c</li> </ul> <p>\u8fd9\u79cd\u8bbe\u8ba1\u4f7f\u5f97 GraphAgent \u65e2\u80fd\u63a5\u5165\u5176\u4ed6 Agent\uff0c\u4e5f\u80fd\u5728\u81ea\u8eab\u5de5\u4f5c\u6d41\u4e2d\u7075\u6d3b\u8c03\u5ea6\u5b50 Agent\u3002</p>"},{"location":"zh/graph/#_5","title":"\u4e3b\u8981\u7279\u6027","text":"<ul> <li>\u7c7b\u578b\u5b89\u5168\u7684\u72b6\u6001\u7ba1\u7406\uff1a\u4f7f\u7528 Schema \u5b9a\u4e49\u72b6\u6001\u7ed3\u6784\uff0c\u652f\u6301\u81ea\u5b9a\u4e49 Reducer</li> <li>\u6761\u4ef6\u8def\u7531\uff1a\u57fa\u4e8e\u72b6\u6001\u52a8\u6001\u9009\u62e9\u6267\u884c\u8def\u5f84</li> <li>LLM \u8282\u70b9\u96c6\u6210\uff1a\u5185\u7f6e\u5bf9\u5927\u578b\u8bed\u8a00\u6a21\u578b\u7684\u652f\u6301</li> <li>\u5de5\u5177\u8282\u70b9\uff1a\u652f\u6301\u51fd\u6570\u8c03\u7528\u548c\u5916\u90e8\u5de5\u5177\u96c6\u6210</li> <li>Agent \u8282\u70b9\uff1a\u901a\u8fc7\u5b50 Agent \u5c06\u5176\u4ed6 Agent \u878d\u5165\u56fe\u4e2d</li> <li>\u6d41\u5f0f\u6267\u884c\uff1a\u652f\u6301\u5b9e\u65f6\u4e8b\u4ef6\u6d41\u548c\u8fdb\u5ea6\u8ddf\u8e2a</li> <li>\u5e76\u53d1\u5b89\u5168\uff1a\u7ebf\u7a0b\u5b89\u5168\u7684\u56fe\u6267\u884c</li> <li>\u57fa\u4e8e\u68c0\u67e5\u70b9\u7684\u65f6\u95f4\u65c5\u884c\uff1a\u6d4f\u89c8\u6267\u884c\u5386\u53f2\u5e76\u6062\u590d\u4e4b\u524d\u7684\u72b6\u6001</li> <li>\u4eba\u673a\u534f\u4f5c (HITL)\uff1a\u652f\u6301\u5e26\u6709\u4e2d\u65ad\u548c\u6062\u590d\u529f\u80fd\u7684\u4ea4\u4e92\u5f0f\u5de5\u4f5c\u6d41</li> <li>\u539f\u5b50\u68c0\u67e5\u70b9\uff1a\u539f\u5b50\u5b58\u50a8\u68c0\u67e5\u70b9\u548c\u5f85\u5199\u5165\u6570\u636e\uff0c\u786e\u4fdd\u53ef\u9760\u7684\u6062\u590d</li> <li>\u68c0\u67e5\u70b9\u8c31\u7cfb\uff1a\u8ddf\u8e2a\u5f62\u6210\u6267\u884c\u7ebf\u7a0b\u7684\u76f8\u5173\u68c0\u67e5\u70b9\u53ca\u5176\u7236\u5b50\u5173\u7cfb</li> </ul>"},{"location":"zh/graph/#_6","title":"\u6838\u5fc3\u6982\u5ff5","text":""},{"location":"zh/graph/#1-graph","title":"1. \u56fe (Graph)","text":"<p>\u56fe\u662f\u5de5\u4f5c\u6d41\u7684\u6838\u5fc3\u7ed3\u6784\uff0c\u7531\u8282\u70b9\u548c\u8fb9\u7ec4\u6210\uff1a</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/graph\"\n)\n\n// \u521b\u5efa\u72b6\u6001\u6a21\u5f0f\nschema := graph.NewStateSchema()\n\n// \u521b\u5efa\u56fe\ngraph := graph.New(schema)\n</code></pre> <p>\u865a\u62df\u8282\u70b9\uff1a</p> <ul> <li><code>Start</code>\uff1a\u865a\u62df\u8d77\u59cb\u8282\u70b9\uff0c\u901a\u8fc7 <code>SetEntryPoint()</code> \u81ea\u52a8\u8fde\u63a5</li> <li><code>End</code>\uff1a\u865a\u62df\u7ed3\u675f\u8282\u70b9\uff0c\u901a\u8fc7 <code>SetFinishPoint()</code> \u81ea\u52a8\u8fde\u63a5</li> <li>\u8fd9\u4e9b\u8282\u70b9\u4e0d\u9700\u8981\u663e\u5f0f\u521b\u5efa\uff0c\u7cfb\u7edf\u4f1a\u81ea\u52a8\u5904\u7406\u8fde\u63a5</li> </ul>"},{"location":"zh/graph/#2-node","title":"2. \u8282\u70b9 (Node)","text":"<p>\u8282\u70b9\u4ee3\u8868\u5de5\u4f5c\u6d41\u4e2d\u7684\u4e00\u4e2a\u5904\u7406\u6b65\u9aa4\uff1a</p> <pre><code>import (\n    \"context\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/graph\"\n)\n\n// \u8282\u70b9\u51fd\u6570\u7b7e\u540d\ntype NodeFunc func(ctx context.Context, state graph.State) (any, error)\n\n// \u521b\u5efa\u8282\u70b9\nnode := &amp;graph.Node{\n    ID:          \"process_data\",\n    Name:        \"\u6570\u636e\u5904\u7406\",\n    Description: \"\u5904\u7406\u8f93\u5165\u6570\u636e\",\n    Function:    processDataFunc,\n}\n</code></pre>"},{"location":"zh/graph/#3-state","title":"3. \u72b6\u6001 (State)","text":"<p>\u72b6\u6001\u662f\u5728\u8282\u70b9\u95f4\u4f20\u9012\u7684\u6570\u636e\u5bb9\u5668\uff1a</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/graph\"\n)\n\n// \u72b6\u6001\u662f\u4e00\u4e2a\u952e\u503c\u5bf9\u6620\u5c04\ntype State map[string]any\n\n// \u7528\u6237\u81ea\u5b9a\u4e49\u7684\u72b6\u6001\u952e\nconst (\n    StateKeyInput         = \"input\"          // \u8f93\u5165\u6570\u636e\n    StateKeyResult        = \"result\"         // \u5904\u7406\u7ed3\u679c\n    StateKeyProcessedData = \"processed_data\" // \u5904\u7406\u540e\u7684\u6570\u636e\n    StateKeyStatus        = \"status\"         // \u5904\u7406\u72b6\u6001\n)\n</code></pre> <p>\u5185\u7f6e\u72b6\u6001\u952e\uff1a</p> <p>Graph \u5305\u63d0\u4f9b\u4e86\u4e00\u4e9b\u5185\u7f6e\u72b6\u6001\u952e\uff0c\u4e3b\u8981\u7528\u4e8e\u7cfb\u7edf\u5185\u90e8\u901a\u4fe1\uff1a</p> <p>\u7528\u6237\u53ef\u8bbf\u95ee\u7684\u5185\u7f6e\u952e\uff1a</p> <ul> <li><code>StateKeyUserInput</code>\uff1a\u7528\u6237\u8f93\u5165\uff08\u4e00\u6b21\u6027\uff0c\u6d88\u8d39\u540e\u6e05\u7a7a\uff0c\u7531 LLM \u8282\u70b9\u81ea\u52a8\u6301\u4e45\u5316\uff09</li> <li><code>StateKeyOneShotMessages</code>\uff1a\u4e00\u6b21\u6027\u6d88\u606f\uff08\u5b8c\u6574\u8986\u76d6\u672c\u8f6e\u8f93\u5165\uff0c\u6d88\u8d39\u540e\u6e05\u7a7a\uff09</li> <li><code>StateKeyLastResponse</code>\uff1a\u6700\u540e\u54cd\u5e94\uff08\u7528\u4e8e\u8bbe\u7f6e\u6700\u7ec8\u8f93\u51fa\uff0cExecutor \u4f1a\u8bfb\u53d6\u6b64\u503c\u4f5c\u4e3a\u7ed3\u679c\uff09</li> <li><code>StateKeyMessages</code>\uff1a\u6d88\u606f\u5386\u53f2\uff08\u6301\u4e45\u5316\uff0c\u652f\u6301 append + MessageOp \u8865\u4e01\u64cd\u4f5c\uff09</li> <li><code>StateKeyNodeResponses</code>\uff1a\u6309\u8282\u70b9\u5b58\u50a8\u7684\u54cd\u5e94\u6620\u5c04\u3002\u952e\u4e3a\u8282\u70b9 ID\uff0c\u503c\u4e3a\u8be5   \u8282\u70b9\u7684\u6700\u7ec8\u6587\u672c\u54cd\u5e94\u3002<code>StateKeyLastResponse</code> \u7528\u4e8e\u4e32\u884c\u8def\u5f84\u4e0a\u7684\u6700\u7ec8\u8f93   \u51fa\uff1b\u5f53\u591a\u4e2a\u5e76\u884c\u8282\u70b9\u5728\u67d0\u5904\u6c47\u5408\u65f6\uff0c\u5e94\u4ece <code>StateKeyNodeResponses</code> \u4e2d\u6309\u8282   \u70b9\u8bfb\u53d6\u5404\u81ea\u7684\u8f93\u51fa\u3002</li> <li><code>StateKeyMetadata</code>\uff1a\u5143\u6570\u636e\uff08\u7528\u6237\u53ef\u7528\u7684\u901a\u7528\u5143\u6570\u636e\u5b58\u50a8\uff09</li> </ul> <p>\u7cfb\u7edf\u5185\u90e8\u952e\uff08\u7528\u6237\u4e0d\u5e94\u76f4\u63a5\u4f7f\u7528\uff09\uff1a</p> <ul> <li><code>StateKeySession</code>\uff1a\u4f1a\u8bdd\u4fe1\u606f\uff08\u7531 GraphAgent \u81ea\u52a8\u8bbe\u7f6e\uff09</li> <li><code>StateKeyExecContext</code>\uff1a\u6267\u884c\u4e0a\u4e0b\u6587\uff08\u7531 Executor \u81ea\u52a8\u8bbe\u7f6e\uff09</li> <li><code>StateKeyToolCallbacks</code>\uff1a\u5de5\u5177\u56de\u8c03\uff08\u7531 Executor \u81ea\u52a8\u8bbe\u7f6e\uff09</li> <li><code>StateKeyModelCallbacks</code>\uff1a\u6a21\u578b\u56de\u8c03\uff08\u7531 Executor \u81ea\u52a8\u8bbe\u7f6e\uff09</li> </ul> <p>\u7528\u6237\u5e94\u8be5\u4f7f\u7528\u81ea\u5b9a\u4e49\u72b6\u6001\u952e\u6765\u5b58\u50a8\u4e1a\u52a1\u6570\u636e\uff0c\u53ea\u5728\u5fc5\u8981\u65f6\u4f7f\u7528\u7528\u6237\u53ef\u8bbf\u95ee\u7684\u5185\u7f6e\u72b6\u6001\u952e\u3002</p>"},{"location":"zh/graph/#4-stateschema","title":"4. \u72b6\u6001\u6a21\u5f0f (StateSchema)","text":"<p>\u72b6\u6001\u6a21\u5f0f\u5b9a\u4e49\u72b6\u6001\u7684\u7ed3\u6784\u548c\u884c\u4e3a\uff1a</p> <pre><code>import (\n    \"reflect\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/graph\"\n)\n\n// \u521b\u5efa\u72b6\u6001\u6a21\u5f0f\nschema := graph.NewStateSchema()\n\n// \u6dfb\u52a0\u5b57\u6bb5\u5b9a\u4e49\nschema.AddField(\"counter\", graph.StateField{\n    Type:    reflect.TypeOf(0),\n    Reducer: graph.DefaultReducer,\n    Default: func() any { return 0 },\n})\n</code></pre>"},{"location":"zh/graph/#_7","title":"\u4f7f\u7528\u6307\u5357","text":""},{"location":"zh/graph/#io","title":"\u8282\u70b9 I/O \u7ea6\u5b9a","text":"<p>\u8282\u70b9\u4e4b\u95f4\u4ec5\u901a\u8fc7\u5171\u4eab\u72b6\u6001 State \u4f20\u9012\u6570\u636e\u3002\u6bcf\u4e2a\u8282\u70b9\u8fd4\u56de\u4e00\u4e2a state delta\uff0c\u6309 Schema \u7684 Reducer \u5408\u5e76\u5230\u5168\u5c40 State\uff0c\u4e0b\u6e38\u8282\u70b9\u4ece State \u8bfb\u53d6\u4e0a\u6e38\u4ea7\u51fa\u3002</p> <ul> <li> <p>\u5e38\u7528\u5185\u7f6e\u952e\uff08\u5bf9\u7528\u6237\u53ef\u89c1\uff09</p> <ul> <li><code>user_input</code>\uff1a\u4e00\u6b21\u6027\u7528\u6237\u8f93\u5165\uff0c\u88ab\u4e0b\u4e00\u4e2a LLM/Agent \u8282\u70b9\u6d88\u8d39\u540e\u6e05\u7a7a</li> <li><code>one_shot_messages</code>\uff1a\u4e00\u6b21\u6027\u5b8c\u6574\u6d88\u606f\u8986\u76d6\uff0c\u7528\u4e8e\u4e0b\u4e00\u6b21 LLM \u8c03\u7528\uff0c\u6267\u884c\u540e\u6e05\u7a7a</li> <li><code>messages</code>\uff1a\u6301\u4e45\u5316\u7684\u6d88\u606f\u5386\u53f2\uff08LLM/Tools \u4f1a\u8ffd\u52a0\uff09\uff0c\u652f\u6301 MessageOp \u8865\u4e01</li> <li><code>last_response</code>\uff1a\u6700\u8fd1\u4e00\u6b21\u52a9\u624b\u6587\u672c\u56de\u590d</li> <li><code>node_responses</code>\uff1amap[nodeID]any\uff0c\u6309\u8282\u70b9\u4fdd\u5b58\u6700\u7ec8\u6587\u672c\u56de\u590d\u3002\u6700\u8fd1\u7ed3\u679c\u7528 <code>last_response</code></li> </ul> </li> </ul> <ul> <li> <p>\u51fd\u6570\u8282\u70b9\uff08Function node\uff09</p> <ul> <li>\u8f93\u5165\uff1a\u5b8c\u6574 State</li> <li>\u8f93\u51fa\uff1a\u8fd4\u56de <code>graph.State</code> \u589e\u91cf\uff0c\u5199\u5165\u81ea\u5b9a\u4e49\u952e\uff08\u9700\u5728 Schema \u4e2d\u58f0\u660e\uff09\uff0c\u5982 <code>{\"parsed_time\":\"...\"}</code></li> </ul> </li> </ul> <ul> <li> <p>LLM \u8282\u70b9</p> <ul> <li>\u8f93\u5165\u4f18\u5148\u7ea7\uff1a<code>one_shot_messages</code> \u2192 <code>user_input</code> \u2192 <code>messages</code></li> <li>\u8f93\u51fa\uff1a<ul> <li>\u5411 <code>messages</code> \u8ffd\u52a0\u52a9\u624b\u6d88\u606f</li> <li>\u8bbe\u7f6e <code>last_response</code></li> <li>\u8bbe\u7f6e <code>node_responses[&lt;llm_node_id&gt;]</code></li> </ul> </li> </ul> </li> </ul> <ul> <li> <p>Tools \u8282\u70b9</p> <ul> <li>\u8f93\u5165\uff1a\u4ece <code>messages</code> \u4e2d\u5bfb\u627e\u6700\u65b0\u7684\u5e26 <code>tool_calls</code> \u7684\u52a9\u624b\u6d88\u606f</li> <li>\u8f93\u51fa\uff1a\u5411 <code>messages</code> \u8ffd\u52a0\u5de5\u5177\u8fd4\u56de\u6d88\u606f</li> </ul> </li> </ul> <ul> <li>Agent \u8282\u70b9\uff08\u5b50\u4ee3\u7406\uff09<ul> <li>\u8f93\u5165\uff1aGraph \u7684 State \u901a\u8fc7 <code>Invocation.RunOptions.RuntimeState</code> \u4f20\u5165\u5b50\u4ee3\u7406<ul> <li>\u5b50\u4ee3\u7406\u7684 Model/Tool \u56de\u8c03\u53ef\u901a\u8fc7 <code>agent.InvocationFromContext(ctx)</code> \u8bbf\u95ee</li> </ul> </li> <li>\u7ed3\u675f\u8f93\u51fa\uff1a<ul> <li>\u8bbe\u7f6e <code>last_response</code></li> <li>\u8bbe\u7f6e <code>node_responses[&lt;agent_node_id&gt;]</code></li> <li>\u6e05\u7a7a <code>user_input</code></li> </ul> </li> </ul> </li> </ul> <p>\u63a8\u8350\u7528\u6cd5</p> <ul> <li>\u5728 Schema \u4e2d\u58f0\u660e\u4e1a\u52a1\u5b57\u6bb5\uff08\u5982 <code>parsed_time</code>\u3001<code>final_payload</code>\uff09\uff0c\u51fd\u6570\u8282\u70b9\u5199\u5165/\u8bfb\u53d6\u3002</li> <li>\u9700\u8981\u7ed9 LLM \u8282\u70b9\u6ce8\u5165\u7ed3\u6784\u5316\u63d0\u793a\u65f6\uff0c\u53ef\u5728\u524d\u7f6e\u8282\u70b9\u5199\u5165 <code>one_shot_messages</code>\uff08\u4f8b\u5982\u52a0\u5165\u5305\u542b\u89e3\u6790\u4fe1\u606f\u7684 system message\uff09\u3002</li> <li>\u9700\u8981\u6d88\u8d39\u4e0a\u6e38\u6587\u672c\u7ed3\u679c\u65f6\uff1a\u7d27\u90bb\u4e0b\u6e38\u8bfb\u53d6 <code>last_response</code>\uff0c\u6216\u5728\u4efb\u610f\u540e\u7eed\u8282\u70b9\u8bfb\u53d6 <code>node_responses[\u8282\u70b9ID]</code>\u3002</li> </ul> <p>\u793a\u4f8b\uff1a</p> <ul> <li><code>examples/graph/io_conventions</code>\uff1a\u51fd\u6570 + LLM + Agent \u7684 I/O \u6f14\u793a</li> <li><code>examples/graph/io_conventions_tools</code>\uff1a\u52a0\u5165 Tools \u8282\u70b9\uff0c\u5c55\u793a\u5982\u4f55\u83b7\u53d6\u5de5\u5177 JSON \u5e76\u843d\u5165 State</li> <li><code>examples/graph/retry</code>\uff1a\u8282\u70b9\u7ea7\u91cd\u8bd5/\u9000\u907f\u6f14\u793a</li> </ul>"},{"location":"zh/graph/#_8","title":"\u72b6\u6001\u952e\u5e38\u91cf\u4e0e\u6765\u6e90\uff08\u53ef\u76f4\u63a5\u5f15\u7528\uff09","text":"<ul> <li>\u5bfc\u5165\u5305\uff1a<code>import \"trpc.group/trpc-go/trpc-agent-go/graph\"</code></li> <li>\u5e38\u91cf\u5b9a\u4e49\u4f4d\u7f6e\uff1a<code>graph/state.go</code></li> </ul> <ul> <li> <p>\u7528\u6237\u53ef\u89c1\u3001\u5e38\u7528\u952e</p> <ul> <li><code>user_input</code> \u2192 \u5e38\u91cf <code>graph.StateKeyUserInput</code></li> <li><code>one_shot_messages</code> \u2192 \u5e38\u91cf <code>graph.StateKeyOneShotMessages</code></li> <li><code>messages</code> \u2192 \u5e38\u91cf <code>graph.StateKeyMessages</code></li> <li><code>last_response</code> \u2192 \u5e38\u91cf <code>graph.StateKeyLastResponse</code></li> <li><code>node_responses</code> \u2192 \u5e38\u91cf <code>graph.StateKeyNodeResponses</code></li> </ul> </li> </ul> <ul> <li>\u5176\u4ed6\u5e38\u7528\u952e<ul> <li><code>session</code> \u2192 <code>graph.StateKeySession</code></li> <li><code>metadata</code> \u2192 <code>graph.StateKeyMetadata</code></li> <li><code>current_node_id</code> \u2192 <code>graph.StateKeyCurrentNodeID</code></li> <li><code>exec_context</code> \u2192 <code>graph.StateKeyExecContext</code></li> <li><code>tool_callbacks</code> \u2192 <code>graph.StateKeyToolCallbacks</code></li> <li><code>model_callbacks</code> \u2192 <code>graph.StateKeyModelCallbacks</code></li> <li><code>agent_callbacks</code> \u2192 <code>graph.StateKeyAgentCallbacks</code></li> <li><code>parent_agent</code> \u2192 <code>graph.StateKeyParentAgent</code></li> </ul> </li> </ul> <p>\u4f7f\u7528\u793a\u4f8b\uff1a</p> <pre><code>import (\n    \"context\"\n    \"trpc.group/trpc-go/trpc-agent-go/graph\"\n)\n\nfunc myNode(ctx context.Context, state graph.State) (any, error) {\n    // \u8bfb\u53d6\u4e0a\u4e00\u8282\u70b9\u6587\u672c\u8f93\u51fa\n    last, _ := state[graph.StateKeyLastResponse].(string)\n    // \u5199\u5165\u81ea\u5b9a\u4e49\u5b57\u6bb5\n    return graph.State{\"my_key\": last}, nil\n}\n</code></pre>"},{"location":"zh/graph/#statedelta","title":"\u4e8b\u4ef6\u5143\u6570\u636e\u952e\uff08StateDelta\uff09","text":"<ul> <li>\u5bfc\u5165\u5305\uff1a<code>import \"trpc.group/trpc-go/trpc-agent-go/graph\"</code></li> <li>\u5e38\u91cf\u5b9a\u4e49\u4f4d\u7f6e\uff1a<code>graph/events.go</code></li> </ul> <ul> <li>\u6a21\u578b\u5143\u6570\u636e\uff1a<code>_model_metadata</code> \u2192 <code>graph.MetadataKeyModel</code>\uff08\u7ed3\u6784\u4f53 <code>graph.ModelExecutionMetadata</code>\uff09</li> <li>\u5de5\u5177\u5143\u6570\u636e\uff1a<code>_tool_metadata</code> \u2192 <code>graph.MetadataKeyTool</code>\uff08\u7ed3\u6784\u4f53 <code>graph.ToolExecutionMetadata</code>\uff09</li> <li>\u8282\u70b9\u5143\u6570\u636e\uff1a<code>_node_metadata</code> \u2192 <code>graph.MetadataKeyNode</code>\uff08\u7ed3\u6784\u4f53 <code>graph.NodeExecutionMetadata</code>\uff09\u3002\u5305\u542b\u91cd\u8bd5\u5b57\u6bb5\uff1a<code>Attempt</code>\u3001<code>MaxAttempts</code>\u3001<code>NextDelay</code>\u3001<code>Retrying</code> \u53ca\u65f6\u95f4\u76f8\u5173\u4fe1\u606f\u3002</li> </ul> <p>\u4f7f\u7528\u793a\u4f8b\uff1a</p> <pre><code>if b, ok := event.StateDelta[graph.MetadataKeyModel]; ok {\n    var md graph.ModelExecutionMetadata\n    _ = json.Unmarshal(b, &amp;md)\n}\n</code></pre>"},{"location":"zh/graph/#eventemitter","title":"\u8282\u70b9\u4e3b\u52a8\u5916\u629b\u4e8b\u4ef6\uff08EventEmitter\uff09","text":"<p>\u5728 NodeFunc \u6267\u884c\u8fc7\u7a0b\u4e2d\uff0c\u8282\u70b9\u53ef\u4ee5\u901a\u8fc7 <code>EventEmitter</code> \u4e3b\u52a8\u5411\u5916\u90e8\u53d1\u5c04\u81ea\u5b9a\u4e49\u4e8b\u4ef6\uff0c\u7528\u4e8e\u5b9e\u65f6\u4f20\u9012\u8fdb\u5ea6\u3001\u4e2d\u95f4\u7ed3\u679c\u6216\u81ea\u5b9a\u4e49\u4e1a\u52a1\u6570\u636e\u3002</p> <p>\u83b7\u53d6 EventEmitter</p> <pre><code>func myNode(ctx context.Context, state graph.State) (any, error) {\n    // \u4ece State \u4e2d\u83b7\u53d6 EventEmitter\n    emitter := graph.GetEventEmitterWithContext(ctx, state)\n    // \u6216\u76f4\u63a5\u8c03\u7528 emitter := graph.GetEventEmitter(state)\n    return state, nil\n}\n</code></pre> <p>EventEmitter \u63a5\u53e3</p> <pre><code>type EventEmitter interface {\n    // Emit \u53d1\u5c04\u4efb\u610f\u4e8b\u4ef6\n    Emit(evt *event.Event) error\n    // EmitCustom \u53d1\u5c04\u81ea\u5b9a\u4e49\u4e8b\u4ef6\n    EmitCustom(eventType string, payload any) error\n    // EmitProgress \u53d1\u5c04\u8fdb\u5ea6\u4e8b\u4ef6\uff08progress: 0-100\uff09\n    EmitProgress(progress float64, message string) error\n    // EmitText \u53d1\u5c04\u6d41\u5f0f\u6587\u672c\u4e8b\u4ef6\n    EmitText(text string) error\n    // Context \u8fd4\u56de\u5173\u8054\u7684 context\n    Context() context.Context\n}\n</code></pre> <p>\u4f7f\u7528\u793a\u4f8b</p> <pre><code>func dataProcessNode(ctx context.Context, state graph.State) (any, error) {\n    emitter := graph.GetEventEmitter(state)\n\n    // 1. \u53d1\u5c04\u81ea\u5b9a\u4e49\u4e8b\u4ef6\n    emitter.EmitCustom(\"data.loaded\", map[string]any{\n        \"recordCount\": 1000,\n        \"source\":      \"database\",\n    })\n\n    // 2. \u53d1\u5c04\u8fdb\u5ea6\u4e8b\u4ef6\n    total := 100\n    for i := 0; i &lt; total; i++ {\n        processItem(i)\n        progress := float64(i+1) / float64(total) * 100\n        emitter.EmitProgress(progress, fmt.Sprintf(\"Processing %d/%d\", i+1, total))\n    }\n\n    // 3. \u53d1\u5c04\u6d41\u5f0f\u6587\u672c\n    emitter.EmitText(\"Processing complete.\\n\")\n    emitter.EmitText(\"Results: 100 items processed successfully.\")\n\n    return state, nil\n}\n</code></pre> <p>\u4e8b\u4ef6\u6d41\u8f6c\u6d41\u7a0b</p> <pre><code>sequenceDiagram\n    autonumber\n    participant NF as NodeFunc\n    participant EE as EventEmitter\n    participant EC as EventChan\n    participant EX as Executor\n    participant TR as AGUI Translator\n    participant FE as \u5ba2\u6237\u7aef\n\n    Note over NF,FE: \u4e8b\u4ef6\u53d1\u5c04\u9636\u6bb5\n    NF-&gt;&gt;EE: GetEventEmitter(state)\n    EE--&gt;&gt;NF: \u8fd4\u56de EventEmitter \u5b9e\u4f8b\n\n    alt \u53d1\u5c04\u81ea\u5b9a\u4e49\u4e8b\u4ef6\n        NF-&gt;&gt;EE: EmitCustom(eventType, payload)\n    else \u53d1\u5c04\u8fdb\u5ea6\u4e8b\u4ef6\n        NF-&gt;&gt;EE: EmitProgress(progress, message)\n    else \u53d1\u5c04\u6587\u672c\u4e8b\u4ef6\n        NF-&gt;&gt;EE: EmitText(text)\n    end\n\n    Note over EE: \u6784\u5efa NodeCustomEventMetadata\n    EE-&gt;&gt;EE: \u6ce8\u5165 NodeID, InvocationID, Timestamp\n    EE-&gt;&gt;EC: \u53d1\u9001 Event \u5230 Chan\n\n    Note over EC,FE: \u4e8b\u4ef6\u6d88\u8d39\u9636\u6bb5\n    EC-&gt;&gt;EX: Executor \u63a5\u6536\u4e8b\u4ef6\n    EX-&gt;&gt;TR: \u4f20\u9012\u4e8b\u4ef6\u7ed9 Translator\n\n    alt Custom \u7c7b\u578b\u4e8b\u4ef6\n        TR-&gt;&gt;TR: \u8f6c\u6362\u4e3a AG-UI CustomEvent\n    else Progress \u7c7b\u578b\u4e8b\u4ef6\n        TR-&gt;&gt;TR: \u8f6c\u6362\u4e3a AG-UI CustomEvent (\u542b\u8fdb\u5ea6\u4fe1\u606f)\n    else Text \u7c7b\u578b\u4e8b\u4ef6 (\u6d88\u606f\u4e0a\u4e0b\u6587)\n        TR-&gt;&gt;TR: \u8f6c\u6362\u4e3a TextMessageContentEvent\n    else Text \u7c7b\u578b\u4e8b\u4ef6 (\u975e\u6d88\u606f\u4e0a\u4e0b)\n        TR-&gt;&gt;TR: \u8f6c\u6362\u4e3a AG-UI CustomEvent\n    end\n\n    TR-&gt;&gt;FE: SSE \u63a8\u9001 AG-UI \u4e8b\u4ef6\n    FE-&gt;&gt;FE: \u5904\u7406\u5e76\u66f4\u65b0 UI</code></pre> <p>AGUI \u4e8b\u4ef6\u8f6c\u6362</p> <p>\u5f53\u4f7f\u7528 AGUI Server \u65f6\uff0c\u8282\u70b9\u53d1\u5c04\u7684\u4e8b\u4ef6\u4f1a\u81ea\u52a8\u8f6c\u6362\u4e3a AG-UI \u534f\u8bae\u4e8b\u4ef6\uff1a</p> \u8282\u70b9\u4e8b\u4ef6\u7c7b\u578b AG-UI \u4e8b\u4ef6\u7c7b\u578b \u8bf4\u660e Custom CustomEvent \u81ea\u5b9a\u4e49\u4e8b\u4ef6\uff0cpayload \u5728 <code>value</code> \u5b57\u6bb5 Progress CustomEvent \u8fdb\u5ea6\u4e8b\u4ef6\uff0c\u5305\u542b <code>progress</code> \u548c <code>message</code> Text\uff08\u6d88\u606f\u4e0a\u4e0b\u6587\u4e2d\uff09 TextMessageContentEvent \u6d41\u5f0f\u6587\u672c\u8ffd\u52a0\u5230\u5f53\u524d\u6d88\u606f Text\uff08\u975e\u6d88\u606f\u4e0a\u4e0b\u6587\uff09 CustomEvent \u5305\u542b <code>nodeId</code> \u548c <code>content</code> \u5b57\u6bb5 <p>\u6ce8\u610f\u4e8b\u9879</p> <ul> <li>\u7ebf\u7a0b\u5b89\u5168\uff1aEventEmitter \u662f\u7ebf\u7a0b\u5b89\u5168\u7684\uff0c\u53ef\u5728\u5e76\u53d1\u73af\u5883\u4e2d\u4f7f\u7528</li> <li>\u4f18\u96c5\u964d\u7ea7\uff1a\u82e5 State \u4e2d\u65e0\u6709\u6548\u7684 ExecutionContext \u6216 EventChan\uff0c<code>GetEventEmitter</code> \u8fd4\u56de no-op emitter\uff0c\u6240\u6709\u64cd\u4f5c\u9759\u9ed8\u6210\u529f</li> <li>\u9519\u8bef\u5904\u7406\uff1a\u4e1a\u52a1\u5b9e\u8df5\u4e2d\u5efa\u8bae\u4e8b\u4ef6\u53d1\u5c04\u5931\u8d25\u4e0d\u8981\u4e2d\u65ad\u8282\u70b9\u6267\u884c\uff0c\u4ec5\u8bb0\u5f55\u8b66\u544a\u65e5\u5fd7\uff0c\u5ffd\u7565\u5f02\u5e38</li> <li>\u81ea\u5b9a\u4e49\u4e8b\u4ef6\u5143\u6570\u636e\uff1a<code>_node_custom_metadata</code> \u2192 <code>graph.MetadataKeyNodeCustom</code>\uff08\u7ed3\u6784\u4f53 <code>graph.NodeCustomEventMetadata</code>\uff09</li> </ul>"},{"location":"zh/graph/#1-graphagent-runner","title":"1. \u521b\u5efa GraphAgent \u548c Runner","text":"<p>\u7528\u6237\u4e3b\u8981\u901a\u8fc7\u521b\u5efa GraphAgent \u7136\u540e\u901a\u8fc7 Runner \u6765\u4f7f\u7528 Graph \u5305\u3002\u8fd9\u662f\u63a8\u8350\u7684\u4f7f\u7528\u6a21\u5f0f\uff1a</p> <pre><code>package main\n\nimport (\n    \"context\"\n    \"fmt\"\n    \"time\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/agent/graphagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/graph\"\n    \"trpc.group/trpc-go/trpc-agent-go/model\"\n    \"trpc.group/trpc-go/trpc-agent-go/runner\"\n    \"trpc.group/trpc-go/trpc-agent-go/session/inmemory\"\n)\n\nfunc main() {\n    // 1. \u521b\u5efa\u72b6\u6001\u6a21\u5f0f\n    schema := graph.MessagesStateSchema()\n\n    // 2. \u521b\u5efa\u72b6\u6001\u56fe\u6784\u5efa\u5668\n    stateGraph := graph.NewStateGraph(schema)\n\n    // 3. \u6dfb\u52a0\u8282\u70b9\n    stateGraph.AddNode(\"start\", startNodeFunc).\n        AddNode(\"process\", processNodeFunc)\n\n    // 4. \u8bbe\u7f6e\u8fb9\n    stateGraph.AddEdge(\"start\", \"process\")\n\n    // 5. \u8bbe\u7f6e\u5165\u53e3\u70b9\u548c\u7ed3\u675f\u70b9\n    // SetEntryPoint \u4f1a\u81ea\u52a8\u521b\u5efa\u865a\u62df Start \u8282\u70b9\u5230 \"start\" \u8282\u70b9\u7684\u8fb9\n    // SetFinishPoint \u4f1a\u81ea\u52a8\u521b\u5efa \"process\" \u8282\u70b9\u5230\u865a\u62df End \u8282\u70b9\u7684\u8fb9\n    stateGraph.SetEntryPoint(\"start\").\n        SetFinishPoint(\"process\")\n\n    // 6. \u7f16\u8bd1\u56fe\n    compiledGraph, err := stateGraph.Compile()\n    if err != nil {\n        panic(err)\n    }\n\n    // 7. \u521b\u5efa GraphAgent\n    graphAgent, err := graphagent.New(\"simple-workflow\", compiledGraph,\n        graphagent.WithDescription(\"\u7b80\u5355\u7684\u5de5\u4f5c\u6d41\u793a\u4f8b\"),\n        graphagent.WithInitialState(graph.State{}),\n        // \u8bbe\u7f6e\u4f20\u7ed9\u6a21\u578b\u7684\u6d88\u606f\u8fc7\u6ee4\u6a21\u5f0f\uff0c\u6700\u7ec8\u4f20\u7ed9\u6a21\u578b\u7684\u6d88\u606f\u9700\u540c\u65f6\u6ee1\u8db3WithMessageTimelineFilterMode\u4e0eWithMessageBranchFilterMode\u6761\u4ef6\n        // \u65f6\u95f4\u7ef4\u5ea6\u8fc7\u6ee4\u6761\u4ef6\n        // \u9ed8\u8ba4\u503c: graphagent.TimelineFilterAll\n        // \u53ef\u9009\u503c:\n        //  - graphagent.TimelineFilterAll: \u5305\u542b\u5386\u53f2\u6d88\u606f\u4ee5\u53ca\u5f53\u524d\u8bf7\u6c42\u4e2d\u6240\u751f\u6210\u7684\u6d88\u606f\n        //  - graphagent.TimelineFilterCurrentRequest: \u4ec5\u5305\u542b\u5f53\u524d\u8bf7\u6c42\u4e2d\u6240\u751f\u6210\u7684\u6d88\u606f\n        //  - graphagent.TimelineFilterCurrentInvocation: \u4ec5\u5305\u542b\u5f53\u524dinvocation\u4e0a\u4e0b\u6587\u4e2d\u751f\u6210\u7684\u6d88\u606f\n        graphagent.WithMessageTimelineFilterMode(graphagent.TimelineFilterAll),\n        // \u5206\u652f\u7ef4\u5ea6\u8fc7\u6ee4\u6761\u4ef6\n        // \u9ed8\u8ba4\u503c: graphagent.BranchFilterModePrefix\n        // \u53ef\u9009\u503c:\n        //  - graphagent.BranchFilterModeAll: \u5305\u542b\u6240\u6709agent\u7684\u6d88\u606f, \u5f53\u524dagent\u4e0e\u6a21\u578b\u4ea4\u4e92\u65f6,\u5982\u9700\u5c06\u6240\u6709agent\u751f\u6210\u7684\u6709\u6548\u5185\u5bb9\u6d88\u606f\u540c\u6b65\u7ed9\u6a21\u578b\u65f6\u53ef\u8bbe\u7f6e\u8be5\u503c\n        //  - graphagent.BranchFilterModePrefix: \u901a\u8fc7Event.FilterKey\u4e0eInvocation.eventFilterKey\u505a\u524d\u7f00\u5339\u914d\u8fc7\u6ee4\u6d88\u606f, \u671f\u671b\u5c06\u4e0e\u5f53\u524dagent\u4ee5\u53ca\u76f8\u5173\u4e0a\u4e0b\u6e38agent\u751f\u6210\u7684\u6d88\u606f\u4f20\u9012\u7ed9\u6a21\u578b\u65f6\uff0c\u53ef\u8bbe\u7f6e\u8be5\u503c\n        //  - graphagent.BranchFilterModeExact: \u901a\u8fc7Event.FilterKey==Invocation.eventFilterKey\u8fc7\u6ee4\u6d88\u606f\uff0c\u5f53\u524dagent\u4e0e\u6a21\u578b\u4ea4\u4e92\u65f6,\u4ec5\u9700\u4f7f\u7528\u5f53\u524dagent\u751f\u6210\u7684\u6d88\u606f\u65f6\u53ef\u8bbe\u7f6e\u8be5\u503c\n        graphagent.WithMessageBranchFilterMode(graphagent.BranchFilterModeAll),\n    )\n    if err != nil {\n        panic(err)\n    }\n\n    // 8. \u521b\u5efa\u4f1a\u8bdd\u670d\u52a1\n    sessionService := inmemory.NewSessionService()\n\n    // 9. \u521b\u5efa Runner\n    appRunner := runner.NewRunner(\n        \"simple-app\",\n        graphAgent,\n        runner.WithSessionService(sessionService),\n    )\n\n    // 10. \u6267\u884c\u5de5\u4f5c\u6d41\n    ctx := context.Background()\n    userID := \"user\"\n    sessionID := fmt.Sprintf(\"session-%d\", time.Now().Unix())\n\n    // \u521b\u5efa\u7528\u6237\u6d88\u606f\uff08Runner \u4f1a\u81ea\u52a8\u5c06\u6d88\u606f\u5185\u5bb9\u653e\u5165 StateKeyUserInput\uff09\n    message := model.NewUserMessage(\"Hello World\")\n\n    // \u901a\u8fc7 Runner \u6267\u884c\n    eventChan, err := appRunner.Run(ctx, userID, sessionID, message)\n    if err != nil {\n        panic(err)\n    }\n\n    // \u5904\u7406\u4e8b\u4ef6\u6d41\n    for event := range eventChan {\n        if event.Error != nil {\n            fmt.Printf(\"\u9519\u8bef: %s\\n\", event.Error.Message)\n            continue\n        }\n\n        if len(event.Response.Choices) &gt; 0 {\n            choice := event.Response.Choices[0]\n            if choice.Delta.Content != \"\" {\n                fmt.Print(choice.Delta.Content)\n            }\n        }\n\n        // \u63a8\u8350\uff1a\u4f7f\u7528 Runner \u5b8c\u6210\u4e8b\u4ef6\u4f5c\u4e3a\u201c\u6d41\u7a0b\u7ed3\u675f\u201d\u7684\u4fe1\u53f7\u3002\n        if event.IsRunnerCompletion() {\n            break\n        }\n    }\n}\n\nconst (\n    stateKeyProcessedData = \"processed_data\"\n    stateKeyResult        = \"result\"\n)\n\n// \u8d77\u59cb\u8282\u70b9\u51fd\u6570\u5b9e\u73b0\nfunc startNodeFunc(ctx context.Context, state graph.State) (any, error) {\n    // \u4ece\u5185\u7f6e\u7684 StateKeyUserInput \u83b7\u53d6\u7528\u6237\u8f93\u5165\uff08\u7531 Runner \u81ea\u52a8\u8bbe\u7f6e\uff09\n    input := state[graph.StateKeyUserInput].(string)\n    return graph.State{\n        stateKeyProcessedData: fmt.Sprintf(\"\u5904\u7406\u540e\u7684: %s\", input),\n    }, nil\n}\n\n// \u5904\u7406\u8282\u70b9\u51fd\u6570\u5b9e\u73b0\nfunc processNodeFunc(ctx context.Context, state graph.State) (any, error) {\n    processed := state[stateKeyProcessedData].(string)\n    result := fmt.Sprintf(\"\u7ed3\u679c: %s\", processed)\n    return graph.State{\n        stateKeyResult:             result,\n        graph.StateKeyLastResponse: fmt.Sprintf(\"\u6700\u7ec8\u7ed3\u679c: %s\", result),\n    }, nil\n}\n</code></pre>"},{"location":"zh/graph/#2-llm","title":"2. \u4f7f\u7528 LLM \u8282\u70b9","text":"<p>LLM \u8282\u70b9\u5b9e\u73b0\u4e86\u56fa\u5b9a\u7684\u4e09\u6bb5\u5f0f\u8f93\u5165\u89c4\u5219\uff0c\u65e0\u9700\u914d\u7f6e\uff1a</p> <ol> <li>OneShot \u4f18\u5148\uff1a\u82e5\u5b58\u5728 <code>one_shot_messages</code>\uff0c\u4ee5\u5b83\u4e3a\u672c\u8f6e\u8f93\u5165\u3002</li> <li>UserInput \u5176\u6b21\uff1a\u5426\u5219\u82e5\u5b58\u5728 <code>user_input</code>\uff0c\u81ea\u52a8\u6301\u4e45\u5316\u4e00\u6b21\u3002</li> <li>\u5386\u53f2\u9ed8\u8ba4\uff1a\u5426\u5219\u4ee5\u6301\u4e45\u5316\u5386\u53f2\u4f5c\u4e3a\u8f93\u5165\u3002</li> </ol> <pre><code>// \u521b\u5efa LLM \u6a21\u578b\nmodel := openai.New(\"gpt-4\")\n\n// \u6dfb\u52a0 LLM \u8282\u70b9\nstateGraph.AddLLMNode(\"analyze\", model,\n    `\u4f60\u662f\u4e00\u4e2a\u6587\u6863\u5206\u6790\u4e13\u5bb6\u3002\u5206\u6790\u63d0\u4f9b\u7684\u6587\u6863\u5e76\uff1a\n1. \u5206\u7c7b\u6587\u6863\u7c7b\u578b\u548c\u590d\u6742\u5ea6\n2. \u63d0\u53d6\u5173\u952e\u4e3b\u9898\n3. \u8bc4\u4f30\u5185\u5bb9\u8d28\u91cf\n\u8bf7\u63d0\u4f9b\u7ed3\u6784\u5316\u7684\u5206\u6790\u7ed3\u679c\u3002`,\n    nil) // \u5de5\u5177\u6620\u5c04\n</code></pre> <p>\u91cd\u8981\u8bf4\u660e\uff1a</p> <ul> <li>SystemPrompt \u4ec5\u7528\u4e8e\u672c\u6b21\u8f93\u5165\uff0c\u4e0d\u843d\u6301\u4e45\u5316\u72b6\u6001\u3002</li> <li>\u4e00\u6b21\u6027\u952e\uff08<code>user_input</code>/<code>one_shot_messages</code>\uff09\u5728\u6210\u529f\u6267\u884c\u540e\u81ea\u52a8\u6e05\u7a7a\u3002</li> <li>\u6240\u6709\u72b6\u6001\u66f4\u65b0\u90fd\u662f\u539f\u5b50\u6027\u7684\uff0c\u786e\u4fdd\u4e00\u81f4\u6027\u3002</li> <li>GraphAgent/Runner \u4ec5\u8bbe\u7f6e <code>user_input</code>\uff0c\u4e0d\u518d\u9884\u5148\u628a\u7528\u6237\u6d88\u606f\u5199\u5165   <code>messages</code>\u3002\u8fd9\u6837\u53ef\u4ee5\u5141\u8bb8\u5728 LLM \u8282\u70b9\u4e4b\u524d\u7684\u4efb\u610f\u8282\u70b9\u5bf9 <code>user_input</code>   \u8fdb\u884c\u4fee\u6539\uff0c\u5e76\u80fd\u5728\u540c\u4e00\u8f6e\u751f\u6548\u3002</li> </ul>"},{"location":"zh/graph/#_9","title":"\u4e09\u79cd\u8f93\u5165\u8303\u5f0f","text":"<ul> <li> <p>OneShot\uff08<code>StateKeyOneShotMessages</code>\uff09\uff1a</p> <ul> <li>\u5f53\u8be5\u952e\u5b58\u5728\u65f6\uff0c\u672c\u8f6e\u4ec5\u4f7f\u7528\u8fd9\u91cc\u63d0\u4f9b\u7684 <code>[]model.Message</code> \u8c03\u7528\u6a21\u578b\uff0c   \u901a\u5e38\u5305\u542b\u5b8c\u6574\u7684 system prompt \u4e0e user prompt\u3002\u8c03\u7528\u540e\u81ea\u52a8\u6e05\u7a7a\u3002</li> <li>\u9002\u7528\u573a\u666f\uff1a\u524d\u7f6e\u8282\u70b9\u4e13\u95e8\u6784\u9020 prompt \u7684\u5de5\u4f5c\u6d41\uff0c\u9700\u5b8c\u5168\u8986\u76d6\u672c\u8f6e\u8f93\u5165\u3002</li> </ul> </li> </ul> <ul> <li> <p>UserInput\uff08<code>StateKeyUserInput</code>\uff09\uff1a</p> <ul> <li>\u5f53 <code>user_input</code> \u975e\u7a7a\u65f6\uff0cLLM \u8282\u70b9\u4f1a\u53d6\u6301\u4e45\u5316\u5386\u53f2 <code>messages</code>\uff0c\u5e76\u5c06   \u672c\u8f6e\u7684\u7528\u6237\u8f93\u5165\u5408\u5e76\u540e\u53d1\u8d77\u8c03\u7528\u3002\u7ed3\u675f\u540e\u4f1a\u628a\u7528\u6237\u8f93\u5165\u4e0e\u52a9\u624b\u56de\u590d\u901a\u8fc7   <code>MessageOp</code>\uff08\u4f8b\u5982 <code>AppendMessages</code>\u3001<code>ReplaceLastUser</code>\uff09\u539f\u5b50\u6027\u5199\u5165   \u5230 <code>messages</code>\uff0c\u5e76\u81ea\u52a8\u6e05\u7a7a <code>user_input</code> \u4ee5\u907f\u514d\u91cd\u590d\u8ffd\u52a0\u3002</li> <li>\u9002\u7528\u573a\u666f\uff1a\u666e\u901a\u5bf9\u8bdd\u5f0f\u5de5\u4f5c\u6d41\uff0c\u5141\u8bb8\u5728\u524d\u7f6e\u8282\u70b9\u52a8\u6001\u8c03\u6574\u7528\u6237\u8f93\u5165\u3002</li> </ul> </li> </ul> <ul> <li>Messages only\uff08\u4ec5 <code>StateKeyMessages</code>\uff09\uff1a<ul> <li>\u591a\u7528\u4e8e\u5de5\u5177\u8c03\u7528\u56de\u8def\u3002\u5f53\u7b2c\u4e00\u8f6e\u7ecf\u7531 <code>user_input</code> \u53d1\u8d77\u540e\uff0c\u8def\u7531\u5230\u5de5\u5177   \u8282\u70b9\u6267\u884c\uff0c\u518d\u56de\u5230 LLM \u8282\u70b9\u65f6\uff0c\u56e0\u4e3a <code>user_input</code> \u5df2\u88ab\u6e05\u7a7a\uff0cLLM \u5c06\u8d70   \u201cMessages only\u201d \u5206\u652f\uff0c\u4ee5\u5386\u53f2\u4e2d\u7684 tool \u54cd\u5e94\u7ee7\u7eed\u63a8\u7406\u3002</li> </ul> </li> </ul>"},{"location":"zh/graph/#llm","title":"LLM \u6307\u4ee4\u4e2d\u7684\u5360\u4f4d\u7b26","text":"<p>LLM \u8282\u70b9\u7684 <code>instruction</code> \u652f\u6301\u5360\u4f4d\u7b26\u6ce8\u5165\uff08\u4e0e LLMAgent \u89c4\u5219\u4e00\u81f4\uff09\u3002\u652f\u6301\u539f\u751f <code>{key}</code> \u4e0e Mustache <code>{{key}}</code> \u4e24\u79cd\u5199\u6cd5\uff08Mustache \u4f1a\u81ea\u52a8\u89c4\u6574\u4e3a\u539f\u751f\u5199\u6cd5\uff09\uff1a</p> <ul> <li><code>{key}</code> / <code>{{key}}</code> \u2192 \u66ff\u6362\u4e3a <code>session.State[\"key\"]</code></li> <li><code>{key?}</code> / <code>{{key?}}</code> \u2192 \u53ef\u9009\uff0c\u7f3a\u5931\u65f6\u66ff\u6362\u4e3a\u7a7a</li> <li><code>{user:subkey}</code>\u3001<code>{app:subkey}</code>\u3001<code>{temp:subkey}</code>\uff08\u4ee5\u53ca\u5176 Mustache \u5199\u6cd5\uff09\u2192 \u8bbf\u95ee\u7528\u6237/\u5e94\u7528/\u4e34\u65f6\u547d\u540d\u7a7a\u95f4\uff08SessionService \u4f1a\u5c06 app/user \u4f5c\u7528\u57df\u5408\u5e76\u5230 session\uff0c\u5e76\u5e26\u4e0a\u524d\u7f00\uff09</li> </ul> <p>\u8bf4\u660e\uff1a</p> <ul> <li>GraphAgent \u4f1a\u628a\u5f53\u524d <code>*session.Session</code> \u5199\u5165\u56fe\u72b6\u6001\u7684 <code>StateKeySession</code>\uff0cLLM \u8282\u70b9\u636e\u6b64\u8bfb\u53d6\u6ce8\u5165\u503c</li> <li>\u65e0\u524d\u7f00\u952e\uff08\u5982 <code>research_topics</code>\uff09\u9700\u8981\u76f4\u63a5\u5b58\u5728\u4e8e <code>session.State</code></li> </ul> <p>\u793a\u4f8b\uff1a</p> <pre><code>mdl := openai.New(modelName)\nstateGraph.AddLLMNode(\n  \"research\",\n  mdl,\n  \"You are a research assistant. Focus: {research_topics}. User: {user:topics?}. App: {app:banner?}.\",\n  nil,\n)\n</code></pre> <p>\u53ef\u53c2\u8003\u53ef\u8fd0\u884c\u793a\u4f8b\uff1a<code>examples/graph/placeholder</code>\u3002</p> <p>\u5c06\u68c0\u7d22\u7ed3\u679c\u4e0e\u7528\u6237\u8f93\u5165\u6ce8\u5165\u6307\u4ee4</p> <ul> <li>\u5728\u8fdb\u5165 LLM \u8282\u70b9\u524d\u7684\u4efb\u610f\u8282\u70b9\uff0c\u5c06\u4e34\u65f6\u503c\u5199\u5165\u4f1a\u8bdd\u7684 <code>temp:</code> \u547d\u540d\u7a7a\u95f4\uff0cLLM \u6307\u4ee4\u5373\u53ef\u7528\u5360\u4f4d\u7b26\u8bfb\u53d6\u3002</li> <li>\u793a\u4f8b\u6a21\u5f0f\uff1a</li> </ul> <pre><code>// \u5728 LLM \u8282\u70b9\u4e4b\u524d\nstateGraph.AddNode(\"retrieve\", func(ctx context.Context, s graph.State) (any, error) {\n    // \u5047\u8bbe\u4f60\u5df2\u7ecf\u5f97\u5230\u68c0\u7d22\u5185\u5bb9 retrieved\uff0c\u5e76\u5e0c\u671b\u8fde\u540c\u5f53\u524d\u7528\u6237\u8f93\u5165\u4e00\u8d77\u6ce8\u5165\n    retrieved := \"\u2022 \u6587\u6863A...\\n\u2022 \u6587\u6863B...\"\n    var input string\n    if v, ok := s[graph.StateKeyUserInput].(string); ok { input = v }\n    if sess, _ := s[graph.StateKeySession].(*session.Session); sess != nil {\n        if sess.State == nil { sess.State = make(session.StateMap) }\n        sess.State[session.StateTempPrefix+\"retrieved_context\"] = []byte(retrieved)\n        sess.State[session.StateTempPrefix+\"user_input\"] = []byte(input)\n    }\n    return graph.State{}, nil\n})\n\n// LLM \u8282\u70b9\u7684\u6307\u4ee4\u5f15\u7528 {temp:retrieved_context} \u548c {temp:user_input}\nstateGraph.AddLLMNode(\"answer\", mdl,\n    \"\u8bf7\u7ed3\u5408\u4e0a\u4e0b\u6587\u56de\u7b54\u3002\\n\\n\u4e0a\u4e0b\u6587\uff1a\\n{temp:retrieved_context}\\n\\n\u95ee\u9898\uff1a{temp:user_input}\",\n    nil)\n</code></pre> <p>\u793a\u4f8b\uff1a<code>examples/graph/retrieval_placeholder</code>\u3002</p> <p>\u5360\u4f4d\u7b26\u4e0e\u4f1a\u8bdd\u72b6\u6001\u7684\u6700\u4f73\u5b9e\u8df5</p> <ul> <li>\u77ed\u671f vs \u6301\u4e45\uff1a\u53ea\u7528\u4e8e\u672c\u8f6e\u63d0\u793a\u8bcd\u7ec4\u88c5\u7684\u6570\u636e\u5199\u5230 <code>session.State</code> \u7684 <code>temp:*</code>\uff1b\u9700\u8981\u8de8\u8f6e/\u8de8\u4f1a\u8bdd\u4fdd\u7559\u7684\u914d\u7f6e\uff0c\u8bf7\u901a\u8fc7 SessionService\uff08\u4f1a\u8bdd\u670d\u52a1\uff09\u66f4\u65b0 <code>user:*</code>/<code>app:*</code>\u3002</li> <li>\u4e3a\u4ec0\u4e48\u53ef\u4ee5\u76f4\u63a5\u5199\uff1aLLM \u8282\u70b9\u4ece\u56fe\u72b6\u6001\u91cc\u7684\u4f1a\u8bdd\u5bf9\u8c61\u8bfb\u53d6\u5e76\u5c55\u5f00\u5360\u4f4d\u7b26\uff0c\u89c1 graph/state_graph.go\uff1bGraphAgent \u5728\u542f\u52a8\u65f6\u628a\u4f1a\u8bdd\u5bf9\u8c61\u653e\u5165\u56fe\u72b6\u6001\uff0c\u89c1 agent/graphagent/graph_agent.go\u3002</li> <li>\u670d\u52a1\u4fa7\u62a4\u680f\uff1a\u5185\u5b58\u5b9e\u73b0\u7981\u6b62\u901a\u8fc7\u201c\u66f4\u65b0\u7528\u6237\u6001\u201d\u7684\u63a5\u53e3\u5199 <code>temp:*</code>\uff08\u4ee5\u53ca <code>app:*</code> via user updater\uff09\uff0c\u89c1 session/inmemory/service.go\u3002</li> <li>\u5e76\u53d1\u5efa\u8bae\uff1a\u5e76\u884c\u5206\u652f\u4e0d\u8981\u540c\u65f6\u6539\u540c\u4e00\u6279 <code>session.State</code> \u952e\uff1b\u5efa\u8bae\u6c47\u603b\u5230\u5355\u8282\u70b9\u5408\u5e76\u540e\u4e00\u6b21\u5199\u5165\uff0c\u6216\u5148\u653e\u56fe\u72b6\u6001\u518d\u4e00\u6b21\u5199\u5230 <code>temp:*</code>\u3002</li> <li>\u53ef\u89c2\u6d4b\u6027\uff1a\u82e5\u5e0c\u671b\u5728\u5b8c\u6210\u4e8b\u4ef6\u4e2d\u770b\u5230\u6458\u8981\uff0c\u53ef\u989d\u5916\u628a\u7cbe\u7b80\u4fe1\u606f\u653e\u5165\u56fe\u72b6\u6001\uff08\u5982 <code>metadata</code>\uff09\uff1b\u6700\u7ec8\u4e8b\u4ef6\u4f1a\u5e8f\u5217\u5316\u975e\u5185\u90e8\u7684\u6700\u7ec8\u72b6\u6001\uff0c\u89c1 graph/events.go\u3002</li> </ul>"},{"location":"zh/graph/#reducer-messageop","title":"\u901a\u8fc7 Reducer \u4e0e MessageOp \u5b9e\u73b0\u7684\u539f\u5b50\u66f4\u65b0","text":"<p>Graph \u5305\u7684\u6d88\u606f\u72b6\u6001\u652f\u6301 <code>MessageOp</code> \u8865\u4e01\u64cd\u4f5c\uff08\u5982 <code>ReplaceLastUser</code>\u3001 <code>AppendMessages</code> \u7b49\uff09\uff0c\u7531 <code>MessageReducer</code> \u5b9e\u73b0\u539f\u5b50\u5408\u5e76\u3002\u8fd9\u5e26\u6765\u4e24\u4e2a \u76f4\u63a5\u6536\u76ca\uff1a</p> <ul> <li>\u5141\u8bb8\u5728 LLM \u8282\u70b9\u4e4b\u524d\u4fee\u6539 <code>user_input</code>\uff0cLLM \u8282\u70b9\u4f1a\u636e\u6b64\u5728\u4e00\u6b21\u8fd4\u56de\u4e2d\u5c06   \u9700\u8981\u7684\u64cd\u4f5c\uff08\u4f8b\u5982\u66ff\u6362\u6700\u540e\u4e00\u6761\u7528\u6237\u6d88\u606f\u3001\u8ffd\u52a0\u52a9\u624b\u6d88\u606f\uff09\u4ee5\u8865\u4e01\u5f62\u5f0f\u8fd4\u56de\uff0c   \u6267\u884c\u5668\u4e00\u6b21\u6027\u843d\u5e93\uff0c\u907f\u514d\u7ade\u6001\u4e0e\u91cd\u590d\u3002`</li> <li>\u517c\u5bb9\u4f20\u7edf\u7684\u76f4\u63a5 <code>[]Message</code> \u8ffd\u52a0\u7528\u6cd5\uff0c\u540c\u65f6\u4e3a\u590d\u6742\u66f4\u65b0\u63d0\u4f9b\u66f4\u9ad8\u7684\u8868\u8fbe\u529b\u3002</li> </ul> <p>\u793a\u4f8b\uff1a\u5728\u524d\u7f6e\u8282\u70b9\u4fee\u6539 <code>user_input</code>\uff0c\u968f\u540e\u8fdb\u5165 LLM \u8282\u70b9\u3002</p> <pre><code>stateGraph.\n    AddNode(\"prepare_input\", func(ctx context.Context, s graph.State) (any, error) {\n        // \u6e05\u6d17/\u6539\u5199\u7528\u6237\u8f93\u5165\uff0c\u4f7f\u5176\u5728\u672c\u8f6e LLM \u4e2d\u751f\u6548\u3002\n        cleaned := strings.TrimSpace(s[graph.StateKeyUserInput].(string))\n        return graph.State{graph.StateKeyUserInput: cleaned}, nil\n    }).\n    AddLLMNode(\"ask\", modelInstance,\n        \"\u4f60\u662f\u4e00\u4e2a\u6709\u5e2e\u52a9\u7684\u52a9\u624b\u3002\u8bf7\u7b80\u6d01\u56de\u7b54\u3002\",\n        nil).\n    SetEntryPoint(\"prepare_input\").\n    SetFinishPoint(\"ask\")\n</code></pre>"},{"location":"zh/graph/#removeallmessages","title":"\u4f7f\u7528 RemoveAllMessages \u6e05\u9664\u6d88\u606f\u5386\u53f2","text":"<p>\u5f53\u591a\u4e2a LLM \u8282\u70b9\u4e32\u8054\u65f6\uff0c<code>MessageReducer</code> \u4f1a\u7d2f\u79ef\u6d88\u606f\u3002\u5982\u679c\u6bcf\u4e2a LLM \u8282\u70b9 \u9700\u8981\u72ec\u7acb\u7684\u6d88\u606f\u4e0a\u4e0b\u6587\uff08\u4e0d\u7ee7\u627f\u524d\u5e8f\u8282\u70b9\u7684\u5bf9\u8bdd\u5386\u53f2\uff09\uff0c\u53ef\u4ee5\u4f7f\u7528 <code>RemoveAllMessages</code> \u64cd\u4f5c\u6e05\u9664\u4e4b\u524d\u7684\u6d88\u606f\uff1a</p> <pre><code>// \u5728\u51c6\u5907 prompt \u7684\u8282\u70b9\u4e2d\uff0c\u5148\u6e05\u9664\u6d88\u606f\u518d\u8bbe\u7f6e\u65b0\u7684 UserInput.\nfunc preparePromptNode(ctx context.Context, state graph.State) (any, error) {\n    userMessage := buildUserMessage(...)\n    return graph.State{\n        // \u5173\u952e\uff1a\u5148\u6e05\u9664\u4e4b\u524d\u7684\u6d88\u606f\uff0c\u907f\u514d\u7d2f\u79ef.\n        graph.StateKeyMessages:  graph.RemoveAllMessages{},\n        graph.StateKeyUserInput: userMessage,\n    }, nil\n}\n</code></pre> <p>\u9002\u7528\u573a\u666f\uff1a</p> <ul> <li>\u540c\u4e00\u4e2a Graph \u5185\u6709\u591a\u4e2a\u72ec\u7acb\u7684 LLM \u8282\u70b9\uff0c\u6bcf\u4e2a\u8282\u70b9\u4e0d\u9700\u8981\u524d\u5e8f\u8282\u70b9\u7684\u5bf9\u8bdd\u5386\u53f2</li> <li>\u5faa\u73af\u7ed3\u6784\u4e2d\uff0c\u6bcf\u6b21\u8fed\u4ee3\u9700\u8981\u5168\u65b0\u7684\u6d88\u606f\u4e0a\u4e0b\u6587</li> <li>\u9700\u8981\u5b8c\u5168\u91cd\u5efa\u6d88\u606f\u5217\u8868\u7684\u573a\u666f</li> </ul> <p>\u6ce8\u610f\uff1a</p> <ul> <li><code>RemoveAllMessages{}</code> \u662f\u4e00\u4e2a\u7279\u6b8a\u7684 <code>MessageOp</code>\uff0c<code>MessageReducer</code> \u4f1a   \u8bc6\u522b\u5b83\u5e76\u6e05\u7a7a\u6d88\u606f\u5217\u8868</li> <li>\u5fc5\u987b\u5728\u8bbe\u7f6e <code>StateKeyUserInput</code> \u4e4b\u524d\u5148\u8bbe\u7f6e <code>RemoveAllMessages{}</code></li> <li><code>WithSubgraphIsolatedMessages(true)</code> \u53ea\u5bf9 <code>AddSubgraphNode</code> \u6709\u6548\uff0c   \u5bf9 <code>AddLLMNode</code> \u65e0\u6548\uff1b\u5982\u9700\u5728 LLM \u8282\u70b9\u95f4\u9694\u79bb\u6d88\u606f\uff0c\u8bf7\u4f7f\u7528   <code>RemoveAllMessages</code></li> </ul>"},{"location":"zh/graph/#3-graphagent","title":"3. GraphAgent \u914d\u7f6e\u9009\u9879","text":"<p>GraphAgent \u652f\u6301\u591a\u79cd\u914d\u7f6e\u9009\u9879\uff1a</p> <pre><code>// \u521b\u5efa GraphAgent \u65f6\u53ef\u4ee5\u4f7f\u7528\u591a\u79cd\u9009\u9879\ngraphAgent, err := graphagent.New(\n    \"workflow-name\",\n    compiledGraph,\n    graphagent.WithDescription(\"\u5de5\u4f5c\u6d41\u63cf\u8ff0\"),\n    graphagent.WithInitialState(graph.State{\n        \"initial_data\": \"\u521d\u59cb\u6570\u636e\",\n    }),\n    graphagent.WithChannelBufferSize(1024),            // \u8c03\u6574\u4e8b\u4ef6\u901a\u9053\u7f13\u51b2\u533a\n    graphagent.WithCheckpointSaver(memorySaver),       // \u4f7f\u7528\u6301\u4e45\u5316\u68c0\u67e5\u70b9\n    graphagent.WithSubAgents([]agent.Agent{subAgent}), // \u914d\u7f6e\u5b50 Agent\n    graphagent.WithAddSessionSummary(true),            // \u5c06\u4f1a\u8bdd\u6458\u8981\u6ce8\u5165 system \u6d88\u606f\n    graphagent.WithMaxHistoryRuns(5),                  // \u672a\u5f00\u542f\u6458\u8981\u65f6\u622a\u65ad\u5386\u53f2\u8f6e\u6b21\n    // \u8bbe\u7f6e\u4f20\u7ed9\u6a21\u578b\u7684\u6d88\u606f\u8fc7\u6ee4\u6a21\u5f0f\uff0c\u6700\u7ec8\u4f20\u7ed9\u6a21\u578b\u7684\u6d88\u606f\u9700\u540c\u65f6\u6ee1\u8db3WithMessageTimelineFilterMode\u4e0eWithMessageBranchFilterMode\u6761\u4ef6\n    // \u65f6\u95f4\u7ef4\u5ea6\u8fc7\u6ee4\u6761\u4ef6\n    // \u9ed8\u8ba4\u503c: graphagent.TimelineFilterAll\n    // \u53ef\u9009\u503c:\n    //  - graphagent.TimelineFilterAll: \u5305\u542b\u5386\u53f2\u6d88\u606f\u4ee5\u53ca\u5f53\u524d\u8bf7\u6c42\u4e2d\u6240\u751f\u6210\u7684\u6d88\u606f\n    //  - graphagent.TimelineFilterCurrentRequest: \u4ec5\u5305\u542b\u5f53\u524d\u8bf7\u6c42\u4e2d\u6240\u751f\u6210\u7684\u6d88\u606f\n    //  - graphagent.TimelineFilterCurrentInvocation: \u4ec5\u5305\u542b\u5f53\u524dinvocation\u4e0a\u4e0b\u6587\u4e2d\u751f\u6210\u7684\u6d88\u606f\n    graphagent.WithMessageTimelineFilterMode(graphagent.BranchFilterModeAll),\n    // \u5206\u652f\u7ef4\u5ea6\u8fc7\u6ee4\u6761\u4ef6\n    // \u9ed8\u8ba4\u503c: graphagent.BranchFilterModePrefix\n    // \u53ef\u9009\u503c:\n    //  - graphagent.BranchFilterModeAll: \u5305\u542b\u6240\u6709agent\u7684\u6d88\u606f, \u5f53\u524dagent\u4e0e\u6a21\u578b\u4ea4\u4e92\u65f6,\u5982\u9700\u5c06\u6240\u6709agent\u751f\u6210\u7684\u6709\u6548\u5185\u5bb9\u6d88\u606f\u540c\u6b65\u7ed9\u6a21\u578b\u65f6\u53ef\u8bbe\u7f6e\u8be5\u503c\n    //  - graphagent.BranchFilterModePrefix: \u901a\u8fc7Event.FilterKey\u4e0eInvocation.eventFilterKey\u505a\u524d\u7f00\u5339\u914d\u8fc7\u6ee4\u6d88\u606f, \u671f\u671b\u5c06\u4e0e\u5f53\u524dagent\u4ee5\u53ca\u76f8\u5173\u4e0a\u4e0b\u6e38agent\u751f\u6210\u7684\u6d88\u606f\u4f20\u9012\u7ed9\u6a21\u578b\u65f6\uff0c\u53ef\u8bbe\u7f6e\u8be5\u503c\n    //  - graphagent.BranchFilterModeExact: \u901a\u8fc7Event.FilterKey==Invocation.eventFilterKey\u8fc7\u6ee4\u6d88\u606f\uff0c\u5f53\u524dagent\u4e0e\u6a21\u578b\u4ea4\u4e92\u65f6,\u4ec5\u9700\u4f7f\u7528\u5f53\u524dagent\u751f\u6210\u7684\u6d88\u606f\u65f6\u53ef\u8bbe\u7f6e\u8be5\u503c\n    graphagent.WithMessageBranchFilterMode(graphagent.TimelineFilterAll),\n    // \u63a8\u7406\u5185\u5bb9\u6a21\u5f0f\uff08DeepSeek \u601d\u8003\u6a21\u5f0f\uff09\n    // \u9ed8\u8ba4\u503c: graphagent.ReasoningContentModeDiscardPreviousTurns\n    // \u53ef\u9009\u503c:\n    //  - graphagent.ReasoningContentModeDiscardPreviousTurns: \u4e22\u5f03\u4e4b\u524d\u8bf7\u6c42\u8f6e\u6b21\u7684\n    //    reasoning_content\uff08\u9ed8\u8ba4\uff0c\u63a8\u8350\uff09\n    //  - graphagent.ReasoningContentModeKeepAll: \u4fdd\u7559\u6240\u6709 reasoning_content\n    //  - graphagent.ReasoningContentModeDiscardAll: \u4e22\u5f03\u6240\u6709 reasoning_content\n    graphagent.WithReasoningContentMode(graphagent.ReasoningContentModeDiscardPreviousTurns),\n    graphagent.WithAgentCallbacks(&amp;agent.Callbacks{\n        // Agent \u7ea7\u56de\u8c03\u914d\u7f6e\n    }),\n)\n</code></pre> <p>\u6a21\u578b/\u5de5\u5177\u56de\u8c03\u9700\u8981\u5728\u8282\u70b9\u7ea7\u914d\u7f6e\uff0c\u4f8b\u5982 <code>AddLLMNode(..., graph.WithModelCallbacks(...))</code> \u6216 <code>AddToolsNode(..., graph.WithToolCallbacks(...))</code>\u3002</p> <p>\u4f7f\u7528\u4f1a\u8bdd\u6458\u8981\u7684\u6ce8\u610f\u4e8b\u9879\uff1a</p> <ul> <li><code>WithAddSessionSummary(true)</code> \u4ec5\u5728 <code>Session.Summaries</code> \u4e2d\u5df2\u6709\u5bf9\u5e94 <code>FilterKey</code> \u7684\u6458\u8981\u65f6\u751f\u6548\u3002\u6458\u8981\u901a\u5e38\u7531 SessionService + SessionSummarizer \u751f\u6210\uff0cRunner \u5728\u843d\u5e93\u4e8b\u4ef6\u540e\u4f1a\u81ea\u52a8\u89e6\u53d1 <code>EnqueueSummaryJob</code>\u3002</li> <li>GraphAgent \u53ea\u8bfb\u53d6\u6458\u8981\uff0c\u4e0d\u751f\u6210\u6458\u8981\u3002\u5982\u679c\u7ed5\u8fc7 Runner\uff0c\u9700\u5728\u5199\u5165\u4e8b\u4ef6\u540e\u81ea\u884c\u8c03\u7528 <code>sessionService.CreateSessionSummary</code> \u6216 <code>EnqueueSummaryJob</code>\u3002</li> <li>\u6458\u8981\u4ec5\u5728 <code>TimelineFilterAll</code> \u4e0b\u751f\u6548\u3002</li> </ul>"},{"location":"zh/graph/#_10","title":"\u5e76\u53d1\u4f7f\u7528\u6ce8\u610f\u4e8b\u9879","text":"<p>\u5728\u670d\u52a1\u7aef\u5c06 Graph + GraphAgent \u90e8\u7f72\u4e3a\u957f\u671f\u8fd0\u884c\u3001\u53ef\u5e76\u53d1\u590d\u7528\u7684\u7ec4\u4ef6\u65f6\uff08\u4f8b\u5982\u5355\u4e2a\u8fdb\u7a0b\u5185\u540c\u65f6\u5904\u7406\u591a\u8def\u8bf7\u6c42\uff09\uff0c\u9700\u8981\u6ce8\u610f\u4ee5\u4e0b\u51e0\u70b9\uff1a</p> <ul> <li>\u81ea\u5b9a\u4e49 CheckpointSaver / Cache \u5fc5\u987b\u5177\u5907\u5e76\u53d1\u5b89\u5168\u80fd\u529b <code>CheckpointSaver</code> \u4e0e <code>Cache</code> \u63a5\u53e3\u672c\u8eab\u662f\u5b58\u50a8\u65e0\u5173\u3001\u7ebf\u7a0b\u65e0\u72b6\u6001\u7684\u62bd\u8c61\uff0c\u540c\u4e00\u4e2a <code>Executor</code> / <code>GraphAgent</code> \u5b9e\u4f8b\u5728\u5e76\u53d1\u6267\u884c\u591a\u6b21\u65f6\uff0c\u4f1a\u4ece\u591a\u4e2a goroutine \u8c03\u7528\u5b83\u4eec\u7684\u65b9\u6cd5\u3002\u5982\u679c\u4f60\u63d0\u4f9b\u81ea\u5b9a\u4e49\u5b9e\u73b0\uff0c\u9700\u8981\u786e\u4fdd\uff1a<ul> <li><code>CheckpointSaver</code> \u7684 <code>Get</code> / <code>GetTuple</code> / <code>List</code> / <code>Put</code> / <code>PutWrites</code> / <code>PutFull</code> / <code>DeleteLineage</code> \u7b49\u65b9\u6cd5\u5728\u5e76\u53d1\u573a\u666f\u4e0b\u662f\u5b89\u5168\u7684\uff1b</li> <li><code>Cache</code> \u7684 <code>Get</code> / <code>Set</code> / <code>Clear</code> \u7b49\u65b9\u6cd5\u5728\u5e76\u53d1\u573a\u666f\u4e0b\u662f\u5b89\u5168\u7684\uff1b</li> <li>\u5185\u90e8\u4f7f\u7528\u7684 map\u3001\u8fde\u63a5\u6c60\u3001\u5185\u5b58\u7f13\u51b2\u533a\u7b49\u90fd\u7ecf\u8fc7\u9002\u5f53\u52a0\u9501\u6216\u4f7f\u7528\u5176\u5b83\u5e76\u53d1\u539f\u8bed\u4fdd\u62a4\u3002</li> </ul> </li> </ul> <ul> <li>NodeFunc / \u5de5\u5177 / \u56de\u8c03\u5e94\u628a\u4f20\u5165\u72b6\u6001\u89c6\u4e3a\u201c\u672c\u6b21\u8c03\u7528\u672c\u8282\u70b9\u7684\u5c40\u90e8\u6570\u636e\u201d   \u6bcf\u4e2a\u8282\u70b9\u5728\u6267\u884c\u65f6\u4f1a\u62ff\u5230\u4e00\u4efd\u9488\u5bf9\u5f53\u524d\u4efb\u52a1\u7684\u72b6\u6001\u526f\u672c\uff0c\u8fd9\u4efd\u526f\u672c\u5728\u5f53\u524d goroutine \u5185\u4fee\u6539\u662f\u5b89\u5168\u7684\uff0c\u4f46\u662f\u4e0d\u5efa\u8bae\uff1a<ul> <li>\u5c06\u8be5\u526f\u672c\uff08\u6216\u5176\u4e2d\u7684 map / slice\uff09\u4fdd\u5b58\u5230\u5168\u5c40\u53d8\u91cf\uff0c\u518d\u7531\u5176\u5b83 goroutine \u540e\u7eed\u4fee\u6539\uff1b</li> <li>\u4ece\u72b6\u6001\u4e2d\u53d6\u51fa <code>StateKeyExecContext</code>\uff08<code>*graph.ExecutionContext</code>\uff09\u540e\uff0c\u7ed5\u8fc7\u5185\u90e8\u9501\u76f4\u63a5\u8bfb\u5199 <code>execCtx.State</code> \u6216 <code>execCtx.pendingTasks</code> \u7b49\u5b57\u6bb5\u3002 \u5982\u679c\u786e\u5b9e\u9700\u8981\u8de8\u8282\u70b9\u6216\u8de8\u8c03\u7528\u5171\u4eab\u53ef\u53d8\u6570\u636e\uff0c\u8bf7\u4f7f\u7528\u4f60\u81ea\u5df1\u7684\u540c\u6b65\u624b\u6bb5\uff08\u4f8b\u5982 <code>sync.Mutex</code> / <code>sync.RWMutex</code>\uff09\uff0c\u6216\u8005\u4f7f\u7528\u5916\u90e8\u670d\u52a1\uff08\u6570\u636e\u5e93\u3001\u7f13\u5b58\u7b49\uff09\u627f\u8f7d\u5171\u4eab\u72b6\u6001\u3002</li> </ul> </li> </ul> <ul> <li>\u4e0d\u8981\u5728\u591a\u4e2a goroutine \u4e2d\u590d\u7528\u540c\u4e00\u4e2a *agent.Invocation   \u6846\u67b6\u8bbe\u8ba1\u5047\u5b9a\u6bcf\u6b21\u8c03\u7528 <code>Run</code>\uff08\u65e0\u8bba\u662f GraphAgent\u3001Runner \u8fd8\u662f\u5176\u5b83 Agent \u5b9e\u73b0\uff09\u90fd\u4f7f\u7528\u72ec\u7acb\u7684 <code>*agent.Invocation</code> \u5b9e\u4f8b\u3002\u5982\u679c\u5728\u591a\u4e2a goroutine \u4e2d\u590d\u7528\u540c\u4e00\u4e2a <code>*agent.Invocation</code> \u5e76\u5e76\u884c\u8c03\u7528 <code>Run</code>\uff0c\u4f1a\u5728 <code>Branch</code>\u3001<code>RunOptions</code>\u3001\u56de\u8c03\u72b6\u6001\u7b49\u5b57\u6bb5\u4e0a\u4ea7\u751f\u6570\u636e\u7ade\u4e89\u3002\u63a8\u8350\u7684\u505a\u6cd5\u662f\uff1a<ul> <li>\u6bcf\u4e2a\u8bf7\u6c42\u6784\u9020\u4e00\u4efd\u65b0\u7684 <code>*agent.Invocation</code>\uff0c\u6216\u8005</li> <li>\u5728\u9700\u8981\u4fdd\u6301\u5173\u8054\u65f6\u4f7f\u7528 <code>invocation.Clone(...)</code> \u4ece\u7236\u8c03\u7528\u4e0a\u514b\u9686\u4e00\u4efd\u65b0\u7684 Invocation\u3002</li> </ul> </li> </ul> <ul> <li>\u5e76\u884c\u5de5\u5177\u8c03\u7528\u8981\u6c42\u5177\u4f53\u5de5\u5177\u5b9e\u73b0\u672c\u8eab\u652f\u6301\u5e76\u53d1   \u5f53\u67d0\u4e2a Tools \u8282\u70b9\u4f7f\u7528 <code>WithEnableParallelTools(true)</code> \u914d\u7f6e\u4e3a\u201c\u5e76\u884c\u5de5\u5177\u6267\u884c\u201d\u65f6\uff0c\u5728\u540c\u4e00\u8f6e step \u5185\u8be5\u8282\u70b9\u4f1a\u4e3a\u6bcf\u4e2a\u5de5\u5177\u8c03\u7528\u8d77\u4e00\u4e2a goroutine \u5e76\u884c\u6267\u884c\uff1a<ul> <li>\u6846\u67b6\u4fdd\u8bc1 <code>tools</code> \u6620\u5c04\u5728\u6267\u884c\u671f\u95f4\u53ea\u8bfb\u8bbf\u95ee\uff1b</li> <li>\u6846\u67b6\u4e5f\u4fdd\u8bc1\u4f20\u5165\u5de5\u5177\u7684\u56fe\u72b6\u6001\u5728\u5de5\u5177\u5185\u90e8\u53ea\u8bfb\u4f7f\u7528\uff0c\u72b6\u6001\u66f4\u65b0\u7531\u8282\u70b9\u8fd4\u56de\u7684 <code>State</code> \u5408\u5e76\u5b8c\u6210\u3002 \u4f46\u6bcf\u4e2a\u5177\u4f53\u7684 <code>tool.Tool</code> \u5b9e\u73b0\u4ee5\u53ca\u5bf9\u5e94\u7684 <code>tool.Callbacks</code> \u53ef\u80fd\u4f1a\u88ab\u591a\u4e2a goroutine \u540c\u65f6\u8c03\u7528\uff0c\u56e0\u6b64\u9700\u8981\u786e\u4fdd\uff1a</li> <li>\u5de5\u5177\u5b9e\u73b0\u4e0d\u4f1a\u5728\u6ca1\u6709\u52a0\u9501\u7684\u60c5\u51b5\u4e0b\u4fee\u6539\u5171\u4eab\u7684\u5168\u5c40\u53d8\u91cf\u6216\u5171\u4eab\u6570\u636e\u7ed3\u6784\uff1b</li> <li>\u5de5\u5177\u5185\u90e8\u4f7f\u7528\u7684\u7f13\u5b58\u3001HTTP \u5ba2\u6237\u7aef\u3001\u8fde\u63a5\u6c60\u7b49\u7ec4\u4ef6\u672c\u8eab\u652f\u6301\u5e76\u53d1\u8bbf\u95ee\u3002</li> </ul> </li> </ul> <p>\u8fd9\u4e9b\u7ea6\u675f\u5728\u5355\u8fdb\u7a0b\u591a\u8bf7\u6c42\u7684\u9ad8\u5e76\u53d1\u573a\u666f\u4e0b\u5c24\u4e3a\u91cd\u8981\uff0c\u53ef\u4ee5\u5e2e\u52a9\u4f60\u5b89\u5168\u5730\u590d\u7528\u540c\u4e00\u4e2a <code>Graph</code> / <code>Executor</code> / <code>GraphAgent</code> \u5b9e\u4f8b\u3002</p> <p>\u914d\u7f6e\u4e86\u5b50 Agent \u540e\uff0c\u53ef\u4ee5\u5728\u56fe\u4e2d\u4f7f\u7528 Agent \u8282\u70b9\u59d4\u6258\u6267\u884c\uff1a</p> <pre><code>// \u5047\u8bbe subAgent.Info().Name == \"assistant\"\nstateGraph.AddAgentNode(\"assistant\",\n    graph.WithName(\"\u5b50 Agent \u8c03\u5ea6\"),\n    graph.WithDescription(\"\u8c03\u7528\u9884\u5148\u6ce8\u518c\u7684 assistant Agent\"),\n)\n\n// \u6267\u884c\u65f6 GraphAgent \u4f1a\u5728\u81ea\u8eab\u7684 SubAgents \u4e2d\u67e5\u627e\u540c\u540d Agent \u5e76\u53d1\u8d77\u8c03\u7528\n</code></pre> <p>Agent \u8282\u70b9\u4f1a\u4ee5\u8282\u70b9 ID \u4f5c\u4e3a\u67e5\u627e\u952e\uff0c\u56e0\u6b64\u9700\u786e\u4fdd <code>AddAgentNode(\"assistant\")</code> \u4e0e <code>subAgent.Info().Name == \"assistant\"</code> \u4e00\u81f4\u3002</p>"},{"location":"zh/graph/#4","title":"4. \u6761\u4ef6\u8def\u7531","text":"<pre><code>// \u5b9a\u4e49\u6761\u4ef6\u51fd\u6570\nfunc complexityCondition(ctx context.Context, state graph.State) (string, error) {\n    complexity := state[\"complexity\"].(string)\n    if complexity == \"simple\" {\n        return \"simple_process\", nil\n    }\n    return \"complex_process\", nil\n}\n\n// \u6dfb\u52a0\u6761\u4ef6\u8fb9\nstateGraph.AddConditionalEdges(\"analyze\", complexityCondition, map[string]string{\n    \"simple_process\":  \"simple_node\",\n    \"complex_process\": \"complex_node\",\n})\n</code></pre>"},{"location":"zh/graph/#41-ends","title":"4.1 \u8282\u70b9\u547d\u540d\u5206\u652f\uff08Ends\uff09","text":"<p>\u5f53\u4e00\u4e2a\u8282\u70b9\u9700\u8981\u628a\u201c\u4e1a\u52a1\u7ed3\u8bba\u201d\uff08\u4f8b\u5982 <code>approve</code>/<code>reject</code>/<code>manual_review</code>\uff09\u8def\u7531\u5230\u5177\u4f53\u7684\u4e0b\u6e38\u8282\u70b9\u65f6\uff0c\u5efa\u8bae\u5728\u8be5\u8282\u70b9\u4e0a\u58f0\u660e\u547d\u540d\u5206\u652f\uff08Ends\uff09\u3002</p> <p>\u4f5c\u7528\u4e0e\u4f18\u52bf\uff1a</p> <ul> <li>\u5728\u8282\u70b9\u672c\u5730\u96c6\u4e2d\u58f0\u660e\u201c\u7b26\u53f7\u540d \u2192 \u5177\u4f53\u76ee\u6807\u201d\u7684\u6620\u5c04\uff0c\u66f4\u76f4\u89c2\u3001\u66f4\u6613\u91cd\u6784\uff1b</li> <li>\u7f16\u8bd1\u671f\u6821\u9a8c\uff1a<code>Compile()</code> \u4f1a\u68c0\u67e5\u6620\u5c04\u4e2d\u7684\u76ee\u6807\u662f\u5426\u5b58\u5728\uff08\u6216\u4e3a\u5e38\u91cf <code>graph.End</code>\uff09\uff1b</li> <li>\u8def\u7531\u7edf\u4e00\uff1a\u547d\u4ee4\u5f0f\u8def\u7531\uff08<code>Command.GoTo</code>\uff09\u4e0e\u6761\u4ef6\u8def\u7531\u90fd\u53ef\u590d\u7528\u540c\u4e00\u4efd\u6620\u5c04\uff1b</li> <li>\u89e3\u8026\uff1a\u8282\u70b9\u8fd4\u56de\u4e1a\u52a1\u8bed\u4e49\uff08\u4f8b\u5982 <code>GoTo:\"approve\"</code>\uff09\uff0c\u6620\u5c04\u8d1f\u8d23\u843d\u5730\u5230\u56fe\u7ed3\u6784\u3002</li> </ul> <p>API\uff1a</p> <pre><code>// \u5728\u8282\u70b9\u4e0a\u58f0\u660e Ends\uff08\u7b26\u53f7\u540d\u5230\u5177\u4f53\u76ee\u6807\uff09\nsg.AddNode(\"decision\", decideNode,\n    graph.WithEndsMap(map[string]string{\n        \"approve\": \"approved\",\n        \"reject\":  \"rejected\",\n        // \u4e5f\u53ef\u4ee5\u628a\u67d0\u4e2a\u7b26\u53f7\u6620\u5c04\u5230\u7ec8\u70b9\n        // \"drop\":  graph.End,\n    }),\n)\n\n// \u7b80\u5199\uff1a\u7b26\u53f7\u540d\u4e0e\u76ee\u6807\u8282\u70b9\u540d\u76f8\u540c\u7684\u60c5\u51b5\nsg.AddNode(\"router\", routerNode, graph.WithEnds(\"nodeB\", \"nodeC\"))\n</code></pre> <p>\u547d\u4ee4\u5f0f\u8def\u7531\uff08Command.GoTo\uff09\uff1a</p> <pre><code>func decideNode(ctx context.Context, s graph.State) (any, error) {\n    switch s[\"decision\"].(string) {\n    case \"approve\":\n        return &amp;graph.Command{GoTo: \"approve\"}, nil // \u7b26\u53f7\u540d\n    case \"reject\":\n        return &amp;graph.Command{GoTo: \"reject\"}, nil\n    default:\n        return &amp;graph.Command{GoTo: \"reject\"}, nil\n    }\n}\n</code></pre> <p>\u6761\u4ef6\u8def\u7531\u590d\u7528 Ends\uff1a\u5f53 <code>AddConditionalEdges(from, condition, pathMap)</code> \u7684 <code>pathMap</code> \u4e3a <code>nil</code> \u6216\u672a\u5339\u914d\u5230\u952e\u65f6\uff0c\u6267\u884c\u5668\u4f1a\u7ee7\u7eed\u4f7f\u7528\u8be5\u8282\u70b9\u7684 Ends \u89e3\u6790\u8fd4\u56de\u503c\uff1b\u82e5\u4ecd\u672a\u5339\u914d\uff0c\u5219\u628a\u8fd4\u56de\u503c\u5f53\u4f5c\u5177\u4f53\u8282\u70b9 ID\u3002</p> <p>\u89e3\u6790\u4f18\u5148\u7ea7\uff1a</p> <ol> <li>\u6761\u4ef6\u8fb9 <code>pathMap</code> \u7684\u663e\u5f0f\u6620\u5c04\uff1b</li> <li>\u5f53\u524d\u8282\u70b9\u7684 Ends \u6620\u5c04\uff08\u7b26\u53f7\u540d \u2192 \u5177\u4f53\u76ee\u6807\uff09\uff1b</li> <li>\u76f4\u63a5\u628a\u8fd4\u56de\u503c\u5f53\u4f5c\u8282\u70b9 ID\u3002</li> </ol> <p>\u7f16\u8bd1\u671f\u6821\u9a8c\uff1a</p> <ul> <li><code>WithEndsMap/WithEnds</code> \u4e2d\u58f0\u660e\u7684\u76ee\u6807\u4f1a\u5728 <code>Compile()</code> \u9636\u6bb5\u6821\u9a8c\uff1b</li> <li>\u76ee\u6807\u5fc5\u987b\u5b58\u5728\u4e8e\u56fe\u4e2d\u6216\u4e3a\u7279\u6b8a\u5e38\u91cf <code>graph.End</code>\u3002</li> </ul> <p>\u6ce8\u610f\uff1a</p> <ul> <li>\u8bf7\u4f7f\u7528\u5e38\u91cf <code>graph.End</code> \u8868\u793a\u201c\u7ec8\u70b9\u201d\uff0c\u4e0d\u8981\u4f7f\u7528\u5b57\u7b26\u4e32 \"END\"\uff1b</li> <li>\u5f53\u901a\u8fc7 <code>Command.GoTo</code> \u8fdb\u884c\u8def\u7531\u65f6\uff0c\u65e0\u9700\u989d\u5916\u6dfb\u52a0 <code>AddEdge(from, to)</code>\uff1b\u53ea\u9700\u4fdd\u8bc1\u76ee\u6807\u8282\u70b9\u5b58\u5728\uff0c\u82e5\u4e3a\u7ec8\u70b9\u9700\u8bbe\u7f6e <code>SetFinishPoint(target)</code>\u3002</li> </ul> <p>\u5b8c\u6574\u53ef\u8fd0\u884c\u793a\u4f8b\uff1a<code>examples/graph/multiends</code>\u3002</p>"},{"location":"zh/graph/#42","title":"4.2 \u591a\u6761\u4ef6\u6247\u51fa\uff08\u5e76\u884c\uff09","text":"<p>\u5f53\u4e00\u6b21\u51b3\u7b56\u9700\u8981\u201c\u540c\u65f6\u201d\u8d70\u591a\u4e2a\u5206\u652f\uff08\u4f8b\u5982\u540c\u65f6\u505a\u6458\u8981\u4e0e\u6253\u6807\u7b7e\uff09\uff0c\u53ef\u4f7f\u7528 <code>AddMultiConditionalEdges</code>\uff1a</p> <pre><code>// \u8fd4\u56de\u591a\u4e2a\u5206\u652f\u952e\uff0c\u6bcf\u4e2a\u5206\u652f\u952e\u89e3\u6790\u4e3a\u4e00\u4e2a\u5177\u4f53\u76ee\u6807\u8282\u70b9\u3002\nsg.AddMultiConditionalEdges(\n    \"router\",\n    func(ctx context.Context, s graph.State) ([]string, error) {\n        // \u4e00\u6b21\u51b3\u7b56\uff0c\u540c\u65f6\u8d70\u4e24\u4e2a\u5206\u652f\n        return []string{\"toA\", \"toB\"}, nil\n    },\n    map[string]string{\n        \"toA\": \"A\", // \u5206\u652f\u952e -&gt; \u76ee\u6807\u8282\u70b9\n        \"toB\": \"B\",\n    },\n)\n</code></pre> <p>\u8bf4\u660e\uff1a</p> <ul> <li>\u8fd4\u56de\u7ed3\u679c\u4f1a\u5148\u53bb\u91cd\uff0c\u540c\u4e00\u5206\u652f\u952e\u5728\u540c\u4e00\u6b65\u5185\u53ea\u89e6\u53d1\u4e00\u6b21\uff1b</li> <li>\u6bcf\u4e2a\u5206\u652f\u952e\u7684\u89e3\u6790\u4f18\u5148\u7ea7\u4e0e\u5355\u6761\u4ef6\u8def\u7531\u4e00\u81f4\uff1a<ol> <li>\u6761\u4ef6\u8fb9 <code>pathMap</code>\uff1b2) \u8282\u70b9 Ends\uff1b3) \u76f4\u63a5\u5f53\u4f5c\u8282\u70b9 ID\uff1b</li> </ol> </li> <li>\u53ef\u89c6\u5316\uff1a\u5f53\u672a\u63d0\u4f9b <code>pathMap</code> \u65f6\uff0cDOT \u4f1a\u56de\u9000\u4f7f\u7528\u8be5\u8282\u70b9\u7684 Ends \u6765\u6e32\u67d3\u865a\u7ebf   \u6761\u4ef6\u8fb9\uff08\u4ec5\u7528\u4e8e\u53ef\u89c6\u5316\uff0c\u65b9\u4fbf\u7406\u89e3\u6d41\u7a0b\uff09\u3002</li> </ul>"},{"location":"zh/graph/#5","title":"5. \u5de5\u5177\u8282\u70b9\u96c6\u6210","text":"<pre><code>// \u521b\u5efa\u5de5\u5177\ntools := map[string]tool.Tool{\n    \"calculator\": calculatorTool,\n    \"search\":     searchTool,\n}\n\n// \u6dfb\u52a0\u5de5\u5177\u8282\u70b9\nstateGraph.AddToolsNode(\"tools\", tools)\n\n// \u6dfb\u52a0 LLM \u5230\u5de5\u5177\u7684\u6761\u4ef6\u8def\u7531\nstateGraph.AddToolsConditionalEdges(\"llm_node\", \"tools\", \"fallback_node\")\n</code></pre> <p>\u5f00\u542f\u5de5\u5177\u5e76\u884c\u6267\u884c\uff08\u4e0e LLMAgent \u7684\u9009\u9879\u5bf9\u9f50\uff09\uff1a</p> <pre><code>// \u5f53\u540c\u4e00\u6761 assistant \u6d88\u606f\u5305\u542b\u591a\u4e2a tool_calls \u65f6\uff0c\u5e76\u884c\u6267\u884c\u4ee5\u52a0\u901f\u6574\u4f53\u8017\u65f6\u3002\nstateGraph.AddToolsNode(\n    \"tools\",\n    tools,\n    graph.WithEnableParallelTools(true), // \u53ef\u9009\uff1b\u9ed8\u8ba4\u4e32\u884c\n)\n</code></pre> <p>\u5de5\u5177\u8c03\u7528\u914d\u5bf9\u673a\u5236\u4e0e\u4e8c\u6b21\u8fdb\u5165 LLM\uff1a</p> <ul> <li>\u4ece <code>messages</code> \u5c3e\u90e8\u5411\u524d\u626b\u63cf\u6700\u8fd1\u7684 <code>assistant(tool_calls)</code>\uff1b\u9047\u5230 <code>user</code>   \u5219\u505c\u6b62\uff0c\u786e\u4fdd\u914d\u5bf9\u6b63\u786e\u3002</li> <li>\u5f53\u5de5\u5177\u8282\u70b9\u5b8c\u6210\u540e\u8fd4\u56de\u5230 LLM \u8282\u70b9\u65f6\uff0c<code>user_input</code> \u5df2\u88ab\u6e05\u7a7a\uff0cLLM \u5c06\u8d70   \u201cMessages only\u201d \u5206\u652f\uff0c\u4ee5\u5386\u53f2\u4e2d\u7684 tool \u54cd\u5e94\u7ee7\u7eed\u63a8\u7406\u3002</li> </ul>"},{"location":"zh/graph/#6","title":"6. \u8282\u70b9\u91cd\u8bd5\u4e0e\u9000\u907f","text":"<p>\u4e3a\u8282\u70b9\u914d\u7f6e\u6307\u6570\u9000\u907f\u7684\u91cd\u8bd5\u7b56\u7565\uff08\u53ef\u9009\u6296\u52a8\uff09\u3002\u5931\u8d25\u7684\u5c1d\u8bd5\u4e0d\u4f1a\u4ea7\u751f\u5199\u5165\uff1b\u53ea\u6709\u6210\u529f\u7684\u4e00\u6b21\u624d\u4f1a\u843d\u5e93\u5e76\u89e6\u53d1\u8def\u7531\u3002</p> <ul> <li>\u8282\u70b9\u7ea7\u7b56\u7565\uff08<code>WithRetryPolicy</code>\uff09\uff1a</li> </ul> <pre><code>// \u4fbf\u6377\u7b56\u7565\uff08attempts \u542b\u9996\u6b21\u5c1d\u8bd5\uff09\nsg.AddNode(\"unstable\", unstableFunc,\n    graph.WithRetryPolicy(graph.WithSimpleRetry(3)))\n\n// \u5b8c\u6574\u7b56\u7565\npolicy := graph.RetryPolicy{\n    MaxAttempts:     3,                      // 1 \u6b21\u9996\u8bd5 + \u6700\u591a 2 \u6b21\u91cd\u8bd5\n    InitialInterval: 200 * time.Millisecond, // \u57fa\u7840\u7b49\u5f85\n    BackoffFactor:   2.0,                    // \u6307\u6570\u589e\u957f\n    MaxInterval:     2 * time.Second,        // \u4e0a\u9650\n    Jitter:          true,                   // \u6296\u52a8\n    RetryOn: []graph.RetryCondition{\n        graph.DefaultTransientCondition(),   // \u622a\u6b62/\u7f51\u7edc\u8d85\u65f6\u7b49\u77ac\u65f6\u9519\u8bef\n        graph.RetryOnErrors(context.DeadlineExceeded),\n        graph.RetryOnPredicate(func(error) bool { return true }),\n    },\n    MaxElapsedTime:  5 * time.Second,        // \u603b\u91cd\u8bd5\u9884\u7b97\uff08\u53ef\u9009\uff09\n    // PerAttemptTimeout: 0,                 // \u9884\u7559\uff1b\u8282\u70b9\u8d85\u65f6\u7531\u6267\u884c\u5668\u63a7\u5236\n}\nsg.AddNode(\"unstable\", unstableFunc, graph.WithRetryPolicy(policy))\n</code></pre> <ul> <li>\u6267\u884c\u5668\u9ed8\u8ba4\u7b56\u7565\uff08\u5f53\u8282\u70b9\u672a\u914d\u7f6e\u65f6\u751f\u6548\uff09\uff1a</li> </ul> <pre><code>exec, _ := graph.NewExecutor(compiled,\n    graph.WithDefaultRetryPolicy(graph.WithSimpleRetry(2)))\n</code></pre> <p>\u6ce8\u610f\u4e8b\u9879</p> <ul> <li>\u4e2d\u65ad\uff08interrupt\uff09\u4e0d\u53c2\u4e0e\u91cd\u8bd5\u3002</li> <li>\u5f53\u8bbe\u7f6e\u4e86\u6b65\u9aa4\u8d85\u65f6\uff08<code>WithStepTimeout</code>\uff09\u65f6\uff0c\u9000\u907f\u65f6\u95f4\u4f1a\u88ab\u5f53\u524d\u6b65\u9aa4\u7684\u622a\u6b62\u65f6\u95f4\u94b3\u5236\u3002</li> <li>\u4e8b\u4ef6\u4f1a\u643a\u5e26\u91cd\u8bd5\u5143\u6570\u636e\uff0c\u4fbf\u4e8e CLI/UI \u5c55\u793a\u8fdb\u5ea6\uff1a</li> </ul> <pre><code>if b, ok := ev.StateDelta[graph.MetadataKeyNode]; ok {\n    var md graph.NodeExecutionMetadata\n    _ = json.Unmarshal(b, &amp;md)\n    if md.Phase == graph.ExecutionPhaseError &amp;&amp; md.Retrying {\n        // md.Attempt, md.MaxAttempts, md.NextDelay\n    }\n}\n</code></pre> <p>\u793a\u4f8b\uff1a<code>examples/graph/retry</code> \u5c55\u793a\u4e86\u4e00\u4e2a\u4f1a\u5148\u5931\u8d25\u540e\u6210\u529f\u7684\u8282\u70b9\uff0c\u5e76\u5728\u6210\u529f\u540e\u8fdb\u5165\u4e0b\u6e38 LLM \u8f93\u51fa\u6700\u7ec8\u7b54\u6848\u3002</p>"},{"location":"zh/graph/#7-runner","title":"7. Runner \u914d\u7f6e","text":"<p>Runner \u63d0\u4f9b\u4e86\u4f1a\u8bdd\u7ba1\u7406\u548c\u6267\u884c\u73af\u5883\uff1a</p> <pre><code>// \u521b\u5efa\u4f1a\u8bdd\u670d\u52a1\nsessionService := inmemory.NewSessionService()\n// \u6216\u8005\u4f7f\u7528 Redis \u4f1a\u8bdd\u670d\u52a1\n// sessionService, err := redis.NewService(redis.WithRedisClientURL(\"redis://localhost:6379\"))\n\n// \u521b\u5efa Runner\nappRunner := runner.NewRunner(\n    \"app-name\",\n    graphAgent,\n    runner.WithSessionService(sessionService),\n    // \u53ef\u4ee5\u6dfb\u52a0\u66f4\u591a\u914d\u7f6e\u9009\u9879\n)\n\n// \u4f7f\u7528 Runner \u6267\u884c\u5de5\u4f5c\u6d41\n// Runner \u4ec5\u8bbe\u7f6e StateKeyUserInput\uff0c\u4e0d\u518d\u9884\u5148\u5199\u5165 StateKeyMessages\u3002\nmessage := model.NewUserMessage(\"\u7528\u6237\u8f93\u5165\")\neventChan, err := appRunner.Run(ctx, userID, sessionID, message)\n</code></pre>"},{"location":"zh/graph/#8","title":"8. \u6d88\u606f\u72b6\u6001\u6a21\u5f0f","text":"<p>\u5bf9\u4e8e\u5bf9\u8bdd\u5f0f\u5e94\u7528\uff0c\u53ef\u4ee5\u4f7f\u7528\u9884\u5b9a\u4e49\u7684\u6d88\u606f\u72b6\u6001\u6a21\u5f0f\uff1a</p> <pre><code>// \u4f7f\u7528\u6d88\u606f\u72b6\u6001\u6a21\u5f0f\nschema := graph.MessagesStateSchema()\n\n// \u8fd9\u4e2a\u6a21\u5f0f\u5305\u542b\uff1a\n// - messages: \u5bf9\u8bdd\u5386\u53f2\uff08StateKeyMessages\uff09\n// - user_input: \u7528\u6237\u8f93\u5165\uff08StateKeyUserInput\uff09\n// - last_response: \u6700\u540e\u54cd\u5e94\uff08StateKeyLastResponse\uff09\n// - node_responses: \u8282\u70b9\u54cd\u5e94\u6620\u5c04\uff08StateKeyNodeResponses\uff09\n// - metadata: \u5143\u6570\u636e\uff08StateKeyMetadata\uff09\n</code></pre>"},{"location":"zh/graph/#9","title":"9. \u72b6\u6001\u952e\u4f7f\u7528\u573a\u666f","text":"<p>\u7528\u6237\u81ea\u5b9a\u4e49\u72b6\u6001\u952e\uff1a\u7528\u4e8e\u5b58\u50a8\u4e1a\u52a1\u903b\u8f91\u6570\u636e</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/graph\"\n)\n\n// \u63a8\u8350\uff1a\u4f7f\u7528\u81ea\u5b9a\u4e49\u72b6\u6001\u952e\nconst (\n    StateKeyDocumentLength = \"document_length\"\n    StateKeyComplexityLevel = \"complexity_level\"\n    StateKeyProcessingStage = \"processing_stage\"\n)\n\n// \u5728\u8282\u70b9\u4e2d\u4f7f\u7528\nreturn graph.State{\n    StateKeyDocumentLength: len(input),\n    StateKeyComplexityLevel: \"simple\",\n    StateKeyProcessingStage: \"completed\",\n}, nil\n</code></pre> <p>\u5185\u7f6e\u72b6\u6001\u952e\uff1a\u7528\u4e8e\u7cfb\u7edf\u96c6\u6210</p> <pre><code>import (\n    \"time\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/graph\"\n)\n\n// \u83b7\u53d6\u7528\u6237\u8f93\u5165\uff08\u7531\u7cfb\u7edf\u81ea\u52a8\u8bbe\u7f6e\uff09\nuserInput := state[graph.StateKeyUserInput].(string)\n\n// \u8bbe\u7f6e\u6700\u7ec8\u8f93\u51fa\uff08\u7cfb\u7edf\u4f1a\u8bfb\u53d6\u6b64\u503c\uff09\nreturn graph.State{\n    graph.StateKeyLastResponse: \"\u5904\u7406\u5b8c\u6210\",\n}, nil\n\n// \u5f53\u591a\u4e2a\u8282\u70b9\uff08\u4f8b\u5982\u5e76\u884c\u7684 LLM \u8282\u70b9\uff09\u540c\u65f6\u4ea7\u51fa\u7ed3\u679c\u65f6\uff0c\u4f7f\u7528\u6309\u8282\u70b9\u54cd\u5e94\u3002\n// \u8be5\u503c\u662f map[nodeID]any\uff0c\u4f1a\u5728\u6267\u884c\u8fc7\u7a0b\u4e2d\u5408\u5e76\u3002\u4e32\u884c\u8def\u5f84\u4f7f\u7528\n// LastResponse\uff1b\u5e76\u884c\u8282\u70b9\u6c47\u5408\u65f6\u4f7f\u7528 NodeResponses\u3002\nresponses, _ := state[graph.StateKeyNodeResponses].(map[string]any)\nnews := responses[\"news\"].(string)\ndialog := responses[\"dialog\"].(string)\n\n// \u5206\u522b\u4f7f\u7528\u6216\u7ec4\u5408\u6210\u6700\u7ec8\u8f93\u51fa\u3002\nreturn graph.State{\n    \"news_output\":   news,\n    \"dialog_output\": dialog,\n    graph.StateKeyLastResponse: news + \"\\n\" + dialog,\n}, nil\n\n// \u5b58\u50a8\u5143\u6570\u636e\nreturn graph.State{\n    graph.StateKeyMetadata: map[string]any{\n        \"timestamp\": time.Now(),\n        \"version\": \"1.0\",\n    },\n}, nil\n</code></pre>"},{"location":"zh/graph/#_11","title":"\u9ad8\u7ea7\u529f\u80fd","text":""},{"location":"zh/graph/#1","title":"1. \u4e2d\u65ad\u548c\u6062\u590d\uff08\u4eba\u673a\u534f\u4f5c\uff09","text":"<p>Graph \u5305\u901a\u8fc7\u4e2d\u65ad\u548c\u6062\u590d\u529f\u80fd\u652f\u6301\u4eba\u673a\u534f\u4f5c (HITL) \u5de5\u4f5c\u6d41\u3002\u8fd9\u4f7f\u5f97\u5de5\u4f5c\u6d41\u53ef\u4ee5\u6682\u505c\u6267\u884c\uff0c\u7b49\u5f85\u4eba\u5de5\u8f93\u5165\u6216\u5ba1\u6279\uff0c\u7136\u540e\u4ece\u4e2d\u65ad\u7684\u786e\u5207\u4f4d\u7f6e\u6062\u590d\u3002</p>"},{"location":"zh/graph/#_12","title":"\u57fa\u672c\u7528\u6cd5","text":"<pre><code>import (\n    \"context\"\n    \"trpc.group/trpc-go/trpc-agent-go/graph\"\n)\n\n// \u521b\u5efa\u4e00\u4e2a\u53ef\u4ee5\u4e2d\u65ad\u6267\u884c\u7b49\u5f85\u4eba\u5de5\u8f93\u5165\u7684\u8282\u70b9\nb.AddNode(\"approval_node\", func(ctx context.Context, s graph.State) (any, error) {\n    // \u4f7f\u7528 Interrupt \u52a9\u624b\u51fd\u6570\u8fdb\u884c\u5e72\u51c0\u7684\u4e2d\u65ad/\u6062\u590d\u5904\u7406\n    prompt := map[string]any{\n        \"message\": \"\u8bf7\u5ba1\u6279\u6b64\u64cd\u4f5c (yes/no):\",\n        \"data\":    s[\"some_data\"],\n    }\n})\n</code></pre> <p>\u7528\u4ee3\u7801\u628a\u8fd9\u4e2a\u56fe\u53d8\u6210\u53ef\u8fd0\u884c\u7684\u5de5\u4f5c\u6d41\uff1a</p> <pre><code>package main\n\nimport (\n    \"context\"\n    \"fmt\"\n    \"strings\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/agent/graphagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/graph\"\n    \"trpc.group/trpc-go/trpc-agent-go/model\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/openai\"\n    \"trpc.group/trpc-go/trpc-agent-go/runner\"\n    \"trpc.group/trpc-go/trpc-agent-go/tool\"\n    \"trpc.group/trpc-go/trpc-agent-go/tool/function\"\n)\n\n// \u975e\u5bfc\u51fa\u5e38\u91cf\uff0c\u907f\u514d\u9b54\u6cd5\u5b57\u7b26\u4e32\nconst (\n    nodePrepare   = \"prepare\"\n    nodeAsk       = \"ask\"\n    nodeTools     = \"tools\"\n    nodeFallback  = \"fallback\"\n    nodeFinish    = \"finish\"\n\n    modelName     = \"gpt-4o-mini\"\n    systemPrompt  = \"\u4f60\u662f\u4e00\u4e2a\u8c28\u614e\u7684\u52a9\u624b\u3002\"\n    outputKeyFinal = \"final_output\"\n\n    toolNameCalculator = \"calculator\"\n\n    demoUserID    = \"user\"\n    demoSessionID = \"session\"\n    demoQuestion  = \"6 * 7 \u7b49\u4e8e\u591a\u5c11\uff1f\"\n)\n\nfunc newCalculator() tool.Tool {\n    type Input struct {\n        Expression string `json:\"expression\"`\n    }\n    type Output struct {\n        Result float64 `json:\"result\"`\n    }\n    return function.NewFunctionTool[Input, Output](\n        func(ctx context.Context, in Input) (Output, error) {\n            // \u5728\u6b64\u5b9e\u73b0\u771f\u5b9e\u8ba1\u7b97\u903b\u8f91\n            return Output{Result: 42}, nil\n        },\n        function.WithName(toolNameCalculator),\n        function.WithDescription(\"\u8ba1\u7b97\u6570\u5b66\u8868\u8fbe\u5f0f\"),\n    )\n}\n\nfunc buildWorkflow(m model.Model, tools map[string]tool.Tool) (*graph.Graph, error) {\n    sg := graph.NewStateGraph(graph.MessagesStateSchema())\n\n    sg.AddNode(nodePrepare, func(ctx context.Context, s graph.State) (any, error) {\n        raw := fmt.Sprint(s[graph.StateKeyUserInput])\n        cleaned := strings.TrimSpace(raw)\n        return graph.State{graph.StateKeyUserInput: cleaned}, nil\n    })\n\n    sg.AddLLMNode(nodeAsk, m, systemPrompt, tools)\n    sg.AddToolsNode(nodeTools, tools)\n\n    sg.AddNode(nodeFallback, func(ctx context.Context, s graph.State) (any, error) {\n        return graph.State{graph.StateKeyLastResponse: \"\u65e0\u9700\u5de5\u5177\uff0c\u76f4\u63a5\u56de\u7b54\"}, nil\n    })\n\n    sg.AddNode(nodeFinish, func(ctx context.Context, s graph.State) (any, error) {\n        return graph.State{outputKeyFinal: fmt.Sprint(s[graph.StateKeyLastResponse])}, nil\n    })\n\n    sg.SetEntryPoint(nodePrepare)\n    sg.AddEdge(nodePrepare, nodeAsk)\n    sg.AddToolsConditionalEdges(nodeAsk, nodeTools, nodeFallback)\n    sg.AddEdge(nodeTools, nodeAsk)\n    sg.AddEdge(nodeFallback, nodeFinish)\n    sg.SetFinishPoint(nodeFinish)\n\n    return sg.Compile()\n}\n\nfunc main() {\n    mdl := openai.New(modelName)\n    tools := map[string]tool.Tool{toolNameCalculator: newCalculator()}\n\n    g, err := buildWorkflow(mdl, tools)\n    if err != nil {\n        panic(err)\n    }\n\n    // \u4f7f\u7528 GraphAgent + Runner \u8fd0\u884c\n    ga, err := graphagent.New(\"demo\", g)\n    if err != nil {\n        panic(err)\n    }\n    app := runner.NewRunner(\"app\", ga)\n    events, err := app.Run(context.Background(), demoUserID, demoSessionID,\n        model.NewUserMessage(demoQuestion))\n    if err != nil {\n        panic(err)\n    }\n    for ev := range events {\n        if ev.Response == nil {\n            continue\n        }\n        if ev.Author == nodeAsk &amp;&amp; !ev.Response.IsPartial &amp;&amp; len(ev.Response.Choices) &gt; 0 {\n            fmt.Println(\"LLM:\", ev.Response.Choices[0].Message.Content)\n        }\n    }\n}\n</code></pre> <p>\u4e0a\u9762\u7684\u4f8b\u5b50\u5c55\u793a\u4e86\u5982\u4f55\u58f0\u660e\u8282\u70b9\u3001\u8fde\u8fb9\u5e76\u8fd0\u884c\u3002\u63a5\u4e0b\u6765\u5148\u4ecb\u7ecd\u6267\u884c\u65b9\u5f0f\u4e0e\u4f1a\u8bdd\u7ba1\u7406\uff0c\u7136\u540e\u8fdb\u5165\u6838\u5fc3\u6982\u5ff5\u4e0e\u5e38\u89c1\u7528\u6cd5\u3002</p>"},{"location":"zh/graph/#_13","title":"\u6267\u884c\u65b9\u5f0f","text":"<ul> <li>\u7528 <code>graphagent.New</code> \u5305\u88c5\u6210\u901a\u7528 <code>agent.Agent</code>\uff0c\u4ea4\u7ed9 <code>runner.Runner</code> \u7ba1\u7406\u4f1a\u8bdd\u4e0e\u4e8b\u4ef6\u6d41\u3002</li> </ul> <p>\u6700\u5c0f GraphAgent + Runner \u4f8b\u5b50\uff1a</p> <pre><code>compiled, _ := buildWorkflow(openai.New(\"gpt-4o-mini\"), nil)\nga, _ := graphagent.New(\"demo\", compiled)\napp := runner.NewRunner(\"app\", ga)\n\nevents, _ := app.Run(ctx, \"user\", \"session\", model.NewUserMessage(\"hi\"))\nfor ev := range events { /* \u5904\u7406\u4e8b\u4ef6 */ }\n</code></pre> <p>Runner \u4f1a\u8bdd\u540e\u7aef\u53ef\u9009\u9879\uff1a</p> <ul> <li>\u5185\u5b58\uff1a<code>session/inmemory</code>\uff08\u9ed8\u8ba4\u793a\u4f8b\u4f7f\u7528\uff09</li> <li>Redis\uff1a<code>session/redis</code>\uff08\u751f\u4ea7\u66f4\u5e38\u7528\uff09</li> </ul> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/session/redis\"\n)\n\nsess, _ := redis.NewService(redis.WithRedisClientURL(\"redis://localhost:6379\"))\napp := runner.NewRunner(\"app\", ga, runner.WithSessionService(sess))\n</code></pre>"},{"location":"zh/graph/#graphagent","title":"GraphAgent \u914d\u7f6e\u9009\u9879","text":"<pre><code>ga, err := graphagent.New(\n    \"workflow\",\n    compiledGraph,\n    graphagent.WithDescription(\"\u5de5\u4f5c\u6d41\u63cf\u8ff0\"),\n    graphagent.WithInitialState(graph.State{\"init\": 1}),\n    graphagent.WithChannelBufferSize(512),\n    graphagent.WithCheckpointSaver(saver),\n    graphagent.WithSubAgents([]agent.Agent{subAgent}), // \u914d\u7f6e\u5b50 Agent\n    graphagent.WithAgentCallbacks(agent.NewCallbacks()), // \u6ce8\u610f\uff1a\u7ed3\u6784\u5316\u56de\u8c03 API \u9700\u8981 trpc-agent-go &gt;= 0.6.0\n    // \u8bbe\u7f6e\u4f20\u7ed9\u6a21\u578b\u7684\u6d88\u606f\u8fc7\u6ee4\u6a21\u5f0f\uff0c\u6700\u7ec8\u4f20\u7ed9\u6a21\u578b\u7684\u6d88\u606f\u9700\u540c\u65f6\u6ee1\u8db3WithMessageTimelineFilterMode\u4e0eWithMessageBranchFilterMode\u6761\u4ef6\n    // \u65f6\u95f4\u7ef4\u5ea6\u8fc7\u6ee4\u6761\u4ef6\n    // \u9ed8\u8ba4\u503c: graphagent.TimelineFilterAll\n    // \u53ef\u9009\u503c:\n    //  - graphagent.TimelineFilterAll: \u5305\u542b\u5386\u53f2\u6d88\u606f\u4ee5\u53ca\u5f53\u524d\u8bf7\u6c42\u4e2d\u6240\u751f\u6210\u7684\u6d88\u606f\n    //  - graphagent.TimelineFilterCurrentRequest: \u4ec5\u5305\u542b\u5f53\u524d\u8bf7\u6c42\u4e2d\u6240\u751f\u6210\u7684\u6d88\u606f\n    //  - graphagent.TimelineFilterCurrentInvocation: \u4ec5\u5305\u542b\u5f53\u524dinvocation\u4e0a\u4e0b\u6587\u4e2d\u751f\u6210\u7684\u6d88\u606f\n    graphagent.WithMessageTimelineFilterMode(graphagent.BranchFilterModeAll),\n    // \u5206\u652f\u7ef4\u5ea6\u8fc7\u6ee4\u6761\u4ef6\n    // \u9ed8\u8ba4\u503c: graphagent.BranchFilterModePrefix\n    // \u53ef\u9009\u503c:\n    //  - graphagent.BranchFilterModeAll: \u5305\u542b\u6240\u6709agent\u7684\u6d88\u606f, \u5f53\u524dagent\u4e0e\u6a21\u578b\u4ea4\u4e92\u65f6,\u5982\u9700\u5c06\u6240\u6709agent\u751f\u6210\u7684\u6709\u6548\u5185\u5bb9\u6d88\u606f\u540c\u6b65\u7ed9\u6a21\u578b\u65f6\u53ef\u8bbe\u7f6e\u8be5\u503c\n    //  - graphagent.BranchFilterModePrefix: \u901a\u8fc7Event.FilterKey\u4e0eInvocation.eventFilterKey\u505a\u524d\u7f00\u5339\u914d\u8fc7\u6ee4\u6d88\u606f, \u671f\u671b\u5c06\u4e0e\u5f53\u524dagent\u4ee5\u53ca\u76f8\u5173\u4e0a\u4e0b\u6e38agent\u751f\u6210\u7684\u6d88\u606f\u4f20\u9012\u7ed9\u6a21\u578b\u65f6\uff0c\u53ef\u8bbe\u7f6e\u8be5\u503c\n    //  - graphagent.BranchFilterModeExact: \u901a\u8fc7Event.FilterKey==Invocation.eventFilterKey\u8fc7\u6ee4\u6d88\u606f\uff0c\u5f53\u524dagent\u4e0e\u6a21\u578b\u4ea4\u4e92\u65f6,\u4ec5\u9700\u4f7f\u7528\u5f53\u524dagent\u751f\u6210\u7684\u6d88\u606f\u65f6\u53ef\u8bbe\u7f6e\u8be5\u503c\n    graphagent.WithMessageBranchFilterMode(graphagent.TimelineFilterAll),\n)\n</code></pre>"},{"location":"zh/graph/#_14","title":"\u6838\u5fc3\u6982\u5ff5","text":""},{"location":"zh/graph/#_15","title":"\u72b6\u6001\u7ba1\u7406","text":"<p>GraphAgent \u91c7\u7528 Schema + Reducer \u6a21\u5f0f\u7ba1\u7406\u72b6\u6001\u3002\u5148\u660e\u786e\u72b6\u6001\u7ed3\u6784\u4e0e\u5408\u5e76\u89c4\u5219\uff0c\u540e\u7eed\u8282\u70b9\u8f93\u5165/\u8f93\u51fa\u7684 key \u5c31\u6709\u4e86\u6e05\u6670\u6765\u6e90\u4e0e\u751f\u547d\u5468\u671f\u7ea6\u5b9a\u3002</p>"},{"location":"zh/graph/#schema","title":"\u4f7f\u7528\u5185\u7f6e Schema","text":"<pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/graph\"\n)\n\nschema := graph.MessagesStateSchema()\n\n// \u9884\u5b9a\u4e49\u5b57\u6bb5\uff08\u952e\u540d\u5e38\u91cf\uff09\u4e0e\u8bed\u4e49\uff1a\n// - graph.StateKeyMessages       (\"messages\")        \u5bf9\u8bdd\u5386\u53f2\uff08[]model.Message\uff1bMessageReducer + MessageOp \u539f\u5b50\u5408\u5e76\uff09\n// - graph.StateKeyUserInput      (\"user_input\")      \u7528\u6237\u8f93\u5165\uff08string\uff1b\u4e00\u6b21\u6027\uff0c\u6210\u529f\u6267\u884c\u540e\u6e05\u7a7a\uff09\n// - graph.StateKeyLastResponse   (\"last_response\")   \u6700\u540e\u54cd\u5e94\uff08string\uff09\n// - graph.StateKeyNodeResponses  (\"node_responses\")  \u5404\u8282\u70b9\u8f93\u51fa\uff08map[string]any\uff1b\u5e76\u884c\u6c47\u603b\u8bfb\u53d6\uff09\n// - graph.StateKeyMetadata       (\"metadata\")        \u5143\u6570\u636e\uff08map[string]any\uff1bMergeReducer \u5408\u5e76\uff09\n\n// \u5176\u4ed6\u4e00\u6b21\u6027/\u7cfb\u7edf\u952e\uff08\u6309\u9700\u4f7f\u7528\uff09\uff1a\n// - graph.StateKeyOneShotMessages (\"one_shot_messages\")  \u4e00\u6b21\u6027\u8986\u76d6\u672c\u8f6e\u8f93\u5165\uff08[]model.Message\uff09\n// - graph.StateKeySession         (\"session\")            \u4f1a\u8bdd\u5bf9\u8c61\uff08\u7cfb\u7edf\u4f7f\u7528\uff09\n// - graph.StateKeyExecContext     (\"exec_context\")       \u6267\u884c\u4e0a\u4e0b\u6587\uff08\u4e8b\u4ef6\u6d41\u7b49\uff0c\u7cfb\u7edf\u4f7f\u7528\uff09\n</code></pre>"},{"location":"zh/graph/#schema_1","title":"\u81ea\u5b9a\u4e49 Schema","text":"<pre><code>import (\n    \"reflect\"\n    \"trpc.group/trpc-go/trpc-agent-go/graph\"\n)\n\nschema := graph.NewStateSchema()\n\n// \u6dfb\u52a0\u81ea\u5b9a\u4e49\u5b57\u6bb5\nschema.AddField(\"counter\", graph.StateField{\n    Type:    reflect.TypeOf(0),\n    Default: func() any { return 0 },\n    Reducer: func(old, new any) any {\n        return old.(int) + new.(int)  // \u7d2f\u52a0\n    },\n})\n\n// \u5b57\u7b26\u4e32\u5217\u8868\u4f7f\u7528\u5185\u7f6e Reducer\nschema.AddField(\"items\", graph.StateField{\n    Type:    reflect.TypeOf([]string{}),\n    Default: func() any { return []string{} },\n    Reducer: graph.StringSliceReducer,\n})\n</code></pre> <p>Reducer \u673a\u5236\u786e\u4fdd\u72b6\u6001\u5b57\u6bb5\u6309\u9884\u5b9a\u4e49\u89c4\u5219\u5b89\u5168\u5408\u5e76\uff0c\u8fd9\u5728\u5e76\u53d1\u6267\u884c\u65f6\u5c24\u5176\u91cd\u8981\u3002</p> <p>\u63d0\u793a\uff1a\u5efa\u8bae\u4e3a\u4e1a\u52a1\u952e\u5b9a\u4e49\u5e38\u91cf\uff0c\u907f\u514d\u6563\u843d\u9b54\u6cd5\u5b57\u7b26\u4e32\u3002</p>"},{"location":"zh/graph/#_16","title":"\u8282\u70b9\u7c7b\u578b","text":"<p>GraphAgent \u63d0\u4f9b\u4e86\u56db\u79cd\u5185\u7f6e\u8282\u70b9\u7c7b\u578b\uff1a</p>"},{"location":"zh/graph/#function","title":"Function \u8282\u70b9","text":"<p>\u6700\u57fa\u7840\u7684\u8282\u70b9\uff0c\u6267\u884c\u81ea\u5b9a\u4e49\u903b\u8f91\uff1a</p> <pre><code>import (\n    \"context\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/graph\"\n)\n\nconst (\n    stateKeyInput  = \"input\"\n    stateKeyOutput = \"output\"\n    nodeProcess    = \"process\"\n)\n\nsg.AddNode(nodeProcess, func(ctx context.Context, state graph.State) (any, error) {\n    data := state[stateKeyInput].(string)\n    processed := transform(data)\n    // Function \u8282\u70b9\u9700\u663e\u5f0f\u6307\u5b9a\u8f93\u51fa key\n    return graph.State{stateKeyOutput: processed}, nil\n})\n</code></pre>"},{"location":"zh/graph/#llm_1","title":"LLM \u8282\u70b9","text":"<p>\u96c6\u6210\u8bed\u8a00\u6a21\u578b\uff0c\u81ea\u52a8\u7ba1\u7406\u5bf9\u8bdd\u5386\u53f2\uff1a</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/graph\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/openai\"\n)\n\nconst (\n    llmModelName     = \"gpt-4o-mini\"\n    llmSystemPrompt  = \"\u7cfb\u7edf\u63d0\u793a\u8bcd\"\n    llmNodeAssistant = \"assistant\"\n)\n\nmodel := openai.New(llmModelName)\nsg.AddLLMNode(llmNodeAssistant, model, llmSystemPrompt, tools)\n\n// LLM \u8282\u70b9\u7684\u8f93\u5165\u8f93\u51fa\u89c4\u5219\uff1a\n// \u8f93\u5165\u4f18\u5148\u7ea7: graph.StateKeyOneShotMessages &gt; graph.StateKeyUserInput &gt; graph.StateKeyMessages\n// \u8f93\u51fa: graph.StateKeyLastResponse\u3001graph.StateKeyMessages(\u539f\u5b50\u66f4\u65b0)\u3001graph.StateKeyNodeResponses\uff08\u5305\u542b\u5f53\u524d\u8282\u70b9\u8f93\u51fa\uff0c\u4fbf\u4e8e\u5e76\u884c\u6c47\u603b\uff09\n</code></pre>"},{"location":"zh/graph/#cache","title":"\u8282\u70b9\u7f13\u5b58\uff08Cache\uff09","text":"<p>\u4e3a\u201c\u7eaf\u51fd\u6570\u578b\u201d\u8282\u70b9\u5f00\u542f\u7f13\u5b58\u53ef\u4ee5\u663e\u8457\u51cf\u5c11\u91cd\u590d\u8ba1\u7b97\u5f00\u9500\u3002Graph \u652f\u6301\u56fe\u7ea7\u4e0e\u8282\u70b9\u7ea7\u7f13\u5b58\u7b56\u7565\uff1a</p> <ul> <li>\u56fe\u7ea7\u8bbe\u7f6e\u7f13\u5b58\u5b9e\u73b0\u4e0e\u9ed8\u8ba4\u7b56\u7565\uff1a<ul> <li><code>WithCache(cache Cache)</code> \u8bbe\u7f6e\u7f13\u5b58\u540e\u7aef\uff08\u9ed8\u8ba4\u793a\u4f8b\u63d0\u4f9b\u5185\u5b58\u5b9e\u73b0 InMemoryCache\uff09</li> <li><code>WithCachePolicy(policy *CachePolicy)</code> \u8bbe\u7f6e\u9ed8\u8ba4\u7f13\u5b58\u7b56\u7565\uff08\u952e\u51fd\u6570 KeyFunc + \u751f\u5b58\u65f6\u95f4 Time To Live, TTL\uff09</li> </ul> </li> <li>\u8282\u70b9\u7ea7\u8986\u76d6\u7b56\u7565\uff1a<code>WithNodeCachePolicy(policy *CachePolicy)</code>\uff08\u4f18\u5148\u4e8e\u56fe\u7ea7\uff09</li> <li>\u6e05\u7406\uff1a<code>ClearCache(nodes ...string)</code> \u6309\u8282\u70b9\u6e05\u7406\u7f13\u5b58\u547d\u540d\u7a7a\u95f4</li> </ul> <p>\u53c2\u8003\uff1a</p> <ul> <li>Graph \u63a5\u53e3\uff08\u7f13\u5b58\u4e0e\u7b56\u7565\u7684\u8bbf\u95ee/\u8bbe\u7f6e\uff09\uff1agraph/graph.go</li> <li>\u9ed8\u8ba4\u7b56\u7565\u4e0e\u5185\u5b58\u540e\u7aef\u5b9e\u73b0\uff1a<ul> <li>\u63a5\u53e3/\u7b56\u7565\u4e0e\u9ed8\u8ba4\u952e\u51fd\u6570\uff08\u89c4\u8303\u5316 JSON + SHA\u2011256\uff09\uff1agraph/cache.go</li> <li>\u5185\u5b58\u7f13\u5b58\uff08InMemoryCache\uff09\u5e76\u53d1\u5b89\u5168\u5b9e\u73b0\uff08\u8bfb\u5199\u9501 + \u6df1\u62f7\u8d1d\uff09\uff1agraph/cache.go</li> </ul> </li> <li>\u6267\u884c\u5668\uff1a<ul> <li>\u8282\u70b9\u6267\u884c\u524d\u5c1d\u8bd5 Get\uff0c\u547d\u4e2d\u5219\u8df3\u8fc7\u8282\u70b9\u51fd\u6570\u6267\u884c\uff0c\u4ec5\u89e6\u53d1 after \u56de\u8c03\u4e0e\u5199\u51fa\uff08Writes\uff09\uff1agraph/executor.go</li> <li>\u6b63\u5e38\u6267\u884c\u6210\u529f\u540e\u5199\u5165\u7f13\u5b58\uff08Set\uff09\uff1agraph/executor.go</li> <li>\u8282\u70b9\u5b8c\u6210\u4e8b\u4ef6\u4e2d\u9644\u5e26 <code>_cache_hit</code> \u89c2\u5bdf\u6807\u8bb0\uff08\u547d\u4e2d\u65f6\u63d2\u5165 <code>StateDelta[\"_cache_hit\"]=true</code>\uff09\uff1agraph/executor.go</li> </ul> </li> </ul> <p>\u6700\u5c0f\u7528\u6cd5\uff1a</p> <pre><code>schema := graph.NewStateSchema()\nsg := graph.NewStateGraph(schema).\n  WithCache(graph.NewInMemoryCache()).\n  WithCachePolicy(graph.DefaultCachePolicy())\n\n// \u5bf9\u67d0\u4e2a\u8282\u70b9\u5355\u72ec\u8bbe\u7f6e TTL 10 \u5206\u949f\nnodePolicy := &amp;graph.CachePolicy{KeyFunc: graph.DefaultCachePolicy().KeyFunc, TTL: 10*time.Minute}\nsg.AddNode(\"compute\", computeFunc, graph.WithNodeCachePolicy(nodePolicy)).\n  SetEntryPoint(\"compute\").\n  SetFinishPoint(\"compute\")\n\ncompiled, _ := sg.Compile()\n</code></pre> <p>\u8fdb\u9636\u7528\u6cd5\uff1a</p> <ul> <li>\u4ec5\u4f7f\u7528\u90e8\u5206\u5b57\u6bb5\u4f5c\u4e3a\u952e\uff08\u63a8\u8350\uff09</li> </ul> <pre><code>package main\n\nimport (\n    \"context\"\n    \"time\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/graph\"\n)\n\nfunc build() (*graph.Graph, error) {\n    schema := graph.NewStateSchema()\n    sg := graph.NewStateGraph(schema).\n        WithCache(graph.NewInMemoryCache()).\n        WithCachePolicy(graph.DefaultCachePolicy())\n\n    compute := func(ctx context.Context, s graph.State) (any, error) {\n        // your logic here\n        return graph.State{\"out\": s[\"n\"].(int) * 2}, nil\n    }\n\n    // \u4ec5\u4f7f\u7528 n \u4e0e user_id \u4e24\u4e2a\u5b57\u6bb5\u53c2\u4e0e\u952e\u8ba1\u7b97\uff08\u5176\u4f59\u5b57\u6bb5\u4e0d\u4f1a\u5f71\u54cd\u547d\u4e2d\uff09\n    sg.AddNode(\"compute\", compute,\n        graph.WithNodeCachePolicy(&amp;graph.CachePolicy{KeyFunc: graph.DefaultCachePolicy().KeyFunc, TTL: 30*time.Minute}),\n        graph.WithCacheKeyFields(\"n\", \"user_id\"),\n    )\n\n    return sg.Compile()\n}\n</code></pre> <ul> <li>\u81ea\u5b9a\u4e49\u9009\u62e9\u5668\uff08\u5f53\u5b57\u6bb5\u6620\u5c04\u66f4\u590d\u6742\u65f6\uff09</li> </ul> <pre><code>package main\n\nimport (\n    \"context\"\n    \"time\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/graph\"\n)\n\nfunc build() (*graph.Graph, error) {\n    schema := graph.NewStateSchema()\n    sg := graph.NewStateGraph(schema).\n        WithCache(graph.NewInMemoryCache()).\n        WithCachePolicy(graph.DefaultCachePolicy())\n\n    compute := func(ctx context.Context, s graph.State) (any, error) { return graph.State{\"out\": 42}, nil }\n\n    sg.AddNode(\"compute\", compute,\n        graph.WithNodeCachePolicy(&amp;graph.CachePolicy{KeyFunc: graph.DefaultCachePolicy().KeyFunc, TTL: 5*time.Minute}),\n        graph.WithCacheKeySelector(func(m map[string]any) any {\n            // \u4ec5\u4ece\u51c0\u5316\u540e\u7684\u8f93\u5165\u4e2d\u9009\u62e9 n \u4e0e uid \u4f5c\u4e3a\u952e\u6765\u6e90\n            return map[string]any{\"n\": m[\"n\"], \"uid\": m[\"uid\"]}\n        }),\n    )\n    return sg.Compile()\n}\n</code></pre> <ul> <li>\u7248\u672c\u5316\u547d\u540d\u7a7a\u95f4\uff08\u8de8\u7248\u672c\u9632\u810f\u7f13\u5b58\uff09</li> </ul> <pre><code>package main\n\nimport (\n    \"trpc.group/trpc-go/trpc-agent-go/graph\"\n)\n\nfunc build() (*graph.Graph, error) {\n    schema := graph.NewStateSchema()\n    sg := graph.NewStateGraph(schema).\n        WithGraphVersion(\"v2025.03\"). // \u547d\u540d\u7a7a\u95f4\u53d8\u4e3a __writes__:v2025.03:&lt;node&gt;\n        WithCache(graph.NewInMemoryCache()).\n        WithCachePolicy(graph.DefaultCachePolicy())\n\n    // ... AddNode(...)\n    return sg.Compile()\n}\n</code></pre> <ul> <li>\u8282\u70b9\u7ea7 TTL\uff08Time To Live\uff09</li> </ul> <pre><code>package main\n\nimport (\n    \"context\"\n    \"time\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/graph\"\n)\n\nfunc build() (*graph.Graph, error) {\n    schema := graph.NewStateSchema()\n    sg := graph.NewStateGraph(schema).\n        WithCache(graph.NewInMemoryCache()).\n        WithCachePolicy(graph.DefaultCachePolicy())\n\n    compute := func(ctx context.Context, s graph.State) (any, error) { return graph.State{\"out\": 42}, nil }\n\n    sg.AddNode(\"compute\", compute,\n        graph.WithNodeCachePolicy(&amp;graph.CachePolicy{\n            KeyFunc: graph.DefaultCachePolicy().KeyFunc,\n            TTL:     10 * time.Minute,\n        }),\n    )\n    return sg.Compile()\n}\n</code></pre> <ul> <li>\u6e05\u7406\u7f13\u5b58\uff08\u6309\u8282\u70b9\uff09</li> </ul> <pre><code>package main\n\nimport (\n    \"trpc.group/trpc-go/trpc-agent-go/graph\"\n)\n\nfunc clear(sg *graph.StateGraph) {\n    // \u6e05\u7406\u6307\u5b9a\u8282\u70b9\n    sg.ClearCache(\"compute\", \"format\")\n\n    // \u6e05\u7406\u56fe\u5185\u6240\u6709\u8282\u70b9\uff08\u4e0d\u4f20\u53c2\uff09\n    sg.ClearCache()\n}\n</code></pre> <ul> <li>\u8bfb\u53d6\u7f13\u5b58\u547d\u4e2d\u6807\u8bb0\uff08_cache_hit\uff09</li> </ul> <pre><code>package main\n\nimport (\n    \"context\"\n    \"fmt\"\n    \"trpc.group/trpc-go/trpc-agent-go/agent\"\n    \"trpc.group/trpc-go/trpc-agent-go/event\"\n    \"trpc.group/trpc-go/trpc-agent-go/graph\"\n)\n\nfunc runAndReadHits(executor *graph.Executor, initial graph.State) error {\n    inv := &amp;agent.Invocation{InvocationID: \"demo\"}\n    ch, err := executor.Execute(context.Background(), initial, inv)\n    if err != nil { return err }\n    for e := range ch {\n        if e.Response != nil &amp;&amp; e.Response.Object == graph.ObjectTypeGraphNodeComplete {\n            if e.StateDelta != nil {\n                if _, ok := e.StateDelta[\"_cache_hit\"]; ok {\n                    fmt.Println(\"cache hit: skipped node function\")\n                }\n            }\n        }\n        if e.Done { break }\n    }\n    return nil\n}\n</code></pre> <p>\u6ce8\u610f\u4e8b\u9879\uff1a</p> <ul> <li>\u4ec5\u5bf9\u201c\u7eaf\u51fd\u6570\uff08\u76f8\u540c\u8f93\u5165 \u2192 \u76f8\u540c\u8f93\u51fa\uff0c\u65e0\u5916\u90e8\u526f\u4f5c\u7528\uff09\u201d\u8282\u70b9\u5f00\u542f\u7f13\u5b58\uff0c\u907f\u514d\u8bed\u4e49\u9519\u8bef\u3002</li> <li>TTL\uff08Time To Live\uff09\u4e3a 0 \u8868\u793a\u4e0d\u8fc7\u671f\uff0c\u9700\u9632\u6b62\u5185\u5b58\u589e\u957f\uff1b\u751f\u4ea7\u5efa\u8bae\u4f7f\u7528\u6301\u4e45\u5316\u540e\u7aef\uff08\u5982 Redis/SQLite\uff09\u4e0e\u5b9a\u671f\u6e05\u7406\u3002</li> <li>\u952e\u51fd\u6570\u4f1a\u201c\u51c0\u5316\u8f93\u5165\u201d\u540e\u518d\u89c4\u8303\u5316\u5e8f\u5217\u5316\uff0c\u907f\u514d\u628a\u4f1a\u8bdd\u3001\u6267\u884c\u4e0a\u4e0b\u6587\u7b49\u201c\u6613\u53d8/\u4e0d\u53ef\u5e8f\u5217\u5316\u201d\u503c\u7eb3\u5165\u952e\uff0c\u63d0\u5347\u547d\u4e2d\u7387\u3001\u907f\u514d\u9519\u8bef\uff08\u89c1 graph/cache_key.go\uff09\u3002</li> <li>\u4ee3\u7801\u66f4\u65b0\u540e\u53ef\u8c03\u7528 <code>ClearCache(\"nodeID\")</code> \u6e05\u7406\u65e7\u7f13\u5b58\uff0c\u6216\u5728\u952e/\u547d\u540d\u7a7a\u95f4\u4e2d\u5f15\u5165\u201c\u51fd\u6570\u6807\u8bc6\u7b26/\u7248\u672c\u201d\u7ef4\u5ea6\u3002</li> </ul> <p>Runner + GraphAgent \u73af\u5883\u4f7f\u7528\u793a\u4f8b\uff1a</p> <pre><code>package main\n\nimport (\n    \"bufio\"\n    \"context\"\n    \"flag\"\n    \"fmt\"\n    \"os\"\n    \"strings\"\n    \"time\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/agent\"\n    \"trpc.group/trpc-go/trpc-agent-go/agent/graphagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/graph\"\n    \"trpc.group/trpc-go/trpc-agent-go/model\"\n    \"trpc.group/trpc-go/trpc-agent-go/runner\"\n    \"trpc.group/trpc-go/trpc-agent-go/session/inmemory\"\n)\n\nfunc main() {\n    ttl := flag.Duration(\"ttl\", 1*time.Minute, \"cache ttl\")\n    flag.Parse()\n\n    // Build graph with cache\n    schema := graph.NewStateSchema()\n    sg := graph.NewStateGraph(schema).\n        WithCache(graph.NewInMemoryCache()).\n        WithCachePolicy(graph.DefaultCachePolicy())\n\n    compute := func(ctx context.Context, s graph.State) (any, error) {\n        n, _ := s[\"n\"].(int)\n        time.Sleep(200 * time.Millisecond)\n        return graph.State{\"out\": n * 2}, nil\n    }\n    sg.AddNode(\"compute\", compute,\n        graph.WithNodeCachePolicy(&amp;graph.CachePolicy{KeyFunc: graph.DefaultCachePolicy().KeyFunc, TTL: *ttl}),\n        graph.WithCacheKeyFields(\"n\"),\n    ).\n        SetEntryPoint(\"compute\").\n        SetFinishPoint(\"compute\")\n    g, _ := sg.Compile()\n\n    // GraphAgent + Runner\n    ga, _ := graphagent.New(\"cache-demo\", g, graphagent.WithInitialState(graph.State{}))\n    app := runner.NewRunner(\"app\", ga, runner.WithSessionService(inmemory.NewSessionService()))\n\n    // Interactive\n    sc := bufio.NewScanner(os.Stdin)\n    fmt.Println(\"Enter integers; repeated inputs should hit cache. type 'exit' to quit\")\n    for {\n        fmt.Print(\"&gt; \")\n        if !sc.Scan() { break }\n        txt := strings.TrimSpace(sc.Text())\n        if txt == \"exit\" { break }\n        if txt == \"\" { continue }\n        msg := model.NewUserMessage(fmt.Sprintf(\"compute %s\", txt))\n        evts, err := app.Run(context.Background(), \"user\", fmt.Sprintf(\"s-%d\", time.Now().UnixNano()), msg, agent.WithRuntimeState(graph.State{\"n\": atoi(txt)}))\n        if err != nil { fmt.Println(\"run error:\", err); continue }\n        for e := range evts {\n            if e.Response != nil &amp;&amp; e.Response.Object == graph.ObjectTypeGraphNodeComplete {\n                if e.StateDelta != nil { if _, ok := e.StateDelta[\"_cache_hit\"]; ok { fmt.Println(\"cache hit\") } }\n            }\n            if e.Done { break }\n        }\n    }\n}\n\nfunc atoi(s string) int { var n int; fmt.Sscanf(s, \"%d\", &amp;n); return n }\n</code></pre> <p>\u793a\u4f8b\uff1a</p> <ul> <li>\u4ea4\u4e92\u5f0f\uff08Interactive\uff09+ Runner + GraphAgent \u6f14\u793a\uff1a<code>examples/graph/nodecache</code>\uff0c\u5165\u53e3 examples/graph/nodecache/main.go</li> </ul>"},{"location":"zh/graph/#tools","title":"Tools \u8282\u70b9","text":"<p>\u6267\u884c\u5de5\u5177\u8c03\u7528\uff0c\u6ce8\u610f\u662f\u987a\u5e8f\u6267\u884c\uff1a</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/graph\"\n)\n\nconst nodeTools = \"tools\"\n\nsg.AddToolsNode(nodeTools, tools)\n// \u591a\u4e2a\u5de5\u5177\u4f1a\u6309 LLM \u8fd4\u56de\u7684\u987a\u5e8f\u4f9d\u6b21\u6267\u884c\n// \u5982\u9700\u5e76\u884c\uff0c\u5e94\u8be5\u4f7f\u7528\u591a\u4e2a\u8282\u70b9 + \u5e76\u884c\u8fb9\n// \u914d\u5bf9\u89c4\u5219\uff1a\u4ece messages \u5c3e\u90e8\u56de\u6eaf\u5b9a\u4f4d\u6700\u8fd1\u7684 assistant(tool_calls)\n// \u6d88\u606f\uff0c\u9047\u5230\u65b0\u7684 user \u5373\u505c\u6b62\uff0c\u786e\u4fdd\u4e0e\u672c\u8f6e\u5de5\u5177\u8c03\u7528\u914d\u5bf9\u3002\n</code></pre>"},{"location":"zh/graph/#state","title":"\u5c06\u5de5\u5177\u7ed3\u679c\u5199\u5165 State","text":"<p>\u5728 Tools \u8282\u70b9\u4e4b\u540e\uff0c\u6dfb\u52a0\u4e00\u4e2a\u51fd\u6570\u8282\u70b9\uff0c\u4ece <code>graph.StateKeyMessages</code> \u6c47\u603b\u5de5\u5177\u7ed3\u679c\u5e76\u5199\u5165\u7ed3\u6784\u5316 State\uff1a</p> <pre><code>const stateKeyToolResults = \"tool_results\"\n\nsg.AddNode(\"collect_tool_results\", func(ctx context.Context, s graph.State) (any, error) {\n    msgs, _ := s[graph.StateKeyMessages].([]model.Message)\n    if len(msgs) == 0 { return nil, nil }\n\n    // \u5b9a\u4f4d\u672c\u8f6e assistant(tool_calls)\n    i := len(msgs) - 1\n    for i &gt;= 0 &amp;&amp; !(msgs[i].Role == model.RoleAssistant &amp;&amp; len(msgs[i].ToolCalls) &gt; 0) {\n        if msgs[i].Role == model.RoleUser { // \u65b0\u4e00\u8f6e\uff0c\u505c\u6b62\n            return nil, nil\n        }\n        i--\n    }\n    if i &lt; 0 { return nil, nil }\n\n    // \u6536\u96c6\u5339\u914d\u7684\u5de5\u5177\u56de\u590d\uff08\u6309 ToolID \u914d\u5bf9\uff09\n    idset := map[string]bool{}\n    for _, tc := range msgs[i].ToolCalls { idset[tc.ID] = true }\n    results := map[string]string{}\n    for j := i + 1; j &lt; len(msgs); j++ {\n        m := msgs[j]\n        if m.Role == model.RoleTool &amp;&amp; idset[m.ToolID] {\n            results[m.ToolName] = m.Content // \u5185\u5bb9\u53ef\u80fd\u4e3a JSON/\u6587\u672c\uff0c\u4f9d\u5de5\u5177\u5b9a\u4e49\u51b3\u5b9a\n        }\n        if m.Role == model.RoleUser { break }\n    }\n    if len(results) == 0 { return nil, nil }\n    return graph.State{stateKeyToolResults: results}, nil\n})\n</code></pre> <p>\u53c2\u8003\u793a\u4f8b\uff1a<code>examples/graph/io_conventions_tools</code>\u3002</p> <pre><code>#### Agent \u8282\u70b9\n\u5d4c\u5165\u5b50 Agent\uff0c\u5b9e\u73b0\u591a Agent \u534f\u4f5c\uff1a\n\n```go\nimport (\n    \"trpc.group/trpc-go/trpc-agent-go/agent\"\n    \"trpc.group/trpc-go/trpc-agent-go/agent/graphagent\"\n)\n\nconst (\n    subAgentNameAnalyzer = \"analyzer\"\n    graphAgentNameMain   = \"main\"\n)\n\n// \u91cd\u8981\uff1a\u8282\u70b9 ID \u5fc5\u987b\u4e0e\u5b50 Agent \u540d\u79f0\u4e00\u81f4\nsg.AddAgentNode(subAgentNameAnalyzer)\n\n// Agent \u5b9e\u4f8b\u5728 GraphAgent \u521b\u5efa\u65f6\u6ce8\u5165\nanalyzer := createAnalyzer()  // \u5185\u90e8 Agent \u540d\u79f0\u5fc5\u987b\u662f \"analyzer\"\ngraphAgent, _ := graphagent.New(graphAgentNameMain, g,\n    graphagent.WithSubAgents([]agent.Agent{analyzer}))\n</code></pre>"},{"location":"zh/graph/#_17","title":"\u8fb9\u4e0e\u8def\u7531","text":"<p>\u8fb9\u5b9a\u4e49\u4e86\u8282\u70b9\u95f4\u7684\u6267\u884c\u6d41\u8f6c\uff1a</p> <pre><code>import (\n    \"context\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/graph\"\n)\n\nconst (\n    nodeA         = \"nodeA\"\n    nodeB         = \"nodeB\"\n    nodeDecision  = \"decision\"\n    nodePathA     = \"pathA\"\n    nodePathB     = \"pathB\"\n\n    routeToPathA  = \"route_to_pathA\"\n    routeToPathB  = \"route_to_pathB\"\n    stateKeyFlag  = \"flag\"\n)\n\n// \u666e\u901a\u8fb9\uff1a\u987a\u5e8f\u6267\u884c\nsg.AddEdge(nodeA, nodeB)\n\n// \u6761\u4ef6\u8fb9\uff1a\u52a8\u6001\u8def\u7531\uff08\u7b2c\u4e09\u4e2a\u53c2\u6570\u4e3a\u8def\u5f84\u6620\u5c04\uff0c\u5efa\u8bae\u663e\u5f0f\u63d0\u4f9b\u4ee5\u505a\u9759\u6001\u6821\u9a8c\uff09\n// \u5148\u5b9a\u4e49\u76ee\u6807\u8282\u70b9\nsg.AddNode(nodePathA, handlerA)\nsg.AddNode(nodePathB, handlerB)\n// \u518d\u6dfb\u52a0\u6761\u4ef6\u8def\u7531\nsg.AddConditionalEdges(nodeDecision,\n    func(ctx context.Context, s graph.State) (string, error) {\n        if s[stateKeyFlag].(bool) {\n            return routeToPathA, nil\n        }\n        return routeToPathB, nil\n    }, map[string]string{\n        routeToPathA: nodePathA,\n        routeToPathB: nodePathB,\n    })\n\n// \u5de5\u5177\u6761\u4ef6\u8fb9\uff1a\u5904\u7406 LLM \u5de5\u5177\u8c03\u7528\nconst (\n    nodeLLM      = \"llm\"\n    nodeToolsUse = \"tools\"\n    nodeFallback = \"fallback\"\n)\nsg.AddToolsConditionalEdges(nodeLLM, nodeToolsUse, nodeFallback)\n\n// \u5e76\u884c\u8fb9\uff1a\u81ea\u52a8\u5e76\u884c\u6267\u884c\nconst (\n    nodeSplit   = \"split\"\n    nodeBranch1 = \"branch1\"\n    nodeBranch2 = \"branch2\"\n)\nsg.AddEdge(nodeSplit, nodeBranch1)\nsg.AddEdge(nodeSplit, nodeBranch2)  // branch1 \u548c branch2 \u4f1a\u5e76\u884c\u6267\u884c\n</code></pre> <p>\u63d0\u793a\uff1a\u8bbe\u7f6e\u5165\u53e3\u4e0e\u7ed3\u675f\u70b9\u65f6\uff0c\u4f1a\u9690\u5f0f\u8fde\u63a5\u5230\u865a\u62df\u7684 Start/End \u8282\u70b9\uff1a</p> <ul> <li><code>SetEntryPoint(\"first\")</code> \u7b49\u6548\u4e8e\u521b\u5efa <code>Start -&gt; first</code> \u7684\u8fde\u8fb9\uff1b</li> <li><code>SetFinishPoint(\"last\")</code> \u7b49\u6548\u4e8e\u521b\u5efa <code>last -&gt; End</code> \u7684\u8fde\u8fb9\u3002   \u65e0\u9700\u663e\u5f0f\u6dfb\u52a0\u8fd9\u4e24\u6761\u8fb9\u3002</li> </ul> <p>\u5e38\u91cf\u540d\uff1a<code>graph.Start == \"__start__\"</code>\uff0c<code>graph.End == \"__end__\"</code>\u3002</p>"},{"location":"zh/graph/#_18","title":"\u6d88\u606f\u53ef\u89c1\u6027\u9009\u9879","text":"<p>\u5f53\u524dAgent\u53ef\u5728\u9700\u8981\u65f6\u6839\u636e\u4e0d\u540c\u573a\u666f\u63a7\u5236\u5176\u5bf9\u5176\u4ed6Agent\u751f\u6210\u7684\u6d88\u606f\u4ee5\u53ca\u5386\u53f2\u4f1a\u8bdd\u6d88\u606f\u7684\u53ef\u89c1\u6027\u8fdb\u884c\u7ba1\u7406\uff0c\u53ef\u901a\u8fc7\u76f8\u5173\u9009\u9879\u914d\u7f6e\u8fdb\u884c\u7ba1\u7406\u3002 \u5728\u4e0emodel\u4ea4\u4e92\u65f6\u4ec5\u5c06\u53ef\u89c1\u7684\u5185\u5bb9\u8f93\u5165\u7ed9\u6a21\u578b\u3002 </p> <p>TIPS:  - \u4e0d\u540csessionID\u7684\u6d88\u606f\u5728\u4efb\u4f55\u573a\u666f\u4e0b\u90fd\u662f\u4e92\u4e0d\u53ef\u89c1\u7684\uff0c\u4ee5\u4e0b\u7ba1\u63a7\u7b56\u7565\u5747\u9488\u5bf9\u540c\u4e00\u4e2asessionID\u7684\u6d88\u606f  - Invocation.Message\u5728\u4efb\u4f55\u573a\u666f\u4e0b\u5747\u53ef\u89c1  - \u76f8\u5173\u914d\u7f6e\u4ec5\u63a7\u5236State[graph.StateKeyMessages]\u7684\u521d\u59cb\u503c  - Agent node\u751f\u6210\u7684\u6d88\u606ffilterKey\u4e3asubAgent name, \u56e0\u6b64\u4f7f\u7528<code>IsolatedRequest</code>\u6216<code>IsolatedInvocation</code>\u8fc7\u6ee4\u65f6\u5bf9\u5f53\u524dgraphAgent\u4e0d\u53ef\u89c1  - \u672a\u914d\u7f6e\u9009\u9879\u65f6\uff0c\u9ed8\u8ba4\u503c\u4e3aFullContext</p> <p>\u914d\u7f6e: - <code>graphagent.WithMessageFilterMode(MessageFilterMode)</code>:   - <code>FullContext</code>: \u6240\u6709\u80fd\u901a\u8fc7filterKey\u505a\u524d\u7f00\u5339\u914d\u7684\u6d88\u606f   - <code>RequestContext</code>: \u4ec5\u5305\u542b\u5f53\u524d\u8bf7\u6c42\u5468\u671f\u5185\u901a\u8fc7filterKey\u524d\u7f00\u5339\u914d\u7684\u6d88\u606f   - <code>IsolatedRequest</code>: \u4ec5\u5305\u542b\u5f53\u524d\u8bf7\u6c42\u5468\u671f\u5185\u901a\u8fc7filterKey\u5b8c\u5168\u5339\u914d\u7684\u6d88\u606f   - <code>IsolatedInvocation</code>: \u4ec5\u5305\u542b\u5f53\u524dinvocation\u5468\u671f\u5185\u901a\u8fc7filterKey\u5b8c\u5168\u5339\u914d\u7684\u6d88\u606f</p> <p>\u63a8\u8350\u7528\u6cd5\u793a\u4f8b\uff08\u8be5\u7528\u6cd5\u4ec5\u57fa\u4e8e\u9ad8\u9636\u7528\u6cd5\u57fa\u7840\u4e4b\u4e0a\u505a\u4e86\u914d\u7f6e\u7b80\u5316\uff09: </p> <p>\u6848\u4f8b1: \u5bf9graphAgent\u6d88\u606f\u53ef\u89c1\u6027\u63a7\u5236 <pre><code>subgraphAgentA := graphagent.New(\n    \"subgraphA\", subgraph,\n    // \u5bf9parentAgent\u3001subgraphAgentA\u3001subgraphAgentB(\u5305\u542btask1\u3001task2\u5206\u522b\u751f\u6210\u7684\u6d88\u606f) \u751f\u6210\u7684\u6240\u6709\u6d88\u606f\u53ef\u89c1\uff08\u5305\u542b\u540c\u4e00sessionID\u7684\u5386\u53f2\u4f1a\u8bdd\u6d88\u606f\uff09\n    graphagent.WithMessageFilterMode(graphagent.FullContext),\n    // \u5bf9parentAgent\u3001subgraphAgentA\u3001subgraphAgentB(\u5305\u542btask1\u3001task2\u5206\u522b\u751f\u6210\u7684\u6d88\u606f) \u5f53\u524drunner.Run\u671f\u95f4\u751f\u6210\u7684\u6240\u6709\u6d88\u606f\u53ef\u89c1\uff08\u4e0d\u5305\u542b\u5386\u53f2\u4f1a\u8bdd\u6d88\u606f\uff09\n    graphagent.WithMessageFilterMode(graphagent.RequestContext),\n    // \u4ec5\u5bf9subgraphAgentA \u5f53\u524drunner.Run\u671f\u95f4\u751f\u6210\u7684\u6d88\u606f\u53ef\u89c1\uff08\u4e0d\u5305\u542b\u81ea\u5df1\u7684\u5386\u53f2\u4f1a\u8bdd\u6d88\u606f\uff09\n    graphagent.WithMessageFilterMode(graphagent.IsolatedRequest),\n    // \u4ec5\u5bf9subgraphAgentA\u5f53\u524dinvocation\u671f\u95f4\u751f\u6210\u7684\u6d88\u606f\u53ef\u89c1(\u6b64\u793a\u4f8b\u4e2dsubgraphAgentA\u4ec5\u6267\u884c\u4e00\u6b21\uff0c \u6548\u679c\u7b49\u4ef7\u4e8egraphagent.IsolatedRequest)\n    graphagent.WithMessageFilterMode(graphagent.IsolatedInvocation),\n)\n\nsubgraphAgentB := graphagent.New(\n    \"subgraphB\", subgraph,\n    // \u5bf9parentAgent\u3001subgraphAgentA\u3001subgraphAgentB(\u5305\u542btask1\u3001task2\u5206\u522b\u751f\u6210\u7684\u6d88\u606f) \u751f\u6210\u7684\u6240\u6709\u6d88\u606f\u53ef\u89c1\uff08\u5305\u542b\u540c\u4e00sessionID\u7684\u5386\u53f2\u4f1a\u8bdd\u6d88\u606f\uff09\n    graphagent.WithMessageFilterMode(graphagent.FullContext),\n    // \u5bf9parentAgent\u3001subgraphAgentA\u3001subgraphAgentB(\u5305\u542btask1\u3001task2\u5206\u522b\u751f\u6210\u7684\u6d88\u606f) \u5f53\u524drunner.Run\u671f\u95f4\u751f\u6210\u7684\u6240\u6709\u6d88\u606f\u53ef\u89c1\uff08\u4e0d\u5305\u542b\u5386\u53f2\u4f1a\u8bdd\u6d88\u606f\uff09\n    graphagent.WithMessageFilterMode(graphagent.RequestContext),\n    // \u4ec5\u5bf9subgraphAgentB\uff08\u5305\u542btask1\u3001task2\u5206\u522b\u751f\u6210\u7684\u6d88\u606f\uff09\u5f53\u524drunner.Run\u671f\u95f4\u751f\u6210\u7684\u6d88\u606f\u53ef\u89c1\uff08\u4e0d\u5305\u542b\u81ea\u5df1\u7684\u5386\u53f2\u4f1a\u8bdd\u6d88\u606f\uff09\n    graphagent.WithMessageFilterMode(graphagent.IsolatedRequest),\n    // \u4ec5\u5bf9subgraphAgentB \u5f53\u524dInvocation\u4e2d\u751f\u6210\u7684\u6d88\u606f\u53ef\u89c1\uff0c\u4e0d\u5305\u542b\u5386\u53f2\u6d88\u606f\uff08task1\u4e0etask2\u6267\u884c\u671f\u95f4\u751f\u6210\u7684\u6d88\u606f\u4e92\u4e0d\u53ef\u89c1\uff09\u3002\n    graphagent.WithMessageFilterMode(graphagent.IsolatedInvocation),\n)\n\nsg.AddAgentNode(\"subgraphA\")\nsg.AddNode(\"fanout\", func(ctx context.Context, state graph.State) (any, error) {\n    return []*graph.Command{\n        {\n            GoTo: \"subgraph\",\n            Update: graph.State{\n                \"task\": \"task 1\"\n            },\n        },\n        {\n            GoTo: \"subgraph\",\n            Update: graph.State{\n                \"task\": \"task 2\"\n            },\n        },\n    }, nil\n})\nsg.AddAgentNode(\"subgraphB\")\nsg.AddEdge(\"subgraphA\", \"fanout\")\nsg.SetEntryPoint(subgraphA)\ngraph, err := sg.Compile()\nif err != nil {\n    log.Fatalf(\"Failed to Compile state graph, err: %w\", err)\n}\nparentAgent := graphagent.New(\n    \"subgraph\", graph,\n    // subagent\n    graphagent.WithSubAgents(subgraphAgent)\n)\n</code></pre></p> <p>\u6848\u4f8b2: \u5bf9\u8282\u70b9Agent\u6d88\u606f\u53ef\u89c1\u6027\u63a7\u5236 <pre><code>taskagentA := llmagent.New(\n  \"taskagentA\",\n  llmagent.WithModel(modelInstance),\n  // \u5bf9taskagentA\u3001taskagentB\u751f\u6210\u7684\u6240\u6709\u6d88\u606f\u53ef\u89c1\uff08\u5305\u542b\u540c\u4e00sessionID\u7684\u5386\u53f2\u4f1a\u8bdd\u6d88\u606f\uff09\n  llmagent.WithMessageFilterMode(llmagent.FullContext),\n  // \u5bf9taskagentA\u3001taskagentB\u5f53\u524drunner.Run\u671f\u95f4\u751f\u6210\u7684\u6240\u6709\u6d88\u606f\u53ef\u89c1\uff08\u4e0d\u5305\u542b\u5386\u53f2\u4f1a\u8bdd\u6d88\u606f\uff09\n  llmagent.WithMessageFilterMode(llmagent.RequestContext),\n  // \u4ec5\u5bf9taskagentA\u5f53\u524drunner.Run\u671f\u95f4\u751f\u6210\u7684\u6d88\u606f\u53ef\u89c1\uff08\u4e0d\u5305\u542b\u81ea\u5df1\u7684\u5386\u53f2\u4f1a\u8bdd\u6d88\u606f\uff09\n  llmagent.WithMessageFilterMode(llmagent.IsolatedRequest),\n  // agent\u6267\u6027\u987a\u5e8f\uff1ataskagentA-invocation1 -&gt; taskagentB-invocation2 -&gt; taskagentA-invocation3(\u5f53\u524d\u6267\u884c\u9636\u6bb5)\n  // \u4ec5\u5bf9taskagentA\u5f53\u524dtaskagentA-invocation3\u671f\u95f4\u751f\u6210\u7684\u6d88\u606f\u53ef\u89c1\uff08\u4e0d\u5305\u542b\u81ea\u5df1\u7684\u5386\u53f2\u4f1a\u8bdd\u6d88\u606f\u4ee5\u53cataskagentA-invocation1\u671f\u95f4\u751f\u6210\u7684\u6d88\u606f\uff09\n  llmagent.WithMessageFilterMode(llmagent.IsolatedInvocation),\n)\n\ntaskagentB := llmagent.New(\n  \"taskagentB\",\n  llmagent.WithModel(modelInstance),\n  // \u5bf9taskagentA\u3001taskagentB\u751f\u6210\u7684\u6240\u6709\u6d88\u606f\u53ef\u89c1\uff08\u5305\u542b\u540c\u4e00sessionID\u7684\u5386\u53f2\u4f1a\u8bdd\u6d88\u606f\uff09\n  llmagent.WithMessageFilterMode(llmagent.FullContext),\n  // \u5bf9taskagentA\u3001taskagentB\u5f53\u524drunner.Run\u671f\u95f4\u751f\u6210\u7684\u6240\u6709\u6d88\u606f\u53ef\u89c1\uff08\u4e0d\u5305\u542b\u5386\u53f2\u4f1a\u8bdd\u6d88\u606f\uff09\n  llmagent.WithMessageFilterMode(llmagent.RequestContext),\n  // \u4ec5\u5bf9taskagentB\u5f53\u524drunner.Run\u671f\u95f4\u751f\u6210\u7684\u6d88\u606f\u53ef\u89c1\uff08\u4e0d\u5305\u542b\u81ea\u5df1\u7684\u5386\u53f2\u4f1a\u8bdd\u6d88\u606f\uff09\n  llmagent.WithMessageFilterMode(llmagent.IsolatedRequest),\n  // agent\u6267\u6027\u987a\u5e8f\uff1ataskagentA-invocation1 -&gt; taskagentB-invocation2 -&gt; taskagentA-invocation3 -&gt; taskagentB-invocation4(\u5f53\u524d\u6267\u884c\u9636\u6bb5)\n  // \u4ec5\u5bf9taskagentB\u5f53\u524dtaskagentB-invocation4\u671f\u95f4\u751f\u6210\u7684\u6d88\u606f\u53ef\u89c1\uff08\u4e0d\u5305\u542b\u81ea\u5df1\u7684\u5386\u53f2\u4f1a\u8bdd\u6d88\u606f\u4ee5\u53cataskagentB-invocation2\u671f\u95f4\u751f\u6210\u7684\u6d88\u606f\uff09\n  llmagent.WithMessageFilterMode(llmagent.IsolatedInvocation),\n)\n\nsg.AddAgentNode(\"taskagentA\")\n// \u540c\u4e00\u4e2a\u5e76\u884c\u6267\u884c\u591a\u4e2a\u4efb\u52a1\nsg.AddNode(\"fanout\", func(ctx context.Context, state graph.State) (any, error) {\n    return []*graph.Command{\n        {\n            GoTo: \"taskB\",\n            Update: graph.State{\n                \"task\": \"task 1\"\n            },\n        },\n        {\n            GoTo: \"taskB\",\n            Update: graph.State{\n                \"task\": \"task 2\"\n            },\n        },\n    }, nil\n})\n// \u53ef\u5c06taskagentB\u7684\u6d88\u606f\u8fc7\u6ee4\u6a21\u5f0f\u8bbe\u7f6e\u4e3allmagent.IsolatedInvocation \u4ee5\u6b64\u6765\u9694\u79bb\u591a\u4efb\u52a1\u7684\u4e0a\u4e0b\u6587\u4f1a\u8bdd\u4fe1\u606f\nsg.AddNode(\"taskB\", func(ctx context.Context, state graph.State) (any, error){\n    task := state[\"task-id\"]\n    inv, _ := agent.InvocationFromContext(ctx)\n    inv.Message = model.NewUserMessage(task)\n    chan, err := taskagentB.Run(ctx, inv)\n    // do any thing\n})\n</code></pre></p> <p>\u9ad8\u9636\u7528\u6cd5\u793a\u4f8b\uff1a \u53ef\u4ee5\u5355\u72ec\u901a\u8fc7 <code>WithMessageTimelineFilterMode</code>\u3001<code>WithMessageBranchFilterMode</code>\u63a7\u5236\u5f53\u524dagent\u5bf9\u5386\u53f2\u6d88\u606f\u4e0e\u5176\u4ed6agent\u751f\u6210\u7684\u6d88\u606f\u53ef\u89c1\u6027\u3002 \u5f53\u524dagent\u5728\u4e0e\u6a21\u578b\u4ea4\u4e92\u65f6\uff0c\u6700\u7ec8\u5c06\u540c\u65f6\u6ee1\u8db3\u4e24\u4e2a\u6761\u4ef6\u7684\u6d88\u606f\u8f93\u5165\u7ed9\u6a21\u578b\u3002</p> <p><code>\u914d\u7f6e:</code> - <code>WithMessageTimelineFilterMode</code>: \u65f6\u95f4\u7ef4\u5ea6\u53ef\u89c1\u6027\u63a7\u5236   - <code>TimelineFilterAll</code>: \u5305\u542b\u5386\u53f2\u6d88\u606f\u4ee5\u53ca\u5f53\u524d\u8bf7\u6c42\u4e2d\u6240\u751f\u6210\u7684\u6d88\u606f   - <code>TimelineFilterCurrentRequest</code>: \u4ec5\u5305\u542b\u5f53\u524d\u8bf7\u6c42(\u4e00\u6b21runner.Run\u4e3a\u4e00\u6b21\u8bf7\u6c42)\u4e2d\u6240\u751f\u6210\u7684\u6d88\u606f   - <code>TimelineFilterCurrentInvocation</code>: \u4ec5\u5305\u542b\u5f53\u524dinvocation\u4e0a\u4e0b\u6587\u4e2d\u751f\u6210\u7684\u6d88\u606f - <code>WithMessageBranchFilterMode</code>: \u5206\u652f\u7ef4\u5ea6\u53ef\u89c1\u6027\u63a7\u5236\uff08\u7528\u4e8e\u63a7\u5236\u5bf9\u5176\u4ed6agent\u751f\u6210\u6d88\u606f\u7684\u53ef\u89c1\u6027\uff09   - <code>BranchFilterModePrefix</code>: \u901a\u8fc7Event.FilterKey\u4e0eInvocation.eventFilterKey\u505a\u524d\u7f00\u5339\u914d   - <code>BranchFilterModeAll</code>: \u6240\u6709agent\u7684\u5747\u6d88\u606f   - <code>BranchFilterModeExact</code>: \u4ec5\u81ea\u5df1\u751f\u6210\u7684\u6d88\u606f\u53ef\u89c1</p> <pre><code>llmAgent := llmagent.New(\n    \"demo-agent\",                      // Agent \u540d\u79f0\n    llmagent.WithModel(modelInstance), // \u8bbe\u7f6e\u6a21\u578b\n    llmagent.WithDescription(\"A helpful AI assistant for demonstrations\"),              // \u8bbe\u7f6e\u63cf\u8ff0\n    llmagent.WithInstruction(\"Be helpful, concise, and informative in your responses\"), // \u8bbe\u7f6e\u6307\u4ee4\n    llmagent.WithGenerationConfig(genConfig),                                           // \u8bbe\u7f6e\u751f\u6210\u53c2\u6570\n\n    // \u8bbe\u7f6e\u4f20\u7ed9\u6a21\u578b\u7684\u6d88\u606f\u8fc7\u6ee4\u6a21\u5f0f\uff0c\u6700\u7ec8\u4f20\u7ed9\u6a21\u578b\u7684\u6d88\u606f\u9700\u540c\u65f6\u6ee1\u8db3WithMessageTimelineFilterMode\u4e0eWithMessageBranchFilterMode\u6761\u4ef6\n    // \u65f6\u95f4\u7ef4\u5ea6\u8fc7\u6ee4\u6761\u4ef6\n    // \u9ed8\u8ba4\u503c: llmagent.TimelineFilterAll\n    // \u53ef\u9009\u503c:\n    //  - llmagent.TimelineFilterAll: \u5305\u542b\u5386\u53f2\u6d88\u606f\u4ee5\u53ca\u5f53\u524d\u8bf7\u6c42\u4e2d\u6240\u751f\u6210\u7684\u6d88\u606f\n    //  - llmagent.TimelineFilterCurrentRequest: \u4ec5\u5305\u542b\u5f53\u524d\u8bf7\u6c42\u4e2d\u6240\u751f\u6210\u7684\u6d88\u606f\n    //  - llmagent.TimelineFilterCurrentInvocation: \u4ec5\u5305\u542b\u5f53\u524dinvocation\u4e0a\u4e0b\u6587\u4e2d\u751f\u6210\u7684\u6d88\u606f\n    llmagent.WithMessageTimelineFilterMode(llmagent.BranchFilterModeAll),\n    // \u5206\u652f\u7ef4\u5ea6\u8fc7\u6ee4\u6761\u4ef6\n    // \u9ed8\u8ba4\u503c: llmagent.BranchFilterModePrefix\n    // \u53ef\u9009\u503c:\n    //  - llmagent.BranchFilterModeAll: \u5305\u542b\u6240\u6709agent\u7684\u6d88\u606f, \u5f53\u524dagent\u4e0e\u6a21\u578b\u4ea4\u4e92\u65f6,\u5982\u9700\u5c06\u6240\u6709agent\u751f\u6210\u7684\u6709\u6548\u5185\u5bb9\u6d88\u606f\u540c\u6b65\u7ed9\u6a21\u578b\u65f6\u53ef\u8bbe\u7f6e\u8be5\u503c\n    //  - llmagent.BranchFilterModePrefix: \u901a\u8fc7Event.FilterKey\u4e0eInvocation.eventFilterKey\u505a\u524d\u7f00\u5339\u914d\u8fc7\u6ee4\u6d88\u606f, \u671f\u671b\u5c06\u4e0e\u5f53\u524dagent\u4ee5\u53ca\u76f8\u5173\u4e0a\u4e0b\u6e38agent\u751f\u6210\u7684\u6d88\u606f\u4f20\u9012\u7ed9\u6a21\u578b\u65f6\uff0c\u53ef\u8bbe\u7f6e\u8be5\u503c\n    //  - llmagent.BranchFilterModeExact: \u901a\u8fc7Event.FilterKey==Invocation.eventFilterKey\u8fc7\u6ee4\u6d88\u606f\uff0c\u5f53\u524dagent\u4e0e\u6a21\u578b\u4ea4\u4e92\u65f6,\u4ec5\u9700\u4f7f\u7528\u5f53\u524dagent\u751f\u6210\u7684\u6d88\u606f\u65f6\u53ef\u8bbe\u7f6e\u8be5\u503c\n    llmagent.WithMessageBranchFilterMode(llmagent.TimelineFilterAll),\n)\n</code></pre>"},{"location":"zh/graph/#fan-out","title":"\u547d\u4ee4\u6a21\u5f0f\uff08\u52a8\u6001\u8def\u7531 / Fan-out\uff09","text":"<p>\u8282\u70b9\u9664\u8fd4\u56de <code>graph.State</code> \u5916\uff0c\u4e5f\u53ef\u4ee5\u8fd4\u56de <code>*graph.Command</code> \u6216 <code>[]*graph.Command</code>\uff0c\u4ee5\u540c\u65f6\u66f4\u65b0\u72b6\u6001\u5e76\u6307\u5b9a\u4e0b\u4e00\u8df3\uff1a</p> <pre><code>// \u52a8\u6001\u8def\u7531\u5230 A \u6216 B\uff0c\u5e76\u5199\u5165\u72b6\u6001\nconst (\n    nodeDecide   = \"decide\"\n    nodeA        = \"A\"\n    nodeB        = \"B\"\n    stateKeyFlag = \"flag\"\n)\n\nsg.AddNode(nodeDecide, func(ctx context.Context, s graph.State) (any, error) {\n    if s[stateKeyFlag].(bool) {\n        return &amp;graph.Command{Update: graph.State{\"routed\": nodeA}, GoTo: nodeA}, nil\n    }\n    return &amp;graph.Command{Update: graph.State{\"routed\": nodeB}, GoTo: nodeB}, nil\n})\n\n// Fan-out\uff1a\u5e76\u884c\u6d3e\u53d1\u591a\u4e2a\u4efb\u52a1\u5230\u540c\u4e00 worker\nconst (\n    nodeFanout = \"fanout\"\n    nodeWorker = \"worker\"\n)\nsg.AddNode(nodeFanout, func(ctx context.Context, s graph.State) (any, error) {\n    cmds := []*graph.Command{\n        {Update: graph.State{\"param\": \"A\"}, GoTo: nodeWorker},\n        {Update: graph.State{\"param\": \"B\"}, GoTo: nodeWorker},\n        {Update: graph.State{\"param\": \"C\"}, GoTo: nodeWorker},\n    }\n    return cmds, nil\n})\n</code></pre> <p>\u4f7f\u7528\u547d\u4ee4\u6a21\u5f0f\u8fdb\u884c\u8def\u7531\u65f6\uff0c\u65e0\u9700\u4e3a <code>GoTo</code> \u76ee\u6807\u6dfb\u52a0\u663e\u5f0f\u9759\u6001\u8fb9\uff1b\u4ec5\u9700\u4fdd\u8bc1\u76ee\u6807\u8282\u70b9\u5b58\u5728\uff0c\u5e76\u5728\u9700\u8981\u4f5c\u4e3a\u7ec8\u70b9\u65f6\u8bbe\u7f6e <code>SetFinishPoint</code>\u3002</p>"},{"location":"zh/graph/#_19","title":"\u67b6\u6784\u8bbe\u8ba1","text":""},{"location":"zh/graph/#_20","title":"\u6574\u4f53\u67b6\u6784","text":"<p>GraphAgent \u7684\u67b6\u6784\u8bbe\u8ba1\u4f53\u73b0\u4e86\u6211\u4eec\u5bf9\u590d\u6742\u7cfb\u7edf\u7684\u7406\u89e3\uff1a\u901a\u8fc7\u6e05\u6670\u7684\u5206\u5c42\u6765\u7ba1\u7406\u590d\u6742\u6027\u3002\u6bcf\u4e00\u5c42\u90fd\u6709\u660e\u786e\u7684\u804c\u8d23\uff0c\u5c42\u4e0e\u5c42\u4e4b\u95f4\u901a\u8fc7\u6807\u51c6\u63a5\u53e3\u901a\u4fe1\u3002</p> <pre><code>flowchart TB\n    subgraph \"Runner Layer\"\n        R[Runner]:::runnerClass\n        S[Session Service]:::sessionClass\n    end\n\n    subgraph \"GraphAgent\"\n        GA[GraphAgent Wrapper]:::agentClass\n        CB[Callbacks]:::callbackClass\n    end\n\n    subgraph \"Graph Engine\"\n        SG[StateGraph Builder]:::builderClass\n        G[Graph]:::graphClass\n        E[Executor]:::executorClass\n    end\n\n    subgraph \"Execution Components\"\n        P[Planning]:::phaseClass\n        EX[Execution]:::phaseClass\n        U[Update]:::phaseClass\n    end\n\n    subgraph \"Storage\"\n        CP[Checkpoint]:::storageClass\n        ST[State Store]:::storageClass\n    end\n\n    R --&gt; GA\n    GA --&gt; G\n    G --&gt; E\n    E --&gt; P\n    E --&gt; EX\n    E --&gt; U\n    E --&gt; CP\n\n    classDef runnerClass fill:#e8f5e9,stroke:#43a047,stroke-width:2px\n    classDef sessionClass fill:#f3e5f5,stroke:#8e24aa,stroke-width:2px\n    classDef agentClass fill:#e3f2fd,stroke:#1976d2,stroke-width:2px\n    classDef callbackClass fill:#fce4ec,stroke:#c2185b,stroke-width:2px\n    classDef builderClass fill:#fff8e1,stroke:#f57c00,stroke-width:2px\n    classDef graphClass fill:#f1f8e9,stroke:#689f38,stroke-width:2px\n    classDef executorClass fill:#e0f2f1,stroke:#00796b,stroke-width:2px\n    classDef phaseClass fill:#ede7f6,stroke:#512da8,stroke-width:2px\n    classDef storageClass fill:#efebe9,stroke:#5d4037,stroke-width:2px</code></pre>"},{"location":"zh/graph/#_21","title":"\u6838\u5fc3\u6a21\u5757\u89e3\u6790","text":"<p>\u6838\u5fc3\u7ec4\u4ef6\u4e00\u89c8\uff1a</p> <p><code>graph/state_graph.go</code> - StateGraph \u6784\u5efa\u5668 \u63d0\u4f9b\u94fe\u5f0f\u58f0\u660e\u5f0f Go API \u6765\u6784\u5efa\u56fe\u7ed3\u6784\uff0c\u901a\u8fc7 fluent \u65b9\u6cd5\u94fe\uff08AddNode \u2192 AddEdge \u2192 Compile\uff09\u5b9a\u4e49\u8282\u70b9\u3001\u8fb9\u548c\u6761\u4ef6\u8def\u7531\u3002</p> <p><code>graph/graph.go</code> - \u7f16\u8bd1\u540e\u7684\u8fd0\u884c\u65f6 \u5b9e\u73b0\u57fa\u4e8e\u901a\u9053\uff08Channel\uff09\u7684\u4e8b\u4ef6\u89e6\u53d1\u5f0f\u6267\u884c\u673a\u5236\u3002\u8282\u70b9\u6267\u884c\u7ed3\u679c\u5408\u5e76\u5165 State\uff1b\u901a\u9053\u4ec5\u7528\u4e8e\u89e6\u53d1\u8def\u7531\uff0c\u5199\u5165\u54e8\u5175\u503c\uff08sentinel value\uff09\u800c\u975e\u4e1a\u52a1\u6570\u636e\u3002</p> <p><code>graph/executor.go</code> - BSP \u6267\u884c\u5668 \u8fd9\u662f\u7cfb\u7edf\u5fc3\u810f\uff0c\u501f\u9274\u4e86 Google Pregel \u8bba\u6587\u3002\u5b9e\u73b0 BSP\uff08Bulk Synchronous Parallel\uff09\u98ce\u683c\u7684\u4e09\u9636\u6bb5\u5faa\u73af\uff1aPlanning \u2192 Execution \u2192 Update\u3002</p> <p><code>graph/checkpoint/*</code> - \u68c0\u67e5\u70b9\u548c\u6062\u590d\u673a\u5236 \u63d0\u4f9b\u53ef\u9009\u7684\u68c0\u67e5\u70b9\u6301\u4e45\u5316\uff08\u5982 sqlite\uff09\uff0c\u539f\u5b50\u4fdd\u5b58\u72b6\u6001\u4e0e\u5f85\u5199\u5165\u52a8\u4f5c\uff0c\u652f\u6301\u6309\u8c31\u7cfb/\u68c0\u67e5\u70b9\u6062\u590d\u3002</p> <p><code>agent/graphagent/graph_agent.go</code> - Graph \u4e0e Agent \u7684\u6865\u6881 \u5c06\u7f16\u8bd1\u540e\u7684 Graph \u9002\u914d\u4e3a\u901a\u7528 Agent\uff0c\u53ef\u590d\u7528\u4f1a\u8bdd\u3001\u56de\u8c03\u4e0e\u4e8b\u4ef6\u6d41\u3002</p>"},{"location":"zh/graph/#_22","title":"\u6267\u884c\u6a21\u578b","text":"<p>GraphAgent \u501f\u9274\u4e86 Google Pregel \u7684 BSP\uff08Bulk Synchronous Parallel\uff09\u6a21\u578b\uff0c\u4f46\u9002\u914d\u5230\u4e86\u5355\u8fdb\u7a0b\u73af\u5883\uff1b\u5728\u6b64\u57fa\u7840\u4e0a\u8fd8\u652f\u6301\u68c0\u67e5\u70b9\u3001HITL \u4e2d\u65ad/\u6062\u590d\u4e0e\u65f6\u95f4\u65c5\u884c\uff1a</p> <pre><code>sequenceDiagram\n    autonumber\n    participant R as Runner\n    participant GA as GraphAgent\n    participant EX as Executor\n    participant CK as Checkpoint Saver\n    participant DB as Storage\n    participant H as Human\n\n    R-&gt;&gt;GA: Run(invocation)\n    GA-&gt;&gt;EX: Execute(graph, state, options)\n    GA--&gt;&gt;R: Stream node/tool/model events\n\n    loop \u6bcf\u4e2a\u8d85\u7ea7\u6b65 (BSP)\n        EX-&gt;&gt;EX: Planning \u2014 \u8ba1\u7b97\u524d\u6cbf(Frontier)\n        par \u5e76\u884c\u6267\u884c\u8282\u70b9\n            EX-&gt;&gt;EX: \u6267\u884c\u8282\u70b9 i\uff08\u72b6\u6001\u6d45\u62f7\u8d1d\uff09\n            EX--&gt;&gt;GA: \u8282\u70b9\u5f00\u59cb\u4e8b\u4ef6(author=nodeID)\n        and\n            EX-&gt;&gt;EX: \u6267\u884c\u8282\u70b9 j\uff08\u72b6\u6001\u6d45\u62f7\u8d1d\uff09\n            EX--&gt;&gt;GA: \u8282\u70b9\u5f00\u59cb\u4e8b\u4ef6\n        end\n\n        alt \u8282\u70b9\u89e6\u53d1 Interrupt(key,prompt)\n            EX-&gt;&gt;CK: Save checkpoint(state,frontier,\n            EX-&gt;&gt;CK: pending_writes,versions_seen,reason=interrupt)\n            CK-&gt;&gt;DB: \u539f\u5b50\u63d0\u4ea4\n            EX--&gt;&gt;GA: interrupt \u4e8b\u4ef6(checkpoint_id,prompt)\n            GA--&gt;&gt;R: \u8f6c\u53d1\u4e2d\u65ad\u4e8b\u4ef6\u5e76\u6682\u505c\n            R-&gt;&gt;H: \u8bf7\u6c42\u4eba\u5de5\u8f93\u5165/\u5ba1\u6279\n            H--&gt;&gt;R: \u63d0\u4ea4\u51b3\u7b56/\u503c\n            R-&gt;&gt;GA: Run(resume) runtime_state{\n            R-&gt;&gt;GA: checkpoint_id,resume_map}\n            GA-&gt;&gt;EX: ResumeFromCheckpoint(checkpoint_id,resume_map)\n            EX-&gt;&gt;CK: Load checkpoint\n            CK-&gt;&gt;EX: state/frontier/pending_writes/versions_seen\n            EX-&gt;&gt;EX: \u91cd\u5efa\u524d\u6cbf\u5e76\u5e94\u7528\u6062\u590d\u503c\n        else \u6b63\u5e38\u6267\u884c\n            EX--&gt;&gt;GA: \u8282\u70b9\u5b8c\u6210\u4e8b\u4ef6\uff08\u542b tool/model \u4e8b\u4ef6\uff09\n            EX-&gt;&gt;EX: Update \u2014 Reducer \u5408\u5e76\u72b6\u6001\n            EX-&gt;&gt;CK: Save checkpoint(state,frontier,\n            EX-&gt;&gt;CK: pending_writes,versions_seen)\n            CK-&gt;&gt;DB: \u539f\u5b50\u63d0\u4ea4\n        end\n    end\n\n    Note over EX,CK: versions_seen \u907f\u514d\u91cd\u590d\u6267\u884c\uff1b\n    Note over EX,CK: pending_writes \u91cd\u5efa\u901a\u9053\uff1b\n    Note over EX,CK: parent_id \u5f62\u6210\u8c31\u7cfb\u4ee5\u652f\u6301\u65f6\u95f4\u65c5\u884c\n\n    opt \u65f6\u95f4\u65c5\u884c\uff08\u56de\u6eaf/\u5206\u652f\uff09\n        R-&gt;&gt;GA: Run(runtime_state{checkpoint_id})\n        GA-&gt;&gt;EX: ResumeFromCheckpoint(checkpoint_id)\n        EX-&gt;&gt;CK: Load checkpoint + lineage\n        CK-&gt;&gt;EX: \u6062\u590d\u72b6\u6001\u5e76\u53ef\u521b\u5efa\u65b0 lineage_id\n    end\n\n    EX--&gt;&gt;GA: done \u4e8b\u4ef6\uff08last_response\uff09\n    GA--&gt;&gt;R: \u8f93\u51fa\u6700\u7ec8\u6d88\u606f</code></pre> <pre><code>flowchart TB\n    %% \u6267\u884c\u5168\u666f\u56fe\uff08\u7cbe\u7b80\u8fde\u7ebf\uff09\n    subgraph Client\n        R[Runner]:::runner --&gt; GA[GraphAgent]:::agent\n    end\n\n    subgraph Engine[Graph Engine]\n        GA --&gt; EX[Executor]:::executor\n        subgraph BSP[\"BSP Superstep\"]\n            P[Planning]:::phase --&gt; X[Execution]:::phase --&gt; U[Update]:::phase\n        end\n    end\n\n    N[Nodes: LLM / Tools / Function / Agent]:::process\n    CK[(Checkpoint)]:::storage\n    H[Human]:::human\n\n    EX --&gt; BSP\n    EX --&gt; N\n    EX -.-&gt; CK\n    GA &lt;--&gt; H\n    GA --&gt; R\n\n    classDef runner fill:#e8f5e9,stroke:#43a047,stroke-width:2px\n    classDef agent fill:#e3f2fd,stroke:#1976d2,stroke-width:2px\n    classDef executor fill:#e0f2f1,stroke:#00796b,stroke-width:2px\n    classDef phase fill:#ede7f6,stroke:#512da8,stroke-width:2px\n    classDef process fill:#f3e5f5,stroke:#9c27b0,stroke-width:2px\n    classDef storage fill:#efebe9,stroke:#6d4c41,stroke-width:2px\n    classDef human fill:#e8f5e9,stroke:#43a047,stroke-width:2px</code></pre> <p>\u6267\u884c\u8fc7\u7a0b\u7684\u5173\u952e\u70b9\uff1a</p> <ol> <li>Planning Phase: \u57fa\u4e8e\u901a\u9053\u72b6\u6001\u786e\u5b9a\u672c\u6b65\u8981\u6267\u884c\u7684\u8282\u70b9</li> <li>Execution Phase: \u6bcf\u4e2a\u8282\u70b9\u83b7\u5f97\u72b6\u6001\u7684\u6d45\u62f7\u8d1d\uff08maps.Copy\uff09\uff0c\u5e76\u884c\u6267\u884c</li> <li>Update Phase: \u901a\u8fc7 Reducer \u5408\u5e76\u5404\u8282\u70b9\u7684\u72b6\u6001\u66f4\u65b0\uff0c\u4fdd\u8bc1\u5e76\u53d1\u5b89\u5168</li> </ol> <p>\u8fd9\u79cd\u8bbe\u8ba1\u8ba9\u6bcf\u4e00\u6b65\u90fd\u80fd\u88ab\u6e05\u6670\u89c2\u6d4b\u3001\u5b89\u5168\u4e2d\u65ad\u548c\u6062\u590d\u3002</p>"},{"location":"zh/graph/#_23","title":"\u8fd0\u884c\u6001\u9694\u79bb\u4e0e\u4e8b\u4ef6\u5feb\u7167","text":"<ul> <li>\u6267\u884c\u5668\uff08Executor\uff09\u53ef\u590d\u7528\u4e14\u5e76\u53d1\u5b89\u5168\uff0c\u5355\u6b21\u8fd0\u884c\u6001\u5b58\u653e\u4e8e <code>ExecutionContext</code>\uff0c\u5305\u62ec\u901a\u9053\u7248\u672c\u3001\u5f85\u5199\uff08pending writes\uff09\u3001\u6700\u8fd1\u68c0\u67e5\u70b9\u7b49\u3002</li> <li>\u4e8b\u4ef6\u7684 <code>StateDelta</code> \u4f7f\u7528\u6df1\u62f7\u8d1d\u5feb\u7167\uff0c\u53ea\u5305\u542b\u53ef\u5e8f\u5217\u5316\u4e14\u5141\u8bb8\u7684\u952e\uff1b\u5185\u90e8\u952e\uff08\u5982\u6267\u884c\u4e0a\u4e0b\u6587\u3001\u56de\u8c03\u7b49\uff09\u4f1a\u88ab\u8fc7\u6ee4\uff0c\u4fbf\u4e8e\u5e26\u5916\u89c2\u6d4b\u4e0e\u6301\u4e45\u5316\u3002</li> </ul>"},{"location":"zh/graph/#_24","title":"\u6267\u884c\u5668\u914d\u7f6e","text":"<pre><code>exec, err := graph.NewExecutor(g,\n    graph.WithChannelBufferSize(1024),              // \u4e8b\u4ef6\u901a\u9053\u7f13\u51b2\n    graph.WithMaxSteps(50),                          // \u6700\u5927\u6b65\u6570\n    graph.WithStepTimeout(5*time.Minute),            // \u6b65\u9aa4\u8d85\u65f6\n    graph.WithNodeTimeout(2*time.Minute),            // \u8282\u70b9\u8d85\u65f6\n    graph.WithCheckpointSaver(saver),                // \u5f00\u542f\u68c0\u67e5\u70b9\uff08\u5982 sqlite/inmemory\uff09\n    graph.WithCheckpointSaveTimeout(30*time.Second), // \u68c0\u67e5\u70b9\u4fdd\u5b58\u8d85\u65f6\n)\n</code></pre>"},{"location":"zh/graph/#agent_1","title":"\u4e0e\u591a Agent \u7cfb\u7edf\u96c6\u6210","text":"<p>GraphAgent \u7684\u8bbe\u8ba1\u521d\u8877\u5c31\u662f\u6210\u4e3a tRPC-Agent-Go \u591a Agent \u751f\u6001\u7684\u4e00\u90e8\u5206\uff0c\u800c\u4e0d\u662f\u72ec\u7acb\u5b58\u5728\u3002\u5b83\u5b9e\u73b0\u4e86\u6807\u51c6\u7684 Agent \u63a5\u53e3\uff0c\u53ef\u4ee5\u548c\u5176\u4ed6 Agent \u7c7b\u578b\u65e0\u7f1d\u534f\u4f5c\u3002</p>"},{"location":"zh/graph/#graphagent-agent","title":"GraphAgent \u4f5c\u4e3a Agent","text":"<p>GraphAgent \u5b9e\u73b0\u4e86\u6807\u51c6 Agent \u63a5\u53e3\uff1a</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/agent\"\n    \"trpc.group/trpc-go/trpc-agent-go/agent/chainagent\"\n)\n\n// \u53ef\u4ee5\u76f4\u63a5\u5728 ChainAgent, ParallelAgent, CycleAgent \u4e2d\u4f7f\u7528\nchain := chainagent.New(\"chain\",\n    chainagent.WithSubAgents([]agent.Agent{\n        graphAgent1,  // \u7ed3\u6784\u5316\u6d41\u7a0b1\n        graphAgent2,  // \u7ed3\u6784\u5316\u6d41\u7a0b2\n    }))\n</code></pre>"},{"location":"zh/graph/#_25","title":"\u9ad8\u7ea7\u7f16\u6392","text":"<p>\u4e0b\u56fe\u5c55\u793a\u590d\u6742\u4e1a\u52a1\u7f16\u6392\uff1a\u5165\u53e3\u6e05\u6d17 \u2192 \u667a\u80fd\u8def\u7531 \u2192 \u591a\u5b50\u7f16\u961f\uff08Email\u3001Weather\u3001Research\uff09\u2192 \u5e76\u884c fanout/\u805a\u5408 \u2192 \u6700\u7ec8\u5408\u6210\u4e0e\u53d1\u5e03\u3002</p> <pre><code>flowchart LR\n    %% Layout\n    subgraph UE[\"User &amp; Entry\"]\n        U((User)):::human --&gt; IN[\"entry&lt;br/&gt;normalize\"]:::process\n    end\n\n    subgraph FAB[\"Graph Orchestration\"]\n        Rtr[\"where_to_go&lt;br/&gt;router\"]:::router\n        Compose[\"compose&lt;br/&gt;LLM\"]:::llm\n    end\n\n    IN --&gt; Rtr\n\n    %% Email Agent (expanded)\n    subgraph EC[\"Email Agent\"]\n        direction LR\n        CE[\"classifier&lt;br/&gt;LLM\"]:::llm --&gt; WE[\"writer&lt;br/&gt;LLM\"]:::llm\n    end\n\n    %% Weather Agent (expanded)\n    subgraph WA[\"Weather Agent\"]\n        direction LR\n        LE[\"locate&lt;br/&gt;LLM\"]:::llm --&gt; WT[\"weather tool\"]:::tool\n    end\n\n    %% Routing from router to pods\n    Rtr -- email --&gt; CE\n    Rtr -- weather --&gt; LE\n    Rtr -- other --&gt; REPLY[\"reply&lt;br/&gt;LLM\"]:::llm\n\n    %% Fanout Pipeline (fanout \u2192 workers \u2192 aggregate)\n    subgraph FP[\"Fanout Pipeline\"]\n        direction LR\n        Fan[\"plan_fanout\"]:::process --&gt; W1[\"worker A\"]:::process\n        Fan --&gt; W2[\"worker B\"]:::process\n        Fan --&gt; W3[\"worker C\"]:::process\n        W1 --&gt; Agg[\"aggregate\"]:::process\n        W2 --&gt; Agg\n        W3 --&gt; Agg\n    end\n    Rtr -- research --&gt; Fan\n\n    %% Human-in-the-loop (optional)\n    Compose -. review .- HG[\"human&lt;br/&gt;review\"]:::human\n\n    %% Compose final (minimal wiring)\n    Agg --&gt; Compose\n    WE --&gt; Compose\n    WT --&gt; Compose\n    REPLY --&gt; Compose\n    Compose --&gt; END([END]):::terminal\n\n    %% Styles\n    classDef router fill:#fff7e0,stroke:#f5a623,stroke-width:2px\n    classDef llm fill:#e3f2fd,stroke:#1e88e5,stroke-width:2px\n    classDef tool fill:#fff3e0,stroke:#fb8c00,stroke-width:2px\n    classDef process fill:#f3e5f5,stroke:#8e24aa,stroke-width:2px\n    classDef human fill:#e8f5e9,stroke:#43a047,stroke-width:2px\n    classDef terminal fill:#ffebee,stroke:#e53935,stroke-width:2px</code></pre> <p>\u8981\u70b9\uff1a</p> <ul> <li>\u667a\u80fd\u8def\u7531 where_to_go \u53ef\u7531 LLM \u51b3\u7b56\u6216\u51fd\u6570\u8282\u70b9\u5b9e\u73b0\uff08\u6761\u4ef6\u8fb9\uff09\u3002</li> <li>Fanout Pipeline \u4f7f\u7528 Command GoTo \u8fdb\u884c\u8fd0\u884c\u65f6 fanout\uff0c\u4e09\u8def\u5e76\u884c\u540e\u5728 aggregate \u8282\u70b9\u805a\u5408\u3002</li> <li>\u53ef\u9009\u7684\u4eba\u673a\u628a\u5173\u4f4d\u4e8e\u805a\u5408\u4e4b\u540e\uff0c\u786e\u4fdd\u5173\u952e\u8f93\u51fa\u7ecf\u4eba\u5de5\u786e\u8ba4\u3002</li> <li>\u4ec5\u5728 Compose \u5904\u5c55\u793a\u4e00\u6b21\u4fdd\u5b58\u68c0\u67e5\u70b9\uff0c\u65e2\u4e0d\u55a7\u5bbe\u593a\u4e3b\uff0c\u53c8\u80fd\u4f53\u73b0\u53ef\u6062\u590d\u80fd\u529b\u3002</li> </ul>"},{"location":"zh/graph/#agent_2","title":"\u5728\u56fe\u4e2d\u5d4c\u5165 Agent","text":"<p>\u5728\u56fe\u5185\u90e8\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u628a\u5df2\u6709\u7684\u5b50 Agent \u4f5c\u4e3a\u4e00\u4e2a\u8282\u70b9\u6765\u8c03\u7528\u3002\u4e0b\u9762\u7684\u793a\u4f8b\u5c55\u793a\u4e86\u5982\u4f55\u521b\u5efa\u5b50 Agent\u3001\u58f0\u660e\u5bf9\u5e94\u8282\u70b9\uff0c\u5e76\u5728 GraphAgent \u6784\u9020\u65f6\u6ce8\u5165\u3002</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/agent\"\n    \"trpc.group/trpc-go/trpc-agent-go/agent/graphagent\"\n)\n\n// \u521b\u5efa\u5b50 Agent\nconst (\n    subAgentAnalyzer = \"analyzer\"\n    subAgentReviewer = \"reviewer\"\n)\nanalyzer := createAnalyzer()  // \u540d\u79f0\u5fc5\u987b\u662f \"analyzer\"\nreviewer := createReviewer()  // \u540d\u79f0\u5fc5\u987b\u662f \"reviewer\"\n\n// \u5728\u56fe\u4e2d\u58f0\u660e Agent \u8282\u70b9\nsg.AddAgentNode(subAgentAnalyzer)\nsg.AddAgentNode(subAgentReviewer)\n\n// \u521b\u5efa GraphAgent \u65f6\u6ce8\u5165\u5b50 Agent\ngraphAgent, _ := graphagent.New(\"workflow\", g,\n    graphagent.WithSubAgents([]agent.Agent{\n        analyzer,\n        reviewer,\n    }))\n\n// I/O\uff1a\u5b50 Agent \u65e2\u4f1a\u628a graph.StateKeyUserInput \u4f5c\u4e3a\u6d88\u606f\u4f20\u5165\uff0c\u4e5f\u80fd\u901a\u8fc7\n// inv.RunOptions.RuntimeState \u8bfb\u53d6\u5b8c\u6574\u56fe\u72b6\u6001\uff1b\u5b8c\u6210\u540e\u4f1a\u66f4\u65b0\n// graph.StateKeyLastResponse \u4ee5\u53ca graph.StateKeyNodeResponses[nodeID]\n</code></pre>"},{"location":"zh/graph/#last_response-user_input","title":"\u53ea\u4f20\u7ed3\u679c\uff1a\u5c06 last_response \u6620\u5c04\u4e3a\u4e0b\u6e38 user_input","text":"<p>\u573a\u666f\uff1aA \u2192 B \u2192 C \u4e92\u4e3a\u9ed1\u76d2\uff0c\u4e0d\u5e0c\u671b\u4e0b\u6e38\u8bfb\u53d6\u5b8c\u6574\u4f1a\u8bdd\uff0c\u53ea\u9700\u8981\u4e0a\u6e38\u7684\u201c\u7ed3\u679c\u6587\u672c\u201d\u4f5c\u4e3a\u672c\u8f6e\u8f93\u5165\u3002</p> <ul> <li>\u65b9\u5f0f\u4e00\uff08\u65e0\u9700\u4f9d\u8d56\uff0c\u63a8\u8350\u901a\u7528\uff09\uff1a\u5728\u76ee\u6807 Agent \u8282\u70b9\u6dfb\u52a0\u524d\u7f6e\u56de\u8c03\uff0c\u628a\u7236\u6001 <code>last_response</code> \u5199\u5165 <code>user_input</code>\uff0c\u5fc5\u8981\u65f6\u5f00\u542f\u201c\u6d88\u606f\u9694\u79bb\u201d\u3002</li> </ul> <pre><code>sg.AddAgentNode(\"orchestrator\",\n    // \u5c06\u4e0a\u6e38 last_response \u8bbe\u7f6e\u4e3a\u672c\u8f6e user_input\n    graph.WithPreNodeCallback(func(ctx context.Context, cb *graph.NodeCallbackContext, s graph.State) (any, error) {\n        if v, ok := s[graph.StateKeyLastResponse].(string); ok &amp;&amp; v != \"\" {\n            s[graph.StateKeyUserInput] = v\n        }\n        return nil, nil\n    }),\n    // \u53ef\u9009\uff1a\u9694\u79bb\u5b50 Agent \u7684\u4f1a\u8bdd\u6ce8\u5165\uff0c\u4ec5\u6d88\u8d39\u672c\u8f6e user_input\n    graph.WithSubgraphIsolatedMessages(true),\n)\n</code></pre> <ul> <li>\u65b9\u5f0f\u4e8c\uff08\u4f7f\u7528\u589e\u5f3a\u9009\u9879\uff0c\u66f4\u7b80\u6d01\uff09\uff1a</li> </ul> <pre><code>// \u6846\u67b6\u63d0\u4f9b\u58f0\u660e\u5f0f Option\uff0c\u81ea\u52a8\u6267\u884c last_response \u2192 user_input \u7684\u6620\u5c04\nsg.AddAgentNode(\"orchestrator\",\n    graph.WithSubgraphInputFromLastResponse(),\n    graph.WithSubgraphIsolatedMessages(true), // \u53ef\u9009\uff0c\u914d\u5408\u9694\u79bb\u8fbe\u5230\u201c\u53ea\u4f20\u7ed3\u679c\u201d\n)\n</code></pre> <p>\u8bf4\u660e\uff1a\u4ee5\u4e0a\u4e24\u79cd\u65b9\u5f0f\u90fd\u80fd\u8ba9 B \u4ec5\u770b\u5230 A \u7684\u7ed3\u679c\u3001C \u4ec5\u770b\u5230 B \u7684\u7ed3\u679c\uff1b\u65b9\u5f0f\u4e8c\u66f4\u7b80\u6d01\uff0c\u65b9\u5f0f\u4e00\u96f6\u4f9d\u8d56\u3001\u5230\u5904\u53ef\u7528\u3002</p>"},{"location":"zh/graph/#_26","title":"\u6df7\u5408\u6a21\u5f0f\u793a\u4f8b","text":"<p>\u7ed3\u6784\u5316\u6d41\u7a0b\u4e2d\u5d4c\u5165\u52a8\u6001\u51b3\u7b56\uff1a</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/agent\"\n    \"trpc.group/trpc-go/trpc-agent-go/agent/chainagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/agent/graphagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/graph\"\n)\n\nsg := graph.NewStateGraph(schema)\n\nconst (\n    nodePrepare  = \"prepare\"\n    nodeAnalyzer = \"analyzer\"\n    nodeFinalize = \"finalize\"\n)\n\n// \u7ed3\u6784\u5316\u7684\u6570\u636e\u51c6\u5907\nsg.AddNode(nodePrepare, prepareData)\n\n// \u52a8\u6001\u51b3\u7b56\u70b9 - \u4f7f\u7528 ChainAgent\ndynamicAgent := chainagent.New(nodeAnalyzer,\n    chainagent.WithSubAgents([]agent.Agent{...}))\nsg.AddAgentNode(nodeAnalyzer)\n\n// \u7ee7\u7eed\u7ed3\u6784\u5316\u6d41\u7a0b\nsg.AddNode(nodeFinalize, finalizeResults)\n\n// \u8fde\u63a5\u6d41\u7a0b\nsg.SetEntryPoint(nodePrepare)\nsg.AddEdge(nodePrepare, nodeAnalyzer)     // \u4ea4\u7ed9\u52a8\u6001 Agent\nsg.AddEdge(nodeAnalyzer, nodeFinalize)    // \u56de\u5230\u7ed3\u6784\u5316\u6d41\u7a0b\nsg.SetFinishPoint(nodeFinalize)\n\n// \u521b\u5efa\u65f6\u6ce8\u5165\ngraphAgent, _ := graphagent.New(\"hybrid\", g,\n    graphagent.WithSubAgents([]agent.Agent{dynamicAgent}))\n</code></pre>"},{"location":"zh/graph/#_27","title":"\u6838\u5fc3\u673a\u5236\u8be6\u89e3","text":""},{"location":"zh/graph/#schema-reducer","title":"\u72b6\u6001\u7ba1\u7406\uff1aSchema + Reducer \u6a21\u5f0f","text":"<p>\u72b6\u6001\u7ba1\u7406\u662f\u56fe\u5de5\u4f5c\u6d41\u7684\u6838\u5fc3\u6311\u6218\u4e4b\u4e00\u3002\u6211\u4eec\u8bbe\u8ba1\u4e86\u4e00\u5957\u57fa\u4e8e Schema + Reducer \u7684\u72b6\u6001\u7ba1\u7406\u673a\u5236\uff0c\u65e2\u4fdd\u8bc1\u4e86\u7c7b\u578b\u5b89\u5168\uff0c\u53c8\u652f\u6301\u9ad8\u5e76\u53d1\u7684\u539f\u5b50\u66f4\u65b0\u3002</p> <pre><code>flowchart LR\n    subgraph \"State Schema\"\n        MS[messages: MessageList]:::schemaClass\n        UI[user_input: string]:::schemaClass\n        LR[last_response: string]:::schemaClass\n        NR[node_responses: Map]:::schemaClass\n    end\n\n    subgraph \"State Operations\"\n        R1[MessageReducer]:::reducerClass\n        R2[AppendReducer]:::reducerClass\n        R3[DefaultReducer]:::reducerClass\n    end\n\n    subgraph \"Concurrent Updates\"\n        N1[Node 1 Output]:::nodeOutputClass\n        N2[Node 2 Output]:::nodeOutputClass\n        N3[Node 3 Output]:::nodeOutputClass\n    end\n\n    N1 --&gt; R1\n    N2 --&gt; R2\n    N3 --&gt; R3\n    R1 --&gt; MS\n    R2 --&gt; NR\n    R3 --&gt; LR\n\n    classDef schemaClass fill:#e3f2fd,stroke:#1565c0,stroke-width:2px\n    classDef reducerClass fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px\n    classDef nodeOutputClass fill:#fff8e1,stroke:#f57f17,stroke-width:2px</code></pre> <p>Graph \u7684\u72b6\u6001\u5e95\u5c42\u662f <code>map[string]any</code>\uff0c\u901a\u8fc7 <code>StateSchema</code> \u63d0\u4f9b\u8fd0\u884c\u65f6\u7c7b\u578b\u6821\u9a8c\u548c\u5b57\u6bb5\u9a8c\u8bc1\u3002Reducer \u673a\u5236\u786e\u4fdd\u72b6\u6001\u5b57\u6bb5\u6309\u9884\u5b9a\u4e49\u89c4\u5219\u5b89\u5168\u5408\u5e76\uff0c\u907f\u514d\u5e76\u53d1\u66f4\u65b0\u51b2\u7a81\u3002</p>"},{"location":"zh/graph/#_28","title":"\u5e38\u7528\u952e\u5e38\u91cf\u53c2\u8003","text":"<ul> <li>\u7528\u6237\u53ef\u89c1\uff1a<code>graph.StateKeyUserInput</code>\u3001<code>graph.StateKeyOneShotMessages</code>\u3001<code>graph.StateKeyMessages</code>\u3001<code>graph.StateKeyLastResponse</code>\u3001<code>graph.StateKeyNodeResponses</code>\u3001<code>graph.StateKeyMetadata</code></li> <li>\u7cfb\u7edf\u5185\u90e8\uff1a<code>session</code>\u3001<code>exec_context</code>\u3001<code>tool_callbacks</code>\u3001<code>model_callbacks</code>\u3001<code>agent_callbacks</code>\u3001<code>current_node_id</code>\u3001<code>parent_agent</code></li> <li>\u547d\u4ee4/\u6062\u590d\uff1a<code>__command__</code>\u3001<code>__resume_map__</code></li> </ul> <p>\u5e38\u91cf\u5747\u5b9a\u4e49\u5728 <code>graph/state.go</code> \u4e0e <code>graph/keys.go</code>\uff0c\u5efa\u8bae\u901a\u8fc7\u5e38\u91cf\u5f15\u7528\uff0c\u907f\u514d\u786c\u7f16\u7801\u3002</p>"},{"location":"zh/graph/#_29","title":"\u8282\u70b9\u7ea7\u56de\u8c03\u3001\u5de5\u5177\u4e0e\u751f\u6210\u53c2\u6570","text":"<p>\u8282\u70b9\u53ef\u901a\u8fc7\u53ef\u9009\u9879\u6ce8\u518c\u56de\u8c03\u6216\u53c2\u6570\uff08\u89c1 <code>graph/state_graph.go</code>\uff09\uff1a</p> <ul> <li><code>graph.WithPreNodeCallback</code> / <code>graph.WithPostNodeCallback</code> / <code>graph.WithNodeErrorCallback</code></li> <li>LLM \u8282\u70b9\u53ef\u7528 <code>graph.WithGenerationConfig</code>\u3001<code>graph.WithModelCallbacks</code></li> <li>\u5de5\u5177\u76f8\u5173\uff1a<code>graph.WithToolCallbacks</code>\u3001<code>graph.WithToolSets</code>\uff08\u9664 <code>tools []tool.Tool</code> \u5916\uff0c\u518d\u989d\u5916\u63d0\u4f9b ToolSet<code>\uff09\u3001</code>graph.WithRefreshToolSetsOnRun`\uff08\u5728\u6bcf\u6b21\u8fd0\u884c\u65f6\u4ece ToolSet \u91cd\u65b0\u6784\u9020\u5de5\u5177\u5217\u8868\uff0c\u9002\u5408 MCP \u7b49\u52a8\u6001\u5de5\u5177\u6e90\uff09</li> <li>Agent \u8282\u70b9\u53ef\u7528 <code>graph.WithAgentNodeEventCallback</code></li> </ul>"},{"location":"zh/graph/#graph-toolset-agent","title":"Graph \u4e2d\u7684 ToolSet \u4e0e Agent \u7684\u533a\u522b","text":"<p><code>graph.WithToolSets</code> \u662f\u8282\u70b9\u7ea7\u3001\u6784\u56fe\u671f\u914d\u7f6e\uff1a\u5728\u6784\u5efa\u56fe\u65f6\uff0c\u628a\u4e00\u4e2a\u6216\u591a\u4e2a <code>tool.ToolSet</code> \u7ed1\u5b9a\u5230\u7279\u5b9a\u7684 LLM \u8282\u70b9\uff0c\u4f8b\u5982\uff1a</p> <pre><code>sg.AddLLMNode(\"llm\",\n    model,\n    \"inst\",\n    tools,\n    graph.WithToolSets([]tool.ToolSet{mcpToolSet, fileToolSet}),\n)\n</code></pre> <p>\u9700\u8981\u6ce8\u610f\uff1a</p> <ul> <li>Graph \u4e00\u65e6 <code>Compile()</code>\uff0c\u7ed3\u6784\uff08\u5305\u62ec\u8282\u70b9\u7ed1\u5b9a\u7684 ToolSet\uff09\u5c31\u662f\u4e0d\u53ef\u53d8\u7684\u3002\u5982\u679c\u8981\u8c03\u6574\u67d0\u4e2a\u8282\u70b9\u7684 ToolSet\uff0c\u9700\u8981\u91cd\u65b0\u6784\u56fe\u6216\u521b\u5efa\u65b0\u7684 <code>GraphAgent</code>\u3002</li> <li>\u8fd0\u884c\u65f6\u5e0c\u671b\u52a8\u6001\u589e\u5220 ToolSet\uff0c\u5e94\u8be5\u5728 Agent \u5c42\u5904\u7406\uff08\u4f8b\u5982\u4f7f\u7528 <code>llmagent.AddToolSet</code>\u3001<code>llmagent.RemoveToolSet</code>\u3001<code>llmagent.SetToolSets</code>\uff09\uff0c\u6216\u8005\u66ff\u6362 Graph \u4e2d Agent \u8282\u70b9\u6240\u4f7f\u7528\u7684\u4e0b\u6e38 Agent\u3002</li> </ul> <p>\u6b64\u5916\uff0c<code>graph.WithName</code>/<code>graph.WithDescription</code> \u53ef\u4e3a\u8282\u70b9\u6dfb\u52a0\u53cb\u597d\u7684\u540d\u79f0\u4e0e\u63cf\u8ff0\uff1b<code>graph.WithDestinations</code> \u53ef\u58f0\u660e\u6f5c\u5728\u52a8\u6001\u8def\u7531\u76ee\u6807\uff08\u4ec5\u7528\u4e8e\u9759\u6001\u6821\u9a8c/\u53ef\u89c6\u5316\uff09\u3002</p>"},{"location":"zh/graph/#llm_2","title":"LLM \u8f93\u5165\u89c4\u5219\uff1a\u4e09\u6bb5\u5f0f\u8bbe\u8ba1","text":"<p>LLM \u8282\u70b9\u7684\u8f93\u5165\u5904\u7406\u662f\u6211\u4eec\u82b1\u4e86\u5f88\u591a\u65f6\u95f4\u6253\u78e8\u7684\u529f\u80fd\u3002\u770b\u8d77\u6765\u7b80\u5355\u7684\u4e09\u6bb5\u5f0f\u89c4\u5219\uff0c\u5b9e\u9645\u4e0a\u89e3\u51b3\u4e86 AI \u5e94\u7528\u4e2d\u6700\u5e38\u89c1\u7684\u4e0a\u4e0b\u6587\u7ba1\u7406\u95ee\u9898\u3002</p> <p>LLM \u8282\u70b9\u5185\u7f6e\u4e86\u4e00\u5957\u56fa\u5b9a\u7684\u8f93\u5165\u9009\u62e9\u903b\u8f91\uff08\u65e0\u9700\u989d\u5916\u914d\u7f6e\uff09\uff1a</p> <ol> <li>\u4f18\u5148\u7528 <code>graph.StateKeyOneShotMessages</code>\uff1a\u5b8c\u5168\u8986\u76d6\u672c\u8f6e\u8f93\u5165\uff08\u542b system/user\uff09\uff0c\u6267\u884c\u540e\u6e05\u7a7a</li> <li>\u5176\u6b21\u7528 <code>graph.StateKeyUserInput</code>\uff1a\u5728 <code>graph.StateKeyMessages</code> \u57fa\u7840\u4e0a\u8ffd\u52a0\u672c\u8f6e user\uff0c\u518d\u628a assistant \u56de\u7b54\u4e00\u8d77\u539f\u5b50\u5199\u56de\uff0c\u968f\u540e\u6e05\u7a7a <code>graph.StateKeyUserInput</code></li> <li>\u5426\u5219\u4ec5\u7528 <code>graph.StateKeyMessages</code>\uff1a\u5e38\u89c1\u4e8e\u5de5\u5177\u56de\u8def\u4e8c\u6b21\u8fdb LLM\uff08<code>graph.StateKeyUserInput</code> \u5df2\u88ab\u6e05\u7a7a\uff09</li> </ol> <p>\u8fd9\u5957\u89c4\u5219\u7684\u7cbe\u5999\u4e4b\u5904\u5728\u4e8e\uff0c\u5b83\u65e2\u4fdd\u8bc1\u4e86\"\u9884\u5904\u7406\u8282\u70b9\u53ef\u4ee5\u6539\u5199 <code>graph.StateKeyUserInput</code> \u5e76\u5728\u540c\u4e00\u8f6e\u751f\u6548\"\uff0c\u53c8\u4e0e\u5de5\u5177\u5faa\u73af\uff08tool_calls \u2192 tools \u2192 LLM\uff09\u81ea\u7136\u8854\u63a5\u3002</p> <p>\u793a\u4f8b\uff08\u6280\u672f\u89e3\u6790\u7ea7\u522b\u7684\u5c0f\u7247\u6bb5\uff0c\u6f14\u793a\u4e09\u79cd\u8f93\u5165\u8def\u5f84\uff09\uff1a</p> <pre><code>// OneShot\uff08graph.StateKeyOneShotMessages\uff09\uff1a\u5b8c\u5168\u8986\u76d6\u672c\u8f6e\u8f93\u5165\uff08\u5305\u542b system/user\uff09\uff0c\u9002\u5408\u201c\u524d\u7f6e\u8282\u70b9\u6784\u9020\u5b8c\u6574 prompt\u201d\nimport (\n    \"trpc.group/trpc-go/trpc-agent-go/graph\"\n    \"trpc.group/trpc-go/trpc-agent-go/model\"\n)\n\nconst (\n    systemPrompt = \"\u4f60\u662f\u5ba1\u614e\u53ef\u9760\u7684\u52a9\u624b\"\n    userPrompt   = \"\u8bf7\u7528\u8981\u70b9\u603b\u7ed3\u8fd9\u6bb5\u6587\u672c\"\n)\n\nsg.AddNode(\"prepare_prompt\", func(ctx context.Context, s graph.State) (any, error) {\n    oneShot := []model.Message{\n        model.NewSystemMessage(systemPrompt),\n        model.NewUserMessage(userPrompt),\n    }\n    return graph.State{graph.StateKeyOneShotMessages: oneShot}, nil\n})\n// \u540e\u7eed\u8fdb\u5165 LLM \u8282\u70b9\u65f6\u5c06\u4ec5\u4f7f\u7528 graph.StateKeyOneShotMessages\uff0c\u5e76\u5728\u6267\u884c\u540e\u6e05\u7a7a\n</code></pre> <pre><code>// UserInput\uff08graph.StateKeyUserInput\uff09\uff1a\u5728\u5386\u53f2 graph.StateKeyMessages \u57fa\u7840\u4e0a\u9644\u52a0\u672c\u8f6e\u7528\u6237\u8f93\u5165\nimport (\n    \"strings\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/graph\"\n)\n\nconst (\n    stateKeyCleanedInput = \"cleaned_input\"\n)\n\nsg.AddNode(\"clean_input\", func(ctx context.Context, s graph.State) (any, error) {\n    in := strings.TrimSpace(s[graph.StateKeyUserInput].(string))\n    return graph.State{\n        graph.StateKeyUserInput: in,                // \u5c06\u6e05\u6d17\u540e\u7684\u8f93\u5165\u5199\u56de\uff0cLLM \u8282\u70b9\u4f1a\u628a user+assistant \u539f\u5b50\u5199\u5165 messages\n        stateKeyCleanedInput:    in,                // \u540c\u65f6\u4fdd\u7559\u4e1a\u52a1\u81ea\u5b9a\u4e49\u952e\n    }, nil\n})\n</code></pre> <pre><code>// Messages-only\uff08graph.StateKeyMessages\uff09\uff1a\u5de5\u5177\u56de\u8def\u8fd4\u56de\u540e\uff0cgraph.StateKeyUserInput \u5df2\u6e05\u7a7a\uff1bLLM \u4ec5\u57fa\u4e8e graph.StateKeyMessages\uff08\u542b tool \u54cd\u5e94\uff09\u7ee7\u7eed\u63a8\u7406\nimport (\n    \"trpc.group/trpc-go/trpc-agent-go/graph\"\n)\n\nconst (\n    nodeAsk       = \"ask\"\n    nodeExecTools = \"exec_tools\"\n    nodeFallback  = \"fallback\"\n)\n\nsg.AddToolsNode(nodeExecTools, tools)\nsg.AddToolsConditionalEdges(nodeAsk, nodeExecTools, nodeFallback)\n// \u518d\u6b21\u56de\u5230 nodeAsk\uff08\u6216\u4e0b\u6e38 LLM \u8282\u70b9\uff09\u65f6\uff0c\u7531\u4e8e graph.StateKeyUserInput \u5df2\u6e05\u7a7a\uff0c\u5c06\u8d70 messages-only \u5206\u652f\n</code></pre>"},{"location":"zh/graph/#_30","title":"\u6307\u4ee4\u5360\u4f4d\u7b26\u6ce8\u5165","text":"<p><code>AddLLMNode</code> \u7684 <code>instruction</code> \u652f\u6301\u5360\u4f4d\u7b26\uff0c\u8bed\u6cd5\u4e0e <code>llmagent</code> \u4e00\u81f4\uff1a</p> <ul> <li><code>{key}</code> / <code>{key?}</code>\uff1a\u4ece\u4f1a\u8bdd <code>session.State</code> \u8bfb\u53d6\u952e\u503c\uff0c\u53ef\u9009\u540e\u7f00 <code>?</code> \u7f3a\u5931\u65f6\u4e3a\u7a7a\uff1b</li> <li><code>{user:subkey}</code>\u3001<code>{app:subkey}</code>\u3001<code>{temp:subkey}</code>\uff1a\u6309\u547d\u540d\u7a7a\u95f4\u8bfb\u53d6\u3002</li> </ul> <p>GraphAgent \u4f1a\u628a\u5f53\u524d <code>*session.Session</code> \u653e\u5165\u72b6\u6001\uff08<code>graph.StateKeySession</code> \u952e\uff09\uff0cLLM \u8282\u70b9\u4f1a\u5728\u6267\u884c\u524d\u5bf9\u6307\u4ee4\u8fdb\u884c\u5360\u4f4d\u7b26\u5c55\u5f00\u3002</p> <p>\u63d0\u793a\uff1aGraphAgent \u4f1a\u4ece\u4f1a\u8bdd\u4e8b\u4ef6\u64ad\u79cd <code>graph.StateKeyMessages</code> \u4ee5\u4fdd\u8bc1\u591a\u8f6e\u8fde\u8d2f\uff1b\u4ece\u68c0\u67e5\u70b9\u6062\u590d\u65f6\uff0c\u82e5\u7528\u6237\u6d88\u606f\u4ec5\u4e3a \"resume\"\uff0c\u4e0d\u4f1a\u6ce8\u5165\u5230 <code>graph.StateKeyUserInput</code>\uff0c\u4ee5\u907f\u514d\u5e72\u6270\u5df2\u6062\u590d\u7684\u72b6\u6001\u3002</p>"},{"location":"zh/graph/#_31","title":"\u5e76\u53d1\u6267\u884c\u548c\u72b6\u6001\u5b89\u5168","text":"<p>\u5f53\u4e00\u4e2a\u8282\u70b9\u6709\u591a\u6761\u51fa\u8fb9\u65f6\uff0c\u4f1a\u81ea\u52a8\u89e6\u53d1\u5e76\u884c\u6267\u884c\uff1a</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/graph\"\n)\n\n// \u8fd9\u6837\u7684\u56fe\u7ed3\u6784\u4f1a\u81ea\u52a8\u5e76\u884c\u6267\u884c\nstateGraph.\n    AddNode(\"analyze\", analyzeData).\n    AddNode(\"generate_report\", generateReport).\n    AddNode(\"call_external_api\", callAPI).\n    AddEdge(\"analyze\", \"generate_report\").    // \u8fd9\u4e24\u4e2a\u4f1a\u5e76\u884c\u6267\u884c\n    AddEdge(\"analyze\", \"call_external_api\")   //\n</code></pre> <p>\u5185\u90e8\u5b9e\u73b0\u4fdd\u8bc1\u4e86\u5e76\u53d1\u5b89\u5168\uff1a\u6267\u884c\u5668\u4e3a\u6bcf\u4e2a\u4efb\u52a1\u6784\u9020\u6d45\u62f7\u8d1d\uff08maps.Copy\uff09\u5e76\u5728\u5408\u5e76\u65f6\u52a0\u9501\uff0c\u540c\u65f6\u901a\u8fc7 Reducer \u673a\u5236\u6765\u5b89\u5168\u5730\u5408\u5e76\u5e76\u53d1\u66f4\u65b0\u3002</p>"},{"location":"zh/graph/#io_1","title":"\u8282\u70b9 I/O \u7ea6\u5b9a\u4e0e\u5e38\u7528\u952e","text":"<p>\u8282\u70b9\u4e4b\u95f4\u4ec5\u901a\u8fc7\u5171\u4eab <code>State</code> \u4f20\u9012\u6570\u636e\uff0c\u8282\u70b9\u51fd\u6570\u8fd4\u56de\u7684\u589e\u91cf\u7531 Schema \u7684 Reducer \u5408\u5e76\u3002</p> <ul> <li> <p>\u51fd\u6570\u8282\u70b9\uff08Function\uff09</p> <ul> <li>\u8f93\u5165\uff1a\u5b8c\u6574 <code>State</code>\uff08\u6309 Schema \u58f0\u660e\u8bfb\u53d6\uff09</li> <li>\u8f93\u51fa\uff1a\u53ea\u5199\u4e1a\u52a1\u952e\uff08\u4f8b\u5982 <code>{\"parsed_time\":\"...\"}</code>\uff09\uff0c\u4e0d\u8981\u5199\u5185\u90e8\u952e</li> </ul> </li> </ul> <ul> <li> <p>LLM \u8282\u70b9</p> <ul> <li>\u8f93\u5165\u4f18\u5148\u7ea7\uff1a<code>graph.StateKeyOneShotMessages</code> \u2192 <code>graph.StateKeyUserInput</code> \u2192 <code>graph.StateKeyMessages</code></li> <li>\u8f93\u51fa\uff1a\u539f\u5b50\u5199\u56de <code>graph.StateKeyMessages</code>\u3001\u8bbe\u7f6e <code>graph.StateKeyLastResponse</code>\u3001\u8bbe\u7f6e <code>graph.StateKeyNodeResponses[&lt;llm_node_id&gt;]</code></li> </ul> </li> </ul> <ul> <li> <p>\u5de5\u5177\u8282\u70b9\uff08Tools\uff09</p> <ul> <li>\u81ea <code>graph.StateKeyMessages</code> \u5c3e\u90e8\u914d\u5bf9\u5f53\u524d\u8f6e\u7684 <code>assistant(tool_calls)</code>\uff0c\u6309\u987a\u5e8f\u8ffd\u52a0\u5de5\u5177\u8fd4\u56de\u5230 <code>graph.StateKeyMessages</code></li> <li>\u591a\u4e2a\u5de5\u5177\u6309 LLM \u8fd4\u56de\u987a\u5e8f\u987a\u5e8f\u6267\u884c</li> </ul> </li> </ul> <ul> <li>Agent \u8282\u70b9<ul> <li>\u901a\u8fc7 <code>Invocation.RunOptions.RuntimeState</code> \u63a5\u6536 Graph \u7684 <code>State</code></li> <li>\u8f93\u51fa\uff1a\u8bbe\u7f6e <code>graph.StateKeyLastResponse</code> \u4e0e <code>graph.StateKeyNodeResponses[&lt;agent_node_id&gt;]</code>\uff1b\u6267\u884c\u6210\u529f\u540e\u4f1a\u6e05\u7a7a <code>graph.StateKeyUserInput</code></li> </ul> </li> </ul> <p>\u5b9e\u8df5\u5efa\u8bae\uff1a</p> <ul> <li>\u4e32\u884c\u8bfb\u53d6\uff1a\u7d27\u90bb\u4e0b\u6e38\u76f4\u63a5\u8bfb\u53d6 <code>graph.StateKeyLastResponse</code>\uff1b</li> <li>\u5e76\u884c/\u6c47\u5408\u8bfb\u53d6\uff1a\u4ece <code>graph.StateKeyNodeResponses[&lt;nodeID&gt;]</code> \u8bfb\u53d6\u6307\u5b9a\u8282\u70b9\u8f93\u51fa\uff1b</li> <li>\u4e3a\u4e1a\u52a1\u952e\u5728 Schema \u4e2d\u58f0\u660e\u5408\u9002\u7684 Reducer\uff0c\u907f\u514d\u5e76\u53d1\u5199\u5165\u51b2\u7a81\u3002</li> </ul>"},{"location":"zh/graph/#api","title":"API \u901f\u67e5\u8868","text":"<ul> <li> <p>\u6784\u56fe</p> <ul> <li><code>graph.NewStateGraph(schema)</code> \u2192 \u6784\u5efa\u5668</li> <li><code>AddNode(id, func, ...opts)</code> / <code>AddLLMNode(id, model, instruction, tools, ...opts)</code></li> <li><code>AddToolsNode(id, tools, ...opts)</code> / <code>AddAgentNode(id, ...opts)</code></li> <li><code>AddEdge(from, to)</code> / <code>AddConditionalEdges(from, condition, pathMap)</code></li> <li><code>AddToolsConditionalEdges(llmNode, toolsNode, fallback)</code></li> <li><code>SetEntryPoint(nodeID)</code> / <code>SetFinishPoint(nodeID)</code> / <code>Compile()</code></li> </ul> </li> </ul> <ul> <li> <p>\u5e38\u7528 State \u952e\uff08\u7528\u6237\u53ef\u89c1\uff09</p> <ul> <li><code>graph.StateKeyUserInput</code>\u3001<code>graph.StateKeyOneShotMessages</code>\u3001<code>graph.StateKeyMessages</code>\u3001<code>graph.StateKeyLastResponse</code>\u3001<code>graph.StateKeyNodeResponses</code>\u3001<code>graph.StateKeyMetadata</code></li> </ul> </li> </ul> <ul> <li> <p>\u8282\u70b9\u7ea7\u53ef\u9009\u9879</p> <ul> <li>LLM / \u5de5\u5177\u76f8\u5173\uff1a<ul> <li><code>graph.WithGenerationConfig</code>\u3001<code>graph.WithModelCallbacks</code></li> <li><code>graph.WithToolCallbacks</code>\u3001<code>graph.WithToolSets</code></li> </ul> </li> <li>\u56de\u8c03\u76f8\u5173\uff1a<ul> <li><code>graph.WithPreNodeCallback</code>\u3001<code>graph.WithPostNodeCallback</code>\u3001<code>graph.WithNodeErrorCallback</code></li> </ul> </li> </ul> </li> </ul> <ul> <li>\u6267\u884c<ul> <li><code>graphagent.New(name, compiledGraph, ...opts)</code> \u2192 <code>runner.NewRunner(app, agent)</code> \u2192 <code>Run(...)</code></li> </ul> </li> </ul> <p>\u66f4\u591a\u7aef\u5230\u7aef\u7528\u6cd5\u89c1 <code>examples/graph</code>\uff08\u57fa\u7840/\u5e76\u884c/\u591a\u8f6e/\u4e2d\u65ad/\u5de5\u5177/\u5360\u4f4d\u7b26\uff09\u3002</p>"},{"location":"zh/graph/#dot","title":"\u53ef\u89c6\u5316\u5bfc\u51fa\uff08DOT/\u56fe\u7247\uff09","text":"<p>Graph \u652f\u6301\u76f4\u63a5\u5bfc\u51fa Graphviz\uff08\u56fe\u5f62\u53ef\u89c6\u5316\u8f6f\u4ef6\uff0cGraph Visualization\uff09<code>DOT</code>\uff08Graphviz \u7684\u63cf\u8ff0\u8bed\u8a00\uff0cDirected Graph Language\uff09\u6587\u672c\uff0c\u4ee5\u53ca\u901a\u8fc7\u7cfb\u7edf\u5b89\u88c5\u7684 <code>dot</code>\uff08Graphviz \u547d\u4ee4\u884c\u5de5\u5177 <code>dot</code> \u662f Graphviz \u7684\u5e03\u5c40\u5f15\u64ce\u4e4b\u4e00\uff0c\u7528\u4e8e\u6e32\u67d3 DOT \u6587\u4ef6\uff09\u6e32\u67d3 <code>PNG</code>\uff08Portable Network Graphics\uff0c\u4fbf\u643a\u5f0f\u7f51\u7edc\u56fe\u5f62\u683c\u5f0f\uff09/<code>SVG</code>\uff08Scalable Vector Graphics\uff0c\u53ef\u7f29\u653e\u77e2\u91cf\u56fe\u5f62\uff09\u3002</p> <ul> <li><code>WithDestinations</code>\uff08\u5728\u8282\u70b9\u4e0a\u58f0\u660e\u6f5c\u5728\u52a8\u6001\u53bb\u5411\uff09\u4f1a\u4ee5\u865a\u7ebf\uff08dotted\u3001\u7070\u8272\uff09\u663e\u793a\uff0c\u4ec5\u7528\u4e8e\u9759\u6001\u68c0\u67e5\u4e0e\u53ef\u89c6\u5316\uff0c\u4e0d\u5f71\u54cd\u8fd0\u884c\u65f6\u8def\u7531\u3002</li> <li>\u6761\u4ef6\u8fb9\uff08Conditional edges\uff09\u4f1a\u4ee5\u865a\u7ebf\uff08dashed\u3001\u7070\u8272\uff09\u5e76\u6807\u6ce8\u5206\u652f\u952e\u503c\u3002</li> <li>\u5e38\u89c4\u8fb9\uff08AddEdge\uff09\u4e3a\u5b9e\u7ebf\u3002</li> <li>\u865a\u62df <code>Start</code>/<code>End</code> \u8282\u70b9\u53ef\u901a\u8fc7\u9009\u9879\u6253\u5f00/\u9690\u85cf\u3002</li> </ul> <p>\u793a\u4f8b\uff1a</p> <pre><code>g := sg.MustCompile()\n\n// \u751f\u6210 DOT \u6587\u672c\ndot := g.DOT(\n    graph.WithRankDir(graph.RankDirLR),     // \u5de6\u2192\u53f3\u5e03\u5c40\uff08\u6216 graph.RankDirTB\uff09\n    graph.WithIncludeDestinations(true),    // \u663e\u793a WithDestinations \u58f0\u660e\n    graph.WithGraphLabel(\"My Workflow\"),   // \u56fe\u6807\u9898\n)\n\n// \u6e32\u67d3 PNG \uff08\u9700\u8981\u5df2\u5b89\u88c5 Graphviz \u7684 dot\uff09\nif err := g.RenderImage(context.Background(), graph.ImageFormatPNG, \"workflow.png\",\n    graph.WithRankDir(graph.RankDirLR),\n    graph.WithIncludeDestinations(true),\n); err != nil {\n    // \u672a\u5b89\u88c5 Graphviz \u65f6\u8fd9\u91cc\u4f1a\u8fd4\u56de\u9519\u8bef\uff0c\u53ef\u5ffd\u7565\u6216\u63d0\u793a\u5b89\u88c5\n}\n</code></pre> <p>API \u53c2\u8003\uff1a</p> <ul> <li><code>g.DOT(...)</code> / <code>g.WriteDOT(w, ...)</code>\uff1a\u5bfc\u51fa DOT \u6587\u672c</li> <li><code>g.RenderImage(ctx, format, outputPath, ...)</code>\uff1a\u8c03\u7528 <code>dot</code> \u6e32\u67d3\u56fe\u7247\uff08<code>png</code>/<code>svg</code> \u7b49\uff09</li> <li>\u9009\u9879\uff1a<code>WithRankDir(graph.RankDirLR|graph.RankDirTB)</code>\u3001<code>WithIncludeDestinations(bool)</code>\u3001<code>WithIncludeStartEnd(bool)</code>\u3001<code>WithGraphLabel(string)</code></li> </ul> <p>\u5b8c\u6574\u793a\u4f8b\u89c1\uff1a<code>examples/graph/visualization</code></p>"},{"location":"zh/graph/#_32","title":"\u9ad8\u7ea7\u7279\u6027","text":""},{"location":"zh/graph/#_33","title":"\u68c0\u67e5\u70b9\u4e0e\u6062\u590d","text":"<p>\u4e3a\u4e86\u652f\u6301\u65f6\u95f4\u65c5\u884c\u4e0e\u53ef\u9760\u6062\u590d\uff0c\u53ef\u4ee5\u4e3a\u6267\u884c\u5668\u6216 GraphAgent \u914d\u7f6e\u68c0\u67e5\u70b9\u4fdd\u5b58\u5668\u3002\u4e0b\u9762\u6f14\u793a\u4f7f\u7528 SQLite/Redis Saver \u6301\u4e45\u5316\u68c0\u67e5\u70b9\u5e76\u4ece\u7279\u5b9a\u68c0\u67e5\u70b9\u6062\u590d\u3002</p> <pre><code>import (\n    \"database/sql\"\n\n    _ \"github.com/mattn/go-sqlite3\"\n    \"trpc.group/trpc-go/trpc-agent-go/agent\"\n    \"trpc.group/trpc-go/trpc-agent-go/agent/graphagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/graph\"\n    \"trpc.group/trpc-go/trpc-agent-go/graph/checkpoint/sqlite\"\n    \"trpc.group/trpc-go/trpc-agent-go/graph/checkpoint/redis\"\n    \"trpc.group/trpc-go/trpc-agent-go/model\"\n)\n\n// \u914d\u7f6e\u68c0\u67e5\u70b9\ndb, _ := sql.Open(\"sqlite3\", \"./checkpoints.db\")\nsaver, _ := sqlite.NewSaver(db)\n\ngraphAgent, _ := graphagent.New(\"workflow\", g,\n    graphagent.WithCheckpointSaver(saver))\n\n// \u6267\u884c\u65f6\u81ea\u52a8\u4fdd\u5b58\u68c0\u67e5\u70b9\uff08\u9ed8\u8ba4\u6bcf\u6b65\u4fdd\u5b58\uff09\n\n// \u4ece\u68c0\u67e5\u70b9\u6062\u590d\neventCh, err := r.Run(ctx, userID, sessionID,\n    model.NewUserMessage(\"resume\"),\n    agent.WithRuntimeState(map[string]any{\n        graph.CfgKeyCheckpointID: \"ckpt-123\",\n    }),\n)\n\n// \u914d\u7f6eredis\u68c0\u67e5\u70b9\nredisSaver, _ := redis.NewSaver(redis.WithRedisClientURL(\"redis://[username:password@]host:port[/database]\"))\n\ngraphAgent, _ := graphagent.New(\"workflow\", g,\n    graphagent.WithCheckpointSaver(redisSaver))\n\n// \u6267\u884c\u65f6\u81ea\u52a8\u4fdd\u5b58\u68c0\u67e5\u70b9\uff08\u9ed8\u8ba4\u6bcf\u6b65\u4fdd\u5b58\uff09\n\n// \u4ece\u68c0\u67e5\u70b9\u6062\u590d\neventCh, err := r.Run(ctx, userID, sessionID,\n    model.NewUserMessage(\"resume\"),\n    agent.WithRuntimeState(map[string]any{\n        graph.CfgKeyCheckpointID: \"ckpt-123\",\n    }),\n)\n</code></pre>"},{"location":"zh/graph/#_34","title":"\u68c0\u67e5\u70b9\u7ba1\u7406","text":"<p>\u4f7f\u7528\u7ba1\u7406\u5668\u53ef\u4ee5\u4fbf\u6377\u5730\u6d4f\u89c8\u3001\u67e5\u8be2\u4e0e\u5220\u9664\u68c0\u67e5\u70b9\uff1a</p> <pre><code>cm := graph.NewCheckpointManager(saver)\n\n// \u6700\u65b0\u68c0\u67e5\u70b9\uff08\u53ef\u6309 namespace \u8fc7\u6ee4\uff1b\u7a7a\u5b57\u7b26\u4e32\u4ee3\u8868\u8de8\u547d\u540d\u7a7a\u95f4\uff09\nlatest, _ := cm.Latest(ctx, lineageID, \"\")\n\n// \u5217\u8868\uff08\u6309\u65f6\u95f4\u5012\u5e8f\uff09\ntuples, _ := cm.ListCheckpoints(ctx, graph.NewCheckpointConfig(lineageID).ToMap(), &amp;graph.CheckpointFilter{Limit: 10})\n\n// \u83b7\u53d6\u5177\u4f53\u68c0\u67e5\u70b9\u5143\u7ec4\uff08\u542b pending writes\uff09\ntuple, _ := cm.GetTuple(ctx, graph.CreateCheckpointConfig(lineageID, checkpointID, namespace))\n\n// \u5220\u9664\u8c31\u7cfb\n_ = cm.DeleteLineage(ctx, lineageID)\n</code></pre> <p>\u5efa\u8bae\u5728\u751f\u4ea7\u4e2d\u4e3a <code>namespace</code> \u4f7f\u7528\u7a33\u5b9a\u7684\u4e1a\u52a1\u6807\u8bc6\uff08\u5982 <code>svc:prod:flowX</code>\uff09\uff0c\u4fbf\u4e8e\u5ba1\u8ba1\u4e0e\u5bf9\u8d26\u3002</p>"},{"location":"zh/graph/#_35","title":"\u9ed8\u8ba4\u503c\u4e0e\u6ce8\u610f\u4e8b\u9879","text":"<ul> <li> <p>\u9ed8\u8ba4\u503c\uff08Executor\uff09</p> <ul> <li><code>ChannelBufferSize = 256</code>\u3001<code>MaxSteps = 100</code>\u3001<code>CheckpointSaveTimeout = 10s</code></li> <li>\u6b65/\u8282\u70b9\u8d85\u65f6\u53ef\u901a\u8fc7 <code>Executor</code> \u7684 <code>WithStepTimeout</code> / <code>WithNodeTimeout</code> \u914d\u7f6e\uff08\u76ee\u524d GraphAgent \u9009\u9879\u672a\u76f4\u63a5\u66b4\u9732\uff09</li> </ul> </li> </ul> <ul> <li>\u4f1a\u8bdd<ul> <li>\u751f\u4ea7\u73af\u5883\u4f18\u5148\u4f7f\u7528 Redis Session\uff1b\u8bbe\u7f6e\u5408\u7406 TTL \u4e0e\u6e05\u7406\u7b56\u7565</li> </ul> </li> <li>Runner \u4f1a\u81ea\u52a8\u4ece\u4f1a\u8bdd\u4e8b\u4ef6\u64ad\u79cd\u591a\u8f6e <code>graph.StateKeyMessages</code></li> </ul> <ul> <li> <p>\u68c0\u67e5\u70b9</p> <ul> <li>\u91c7\u7528\u7a33\u5b9a\u7684 <code>namespace</code> \u547d\u540d\uff08\u5982 <code>svc:prod:flowX</code>\uff09\uff1b\u4f7f\u7528 <code>CheckpointManager</code> \u6309\u8c31\u7cfb\u5ba1\u8ba1\u4e0e\u6e05\u7406</li> </ul> </li> </ul> <ul> <li> <p>\u4e8b\u4ef6\u4e0e\u80cc\u538b</p> <ul> <li>\u8c03\u6574 <code>WithChannelBufferSize</code>\uff1b\u6309 <code>author</code>/<code>object</code> \u8fc7\u6ee4\u4e8b\u4ef6\u964d\u4f4e\u566a\u97f3</li> </ul> </li> </ul> <ul> <li> <p>\u547d\u540d\u4e0e\u952e</p> <ul> <li>\u8282\u70b9/\u8def\u7531\u6807\u7b7e/\u72b6\u6001\u952e\u4f7f\u7528\u5e38\u91cf\uff1b\u4e3a\u9700\u8981\u5408\u5e76\u7684\u952e\u58f0\u660e Reducer</li> </ul> </li> </ul> <ul> <li>\u6cbb\u7406\u4e0e\u5408\u89c4</li> <li>\u5173\u952e\u8def\u5f84\u5f15\u5165 HITL\uff1b\u654f\u611f\u4fe1\u606f\u4f18\u5148\u843d\u5230 <code>graph.StateKeyMetadata</code>\uff0c\u907f\u514d\u6df7\u5165 <code>graph.StateKeyMessages</code></li> </ul>"},{"location":"zh/graph/#_36","title":"\u4e8b\u4ef6\u901f\u89c8","text":"<ul> <li> <p>Author \u7ea6\u5b9a</p> <ul> <li>\u8282\u70b9\u7ea7\uff1a\u8282\u70b9 ID\uff08\u65e0\u6cd5\u83b7\u53d6\u65f6\u4e3a <code>graph.AuthorGraphNode</code>\uff09</li> <li>Pregel \u9636\u6bb5\uff1a<code>graph.AuthorGraphPregel</code></li> <li>\u6267\u884c\u5668/\u7cfb\u7edf\uff1a<code>graph.AuthorGraphExecutor</code></li> <li>\u7528\u6237\u8f93\u5165\uff1a<code>user</code>\uff08\u672a\u5bfc\u51fa\u5e38\u91cf\uff09</li> </ul> </li> </ul> <ul> <li>\u5bf9\u8c61\u7c7b\u578b\uff08\u5b50\u96c6\uff09<ul> <li>\u8282\u70b9\uff1a<code>graph.ObjectTypeGraphNodeStart | graph.ObjectTypeGraphNodeComplete | graph.ObjectTypeGraphNodeError</code></li> <li>Pregel\uff1a<code>graph.ObjectTypeGraphPregelPlanning | graph.ObjectTypeGraphPregelExecution | graph.ObjectTypeGraphPregelUpdate</code></li> <li>\u901a\u9053/\u72b6\u6001\uff1a<code>graph.ObjectTypeGraphChannelUpdate</code> / <code>graph.ObjectTypeGraphStateUpdate</code></li> <li>\u68c0\u67e5\u70b9\uff1a<code>graph.ObjectTypeGraphCheckpoint</code>\u3001<code>graph.ObjectTypeGraphCheckpointCreated</code>\u3001<code>graph.ObjectTypeGraphCheckpointCommitted</code>\u3001<code>graph.ObjectTypeGraphCheckpointInterrupt</code></li> </ul> </li> </ul> <p>\u66f4\u591a\u793a\u4f8b\u89c1\u4e0b\u6587\u201c\u4e8b\u4ef6\u76d1\u63a7\u201d\u3002</p>"},{"location":"zh/graph/#human-in-the-loop","title":"Human-in-the-Loop","text":"<p>\u5728\u5173\u952e\u8def\u5f84\u4e0a\u5f15\u5165\u4eba\u5de5\u786e\u8ba4\uff08HITL\uff09\u80fd\u591f\u663e\u8457\u63d0\u5347\u53ef\u63a7\u6027\u3002\u4e0b\u9762\u7684\u793a\u4f8b\u5c55\u793a\u4e00\u4e2a\u201c\u4e2d\u65ad\u2014\u6062\u590d\u201d\u7684\u57fa\u672c\u6d41\u7a0b\uff1a</p> <pre><code>import (\n    \"context\"\n    \"fmt\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/agent\"\n    \"trpc.group/trpc-go/trpc-agent-go/graph\"\n    \"trpc.group/trpc-go/trpc-agent-go/model\"\n)\n\nconst (\n    stateKeyContent    = \"content\"\n    stateKeyDecision   = \"decision\"\n    interruptKeyReview = \"review_key\"\n    nodeReview         = \"review\"\n)\n\nsg.AddNode(nodeReview, func(ctx context.Context, s graph.State) (any, error) {\n    content := s[stateKeyContent].(string)\n\n    // \u4e2d\u65ad\u5e76\u7b49\u5f85\u4eba\u5de5\u8f93\u5165\n    result, err := graph.Interrupt(ctx, s, interruptKeyReview,\n        fmt.Sprintf(\"\u8bf7\u5ba1\u6838: %s\", content))\n    if err != nil {\n        return nil, err\n    }\n\n    return graph.State{stateKeyDecision: result}, nil\n})\n\n// \u6062\u590d\u6267\u884c\uff08\u9700\u8981 import agent \u5305\uff09\neventCh, err := r.Run(ctx, userID, sessionID,\n    model.NewUserMessage(\"resume\"),\n    agent.WithRuntimeState(map[string]any{\n        graph.CfgKeyCheckpointID: checkpointID,\n        graph.StateKeyResumeMap: map[string]any{\n            \"review_key\": \"approved\",\n        },\n    }),\n)\n</code></pre> <p>\u6062\u590d\u8f85\u52a9\u51fd\u6570\uff1a</p> <pre><code>// \u5e26\u7c7b\u578b\u7684\u6062\u590d\u503c\u8bfb\u53d6\nif v, ok := graph.ResumeValue[string](ctx, state, \"approval\"); ok { /* \u4f7f\u7528 v */ }\n\n// \u5e26\u9ed8\u8ba4\u503c\nv := graph.ResumeValueOrDefault(ctx, state, \"approval\", \"no\")\n\n// \u5224\u65ad/\u6e05\u7406\n_ = graph.HasResumeValue(state, \"approval\")\ngraph.ClearResumeValue(state, \"approval\")\ngraph.ClearAllResumeValues(state)\n</code></pre> <p>\u4e5f\u53ef\u4ee5\u5728\u6267\u884c\u5165\u53e3\u901a\u8fc7\u547d\u4ee4\u6ce8\u5165\u6062\u590d\u503c\uff08\u65e0\u9700\u63d0\u524d\u5230\u7279\u5b9a\u8282\u70b9\uff09\u3002\u4f7f\u7528 Runner \u4f20\u5165 <code>RuntimeState</code> \u5373\u53ef\uff1a</p> <pre><code>cmd := graph.NewResumeCommand().\n    WithResumeMap(map[string]any{\"approval\": \"yes\"})\n\n// \u901a\u8fc7 RuntimeState \u6ce8\u5165 __command__ \u5230\u521d\u59cb\u72b6\u6001\nevents, err := r.Run(ctx, userID, sessionID,\n    model.NewUserMessage(\"resume\"),\n    agent.WithRuntimeState(map[string]any{\n        graph.StateKeyCommand: cmd,\n    }),\n)\n</code></pre>"},{"location":"zh/graph/#_37","title":"\u4e8b\u4ef6\u76d1\u63a7","text":"<p>\u4e8b\u4ef6\u6d41\u627f\u8f7d\u4e86\u6574\u4e2a\u56fe\u7684\u6267\u884c\u8fc7\u7a0b\u4e0e\u589e\u91cf\u8f93\u51fa\u3002\u4e0b\u9762\u7684\u793a\u4f8b\u5c55\u793a\u4e86\u5982\u4f55\u904d\u5386\u4e8b\u4ef6\u5e76\u533a\u5206\u56fe\u4e8b\u4ef6\u4e0e\u6a21\u578b\u589e\u91cf\uff1a</p> <pre><code>import (\n    \"fmt\"\n    \"trpc.group/trpc-go/trpc-agent-go/graph\"\n)\n\nfor ev := range eventCh {\n    if ev.Response == nil {\n        continue\n    }\n    // \u6309\u5bf9\u8c61\u7c7b\u578b\u5206\u6d41\uff08Graph \u6269\u5c55\u4e8b\u4ef6\u7c7b\u578b\u89c1 graph/events.go\uff09\n    switch ev.Response.Object {\n    case graph.ObjectTypeGraphNodeStart:\n        fmt.Println(\"\u8282\u70b9\u5f00\u59cb\")\n    case graph.ObjectTypeGraphNodeComplete:\n        fmt.Println(\"\u8282\u70b9\u5b8c\u6210\")\n    case graph.ObjectTypeGraphChannelUpdate:\n        fmt.Println(\"\u901a\u9053\u66f4\u65b0\")\n    case graph.ObjectTypeGraphCheckpoint, graph.ObjectTypeGraphCheckpointCommitted:\n        fmt.Println(\"\u68c0\u67e5\u70b9\u4e8b\u4ef6\")\n    }\n    // \u540c\u65f6\u5904\u7406\u6a21\u578b\u589e\u91cf/\u6700\u7ec8\u8f93\u51fa\n    if len(ev.Response.Choices) &gt; 0 {\n        ch := ev.Response.Choices[0]\n        if ev.Response.IsPartial &amp;&amp; ch.Delta.Content != \"\" {\n            fmt.Print(ch.Delta.Content)\n        } else if !ev.Response.IsPartial &amp;&amp; ch.Message.Content != \"\" {\n            fmt.Println(\"\\n\u8f93\u51fa:\", ch.Message.Content)\n        }\n    }\n}\n</code></pre> <p>\u5728\u5b9e\u9645\u4f7f\u7528\u4e2d\uff0c\u5efa\u8bae\u7ed3\u5408 Event \u7684 <code>Author</code> \u5b57\u6bb5\u8fdb\u884c\u8fc7\u6ee4\uff1a</p> <ul> <li>\u8282\u70b9\u7ea7\u4e8b\u4ef6\uff08\u6a21\u578b\u3001\u5de5\u5177\u3001\u8282\u70b9\u8d77\u6b62\uff09\uff1a<code>Author = &lt;nodeID&gt;</code>\uff08\u82e5\u65e0\u6cd5\u83b7\u53d6 nodeID\uff0c\u5219\u4e3a <code>graph-node</code>\uff09</li> <li>Pregel\uff08\u89c4\u5212/\u6267\u884c/\u66f4\u65b0/\u9519\u8bef\uff09\uff1a<code>Author = graph.AuthorGraphPregel</code></li> <li>\u6267\u884c\u5668\u7ea7\u522b\u4e8b\u4ef6\uff08\u72b6\u6001\u66f4\u65b0/\u68c0\u67e5\u70b9\u7b49\uff09\uff1a<code>Author = graph.AuthorGraphExecutor</code></li> <li>\u7528\u6237\u8f93\u5165\u4e8b\u4ef6\uff08Runner \u5199\u5165\uff09\uff1a<code>Author = user</code></li> </ul> <p>\u5229\u7528\u8fd9\u4e00\u7ea6\u5b9a\uff0c\u4f60\u53ef\u4ee5\u7cbe\u51c6\u8ba2\u9605\u67d0\u4e2a\u8282\u70b9\u7684\u6d41\u5f0f\u8f93\u51fa\uff0c\u800c\u65e0\u9700\u5728\u8282\u70b9\u4e4b\u95f4\u4f20\u9012\u6d41\u5f0f\u4e0a\u4e0b\u6587\uff08\u6d41\u5f0f\u7531\u4e8b\u4ef6\u901a\u9053\u7edf\u4e00\u627f\u8f7d\uff0c\u72b6\u6001\u4ecd\u6309 LangGraph \u98ce\u683c\u4ee5\u7ed3\u6784\u5316 State \u4f20\u9012\uff09\u3002</p> <p>\u793a\u4f8b\uff1a\u4ec5\u6d88\u8d39\u8282\u70b9 <code>ask</code> \u7684\u6d41\u5f0f\u8f93\u51fa\uff0c\u5e76\u5728\u5b8c\u6210\u65f6\u6253\u5370\u6700\u7ec8\u6d88\u606f\u3002</p> <pre><code>import (\n    \"fmt\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/graph\"\n)\n\nconst nodeIDWatch = \"ask\"\n\nfor ev := range eventCh {\n    // \u4ec5\u5173\u6ce8\u6765\u81ea\u6307\u5b9a\u8282\u70b9\u7684\u4e8b\u4ef6\n    if ev.Author != nodeIDWatch {\n        continue\n    }\n    if ev.Response == nil || len(ev.Response.Choices) == 0 {\n        continue\n    }\n    choice := ev.Response.Choices[0]\n\n    // \u8282\u70b9\u7684\u6d41\u5f0f\u589e\u91cf\uff08Delta\uff09\n    if ev.Response.IsPartial &amp;&amp; choice.Delta.Content != \"\" {\n        fmt.Print(choice.Delta.Content)\n        continue\n    }\n\n    // \u8282\u70b9\u7684\u6700\u7ec8\u5b8c\u6574\u6d88\u606f\n    if !ev.Response.IsPartial &amp;&amp; choice.Message.Content != \"\" {\n        fmt.Println(\"\\n[ask] \u6700\u7ec8\u8f93\u51fa:\", choice.Message.Content)\n    }\n}\n</code></pre>"},{"location":"zh/graph/#statedelta_1","title":"\u4e8b\u4ef6\u5143\u6570\u636e\uff08StateDelta\uff09","text":"<p>\u6bcf\u4e2a\u4e8b\u4ef6\u8fd8\u643a\u5e26 <code>StateDelta</code>\uff0c\u53ef\u8bfb\u53d6\u6a21\u578b/\u5de5\u5177\u7b49\u6267\u884c\u5143\u6570\u636e\uff1a</p> <pre><code>import (\n    \"encoding/json\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/graph\"\n)\n\nfor ev := range events {\n    if ev.StateDelta == nil { continue }\n    if b, ok := ev.StateDelta[graph.MetadataKeyModel]; ok {\n        var md graph.ModelExecutionMetadata\n        _ = json.Unmarshal(b, &amp;md)\n        // \u4f7f\u7528 md.Input / md.Output / md.Duration \u7b49\n    }\n    if b, ok := ev.StateDelta[graph.MetadataKeyTool]; ok {\n        var td graph.ToolExecutionMetadata\n        _ = json.Unmarshal(b, &amp;td)\n    }\n}\n</code></pre>"},{"location":"zh/graph/#_38","title":"\u5728\u8282\u70b9\u56de\u8c03\u4e2d\u643a\u5e26\u4e1a\u52a1\u503c","text":"<p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0c\u4e2d\u9014\u4e8b\u4ef6\uff08\u5982 <code>graph.state.update</code>\uff09\u53ea\u4f1a\u4e0a\u62a5\u201c\u66f4\u65b0\u4e86\u54ea\u4e9b\u952e\u201d\uff0c\u4e0d\u643a\u5e26\u503c\uff1b\u6700\u7ec8\u5b8c\u6210\u4e8b\u4ef6\uff08<code>graph.execution</code>\uff09\u7684 <code>StateDelta</code> \u624d\u5305\u542b\u201c\u6700\u7ec8\u72b6\u6001\u5feb\u7167\u201d\u3002\u5982\u679c\u4ec5\u9700\u5728\u201c\u67d0\u4e2a\u8282\u70b9\u201d\u5b8c\u6210\u540e\uff0c\u5c06\u5176\u8fd4\u56de\u7684\u90e8\u5206\u952e\u503c\u5373\u65f6\u53d1\u7ed9\u4e0a\u6e38\u670d\u52a1\uff0c\u53ef\u5728\u8be5\u8282\u70b9\u7684 After \u56de\u8c03\u4e2d\u6784\u9020\u5e76\u53d1\u9001\u4e00\u6761\u81ea\u5b9a\u4e49\u4e8b\u4ef6\uff1a</p> <p>\u5b9e\u73b0\u6b65\u9aa4\uff1a</p> <ul> <li>\u5728\u8282\u70b9\u4e0a\u6ce8\u518c <code>WithPostNodeCallback</code>\uff1b</li> <li>\u5728\u56de\u8c03\u7684 <code>result any</code> \u4e2d\u8bfb\u53d6\u8be5\u8282\u70b9\u8fd4\u56de\u7684 <code>graph.State</code>\uff08state delta\uff09\uff1b</li> <li>\u9009\u62e9\u9700\u8981\u7684\u952e\u503c\uff0c\u5e8f\u5217\u5316\u540e\u653e\u5165\u81ea\u5b9a\u4e49\u4e8b\u4ef6\u7684 <code>StateDelta</code>\uff1b</li> <li>\u901a\u8fc7 <code>agent.EmitEvent</code> \u53d1\u9001\u5230\u4e8b\u4ef6\u901a\u9053\u3002</li> </ul> <p>\u793a\u4f8b\uff1a</p> <pre><code>import (\n    \"context\"\n    \"encoding/json\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/agent\"\n    \"trpc.group/trpc-go/trpc-agent-go/graph\"\n)\n\nconst (\n    nodeParse   = \"parse\"\n    stateKeyOut = \"parsed_value\" // \u4ec5\u8f93\u51fa\u6240\u9700\u952e\n)\n\nfunc parseNode(ctx context.Context, s graph.State) (any, error) {\n    // ...\u4e1a\u52a1\u5904\u7406...\n    val := map[string]any{\"ok\": true, \"score\": 0.97}\n    return graph.State{stateKeyOut: val}, nil\n}\n\nfunc buildGraph() (*graph.Graph, error) {\n    sg := graph.NewStateGraph(graph.MessagesStateSchema())\n    sg.AddNode(nodeParse, parseNode,\n        graph.WithPostNodeCallback(func(\n            ctx context.Context,\n            cb *graph.NodeCallbackContext,\n            st graph.State,\n            result any,\n            nodeErr error,\n        ) (any, error) {\n            if nodeErr != nil { return nil, nil }\n            inv, _ := agent.InvocationFromContext(ctx)\n            execCtx, _ := st[graph.StateKeyExecContext].(*graph.ExecutionContext)\n            if delta, ok := result.(graph.State); ok {\n                if v, exists := delta[stateKeyOut]; exists &amp;&amp; execCtx != nil {\n                    evt := graph.NewGraphEvent(\n                        inv.InvocationID,\n                        cb.NodeID,\n                        graph.ObjectTypeGraphNodeExecution,\n                    )\n                    if evt.StateDelta == nil { evt.StateDelta = make(map[string][]byte) }\n                    if b, err := json.Marshal(v); err == nil {\n                        evt.StateDelta[stateKeyOut] = b\n                        _ = agent.EmitEvent(ctx, inv, execCtx.EventChan, evt)\n                    }\n                }\n            }\n            return nil, nil\n        }),\n    ).\n        SetEntryPoint(nodeParse).\n        SetFinishPoint(nodeParse)\n    return sg.Compile()\n}\n</code></pre> <p>\u5efa\u8bae\uff1a</p> <ul> <li>\u4ec5\u8f93\u51fa\u5fc5\u8981\u952e\uff0c\u63a7\u5236\u8d1f\u8f7d\u4e0e\u654f\u611f\u4fe1\u606f\uff1b</li> <li>\u5185\u90e8/\u6613\u53d8\u952e\u4e0d\u4f1a\u88ab\u5e8f\u5217\u5316\u5230\u6700\u7ec8\u5feb\u7167\uff0c\u4ea6\u4e0d\u5efa\u8bae\u5916\u53d1\uff08\u53c2\u8003 graph/internal_keys.go:16\uff09\uff1b</li> <li>\u6587\u672c\u7c7b\u4e2d\u95f4\u7ed3\u679c\u4f18\u5148\u590d\u7528\u6a21\u578b\u6d41\u5f0f\u4e8b\u4ef6\uff08<code>choice.Delta.Content</code>\uff09\u3002</li> </ul> <p>\u4e5f\u53ef\u4ee5\u5728 Agent \u7ea7\u522b\u914d\u7f6e\u56de\u8c03\uff1a</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/agent\"\n    \"trpc.group/trpc-go/trpc-agent-go/model\"\n)\n\n// \u65b9\u5f0f\u4e00\uff1a\u6784\u9020\u56de\u8c03\u5e76\u6ce8\u518c\uff08\u63a8\u8350\uff09\n// \u6ce8\u610f\uff1a\u7ed3\u6784\u5316\u56de\u8c03 API \u9700\u8981 trpc-agent-go &gt;= 0.6.0\ncb := agent.NewCallbacks().\n    RegisterBeforeAgent(func(ctx context.Context, args *agent.BeforeAgentArgs) (*agent.BeforeAgentResult, error) {\n        // \u8fd4\u56de\u975e\u7a7a CustomResponse \u53ef\u76f4\u63a5\u77ed\u8def\u6b64\u8f6e\u6267\u884c\n        return nil, nil\n    }).\n    RegisterAfterAgent(func(ctx context.Context, args *agent.AfterAgentArgs) (*agent.AfterAgentResult, error) {\n        // \u53ef\u5bf9\u6700\u7ec8\u54cd\u5e94\u505a\u7edf\u4e00\u4fee\u6539/\u66ff\u6362\n        return nil, nil\n    })\n\ngraphAgent, _ := graphagent.New(\"workflow\", g,\n    graphagent.WithAgentCallbacks(cb),\n)\n</code></pre>"},{"location":"zh/graph/#_39","title":"\u5e38\u89c1\u95ee\u9898\u6392\u67e5","text":"<p>Q1: \u62a5\u9519 \"graph must have an entry point\"</p> <ul> <li>\u672a\u8bbe\u7f6e\u5165\u53e3\u70b9\u3002\u8c03\u7528 <code>SetEntryPoint()</code>\uff0c\u5e76\u786e\u4fdd\u76ee\u6807\u8282\u70b9\u5df2\u5b9a\u4e49\u3002</li> </ul> <p>Q2: \u62a5\u9519\u76ee\u6807/\u6e90\u8282\u70b9\u4e0d\u5b58\u5728</p> <ul> <li>\u5728\u8fde\u8fb9/\u6761\u4ef6\u8def\u7531\u524d\u5148\u5b9a\u4e49\u8282\u70b9\uff1b\u6761\u4ef6\u8def\u7531\u7684 <code>pathMap</code> \u76ee\u6807\u4e5f\u9700\u5b58\u5728\u3002</li> </ul> <p>Q3: \u5de5\u5177\u672a\u6267\u884c</p> <ul> <li>\u786e\u8ba4 LLM \u8fd4\u56de\u4e86 <code>tool_calls</code>\uff0c\u5e76\u4f7f\u7528\u4e86 <code>AddToolsConditionalEdges(ask, tools, fallback)</code>\uff1b</li> <li>\u5de5\u5177\u540d\u9700\u4e0e\u6a21\u578b\u58f0\u660e\u4e00\u81f4\uff1b</li> <li>\u914d\u5bf9\u89c4\u5219\u662f\u4ece\u6700\u8fd1\u4e00\u6b21 <code>assistant(tool_calls)</code> \u56de\u6eaf\u5230\u4e0b\u4e00\u4e2a <code>user</code>\uff0c\u68c0\u67e5\u6d88\u606f\u987a\u5e8f\u3002</li> </ul> <p>Q4: LLM \u8fd4\u56de tool_calls \u4f46\u5de5\u5177\u8282\u70b9\u672a\u6267\u884c\uff08\u6c38\u8fdc\u8def\u7531\u5230 fallback\uff09</p> <ul> <li>\u6839\u672c\u539f\u56e0\uff1a\u4f7f\u7528\u4e86 <code>NewStateSchema()</code> \u800c\u975e <code>MessagesStateSchema()</code>\u3002</li> <li><code>AddToolsConditionalEdges</code> \u5185\u90e8\u68c0\u67e5 <code>state[StateKeyMessages].([]model.Message)</code> \u6765\u5224\u65ad\u662f\u5426\u6709\u5de5\u5177\u8c03\u7528\u3002</li> <li>\u5982\u679c Schema \u4e2d\u6ca1\u6709 <code>StateKeyMessages</code> \u5b57\u6bb5\uff0c<code>MessageReducer</code> \u4e0d\u4f1a\u88ab\u5e94\u7528\uff0cLLM \u8282\u70b9\u8fd4\u56de\u7684\u662f <code>[]graph.MessageOp</code> \u7c7b\u578b\u800c\u975e <code>[]model.Message</code>\uff0c\u5bfc\u81f4\u7c7b\u578b\u65ad\u8a00\u5931\u8d25\uff0c\u6c38\u8fdc\u8def\u7531\u5230 <code>fallbackNode</code>\u3002</li> <li>\u89e3\u51b3\u65b9\u6848\uff1a\u5c06 <code>graph.NewStateSchema()</code> \u6539\u4e3a <code>graph.MessagesStateSchema()</code>\uff0c\u7136\u540e\u5728\u5176\u57fa\u7840\u4e0a\u6dfb\u52a0\u4e1a\u52a1\u5b57\u6bb5\uff1a   <pre><code>// \u9519\u8bef\u5199\u6cd5\nschema := graph.NewStateSchema()\n\n// \u6b63\u786e\u5199\u6cd5\nschema := graph.MessagesStateSchema()\nschema.AddField(\"my_field\", graph.StateField{...})\n</code></pre></li> </ul> <p>Q5: \u6ca1\u6709\u89c2\u5bdf\u5230\u6d41\u5f0f\u4e8b\u4ef6</p> <ul> <li>\u8c03\u5927 <code>WithChannelBufferSize</code> \u5e76\u6309 <code>Author</code>/\u5bf9\u8c61\u7c7b\u578b\u8fc7\u6ee4\uff1b</li> <li>\u786e\u8ba4\u4ece <code>Runner.Run(...)</code> \u6d88\u8d39\u4e8b\u4ef6\u3002</li> </ul> <p>Q6: \u4ece\u68c0\u67e5\u70b9\u6062\u590d\u672a\u6309\u9884\u671f\u7ee7\u7eed</p> <ul> <li>\u901a\u8fc7 <code>agent.WithRuntimeState(map[string]any{ graph.CfgKeyCheckpointID: \"...\" })</code> \u4f20\u5165\uff1b</li> <li>HITL \u6062\u590d\u65f6\u63d0\u4f9b <code>ResumeMap</code>\uff1b\u7eaf \"resume\" \u6587\u672c\u4e0d\u4f1a\u6ce8\u5165\u5230 <code>graph.StateKeyUserInput</code>\u3002</li> </ul> <p>Q7: \u5e76\u884c\u4e0b\u72b6\u6001\u51b2\u7a81</p> <ul> <li>\u4e3a\u5217\u8868/\u6620\u5c04\u7b49\u58f0\u660e\u5408\u5e76\u578b Reducer\uff08\u5982 <code>StringSliceReducer</code>\u3001<code>MergeReducer</code>\uff09\uff0c\u907f\u514d\u591a\u4e2a\u5206\u652f\u8986\u76d6\u540c\u4e00\u952e\u3002</li> </ul> <p>Q8: AddLLMNode \u7684 tools \u53c2\u6570\u8d77\u4ec0\u4e48\u4f5c\u7528\uff1f\u5de5\u5177\u4f55\u65f6\u88ab\u8c03\u7528\uff1f</p> <ul> <li>tools \u53c2\u6570\u662f\u58f0\u660e\u6027\u7684\uff1a\u4f20\u7ed9 <code>AddLLMNode</code> \u7684 tools \u4f1a\u88ab\u653e\u5165 <code>model.Request.Tools</code> \u5b57\u6bb5\uff0c\u544a\u8bc9 LLM \u6709\u54ea\u4e9b\u5de5\u5177\u53ef\u7528\u3002</li> <li>LLM \u51b3\u5b9a\u662f\u5426\u8c03\u7528\u5de5\u5177\uff1aLLM \u6839\u636e tools \u58f0\u660e\u548c\u7528\u6237\u8f93\u5165\uff0c\u51b3\u5b9a\u662f\u5426\u5728\u54cd\u5e94\u4e2d\u8fd4\u56de <code>tool_calls</code>\u3002</li> <li>tools \u4e0d\u4f1a\u81ea\u52a8\u6267\u884c\uff1a<code>AddLLMNode</code> \u53ea\u8d1f\u8d23\u58f0\u660e\u5de5\u5177\u3001\u53d1\u9001\u8bf7\u6c42\u7ed9 LLM\uff0c\u4e0d\u4f1a\u6267\u884c\u5de5\u5177\u3002</li> <li>\u5de5\u5177\u6267\u884c\u9700\u8981\u914d\u5408 AddToolsNode + AddToolsConditionalEdges\uff1a   <pre><code>// 1. LLM \u8282\u70b9\u58f0\u660e\u5de5\u5177\uff08\u544a\u8bc9 LLM \u6709\u54ea\u4e9b\u5de5\u5177\u53ef\u7528\uff09\nsg.AddLLMNode(\"ask\", model, systemPrompt, tools)\n\n// 2. \u5de5\u5177\u8282\u70b9\u8d1f\u8d23\u6267\u884c\u5de5\u5177\uff08\u6839\u636e LLM \u8fd4\u56de\u7684 tool_calls\uff09\nsg.AddToolsNode(\"tools\", tools)\n\n// 3. \u6761\u4ef6\u8fb9\u6839\u636e LLM \u54cd\u5e94\u8def\u7531\uff08\u6709 tool_calls \u5219\u8def\u7531\u5230\u5de5\u5177\u8282\u70b9\uff09\nsg.AddToolsConditionalEdges(\"ask\", \"tools\", \"fallback\")\n</code></pre></li> <li>\u8c03\u7528\u65f6\u673a\uff1a\u5f53 <code>AddToolsConditionalEdges</code> \u68c0\u6d4b\u5230 LLM \u54cd\u5e94\u4e2d\u5305\u542b <code>tool_calls</code> \u65f6\uff0c\u4f1a\u8def\u7531\u5230 <code>AddToolsNode</code>\uff0c\u7531\u5de5\u5177\u8282\u70b9\u6267\u884c\u5b9e\u9645\u8c03\u7528\u3002</li> </ul> <p>Q9: \u591a\u4e2a LLM \u8282\u70b9\u4e32\u8054\u65f6\uff0creq.Messages \u4e2d\u6d88\u606f\u88ab\u91cd\u590d\u8ffd\u52a0</p> <ul> <li>\u95ee\u9898\u73b0\u8c61\uff1a\u540c\u4e00\u4e2a\u7528\u6237\u8f93\u5165\u5728 <code>req.Messages</code> \u4e2d\u51fa\u73b0\u591a\u6b21\u3002</li> <li>\u6839\u672c\u539f\u56e0\uff1a\u4f7f\u7528 <code>MessagesStateSchema()</code> \u65f6\uff0c<code>MessageReducer</code> \u4f1a\u7d2f\u79ef\u6d88\u606f\u3002\u6bcf\u4e2a LLM \u8282\u70b9\u6267\u884c\u65f6\uff0c\u5982\u679c <code>StateKeyUserInput</code> \u4e0d\u4e3a\u7a7a\uff0c\u4f1a\u8ffd\u52a0\u65b0\u7684 user message\u3002\u5f53\u5b58\u5728\u5faa\u73af\uff08\u5982\u5de5\u5177\u8c03\u7528\u5faa\u73af\uff09\u6216\u591a\u4e2a LLM \u8282\u70b9\u4e32\u8054\u65f6\uff0c\u6d88\u606f\u4f1a\u4e0d\u65ad\u7d2f\u79ef\u3002</li> <li>\u89e3\u51b3\u65b9\u6848\uff1a\u5728\u8bbe\u7f6e\u65b0\u7684 <code>StateKeyUserInput</code> \u4e4b\u524d\uff0c\u4f7f\u7528 <code>RemoveAllMessages</code> \u6e05\u9664\u4e4b\u524d\u7684\u6d88\u606f\uff1a   <pre><code>// \u5728\u51c6\u5907 prompt \u7684\u8282\u70b9\u4e2d\nfunc preparePromptNode(ctx context.Context, state graph.State) (any, error) {\n    userMessage := buildUserMessage(...)\n    return graph.State{\n        // \u5173\u952e\uff1a\u5148\u6e05\u9664\u4e4b\u524d\u7684\u6d88\u606f\uff0c\u907f\u514d\u7d2f\u79ef\n        graph.StateKeyMessages:  graph.RemoveAllMessages{},\n        graph.StateKeyUserInput: userMessage,\n    }, nil\n}\n</code></pre></li> <li>\u6ce8\u610f\uff1a<code>WithSubgraphIsolatedMessages(true)</code> \u53ea\u5bf9 <code>AddSubgraphNode</code> \u6709\u6548\uff0c\u5bf9 <code>AddLLMNode</code> \u65e0\u6548\u3002</li> </ul>"},{"location":"zh/graph/#_40","title":"\u5b9e\u9645\u6848\u4f8b","text":""},{"location":"zh/graph/#_41","title":"\u5ba1\u6279\u5de5\u4f5c\u6d41","text":"<pre><code>import (\n    \"context\"\n    \"fmt\"\n    \"strings\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/graph\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/openai\"\n)\n\nfunc buildApprovalWorkflow() (*graph.Graph, error) {\n    sg := graph.NewStateGraph(graph.MessagesStateSchema())\n\n    // AI \u521d\u5ba1\uff08\u5b9a\u4e49 LLM \u6a21\u578b\uff09\n    const (\n        modelNameApprove      = \"gpt-4o-mini\"\n        promptApproveDecision = \"\u5224\u65ad\u7533\u8bf7\u662f\u5426\u7b26\u5408\u8981\u6c42\uff0c\u56de\u590d approve \u6216 reject\"\n\n        nodeAIReview    = \"ai_review\"\n        nodeHumanReview = \"human_review\"\n        nodeApprove     = \"approve\"\n        nodeReject      = \"reject\"\n\n        routeHumanReview = \"route_human_review\"\n        routeReject      = \"route_reject\"\n        routeApprove     = \"route_approve\"\n\n        stateKeyApplication = \"application\"\n        stateKeyDecision    = \"decision\"\n    )\n\n    llm := openai.New(modelNameApprove)\n    sg.AddLLMNode(nodeAIReview, llm, promptApproveDecision, nil)\n\n    // \u6761\u4ef6\u8def\u7531\u5230\u4eba\u5de5\u5ba1\u6838\u6216\u62d2\u7edd\n    sg.AddConditionalEdges(nodeAIReview,\n        func(ctx context.Context, s graph.State) (string, error) {\n            resp := s[graph.StateKeyLastResponse].(string)\n            if strings.Contains(resp, \"approve\") {\n                return routeHumanReview, nil\n            }\n            return routeReject, nil\n        }, map[string]string{\n            routeHumanReview: nodeHumanReview,\n            routeReject:      nodeReject,\n        })\n\n    // \u4eba\u5de5\u5ba1\u6838\u8282\u70b9\n    sg.AddNode(nodeHumanReview, func(ctx context.Context, s graph.State) (any, error) {\n        app := s[stateKeyApplication].(string)\n        decision, err := graph.Interrupt(ctx, s, \"approval\",\n            fmt.Sprintf(\"\u8bf7\u5ba1\u6279: %s\", app))\n        if err != nil {\n            return nil, err\n        }\n        return graph.State{stateKeyDecision: decision}, nil\n    })\n\n    // \u7ed3\u679c\u5904\u7406\n    sg.AddNode(nodeApprove, func(ctx context.Context, s graph.State) (any, error) {\n        // \u6267\u884c\u6279\u51c6\u903b\u8f91\n        return graph.State{\"status\": \"approved\"}, nil\n    })\n    sg.AddNode(nodeReject, func(ctx context.Context, s graph.State) (any, error) {\n        return graph.State{\"status\": \"rejected\"}, nil\n    })\n\n    // \u914d\u7f6e\u6d41\u7a0b\n    sg.SetEntryPoint(nodeAIReview)\n    sg.AddConditionalEdges(nodeHumanReview,\n        func(ctx context.Context, s graph.State) (string, error) {\n            if s[stateKeyDecision] == \"approve\" {\n                return routeApprove, nil\n            }\n            return routeReject, nil\n        }, map[string]string{\n            routeApprove: nodeApprove,\n            routeReject:  nodeReject,\n        })\n\n    return sg.Compile()\n}\n</code></pre>"},{"location":"zh/graph/#_42","title":"\u603b\u7ed3","text":"<p>\u672c\u6587\u4ecb\u7ecd\u4e86 <code>graph</code> \u5305\u4e0e GraphAgent \u7684\u6838\u5fc3\u7528\u6cd5\uff1a\u5982\u4f55\u58f0\u660e\u8282\u70b9\u4e0e\u8def\u7531\u3001\u5982\u4f55\u901a\u8fc7 Schema \u4e0e Reducer \u5b89\u5168\u5408\u5e76\u72b6\u6001\u3001\u4ee5\u53ca\u5982\u4f55\u5229\u7528\u4e8b\u4ef6\u3001\u68c0\u67e5\u70b9\u4e0e\u4e2d\u65ad\u5b9e\u73b0\u53ef\u89c2\u6d4b\u4e0e\u53ef\u6062\u590d\u3002\u5bf9\u4e8e\u7ed3\u6784\u5316\u6d41\u7a0b\uff08\u5ba1\u6279\u3001\u5185\u5bb9\u5ba1\u6838\u3001\u5206\u6b65\u6570\u636e\u5904\u7406\u7b49\uff09\uff0cGraph \u63d0\u4f9b\u7a33\u5b9a\u3001\u53ef\u5ba1\u8ba1\u7684\u6267\u884c\u8def\u5f84\uff1b\u5bf9\u4e8e\u9700\u8981\u667a\u80fd\u51b3\u7b56\u7684\u73af\u8282\uff0c\u53ef\u901a\u8fc7 LLM \u8282\u70b9\u4e0e\u5b50 Agent \u7075\u6d3b\u6269\u5c55\u3002</p>"},{"location":"zh/graph/#_43","title":"\u53c2\u8003\u4e0e\u793a\u4f8b","text":"<ul> <li>\u4ee3\u7801\u4ed3\u5e93: https://github.com/trpc-group/trpc-agent-go</li> <li>Graph \u793a\u4f8b: <code>examples/graph</code> \u76ee\u5f55\uff08\u57fa\u7840/\u5e76\u884c/\u591a\u8f6e/\u4e2d\u65ad\u4e0e\u6062\u590d\u7b49\uff09<ul> <li>I/O \u7ea6\u5b9a\uff1a<code>io_conventions</code>\u3001<code>io_conventions_tools</code></li> <li>\u5e76\u884c / \u6247\u51fa\uff1a<code>parallel</code>\u3001<code>fanout</code>\u3001<code>diamond</code></li> <li>\u5360\u4f4d\u7b26\uff1a<code>placeholder</code></li> <li>\u68c0\u67e5\u70b9 / \u4e2d\u65ad\uff1a<code>checkpoint</code>\u3001<code>interrupt</code></li> </ul> </li> <li>\u8fdb\u4e00\u6b65\u9605\u8bfb\uff1a<code>graph/state_graph.go</code>\u3001<code>graph/executor.go</code>\u3001<code>agent/graphagent</code></li> </ul>"},{"location":"zh/knowledge/","title":"Knowledge \u4f7f\u7528\u6587\u6863","text":""},{"location":"zh/knowledge/#_1","title":"\u6982\u8ff0","text":"<p>Knowledge \u662f tRPC-Agent-Go \u6846\u67b6\u4e2d\u7684\u77e5\u8bc6\u7ba1\u7406\u7cfb\u7edf\uff0c\u4e3a Agent \u63d0\u4f9b\u68c0\u7d22\u589e\u5f3a\u751f\u6210\uff08Retrieval-Augmented Generation, RAG\uff09\u80fd\u529b\u3002\u901a\u8fc7\u96c6\u6210\u5411\u91cf\u6570\u636e\u3001embedding \u6a21\u578b\u548c\u6587\u6863\u5904\u7406\u7ec4\u4ef6\uff0cKnowledge \u7cfb\u7edf\u80fd\u591f\u5e2e\u52a9 Agent \u8bbf\u95ee\u548c\u68c0\u7d22\u76f8\u5173\u7684\u77e5\u8bc6\u4fe1\u606f\uff0c\u4ece\u800c\u63d0\u4f9b\u66f4\u51c6\u786e\u3001\u66f4\u6709\u4f9d\u636e\u7684\u54cd\u5e94\u3002</p>"},{"location":"zh/knowledge/#_2","title":"\u4f7f\u7528\u6a21\u5f0f","text":"<p>Knowledge \u7cfb\u7edf\u7684\u4f7f\u7528\u9075\u5faa\u4ee5\u4e0b\u6a21\u5f0f\uff1a</p> <ol> <li>\u521b\u5efa Knowledge\uff1a\u914d\u7f6e\u5411\u91cf\u5b58\u50a8\u3001Embedder \u548c\u77e5\u8bc6\u6e90</li> <li>\u52a0\u8f7d\u6587\u6863\uff1a\u4ece\u5404\u79cd\u6765\u6e90\u52a0\u8f7d\u548c\u7d22\u5f15\u6587\u6863</li> <li>\u96c6\u6210\u5230 Agent\uff1a\u4f7f\u7528 <code>WithKnowledge()</code> \u5c06 Knowledge \u96c6\u6210\u5230 LLM Agent \u4e2d</li> <li>Agent \u81ea\u52a8\u68c0\u7d22\uff1aAgent \u901a\u8fc7\u5185\u7f6e\u7684 <code>knowledge_search</code> \u5de5\u5177\u81ea\u52a8\u8fdb\u884c\u77e5\u8bc6\u68c0\u7d22</li> <li>\u77e5\u8bc6\u5e93\u7ba1\u7406\uff1a\u901a\u8fc7 <code>enableSourceSync</code> \u542f\u7528\u667a\u80fd\u540c\u6b65\u673a\u5236\uff0c\u786e\u4fdd\u5411\u91cf\u5b58\u50a8\u4e2d\u7684\u6570\u636e\u59cb\u7ec8\u4e0e\u7528\u6237\u914d\u7f6e\u7684 source \u4fdd\u6301\u4e00\u81f4</li> </ol> <p>\u8fd9\u79cd\u6a21\u5f0f\u63d0\u4f9b\u4e86\uff1a</p> <ul> <li>\u667a\u80fd\u68c0\u7d22\uff1a\u57fa\u4e8e\u5411\u91cf\u76f8\u4f3c\u5ea6\u7684\u8bed\u4e49\u641c\u7d22</li> <li>\u591a\u6e90\u652f\u6301\uff1a\u652f\u6301\u6587\u4ef6\u3001\u76ee\u5f55\u3001URL \u7b49\u591a\u79cd\u77e5\u8bc6\u6765\u6e90</li> <li>\u7075\u6d3b\u5b58\u50a8\uff1a\u652f\u6301\u5185\u5b58\u3001PostgreSQL\u3001TcVector \u7b49\u591a\u79cd\u5b58\u50a8\u540e\u7aef</li> <li>\u9ad8\u6027\u80fd\u5904\u7406\uff1a\u5e76\u53d1\u5904\u7406\u548c\u6279\u91cf\u6587\u6863\u52a0\u8f7d</li> <li>\u77e5\u8bc6\u8fc7\u6ee4\uff1a\u901a\u8fc7\u5143\u6570\u636e\uff0c\u652f\u6301\u77e5\u8bc6\u7684\u9759\u6001\u8fc7\u6ee4\u548c Agent \u667a\u80fd\u8fc7\u6ee4</li> <li>\u53ef\u6269\u5c55\u67b6\u6784\uff1a\u652f\u6301\u81ea\u5b9a\u4e49 Embedder\u3001Retriever \u548c Reranker</li> <li>\u52a8\u6001\u7ba1\u7406\uff1a\u652f\u6301\u8fd0\u884c\u65f6\u6dfb\u52a0\u3001\u79fb\u9664\u548c\u66f4\u65b0\u77e5\u8bc6\u6e90</li> <li>\u6570\u636e\u4e00\u81f4\u6027\u4fdd\u8bc1\uff1a\u901a\u8fc7 <code>enableSourceSync</code> \u5f00\u542f\u667a\u80fd\u540c\u6b65\u673a\u5236\uff0c\u786e\u4fdd\u5411\u91cf\u5b58\u50a8\u6570\u636e\u59cb\u7ec8\u4e0e\u7528\u6237\u914d\u7f6e\u7684 source \u4fdd\u6301\u4e00\u81f4\uff0c\u652f\u6301\u589e\u91cf\u5904\u7406\u3001\u53d8\u66f4\u68c0\u6d4b\u548c\u5b64\u513f\u6587\u6863\u81ea\u52a8\u6e05\u7406</li> </ul>"},{"location":"zh/knowledge/#agent","title":"Agent \u96c6\u6210","text":"<p>Knowledge \u7cfb\u7edf\u4e0e Agent \u7684\u96c6\u6210\u65b9\u5f0f\uff1a</p> <ul> <li>\u81ea\u52a8\u5de5\u5177\u6ce8\u518c\uff1a\u4f7f\u7528 <code>WithKnowledge()</code> \u9009\u9879\u81ea\u52a8\u6dfb\u52a0 <code>knowledge_search</code> \u5de5\u5177</li> <li>\u667a\u80fd\u8fc7\u6ee4\u5de5\u5177\uff1a\u4f7f\u7528 <code>WithEnableKnowledgeAgenticFilter(true)</code> \u542f\u7528 <code>knowledge_search_with_agentic_filter</code> \u5de5\u5177</li> <li>\u5de5\u5177\u8c03\u7528\uff1aAgent \u53ef\u4ee5\u8c03\u7528\u77e5\u8bc6\u641c\u7d22\u5de5\u5177\u83b7\u53d6\u76f8\u5173\u4fe1\u606f</li> <li>\u4e0a\u4e0b\u6587\u589e\u5f3a\uff1a\u68c0\u7d22\u5230\u7684\u77e5\u8bc6\u5185\u5bb9\u81ea\u52a8\u6dfb\u52a0\u5230 Agent \u7684\u4e0a\u4e0b\u6587\u4e2d</li> <li>\u5143\u6570\u636e\u8fc7\u6ee4\uff1a\u652f\u6301\u57fa\u4e8e\u6587\u6863\u5143\u6570\u636e\u8fdb\u884c\u7cbe\u51c6\u641c\u7d22</li> </ul>"},{"location":"zh/knowledge/#_3","title":"\u5feb\u901f\u5f00\u59cb","text":"<p>\u5b8c\u6574\u793a\u4f8b: examples/knowledge/basic</p>"},{"location":"zh/knowledge/#_4","title":"\u73af\u5883\u8981\u6c42","text":"<ul> <li>Go 1.24.1 \u6216\u66f4\u9ad8\u7248\u672c</li> <li>\u6709\u6548\u7684 LLM API \u5bc6\u94a5\uff08OpenAI \u517c\u5bb9\u63a5\u53e3\uff09</li> <li>\u5411\u91cf\u6570\u636e\u5e93\uff08\u53ef\u9009\uff0c\u7528\u4e8e\u751f\u4ea7\u73af\u5883\uff09</li> </ul>"},{"location":"zh/knowledge/#_5","title":"\u914d\u7f6e\u73af\u5883\u53d8\u91cf","text":"<pre><code># OpenAI API \u914d\u7f6e\nexport OPENAI_API_KEY=\"your-openai-api-key\"\nexport OPENAI_BASE_URL=\"your-openai-base-url\"\n\n# embedding \u6a21\u578b\u914d\u7f6e\uff08\u53ef\u9009\uff0c\u9700\u8981\u624b\u52a8\u8bfb\u53d6\uff09\nexport OPENAI_EMBEDDING_MODEL=\"text-embedding-3-small\"\n</code></pre>"},{"location":"zh/knowledge/#_6","title":"\u6700\u7b80\u793a\u4f8b","text":"<pre><code>package main\n\nimport (\n    \"context\"\n    \"log\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/agent/llmagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/knowledge\"\n    openaiembedder \"trpc.group/trpc-go/trpc-agent-go/knowledge/embedder/openai\"\n    \"trpc.group/trpc-go/trpc-agent-go/knowledge/source\"\n    dirsource \"trpc.group/trpc-go/trpc-agent-go/knowledge/source/dir\"\n    filesource \"trpc.group/trpc-go/trpc-agent-go/knowledge/source/file\"\n    knowledgetool \"trpc.group/trpc-go/trpc-agent-go/knowledge/tool\"\n    vectorinmemory \"trpc.group/trpc-go/trpc-agent-go/knowledge/vectorstore/inmemory\"\n    \"trpc.group/trpc-go/trpc-agent-go/model\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/openai\"\n    \"trpc.group/trpc-go/trpc-agent-go/runner\"\n    \"trpc.group/trpc-go/trpc-agent-go/session/inmemory\"\n    \"trpc.group/trpc-go/trpc-agent-go/tool\"\n\n    // \u5982\u9700\u652f\u6301 PDF \u6587\u4ef6\uff0c\u9700\u624b\u52a8\u5f15\u5165 PDF reader\uff08\u72ec\u7acb go.mod\uff0c\u907f\u514d\u5f15\u5165\u4e0d\u5fc5\u8981\u7684\u7b2c\u4e09\u65b9\u4f9d\u8d56\uff09\n    // _ \"trpc.group/trpc-go/trpc-agent-go/knowledge/document/reader/pdf\"\n)\n\nfunc main() {\n    ctx := context.Background()\n\n    // 1. \u521b\u5efa embedder\n    embedder := openaiembedder.New(\n        openaiembedder.WithModel(\"text-embedding-3-small\"),\n    )\n\n    // 2. \u521b\u5efa\u5411\u91cf\u5b58\u50a8\n    vectorStore := vectorinmemory.New()\n\n    // 3. \u521b\u5efa\u77e5\u8bc6\u6e90\n    sources := []source.Source{\n        filesource.New([]string{\"./data/llm.md\"}),\n        dirsource.New([]string{\"./dir\"}),\n    }\n\n    // 4. \u521b\u5efa Knowledge\n    kb := knowledge.New(\n        knowledge.WithEmbedder(embedder),\n        knowledge.WithVectorStore(vectorStore),\n        knowledge.WithSources(sources),\n        knowledge.WithEnableSourceSync(true),\n    )\n\n    // 5. \u52a0\u8f7d\u6587\u6863\n    if err := kb.Load(ctx); err != nil {\n        log.Fatalf(\"Failed to load knowledge base: %v\", err)\n    }\n\n    // 6. \u521b\u5efa\u641c\u7d22\u5de5\u5177\n    searchTool := knowledgetool.NewKnowledgeSearchTool(\n        kb,\n        knowledgetool.WithToolName(\"knowledge_search\"),\n        knowledgetool.WithToolDescription(\"Search for relevant information in the knowledge base.\"),\n    )\n\n    // 7. \u521b\u5efa Agent \u5e76\u6dfb\u52a0\u5de5\u5177\n    modelInstance := openai.New(\"claude-4-sonnet-20250514\")\n    llmAgent := llmagent.New(\n        \"knowledge-assistant\",\n        llmagent.WithModel(modelInstance),\n        llmagent.WithTools([]tool.Tool{searchTool}),\n    )\n\n    // 8. \u521b\u5efa Runner \u5e76\u6267\u884c\n    sessionService := inmemory.NewSessionService()\n    appRunner := runner.NewRunner(\"knowledge-chat\", llmAgent, runner.WithSessionService(sessionService))\n\n    message := model.NewUserMessage(\"\u8bf7\u544a\u8bc9\u6211\u5173\u4e8e LLM \u7684\u4fe1\u606f\")\n    _, err := appRunner.Run(ctx, \"user123\", \"session456\", message)\n    if err != nil {\n        log.Fatalf(\"Failed to run agent: %v\", err)\n    }\n}\n</code></pre>"},{"location":"zh/knowledge/#_7","title":"\u6838\u5fc3\u6982\u5ff5","text":"<p>knowledge \u6a21\u5757 \u662f tRPC-Agent-Go \u6846\u67b6\u7684\u77e5\u8bc6\u7ba1\u7406\u6838\u5fc3\uff0c\u63d0\u4f9b\u4e86\u5b8c\u6574\u7684 RAG \u80fd\u529b\u3002\u8be5\u6a21\u5757\u91c7\u7528\u6a21\u5757\u5316\u8bbe\u8ba1\uff0c\u652f\u6301\u591a\u79cd\u6587\u6863\u6e90\u3001\u5411\u91cf\u5b58\u50a8\u540e\u7aef\u548c embedding \u6a21\u578b\u3002</p> <pre><code>knowledge/\n\u251c\u2500\u2500 knowledge.go          # \u6838\u5fc3\u63a5\u53e3\u5b9a\u4e49\u548c\u4e3b\u8981\u5b9e\u73b0\n\u251c\u2500\u2500 source/               # \u6587\u6863\u6e90\u7ba1\u7406\n\u2502   \u251c\u2500\u2500 source.go        # Source \u63a5\u53e3\u5b9a\u4e49\n\u2502   \u251c\u2500\u2500 file.go          # \u6587\u4ef6\u6e90\u5b9e\u73b0\n\u2502   \u251c\u2500\u2500 dir.go           # \u76ee\u5f55\u6e90\u5b9e\u73b0\n\u2502   \u251c\u2500\u2500 url.go           # URL \u6e90\u5b9e\u73b0\n\u2502   \u2514\u2500\u2500 auto.go          # \u81ea\u52a8\u6e90\u7c7b\u578b\u68c0\u6d4b\n\u251c\u2500\u2500 vectorstore/          # \u5411\u91cf\u5b58\u50a8\u540e\u7aef\n\u2502   \u251c\u2500\u2500 vectorstore.go   # VectorStore \u63a5\u53e3\u5b9a\u4e49\n\u2502   \u251c\u2500\u2500 inmemory/        # \u5185\u5b58\u5411\u91cf\u5b58\u50a8\uff08\u5f00\u53d1/\u6d4b\u8bd5\u7528\uff09\n\u2502   \u251c\u2500\u2500 pgvector/        # PostgreSQL + pgvector \u5b9e\u73b0\n\u2502   \u2514\u2500\u2500 tcvector/        # \u817e\u8baf\u4e91\u5411\u91cf\u6570\u636e\u5e93\u5b9e\u73b0\n\u251c\u2500\u2500 embedder/             # \u6587\u672c embedding \u6a21\u578b\n\u2502   \u251c\u2500\u2500 embedder.go      # Embedder \u63a5\u53e3\u5b9a\u4e49\n\u2502   \u251c\u2500\u2500 openai/          # OpenAI embedding \u6a21\u578b\n\u2502   \u2514\u2500\u2500 local/           # \u672c\u5730 embedding \u6a21\u578b\n\u251c\u2500\u2500 reranker/             # \u7ed3\u679c\u91cd\u6392\n\u2502   \u251c\u2500\u2500 reranker.go      # Reranker \u63a5\u53e3\u5b9a\u4e49\n\u2502   \u251c\u2500\u2500 topk.go          # \u8fd4\u56detopK\u7684\u68c0\u7d22\u7ed3\u679c\n\u251c\u2500\u2500 document/             # \u6587\u6863\u8868\u793a\n\u2502   \u2514\u2500\u2500 document.go      # Document \u7ed3\u6784\u5b9a\u4e49\n\u251c\u2500\u2500 query/                # \u67e5\u8be2\u589e\u5f3a\u5668\n\u2502   \u251c\u2500\u2500 query.go         # QueryEnhancer \u63a5\u53e3\u5b9a\u4e49\n\u2502   \u2514\u2500\u2500 passthrough.go   # \u9ed8\u8ba4\u900f\u4f20\u589e\u5f3a\u5668\n\u2514\u2500\u2500 loader/               # \u6587\u6863\u52a0\u8f7d\u5668\n    \u2514\u2500\u2500 loader.go        # \u6587\u6863\u52a0\u8f7d\u903b\u8f91\n</code></pre>"},{"location":"zh/knowledge/#_8","title":"\u4f7f\u7528\u6307\u5357","text":""},{"location":"zh/knowledge/#agent_1","title":"\u4e0e Agent \u96c6\u6210","text":"<p>Knowledge \u7cfb\u7edf\u63d0\u4f9b\u4e86\u4e24\u79cd\u4e0e Agent \u96c6\u6210\u7684\u65b9\u5f0f\uff1a\u624b\u52a8\u6784\u5efa\u5de5\u5177\u548c\u81ea\u52a8\u96c6\u6210\u3002</p>"},{"location":"zh/knowledge/#_9","title":"\u65b9\u5f0f\u4e00\uff1a\u624b\u52a8\u6784\u5efa\u5de5\u5177\uff08\u63a8\u8350\uff09","text":"<p>\u4f7f\u7528 <code>NewKnowledgeSearchTool</code> \u624b\u52a8\u521b\u5efa\u641c\u7d22\u5de5\u5177\uff0c\u53ef\u4ee5\u7075\u6d3b\u914d\u7f6e\u5de5\u5177\u540d\u79f0\u3001\u63cf\u8ff0\uff0c\u5e76\u652f\u6301\u6784\u5efa\u591a\u4e2a\u77e5\u8bc6\u5e93\u3002</p> <pre><code>import (\n    knowledgetool \"trpc.group/trpc-go/trpc-agent-go/knowledge/tool\"\n    \"trpc.group/trpc-go/trpc-agent-go/tool\"\n)\n\n// \u521b\u5efa\u641c\u7d22\u5de5\u5177\nsearchTool := knowledgetool.NewKnowledgeSearchTool(\n    kb,\n    knowledgetool.WithToolName(\"knowledge_search\"),\n    knowledgetool.WithToolDescription(\"Search for relevant information in the knowledge base.\"),\n)\n\n// \u521b\u5efa Agent \u5e76\u6dfb\u52a0\u5de5\u5177\nllmAgent := llmagent.New(\n    \"knowledge-assistant\",\n    llmagent.WithModel(modelInstance),\n    llmagent.WithTools([]tool.Tool{searchTool}),\n)\n</code></pre>"},{"location":"zh/knowledge/#_10","title":"\u65b9\u5f0f\u4e8c\uff1a\u81ea\u52a8\u96c6\u6210","text":"<p>\u4f7f\u7528 <code>llmagent.WithKnowledge(kb)</code> \u5c06 Knowledge \u96c6\u6210\u5230 Agent\uff0c\u6846\u67b6\u4f1a\u81ea\u52a8\u6ce8\u518c <code>knowledge_search</code> \u5de5\u5177\u3002</p> <pre><code>llmAgent := llmagent.New(\n    \"knowledge-assistant\",\n    llmagent.WithModel(modelInstance),\n    llmagent.WithKnowledge(kb), // \u81ea\u52a8\u6dfb\u52a0 knowledge_search \u5de5\u5177\n)\n</code></pre> <p>\u4f7f\u7528 NewAgenticFilterSearchTool \u521b\u5efa\u667a\u80fd\u8fc7\u6ee4\u641c\u7d22\u5de5\u5177\uff1a</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/knowledge/source\"\n    knowledgetool \"trpc.group/trpc-go/trpc-agent-go/knowledge/tool\"\n)\n\n// \u83b7\u53d6\u6e90\u7684\u5143\u6570\u636e\u4fe1\u606f\uff08\u7528\u4e8e\u667a\u80fd\u8fc7\u6ee4\uff09\nsourcesMetadata := source.GetAllMetadata(sources)\n\n// \u521b\u5efa\u667a\u80fd\u8fc7\u6ee4\u641c\u7d22\u5de5\u5177\nfilterSearchTool := knowledgetool.NewAgenticFilterSearchTool(\n    kb,                    // Knowledge \u5b9e\u4f8b\n    sourcesMetadata,       // \u5143\u6570\u636e\u4fe1\u606f\n    knowledgetool.WithToolName(\"knowledge_search_with_filter\"),\n    knowledgetool.WithToolDescription(\"Search the knowledge base with intelligent metadata filtering.\"),\n)\n\nllmAgent := llmagent.New(\n    \"knowledge-assistant\",\n    llmagent.WithModel(modelInstance),\n    llmagent.WithTools([]tool.Tool{filterSearchTool}),\n)\n</code></pre>"},{"location":"zh/knowledge/#vectorstore","title":"\u5411\u91cf\u5b58\u50a8 (VectorStore)","text":"<p>\u793a\u4f8b\u4ee3\u7801: examples/knowledge/vectorstores</p> <p>\u5411\u91cf\u5b58\u50a8\u53ef\u5728\u4ee3\u7801\u4e2d\u901a\u8fc7\u9009\u9879\u914d\u7f6e\uff0c\u914d\u7f6e\u6765\u6e90\u53ef\u4ee5\u662f\u914d\u7f6e\u6587\u4ef6\u3001\u547d\u4ee4\u884c\u53c2\u6570\u6216\u73af\u5883\u53d8\u91cf\uff0c\u7528\u6237\u53ef\u4ee5\u81ea\u884c\u5b9e\u73b0\u3002</p> <p>trpc-agent-go \u652f\u6301\u591a\u79cd\u5411\u91cf\u5b58\u50a8\u5b9e\u73b0\uff1a</p> <ul> <li>Memory\uff1a\u5185\u5b58\u5411\u91cf\u5b58\u50a8\uff0c\u9002\u7528\u4e8e\u6d4b\u8bd5\u548c\u5c0f\u89c4\u6a21\u6570\u636e</li> <li>PGVector\uff1a\u57fa\u4e8e PostgreSQL + pgvector \u6269\u5c55\u7684\u5411\u91cf\u5b58\u50a8\uff0c\u652f\u6301\u6df7\u5408\u68c0\u7d22 - \u793a\u4f8b</li> <li>TcVector\uff1a\u817e\u8baf\u4e91\u5411\u91cf\u6570\u636e\u5e93\uff0c\u652f\u6301\u8fdc\u7a0b embedding \u8ba1\u7b97\u548c\u6df7\u5408\u68c0\u7d22 - \u793a\u4f8b</li> <li>Elasticsearch\uff1a\u652f\u6301 v7/v8/v9 \u591a\u7248\u672c\u7684 Elasticsearch \u5411\u91cf\u5b58\u50a8 - \u793a\u4f8b</li> <li>Milvus\uff1a\u9ad8\u6027\u80fd\u5411\u91cf\u6570\u636e\u5e93\uff0c\u652f\u6301\u5341\u4ebf\u7ea7\u5411\u91cf\u641c\u7d22 - \u793a\u4f8b</li> </ul>"},{"location":"zh/knowledge/#_11","title":"\u5411\u91cf\u5b58\u50a8\u914d\u7f6e\u793a\u4f8b","text":""},{"location":"zh/knowledge/#memory","title":"Memory\uff08\u5185\u5b58\u5411\u91cf\u5b58\u50a8\uff09","text":"<pre><code>import (\n    vectorinmemory \"trpc.group/trpc-go/trpc-agent-go/knowledge/vectorstore/inmemory\"\n)\n\n// \u5185\u5b58\u5b9e\u73b0\uff0c\u9002\u7528\u4e8e\u6d4b\u8bd5\u548c\u5c0f\u89c4\u6a21\u6570\u636e\nmemVS := vectorinmemory.New()\n\nkb := knowledge.New(\n    knowledge.WithVectorStore(memVS),\n    knowledge.WithEmbedder(embedder), // \u9700\u8981\u914d\u7f6e\u672c\u5730 embedder\n)\n</code></pre>"},{"location":"zh/knowledge/#pgvectorpostgresql-pgvector","title":"PGVector\uff08PostgreSQL + pgvector\uff09","text":"<pre><code>import (\n    vectorpgvector \"trpc.group/trpc-go/trpc-agent-go/knowledge/vectorstore/pgvector\"\n)\n\n// PostgreSQL + pgvector\npgVS, err := vectorpgvector.New(\n    vectorpgvector.WithPGVectorClientDSN(\"postgres://postgres:your-password@127.0.0.1:5432/your-database?sslmode=disable\"),\n    // \u6839\u636e embedding \u6a21\u578b\u8bbe\u7f6e\u7d22\u5f15\u7ef4\u5ea6\uff08text-embedding-3-small \u4e3a 1536\uff09\n    vectorpgvector.WithIndexDimension(1536),\n    // \u542f\u7528/\u5173\u95ed\u6587\u672c\u68c0\u7d22\u5411\u91cf\uff0c\u914d\u5408\u6df7\u5408\u68c0\u7d22\u6743\u91cd\u4f7f\u7528\n    vectorpgvector.WithEnableTSVector(true),\n    // \u8c03\u6574\u6df7\u5408\u68c0\u7d22\u6743\u91cd\uff08\u5411\u91cf\u76f8\u4f3c\u5ea6\u6743\u91cd\u4e0e\u6587\u672c\u76f8\u5173\u6027\u6743\u91cd\uff09\n    vectorpgvector.WithHybridSearchWeights(0.7, 0.3),\n    // \u5982\u5b89\u88c5\u4e86\u4e2d\u6587\u5206\u8bcd\u6269\u5c55\uff08\u5982 zhparser/jieba\uff09\uff0c\u53ef\u8bbe\u7f6e\u8bed\u8a00\u4ee5\u63d0\u5347\u6587\u672c\u53ec\u56de\n    vectorpgvector.WithLanguageExtension(\"english\"),\n)\nif err != nil {\n    // \u5904\u7406 error\n}\n\nkb := knowledge.New(\n    knowledge.WithVectorStore(pgVS),\n    knowledge.WithEmbedder(embedder), // \u9700\u8981\u914d\u7f6e\u672c\u5730 embedder\n)\n</code></pre>"},{"location":"zh/knowledge/#tcvector","title":"TcVector\uff08\u817e\u8baf\u4e91\u5411\u91cf\u6570\u636e\u5e93\uff09","text":"<p>TcVector \u652f\u6301\u4e24\u79cd embedding \u6a21\u5f0f\uff1a</p> <p>1. \u672c\u5730 Embedding \u6a21\u5f0f\uff08\u9ed8\u8ba4\uff09</p> <p>\u4f7f\u7528\u672c\u5730 embedder \u8ba1\u7b97\u5411\u91cf\uff0c\u7136\u540e\u5b58\u50a8\u5230 TcVector\uff1a</p> <pre><code>import (\n    vectortcvector \"trpc.group/trpc-go/trpc-agent-go/knowledge/vectorstore/tcvector\"\n)\n\ndocBuilder := func(tcDoc tcvectordb.Document) (*document.Document, []float64, error) {\n    return &amp;document.Document{ID: tcDoc.Id}, nil, nil\n}\n\n// \u672c\u5730 embedding \u6a21\u5f0f\ntcVS, err := vectortcvector.New(\n    vectortcvector.WithURL(\"https://your-tcvector-endpoint\"),\n    vectortcvector.WithUsername(\"your-username\"),\n    vectortcvector.WithPassword(\"your-password\"),\n    // \u7528\u4e8e\u6587\u6863\u68c0\u7d22\u65f6\u7684\u81ea\u5b9a\u4e49\u6587\u6863\u6784\u5efa\u65b9\u6cd5\u3002\u82e5\u4e0d\u63d0\u4f9b\uff0c\u5219\u4f7f\u7528\u9ed8\u8ba4\u6784\u5efa\u65b9\u6cd5\n    vectortcvector.WithDocBuilder(docBuilder),\n)\nif err != nil {\n    // \u5904\u7406 error\n}\n\nkb := knowledge.New(\n    knowledge.WithVectorStore(tcVS),\n    knowledge.WithEmbedder(embedder), // \u9700\u8981\u914d\u7f6e\u672c\u5730 embedder\n)\n</code></pre> <p>2. \u8fdc\u7a0b Embedding \u6a21\u5f0f</p> <p>\u4f7f\u7528 TcVector \u4e91\u7aef embedding \u8ba1\u7b97\uff0c\u65e0\u9700\u672c\u5730 embedder\uff0c\u8282\u7701\u8d44\u6e90\uff1a</p> <pre><code>import (\n    vectortcvector \"trpc.group/trpc-go/trpc-agent-go/knowledge/vectorstore/tcvector\"\n)\n\n// \u8fdc\u7a0b embedding \u6a21\u5f0f\ntcVS, err := vectortcvector.New(\n    vectortcvector.WithURL(\"https://your-tcvector-endpoint\"),\n    vectortcvector.WithUsername(\"your-username\"),\n    vectortcvector.WithPassword(\"your-password\"),\n    // \u542f\u7528\u8fdc\u7a0b embedding \u8ba1\u7b97\n    vectortcvector.WithEnableRemoteEmbedding(true),\n    // \u6307\u5b9a TcVector \u7684 embedding \u6a21\u578b\uff08\u5982 bge-base-zh\uff09\n    vectortcvector.WithRemoteEmbeddingModel(\"bge-base-zh\"),\n    // \u5982\u9700\u6df7\u5408\u68c0\u7d22\uff0c\u9700\u542f\u7528 TSVector\n    vectortcvector.WithEnableTSVector(true),\n)\nif err != nil {\n    // \u5904\u7406 error\n}\n\nkb := knowledge.New(\n    knowledge.WithVectorStore(tcVS),\n    // \u6ce8\u610f\uff1a\u4f7f\u7528\u8fdc\u7a0b embedding \u65f6\uff0c\u4e0d\u9700\u8981\u914d\u7f6e embedder\n    // knowledge.WithEmbedder(embedder), // \u4e0d\u9700\u8981\n)\n</code></pre>"},{"location":"zh/knowledge/#elasticsearch","title":"Elasticsearch","text":"<pre><code>docBuilder := func(hitSource json.RawMessage) (*document.Document, []float64, error) {\n    var source struct {\n        ID        string    `json:\"id\"`\n        Title     string    `json:\"title\"`\n        Content   string    `json:\"content\"`\n        Page      int       `json:\"page\"`\n        Author    string    `json:\"author\"`\n        CreatedAt time.Time `json:\"created_at\"`\n        UpdatedAt time.Time `json:\"updated_at\"`\n        Embedding []float64 `json:\"embedding\"`\n    }\n    if err := json.Unmarshal(hitSource, &amp;source); err != nil {\n        return nil, nil, err\n    }\n    // Create document.\n    doc := &amp;document.Document{\n        ID:        source.ID,\n        Name:      source.Title,\n        Content:   source.Content,\n        CreatedAt: source.CreatedAt,\n        UpdatedAt: source.UpdatedAt,\n        Metadata: map[string]any{\n            \"page\":   source.Page,\n            \"author\": source.Author,\n        },\n    }\n    return doc, source.Embedding, nil\n}\n\n// \u521b\u5efa\u652f\u6301\u591a\u7248\u672c (v7, v8, v9) \u7684 Elasticsearch \u5411\u91cf\u5b58\u50a8\nesVS, err := vectorelasticsearch.New(\n    vectorelasticsearch.WithAddresses([]string{\"http://localhost:9200\"}),\n    vectorelasticsearch.WithUsername(os.Getenv(\"ELASTICSEARCH_USERNAME\")),\n    vectorelasticsearch.WithPassword(os.Getenv(\"ELASTICSEARCH_PASSWORD\")),\n    vectorelasticsearch.WithAPIKey(os.Getenv(\"ELASTICSEARCH_API_KEY\")),\n    vectorelasticsearch.WithIndexName(getEnvOrDefault(\"ELASTICSEARCH_INDEX_NAME\", \"trpc_agent_documents\")),\n    vectorelasticsearch.WithMaxRetries(3),\n    // \u7248\u672c\u53ef\u9009\uff1a\"v7\"\u3001\"v8\"\u3001\"v9\"\uff08\u9ed8\u8ba4 \"v9\"\uff09\n    vectorelasticsearch.WithVersion(\"v9\"),\n    // \u7528\u4e8e\u6587\u6863\u68c0\u7d22\u65f6\u7684\u81ea\u5b9a\u4e49\u6587\u6863\u6784\u5efa\u65b9\u6cd5\u3002\u82e5\u4e0d\u63d0\u4f9b\uff0c\u5219\u4f7f\u7528\u9ed8\u8ba4\u6784\u5efa\u65b9\u6cd5\u3002\n    vectorelasticsearch.WithDocBuilder(docBuilder),\n)\nif err != nil {\n    // \u5904\u7406 error\n}\n\nkb := knowledge.New(\n    knowledge.WithVectorStore(esVS),\n)\n</code></pre>"},{"location":"zh/knowledge/#embedder","title":"Embedder","text":"<p>Embedder \u8d1f\u8d23\u5c06\u6587\u672c\u8f6c\u6362\u4e3a\u5411\u91cf\u8868\u793a\uff0c\u662f Knowledge \u7cfb\u7edf\u7684\u6838\u5fc3\u7ec4\u4ef6\u3002\u76ee\u524d\u6846\u67b6\u4e3b\u8981\u652f\u6301 OpenAI embedding \u6a21\u578b\uff1a</p> <pre><code>import (\n    openaiembedder \"trpc.group/trpc-go/trpc-agent-go/knowledge/embedder/openai\"\n)\n\n// OpenAI Embedder \u914d\u7f6e\nembedder := openaiembedder.New(\n    openaiembedder.WithModel(\"text-embedding-3-small\"), // embedding \u6a21\u578b\uff0c\u4e5f\u53ef\u901a\u8fc7 OPENAI_EMBEDDING_MODEL \u73af\u5883\u53d8\u91cf\u8bbe\u7f6e\n)\n\n// \u4f20\u9012\u7ed9 Knowledge\nkb := knowledge.New(\n    knowledge.WithEmbedder(embedder),\n)\n</code></pre>"},{"location":"zh/knowledge/#reranker","title":"Reranker","text":"<p>Reranker \u8d1f\u8d23\u5bf9\u68c0\u7d22\u7ed3\u679c\u7684\u7cbe\u6392\uff1a</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/knowledge/reranker\"\n)\n\nrerank := reranker.NewTopKReranker(\n    reranker.WithK(1), // \u6307\u5b9a\u7cbe\u6392\u540e\u7684\u8fd4\u56de\u7ed3\u679c\u6570\uff0c\u4e0d\u8bbe\u7f6e\u7684\u60c5\u51b5\u4e0b\u9ed8\u8ba4\u8fd4\u56de\u6240\u6709\u7ed3\u679c\n)\n\n// \u4f20\u9012\u7ed9 Knowledge\nkb := knowledge.New(\n    knowledge.WithReranker(rerank),\n)\n</code></pre> <p>\u652f\u6301\u7684 embedding \u6a21\u578b\uff1a</p> <ul> <li>OpenAI embedding \u6a21\u578b\uff08text-embedding-3-small \u7b49\uff09</li> <li>\u5176\u4ed6\u517c\u5bb9 OpenAI API \u7684 embedding \u670d\u52a1</li> <li>Gemini embedding \u6a21\u578b\uff08\u901a\u8fc7 <code>knowledge/embedder/gemini</code>\uff09</li> <li>Ollama embedding \u6a21\u578b (\u901a\u8fc7 <code>knowledge/embedder/ollama</code>\uff09</li> <li>hugging_face text_embedding_interface \u6a21\u578b (\u901a\u8fc7 <code>knowledge/embedder/hugging_face</code>\uff09</li> </ul> <p>\u6ce8\u610f:</p> <ul> <li>Retriever \u548c Reranker \u76ee\u524d\u7531 Knowledge \u5185\u90e8\u5b9e\u73b0\uff0c\u7528\u6237\u65e0\u9700\u5355\u72ec\u914d\u7f6e\u3002Knowledge \u4f1a\u81ea\u52a8\u5904\u7406\u6587\u6863\u68c0\u7d22\u548c\u7ed3\u679c\u6392\u5e8f\u3002</li> <li><code>OPENAI_EMBEDDING_MODEL</code> \u73af\u5883\u53d8\u91cf\u9700\u8981\u5728\u4ee3\u7801\u4e2d\u624b\u52a8\u8bfb\u53d6\uff0c\u6846\u67b6\u4e0d\u4f1a\u81ea\u52a8\u8bfb\u53d6\u3002\u53c2\u8003\u793a\u4f8b\u4ee3\u7801\u4e2d\u7684 <code>getEnvOrDefault(\"OPENAI_EMBEDDING_MODEL\", \"\")</code> \u5b9e\u73b0\u3002</li> </ul>"},{"location":"zh/knowledge/#_12","title":"\u6587\u6863\u6e90\u914d\u7f6e","text":"<p>\ud83d\udcc1 \u793a\u4f8b\u4ee3\u7801: examples/knowledge/sources</p> <p>\u6e90\u6a21\u5757\u63d0\u4f9b\u4e86\u591a\u79cd\u6587\u6863\u6e90\u7c7b\u578b\uff0c\u6bcf\u79cd\u7c7b\u578b\u90fd\u652f\u6301\u4e30\u5bcc\u7684\u914d\u7f6e\u9009\u9879\uff1a</p> <ul> <li>\u6587\u4ef6\u6e90 (file): \u5355\u4e2a\u6587\u4ef6\u5904\u7406 - \u793a\u4f8b</li> <li>\u76ee\u5f55\u6e90 (dir): \u6279\u91cf\u5904\u7406\u76ee\u5f55 - \u793a\u4f8b</li> <li>URL \u6e90 (url): \u4ece\u7f51\u9875\u83b7\u53d6\u5185\u5bb9 - \u793a\u4f8b</li> <li>\u81ea\u52a8\u6e90 (auto): \u667a\u80fd\u8bc6\u522b\u7c7b\u578b - \u793a\u4f8b</li> </ul> <pre><code>import (\n    filesource \"trpc.group/trpc-go/trpc-agent-go/knowledge/source/file\"\n    dirsource \"trpc.group/trpc-go/trpc-agent-go/knowledge/source/dir\"\n    urlsource \"trpc.group/trpc-go/trpc-agent-go/knowledge/source/url\"\n    autosource \"trpc.group/trpc-go/trpc-agent-go/knowledge/source/auto\"\n)\n\n// \u6587\u4ef6\u6e90\uff1a\u5355\u4e2a\u6587\u4ef6\u5904\u7406\uff0c\u652f\u6301 .txt, .md, .go, .json \u7b49\u683c\u5f0f\nfileSrc := filesource.New(\n    []string{\"./data/llm.md\"},\n    filesource.WithChunkSize(1000),      // \u5206\u5757\u5927\u5c0f\n    filesource.WithChunkOverlap(200),    // \u5206\u5757\u91cd\u53e0\n    filesource.WithName(\"LLM Doc\"),\n    filesource.WithMetadataValue(\"type\", \"documentation\"),\n)\n\n// \u76ee\u5f55\u6e90\uff1a\u6279\u91cf\u5904\u7406\u76ee\u5f55\uff0c\u652f\u6301\u9012\u5f52\u548c\u8fc7\u6ee4\ndirSrc := dirsource.New(\n    []string{\"./docs\"},\n    dirsource.WithRecursive(true),                           // \u9012\u5f52\u5904\u7406\u5b50\u76ee\u5f55\n    dirsource.WithFileExtensions([]string{\".md\", \".txt\"}),   // \u6587\u4ef6\u6269\u5c55\u540d\u8fc7\u6ee4\n    dirsource.WithExcludePatterns([]string{\"*.tmp\", \"*.log\"}), // \u6392\u9664\u6a21\u5f0f\n    dirsource.WithChunkSize(800),\n    dirsource.WithName(\"Documentation\"),\n)\n\n// URL \u6e90\uff1a\u4ece\u7f51\u9875\u548c API \u83b7\u53d6\u5185\u5bb9\nurlSrc := urlsource.New(\n    []string{\"https://en.wikipedia.org/wiki/Artificial_intelligence\"},\n    urlsource.WithTimeout(30*time.Second),           // \u8bf7\u6c42\u8d85\u65f6\n    urlsource.WithUserAgent(\"MyBot/1.0\"),           // \u81ea\u5b9a\u4e49 User-Agent\n    urlsource.WithMaxContentLength(1024*1024),       // \u6700\u5927\u5185\u5bb9\u957f\u5ea6 (1MB)\n    urlsource.WithName(\"Web Content\"),\n)\n\n// URL \u6e90\u9ad8\u7ea7\u914d\u7f6e\uff1a\u5206\u79bb\u5185\u5bb9\u83b7\u53d6\u548c\u6587\u6863\u6807\u8bc6\nurlSrcAlias := urlsource.New(\n    []string{\"https://trpc-go.com/docs/api.md\"},     // \u6807\u8bc6\u7b26 URL\uff08\u7528\u4e8e\u6587\u6863 ID \u548c\u5143\u6570\u636e\uff09\n    urlsource.WithContentFetchingURL([]string{\"https://github.com/trpc-group/trpc-go/raw/main/docs/api.md\"}), // \u5b9e\u9645\u5185\u5bb9\u83b7\u53d6 URL\n    urlsource.WithName(\"TRPC API Docs\"),\n    urlsource.WithMetadataValue(\"source\", \"github\"),\n)\n// \u6ce8\u610f\uff1a\u4f7f\u7528 WithContentFetchingURL \u65f6\uff0c\u6807\u8bc6\u7b26 URL \u5e94\u4fdd\u7559\u83b7\u53d6\u5185\u5bb9\u7684URL\u7684\u6587\u4ef6\u4fe1\u606f\uff0c\u6bd4\u5982\n// \u6b63\u786e\uff1a\u6807\u8bc6\u7b26 URL \u4e3a https://trpc-go.com/docs/api.md\uff0c\u83b7\u53d6 URL \u4e3a https://github.com/.../docs/api.md\n// \u9519\u8bef\uff1a\u6807\u8bc6\u7b26 URL \u4e3a https://trpc-go.com\uff0c\u4f1a\u4e22\u5931\u6587\u6863\u8def\u5f84\u4fe1\u606f\n\n// \u81ea\u52a8\u6e90\uff1a\u667a\u80fd\u8bc6\u522b\u7c7b\u578b\uff0c\u81ea\u52a8\u9009\u62e9\u5904\u7406\u5668\nautoSrc := autosource.New(\n    []string{\n        \"Cloud computing provides on-demand access to computing resources.\",\n        \"https://docs.example.com/api\",\n        \"./config.yaml\",\n    },\n    autosource.WithName(\"Mixed Sources\"),\n    autosource.WithFallbackChunkSize(1000),\n)\n\n// \u7ec4\u5408\u4f7f\u7528\nsources := []source.Source{fileSrc, dirSrc, urlSrc, autoSrc}\n\n// \u4f20\u9012\u7ed9 Knowledge\nkb := knowledge.New(\n    knowledge.WithSources(sources),\n)\n\n// \u52a0\u8f7d\u6240\u6709\u6e90\nif err := kb.Load(ctx); err != nil {\n    log.Fatalf(\"Failed to load knowledge base: %v\", err)\n}\n</code></pre>"},{"location":"zh/knowledge/#_13","title":"\u6279\u91cf\u6587\u6863\u5904\u7406\u4e0e\u5e76\u53d1","text":"<p>Knowledge \u652f\u6301\u6279\u91cf\u6587\u6863\u5904\u7406\u548c\u5e76\u53d1\u52a0\u8f7d\uff0c\u53ef\u4ee5\u663e\u8457\u63d0\u5347\u5927\u91cf\u6587\u6863\u7684\u5904\u7406\u6027\u80fd\uff1a</p> <pre><code>err := kb.Load(ctx,\n    knowledge.WithShowProgress(true),      // \u6253\u5370\u8fdb\u5ea6\u65e5\u5fd7\n    knowledge.WithProgressStepSize(10),    // \u8fdb\u5ea6\u6b65\u957f\n    knowledge.WithShowStats(true),         // \u6253\u5370\u7edf\u8ba1\u4fe1\u606f\n    knowledge.WithSourceConcurrency(4),    // \u6e90\u7ea7\u5e76\u53d1\n    knowledge.WithDocConcurrency(64),      // \u6587\u6863\u7ea7\u5e76\u53d1\n)\n</code></pre> <p>\u5173\u4e8e\u6027\u80fd\u4e0e\u9650\u6d41\uff1a</p> <ul> <li>\u63d0\u9ad8\u5e76\u53d1\u4f1a\u589e\u52a0\u5bf9 Embedder \u670d\u52a1\uff08OpenAI/Gemini\uff09\u7684\u8c03\u7528\u9891\u7387\uff0c\u53ef\u80fd\u89e6\u53d1\u9650\u6d41\uff1b</li> <li>\u8bf7\u6839\u636e\u541e\u5410\u3001\u6210\u672c\u4e0e\u9650\u6d41\u60c5\u51b5\u8c03\u8282 <code>WithSourceConcurrency()</code>\u3001<code>WithDocConcurrency()</code>\uff1b</li> <li>\u9ed8\u8ba4\u503c\u5728\u591a\u6570\u573a\u666f\u4e0b\u8f83\u4e3a\u5747\u8861\uff1b\u9700\u8981\u66f4\u5feb\u901f\u5ea6\u53ef\u9002\u5f53\u4e0a\u8c03\uff0c\u9047\u5230\u9650\u6d41\u5219\u4e0b\u8c03\u3002</li> </ul>"},{"location":"zh/knowledge/#_14","title":"\u8fc7\u6ee4\u5668\u529f\u80fd","text":"<p>\ud83d\udcc1 \u793a\u4f8b\u4ee3\u7801: examples/knowledge/features/metadata-filter</p> <p>Knowledge \u7cfb\u7edf\u63d0\u4f9b\u4e86\u5f3a\u5927\u7684\u8fc7\u6ee4\u5668\u529f\u80fd\uff0c\u5141\u8bb8\u57fa\u4e8e\u6587\u6863\u5143\u6570\u636e\u8fdb\u884c\u7cbe\u51c6\u641c\u7d22\u3002\u8fd9\u5305\u62ec\u9759\u6001\u8fc7\u6ee4\u5668\u548c\u667a\u80fd\u8fc7\u6ee4\u5668\u4e24\u79cd\u6a21\u5f0f\u3002</p> <p>\u91cd\u8981\uff1a\u8fc7\u6ee4\u5668\u5b57\u6bb5\u547d\u540d\u89c4\u8303</p> <p>\u5728\u4f7f\u7528\u8fc7\u6ee4\u5668\u65f6\uff0c\u5143\u6570\u636e\u5b57\u6bb5\u5efa\u8bae\u4f7f\u7528 <code>metadata.</code> \u524d\u7f00\uff1a - <code>metadata.</code> \u524d\u7f00\u7528\u4e8e\u533a\u5206\u5143\u6570\u636e\u5b57\u6bb5\u548c\u7cfb\u7edf\u5b57\u6bb5\uff08\u5982 <code>id</code>\u3001<code>name</code>\u3001<code>content</code> \u7b49\uff09 - \u65e0\u8bba\u662f <code>WithKnowledgeFilter()</code>\u3001<code>tool.WithFilter()</code> \u8fd8\u662f <code>searchfilter.Equal()</code> \u7b49\uff0c\u5143\u6570\u636e\u5b57\u6bb5\u90fd\u5efa\u8bae\u52a0 <code>metadata.</code> \u524d\u7f00 - \u5982\u679c\u901a\u8fc7 <code>WithMetadataField()</code> \u81ea\u5b9a\u4e49\u4e86\u5143\u6570\u636e\u5b57\u6bb5\u540d\uff0c\u4ecd\u7136\u4f7f\u7528 <code>metadata.</code> \u524d\u7f00\uff0c\u6846\u67b6\u4f1a\u81ea\u52a8\u8f6c\u6362\u4e3a\u5b9e\u9645\u7684\u5b57\u6bb5\u540d - \u901a\u8fc7 <code>WithDocBuilder</code> \u81ea\u5b9a\u4e49\u7684\u8868\u5b57\u6bb5\uff08\u5982 <code>status</code>\u3001<code>priority</code> \u7b49\u989d\u5916\u5217\uff09\u76f4\u63a5\u4f7f\u7528\u5b57\u6bb5\u540d\uff0c\u65e0\u9700\u524d\u7f00</p>"},{"location":"zh/knowledge/#_15","title":"\u57fa\u7840\u8fc7\u6ee4\u5668","text":"<p>\u57fa\u7840\u8fc7\u6ee4\u5668\u652f\u6301\u4e24\u79cd\u8bbe\u7f6e\u65b9\u5f0f\uff1aAgent \u7ea7\u522b\u7684\u56fa\u5b9a\u8fc7\u6ee4\u5668\u548c Runner \u7ea7\u522b\u7684\u8fd0\u884c\u65f6\u8fc7\u6ee4\u5668\u3002</p>"},{"location":"zh/knowledge/#agent_2","title":"Agent \u7ea7\u8fc7\u6ee4\u5668","text":"<p>\u5728\u521b\u5efa Agent \u65f6\u9884\u8bbe\u56fa\u5b9a\u7684\u641c\u7d22\u8fc7\u6ee4\u6761\u4ef6\uff1a</p> <pre><code>// \u521b\u5efa\u5e26\u6709\u56fa\u5b9a\u8fc7\u6ee4\u5668\u7684 Agent\nllmAgent := llmagent.New(\n    \"knowledge-assistant\",\n    llmagent.WithModel(modelInstance),\n    llmagent.WithKnowledge(kb),\n    llmagent.WithKnowledgeFilter(map[string]interface{}{\n        \"metadata.category\": \"documentation\",\n        \"metadata.topic\":    \"programming\",\n    }),\n)\n</code></pre>"},{"location":"zh/knowledge/#runner","title":"Runner \u7ea7\u8fc7\u6ee4\u5668","text":"<p>\u5728\u8c03\u7528 <code>runner.Run()</code> \u65f6\u52a8\u6001\u4f20\u9012\u8fc7\u6ee4\u5668\uff0c\u9002\u7528\u4e8e\u9700\u8981\u6839\u636e\u4e0d\u540c\u8bf7\u6c42\u4e0a\u4e0b\u6587\u8fdb\u884c\u8fc7\u6ee4\u7684\u573a\u666f\uff1a</p> <pre><code>import \"trpc.group/trpc-go/trpc-agent-go/agent\"\n\n// \u5728\u8fd0\u884c\u65f6\u4f20\u9012\u8fc7\u6ee4\u5668\neventCh, err := runner.Run(\n    ctx,\n    userID,\n    sessionID,\n    message,\n    agent.WithKnowledgeFilter(map[string]interface{}{\n        \"metadata.user_level\": \"premium\",     // \u6839\u636e\u7528\u6237\u7ea7\u522b\u8fc7\u6ee4\n        \"metadata.region\":     \"china\",       // \u6839\u636e\u5730\u533a\u8fc7\u6ee4\n        \"metadata.language\":   \"zh\",          // \u6839\u636e\u8bed\u8a00\u8fc7\u6ee4\n    }),\n)\n</code></pre> <p>\u91cd\u8981\uff1aAgent \u7ea7\u8fc7\u6ee4\u5668\u7684\u4f18\u5148\u7ea7\u9ad8\u4e8e Runner \u7ea7\u8fc7\u6ee4\u5668\uff0c\u76f8\u540c\u952e\u7684\u503c\u4f1a\u88ab Agent \u7ea7\u8986\u76d6\uff1a</p> <pre><code>// Agent \u7ea7\u8fc7\u6ee4\u5668\nllmAgent := llmagent.New(\n    \"assistant\",\n    llmagent.WithKnowledge(kb),\n    llmagent.WithKnowledgeFilter(map[string]interface{}{\n        \"metadata.category\": \"general\",\n        \"metadata.source\":   \"internal\",\n    }),\n)\n\n// Runner \u7ea7\u8fc7\u6ee4\u5668\u7684\u540c\u540d\u952e\u4f1a\u88ab Agent \u7ea7\u8986\u76d6\neventCh, err := runner.Run(\n    ctx, userID, sessionID, message,\n    agent.WithKnowledgeFilter(map[string]interface{}{\n        \"metadata.source\": \"external\",  // \u4f1a\u88ab Agent \u7ea7\u7684 \"internal\" \u8986\u76d6\n        \"metadata.topic\":  \"api\",       // \u65b0\u589e\u8fc7\u6ee4\u6761\u4ef6\uff08Agent \u7ea7\u6ca1\u6709\u6b64\u952e\uff09\n    }),\n)\n\n// \u6700\u7ec8\u751f\u6548\u7684\u8fc7\u6ee4\u5668\uff1a\n// {\n//     \"metadata.category\": \"general\",   // \u6765\u81ea Agent \u7ea7\n//     \"metadata.source\":   \"internal\",  // \u6765\u81ea Agent \u7ea7\uff08\u8986\u76d6\u4e86 Runner \u7ea7\u7684 \"external\"\uff09\n//     \"metadata.topic\":    \"api\",       // \u6765\u81ea Runner \u7ea7\uff08\u65b0\u589e\uff09\n// }\n</code></pre>"},{"location":"zh/knowledge/#agentic-filter","title":"\u667a\u80fd\u8fc7\u6ee4\u5668 (Agentic Filter)","text":"<p>\ud83d\udcc1 \u793a\u4f8b\u4ee3\u7801: examples/knowledge/features/agentic-filter</p> <p>\u667a\u80fd\u8fc7\u6ee4\u5668\u662f Knowledge \u7cfb\u7edf\u7684\u9ad8\u7ea7\u529f\u80fd\uff0c\u5141\u8bb8 LLM Agent \u6839\u636e\u7528\u6237\u67e5\u8be2\u52a8\u6001\u9009\u62e9\u5408\u9002\u7684\u8fc7\u6ee4\u6761\u4ef6\u3002</p>"},{"location":"zh/knowledge/#_16","title":"\u542f\u7528\u667a\u80fd\u8fc7\u6ee4\u5668","text":"<pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/knowledge/source\"\n)\n\n// \u83b7\u53d6\u6240\u6709\u6e90\u7684\u5143\u6570\u636e\u4fe1\u606f\nsourcesMetadata := source.GetAllMetadata(sources)\n\n// \u521b\u5efa\u652f\u6301\u667a\u80fd\u8fc7\u6ee4\u7684 Agent\nllmAgent := llmagent.New(\n    \"knowledge-assistant\",\n    llmagent.WithModel(modelInstance),\n    llmagent.WithKnowledge(kb),\n    llmagent.WithEnableKnowledgeAgenticFilter(true),           // \u542f\u7528\u667a\u80fd\u8fc7\u6ee4\u5668\n    llmagent.WithKnowledgeAgenticFilterInfo(sourcesMetadata), // \u63d0\u4f9b\u53ef\u7528\u7684\u8fc7\u6ee4\u5668\u4fe1\u606f\n)\n</code></pre>"},{"location":"zh/knowledge/#_17","title":"\u8fc7\u6ee4\u5668\u5c42\u7ea7","text":"<p>Knowledge \u7cfb\u7edf\u652f\u6301\u591a\u5c42\u8fc7\u6ee4\u5668\uff0c\u6240\u6709\u8fc7\u6ee4\u5668\u7edf\u4e00\u4f7f\u7528 FilterCondition \u5b9e\u73b0\uff0c\u901a\u8fc7 AND \u903b\u8f91\u7ec4\u5408\u3002\u7cfb\u7edf\u4e0d\u533a\u5206\u4f18\u5148\u7ea7\uff0c\u6240\u6709\u5c42\u7ea7\u7684\u8fc7\u6ee4\u5668\u5e73\u7b49\u5408\u5e76\u3002</p> <p>\u8fc7\u6ee4\u5668\u5c42\u7ea7\uff1a</p> <ol> <li> <p>Agent \u7ea7\u8fc7\u6ee4\u5668\uff1a</p> <ul> <li>\u901a\u8fc7 <code>llmagent.WithKnowledgeFilter()</code> \u8bbe\u7f6e\u5143\u6570\u636e\u8fc7\u6ee4\u5668</li> <li>\u901a\u8fc7 <code>llmagent.WithKnowledgeConditionedFilter()</code> \u8bbe\u7f6e\u590d\u6742\u6761\u4ef6\u8fc7\u6ee4\u5668</li> </ul> </li> <li> <p>Tool \u7ea7\u8fc7\u6ee4\u5668\uff1a</p> <ul> <li>\u901a\u8fc7 <code>tool.WithFilter()</code> \u8bbe\u7f6e\u5143\u6570\u636e\u8fc7\u6ee4\u5668</li> <li>\u901a\u8fc7 <code>tool.WithConditionedFilter()</code> \u8bbe\u7f6e\u590d\u6742\u6761\u4ef6\u8fc7\u6ee4\u5668</li> <li>\u6ce8\uff1aAgent \u7ea7\u8fc7\u6ee4\u5668\u5b9e\u9645\u4e0a\u662f\u901a\u8fc7 Tool \u7ea7\u8fc7\u6ee4\u5668\u5b9e\u73b0\u7684</li> </ul> </li> <li> <p>Runner \u7ea7\u8fc7\u6ee4\u5668\uff1a</p> <ul> <li>\u901a\u8fc7 <code>agent.WithKnowledgeFilter()</code> \u5728 <code>runner.Run()</code> \u65f6\u4f20\u9012\u5143\u6570\u636e\u8fc7\u6ee4\u5668</li> <li>\u901a\u8fc7 <code>agent.WithKnowledgeConditionedFilter()</code> \u5728 <code>runner.Run()</code> \u65f6\u4f20\u9012\u590d\u6742\u6761\u4ef6\u8fc7\u6ee4\u5668</li> </ul> </li> <li> <p>LLM \u667a\u80fd\u8fc7\u6ee4\u5668\uff1a</p> <ul> <li>LLM \u6839\u636e\u7528\u6237\u67e5\u8be2\u52a8\u6001\u751f\u6210\u7684\u8fc7\u6ee4\u6761\u4ef6\uff08\u4ec5\u652f\u6301\u590d\u6742\u6761\u4ef6\u8fc7\u6ee4\u5668\uff09</li> </ul> </li> </ol> <p>\u91cd\u8981\u8bf4\u660e\uff1a - \u6240\u6709\u8fc7\u6ee4\u5668\u901a\u8fc7 AND \u903b\u8f91\u7ec4\u5408\uff0c\u5373\u5fc5\u987b\u540c\u65f6\u6ee1\u8db3\u6240\u6709\u5c42\u7ea7\u7684\u8fc7\u6ee4\u6761\u4ef6 - \u4e0d\u5b58\u5728\u4f18\u5148\u7ea7\u8986\u76d6\u5173\u7cfb\uff0c\u6240\u6709\u8fc7\u6ee4\u5668\u90fd\u662f\u5e73\u7b49\u7684\u7ea6\u675f\u6761\u4ef6 - \u6bcf\u4e2a\u5c42\u7ea7\u90fd\u652f\u6301\u5143\u6570\u636e\u8fc7\u6ee4\u5668\u548c\u590d\u6742\u6761\u4ef6\u8fc7\u6ee4\u5668\uff08LLM \u9664\u5916\uff0c\u4ec5\u652f\u6301\u590d\u6742\u6761\u4ef6\uff09</p>"},{"location":"zh/knowledge/#_18","title":"\u793a\u4f8b\uff1a\u8fc7\u6ee4\u5668\u7ec4\u5408","text":"<pre><code>import \"trpc.group/trpc-go/trpc-agent-go/knowledge/searchfilter\"\n\n// 1. Agent \u7ea7\u8fc7\u6ee4\u5668\nllmAgent := llmagent.New(\n    \"knowledge-assistant\",\n    llmagent.WithModel(modelInstance),\n    llmagent.WithKnowledge(kb),\n    // Agent \u7ea7\u5143\u6570\u636e\u8fc7\u6ee4\u5668\n    llmagent.WithKnowledgeFilter(map[string]any{\n        \"metadata.source\":   \"official\",      // \u5b98\u65b9\u6765\u6e90\n        \"metadata.category\": \"documentation\", // \u6587\u6863\u7c7b\u522b\n    }),\n    // Agent \u7ea7\u590d\u6742\u6761\u4ef6\u8fc7\u6ee4\u5668\uff08\u5143\u6570\u636e\u5b57\u6bb5\u4f7f\u7528 metadata. \u524d\u7f00\uff09\n    llmagent.WithKnowledgeConditionedFilter(\n        searchfilter.Equal(\"metadata.status\", \"published\"), // \u5df2\u53d1\u5e03\u72b6\u6001\n    ),\n)\n\n// 2. Runner \u7ea7\u8fc7\u6ee4\u5668\neventCh, err := runner.Run(\n    ctx, userID, sessionID, message,\n    // Runner \u7ea7\u5143\u6570\u636e\u8fc7\u6ee4\u5668\n    agent.WithKnowledgeFilter(map[string]any{\n        \"metadata.region\":   \"china\",  // \u4e2d\u56fd\u533a\u57df\n        \"metadata.language\": \"zh\",     // \u4e2d\u6587\n    }),\n    // Runner \u7ea7\u590d\u6742\u6761\u4ef6\u8fc7\u6ee4\u5668\n    agent.WithKnowledgeConditionedFilter(\n        searchfilter.GreaterThan(\"metadata.priority\", 5), // \u4f18\u5148\u7ea7\u5927\u4e8e 5\n    ),\n)\n\n// 3. LLM \u667a\u80fd\u8fc7\u6ee4\u5668\uff08\u7531 LLM \u52a8\u6001\u751f\u6210\uff09\n// \u4f8b\u5982\uff1a\u7528\u6237\u95ee \"\u67e5\u627e API \u76f8\u5173\u6587\u6863\"\uff0cLLM \u53ef\u80fd\u751f\u6210 {\"field\": \"metadata.topic\", \"value\": \"api\"}\n\n// \u6700\u7ec8\u751f\u6548\u7684\u8fc7\u6ee4\u6761\u4ef6\uff08\u6240\u6709\u6761\u4ef6\u901a\u8fc7 AND \u7ec4\u5408\uff09\uff1a\n// metadata.source = \"official\" AND\n// metadata.category = \"documentation\" AND\n// metadata.status = \"published\" AND\n// metadata.region = \"china\" AND\n// metadata.language = \"zh\" AND\n// metadata.priority &gt; 5 AND\n// metadata.topic = \"api\"\n//\n// \u5373\uff1a\u5fc5\u987b\u540c\u65f6\u6ee1\u8db3\u6240\u6709\u5c42\u7ea7\u7684\u6240\u6709\u6761\u4ef6\n</code></pre>"},{"location":"zh/knowledge/#_19","title":"\u590d\u6742\u6761\u4ef6\u8fc7\u6ee4\u5668\u793a\u4f8b","text":"<pre><code>// \u624b\u52a8\u521b\u5efa\u5e26\u6709\u590d\u6742\u6761\u4ef6\u8fc7\u6ee4\u5668\u7684 Tool\nsearchTool := tool.NewKnowledgeSearchTool(\n    kb,\n    // Agent \u7ea7\u5143\u6570\u636e\u8fc7\u6ee4\u5668\n    tool.WithFilter(map[string]any{\n        \"metadata.source\": \"official\",\n    }),\n    // Agent \u7ea7\u590d\u6742\u6761\u4ef6\u8fc7\u6ee4\u5668\uff08\u5143\u6570\u636e\u5b57\u6bb5\u4f7f\u7528 metadata. \u524d\u7f00\uff09\n    tool.WithConditionedFilter(\n        searchfilter.Or(\n            searchfilter.Equal(\"metadata.topic\", \"programming\"),\n            searchfilter.Equal(\"metadata.topic\", \"llm\"),\n        ),\n    ),\n)\n\nllmAgent := llmagent.New(\n    \"knowledge-assistant\",\n    llmagent.WithModel(modelInstance),\n    llmagent.WithTools(searchTool),  // \u624b\u52a8\u4f20\u9012 Tool\n)\n\n// \u6700\u7ec8\u8fc7\u6ee4\u6761\u4ef6\uff1a\n// metadata.source = \"official\" AND (metadata.topic = \"programming\" OR metadata.topic = \"llm\")\n// \u5373\uff1a\u5fc5\u987b\u662f\u5b98\u65b9\u6765\u6e90\uff0c\u4e14\u4e3b\u9898\u662f\u7f16\u7a0b\u6216 LLM\n</code></pre>"},{"location":"zh/knowledge/#_20","title":"\u5e38\u7528\u8fc7\u6ee4\u5668\u8f85\u52a9\u51fd\u6570","text":"<pre><code>// \u6bd4\u8f83\u64cd\u4f5c\u7b26\uff08\u6ce8\u610f\uff1a\u5143\u6570\u636e\u5b57\u6bb5\u9700\u8981 metadata. \u524d\u7f00\uff09\nsearchfilter.Equal(\"metadata.topic\", value)              // metadata.topic = value\nsearchfilter.NotEqual(\"metadata.status\", value)          // metadata.status != value\nsearchfilter.GreaterThan(\"metadata.priority\", value)     // metadata.priority &gt; value\nsearchfilter.GreaterThanOrEqual(\"metadata.score\", value) // metadata.score &gt;= value\nsearchfilter.LessThan(\"metadata.age\", value)             // metadata.age &lt; value\nsearchfilter.LessThanOrEqual(\"metadata.level\", value)    // metadata.level &lt;= value\nsearchfilter.In(\"metadata.category\", values...)          // metadata.category IN (...)\nsearchfilter.NotIn(\"metadata.type\", values...)           // metadata.type NOT IN (...)\nsearchfilter.Like(\"metadata.title\", pattern)             // metadata.title LIKE pattern\nsearchfilter.Between(\"metadata.date\", min, max)          // metadata.date BETWEEN min AND max\n\n// \u81ea\u5b9a\u4e49\u8868\u5b57\u6bb5\uff08\u901a\u8fc7 WithDocBuilder \u6dfb\u52a0\u7684\u989d\u5916\u5217\uff09\u4e0d\u9700\u8981\u524d\u7f00\nsearchfilter.NotEqual(\"status\", \"deleted\")               // status != \"deleted\"\nsearchfilter.GreaterThanOrEqual(\"priority\", 3)           // priority &gt;= 3\n\n// \u903b\u8f91\u64cd\u4f5c\u7b26\nsearchfilter.And(conditions...)               // AND \u7ec4\u5408\nsearchfilter.Or(conditions...)                // OR \u7ec4\u5408\n\n// \u5d4c\u5957\u793a\u4f8b\uff1a(metadata.status = 'published') AND (metadata.category = 'doc' OR metadata.category = 'tutorial')\nsearchfilter.And(\n    searchfilter.Equal(\"metadata.status\", \"published\"),\n    searchfilter.Or(\n        searchfilter.Equal(\"metadata.category\", \"documentation\"),\n        searchfilter.Equal(\"metadata.category\", \"tutorial\"),\n    ),\n)\n</code></pre>"},{"location":"zh/knowledge/#_21","title":"\u591a\u6587\u6863\u8fd4\u56de","text":"<p>Knowledge Search Tool \u652f\u6301\u8fd4\u56de\u591a\u4e2a\u76f8\u5173\u6587\u6863\uff0c\u53ef\u901a\u8fc7 <code>WithMaxResults(n)</code> \u9009\u9879\u9650\u5236\u8fd4\u56de\u7684\u6700\u5927\u6587\u6863\u6570\u91cf\uff1a</p> <pre><code>// \u521b\u5efa\u641c\u7d22\u5de5\u5177\uff0c\u9650\u5236\u6700\u591a\u8fd4\u56de 5 \u4e2a\u6587\u6863\nsearchTool := tool.NewKnowledgeSearchTool(\n    kb,\n    tool.WithMaxResults(5),\n)\n\n// \u6216\u4f7f\u7528\u667a\u80fd\u8fc7\u6ee4\u641c\u7d22\u5de5\u5177\nagenticSearchTool := tool.NewAgenticFilterSearchTool(\n    kb,\n    sourcesMetadata,\n    tool.WithMaxResults(10),\n)\n</code></pre> <p>\u6bcf\u4e2a\u8fd4\u56de\u7684\u6587\u6863\u5305\u542b\u6587\u672c\u5185\u5bb9\u3001\u5143\u6570\u636e\u548c\u76f8\u5173\u6027\u5206\u6570\uff0c\u6309\u5206\u6570\u964d\u5e8f\u6392\u5217</p>"},{"location":"zh/knowledge/#_22","title":"\u914d\u7f6e\u5143\u6570\u636e\u6e90","text":"<p>\u4e3a\u4e86\u4f7f\u667a\u80fd\u8fc7\u6ee4\u5668\u6b63\u5e38\u5de5\u4f5c\uff0c\u9700\u8981\u5728\u521b\u5efa\u6587\u6863\u6e90\u65f6\u6dfb\u52a0\u4e30\u5bcc\u7684\u5143\u6570\u636e\uff1a</p> <pre><code>sources := []source.Source{\n    // \u6587\u4ef6\u6e90\u914d\u7f6e\u5143\u6570\u636e\n    filesource.New(\n        []string{\"./docs/api.md\"},\n        filesource.WithName(\"API Documentation\"),\n        filesource.WithMetadataValue(\"category\", \"documentation\"),\n        filesource.WithMetadataValue(\"topic\", \"api\"),\n        filesource.WithMetadataValue(\"service_type\", \"gateway\"),\n        filesource.WithMetadataValue(\"protocol\", \"trpc-go\"),\n        filesource.WithMetadataValue(\"version\", \"v1.0\"),\n    ),\n\n    // \u76ee\u5f55\u6e90\u914d\u7f6e\u5143\u6570\u636e\n    dirsource.New(\n        []string{\"./tutorials\"},\n        dirsource.WithName(\"Tutorials\"),\n        dirsource.WithMetadataValue(\"category\", \"tutorial\"),\n        dirsource.WithMetadataValue(\"difficulty\", \"beginner\"),\n        dirsource.WithMetadataValue(\"topic\", \"programming\"),\n    ),\n\n    // URL \u6e90\u914d\u7f6e\u5143\u6570\u636e\n    urlsource.New(\n        []string{\"https://example.com/wiki/rpc\"},\n        urlsource.WithName(\"RPC Wiki\"),\n        urlsource.WithMetadataValue(\"category\", \"encyclopedia\"),\n        urlsource.WithMetadataValue(\"source_type\", \"web\"),\n        urlsource.WithMetadataValue(\"topic\", \"rpc\"),\n        urlsource.WithMetadataValue(\"language\", \"zh\"),\n    ),\n}\n</code></pre>"},{"location":"zh/knowledge/#_23","title":"\u5411\u91cf\u6570\u636e\u5e93\u8fc7\u6ee4\u5668\u652f\u6301","text":"<p>\u4e0d\u540c\u7684\u5411\u91cf\u6570\u636e\u5e93\u5bf9\u8fc7\u6ee4\u5668\u7684\u652f\u6301\u7a0b\u5ea6\u4e0d\u540c\uff1a</p>"},{"location":"zh/knowledge/#postgresql-pgvector","title":"PostgreSQL + pgvector","text":"<ul> <li>\u2705 \u652f\u6301\u6240\u6709\u5143\u6570\u636e\u5b57\u6bb5\u8fc7\u6ee4</li> <li>\u2705 \u652f\u6301\u590d\u6742\u67e5\u8be2\u6761\u4ef6</li> <li>\u2705 \u652f\u6301 JSONB \u5b57\u6bb5\u7d22\u5f15</li> </ul> <pre><code>vectorStore, err := vectorpgvector.New(\n    vectorpgvector.WithHost(\"127.0.0.1\"),\n    vectorpgvector.WithPort(5432),\n    // ... \u5176\u4ed6\u914d\u7f6e\n)\n</code></pre>"},{"location":"zh/knowledge/#tcvector_1","title":"TcVector","text":"<ul> <li>\u2705 \u652f\u6301\u6240\u6709\u5143\u6570\u636e\u8fc7\u6ee4</li> <li>\u2705 v0.4.0+ \u65b0\u5efa\u96c6\u5408\u81ea\u52a8\u652f\u6301 JSON \u7d22\u5f15\uff08\u9700 TCVector \u670d\u52a1\u652f\u6301\uff09</li> <li>\u26a1 \u53ef\u9009\uff1a\u4f7f\u7528 <code>WithFilterIndexFields</code> \u4e3a\u9ad8\u9891\u5b57\u6bb5\u6784\u5efa\u989d\u5916\u7d22\u5f15</li> </ul> <pre><code>// v0.4.0+ \u65b0\u5efa\u96c6\u5408\uff08TCVector \u670d\u52a1\u652f\u6301 JSON \u7d22\u5f15\uff09\nvectorStore, err := vectortcvector.New(\n    vectortcvector.WithURL(\"https://your-endpoint\"),\n    // ... \u5176\u4ed6\u914d\u7f6e\n)\n// \u6240\u6709\u5143\u6570\u636e\u5b57\u6bb5\u53ef\u901a\u8fc7 JSON \u7d22\u5f15\u67e5\u8be2\uff0c\u65e0\u9700\u9884\u5b9a\u4e49\n\n// \u53ef\u9009\uff1a\u4e3a\u9ad8\u9891\u5b57\u6bb5\u6784\u5efa\u989d\u5916\u7d22\u5f15\u4ee5\u4f18\u5316\u6027\u80fd\nmetadataKeys := source.GetAllMetadataKeys(sources)\nvectorStore, err := vectortcvector.New(\n    vectortcvector.WithURL(\"https://your-endpoint\"),\n    vectortcvector.WithFilterIndexFields(metadataKeys), // \u53ef\u9009\uff1a\u6784\u5efa\u989d\u5916\u7d22\u5f15\n    // ... \u5176\u4ed6\u914d\u7f6e\n)\n\n// v0.4.0 \u4e4b\u524d\u7684\u96c6\u5408\u6216 TCVector \u670d\u52a1\u4e0d\u652f\u6301 JSON \u7d22\u5f15\nvectorStore, err := vectortcvector.New(\n    vectortcvector.WithURL(\"https://your-endpoint\"),\n    vectortcvector.WithFilterIndexFields(metadataKeys), // \u5fc5\u9700\uff1a\u9884\u5b9a\u4e49\u8fc7\u6ee4\u5b57\u6bb5\n    // ... \u5176\u4ed6\u914d\u7f6e\n)\n</code></pre> <p>\u8bf4\u660e\uff1a - v0.4.0+ \u65b0\u5efa\u96c6\u5408\uff1a\u81ea\u52a8\u521b\u5efa metadata JSON \u7d22\u5f15\uff0c\u6240\u6709\u5b57\u6bb5\u53ef\u67e5\u8be2 - \u65e7\u7248\u672c\u96c6\u5408\uff1a\u4ec5\u652f\u6301 <code>WithFilterIndexFields</code> \u4e2d\u9884\u5b9a\u4e49\u7684\u5b57\u6bb5</p>"},{"location":"zh/knowledge/#_24","title":"\u5185\u5b58\u5b58\u50a8","text":"<ul> <li>\u2705 \u652f\u6301\u6240\u6709\u8fc7\u6ee4\u5668\u529f\u80fd</li> <li>\u26a0\ufe0f \u4ec5\u9002\u7528\u4e8e\u5f00\u53d1\u548c\u6d4b\u8bd5</li> </ul>"},{"location":"zh/knowledge/#_25","title":"\u77e5\u8bc6\u5e93\u7ba1\u7406\u529f\u80fd","text":"<p>\ud83d\udcc1 \u793a\u4f8b\u4ee3\u7801: examples/knowledge/features/management</p> <p>Knowledge \u7cfb\u7edf\u63d0\u4f9b\u4e86\u5f3a\u5927\u7684\u77e5\u8bc6\u5e93\u7ba1\u7406\u529f\u80fd\uff0c\u652f\u6301\u52a8\u6001\u6e90\u7ba1\u7406\u548c\u667a\u80fd\u540c\u6b65\u673a\u5236\u3002</p>"},{"location":"zh/knowledge/#enablesourcesync","title":"\u542f\u7528\u6e90\u540c\u6b65 (enableSourceSync)","text":"<p>\u901a\u8fc7\u542f\u7528 <code>enableSourceSync</code>\uff0c\u77e5\u8bc6\u5e93\u4f1a\u59cb\u7ec8\u4fdd\u6301\u5411\u91cf\u5b58\u50a8\u6570\u636e\u548c\u914d\u7f6e\u7684\u6570\u636e\u6e90\u4e00\u81f4\uff0c\u8fd9\u91cc\u5982\u679c\u6ca1\u6709\u4f7f\u7528\u81ea\u5b9a\u4e49\u7684\u529e\u6cd5\u6765\u7ba1\u7406\u77e5\u8bc6\u5e93\uff0c\u5efa\u8bae\u5f00\u542f\u6b64\u9009\u9879\uff1a</p> <pre><code>kb := knowledge.New(\n    knowledge.WithEmbedder(embedder),\n    knowledge.WithVectorStore(vectorStore),\n    knowledge.WithSources(sources),\n    knowledge.WithEnableSourceSync(true), // \u542f\u7528\u589e\u91cf\u540c\u6b65\n)\n</code></pre> <p>\u540c\u6b65\u673a\u5236\u7684\u5de5\u4f5c\u539f\u7406\uff1a</p> <ol> <li>\u52a0\u8f7d\u524d\u51c6\u5907\uff1a\u5237\u65b0\u6587\u6863\u4fe1\u606f\u7f13\u5b58\uff0c\u5efa\u7acb\u540c\u6b65\u72b6\u6001\u8ddf\u8e2a</li> <li>\u5904\u7406\u8fc7\u7a0b\u8ddf\u8e2a\uff1a\u8bb0\u5f55\u5df2\u5904\u7406\u7684\u6587\u6863\uff0c\u907f\u514d\u91cd\u590d\u5904\u7406</li> <li>\u52a0\u8f7d\u540e\u6e05\u7406\uff1a\u81ea\u52a8\u6e05\u7406\u4e0d\u518d\u5b58\u5728\u7684\u5b64\u513f\u6587\u6863</li> </ol> <p>\u542f\u7528\u540c\u6b65\u7684\u4f18\u52bf\uff1a</p> <ul> <li>\u6570\u636e\u4e00\u81f4\u6027\uff1a\u786e\u4fdd\u5411\u91cf\u5b58\u50a8\u4e0e\u6e90\u914d\u7f6e\u5b8c\u5168\u540c\u6b65</li> <li>\u589e\u91cf\u66f4\u65b0\uff1a\u53ea\u5904\u7406\u53d8\u66f4\u7684\u6587\u6863\uff0c\u63d0\u5347\u6027\u80fd</li> <li>\u5b64\u513f\u6e05\u7406\uff1a\u81ea\u52a8\u5220\u9664\u5df2\u79fb\u9664\u6e90\u7684\u76f8\u5173\u6587\u6863</li> <li>\u72b6\u6001\u8ddf\u8e2a\uff1a\u5b9e\u65f6\u76d1\u63a7\u540c\u6b65\u72b6\u6001\u548c\u5904\u7406\u8fdb\u5ea6</li> </ul>"},{"location":"zh/knowledge/#_26","title":"\u52a8\u6001\u6e90\u7ba1\u7406","text":"<p>Knowledge \u652f\u6301\u8fd0\u884c\u65f6\u52a8\u6001\u7ba1\u7406\u77e5\u8bc6\u6e90\uff0c\u786e\u4fdd\u5411\u91cf\u5b58\u50a8\u4e2d\u7684\u6570\u636e\u59cb\u7ec8\u4e0e\u7528\u6237\u914d\u7f6e\u7684 source \u4fdd\u6301\u4e00\u81f4\uff1a</p> <pre><code>// \u6dfb\u52a0\u65b0\u7684\u77e5\u8bc6\u6e90 - \u6570\u636e\u5c06\u4e0e\u914d\u7f6e\u7684\u6e90\u4fdd\u6301\u540c\u6b65\nnewSource := filesource.New([]string{\"./new-docs/api.md\"})\nif err := kb.AddSource(ctx, newSource); err != nil {\n    log.Printf(\"Failed to add source: %v\", err)\n}\n\n// \u91cd\u65b0\u52a0\u8f7d\u6307\u5b9a\u7684\u77e5\u8bc6\u6e90 - \u81ea\u52a8\u68c0\u6d4b\u53d8\u66f4\u5e76\u540c\u6b65\nif err := kb.ReloadSource(ctx, newSource); err != nil {\n    log.Printf(\"Failed to reload source: %v\", err)\n}\n\n// \u79fb\u9664\u6307\u5b9a\u7684\u77e5\u8bc6\u6e90 - \u7cbe\u786e\u5220\u9664\u76f8\u5173\u6587\u6863\nif err := kb.RemoveSource(ctx, \"API Documentation\"); err != nil {\n    log.Printf(\"Failed to remove source: %v\", err)\n}\n</code></pre> <p>\u52a8\u6001\u7ba1\u7406\u7684\u6838\u5fc3\u7279\u70b9\uff1a</p> <ul> <li>\u6570\u636e\u4e00\u81f4\u6027\u4fdd\u8bc1\uff1a\u5411\u91cf\u5b58\u50a8\u6570\u636e\u59cb\u7ec8\u4e0e\u7528\u6237\u914d\u7f6e\u7684 source \u4fdd\u6301\u4e00\u81f4</li> <li>\u667a\u80fd\u589e\u91cf\u540c\u6b65\uff1a\u53ea\u5904\u7406\u53d8\u66f4\u7684\u6587\u6863\uff0c\u907f\u514d\u91cd\u590d\u5904\u7406</li> <li>\u7cbe\u786e\u6e90\u63a7\u5236\uff1a\u652f\u6301\u6309\u6e90\u540d\u79f0\u7cbe\u786e\u6dfb\u52a0/\u79fb\u9664/\u91cd\u8f7d</li> <li>\u5b64\u513f\u6587\u6863\u6e05\u7406\uff1a\u81ea\u52a8\u6e05\u7406\u4e0d\u518d\u5c5e\u4e8e\u4efb\u4f55\u914d\u7f6e\u6e90\u7684\u6587\u6863</li> <li>\u70ed\u66f4\u65b0\u652f\u6301\uff1a\u65e0\u9700\u91cd\u542f\u5e94\u7528\u5373\u53ef\u66f4\u65b0\u77e5\u8bc6\u5e93</li> </ul>"},{"location":"zh/knowledge/#_27","title":"\u77e5\u8bc6\u5e93\u72b6\u6001\u76d1\u63a7","text":"<p>Knowledge \u63d0\u4f9b\u4e86\u4e30\u5bcc\u7684\u72b6\u6001\u76d1\u63a7\u529f\u80fd\uff0c\u5e2e\u52a9\u7528\u6237\u4e86\u89e3\u5f53\u524d\u914d\u7f6e\u6e90\u7684\u540c\u6b65\u72b6\u6001\uff1a</p> <pre><code>// \u663e\u793a\u6240\u6709\u6587\u6863\u4fe1\u606f\ndocInfos, err := kb.ShowDocumentInfo(ctx)\nif err != nil {\n    log.Printf(\"Failed to show document info: %v\", err)\n    return\n}\n\n// \u6309\u6e90\u540d\u79f0\u8fc7\u6ee4\u663e\u793a\ndocInfos, err = kb.ShowDocumentInfo(ctx,\n    knowledge.WithShowDocumentInfoSourceName(\"APIDocumentation\"))\nif err != nil {\n    log.Printf(\"Failed to show source documents: %v\", err)\n    return\n}\n\n// \u6309\u6587\u6863ID\u8fc7\u6ee4\u663e\u793a\ndocInfos, err = kb.ShowDocumentInfo(ctx,\n    knowledge.WithShowDocumentInfoIDs([]string{\"doc1\", \"doc2\"}))\nif err != nil {\n    log.Printf(\"Failed to show specific documents: %v\", err)\n    return\n}\n\n// \u904d\u5386\u663e\u793a\u6587\u6863\u4fe1\u606f\nfor _, docInfo := range docInfos {\n    fmt.Printf(\"Document ID: %s\\n\", docInfo.DocumentID)\n    fmt.Printf(\"Source: %s\\n\", docInfo.SourceName)\n    fmt.Printf(\"URI: %s\\n\", docInfo.URI)\n    fmt.Printf(\"Chunk Index: %d\\n\", docInfo.ChunkIndex)\n}\n</code></pre> <p>\u72b6\u6001\u76d1\u63a7\u8f93\u51fa\u793a\u4f8b\uff1a</p> <pre><code>Document ID: a1b2c3d4e5f6...\nSource: Technical Documentation\nURI: /docs/api/authentication.md\nChunk Index: 0\n\nDocument ID: f6e5d4c3b2a1...\nSource: Technical Documentation\nURI: /docs/api/authentication.md\nChunk Index: 1\n</code></pre>"},{"location":"zh/knowledge/#queryenhancer","title":"QueryEnhancer","text":"<p>QueryEnhancer \u7528\u4e8e\u5728\u641c\u7d22\u524d\u5bf9\u7528\u6237\u67e5\u8be2\u8fdb\u884c\u9884\u5904\u7406\u548c\u4f18\u5316\u3002\u76ee\u524d\u6846\u67b6\u53ea\u63d0\u4f9b\u4e86\u4e00\u4e2a\u9ed8\u8ba4\u5b9e\u73b0\uff1a</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/knowledge\"\n    \"trpc.group/trpc-go/trpc-agent-go/knowledge/query\"\n)\n\nkb := knowledge.New(\n    knowledge.WithQueryEnhancer(query.NewPassthroughEnhancer()), // \u9ed8\u8ba4\u589e\u5f3a\u5668\uff0c\u6309\u539f\u6837\u8fd4\u56de\u67e5\u8be2\n)\n</code></pre> <p>\u6ce8\u610f: QueryEnhancer \u4e0d\u662f\u5fc5\u987b\u7684\u7ec4\u4ef6\u3002\u5982\u679c\u4e0d\u6307\u5b9a\uff0cKnowledge \u4f1a\u76f4\u63a5\u4f7f\u7528\u539f\u59cb\u67e5\u8be2\u8fdb\u884c\u641c\u7d22\u3002\u53ea\u6709\u5728\u9700\u8981\u81ea\u5b9a\u4e49\u67e5\u8be2\u9884\u5904\u7406\u903b\u8f91\u65f6\u624d\u9700\u8981\u914d\u7f6e\u6b64\u9009\u9879\u3002</p>"},{"location":"zh/knowledge/#_28","title":"\u6027\u80fd\u4f18\u5316","text":"<p>Knowledge \u7cfb\u7edf\u63d0\u4f9b\u4e86\u591a\u79cd\u6027\u80fd\u4f18\u5316\u7b56\u7565\uff0c\u5305\u62ec\u5e76\u53d1\u5904\u7406\u3001\u5411\u91cf\u5b58\u50a8\u4f18\u5316\u548c\u7f13\u5b58\u673a\u5236\uff1a</p> <pre><code>// \u6839\u636e\u7cfb\u7edf\u8d44\u6e90\u8c03\u6574\u5e76\u53d1\u6570\nkb := knowledge.New(\n    knowledge.WithSources(sources),\n    knowledge.WithSourceConcurrency(runtime.NumCPU()),\n    knowledge.WithDocConcurrency(runtime.NumCPU()*2),\n)\n</code></pre>"},{"location":"zh/knowledge/#_29","title":"\u5b8c\u6574\u793a\u4f8b","text":"<p>\ud83d\udcc1 \u6240\u6709\u793a\u4f8b: examples/knowledge</p> <p>\u4ee5\u4e0b\u662f\u4e00\u4e2a\u5b8c\u6574\u7684\u793a\u4f8b\uff0c\u5c55\u793a\u4e86\u5982\u4f55\u521b\u5efa\u5177\u6709 Knowledge \u8bbf\u95ee\u80fd\u529b\u7684 Agent\uff1a</p> <pre><code>package main\n\nimport (\n    \"context\"\n    \"flag\"\n    \"log\"\n    \"os\"\n    \"strconv\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/agent/llmagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/knowledge\"\n    \"trpc.group/trpc-go/trpc-agent-go/model\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/openai\"\n    \"trpc.group/trpc-go/trpc-agent-go/runner\"\n    \"trpc.group/trpc-go/trpc-agent-go/session/inmemory\"\n\n    // Embedder\n    \"trpc.group/trpc-go/trpc-agent-go/knowledge/embedder\"\n    geminiembedder \"trpc.group/trpc-go/trpc-agent-go/knowledge/embedder/gemini\"\n    openaiembedder \"trpc.group/trpc-go/trpc-agent-go/knowledge/embedder/openai\"\n    ollamaembedder \"trpc.group/trpc-go/trpc-agent-go/knowledge/embedder/ollama\"\n    huggingfaceembedder \"trpc.group/trpc-go/trpc-agent-go/knowledge/embedder/huggingface\"\n\n    // Source\n    \"trpc.group/trpc-go/trpc-agent-go/knowledge/source\"\n    autosource \"trpc.group/trpc-go/trpc-agent-go/knowledge/source/auto\"\n    dirsource \"trpc.group/trpc-go/trpc-agent-go/knowledge/source/dir\"\n    filesource \"trpc.group/trpc-go/trpc-agent-go/knowledge/source/file\"\n    urlsource \"trpc.group/trpc-go/trpc-agent-go/knowledge/source/url\"\n\n    // Vector Store\n    \"trpc.group/trpc-go/trpc-agent-go/knowledge/vectorstore\"\n    vectorinmemory \"trpc.group/trpc-go/trpc-agent-go/knowledge/vectorstore/inmemory\"\n    vectorpgvector \"trpc.group/trpc-go/trpc-agent-go/knowledge/vectorstore/pgvector\"\n    vectortcvector \"trpc.group/trpc-go/trpc-agent-go/knowledge/vectorstore/tcvector\"\n\n    // \u5982\u9700\u652f\u6301 PDF \u6587\u4ef6\uff0c\u9700\u624b\u52a8\u5f15\u5165 PDF reader\uff08\u72ec\u7acb go.mod\uff0c\u907f\u514d\u5f15\u5165\u4e0d\u5fc5\u8981\u7684\u7b2c\u4e09\u65b9\u4f9d\u8d56\uff09\n    // _ \"trpc.group/trpc-go/trpc-agent-go/knowledge/document/reader/pdf\"\n)\n\nfunc main() {\n    var (\n        embedderType    = flag.String(\"embedder\", \"openai\", \"ollama\", \"embedder type (openai, gemini, ollama,huggingface)\")\n        vectorStoreType = flag.String(\"vectorstore\", \"inmemory\", \"vector store type (inmemory, pgvector, tcvector)\")\n        modelName       = flag.String(\"model\", \"claude-4-sonnet-20250514\", \"Name of the model to use\")\n    )\n\n    flag.Parse()\n\n    ctx := context.Background()\n\n    // 1. \u521b\u5efa embedder\uff08\u6839\u636e\u73af\u5883\u53d8\u91cf\u9009\u62e9\uff09\n    var embedder embedder.Embedder\n    var err error\n\n    switch *embedderType {\n    case \"gemini\":\n        embedder, err = geminiembedder.New(context.Background())\n        if err != nil {\n            log.Fatalf(\"Failed to create gemini embedder: %v\", err)\n        }\n    case \"ollama\":\n        embedder, err = ollamaembedder.New()\n        if err != nil {\n            log.Fatalf(\"Failed to create ollama embedder: %v\", err)\n        }\n    case \"huggingface\":\n        embedder = huggingfaceembedder.New()\n    default: // openai\n        embedder = openaiembedder.New(\n            openaiembedder.WithModel(getEnvOrDefault(\"OPENAI_EMBEDDING_MODEL\", \"text-embedding-3-small\")),\n        )\n    }\n\n    // 2. \u521b\u5efa\u5411\u91cf\u5b58\u50a8\uff08\u6839\u636e\u53c2\u6570\u9009\u62e9\uff09\n    var vectorStore vectorstore.VectorStore\n\n    switch *vectorStoreType {\n    case \"pgvector\":\n        port, err := strconv.Atoi(getEnvOrDefault(\"PGVECTOR_PORT\", \"5432\"))\n        if err != nil {\n            log.Fatalf(\"Failed to convert PGVECTOR_PORT to int: %v\", err)\n        }\n\n        vectorStore, err = vectorpgvector.New(\n            vectorpgvector.WithHost(getEnvOrDefault(\"PGVECTOR_HOST\", \"127.0.0.1\")),\n            vectorpgvector.WithPort(port),\n            vectorpgvector.WithUser(getEnvOrDefault(\"PGVECTOR_USER\", \"postgres\")),\n            vectorpgvector.WithPassword(getEnvOrDefault(\"PGVECTOR_PASSWORD\", \"\")),\n            vectorpgvector.WithDatabase(getEnvOrDefault(\"PGVECTOR_DATABASE\", \"vectordb\")),\n            vectorpgvector.WithIndexDimension(1536),\n        )\n        if err != nil {\n            log.Fatalf(\"Failed to create pgvector store: %v\", err)\n        }\n    case \"tcvector\":\n        vectorStore, err = vectortcvector.New(\n            vectortcvector.WithURL(getEnvOrDefault(\"TCVECTOR_URL\", \"\")),\n            vectortcvector.WithUsername(getEnvOrDefault(\"TCVECTOR_USERNAME\", \"\")),\n            vectortcvector.WithPassword(getEnvOrDefault(\"TCVECTOR_PASSWORD\", \"\")),\n        )\n        if err != nil {\n            log.Fatalf(\"Failed to create tcvector store: %v\", err)\n        }\n    default: // inmemory\n        vectorStore = vectorinmemory.New()\n    }\n\n    // 3. \u521b\u5efa\u77e5\u8bc6\u6e90\n    sources := []source.Source{\n        // \u6587\u4ef6\u6e90\uff1a\u5355\u4e2a\u6587\u4ef6\u5904\u7406\n        filesource.New(\n            []string{\"./data/llm.md\"},\n            filesource.WithChunkSize(1000),\n            filesource.WithChunkOverlap(200),\n            filesource.WithName(\"LLM Documentation\"),\n            filesource.WithMetadataValue(\"type\", \"documentation\"),\n            filesource.WithMetadataValue(\"category\", \"ai\"),\n        ),\n\n        // \u76ee\u5f55\u6e90\uff1a\u6279\u91cf\u5904\u7406\u76ee\u5f55\n        dirsource.New(\n            []string{\"./dir\"},\n            dirsource.WithRecursive(true),\n            dirsource.WithFileExtensions([]string{\".md\", \".txt\"}),\n            dirsource.WithChunkSize(800),\n            dirsource.WithName(\"Documentation\"),\n            dirsource.WithMetadataValue(\"category\", \"docs\"),\n        ),\n\n        // URL \u6e90\uff1a\u4ece\u7f51\u9875\u83b7\u53d6\u5185\u5bb9\n        urlsource.New(\n            []string{\"https://en.wikipedia.org/wiki/Artificial_intelligence\"},\n            urlsource.WithName(\"Web Documentation\"),\n            urlsource.WithMetadataValue(\"source\", \"web\"),\n            urlsource.WithMetadataValue(\"category\", \"wikipedia\"),\n            urlsource.WithMetadataValue(\"language\", \"en\"),\n        ),\n\n        // \u81ea\u52a8\u6e90\uff1a\u6df7\u5408\u5185\u5bb9\u7c7b\u578b\n        autosource.New(\n            []string{\n                \"Cloud computing is the delivery of computing services over the internet, including servers, storage, databases, networking, software, and analytics. It provides on-demand access to shared computing resources.\",\n                \"Machine learning is a subset of artificial intelligence that enables systems to learn and improve from experience without being explicitly programmed.\",\n                \"./README.md\",\n            },\n            autosource.WithName(\"Mixed Knowledge Sources\"),\n            autosource.WithMetadataValue(\"category\", \"mixed\"),\n            autosource.WithMetadataValue(\"type\", \"custom\"),\n            autosource.WithMetadataValue(\"topics\", []string{\"cloud\", \"ml\", \"ai\"}),\n        ),\n    }\n\n    // 4. \u521b\u5efa Knowledge\n    kb := knowledge.New(\n        knowledge.WithEmbedder(embedder),\n        knowledge.WithVectorStore(vectorStore),\n        knowledge.WithSources(sources),\n    )\n\n    // 5. \u52a0\u8f7d\u6587\u6863\uff08\u5e26\u8fdb\u5ea6\u548c\u7edf\u8ba1\uff09\n    log.Println(\"\ud83d\ude80 \u5f00\u59cb\u52a0\u8f7d Knowledge ...\")\n    if err := kb.Load(\n        ctx,\n        knowledge.WithShowProgress(true),\n        knowledge.WithProgressStepSize(10),\n        knowledge.WithShowStats(true),\n        knowledge.WithSourceConcurrency(4),\n        knowledge.WithDocConcurrency(64),\n    ); err != nil {\n        log.Fatalf(\"\u274c Knowledge \u52a0\u8f7d\u5931\u8d25: %v\", err)\n    }\n    log.Println(\"\u2705 Knowledge \u52a0\u8f7d\u5b8c\u6210\uff01\")\n\n    // 6. \u521b\u5efa LLM \u6a21\u578b\n    modelInstance := openai.New(*modelName)\n\n    // \u83b7\u53d6\u6240\u6709\u6e90\u7684\u5143\u6570\u636e\u4fe1\u606f\uff08\u7528\u4e8e\u667a\u80fd\u8fc7\u6ee4\u5668\uff09\n    sourcesMetadata := source.GetAllMetadata(sources)\n\n    // 7. \u521b\u5efa Agent \u5e76\u96c6\u6210 Knowledge\n    llmAgent := llmagent.New(\n        \"knowledge-assistant\",\n        llmagent.WithModel(modelInstance),\n        llmagent.WithDescription(\"\u5177\u6709 Knowledge \u8bbf\u95ee\u80fd\u529b\u7684\u667a\u80fd\u52a9\u624b\"),\n        llmagent.WithInstruction(\"\u4f7f\u7528 knowledge_search \u6216 knowledge_search_with_filter \u5de5\u5177\u4ece Knowledge \u68c0\u7d22\u76f8\u5173\u4fe1\u606f\uff0c\u5e76\u57fa\u4e8e\u68c0\u7d22\u5185\u5bb9\u56de\u7b54\u95ee\u9898\u3002\u6839\u636e\u7528\u6237\u67e5\u8be2\u9009\u62e9\u5408\u9002\u7684\u8fc7\u6ee4\u6761\u4ef6\u3002\"),\n        llmagent.WithKnowledge(kb), // \u81ea\u52a8\u6dfb\u52a0 knowledge_search \u5de5\u5177\n        llmagent.WithEnableKnowledgeAgenticFilter(true),           // \u542f\u7528\u667a\u80fd\u8fc7\u6ee4\u5668\n        llmagent.WithKnowledgeAgenticFilterInfo(sourcesMetadata), // \u63d0\u4f9b\u53ef\u7528\u7684\u8fc7\u6ee4\u5668\u4fe1\u606f\n    )\n\n    // 8. \u521b\u5efa Runner\n    sessionService := inmemory.NewSessionService()\n    appRunner := runner.NewRunner(\n        \"knowledge-chat\",\n        llmAgent,\n        runner.WithSessionService(sessionService),\n    )\n\n    // 9. \u6267\u884c\u5bf9\u8bdd\uff08Agent \u4f1a\u81ea\u52a8\u4f7f\u7528 knowledge_search \u5de5\u5177\uff09\n    log.Println(\"\ud83d\udd0d \u5f00\u59cb\u641c\u7d22\u77e5\u8bc6\u5e93...\")\n    message := model.NewUserMessage(\"\u8bf7\u544a\u8bc9\u6211\u5173\u4e8e LLM \u7684\u4fe1\u606f\")\n    eventChan, err := appRunner.Run(ctx, \"user123\", \"session456\", message)\n    if err != nil {\n        log.Fatalf(\"Failed to run agent: %v\", err)\n    }\n\n    // 10. \u5904\u7406\u54cd\u5e94 ...\n\n    // 11. \u6f14\u793a\u77e5\u8bc6\u5e93\u7ba1\u7406\u529f\u80fd - \u67e5\u770b\u6587\u6863\u5143\u6570\u636e\n    log.Println(\"\ud83d\udcca \u663e\u793a\u5f53\u524d\u77e5\u8bc6\u5e93\u72b6\u6001...\")\n\n    // \u67e5\u8be2\u6240\u6709\u6587\u6863\u7684\u5143\u6570\u636e\u4fe1\u606f\uff0c\u4e5f\u652f\u6301\u67e5\u8be2\u6307\u5b9a source \u6216\u8005 metadata \u7684\u6570\u636e\u4fe1\u606f\n    docInfos, err := kb.ShowDocumentInfo(ctx)\n    if err != nil {\n        log.Printf(\"Failed to show document info: %v\", err)\n    } else {\n        log.Printf(\"\u77e5\u8bc6\u5e93\u4e2d\u603b\u5171\u6709 %d \u4e2a\u6587\u6863\u5757\", len(docInfos))\n    }\n\n\n    // 12. \u6f14\u793a\u52a8\u6001\u6dfb\u52a0\u6e90 - \u65b0\u6570\u636e\u5c06\u81ea\u52a8\u4e0e\u914d\u7f6e\u4fdd\u6301\u540c\u6b65\n    log.Println(\"\u6f14\u793a\u52a8\u6001\u6dfb\u52a0 source ...\")\n    newSource := filesource.New(\n        []string{\"./new-docs/changelog.md\"},\n        filesource.WithName(\"Changelog\"),\n        filesource.WithMetadataValue(\"category\", \"changelog\"),\n        filesource.WithMetadataValue(\"type\", \"updates\"),\n    )\n\n    if err := kb.AddSource(ctx, newSource); err != nil {\n        log.Printf(\"Failed to add new source: %v\", err)\n    }\n\n    // 13. \u6f14\u793a\u79fb\u9664source\uff08\u53ef\u9009\uff0c\u53d6\u6d88\u6ce8\u91ca\u4ee5\u6d4b\u8bd5\uff09\n    // if err := kb.RemoveSource(ctx, \"Changelog\"); err != nil {\n    //     log.Printf(\"Failed to remove source: %v\", err)\n    // }\n}\n\n// getEnvOrDefault returns the environment variable value or a default value if not set.\nfunc getEnvOrDefault(key, defaultValue string) string {\n    if value := os.Getenv(key); value != \"\" {\n        return value\n    }\n    return defaultValue\n}\n</code></pre> <p>\u5176\u4e2d\uff0c\u73af\u5883\u53d8\u91cf\u914d\u7f6e\u5982\u4e0b\uff1a</p> <pre><code># OpenAI API \u914d\u7f6e\uff08\u5f53\u4f7f\u7528 OpenAI embedder \u65f6\u5fc5\u9009\uff0c\u4f1a\u88ab OpenAI SDK \u81ea\u52a8\u8bfb\u53d6\uff09\nexport OPENAI_API_KEY=\"your-openai-api-key\"\nexport OPENAI_BASE_URL=\"your-openai-base-url\"\n# OpenAI embedding \u6a21\u578b\u914d\u7f6e\uff08\u53ef\u9009\uff0c\u9700\u8981\u5728\u4ee3\u7801\u4e2d\u624b\u52a8\u8bfb\u53d6\uff09\nexport OPENAI_EMBEDDING_MODEL=\"text-embedding-3-small\"\n\n# Google Gemini API \u914d\u7f6e\uff08\u5f53\u4f7f\u7528 Gemini embedder \u65f6\uff09\nexport GOOGLE_API_KEY=\"your-google-api-key\"\n\n# PostgreSQL + pgvector \u914d\u7f6e\uff08\u5f53\u4f7f\u7528 -vectorstore=pgvector \u65f6\u5fc5\u586b\uff09\nexport PGVECTOR_HOST=\"127.0.0.1\"\nexport PGVECTOR_PORT=\"5432\"\nexport PGVECTOR_USER=\"postgres\"\nexport PGVECTOR_PASSWORD=\"your-password\"\nexport PGVECTOR_DATABASE=\"vectordb\"\n\n# TcVector \u914d\u7f6e\uff08\u5f53\u4f7f\u7528 -vectorstore=tcvector \u65f6\u5fc5\u586b\uff09\nexport TCVECTOR_URL=\"https://your-tcvector-endpoint\"\nexport TCVECTOR_USERNAME=\"your-username\"\nexport TCVECTOR_PASSWORD=\"your-password\"\n\n# Elasticsearch \u914d\u7f6e\uff08\u5f53\u4f7f\u7528 -vectorstore=elasticsearch \u65f6\u5fc5\u586b\uff09\nexport ELASTICSEARCH_HOSTS=\"http://localhost:9200\"\nexport ELASTICSEARCH_USERNAME=\"\"\nexport ELASTICSEARCH_PASSWORD=\"\"\nexport ELASTICSEARCH_API_KEY=\"\"\nexport ELASTICSEARCH_INDEX_NAME=\"trpc_agent_documents\"\n</code></pre>"},{"location":"zh/knowledge/#_30","title":"\u547d\u4ee4\u884c\u53c2\u6570","text":"<pre><code># \u8fd0\u884c\u793a\u4f8b\u65f6\u53ef\u4ee5\u901a\u8fc7\u547d\u4ee4\u884c\u53c2\u6570\u9009\u62e9\u7ec4\u4ef6\u7c7b\u578b\ngo run main.go -embedder openai -vectorstore inmemory\ngo run main.go -embedder gemini -vectorstore pgvector\ngo run main.go -embedder openai -vectorstore tcvector\ngo run main.go -embedder openai -vectorstore elasticsearch -es-version v9\n\n# \u53c2\u6570\u8bf4\u660e\uff1a\n# -embedder: \u9009\u62e9 embedder \u7c7b\u578b (openai, gemini, ollama,huggingface)\uff0c \u9ed8\u8ba4\u4e3a openai\n# -vectorstore: \u9009\u62e9\u5411\u91cf\u5b58\u50a8\u7c7b\u578b (inmemory, pgvector, tcvector, elasticsearch)\uff0c\u9ed8\u8ba4\u4e3a inmemory\n# -es-version: \u6307\u5b9a Elasticsearch \u7248\u672c (v7, v8, v9)\uff0c\u4ec5\u5f53 vectorstore=elasticsearch \u65f6\u6709\u6548\n</code></pre>"},{"location":"zh/knowledge/#_31","title":"\u6545\u969c\u6392\u9664","text":""},{"location":"zh/knowledge/#_32","title":"\u5e38\u89c1\u95ee\u9898\u4e0e\u5904\u7406\u5efa\u8bae","text":"<ol> <li> <p>Create embedding failed/HTTP 4xx/5xx</p> <ul> <li>\u53ef\u80fd\u539f\u56e0\uff1aAPI Key \u65e0\u6548\u6216\u7f3a\u5931\uff1bBaseURL \u914d\u7f6e\u9519\u8bef\uff1b\u7f51\u7edc\u8bbf\u95ee\u53d7\u9650\uff1b\u6587\u672c\u8fc7\u957f\uff1b\u6240\u914d\u7f6e\u7684 BaseURL \u4e0d\u63d0\u4f9b Embeddings \u63a5\u53e3\u6216\u4e0d\u652f\u6301\u6240\u9009\u7684 embedding \u6a21\u578b\uff08\u4f8b\u5982\u8fd4\u56de 404 Not Found\uff09\u3002</li> <li>\u6392\u67e5\u6b65\u9aa4\uff1a<ul> <li>\u786e\u8ba4 <code>OPENAI_API_KEY</code> \u5df2\u8bbe\u7f6e\u4e14\u53ef\u7528\uff1b</li> <li>\u5982\u4f7f\u7528\u517c\u5bb9\u7f51\u5173\uff0c\u663e\u5f0f\u8bbe\u7f6e <code>WithBaseURL(os.Getenv(\"OPENAI_BASE_URL\"))</code>\uff1b</li> <li>\u786e\u8ba4 <code>WithModel(\"text-embedding-3-small\")</code> \u6216\u4f60\u6240\u7528\u670d\u52a1\u5b9e\u9645\u652f\u6301\u7684 embedding \u6a21\u578b\u540d\u79f0\uff1b</li> <li>\u4f7f\u7528\u6700\u5c0f\u5316\u6837\u4f8b\u8c03\u7528\u4e00\u6b21 embedding API \u9a8c\u8bc1\u8fde\u901a\u6027\uff1b</li> <li>\u7528 curl \u9a8c\u8bc1\u76ee\u6807 BaseURL \u662f\u5426\u5b9e\u73b0 <code>/v1/embeddings</code> \u4e14\u6a21\u578b\u5b58\u5728\uff1a    <pre><code>curl -sS -X POST \"$OPENAI_BASE_URL/embeddings\" \\\n  -H \"Authorization: Bearer $OPENAI_API_KEY\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\"model\":\"text-embedding-3-small\",\"input\":\"ping\"}'\n</code></pre>    \u82e5\u8fd4\u56de 404/\u6a21\u578b\u4e0d\u5b58\u5728\uff0c\u8bf7\u66f4\u6362\u4e3a\u652f\u6301 Embeddings \u7684 BaseURL \u6216\u5207\u6362\u5230\u8be5\u670d\u52a1\u63d0\u4f9b\u7684\u6709\u6548 embedding \u6a21\u578b\u540d\u3002</li> <li>\u9010\u6b65\u7f29\u77ed\u6587\u672c\uff0c\u786e\u8ba4\u975e\u8d85\u957f\u8f93\u5165\u5bfc\u81f4\u3002</li> </ul> </li> <li>\u53c2\u8003\u4ee3\u7801\uff1a    <pre><code>embedder := openaiembedder.New(\n    openaiembedder.WithModel(\"text-embedding-3-small\"),\n    openaiembedder.WithAPIKey(os.Getenv(\"OPENAI_API_KEY\")),\n    openaiembedder.WithBaseURL(os.Getenv(\"OPENAI_BASE_URL\")),\n)\nif _, err := embedder.GetEmbedding(ctx, \"ping\"); err != nil {\n    log.Fatalf(\"embed check failed: %v\", err)\n}\n</code></pre></li> </ul> </li> <li> <p>\u52a0\u8f7d\u901f\u5ea6\u6162\u6216 CPU \u5360\u7528\u9ad8</p> <ul> <li>\u53ef\u80fd\u539f\u56e0\uff1a\u5355\u6838\u987a\u5e8f\u52a0\u8f7d\uff1b\u5e76\u53d1\u8bbe\u7f6e\u4e0d\u5408\u9002\uff1b\u5927\u6587\u4ef6\u5206\u5757\u7b56\u7565\u4e0d\u5408\u7406\u3002</li> <li>\u6392\u67e5\u6b65\u9aa4\uff1a<ul> <li>\u8bbe\u7f6e\u6e90\u7ea7/\u6587\u6863\u7ea7\u5e76\u53d1\uff1a<code>WithSourceConcurrency(N)</code>\u3001<code>WithDocConcurrency(M)</code>\uff1b</li> <li>\u8c03\u6574\u5206\u5757\u5927\u5c0f\uff0c\u907f\u514d\u8fc7\u591a\u5c0f\u5757\uff1b</li> <li>\u4e34\u65f6\u5173\u95ed\u7edf\u8ba1\u8f93\u51fa\u51cf\u5c11\u65e5\u5fd7\u5f00\u9500\uff1a<code>WithShowStats(false)</code>\u3002</li> </ul> </li> <li>\u53c2\u8003\u4ee3\u7801\uff1a    <pre><code>err := kb.Load(ctx,\n    knowledge.WithSourceConcurrency(runtime.NumCPU()),\n    knowledge.WithDocConcurrency(runtime.NumCPU()*2),\n    knowledge.WithShowStats(false),\n)\n</code></pre></li> </ul> </li> <li> <p>\u5b58\u50a8\u8fde\u63a5\u5931\u8d25\uff08pgvector/TcVector\uff09</p> <ul> <li>\u53ef\u80fd\u539f\u56e0\uff1a\u8fde\u63a5\u53c2\u6570\u9519\u8bef\uff1b\u7f51\u7edc/\u9274\u6743\u5931\u8d25\uff1b\u670d\u52a1\u672a\u542f\u52a8\u6216\u7aef\u53e3\u4e0d\u901a\u3002</li> <li>\u6392\u67e5\u6b65\u9aa4\uff1a<ul> <li>\u4f7f\u7528\u539f\u751f\u5ba2\u6237\u7aef\u5148\u8fde\u901a\u4e00\u6b21\uff08psql/curl\uff09\uff1b</li> <li>\u663e\u5f0f\u6253\u5370\u5f53\u524d\u914d\u7f6e\uff08host/port/user/db/url\uff09\uff1b</li> <li>\u4e3a\u6700\u5c0f\u5316\u793a\u4f8b\u4ec5\u63d2\u5165/\u67e5\u8be2\u4e00\u6761\u8bb0\u5f55\u9a8c\u8bc1\u3002</li> </ul> </li> </ul> </li> <li> <p>\u5185\u5b58\u4f7f\u7528\u8fc7\u9ad8</p> <ul> <li>\u53ef\u80fd\u539f\u56e0\uff1a\u4e00\u6b21\u6027\u52a0\u8f7d\u6587\u6863\u8fc7\u591a\uff1b\u5757\u5c3a\u5bf8/\u91cd\u53e0\u8fc7\u5927\uff1b\u76f8\u4f3c\u5ea6\u7b5b\u9009\u8fc7\u5bbd\u3002</li> <li>\u6392\u67e5\u6b65\u9aa4\uff1a<ul> <li>\u51cf\u5c0f\u5e76\u53d1\u4e0e\u5206\u5757\u91cd\u53e0\uff1b</li> <li>\u5206\u6279\u52a0\u8f7d\u76ee\u5f55\u3002</li> </ul> </li> </ul> </li> <li> <p>\u7ef4\u5ea6/\u5411\u91cf\u4e0d\u5339\u914d</p> <ul> <li>\u75c7\u72b6\uff1a\u641c\u7d22\u9636\u6bb5\u62a5\u9519\u6216\u5f97\u5206\u5f02\u5e38\u4e3a 0\u3002</li> <li>\u6392\u67e5\uff1a<ul> <li>\u786e\u8ba4 embedding \u6a21\u578b\u7ef4\u5ea6\u4e0e\u5b58\u91cf\u5411\u91cf\u4e00\u81f4\uff08<code>text-embedding-3-small</code> \u4e3a 1536\uff09\uff1b</li> <li>\u66ff\u6362 embedding \u6a21\u578b\u540e\u9700\u91cd\u5efa\uff08\u6e05\u7a7a\u5e76\u91cd\u704c\uff09\u5411\u91cf\u5e93\u3002</li> </ul> </li> </ul> </li> <li> <p>\u8def\u5f84/\u683c\u5f0f\u8bfb\u53d6\u5931\u8d25</p> <ul> <li>\u75c7\u72b6\uff1a\u52a0\u8f7d\u65e5\u5fd7\u663e\u793a 0 \u6587\u6863\u6216\u7279\u5b9a\u6e90\u62a5\u9519\u3002</li> <li>\u6392\u67e5\uff1a<ul> <li>\u786e\u8ba4\u6587\u4ef6\u5b58\u5728\u4e14\u540e\u7f00\u53d7\u652f\u6301\uff08.md/.txt/.pdf/.csv/.json/.docx \u7b49\uff09\uff1b</li> <li>\u76ee\u5f55\u6e90\u662f\u5426\u9700\u8981 <code>WithRecursive(true)</code>\uff1b</li> <li>\u4f7f\u7528 <code>WithFileExtensions</code> \u505a\u767d\u540d\u5355\u8fc7\u6ee4\u3002</li> </ul> </li> </ul> </li> <li> <p>PDF \u6587\u4ef6\u8bfb\u53d6\u652f\u6301</p> <ul> <li>\u8bf4\u660e\uff1a\u7531\u4e8e PDF reader \u4f9d\u8d56\u7b2c\u4e09\u65b9\u5e93\uff0c\u4e3a\u907f\u514d\u4e3b\u6a21\u5757\u5f15\u5165\u4e0d\u5fc5\u8981\u7684\u4f9d\u8d56\uff0cPDF reader \u91c7\u7528\u72ec\u7acb <code>go.mod</code> \u7ba1\u7406\u3002</li> <li>\u4f7f\u7528\u65b9\u5f0f\uff1a\u5982\u9700\u652f\u6301 PDF \u6587\u4ef6\u8bfb\u53d6\uff0c\u9700\u5728\u4ee3\u7801\u4e2d\u624b\u52a8\u5f15\u5165 PDF reader \u5305\u8fdb\u884c\u6ce8\u518c\uff1a    <pre><code>import (\n    // \u5f15\u5165 PDF reader \u4ee5\u652f\u6301 .pdf \u6587\u4ef6\u89e3\u6790\n    _ \"trpc.group/trpc-go/trpc-agent-go/knowledge/document/reader/pdf\"\n)\n</code></pre></li> <li>\u6ce8\u610f\uff1a\u5176\u4ed6\u683c\u5f0f\uff08.txt/.md/.csv/.json \u7b49\uff09\u7684 reader \u5df2\u81ea\u52a8\u6ce8\u518c\uff0c\u65e0\u9700\u624b\u52a8\u5f15\u5165\u3002</li> </ul> </li> </ol>"},{"location":"zh/memory/","title":"Memory \u4f7f\u7528\u6587\u6863","text":""},{"location":"zh/memory/#_1","title":"\u6982\u8ff0","text":"<p>Memory \u662f tRPC-Agent-Go \u6846\u67b6\u4e2d\u7684\u8bb0\u5fc6\u7ba1\u7406\u7cfb\u7edf\uff0c\u4e3a Agent \u63d0\u4f9b\u6301\u4e45\u5316\u8bb0\u5fc6\u548c\u4e0a\u4e0b\u6587\u7ba1\u7406\u80fd\u529b\u3002\u901a\u8fc7\u96c6\u6210\u8bb0\u5fc6\u670d\u52a1\u3001\u4f1a\u8bdd\u7ba1\u7406\u548c\u8bb0\u5fc6\u5de5\u5177\uff0cMemory \u7cfb\u7edf\u80fd\u591f\u5e2e\u52a9 Agent \u8bb0\u4f4f\u7528\u6237\u4fe1\u606f\u3001\u7ef4\u62a4\u5bf9\u8bdd\u4e0a\u4e0b\u6587\uff0c\u5e76\u5728\u591a\u8f6e\u5bf9\u8bdd\u4e2d\u63d0\u4f9b\u4e2a\u6027\u5316\u7684\u54cd\u5e94\u4f53\u9a8c\u3002</p>"},{"location":"zh/memory/#_2","title":"\u5b9a\u4f4d","text":"<p>Memory \u7528\u4e8e\u7ba1\u7406\u4e0e\u7528\u6237\u76f8\u5173\u7684\u957f\u671f\u4fe1\u606f\uff0c\u9694\u79bb\u7ef4\u5ea6\u4e3a <code>&lt;appName, userID&gt;</code>\uff0c\u53ef\u4ee5\u7406\u89e3\u4e3a\u56f4\u7ed5\u5355\u4e2a\u7528\u6237\u9010\u6b65\u79ef\u7d2f\u7684\u201c\u4e2a\u4eba\u6863\u6848\u201d\u3002</p> <p>\u5728\u8de8\u4f1a\u8bdd\u573a\u666f\u4e2d\uff0cMemory \u4f7f\u7cfb\u7edf\u4f9d\u7136\u80fd\u591f\u4fdd\u7559\u5f53\u524d\u7528\u6237\u7684\u5173\u952e\u4fe1\u606f\uff0c\u907f\u514d\u6bcf\u4e2a\u4f1a\u8bdd\u90fd\u4ece\u96f6\u5f00\u59cb\u91cd\u590d\u83b7\u53d6\u7528\u6237\u4fe1\u606f\u3002</p> <p>\u5b83\u9002\u5408\u8bb0\u5f55\u7a33\u5b9a\u3001\u53ef\u590d\u7528\u7684\u4e8b\u5b9e\uff0c\u4f8b\u5982\u201c\u7528\u6237\u59d3\u540d\u662f\u5f20\u4e09\u201d\u3001\u201c\u804c\u4e1a\u662f\u540e\u7aef\u5de5\u7a0b\u5e08\u201d\u3001\u201c\u504f\u597d\u7b80\u77ed\u56de\u7b54\u201d\u3001\u201c\u5e38\u7528\u8bed\u8a00\u662f\u82f1\u6587\u201d\u7b49\u7528\u6237\u4fe1\u606f\uff0c\u5e76\u5728\u540e\u7eed\u591a\u6b21\u4ea4\u4e92\u4e2d\u76f4\u63a5\u4f7f\u7528\u8fd9\u4e9b\u4fe1\u606f\u3002</p>"},{"location":"zh/memory/#_3","title":"\u6838\u5fc3\u4ef7\u503c","text":"<ul> <li>\u4e0a\u4e0b\u6587\u5ef6\u7eed\u6027\uff1a\u8de8\u4f1a\u8bdd\u4fdd\u7559\u7528\u6237\u5386\u53f2\uff0c\u907f\u514d\u91cd\u590d\u8be2\u95ee\u548c\u8f93\u5165\u3002</li> <li>\u4e2a\u6027\u5316\u670d\u52a1\uff1a\u57fa\u4e8e\u957f\u671f\u7528\u6237\u753b\u50cf\u548c\u504f\u597d\uff0c\u63d0\u4f9b\u5b9a\u5236\u5316\u7684\u54cd\u5e94\u548c\u5efa\u8bae\u3002</li> <li>\u77e5\u8bc6\u79ef\u7d2f\uff1a\u5c06\u5bf9\u8bdd\u4e2d\u7684\u4e8b\u5b9e\u548c\u7ecf\u9a8c\u8f6c\u5316\u4e3a\u53ef\u590d\u7528\u7684\u77e5\u8bc6\u3002</li> <li>\u6301\u4e45\u5316\u5b58\u50a8\uff1a\u652f\u6301\u591a\u79cd\u5b58\u50a8\u540e\u7aef\uff0c\u786e\u4fdd\u6570\u636e\u5b89\u5168\u53ef\u9760\u3002</li> </ul>"},{"location":"zh/memory/#_4","title":"\u4f7f\u7528\u573a\u666f","text":"<p>Memory \u6a21\u5757\u9002\u7528\u4e8e\u9700\u8981\u8de8\u4f1a\u8bdd\u4fdd\u7559\u7528\u6237\u4fe1\u606f\u548c\u4e0a\u4e0b\u6587\u7684\u573a\u666f\uff1a</p>"},{"location":"zh/memory/#1-agent","title":"\u573a\u666f 1\uff1a\u4e2a\u6027\u5316\u5ba2\u670d Agent","text":"<p>\u9700\u6c42\uff1a\u5ba2\u670d Agent \u9700\u8981\u8bb0\u4f4f\u7528\u6237\u4fe1\u606f\u3001\u5386\u53f2\u95ee\u9898\u548c\u504f\u597d\uff0c\u63d0\u4f9b\u4e00\u81f4\u6027\u670d\u52a1\u3002</p> <p>\u5b9e\u73b0\u65b9\u5f0f\uff1a - \u9996\u6b21\u5bf9\u8bdd\uff1aAgent \u4f7f\u7528 <code>memory_add</code> \u8bb0\u5f55\u59d3\u540d\u3001\u516c\u53f8\u3001\u8054\u7cfb\u65b9\u5f0f - \u8bb0\u5f55\u7528\u6237\u504f\u597d\u5982\"\u559c\u6b22\u7b80\u77ed\u56de\u7b54\"\u3001\"\u6280\u672f\u80cc\u666f\" - \u540e\u7eed\u4f1a\u8bdd\uff1aAgent \u4f7f\u7528 <code>memory_load</code> \u52a0\u8f7d\u7528\u6237\u4fe1\u606f\uff0c\u65e0\u9700\u91cd\u590d\u8be2\u95ee - \u95ee\u9898\u89e3\u51b3\u540e\uff1a\u4f7f\u7528 <code>memory_update</code> \u66f4\u65b0\u95ee\u9898\u72b6\u6001</p>"},{"location":"zh/memory/#2-agent","title":"\u573a\u666f 2\uff1a\u5b66\u4e60\u966a\u4f34 Agent","text":"<p>\u9700\u6c42\uff1a\u6559\u80b2 Agent \u9700\u8981\u8ffd\u8e2a\u5b66\u751f\u5b66\u4e60\u8fdb\u5ea6\u3001\u77e5\u8bc6\u638c\u63e1\u60c5\u51b5\u548c\u5174\u8da3\u3002</p> <p>\u5b9e\u73b0\u65b9\u5f0f\uff1a - \u4f7f\u7528 <code>memory_add</code> \u8bb0\u5f55\u5df2\u638c\u63e1\u7684\u77e5\u8bc6\u70b9 - \u4f7f\u7528\u4e3b\u9898\u6807\u7b7e\u5206\u7c7b\uff1a<code>[\"\u6570\u5b66\", \"\u51e0\u4f55\"]</code>\u3001<code>[\"\u7f16\u7a0b\", \"Python\"]</code> - \u4f7f\u7528 <code>memory_search</code> \u67e5\u8be2\u76f8\u5173\u77e5\u8bc6\uff0c\u907f\u514d\u91cd\u590d\u6559\u5b66 - \u6839\u636e\u8bb0\u5fc6\u8c03\u6574\u6559\u5b66\u7b56\u7565\uff0c\u63d0\u4f9b\u4e2a\u6027\u5316\u5b66\u4e60\u8def\u5f84</p>"},{"location":"zh/memory/#3-agent","title":"\u573a\u666f 3\uff1a\u9879\u76ee\u7ba1\u7406 Agent","text":"<p>\u9700\u6c42\uff1a\u9879\u76ee\u7ba1\u7406 Agent \u9700\u8981\u8ffd\u8e2a\u9879\u76ee\u4fe1\u606f\u3001\u56e2\u961f\u6210\u5458\u548c\u4efb\u52a1\u8fdb\u5ea6\u3002</p> <p>\u5b9e\u73b0\u65b9\u5f0f\uff1a - \u8bb0\u5f55\u5173\u952e\u9879\u76ee\u4fe1\u606f\uff1a<code>memory_add(\"\u9879\u76ee X \u4f7f\u7528 Go \u8bed\u8a00\", [\"\u9879\u76ee\", \"\u6280\u672f\u6808\"])</code> - \u8bb0\u5f55\u56e2\u961f\u6210\u5458\u89d2\u8272\uff1a<code>memory_add(\"\u5f20\u4e09\u662f\u540e\u7aef\u8d1f\u8d23\u4eba\", [\"\u56e2\u961f\", \"\u89d2\u8272\"])</code> - \u4f7f\u7528 <code>memory_search</code> \u5feb\u901f\u67e5\u627e\u76f8\u5173\u4fe1\u606f - \u9879\u76ee\u5b8c\u6210\u540e\uff1a\u4f7f\u7528 <code>memory_clear</code> \u6e05\u7a7a\u4e34\u65f6\u4fe1\u606f</p>"},{"location":"zh/memory/#_5","title":"\u5feb\u901f\u5f00\u59cb","text":""},{"location":"zh/memory/#_6","title":"\u73af\u5883\u8981\u6c42","text":"<ul> <li>Go 1.21 \u6216\u66f4\u9ad8\u7248\u672c</li> <li>\u6709\u6548\u7684 LLM API \u5bc6\u94a5\uff08OpenAI \u517c\u5bb9\u63a5\u53e3\uff09</li> <li>\u5b58\u50a8\u540e\u7aef\uff08\u53ef\u9009\uff09\uff1a<ul> <li>\u5f00\u53d1/\u6d4b\u8bd5\uff1a\u65e0\u9700\u5916\u90e8\u4f9d\u8d56\uff08\u4f7f\u7528\u5185\u5b58\u5b58\u50a8\uff09</li> <li>\u751f\u4ea7\u73af\u5883\uff1aRedis\u3001MySQL \u6216 PostgreSQL \u670d\u52a1</li> </ul> </li> </ul>"},{"location":"zh/memory/#_7","title":"\u914d\u7f6e\u73af\u5883\u53d8\u91cf","text":"<pre><code># LLM API \u914d\u7f6e\uff08\u5fc5\u9700\uff09\nexport OPENAI_API_KEY=\"your-openai-api-key\"\nexport OPENAI_BASE_URL=\"https://api.openai.com/v1\"\n\n# \u5b58\u50a8\u540e\u7aef\u914d\u7f6e\uff08\u53ef\u9009\uff0c\u6839\u636e\u9009\u62e9\u7684\u540e\u7aef\u914d\u7f6e\uff09\n# Redis\nexport REDIS_ADDR=\"localhost:6379\"\n\n# MySQL\nexport MYSQL_HOST=\"localhost\"\nexport MYSQL_PORT=\"3306\"\nexport MYSQL_USER=\"root\"\nexport MYSQL_PASSWORD=\"password\"\nexport MYSQL_DATABASE=\"memory_db\"\n\n# PostgreSQL\nexport PG_HOST=\"localhost\"\nexport PG_PORT=\"5432\"\nexport PG_USER=\"postgres\"\nexport PG_PASSWORD=\"password\"\nexport PG_DATABASE=\"memory_db\"\n</code></pre>"},{"location":"zh/memory/#_8","title":"\u6700\u7b80\u793a\u4f8b","text":"<pre><code>package main\n\nimport (\n    \"context\"\n    \"log\"\n\n    // \u6838\u5fc3\u7ec4\u4ef6\n    \"trpc.group/trpc-go/trpc-agent-go/agent/llmagent\"\n    memoryinmemory \"trpc.group/trpc-go/trpc-agent-go/memory/inmemory\"\n    \"trpc.group/trpc-go/trpc-agent-go/model\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/openai\"\n    \"trpc.group/trpc-go/trpc-agent-go/runner\"\n    \"trpc.group/trpc-go/trpc-agent-go/session/inmemory\"\n)\n\nfunc main() {\n    ctx := context.Background()\n\n    // 1. \u521b\u5efa\u8bb0\u5fc6\u670d\u52a1\n    memoryService := memoryinmemory.NewMemoryService()\n\n    // 2. \u521b\u5efa LLM \u6a21\u578b\n    modelInstance := openai.New(\"deepseek-chat\")\n\n    // 3. \u521b\u5efa Agent \u5e76\u6ce8\u518c\u8bb0\u5fc6\u5de5\u5177\n    llmAgent := llmagent.New(\n        \"memory-assistant\",\n        llmagent.WithModel(modelInstance),\n        llmagent.WithDescription(\"\u5177\u6709\u8bb0\u5fc6\u80fd\u529b\u7684\u667a\u80fd\u52a9\u624b\"),\n        llmagent.WithInstruction(\"\u8bb0\u4f4f\u7528\u6237\u7684\u91cd\u8981\u4fe1\u606f\uff0c\u5e76\u5728\u9700\u8981\u65f6\u56de\u5fc6\u8d77\u6765\u3002\"),\n        llmagent.WithTools(memoryService.Tools()), // \u6ce8\u518c\u8bb0\u5fc6\u5de5\u5177\n    )\n\n    // 4. \u521b\u5efa Runner \u5e76\u8bbe\u7f6e\u8bb0\u5fc6\u670d\u52a1\n    sessionService := inmemory.NewSessionService()\n    appRunner := runner.NewRunner(\n        \"memory-chat\",\n        llmAgent,\n        runner.WithSessionService(sessionService),\n        runner.WithMemoryService(memoryService), // \u8bbe\u7f6e\u8bb0\u5fc6\u670d\u52a1\n    )\n\n    // 5. \u6267\u884c\u5bf9\u8bdd\uff08Agent \u4f1a\u81ea\u52a8\u4f7f\u7528\u8bb0\u5fc6\u5de5\u5177\uff09\n    log.Println(\"\ud83e\udde0 \u5f00\u59cb\u8bb0\u5fc6\u5bf9\u8bdd...\")\n    message := model.NewUserMessage(\"\u4f60\u597d\uff0c\u6211\u7684\u540d\u5b57\u662f\u5f20\u4e09\uff0c\u6211\u559c\u6b22\u7f16\u7a0b\")\n    eventChan, err := appRunner.Run(ctx, \"user123\", \"session456\", message)\n    if err != nil {\n        log.Fatalf(\"Failed to run agent: %v\", err)\n    }\n\n    // 6. \u5904\u7406\u54cd\u5e94 ...\n}\n</code></pre>"},{"location":"zh/memory/#_9","title":"\u6838\u5fc3\u6982\u5ff5","text":"<p>memory \u6a21\u5757 \u662f tRPC-Agent-Go \u6846\u67b6\u7684\u8bb0\u5fc6\u7ba1\u7406\u6838\u5fc3\uff0c\u63d0\u4f9b\u5b8c\u6574\u7684\u8bb0\u5fc6\u5b58\u50a8\u548c\u68c0\u7d22\u80fd\u529b\u3002</p>"},{"location":"zh/memory/#_10","title":"\u67b6\u6784\u8bbe\u8ba1","text":"<p>Memory \u6a21\u5757\u91c7\u7528\u5206\u5c42\u8bbe\u8ba1\uff0c\u7531\u4ee5\u4e0b\u6838\u5fc3\u7ec4\u4ef6\u7ec4\u6210\uff1a</p> <pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                         Agent                                \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502\n\u2502  \u2502          Memory Tools\uff086 \u4e2a\u5de5\u5177\uff09                     \u2502   \u2502\n\u2502  \u2502  add | update | delete | search | load | clear       \u2502   \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                              \u2502\n                              \u2193\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                    Memory Service                            \u2502\n\u2502  \u2022 UserKey: &lt;appName, userID&gt; \u9694\u79bb                         \u2502\n\u2502  \u2022 Entry: \u8bb0\u5fc6\u6761\u76ee\uff08ID\u3001\u5185\u5bb9\u3001\u4e3b\u9898\u3001\u65f6\u95f4\u6233\uff09                \u2502\n\u2502  \u2022 Operations: Add\u3001Update\u3001Delete\u3001Search\u3001Load\u3001Clear    \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                              \u2502\n                              \u2193\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                   Storage Backends                           \u2502\n\u2502  \u2022 InMemory: \u5185\u5b58\u5b58\u50a8\uff08\u5f00\u53d1/\u6d4b\u8bd5\uff09                          \u2502\n\u2502  \u2022 Redis: \u9ad8\u6027\u80fd\u7f13\u5b58\uff08\u751f\u4ea7\u73af\u5883\uff09                            \u2502\n\u2502  \u2022 MySQL: \u5173\u7cfb\u578b\u6570\u636e\u5e93\uff08ACID \u4fdd\u8bc1\uff09                        \u2502\n\u2502  \u2022 PostgreSQL: \u5173\u7cfb\u578b\u6570\u636e\u5e93\uff08JSONB \u652f\u6301\uff09                  \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre> <p>\u5de5\u4f5c\u6d41\u7a0b\uff1a</p> <ol> <li>Agent \u901a\u8fc7 Memory Tools \u4e0e Memory Service \u4ea4\u4e92</li> <li>Memory Service \u7ba1\u7406\u8bb0\u5fc6\u7684\u751f\u547d\u5468\u671f\uff08CRUD \u64cd\u4f5c\uff09</li> <li>\u8bb0\u5fc6\u4ee5 Entry \u5f62\u5f0f\u5b58\u50a8\uff0c\u5305\u542b\u5185\u5bb9\u3001\u4e3b\u9898\u3001\u65f6\u95f4\u6233\u7b49</li> <li>Memory ID \u901a\u8fc7\u5185\u5bb9 + \u4e3b\u9898\u7684 SHA256 \u54c8\u5e0c\u751f\u6210\uff0c\u786e\u4fdd\u5e42\u7b49\u6027</li> <li>Storage Backends \u63d0\u4f9b\u6301\u4e45\u5316\uff0c\u652f\u6301\u591a\u79cd\u5b58\u50a8\u9009\u9879</li> </ol>"},{"location":"zh/memory/#_11","title":"\u6838\u5fc3\u7ec4\u4ef6","text":"\u7ec4\u4ef6 \u63cf\u8ff0 \u6280\u672f\u7ec6\u8282 Memory Service \u6838\u5fc3\u8bb0\u5fc6\u7ba1\u7406\u670d\u52a1\uff0c\u63d0\u4f9b CRUD \u80fd\u529b \u5b9e\u73b0\u7edf\u4e00 Service \u63a5\u53e3\uff0c\u652f\u6301\u591a\u79cd\u5b58\u50a8\u540e\u7aef UserKey \u7528\u6237\u6807\u8bc6\u7b26\uff0c\u7531 <code>appName</code> \u548c <code>userID</code> \u7ec4\u6210 \u8bb0\u5fc6\u9694\u79bb\u7684\u6700\u5c0f\u5355\u4f4d\uff0c\u786e\u4fdd\u5e94\u7528/\u7528\u6237\u95f4\u8bb0\u5fc6\u4e0d\u5e72\u6270 Entry \u8bb0\u5fc6\u6761\u76ee\uff0c\u5305\u542b\u5b8c\u6574\u8bb0\u5fc6\u4fe1\u606f \u5305\u62ec ID\u3001\u5185\u5bb9\u3001\u4e3b\u9898\u3001created_at\u3001updated_at \u5b57\u6bb5 Memory ID \u8bb0\u5fc6\u7684\u552f\u4e00\u6807\u8bc6\u7b26 \u57fa\u4e8e\u5185\u5bb9 + \u4e3b\u9898\u7684 SHA256 \u54c8\u5e0c\uff0c\u76f8\u540c\u5185\u5bb9\u4ea7\u751f\u76f8\u540c ID Topics \u8bb0\u5fc6\u7684\u4e3b\u9898\u6807\u7b7e \u7528\u4e8e\u5206\u7c7b\u548c\u68c0\u7d22\uff0c\u652f\u6301\u591a\u4e2a\u6807\u7b7e Memory Tools Agent \u53ef\u8c03\u7528\u7684\u8bb0\u5fc6\u64cd\u4f5c\u5de5\u5177 \u5305\u62ec add\u3001update\u3001delete\u3001search\u3001load\u3001clear Storage Backend \u5b58\u50a8\u540e\u7aef\u5b9e\u73b0 \u652f\u6301 InMemory\u3001Redis\u3001MySQL\u3001PostgreSQL"},{"location":"zh/memory/#_12","title":"\u5173\u952e\u6d41\u7a0b","text":""},{"location":"zh/memory/#_13","title":"\u8bb0\u5fc6\u7684\u751f\u547d\u5468\u671f","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 1. \u521b\u5efa\u8bb0\u5fc6   \u2502  \u7528\u6237\u5bf9\u8bdd \u2192 Agent \u5224\u65ad \u2192 \u8c03\u7528 memory_add\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n       \u2502\n       \u2193\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 2. \u751f\u6210 ID   \u2502  SHA256\uff08\u5185\u5bb9 + \u4e3b\u9898\uff09 \u2192 \u552f\u4e00\u6807\u8bc6\u7b26\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n       \u2502\n       \u2193\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 3. \u5b58\u50a8\u8bb0\u5fc6   \u2502  Entry \u2192 Storage Backend\uff08InMemory/Redis/MySQL/PostgreSQL\uff09\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n       \u2502\n       \u2193\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 4. \u68c0\u7d22\u8bb0\u5fc6   \u2502  memory_load\uff08\u65f6\u95f4\u6392\u5e8f\uff09\u6216 memory_search\uff08\u5173\u952e\u8bcd\u5339\u914d\uff09\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n       \u2502\n       \u2193\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 5. \u66f4\u65b0\u8bb0\u5fc6   \u2502  \u76f8\u540c ID \u8986\u76d6\u66f4\u65b0\uff0c\u5237\u65b0 updated_at\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n       \u2502\n       \u2193\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 6. \u5220\u9664\u8bb0\u5fc6   \u2502  \u786c\u5220\u9664\u6216\u8f6f\u5220\u9664\uff08\u53d6\u51b3\u4e8e\u914d\u7f6e\uff09\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"zh/memory/#_14","title":"\u8bb0\u5fc6\u68c0\u7d22\u6d41\u7a0b","text":"<p>Load\uff08\u52a0\u8f7d\u8bb0\u5fc6\uff09\uff1a 1. \u6839\u636e UserKey \u67e5\u8be2\u8be5\u7528\u6237\u7684\u6240\u6709\u8bb0\u5fc6 2. \u6309 <code>updated_at</code> \u964d\u5e8f\u6392\u5e8f\uff08\u6700\u8fd1\u66f4\u65b0\u7684\u5728\u524d\uff09 3. \u8fd4\u56de\u524d N \u6761\u8bb0\u5fc6\uff08\u9ed8\u8ba4 10 \u6761\uff09</p> <p>Search\uff08\u641c\u7d22\u8bb0\u5fc6\uff09\uff1a 1. \u5c06\u67e5\u8be2\u6587\u672c\u5206\u8bcd\uff08\u652f\u6301\u4e2d\u82f1\u6587\uff09 2. \u8fc7\u6ee4\u505c\u7528\u8bcd\uff08a\u3001the\u3001is\u3001of \u7b49\uff09 3. \u5bf9\u6bcf\u6761\u8bb0\u5fc6\u7684\u5185\u5bb9\u548c\u4e3b\u9898\u8fdb\u884c\u5339\u914d 4. \u8fd4\u56de\u6240\u6709\u5339\u914d\u7684\u8bb0\u5fc6\uff0c\u6309\u66f4\u65b0\u65f6\u95f4\u6392\u5e8f</p>"},{"location":"zh/memory/#id","title":"\u8bb0\u5fc6 ID \u751f\u6210\u7b56\u7565","text":"<p>\u8bb0\u5fc6 ID \u57fa\u4e8e\u5185\u5bb9\u548c\u4e3b\u9898\u7684 SHA256 \u54c8\u5e0c\u751f\u6210\uff0c\u786e\u4fdd\u76f8\u540c\u5185\u5bb9\u4ea7\u751f\u76f8\u540c ID\uff1a</p> <pre><code>// \u751f\u6210\u903b\u8f91\ncontent := \"memory:\" + \u8bb0\u5fc6\u5185\u5bb9\nif len(\u4e3b\u9898) &gt; 0 {\n    content += \"|topics:\" + join(\u4e3b\u9898, \"\uff0c\")\n}\nmemoryID := SHA256(content) // 64 \u4f4d\u5341\u516d\u8fdb\u5236\u5b57\u7b26\u4e32\n</code></pre> <p>\u7279\u6027\uff1a - \u5e42\u7b49\u6027\uff1a\u91cd\u590d\u6dfb\u52a0\u76f8\u540c\u5185\u5bb9\u4e0d\u4f1a\u521b\u5efa\u65b0\u8bb0\u5fc6\uff0c\u800c\u662f\u8986\u76d6\u66f4\u65b0 - \u4e00\u81f4\u6027\uff1a\u76f8\u540c\u5185\u5bb9\u5728\u4e0d\u540c\u65f6\u95f4\u6dfb\u52a0\u4ea7\u751f\u76f8\u540c ID - \u53bb\u91cd\uff1a\u5929\u7136\u652f\u6301\u53bb\u91cd\uff0c\u907f\u514d\u5197\u4f59\u5b58\u50a8</p>"},{"location":"zh/memory/#_15","title":"\u4f7f\u7528\u6307\u5357","text":""},{"location":"zh/memory/#agent","title":"\u4e0e Agent \u96c6\u6210","text":"<p>\u4f7f\u7528\u4e24\u6b65\u65b9\u6cd5\u5c06 Memory Service \u96c6\u6210\u5230 Agent\uff1a</p> <ol> <li>\u6ce8\u518c\u5de5\u5177\uff1a\u4f7f\u7528 <code>llmagent.WithTools(memoryService.Tools())</code> \u5411 Agent \u6ce8\u518c\u8bb0\u5fc6\u5de5\u5177</li> <li>\u8bbe\u7f6e\u670d\u52a1\uff1a\u4f7f\u7528 <code>runner.WithMemoryService(memoryService)</code> \u5728 Runner \u4e2d\u8bbe\u7f6e\u8bb0\u5fc6\u670d\u52a1</li> </ol> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/agent/llmagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/memory\"\n    memoryinmemory \"trpc.group/trpc-go/trpc-agent-go/memory/inmemory\"\n    \"trpc.group/trpc-go/trpc-agent-go/runner\"\n)\n\n// \u6b65\u9aa4 1\uff1a\u521b\u5efa\u8bb0\u5fc6\u670d\u52a1\nmemoryService := memoryinmemory.NewMemoryService()\n\n// \u6b65\u9aa4 2\uff1a\u521b\u5efa Agent \u5e76\u6ce8\u518c\u8bb0\u5fc6\u5de5\u5177\nllmAgent := llmagent.New(\n    \"memory-assistant\",\n    llmagent.WithModel(modelInstance),\n    llmagent.WithDescription(\"\u5177\u6709\u8bb0\u5fc6\u80fd\u529b\u7684\u667a\u80fd\u52a9\u624b\"),\n    llmagent.WithTools(memoryService.Tools()), // \u663e\u5f0f\u6ce8\u518c\u5de5\u5177\n)\n\n// \u6b65\u9aa4 3\uff1a\u521b\u5efa Runner \u5e76\u8bbe\u7f6e\u8bb0\u5fc6\u670d\u52a1\nappRunner := runner.NewRunner(\n    \"memory-chat\",\n    llmAgent,\n    runner.WithMemoryService(memoryService), // \u5728 Runner \u5c42\u8bbe\u7f6e\u670d\u52a1\n)\n</code></pre>"},{"location":"zh/memory/#memory-service","title":"\u8bb0\u5fc6\u670d\u52a1 (Memory Service)","text":"<p>\u8bb0\u5fc6\u670d\u52a1\u652f\u6301\u56db\u79cd\u5b58\u50a8\u540e\u7aef\uff0c\u53ef\u6839\u636e\u573a\u666f\u9009\u62e9\u3002</p>"},{"location":"zh/memory/#_16","title":"\u914d\u7f6e\u793a\u4f8b","text":"<pre><code>import (\n    memoryinmemory \"trpc.group/trpc-go/trpc-agent-go/memory/inmemory\"\n    memoryredis \"trpc.group/trpc-go/trpc-agent-go/memory/redis\"\n    memorymysql \"trpc.group/trpc-go/trpc-agent-go/memory/mysql\"\n    memorypostgres \"trpc.group/trpc-go/trpc-agent-go/memory/postgres\"\n)\n\n// 1. \u5185\u5b58\u5b58\u50a8\uff08\u5f00\u53d1/\u6d4b\u8bd5\uff09\nmemService := memoryinmemory.NewMemoryService()\n\n// 2. Redis \u5b58\u50a8\uff08\u751f\u4ea7\u73af\u5883 - \u9ad8\u6027\u80fd\uff09\nredisService, err := memoryredis.NewService(\n    memoryredis.WithRedisClientURL(\"redis://localhost:6379\"),\n)\nif err != nil {\n    // \u5904\u7406\u9519\u8bef\n}\n\n// 3. MySQL \u5b58\u50a8\uff08\u751f\u4ea7\u73af\u5883 - ACID \u4fdd\u8bc1\uff09\nmysqlDSN := \"user:password@tcp(localhost:3306)/dbname?parseTime=true\"\nmysqlService, err := memorymysql.NewService(\n    memorymysql.WithMySQLClientDSN(mysqlDSN),\n    memorymysql.WithSoftDelete(true), // \u53ef\u9009\uff1a\u542f\u7528\u8f6f\u5220\u9664\n)\nif err != nil {\n    // \u5904\u7406\u9519\u8bef\n}\n\n// 4. PostgreSQL \u5b58\u50a8\uff08\u751f\u4ea7\u73af\u5883 - JSONB \u652f\u6301\uff09\npostgresService, err := memorypostgres.NewService(\n    memorypostgres.WithHost(\"localhost\"),\n    memorypostgres.WithPort(5432),\n    memorypostgres.WithUser(\"postgres\"),\n    memorypostgres.WithPassword(\"password\"),\n    memorypostgres.WithDatabase(\"dbname\"),\n    memorypostgres.WithSoftDelete(true), // \u53ef\u9009\uff1a\u542f\u7528\u8f6f\u5220\u9664\n)\nif err != nil {\n    // \u5904\u7406\u9519\u8bef\n}\n</code></pre> <p>\u5feb\u901f\u9009\u62e9\u6307\u5357\uff1a</p> \u573a\u666f \u63a8\u8350\u540e\u7aef \u539f\u56e0 \u672c\u5730\u5f00\u53d1 InMemory \u96f6\u914d\u7f6e\uff0c\u5feb\u901f\u542f\u52a8 \u9ad8\u5e76\u53d1\u8bfb\u5199 Redis \u5185\u5b58\u7ea7\u6027\u80fd\uff0c\u652f\u6301\u5206\u5e03\u5f0f \u9700\u8981\u590d\u6742\u67e5\u8be2 MySQL/PostgreSQL \u5173\u7cfb\u578b\u6570\u636e\u5e93\uff0cSQL \u652f\u6301 \u9700\u8981 JSON \u9ad8\u7ea7\u64cd\u4f5c PostgreSQL JSONB \u7c7b\u578b\uff0c\u9ad8\u6548 JSON \u67e5\u8be2 \u9700\u8981\u5ba1\u8ba1\u8ffd\u8e2a MySQL/PostgreSQL \u652f\u6301\u8f6f\u5220\u9664\uff0c\u53ef\u6062\u590d\u6570\u636e"},{"location":"zh/memory/#_17","title":"\u8bb0\u5fc6\u5de5\u5177\u914d\u7f6e","text":"<p>\u8bb0\u5fc6\u670d\u52a1\u63d0\u4f9b 6 \u4e2a\u5de5\u5177\uff0c\u9ed8\u8ba4\u542f\u7528\u5e38\u7528\u5de5\u5177\uff0c\u5371\u9669\u64cd\u4f5c\u9700\u624b\u52a8\u542f\u7528\u3002</p>"},{"location":"zh/memory/#_18","title":"\u5de5\u5177\u6e05\u5355","text":"\u5de5\u5177 \u529f\u80fd \u9ed8\u8ba4\u72b6\u6001 \u8bf4\u660e <code>memory_add</code> \u6dfb\u52a0\u65b0\u8bb0\u5fc6 \u2705 \u542f\u7528 \u521b\u5efa\u65b0\u8bb0\u5fc6\u6761\u76ee <code>memory_update</code> \u66f4\u65b0\u8bb0\u5fc6 \u2705 \u542f\u7528 \u4fee\u6539\u73b0\u6709\u8bb0\u5fc6 <code>memory_search</code> \u641c\u7d22\u8bb0\u5fc6 \u2705 \u542f\u7528 \u6839\u636e\u5173\u952e\u8bcd\u67e5\u627e <code>memory_load</code> \u52a0\u8f7d\u8bb0\u5fc6 \u2705 \u542f\u7528 \u52a0\u8f7d\u6700\u8fd1\u7684\u8bb0\u5fc6 <code>memory_delete</code> \u5220\u9664\u8bb0\u5fc6 \u274c \u7981\u7528 \u5220\u9664\u5355\u6761\u8bb0\u5fc6 <code>memory_clear</code> \u6e05\u7a7a\u8bb0\u5fc6 \u274c \u7981\u7528 \u5220\u9664\u6240\u6709\u8bb0\u5fc6"},{"location":"zh/memory/#_19","title":"\u542f\u7528/\u7981\u7528\u5de5\u5177","text":"<pre><code>// \u573a\u666f 1\uff1a\u7528\u6237\u53ef\u7ba1\u7406\uff08\u5141\u8bb8\u5220\u9664\u5355\u6761\u8bb0\u5fc6\uff09\nmemoryService := memoryinmemory.NewMemoryService(\n    memoryinmemory.WithToolEnabled(memory.DeleteToolName, true),\n)\n\n// \u573a\u666f 2\uff1a\u7ba1\u7406\u5458\u6743\u9650\uff08\u5141\u8bb8\u6e05\u7a7a\u6240\u6709\u8bb0\u5fc6\uff09\nmemoryService := memoryinmemory.NewMemoryService(\n    memoryinmemory.WithToolEnabled(memory.DeleteToolName, true),\n    memoryinmemory.WithToolEnabled(memory.ClearToolName, true),\n)\n\n// \u573a\u666f 3\uff1a\u53ea\u8bfb\u52a9\u624b\uff08\u53ea\u5141\u8bb8\u67e5\u8be2\uff09\nmemoryService := memoryinmemory.NewMemoryService(\n    memoryinmemory.WithToolEnabled(memory.AddToolName, false),\n    memoryinmemory.WithToolEnabled(memory.UpdateToolName, false),\n)\n</code></pre>"},{"location":"zh/memory/#id_1","title":"\u8986\u76d6\u8bed\u4e49\uff08ID \u4e0e\u91cd\u590d\uff09","text":"<ul> <li>\u8bb0\u5fc6 ID \u57fa\u4e8e\u300c\u5185\u5bb9 + \u4e3b\u9898\u300d\u751f\u6210\u3002\u5bf9\u540c\u4e00\u7528\u6237\u91cd\u590d\u6dfb\u52a0\u76f8\u540c\u5185\u5bb9\u4e0e\u4e3b\u9898\u662f\u5e42\u7b49\u7684\uff1a\u4f1a\u8986\u76d6\u539f\u6709\u8bb0\u5f55\uff08\u975e\u8ffd\u52a0\uff09\uff0c\u5e76\u5237\u65b0 UpdatedAt\u3002</li> <li>\u5982\u9700\u201c\u5141\u8bb8\u91cd\u590d/\u53ea\u8fd4\u56de\u5df2\u5b58\u5728/\u5ffd\u7565\u91cd\u590d\u201d\u7b49\u7b56\u7565\uff0c\u53ef\u901a\u8fc7\u81ea\u5b9a\u4e49\u5de5\u5177\u6216\u6269\u5c55\u670d\u52a1\u7b56\u7565\u914d\u7f6e\u5b9e\u73b0\u3002</li> </ul>"},{"location":"zh/memory/#_20","title":"\u81ea\u5b9a\u4e49\u5de5\u5177\u5b9e\u73b0","text":"<p>\u4f60\u53ef\u4ee5\u7528\u81ea\u5b9a\u4e49\u5b9e\u73b0\u8986\u76d6\u9ed8\u8ba4\u5de5\u5177\u3002\u53c2\u8003 memory/tool/tool.go \u4e86\u89e3\u5982\u4f55\u5b9e\u73b0\u81ea\u5b9a\u4e49\u5de5\u5177\uff1a</p> <pre><code>import (\n    \"context\"\n    \"fmt\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/memory\"\n    memoryinmemory \"trpc.group/trpc-go/trpc-agent-go/memory/inmemory\"\n    toolmemory \"trpc.group/trpc-go/trpc-agent-go/memory/tool\"\n    \"trpc.group/trpc-go/trpc-agent-go/tool\"\n    \"trpc.group/trpc-go/trpc-agent-go/tool/function\"\n)\n\n// \u81ea\u5b9a\u4e49\u6e05\u7a7a\u5de5\u5177\uff0c\u4f7f\u7528\u8c03\u7528\u4e0a\u4e0b\u6587\u4e2d\u7684 MemoryService \u4e0e\u4f1a\u8bdd\u4fe1\u606f\u3002\nfunc customClearMemoryTool() tool.Tool {\n    clearFunc := func(ctx context.Context, _ *toolmemory.ClearMemoryRequest) (*toolmemory.ClearMemoryResponse, error) {\n        // \u4ece\u8c03\u7528\u4e0a\u4e0b\u6587\u83b7\u53d6 MemoryService \u4e0e\u7528\u6237\u4fe1\u606f\u3002\n        memSvc, err := toolmemory.GetMemoryServiceFromContext(ctx)\n        if err != nil {\n            return nil, fmt.Errorf(\"custom clear tool: %w\", err)\n        }\n        appName, userID, err := toolmemory.GetAppAndUserFromContext(ctx)\n        if err != nil {\n            return nil, fmt.Errorf(\"custom clear tool: %w\", err)\n        }\n\n        if err := memSvc.ClearMemories(ctx, memory.UserKey{AppName: appName, UserID: userID}); err != nil {\n            return nil, fmt.Errorf(\"custom clear tool: failed to clear memories: %w\", err)\n        }\n        return &amp;toolmemory.ClearMemoryResponse{Message: \"\ud83c\udf89 \u6240\u6709\u8bb0\u5fc6\u5df2\u6210\u529f\u6e05\u7a7a\uff01\"}, nil\n    }\n\n    return function.NewFunctionTool(\n        clearFunc,\n        function.WithName(memory.ClearToolName),\n        function.WithDescription(\"\u6e05\u7a7a\u7528\u6237\u7684\u6240\u6709\u8bb0\u5fc6\u3002\"),\n    )\n}\n\n// \u5728\u5185\u5b58\u5b9e\u73b0\u4e0a\u6ce8\u518c\u81ea\u5b9a\u4e49\u5de5\u5177\u3002\nmemoryService := memoryinmemory.NewMemoryService(\n    memoryinmemory.WithCustomTool(memory.ClearToolName, customClearMemoryTool),\n)\n</code></pre>"},{"location":"zh/memory/#_21","title":"\u5b8c\u6574\u793a\u4f8b","text":"<p>\u4ee5\u4e0b\u662f\u4e00\u4e2a\u5b8c\u6574\u7684\u4ea4\u4e92\u5f0f\u5bf9\u8bdd\u793a\u4f8b\uff0c\u5c55\u793a\u4e86\u8bb0\u5fc6\u529f\u80fd\u7684\u5b9e\u9645\u4f7f\u7528\u3002</p>"},{"location":"zh/memory/#_22","title":"\u8fd0\u884c\u793a\u4f8b","text":"<pre><code># \u67e5\u770b\u5e2e\u52a9\ncd examples/memory\ngo run . -h\n\n# \u4f7f\u7528\u9ed8\u8ba4\u914d\u7f6e\uff08\u5185\u5b58\u5b58\u50a8 + \u6d41\u5f0f\u8f93\u51fa\uff09\ngo run .\n\n# \u4f7f\u7528 Redis \u5b58\u50a8\nexport REDIS_ADDR=localhost:6379\ngo run . -memory redis\n\n# \u4f7f\u7528 MySQL \u5b58\u50a8\uff08\u5e26\u8f6f\u5220\u9664\uff09\nexport MYSQL_HOST=localhost\nexport MYSQL_PASSWORD=password\ngo run . -memory mysql -soft-delete\n\n# \u4f7f\u7528 PostgreSQL \u5b58\u50a8\nexport PG_HOST=localhost\nexport PG_PASSWORD=password\ngo run . -memory postgres -soft-delete\n\n# \u975e\u6d41\u5f0f\u8f93\u51fa\u6a21\u5f0f\ngo run . -streaming=false\n</code></pre>"},{"location":"zh/memory/#_23","title":"\u4ea4\u4e92\u6f14\u793a","text":"<pre><code>$ go run .\n\ud83e\udde0 Multi Turn Chat with Memory\nModel: deepseek-chat\nMemory Service: inmemory\nIn-memory\nStreaming: true\nAvailable tools: memory_add, memory_update, memory_search, memory_load\n(memory_delete, memory_clear disabled by default, and can be enabled or customized)\n==================================================\n\u2705 Memory chat ready! Session: memory-session-1765504743\n\n\ud83d\udca1 Special commands:\n   /memory   - Show user memories\n   /new      - Start a new session\n   /exit     - End the conversation\n\n\ud83d\udc64 You: \u4f60\u597d\uff0c\u6211\u662f\u5f20\u4e09\uff0c\u6211\u559c\u6b22 Go \u8bed\u8a00\u7f16\u7a0b\n\ud83e\udd16 Assistant: \u4f60\u597d\u5f20\u4e09\uff01\u5f88\u9ad8\u5174\u8ba4\u8bc6\u4f60\uff01\ud83d\udc4b \u6211\u4e86\u89e3\u5230\u4f60\u559c\u6b22 Go \u8bed\u8a00\u7f16\u7a0b\uff0c\u8fd9\u771f\u662f\u592a\u68d2\u4e86\uff01Go \u8bed\u8a00\u786e\u5b9e\u662f\u4e00\u95e8\u5f88\u4f18\u79c0\u7684\u7f16\u7a0b\u8bed\u8a00\uff0c\u4ee5\u5176\u7b80\u6d01\u3001\u9ad8\u6548\u548c\u5e76\u53d1\u7279\u6027\u800c\u95fb\u540d\u3002\n\n\u8ba9\u6211\u628a\u8fd9\u4e2a\u4fe1\u606f\u8bb0\u4e0b\u6765\uff0c\u8fd9\u6837\u6211\u5c31\u80fd\u66f4\u597d\u5730\u4e86\u89e3\u4f60\u7684\u5174\u8da3\u548c\u80cc\u666f\u4e86\u3002\n\ud83d\udd27 Memory tool calls initiated:\n   \u2022 memory_add (ID: call_00_FqOJ5GTRxaxWLVDxcfjhogIA)\n     Args: {\"memory\": \"\u5f20\u4e09\u559c\u6b22 Go \u8bed\u8a00\u7f16\u7a0b\", \"topics\": [\"programming\", \"go\", \"interests\", \"technology\"]}\n\n\ud83d\udd04 Executing memory tools...\n\u2705 Memory tool response (ID: call_00_FqOJ5GTRxaxWLVDxcfjhogIA): {\"message\":\"Memory added successfully\",\"memory\":\"\u5f20\u4e09\u559c\u6b22 Go \u8bed\u8a00\u7f16\u7a0b\",\"topics\":[\"programming\",\"go\",\"interests\",\"technology\"]}\n\u592a\u597d\u4e86\uff01\u6211\u5df2\u7ecf\u8bb0\u4f4f\u4e86\u4f60\u559c\u6b22 Go \u8bed\u8a00\u7f16\u7a0b\u3002\u4f5c\u4e3a\u4e00\u4e2a Go \u8bed\u8a00\u7231\u597d\u8005\uff0c\u4f60\u5e73\u65f6\u4e3b\u8981\u7528\u5b83\u505a\u4ec0\u4e48\u9879\u76ee\u5462\uff1f\u662f\u540e\u7aef\u5f00\u53d1\u3001\u7cfb\u7edf\u5de5\u5177\uff0c\u8fd8\u662f\u5176\u4ed6\u7c7b\u578b\u7684\u9879\u76ee\uff1f\u6211\u5f88\u60f3\u4e86\u89e3\u66f4\u591a\u5173\u4e8e\u4f60\u7684\u7f16\u7a0b\u7ecf\u5386\u548c\u5174\u8da3\uff01\n\n\ud83d\udc64 You: /new\n\ud83c\udd95 Started new memory session!\n   Previous: memory-session-1765504743\n   Current:  memory-session-1765504766\n   (Memory and conversation history have been reset)\n\n\ud83d\udc64 You:  \u6211\u559c\u6b22\u4ec0\u4e48?\n\ud83e\udd16 Assistant: \u6211\u6765\u67e5\u770b\u4e00\u4e0b\u8bb0\u5fc6\u4e2d\u5173\u4e8e\u60a8\u7684\u559c\u597d\u4fe1\u606f\u3002\n\ud83d\udd27 Memory tool calls initiated:\n   \u2022 memory_search (ID: call_00_BsjZNVCjxxMXOsWmMfXfLZ1z)\n     Args: {\"query\": \"\u559c\u6b22 \u7231\u597d \u5174\u8da3 \u504f\u597d\"}\n\n\ud83d\udd04 Executing memory tools...\n\u2705 Memory tool response (ID: call_00_BsjZNVCjxxMXOsWmMfXfLZ1z): {\"query\":\"\u559c\u6b22 \u7231\u597d \u5174\u8da3 \u504f\u597d\",\"results\":[{\"id\":\"a4b1d02cef09bd21ecc8b44832d1ed7f1b33014f9c3dfd11e72259bf14e900a9\",\"memory\":\"\u5f20\u4e09\u559c\u6b22 Go \u8bed\u8a00\u7f16\u7a0b\",\"topics\":[\"programming\",\"go\",\"interests\",\"technology\"],\"created\":\"2025-12-12T09:59:16.300377171+08:00\"}],\"count\":1}\n\u6839\u636e\u6211\u7684\u8bb0\u5fc6\uff0c\u60a8\u559c\u6b22 **Go \u8bed\u8a00\u7f16\u7a0b**\u3002\u8fd9\u662f\u76ee\u524d\u6211\u8bb0\u5f55\u7684\u552f\u4e00\u5173\u4e8e\u60a8\u559c\u597d\u7684\u4fe1\u606f\u3002\n\n\u5982\u679c\u60a8\u8fd8\u6709\u5176\u4ed6\u559c\u6b22\u7684\u4e8b\u7269\uff0c\u6bd4\u5982\uff1a\n- \u97f3\u4e50\u7c7b\u578b\n- \u7535\u5f71\u6216\u4e66\u7c4d\n- \u8fd0\u52a8\u6216\u6d3b\u52a8\n- \u98df\u7269\u6216\u996e\u6599\n- \u65c5\u884c\u76ee\u7684\u5730\n- \u5176\u4ed6\u5174\u8da3\u7231\u597d\n\n\u8bf7\u544a\u8bc9\u6211\uff0c\u6211\u53ef\u4ee5\u5e2e\u60a8\u8bb0\u4f4f\u8fd9\u4e9b\u4fe1\u606f\uff0c\u8fd9\u6837\u4e0b\u6b21\u60a8\u95ee\"\u6211\u559c\u6b22\u4ec0\u4e48\"\u65f6\uff0c\u6211\u5c31\u80fd\u7ed9\u60a8\u66f4\u5168\u9762\u7684\u56de\u7b54\u4e86\uff01\n\n\ud83d\udc64 You: /exit\n\ud83d\udc4b Goodbye!\n</code></pre>"},{"location":"zh/memory/#_24","title":"\u4ee3\u7801\u793a\u4f8b","text":"<p>\u5b8c\u6574\u4ee3\u7801\u8bf7\u53c2\u8003 examples/memory\uff0c\u6838\u5fc3\u5b9e\u73b0\uff1a</p> <pre><code>package main\n\nimport (\n    \"context\"\n    \"flag\"\n    \"fmt\"\n    \"log\"\n    \"os\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/agent/llmagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/memory\"\n    memoryinmemory \"trpc.group/trpc-go/trpc-agent-go/memory/inmemory\"\n    memoryredis \"trpc.group/trpc-go/trpc-agent-go/memory/redis\"\n    memorymysql \"trpc.group/trpc-go/trpc-agent-go/memory/mysql\"\n    memorypostgres \"trpc.group/trpc-go/trpc-agent-go/memory/postgres\"\n    \"trpc.group/trpc-go/trpc-agent-go/model\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/openai\"\n    \"trpc.group/trpc-go/trpc-agent-go/runner\"\n    \"trpc.group/trpc-go/trpc-agent-go/session/inmemory\"\n)\n\nfunc main() {\n    var (\n        memType    = flag.String(\"memory\", \"inmemory\", \"\u8bb0\u5fc6\u670d\u52a1\u7c7b\u578b\")\n        streaming  = flag.Bool(\"streaming\", true, \"\u662f\u5426\u542f\u7528\u6d41\u5f0f\u8f93\u51fa\")\n        softDelete = flag.Bool(\"soft-delete\", false, \"\u542f\u7528\u8f6f\u5220\u9664\")\n        modelName  = flag.String(\"model\", \"deepseek-chat\", \"\u6a21\u578b\u540d\u79f0\")\n    )\n    flag.Parse()\n\n    ctx := context.Background()\n\n    // 1. \u521b\u5efa\u8bb0\u5fc6\u670d\u52a1\n    memoryService, err := createMemoryService(*memType, *softDelete)\n    if err != nil {\n        log.Fatalf(\"Failed to create memory service: %v\", err)\n    }\n\n    // 2. \u521b\u5efa\u6a21\u578b\n    modelInstance := openai.New(*modelName)\n\n    // 3. \u521b\u5efa Agent\n    genConfig := model.GenerationConfig{\n        MaxTokens:   intPtr(2000),\n        Temperature: floatPtr(0.7),\n        Stream:      *streaming,\n    }\n\n    llmAgent := llmagent.New(\n        \"memory-assistant\",\n        llmagent.WithModel(modelInstance),\n        llmagent.WithDescription(\n            \"\u5177\u6709\u8bb0\u5fc6\u80fd\u529b\u7684\u667a\u80fd\u52a9\u624b\u3002\u6211\u53ef\u4ee5\u8bb0\u4f4f\u5173\u4e8e\u4f60\u7684\u91cd\u8981\u4fe1\u606f\uff0c\"+\n            \"\u5e76\u5728\u9700\u8981\u65f6\u56de\u5fc6\u8d77\u6765\u3002\",\n        ),\n        llmagent.WithGenerationConfig(genConfig),\n        llmagent.WithTools(memoryService.Tools()),\n    )\n\n    // 4. \u521b\u5efa Runner\n    sessionService := inmemory.NewSessionService()\n    appRunner := runner.NewRunner(\n        \"memory-chat\",\n        llmAgent,\n        runner.WithSessionService(sessionService),\n        runner.WithMemoryService(memoryService),\n    )\n    defer appRunner.Close()\n\n    // 5. \u8fd0\u884c\u5bf9\u8bdd\n    log.Println(\"\ud83e\udde0 \u5f00\u59cb\u8bb0\u5fc6\u5bf9\u8bdd...\")\n    // ... \u5904\u7406\u7528\u6237\u8f93\u5165\u548c\u54cd\u5e94\n}\n\nfunc createMemoryService(memType string, softDelete bool) (\n    memory.Service, error) {\n\n    switch memType {\n    case \"redis\":\n        redisAddr := os.Getenv(\"REDIS_ADDR\")\n        if redisAddr == \"\" {\n            redisAddr = \"localhost:6379\"\n        }\n        return memoryredis.NewService(\n            memoryredis.WithRedisClientURL(\n                fmt.Sprintf(\"redis://%s\", redisAddr),\n            ),\n            memoryredis.WithToolEnabled(memory.DeleteToolName, false),\n        )\n\n    case \"mysql\":\n        dsn := buildMySQLDSN()\n        return memorymysql.NewService(\n            memorymysql.WithMySQLClientDSN(dsn),\n            memorymysql.WithSoftDelete(softDelete),\n            memorymysql.WithToolEnabled(memory.DeleteToolName, false),\n        )\n\n    case \"postgres\":\n        return memorypostgres.NewService(\n            memorypostgres.WithHost(getEnv(\"PG_HOST\", \"localhost\")),\n            memorypostgres.WithPort(getEnvInt(\"PG_PORT\", 5432)),\n            memorypostgres.WithUser(getEnv(\"PG_USER\", \"postgres\")),\n            memorypostgres.WithPassword(getEnv(\"PG_PASSWORD\", \"\")),\n            memorypostgres.WithDatabase(getEnv(\"PG_DATABASE\", \"postgres\")),\n            memorypostgres.WithSoftDelete(softDelete),\n            memorypostgres.WithToolEnabled(memory.DeleteToolName, false),\n        )\n\n    default: // inmemory\n        return memoryinmemory.NewMemoryService(\n            memoryinmemory.WithToolEnabled(memory.DeleteToolName, false),\n        ), nil\n    }\n}\n\nfunc buildMySQLDSN() string {\n    host := getEnv(\"MYSQL_HOST\", \"localhost\")\n    port := getEnv(\"MYSQL_PORT\", \"3306\")\n    user := getEnv(\"MYSQL_USER\", \"root\")\n    password := getEnv(\"MYSQL_PASSWORD\", \"\")\n    database := getEnv(\"MYSQL_DATABASE\", \"trpc_agent_go\")\n\n    return fmt.Sprintf(\n        \"%s:%s@tcp(%s:%s)/%s?parseTime=true&amp;charset=utf8mb4\",\n        user, password, host, port, database,\n    )\n}\n\nfunc getEnv(key, defaultVal string) string {\n    if val := os.Getenv(key); val != \"\" {\n        return val\n    }\n    return defaultVal\n}\n\nfunc intPtr(i int) *int             { return &amp;i }\nfunc floatPtr(f float64) *float64   { return &amp;f }\n</code></pre>"},{"location":"zh/memory/#_25","title":"\u5b58\u50a8\u540e\u7aef","text":""},{"location":"zh/memory/#inmemory","title":"\u5185\u5b58\u5b58\u50a8\uff08InMemory\uff09","text":"<p>\u9002\u7528\u573a\u666f\uff1a\u5f00\u53d1\u3001\u6d4b\u8bd5\u3001\u5feb\u901f\u539f\u578b</p> <pre><code>import memoryinmemory \"trpc.group/trpc-go/trpc-agent-go/memory/inmemory\"\n\nmemoryService := memoryinmemory.NewMemoryService()\n</code></pre> <p>\u914d\u7f6e\u9009\u9879\uff1a - <code>WithMemoryLimit(limit int)</code>: \u8bbe\u7f6e\u6bcf\u7528\u6237\u8bb0\u5fc6\u6570\u91cf\u4e0a\u9650 - <code>WithCustomTool(toolName, creator)</code>: \u6ce8\u518c\u81ea\u5b9a\u4e49\u5de5\u5177\u5b9e\u73b0 - <code>WithToolEnabled(toolName, enabled)</code>: \u542f\u7528/\u7981\u7528\u7279\u5b9a\u5de5\u5177</p> <p>\u7279\u70b9\uff1a\u96f6\u914d\u7f6e\uff0c\u9ad8\u6027\u80fd\uff0c\u65e0\u6301\u4e45\u5316</p>"},{"location":"zh/memory/#redis","title":"Redis \u5b58\u50a8","text":"<p>\u9002\u7528\u573a\u666f\uff1a\u751f\u4ea7\u73af\u5883\u3001\u9ad8\u5e76\u53d1\u3001\u5206\u5e03\u5f0f\u90e8\u7f72</p> <pre><code>import memoryredis \"trpc.group/trpc-go/trpc-agent-go/memory/redis\"\n\nredisService, err := memoryredis.NewService(\n    memoryredis.WithRedisClientURL(\"redis://localhost:6379\"),\n)\n</code></pre> <p>\u914d\u7f6e\u9009\u9879\uff1a - <code>WithRedisClientURL(url)</code>: Redis \u8fde\u63a5 URL\uff08\u63a8\u8350\uff09 - <code>WithRedisInstance(name)</code>: \u4f7f\u7528\u9884\u6ce8\u518c\u7684 Redis \u5b9e\u4f8b - <code>WithMemoryLimit(limit)</code>: \u6bcf\u7528\u6237\u8bb0\u5fc6\u4e0a\u9650 - <code>WithCustomTool(toolName, creator)</code>: \u6ce8\u518c\u81ea\u5b9a\u4e49\u5de5\u5177 - <code>WithToolEnabled(toolName, enabled)</code>: \u542f\u7528/\u7981\u7528\u5de5\u5177 - <code>WithExtraOptions(...options)</code>: \u4f20\u9012\u7ed9 Redis \u5ba2\u6237\u7aef\u7684\u989d\u5916\u9009\u9879</p> <p>\u6ce8\u610f\uff1a<code>WithRedisClientURL</code> \u4f18\u5148\u7ea7\u9ad8\u4e8e <code>WithRedisInstance</code></p>"},{"location":"zh/memory/#mysql","title":"MySQL \u5b58\u50a8","text":"<p>\u9002\u7528\u573a\u666f\uff1a\u751f\u4ea7\u73af\u5883\u3001\u9700\u8981 ACID \u4fdd\u8bc1\u3001\u590d\u6742\u67e5\u8be2</p> <pre><code>import memorymysql \"trpc.group/trpc-go/trpc-agent-go/memory/mysql\"\n\ndsn := \"user:password@tcp(localhost:3306)/dbname?parseTime=true\"\nmysqlService, err := memorymysql.NewService(\n    memorymysql.WithMySQLClientDSN(dsn),\n    memorymysql.WithSoftDelete(true),\n)\n</code></pre> <p>\u914d\u7f6e\u9009\u9879\uff1a - <code>WithMySQLClientDSN(dsn)</code>: MySQL DSN \u8fde\u63a5\u5b57\u7b26\u4e32\uff08\u63a8\u8350\uff0c\u5fc5\u9700 <code>parseTime=true</code>\uff09 - <code>WithMySQLInstance(name)</code>: \u4f7f\u7528\u9884\u6ce8\u518c\u7684 MySQL \u5b9e\u4f8b - <code>WithSoftDelete(enabled)</code>: \u542f\u7528\u8f6f\u5220\u9664\uff08\u9ed8\u8ba4 false\uff09 - <code>WithTableName(name)</code>: \u81ea\u5b9a\u4e49\u8868\u540d\uff08\u9ed8\u8ba4 \"memories\"\uff09 - <code>WithMemoryLimit(limit)</code>: \u6bcf\u7528\u6237\u8bb0\u5fc6\u4e0a\u9650 - <code>WithCustomTool(toolName, creator)</code>: \u6ce8\u518c\u81ea\u5b9a\u4e49\u5de5\u5177 - <code>WithToolEnabled(toolName, enabled)</code>: \u542f\u7528/\u7981\u7528\u5de5\u5177 - <code>WithExtraOptions(...options)</code>: \u4f20\u9012\u7ed9 MySQL \u5ba2\u6237\u7aef\u7684\u989d\u5916\u9009\u9879 - <code>WithSkipDBInit(skip)</code>: \u8df3\u8fc7\u8868\u521d\u59cb\u5316\uff08\u9002\u7528\u4e8e\u65e0 DDL \u6743\u9650\u573a\u666f\uff09</p> <p>DSN \u793a\u4f8b\uff1a <pre><code>root:password@tcp(localhost:3306)/memory_db?parseTime=true&amp;charset=utf8mb4\n</code></pre></p> <p>\u8868\u7ed3\u6784\uff08\u81ea\u52a8\u521b\u5efa\uff09\uff1a <pre><code>CREATE TABLE memories (\n    id BIGINT AUTO_INCREMENT PRIMARY KEY,\n    app_name VARCHAR(255) NOT NULL,\n    user_id VARCHAR(255) NOT NULL,\n    memory_id VARCHAR(64) NOT NULL,\n    memory_data JSON NOT NULL,\n    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n    deleted_at TIMESTAMP NULL,\n    UNIQUE INDEX (app_name, user_id, memory_id)\n)\n</code></pre></p> <p>\u8d44\u6e90\u6e05\u7406\uff1a\u4f7f\u7528\u5b8c\u6bd5\u540e\u9700\u8c03\u7528 <code>Close()</code> \u65b9\u6cd5\u91ca\u653e\u6570\u636e\u5e93\u8fde\u63a5\uff1a <pre><code>defer mysqlService.Close()\n</code></pre></p>"},{"location":"zh/memory/#postgresql","title":"PostgreSQL \u5b58\u50a8","text":"<p>\u9002\u7528\u573a\u666f\uff1a\u751f\u4ea7\u73af\u5883\u3001\u9700\u8981 JSONB \u9ad8\u7ea7\u7279\u6027</p> <pre><code>import memorypostgres \"trpc.group/trpc-go/trpc-agent-go/memory/postgres\"\n\npostgresService, err := memorypostgres.NewService(\n    memorypostgres.WithHost(\"localhost\"),\n    memorypostgres.WithPort(5432),\n    memorypostgres.WithUser(\"postgres\"),\n    memorypostgres.WithPassword(\"password\"),\n    memorypostgres.WithDatabase(\"dbname\"),\n    memorypostgres.WithSoftDelete(true),\n)\n</code></pre> <p>\u914d\u7f6e\u9009\u9879\uff1a - <code>WithHost/WithPort/WithUser/WithPassword/WithDatabase</code>: \u8fde\u63a5\u53c2\u6570 - <code>WithSSLMode(mode)</code>: SSL \u6a21\u5f0f\uff08\u9ed8\u8ba4 \"disable\"\uff09 - <code>WithPostgresInstance(name)</code>: \u4f7f\u7528\u9884\u6ce8\u518c\u7684 PostgreSQL \u5b9e\u4f8b - <code>WithSoftDelete(enabled)</code>: \u542f\u7528\u8f6f\u5220\u9664\uff08\u9ed8\u8ba4 false\uff09 - <code>WithTableName(name)</code>: \u81ea\u5b9a\u4e49\u8868\u540d\uff08\u9ed8\u8ba4 \"memories\"\uff09 - <code>WithSchema(schema)</code>: \u6307\u5b9a\u6570\u636e\u5e93 schema\uff08\u9ed8\u8ba4\u4e3a public\uff09 - <code>WithMemoryLimit(limit)</code>: \u6bcf\u7528\u6237\u8bb0\u5fc6\u4e0a\u9650 - <code>WithCustomTool(toolName, creator)</code>: \u6ce8\u518c\u81ea\u5b9a\u4e49\u5de5\u5177 - <code>WithToolEnabled(toolName, enabled)</code>: \u542f\u7528/\u7981\u7528\u5de5\u5177 - <code>WithExtraOptions(...options)</code>: \u4f20\u9012\u7ed9 PostgreSQL \u5ba2\u6237\u7aef\u7684\u989d\u5916\u9009\u9879 - <code>WithSkipDBInit(skip)</code>: \u8df3\u8fc7\u8868\u521d\u59cb\u5316\uff08\u9002\u7528\u4e8e\u65e0 DDL \u6743\u9650\u573a\u666f\uff09</p> <p>\u6ce8\u610f\uff1a\u76f4\u63a5\u8fde\u63a5\u53c2\u6570\u4f18\u5148\u7ea7\u9ad8\u4e8e <code>WithPostgresInstance</code></p> <p>\u8868\u7ed3\u6784\uff08\u81ea\u52a8\u521b\u5efa\uff09\uff1a <pre><code>CREATE TABLE memories (\n    id BIGSERIAL PRIMARY KEY,\n    app_name VARCHAR(255) NOT NULL,\n    user_id VARCHAR(255) NOT NULL,\n    memory_id VARCHAR(64) NOT NULL,\n    memory_data JSONB NOT NULL,\n    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n    deleted_at TIMESTAMP NULL,\n    UNIQUE (app_name, user_id, memory_id)\n)\n</code></pre></p> <p>\u8d44\u6e90\u6e05\u7406\uff1a\u4f7f\u7528\u5b8c\u6bd5\u540e\u9700\u8c03\u7528 <code>Close()</code> \u65b9\u6cd5\u91ca\u653e\u6570\u636e\u5e93\u8fde\u63a5\uff1a <pre><code>defer postgresService.Close()\n</code></pre></p>"},{"location":"zh/memory/#_26","title":"\u540e\u7aef\u5bf9\u6bd4\u4e0e\u9009\u62e9","text":"\u7279\u6027 InMemory Redis MySQL PostgreSQL \u6301\u4e45\u5316 \u274c \u2705 \u2705 \u2705 \u5206\u5e03\u5f0f \u274c \u2705 \u2705 \u2705 \u4e8b\u52a1 \u274c \u90e8\u5206 \u2705 ACID \u2705 ACID \u67e5\u8be2 \u7b80\u5355 \u4e2d\u7b49 SQL SQL JSON \u274c \u57fa\u7840 JSON JSONB \u6027\u80fd \u6781\u9ad8 \u9ad8 \u4e2d\u9ad8 \u4e2d\u9ad8 \u914d\u7f6e \u96f6\u914d\u7f6e \u7b80\u5355 \u4e2d\u7b49 \u4e2d\u7b49 \u8f6f\u5220\u9664 \u274c \u274c \u2705 \u2705 \u9002\u7528\u573a\u666f \u5f00\u53d1\u6d4b\u8bd5 \u9ad8\u5e76\u53d1 \u4f01\u4e1a\u5e94\u7528 \u9ad8\u7ea7\u7279\u6027 <p>\u9009\u62e9\u5efa\u8bae\uff1a</p> <pre><code>\u5f00\u53d1/\u6d4b\u8bd5 \u2192 InMemory\uff08\u96f6\u914d\u7f6e\uff0c\u5feb\u901f\u542f\u52a8\uff09\n\u9ad8\u5e76\u53d1\u8bfb\u5199 \u2192 Redis\uff08\u5185\u5b58\u7ea7\u6027\u80fd\uff09\n\u9700\u8981 ACID \u2192 MySQL/PostgreSQL\uff08\u4e8b\u52a1\u4fdd\u8bc1\uff09\n\u590d\u6742 JSON \u2192 PostgreSQL\uff08JSONB \u7d22\u5f15\u548c\u67e5\u8be2\uff09\n\u5ba1\u8ba1\u8ffd\u8e2a \u2192 MySQL/PostgreSQL\uff08\u8f6f\u5220\u9664\u652f\u6301\uff09\n</code></pre>"},{"location":"zh/memory/#_27","title":"\u5e38\u89c1\u95ee\u9898","text":""},{"location":"zh/memory/#memory-session","title":"Memory \u4e0e Session \u7684\u533a\u522b","text":"<p>\u8fd9\u662f\u6700\u5e38\u89c1\u7684\u7591\u95ee\u3002Memory \u548c Session \u89e3\u51b3\u4e0d\u540c\u7684\u95ee\u9898\uff1a</p> \u7ef4\u5ea6 Memory\uff08\u8bb0\u5fc6\uff09 Session\uff08\u4f1a\u8bdd\uff09 \u5b9a\u4f4d \u957f\u671f\u7528\u6237\u6863\u6848 \u4e34\u65f6\u5bf9\u8bdd\u4e0a\u4e0b\u6587 \u9694\u79bb\u7ef4\u5ea6 <code>&lt;appName, userID&gt;</code> <code>&lt;appName, userID, sessionID&gt;</code> \u751f\u547d\u5468\u671f \u8de8\u4f1a\u8bdd\u6301\u4e45\u5316 \u5355\u6b21\u4f1a\u8bdd\u5185\u6709\u6548 \u5b58\u50a8\u5185\u5bb9 \u7528\u6237\u753b\u50cf\u3001\u504f\u597d\u3001\u4e8b\u5b9e \u5bf9\u8bdd\u5386\u53f2\u3001\u6d88\u606f\u8bb0\u5f55 \u6570\u636e\u91cf \u5c0f\uff08\u51e0\u5341\u5230\u51e0\u767e\u6761\uff09 \u5927\uff08\u51e0\u5341\u5230\u51e0\u5343\u6761\u6d88\u606f\uff09 \u4f7f\u7528\u573a\u666f \u201c\u8bb0\u4f4f\u7528\u6237\u662f\u8c01\u201d \u201c\u8bb0\u4f4f\u8bf4\u4e86\u4ec0\u4e48\u201d <p>\u793a\u4f8b\uff1a</p> <pre><code>// Memory\uff1a\u8de8\u4f1a\u8bdd\u4fdd\u7559\nmemory.AddMemory(ctx, userKey, \"\u7528\u6237\u662f\u540e\u7aef\u5de5\u7a0b\u5e08\", []string{\"\u804c\u4e1a\"})\n\n// Session\uff1a\u5355\u6b21\u4f1a\u8bdd\u6709\u6548\nsession.AddMessage(ctx, sessionKey, userMessage(\"\u4eca\u5929\u5929\u6c14\u600e\u4e48\u6837\uff1f\"))\nsession.AddMessage(ctx, sessionKey, agentMessage(\"\u4eca\u5929\u6674\u5929\"))\n\n// \u65b0\u4f1a\u8bdd\uff1aMemory \u4fdd\u7559\uff0cSession \u91cd\u7f6e\n</code></pre>"},{"location":"zh/memory/#memory-id","title":"Memory ID \u7684\u5e42\u7b49\u6027","text":"<p>Memory ID \u57fa\u4e8e\u300c\u5185\u5bb9 + \u4e3b\u9898\u300d\u7684 SHA256 \u54c8\u5e0c\u751f\u6210\uff0c\u76f8\u540c\u5185\u5bb9\u4f1a\u4ea7\u751f\u76f8\u540c ID\uff1a</p> <pre><code>// \u7b2c\u4e00\u6b21\u6dfb\u52a0\nmemory.AddMemory(ctx, userKey, \"\u7528\u6237\u559c\u6b22\u7f16\u7a0b\", []string{\"\u7231\u597d\"})\n// \u751f\u6210 ID\uff1aabc123...\n\n// \u7b2c\u4e8c\u6b21\u6dfb\u52a0\u76f8\u540c\u5185\u5bb9\nmemory.AddMemory(ctx, userKey, \"\u7528\u6237\u559c\u6b22\u7f16\u7a0b\", []string{\"\u7231\u597d\"})\n// \u751f\u6210\u76f8\u540c ID\uff1aabc123...\uff0c\u8986\u76d6\u66f4\u65b0\uff0c\u5237\u65b0 updated_at\n</code></pre> <p>\u5f71\u54cd\uff1a - \u2705 \u5929\u7136\u53bb\u91cd\uff1a\u907f\u514d\u5197\u4f59\u5b58\u50a8 - \u2705 \u5e42\u7b49\u64cd\u4f5c\uff1a\u91cd\u590d\u6dfb\u52a0\u4e0d\u4f1a\u521b\u5efa\u591a\u6761\u8bb0\u5f55 - \u26a0\ufe0f \u8986\u76d6\u66f4\u65b0\uff1a\u65e0\u6cd5\u8ffd\u52a0\u76f8\u540c\u5185\u5bb9\uff08\u5982\u9700\u8ffd\u52a0\uff0c\u53ef\u5728\u5185\u5bb9\u4e2d\u52a0\u65f6\u95f4\u6233\u6216\u5e8f\u53f7\uff09</p>"},{"location":"zh/memory/#_28","title":"\u641c\u7d22\u529f\u80fd\u7684\u5c40\u9650\u6027","text":"<p>Memory \u4f7f\u7528Token \u5339\u914d\uff0c\u4e0d\u662f\u8bed\u4e49\u641c\u7d22\uff1a</p> <p>\u82f1\u6587\u5206\u8bcd\uff1a\u8f6c\u5c0f\u5199 \u2192 \u8fc7\u6ee4\u505c\u7528\u8bcd\uff08a\u3001the\u3001is \u7b49\uff09\u2192 \u7a7a\u683c\u5206\u5272</p> <pre><code>// \u53ef\u4ee5\u627e\u5230\n\u8bb0\u5fc6\uff1a\"User likes programming\"\n\u641c\u7d22\uff1a\"programming\" \u2705 \u5339\u914d\n\n// \u627e\u4e0d\u5230\n\u8bb0\u5fc6\uff1a\"User likes programming\"\n\u641c\u7d22\uff1a\"coding\" \u274c \u4e0d\u5339\u914d\uff08\u8bed\u4e49\u76f8\u8fd1\u4f46\u8bcd\u4e0d\u540c\uff09\n</code></pre> <p>\u4e2d\u6587\u5206\u8bcd\uff1a\u4f7f\u7528\u53cc\u5b57\u7ec4\uff08bigram\uff09</p> <pre><code>\u8bb0\u5fc6\uff1a\"\u7528\u6237\u559c\u6b22\u7f16\u7a0b\"\n\u641c\u7d22\uff1a\"\u7f16\u7a0b\" \u2705 \u5339\u914d\uff08\"\u7f16\u7a0b\"\u5728\u53cc\u5b57\u7ec4\u4e2d\uff09\n\u641c\u7d22\uff1a\"\u5199\u4ee3\u7801\" \u274c \u4e0d\u5339\u914d\uff08\u8bcd\u4e0d\u540c\uff09\n</code></pre> <p>\u9650\u5236\uff1a - \u6240\u6709\u540e\u7aef\u5747\u5728\u5e94\u7528\u5c42\u8fc7\u6ee4\u548c\u6392\u5e8f\uff08O(n) \u590d\u6742\u5ea6\uff09 - \u6570\u636e\u91cf\u5927\u65f6\u6027\u80fd\u53d7\u5f71\u54cd - \u4e0d\u652f\u6301\u8bed\u4e49\u76f8\u4f3c\u5ea6\u641c\u7d22</p> <p>\u5efa\u8bae\uff1a - \u4f7f\u7528\u660e\u786e\u5173\u952e\u8bcd\u548c\u4e3b\u9898\u6807\u7b7e\u63d0\u9ad8\u547d\u4e2d\u7387 - \u5982\u9700\u8bed\u4e49\u641c\u7d22\uff0c\u8003\u8651\u96c6\u6210\u5411\u91cf\u6570\u636e\u5e93\uff08\u9700\u81ea\u5b9a\u4e49\u5b9e\u73b0\uff09</p>"},{"location":"zh/memory/#_29","title":"\u8f6f\u5220\u9664\u7684\u6ce8\u610f\u4e8b\u9879","text":"<p>\u652f\u6301\u60c5\u51b5\uff1a - \u2705 MySQL\u3001PostgreSQL\uff1a\u652f\u6301\u8f6f\u5220\u9664 - \u274c InMemory\u3001Redis\uff1a\u4e0d\u652f\u6301\uff08\u53ea\u6709\u786c\u5220\u9664\uff09</p> <p>\u8f6f\u5220\u9664\u914d\u7f6e\uff1a</p> <pre><code>mysqlService, err := memorymysql.NewService(\n    memorymysql.WithMySQLClientDSN(\"...\"),\n    memorymysql.WithSoftDelete(true), // \u542f\u7528\u8f6f\u5220\u9664\n)\n</code></pre> <p>\u884c\u4e3a\u5dee\u5f02\uff1a</p> \u64cd\u4f5c \u786c\u5220\u9664 \u8f6f\u5220\u9664 \u5220\u9664 \u7acb\u5373\u79fb\u9664 \u8bbe\u7f6e <code>deleted_at</code> \u5b57\u6bb5 \u67e5\u8be2 \u4e0d\u53ef\u89c1 \u81ea\u52a8\u8fc7\u6ee4\uff08WHERE deleted_at IS NULL\uff09 \u6062\u590d \u65e0\u6cd5\u6062\u590d \u53ef\u624b\u52a8\u6e05\u9664 <code>deleted_at</code> \u5b58\u50a8 \u8282\u7701\u7a7a\u95f4 \u5360\u7528\u7a7a\u95f4 <p>\u8fc1\u79fb\u9677\u9631\uff1a <pre><code>// \u26a0\ufe0f \u4ece\u652f\u6301\u8f6f\u5220\u9664\u7684\u540e\u7aef\u8fc1\u79fb\u5230\u4e0d\u652f\u6301\u7684\u540e\u7aef\n// \u8f6f\u5220\u9664\u7684\u8bb0\u5f55\u4f1a\u4e22\u5931\uff01\n\n// \u4ece MySQL\uff08\u8f6f\u5220\u9664\uff09\u8fc1\u79fb\u5230 Redis\uff08\u786c\u5220\u9664\uff09\n// \u9700\u8981\u624b\u52a8\u5904\u7406\u8f6f\u5220\u9664\u8bb0\u5f55\n</code></pre></p>"},{"location":"zh/memory/#_30","title":"\u6700\u4f73\u5b9e\u8df5","text":""},{"location":"zh/memory/#_31","title":"\u751f\u4ea7\u73af\u5883\u914d\u7f6e","text":"<pre><code>// \u2705 \u63a8\u8350\u914d\u7f6e\npostgresService, err := memorypostgres.NewService(\n    // \u4f7f\u7528\u73af\u5883\u53d8\u91cf\u7ba1\u7406\u654f\u611f\u4fe1\u606f\n    memorypostgres.WithHost(os.Getenv(\"DB_HOST\")),\n    memorypostgres.WithUser(os.Getenv(\"DB_USER\")),\n    memorypostgres.WithPassword(os.Getenv(\"DB_PASSWORD\")),\n    memorypostgres.WithDatabase(os.Getenv(\"DB_NAME\")),\n\n    // \u542f\u7528\u8f6f\u5220\u9664\uff08\u4fbf\u4e8e\u6062\u590d\uff09\n    memorypostgres.WithSoftDelete(true),\n\n    // \u5408\u7406\u9650\u5236\n    memorypostgres.WithMemoryLimit(1000),\n)\n</code></pre>"},{"location":"zh/memory/#_32","title":"\u9519\u8bef\u5904\u7406","text":"<pre><code>// \u2705 \u5b8c\u6574\u9519\u8bef\u5904\u7406\nerr := memoryService.AddMemory(ctx, userKey, content, topics)\nif err != nil {\n    if strings.Contains(err.Error(), \"limit exceeded\") {\n        // \u8d85\u9650\uff1a\u6e05\u7406\u65e7\u8bb0\u5fc6\u6216\u62d2\u7edd\u6dfb\u52a0\n        log.Warnf(\"Memory limit exceeded for user %s\", userKey.UserID)\n    } else {\n        return fmt.Errorf(\"failed to add memory: %w\", err)\n    }\n}\n</code></pre>"},{"location":"zh/memory/#_33","title":"\u5de5\u5177\u542f\u7528\u7b56\u7565","text":"<pre><code>// \u573a\u666f 1\uff1a\u53ea\u8bfb\u52a9\u624b\nreadOnlyService := memoryinmemory.NewMemoryService(\n    memoryinmemory.WithToolEnabled(memory.LoadToolName, true),\n    memoryinmemory.WithToolEnabled(memory.SearchToolName, true),\n    memoryinmemory.WithToolEnabled(memory.AddToolName, false),\n    memoryinmemory.WithToolEnabled(memory.UpdateToolName, false),\n)\n\n// \u573a\u666f 2\uff1a\u666e\u901a\u7528\u6237\nuserService := memoryinmemory.NewMemoryService(\n    memoryinmemory.WithToolEnabled(memory.DeleteToolName, true),\n    // clear \u7981\u7528\uff08\u9632\u6b62\u8bef\u5220\u6240\u6709\u8bb0\u5fc6\uff09\n)\n\n// \u573a\u666f 3\uff1a\u7ba1\u7406\u5458\nadminService := memoryinmemory.NewMemoryService(\n    memoryinmemory.WithToolEnabled(memory.DeleteToolName, true),\n    memoryinmemory.WithToolEnabled(memory.ClearToolName, true),\n)\n</code></pre>"},{"location":"zh/memory/#_34","title":"\u53c2\u8003\u94fe\u63a5","text":"<ul> <li>Memory \u6a21\u5757\u6e90\u7801</li> <li>\u5b8c\u6574\u793a\u4f8b\u4ee3\u7801</li> <li>API \u6587\u6863</li> </ul>"},{"location":"zh/model/","title":"Model \u6a21\u5757","text":""},{"location":"zh/model/#_1","title":"\u6982\u8ff0","text":"<p>Model \u6a21\u5757\u662f tRPC-Agent-Go \u6846\u67b6\u7684\u5927\u8bed\u8a00\u6a21\u578b\u62bd\u8c61\u5c42\uff0c\u63d0\u4f9b\u4e86\u7edf\u4e00\u7684 LLM \u63a5\u53e3\u8bbe\u8ba1\uff0c\u76ee\u524d\u652f\u6301 OpenAI \u548c Anthropic \u517c\u5bb9\u7684 API \u8c03\u7528\u3002\u901a\u8fc7\u6807\u51c6\u5316\u7684\u63a5\u53e3\u8bbe\u8ba1\uff0c\u5f00\u53d1\u8005\u53ef\u4ee5\u7075\u6d3b\u5207\u6362\u4e0d\u540c\u7684\u6a21\u578b\u63d0\u4f9b\u5546\uff0c\u5b9e\u73b0\u6a21\u578b\u7684\u65e0\u7f1d\u96c6\u6210\u548c\u8c03\u7528\u3002\u8be5\u6a21\u5757\u5df2\u9a8c\u8bc1\u517c\u5bb9\u516c\u53f8\u5185\u5916\u5927\u591a\u6570 OpenAI-like \u63a5\u53e3\u3002</p> <p>Model \u6a21\u5757\u5177\u6709\u4ee5\u4e0b\u6838\u5fc3\u7279\u6027\uff1a</p> <ul> <li>\u7edf\u4e00\u63a5\u53e3\u62bd\u8c61\uff1a\u63d0\u4f9b\u6807\u51c6\u5316\u7684 <code>Model</code> \u63a5\u53e3\uff0c\u5c4f\u853d\u4e0d\u540c\u6a21\u578b\u63d0\u4f9b\u5546\u7684\u5dee\u5f02</li> <li>\u6d41\u5f0f\u54cd\u5e94\u652f\u6301\uff1a\u539f\u751f\u652f\u6301\u6d41\u5f0f\u8f93\u51fa\uff0c\u5b9e\u73b0\u5b9e\u65f6\u4ea4\u4e92\u4f53\u9a8c</li> <li>\u591a\u6a21\u6001\u80fd\u529b\uff1a\u652f\u6301\u6587\u672c\u3001\u56fe\u50cf\u3001\u97f3\u9891\u7b49\u591a\u6a21\u6001\u5185\u5bb9\u5904\u7406</li> <li>\u5b8c\u6574\u9519\u8bef\u5904\u7406\uff1a\u63d0\u4f9b\u53cc\u5c42\u9519\u8bef\u5904\u7406\u673a\u5236\uff0c\u533a\u5206\u7cfb\u7edf\u9519\u8bef\u548c API \u9519\u8bef</li> <li>\u53ef\u6269\u5c55\u914d\u7f6e\uff1a\u652f\u6301\u4e30\u5bcc\u7684\u81ea\u5b9a\u4e49\u914d\u7f6e\u9879\uff0c\u6ee1\u8db3\u4e0d\u540c\u573a\u666f\u9700\u6c42</li> </ul>"},{"location":"zh/model/#_2","title":"\u5feb\u901f\u5f00\u59cb","text":""},{"location":"zh/model/#agent-model","title":"\u5728 Agent \u4e2d\u4f7f\u7528 Model","text":"<pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/agent/llmagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/model\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/openai\"\n    \"trpc.group/trpc-go/trpc-agent-go/runner\"\n    \"trpc.group/trpc-go/trpc-agent-go/tool\"\n)\n\nfunc main() {\n    // 1. \u521b\u5efa\u6a21\u578b\u5b9e\u4f8b\n    modelInstance := openai.New(\"deepseek-chat\",\n        openai.WithExtraFields(map[string]interface{}{\n            \"tool_choice\": \"auto\", // \u81ea\u52a8\u9009\u62e9\u5de5\u5177\n        }),\n    )\n\n    // 2. \u914d\u7f6e\u751f\u6210\u53c2\u6570\n    genConfig := model.GenerationConfig{\n        MaxTokens:   intPtr(2000),\n        Temperature: floatPtr(0.7),\n        Stream:      true, // \u542f\u7528\u6d41\u5f0f\u8f93\u51fa\n    }\n\n    // 3. \u521b\u5efa Agent \u5e76\u96c6\u6210\u6a21\u578b\n    agent := llmagent.New(\n        \"chat-assistant\",\n        llmagent.WithModel(modelInstance),\n        llmagent.WithDescription(\"\u4e00\u4e2a\u6709\u7528\u7684\u52a9\u624b\"),\n        llmagent.WithInstruction(\"\u4f60\u662f\u4e00\u4e2a\u667a\u80fd\u52a9\u624b\uff0c\u5728\u9700\u8981\u65f6\u4f7f\u7528\u5de5\u5177\u3002\"),\n        llmagent.WithGenerationConfig(genConfig),\n        llmagent.WithTools([]tool.Tool{calculatorTool, timeTool}),\n    )\n\n    // 4. \u521b\u5efa Runner \u5e76\u8fd0\u884c\n    r := runner.NewRunner(\"app-name\", agent)\n    eventChan, err := r.Run(ctx, userID, sessionID, model.NewUserMessage(\"Hello\"))\n    if err != nil {\n        log.Fatal(err)\n    }\n\n    // 5. \u5904\u7406\u54cd\u5e94\u4e8b\u4ef6\n    for event := range eventChan {\n        // \u5904\u7406\u6d41\u5f0f\u54cd\u5e94\u3001\u5de5\u5177\u8c03\u7528\u7b49\n    }\n}\n</code></pre> <p>\u793a\u4f8b\u4ee3\u7801\u4f4d\u4e8e examples/runner</p>"},{"location":"zh/model/#_3","title":"\u4f7f\u7528\u65b9\u5f0f\u4e0e\u5e73\u53f0\u63a5\u5165\u6307\u5357","text":"<p>Model \u6a21\u5757\u652f\u6301\u591a\u79cd\u4f7f\u7528\u65b9\u5f0f\u548c\u5e73\u53f0\u63a5\u5165\u3002\u4ee5\u4e0b\u662f\u57fa\u4e8e Runner \u793a\u4f8b\u7684\u5e38\u89c1\u4f7f\u7528\u573a\u666f\uff1a</p>"},{"location":"zh/model/#_4","title":"\u5feb\u901f\u542f\u52a8","text":"<pre><code># \u57fa\u7840\u4f7f\u7528\uff1a\u901a\u8fc7\u73af\u5883\u53d8\u91cf\u914d\u7f6e\uff0c\u76f4\u63a5\u8fd0\u884c\ncd examples/runner\nexport OPENAI_BASE_URL=\"https://api.deepseek.com/v1\"\nexport OPENAI_API_KEY=\"your-api-key\"\ngo run main.go -model deepseek-chat\n</code></pre>"},{"location":"zh/model/#_5","title":"\u5e73\u53f0\u63a5\u5165\u914d\u7f6e","text":"<p>\u6240\u6709\u5e73\u53f0\u7684\u63a5\u5165\u65b9\u5f0f\u90fd\u9075\u5faa\u76f8\u540c\u6a21\u5f0f\uff0c\u53ea\u9700\u914d\u7f6e\u4e0d\u540c\u7684\u73af\u5883\u53d8\u91cf\u6216\u76f4\u63a5\u5728\u4ee3\u7801\u4e2d\u8bbe\u7f6e\uff1a</p> <p>\u73af\u5883\u53d8\u91cf\u65b9\u5f0f\uff08\u63a8\u8350\uff09\uff1a</p> <pre><code>export OPENAI_BASE_URL=\"\u5e73\u53f0API\u5730\u5740\"\nexport OPENAI_API_KEY=\"API\u5bc6\u94a5\"\n</code></pre> <p>\u4ee3\u7801\u65b9\u5f0f\uff1a</p> <pre><code>model := openai.New(\"\u6a21\u578b\u540d\u79f0\",\n    openai.WithBaseURL(\"\u5e73\u53f0API\u5730\u5740\"),\n    openai.WithAPIKey(\"API\u5bc6\u94a5\"),\n)\n</code></pre>"},{"location":"zh/model/#_6","title":"\u652f\u6301\u7684\u5e73\u53f0\u53ca\u5176\u914d\u7f6e","text":"<p>\u4ee5\u4e0b\u662f\u5404\u5e73\u53f0\u7684\u914d\u7f6e\u793a\u4f8b\uff0c\u5206\u4e3a\u73af\u5883\u53d8\u91cf\u914d\u7f6e\u548c\u4ee3\u7801\u914d\u7f6e\u4e24\u79cd\u65b9\u5f0f\uff1a</p> <p>\u73af\u5883\u53d8\u91cf\u914d\u7f6e</p> <p>runner \u793a\u4f8b\u4e2d\u652f\u6301\u901a\u8fc7\u547d\u4ee4\u884c\u53c2\u6570(-model)\u6307\u5b9a\u6a21\u578b\u540d\u79f0\uff0c\u5b9e\u9645\u4e0a\u662f\u5728 <code>openai.New()</code> \u65f6\u4f20\u5165\u6a21\u578b\u540d\u79f0\u3002</p> <pre><code># OpenAI \u5e73\u53f0\nexport OPENAI_API_KEY=\"sk-...\"\ncd examples/runner\ngo run main.go -model gpt-4o-mini\n\n# OpenAI API \u517c\u5bb9\nexport OPENAI_BASE_URL=\"https://api.deepseek.com/v1\"\nexport OPENAI_API_KEY=\"your-api-key\"\ncd examples/runner\ngo run main.go -model deepseek-chat\n</code></pre> <p>\u4ee3\u7801\u914d\u7f6e\u65b9\u5f0f</p> <p>\u5728\u81ea\u5df1\u7684\u4ee3\u7801\u4e2d\u76f4\u63a5\u4f7f\u7528 Model \u65f6\u7684\u914d\u7f6e\u65b9\u5f0f\uff1a</p> <pre><code>model := openai.New(\"deepseek-chat\",\n    openai.WithBaseURL(\"https://api.deepseek.com/v1\"),\n    openai.WithAPIKey(\"your-api-key\"),\n)\n\n// \u5176\u4ed6\u5e73\u53f0\u914d\u7f6e\u7c7b\u4f3c\uff0c\u53ea\u9700\u4fee\u6539\u6a21\u578b\u540d\u79f0\u3001BaseURL\u548cAPIKey\uff0c\u65e0\u9700\u989d\u5916\u5b57\u6bb5\n</code></pre>"},{"location":"zh/model/#_7","title":"\u6838\u5fc3\u63a5\u53e3\u8bbe\u8ba1","text":""},{"location":"zh/model/#model_1","title":"Model \u63a5\u53e3","text":"<pre><code>// Model \u662f\u6240\u6709\u8bed\u8a00\u6a21\u578b\u5fc5\u987b\u5b9e\u73b0\u7684\u63a5\u53e3\ntype Model interface {\n    // \u751f\u6210\u5185\u5bb9\uff0c\u652f\u6301\u6d41\u5f0f\u54cd\u5e94\n    GenerateContent(ctx context.Context, request *Request) (&lt;-chan *Response, error)\n\n    // \u8fd4\u56de\u6a21\u578b\u57fa\u672c\u4fe1\u606f\n    Info() Info\n}\n\n// \u6a21\u578b\u4fe1\u606f\u7ed3\u6784\ntype Info struct {\n    Name string // \u6a21\u578b\u540d\u79f0\n}\n</code></pre>"},{"location":"zh/model/#request","title":"Request \u7ed3\u6784","text":"<pre><code>// Request \u8868\u793a\u53d1\u9001\u7ed9\u6a21\u578b\u7684\u8bf7\u6c42\ntype Request struct {\n    // \u6d88\u606f\u5217\u8868\uff0c\u5305\u542b\u7cfb\u7edf\u6307\u4ee4\u3001\u7528\u6237\u8f93\u5165\u548c\u52a9\u624b\u56de\u590d\n    Messages []Message `json:\"messages\"`\n\n    // \u751f\u6210\u914d\u7f6e\uff08\u5185\u8054\u5230\u8bf7\u6c42\u4e2d\uff09\n    GenerationConfig `json:\",inline\"`\n\n    // \u5de5\u5177\u5217\u8868\n    Tools map[string]tool.Tool `json:\"-\"`\n}\n\n// GenerationConfig \u5305\u542b\u751f\u6210\u53c2\u6570\u914d\u7f6e\ntype GenerationConfig struct {\n    // \u662f\u5426\u4f7f\u7528\u6d41\u5f0f\u54cd\u5e94\n    Stream bool `json:\"stream\"`\n\n    // \u6e29\u5ea6\u53c2\u6570 (0.0-2.0)\n    Temperature *float64 `json:\"temperature,omitempty\"`\n\n    // \u6700\u5927\u751f\u6210\u4ee4\u724c\u6570\n    MaxTokens *int `json:\"max_tokens,omitempty\"`\n\n    // Top-P \u91c7\u6837\u53c2\u6570\n    TopP *float64 `json:\"top_p,omitempty\"`\n\n    // \u505c\u6b62\u751f\u6210\u7684\u6807\u8bb0\n    Stop []string `json:\"stop,omitempty\"`\n\n    // \u9891\u7387\u60e9\u7f5a\n    FrequencyPenalty *float64 `json:\"frequency_penalty,omitempty\"`\n\n    // \u5b58\u5728\u60e9\u7f5a\n    PresencePenalty *float64 `json:\"presence_penalty,omitempty\"`\n\n    // \u63a8\u7406\u52aa\u529b\u7a0b\u5ea6 (\"low\", \"medium\", \"high\")\n    ReasoningEffort *string `json:\"reasoning_effort,omitempty\"`\n\n    // \u662f\u5426\u542f\u7528\u601d\u8003\u6a21\u5f0f\n    ThinkingEnabled *bool `json:\"-\"`\n\n    // \u601d\u8003\u6a21\u5f0f\u7684\u6700\u5927\u4ee4\u724c\u6570\n    ThinkingTokens *int `json:\"-\"`\n}\n</code></pre>"},{"location":"zh/model/#response","title":"Response \u7ed3\u6784","text":"<pre><code>// Response \u8868\u793a\u6a21\u578b\u8fd4\u56de\u7684\u54cd\u5e94\ntype Response struct {\n    // OpenAI \u517c\u5bb9\u5b57\u6bb5\n    ID                string   `json:\"id,omitempty\"`\n    Object            string   `json:\"object,omitempty\"`\n    Created           int64    `json:\"created,omitempty\"`\n    Model             string   `json:\"model,omitempty\"`\n    SystemFingerprint *string  `json:\"system_fingerprint,omitempty\"`\n    Choices           []Choice `json:\"choices,omitempty\"`\n    Usage             *Usage   `json:\"usage,omitempty\"`\n\n    // \u9519\u8bef\u4fe1\u606f\n    Error *ResponseError `json:\"error,omitempty\"`\n\n    // \u5185\u90e8\u5b57\u6bb5\n    Timestamp time.Time `json:\"-\"`\n    Done      bool      `json:\"-\"`\n    IsPartial bool      `json:\"-\"`\n}\n\n// ResponseError \u8868\u793a API \u7ea7\u522b\u7684\u9519\u8bef\ntype ResponseError struct {\n    Message string    `json:\"message\"`\n    Type    ErrorType `json:\"type\"`\n    Param   string    `json:\"param,omitempty\"`\n    Code    string    `json:\"code,omitempty\"`\n}\n</code></pre>"},{"location":"zh/model/#_8","title":"\u6a21\u578b\u540d\u79f0\u53c2\u6570","text":"<p>\u4f7f\u7528 <code>openai.New(name string, opts ...Option)</code> \u521b\u5efa OpenAI \u6a21\u578b\u5b9e\u4f8b\u65f6\uff0c\u7b2c\u4e00\u4e2a\u53c2\u6570\u662f\u5b9e\u9645\u53d1\u9001\u7ed9 OpenAI API \u7684\u6a21\u578b\u540d\u79f0\uff0c\u4f5c\u4e3a\u544a\u8bc9 API \u4f7f\u7528\u54ea\u4e2a\u8bed\u8a00\u6a21\u578b\u7684\u7279\u5b9a\u6a21\u578b\u6807\u8bc6\u7b26\u3002</p> <p>\u7531\u4e8e\u6846\u67b6\u652f\u6301\u4e0e OpenAI API \u517c\u5bb9\u7684\u4e0d\u540c\u6a21\u578b\uff0c\u60a8\u53ef\u4ee5\u4ece\u5404\u79cd\u6a21\u578b\u63d0\u4f9b\u5546\u83b7\u53d6\u57fa\u7840 URL\u3001API \u5bc6\u94a5\u548c\u6a21\u578b\u540d\u79f0\uff1a</p> <p>1. OpenAI \u5b98\u65b9</p> <ul> <li>\u57fa\u7840 URL\uff1a<code>https://api.openai.com/v1</code></li> <li>\u6a21\u578b\u540d\u79f0\uff1a<code>gpt-4o</code>\u3001<code>gpt-4o-mini</code> \u7b49</li> </ul> <p>2. DeepSeek</p> <ul> <li>\u57fa\u7840 URL\uff1a<code>https://api.deepseek.com</code></li> <li>\u6a21\u578b\u540d\u79f0\uff1a<code>deepseek-chat</code>\u3001<code>deepseek-reasoner</code></li> </ul> <p>3. \u817e\u8baf\u6df7\u5143</p> <ul> <li>\u57fa\u7840 URL\uff1a<code>https://api.hunyuan.cloud.tencent.com/v1</code></li> <li>\u6a21\u578b\u540d\u79f0\uff1a<code>hunyuan-2.0-thinking-20251109</code>\u3001<code>hunyuan-2.0-instruct-20251111</code> \u7b49</li> </ul> <p>4. \u5176\u4ed6\u63d0\u4f9b\u5546</p> <ul> <li>Qwen\uff1a\u57fa\u7840 URL <code>https://dashscope.aliyuncs.com/compatible-mode/v1</code>\uff0c\u6a21\u578b\u540d\u79f0\uff1a\u5404\u79cd Qwen \u6a21\u578b</li> </ul> <p>OpenAI Model \u7528\u4e8e\u5bf9\u63a5 OpenAI \u53ca\u5176\u517c\u5bb9\u5e73\u53f0\uff0c\u652f\u6301\u6d41\u5f0f\u8f93\u51fa\u3001\u591a\u6a21\u6001\u4e0e\u9ad8\u7ea7\u53c2\u6570\u914d\u7f6e\uff0c\u5e76\u63d0\u4f9b\u4e30\u5bcc\u7684\u56de\u8c03\u673a\u5236\u3001\u6279\u91cf\u5904\u7406\u4e0e\u91cd\u8bd5\u80fd\u529b\uff0c\u540c\u65f6\u53ef\u7075\u6d3b\u8bbe\u7f6e\u81ea\u5b9a\u4e49 HTTP Header.</p>"},{"location":"zh/model/#_9","title":"\u914d\u7f6e\u65b9\u5f0f","text":""},{"location":"zh/model/#_10","title":"\u73af\u5883\u53d8\u91cf\u65b9\u5f0f","text":"<pre><code>export OPENAI_API_KEY=\"your-api-key\"\nexport OPENAI_BASE_URL=\"https://api.openai.com\" # \u53ef\u9009\u914d\u7f6e\uff0c\u9ed8\u8ba4\u4e3a\u6b64 BASE URL\n</code></pre>"},{"location":"zh/model/#_11","title":"\u4ee3\u7801\u65b9\u5f0f","text":"<pre><code>import \"trpc.group/trpc-go/trpc-agent-go/model/openai\"\n\nm := openai.New(\n    \"gpt-4o\",\n    openai.WithAPIKey(\"your-api-key\"),\n    openai.WithBaseURL(\"https://api.openai.com\"), // \u53ef\u9009\u914d\u7f6e\uff0c\u9ed8\u8ba4\u4e3a\u6b64 BASE URL\n)\n</code></pre>"},{"location":"zh/model/#model_2","title":"\u76f4\u63a5\u4f7f\u7528 Model","text":"<pre><code>import (\n    \"context\"\n    \"fmt\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/model\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/openai\"\n)\n\nfunc main() {\n    // \u521b\u5efa\u6a21\u578b\u5b9e\u4f8b\n    llm := openai.New(\"deepseek-chat\")\n\n    // \u6784\u5efa\u8bf7\u6c42\n    temperature := 0.7\n    maxTokens := 1000\n\n    request := &amp;model.Request{\n        Messages: []model.Message{\n            model.NewSystemMessage(\"\u4f60\u662f\u4e00\u4e2a\u4e13\u4e1a\u7684AI\u52a9\u624b\u3002\"),\n            model.NewUserMessage(\"\u4ecb\u7ecd\u4e00\u4e0bGo\u8bed\u8a00\u7684\u5e76\u53d1\u7279\u6027\u3002\"),\n        },\n        GenerationConfig: model.GenerationConfig{\n            Temperature: &amp;temperature,\n            MaxTokens:   &amp;maxTokens,\n            Stream:      false,\n        },\n    }\n\n    // \u8c03\u7528\u6a21\u578b\n    ctx := context.Background()\n    responseChan, err := llm.GenerateContent(ctx, request)\n    if err != nil {\n        fmt.Printf(\"\u7cfb\u7edf\u9519\u8bef: %v\\n\", err)\n        return\n    }\n\n    // \u5904\u7406\u54cd\u5e94\n    for response := range responseChan {\n        if response.Error != nil {\n            fmt.Printf(\"API\u9519\u8bef: %s\\n\", response.Error.Message)\n            return\n        }\n\n        if len(response.Choices) &gt; 0 {\n            fmt.Printf(\"\u56de\u590d: %s\\n\", response.Choices[0].Message.Content)\n        }\n\n        if response.Done {\n            break\n        }\n    }\n}\n</code></pre>"},{"location":"zh/model/#_12","title":"\u6d41\u5f0f\u8f93\u51fa","text":"<pre><code>// \u6d41\u5f0f\u8bf7\u6c42\u914d\u7f6e\nrequest := &amp;model.Request{\n    Messages: []model.Message{\n        model.NewSystemMessage(\"\u4f60\u662f\u4e00\u4e2a\u521b\u610f\u6545\u4e8b\u8bb2\u8ff0\u8005\u3002\"),\n        model.NewUserMessage(\"\u5199\u4e00\u4e2a\u5173\u4e8e\u673a\u5668\u4eba\u5b66\u4e60\u7ed8\u753b\u7684\u77ed\u6545\u4e8b\u3002\"),\n    },\n    GenerationConfig: model.GenerationConfig{\n        Stream: true,  // \u542f\u7528\u6d41\u5f0f\u8f93\u51fa\n    },\n}\n\n// \u5904\u7406\u6d41\u5f0f\u54cd\u5e94\nresponseChan, err := llm.GenerateContent(ctx, request)\nif err != nil {\n    return err\n}\n\nfor response := range responseChan {\n    if response.Error != nil {\n        fmt.Printf(\"\u9519\u8bef: %s\", response.Error.Message)\n        return\n    }\n\n    if len(response.Choices) &gt; 0 &amp;&amp; response.Choices[0].Delta.Content != \"\" {\n        fmt.Print(response.Choices[0].Delta.Content)\n    }\n\n    if response.Done {\n        break\n    }\n}\n</code></pre>"},{"location":"zh/model/#_13","title":"\u9ad8\u7ea7\u53c2\u6570\u914d\u7f6e","text":"<pre><code>// \u4f7f\u7528\u9ad8\u7ea7\u751f\u6210\u53c2\u6570\ntemperature := 0.3\nmaxTokens := 2000\ntopP := 0.9\npresencePenalty := 0.2\nfrequencyPenalty := 0.5\nreasoningEffort := \"high\"\n\nrequest := &amp;model.Request{\n    Messages: []model.Message{\n        model.NewSystemMessage(\"\u4f60\u662f\u4e00\u4e2a\u4e13\u4e1a\u7684\u6280\u672f\u6587\u6863\u64b0\u5199\u8005\u3002\"),\n        model.NewUserMessage(\"\u89e3\u91ca\u5fae\u670d\u52a1\u67b6\u6784\u7684\u4f18\u7f3a\u70b9\u3002\"),\n    },\n    GenerationConfig: model.GenerationConfig{\n        Temperature:      &amp;temperature,\n        MaxTokens:        &amp;maxTokens,\n        TopP:             &amp;topP,\n        PresencePenalty:  &amp;presencePenalty,\n        FrequencyPenalty: &amp;frequencyPenalty,\n        ReasoningEffort:  &amp;reasoningEffort,\n        Stream:           true,\n    },\n}\n</code></pre>"},{"location":"zh/model/#_14","title":"\u591a\u6a21\u6001\u5185\u5bb9","text":"<pre><code>// \u8bfb\u53d6\u56fe\u50cf\u6587\u4ef6\nimageData, _ := os.ReadFile(\"image.jpg\")\n\n// \u521b\u5efa\u591a\u6a21\u6001\u6d88\u606f\nrequest := &amp;model.Request{\n    Messages: []model.Message{\n        model.NewSystemMessage(\"\u4f60\u662f\u4e00\u4e2a\u56fe\u50cf\u5206\u6790\u4e13\u5bb6\u3002\"),\n        {\n            Role: model.RoleUser,\n            ContentParts: []model.ContentPart{\n                {\n                    Type: model.ContentTypeText,\n                    Text: stringPtr(\"\u8fd9\u5f20\u56fe\u7247\u4e2d\u6709\u4ec0\u4e48?\"),\n                },\n                {\n                    Type: model.ContentTypeImage,\n                    Image: &amp;model.Image{\n                        Data:   imageData,\n                        Format: \"jpeg\",\n                    },\n                },\n            },\n        },\n    },\n}\n</code></pre>"},{"location":"zh/model/#_15","title":"\u9ad8\u7ea7\u529f\u80fd","text":""},{"location":"zh/model/#1","title":"1. \u56de\u8c03\u51fd\u6570","text":"<pre><code>// \u8bbe\u7f6e\u8bf7\u6c42\u524d\u56de\u8c03\u51fd\u6570\nmodel := openai.New(\"deepseek-chat\",\n    openai.WithChatRequestCallback(func(ctx context.Context, req *openai.ChatCompletionNewParams) {\n        // \u8bf7\u6c42\u53d1\u9001\u524d\u88ab\u8c03\u7528\n        log.Printf(\"\u53d1\u9001\u8bf7\u6c42: \u6a21\u578b=%s, \u6d88\u606f\u6570=%d\", req.Model, len(req.Messages))\n    }),\n\n    // \u8bbe\u7f6e\u54cd\u5e94\u56de\u8c03\u51fd\u6570\uff08\u975e\u6d41\u5f0f\uff09\n    openai.WithChatResponseCallback(func(ctx context.Context,\n        req *openai.ChatCompletionNewParams,\n        resp *openai.ChatCompletion) {\n        // \u6536\u5230\u5b8c\u6574\u54cd\u5e94\u65f6\u8c03\u7528\n        log.Printf(\"\u6536\u5230\u54cd\u5e94: ID=%s, \u4f7f\u7528Token=%d\",\n            resp.ID, resp.Usage.TotalTokens)\n    }),\n\n    // \u8bbe\u7f6e\u6d41\u5f0f\u54cd\u5e94\u56de\u8c03\u51fd\u6570\n    openai.WithChatChunkCallback(func(ctx context.Context,\n        req *openai.ChatCompletionNewParams,\n        chunk *openai.ChatCompletionChunk) {\n        // \u6536\u5230\u6bcf\u4e2a\u6d41\u5f0f\u54cd\u5e94\u5757\u65f6\u8c03\u7528\n        log.Printf(\"\u6536\u5230\u6d41\u5f0f\u5757: ID=%s\", chunk.ID)\n    }),\n\n    // \u8bbe\u7f6e\u6d41\u5f0f\u5b8c\u6210\u56de\u8c03\u51fd\u6570\n    openai.WithChatStreamCompleteCallback(func(ctx context.Context,\n        req *openai.ChatCompletionNewParams,\n        acc *openai.ChatCompletionAccumulator,\n        streamErr error) {\n        // \u6d41\u5f0f\u54cd\u5e94\u5b8c\u5168\u7ed3\u675f\u65f6\u8c03\u7528\uff08\u6210\u529f\u6216\u5931\u8d25\uff09\n        if streamErr != nil {\n            log.Printf(\"\u6d41\u5f0f\u54cd\u5e94\u5931\u8d25: %v\", streamErr)\n        } else {\n            log.Printf(\"\u6d41\u5f0f\u54cd\u5e94\u5b8c\u6210: \u539f\u56e0=%s\",\n                acc.Choices[0].FinishReason)\n        }\n    }),\n)\n</code></pre>"},{"location":"zh/model/#2-model-switching","title":"2. \u6a21\u578b\u5207\u6362\uff08Model Switching\uff09","text":"<p>\u6a21\u578b\u5207\u6362\u5141\u8bb8\u5728\u8fd0\u884c\u65f6\u52a8\u6001\u66f4\u6362 Agent \u4f7f\u7528\u7684 LLM \u6a21\u578b\u3002\u6846\u67b6\u63d0\u4f9b\u4e24\u79cd\u65b9\u5f0f\uff1aAgent \u7ea7\u522b\u5207\u6362\uff08\u5f71\u54cd\u6240\u6709\u540e\u7eed\u8bf7\u6c42\uff09\u548c\u8bf7\u6c42\u7ea7\u522b\u5207\u6362\uff08\u4ec5\u5f71\u54cd\u5355\u6b21\u8bf7\u6c42\uff09\u3002</p>"},{"location":"zh/model/#agent","title":"Agent \u7ea7\u522b\u5207\u6362","text":"<p>Agent \u7ea7\u522b\u5207\u6362\u4f1a\u6539\u53d8 Agent \u7684\u9ed8\u8ba4\u6a21\u578b\uff0c\u5f71\u54cd\u6240\u6709\u540e\u7eed\u8bf7\u6c42\u3002</p>"},{"location":"zh/model/#_16","title":"\u65b9\u5f0f\u4e00\uff1a\u76f4\u63a5\u8bbe\u7f6e\u6a21\u578b\u5b9e\u4f8b","text":"<p>\u901a\u8fc7 <code>SetModel</code> \u65b9\u6cd5\u76f4\u63a5\u4f20\u5165\u6a21\u578b\u5b9e\u4f8b\uff1a</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/agent/llmagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/anthropic\"\n)\n\n// \u521b\u5efa Agent.\nagent := llmagent.New(\"my-agent\",\n    llmagent.WithModel(anthropic.New(\"claude-3-5-haiku-20241022\")),\n)\n\n// \u5207\u6362\u5230\u5176\u4ed6\u6a21\u578b.\nagent.SetModel(anthropic.New(\"claude-3-5-sonnet-20241022\"))\n</code></pre> <p>\u4f7f\u7528\u573a\u666f\uff1a</p> <pre><code>// \u6839\u636e\u4efb\u52a1\u590d\u6742\u5ea6\u9009\u62e9\u6a21\u578b.\nif isComplexTask {\n    agent.SetModel(anthropic.New(\"claude-3-5-sonnet-20241022\"))  // \u4f7f\u7528\u5f3a\u5927\u6a21\u578b.\n} else {\n    agent.SetModel(anthropic.New(\"claude-3-5-haiku-20241022\"))  // \u4f7f\u7528\u5feb\u901f\u6a21\u578b.\n}\n</code></pre>"},{"location":"zh/model/#_17","title":"\u65b9\u5f0f\u4e8c\uff1a\u6309\u540d\u79f0\u5207\u6362\u6a21\u578b","text":"<p>\u901a\u8fc7 <code>WithModels</code> \u9884\u6ce8\u518c\u591a\u4e2a\u6a21\u578b\uff0c\u7136\u540e\u4f7f\u7528 <code>SetModelByName</code> \u6309\u540d\u79f0\u5207\u6362\uff1a</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/agent/llmagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/model\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/anthropic\"\n)\n\n// \u521b\u5efa\u591a\u4e2a\u6a21\u578b\u5b9e\u4f8b.\nsonnet := anthropic.New(\"claude-3-5-sonnet-20241022\")\nhaiku := anthropic.New(\"claude-3-5-haiku-20241022\")\n\n// \u521b\u5efa Agent \u65f6\u6ce8\u518c\u6240\u6709\u6a21\u578b.\nagent := llmagent.New(\"my-agent\",\n    llmagent.WithModels(map[string]model.Model{\n        \"smart\": sonnet,\n        \"fast\":  haiku,\n    }),\n    llmagent.WithModel(haiku), // \u6307\u5b9a\u521d\u59cb\u6a21\u578b.\n    llmagent.WithInstruction(\"\u4f60\u662f\u4e00\u4e2a\u667a\u80fd\u52a9\u624b\u3002\"),\n)\n\n// \u8fd0\u884c\u65f6\u6309\u540d\u79f0\u5207\u6362\u6a21\u578b.\nerr := agent.SetModelByName(\"smart\")\nif err != nil {\n    log.Fatal(err)\n}\n\n// \u5207\u6362\u5230\u5176\u4ed6\u6a21\u578b.\nerr = agent.SetModelByName(\"fast\")\nif err != nil {\n    log.Fatal(err)\n}\n</code></pre> <p>\u4f7f\u7528\u573a\u666f\uff1a</p> <pre><code>// \u6839\u636e\u7528\u6237\u7b49\u7ea7\u9009\u62e9\u6a21\u578b.\nmodelName := \"fast\" // \u9ed8\u8ba4\u4f7f\u7528\u5feb\u901f\u6a21\u578b.\nif user.IsPremium() {\n    modelName = \"smart\" // \u4ed8\u8d39\u7528\u6237\u4f7f\u7528\u9ad8\u7ea7\u6a21\u578b.\n}\nif err := agent.SetModelByName(modelName); err != nil {\n    log.Printf(\"\u5207\u6362\u6a21\u578b\u5931\u8d25: %v\", err)\n}\n\n// \u6839\u636e\u65f6\u95f4\u6bb5\u9009\u62e9\u6a21\u578b\uff08\u6210\u672c\u4f18\u5316\uff09.\nhour := time.Now().Hour()\nif hour &gt;= 22 || hour &lt; 8 {\n    // \u591c\u95f4\u4f7f\u7528\u5feb\u901f\u6a21\u578b.\n    agent.SetModelByName(\"fast\")\n} else {\n    // \u767d\u5929\u4f7f\u7528\u667a\u80fd\u6a21\u578b.\n    agent.SetModelByName(\"smart\")\n}\n</code></pre>"},{"location":"zh/model/#_18","title":"\u8bf7\u6c42\u7ea7\u522b\u5207\u6362","text":"<p>\u8bf7\u6c42\u7ea7\u522b\u5207\u6362\u5141\u8bb8\u4e3a\u5355\u6b21\u8bf7\u6c42\u4e34\u65f6\u6307\u5b9a\u6a21\u578b\uff0c\u4e0d\u5f71\u54cd Agent \u7684\u9ed8\u8ba4\u6a21\u578b\u548c\u5176\u4ed6\u8bf7\u6c42\u3002\u8fd9\u5bf9\u4e8e\u9700\u8981\u9488\u5bf9\u7279\u5b9a\u4efb\u52a1\u4f7f\u7528\u4e0d\u540c\u6a21\u578b\u7684\u573a\u666f\u975e\u5e38\u6709\u7528\u3002</p>"},{"location":"zh/model/#withmodel","title":"\u65b9\u5f0f\u4e00\uff1a\u4f7f\u7528 WithModel \u9009\u9879","text":"<p>\u901a\u8fc7 <code>agent.WithModel</code> \u4e3a\u5355\u6b21\u8bf7\u6c42\u6307\u5b9a\u6a21\u578b\u5b9e\u4f8b\uff1a</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/agent\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/anthropic\"\n)\n\n// \u4e3a\u8fd9\u6b21\u8bf7\u6c42\u4f7f\u7528\u7279\u5b9a\u6a21\u578b.\neventChan, err := runner.Run(ctx, userID, sessionID, message,\n    agent.WithModel(anthropic.New(\"claude-3-5-sonnet-20241022\")),\n)\n</code></pre>"},{"location":"zh/model/#withmodelname","title":"\u65b9\u5f0f\u4e8c\uff1a\u4f7f\u7528 WithModelName \u9009\u9879\uff08\u63a8\u8350\uff09","text":"<p>\u901a\u8fc7 <code>agent.WithModelName</code> \u4e3a\u5355\u6b21\u8bf7\u6c42\u6307\u5b9a\u9884\u6ce8\u518c\u7684\u6a21\u578b\u540d\u79f0\uff1a</p> <pre><code>// \u521b\u5efa Agent \u65f6\u9884\u6ce8\u518c\u591a\u4e2a\u6a21\u578b.\nagent := llmagent.New(\"my-agent\",\n    llmagent.WithModels(map[string]model.Model{\n        \"smart\": anthropic.New(\"claude-3-5-sonnet-20241022\"),\n        \"fast\":  anthropic.New(\"claude-3-5-haiku-20241022\"),\n    }),\n    llmagent.WithModel(anthropic.New(\"claude-3-5-haiku-20241022\")), // \u9ed8\u8ba4\u6a21\u578b.\n)\n\nrunner := runner.NewRunner(\"app\", agent)\n\n// \u4e3a\u8fd9\u6b21\u8bf7\u6c42\u4e34\u65f6\u4f7f\u7528 \"smart\" \u6a21\u578b.\neventChan, err := runner.Run(ctx, userID, sessionID, message,\n    agent.WithModelName(\"smart\"),\n)\n\n// \u4e0b\u4e00\u6b21\u8bf7\u6c42\u4ecd\u7136\u4f7f\u7528\u9ed8\u8ba4\u6a21\u578b \"claude-3-5-haiku-20241022\".\neventChan2, err := runner.Run(ctx, userID, sessionID, message2)\n</code></pre> <p>\u4f7f\u7528\u573a\u666f\uff1a</p> <pre><code>// \u6839\u636e\u6d88\u606f\u590d\u6742\u5ea6\u52a8\u6001\u9009\u62e9\u6a21\u578b.\nvar opts []agent.RunOption\nif isComplexQuery(message) {\n    opts = append(opts, agent.WithModelName(\"smart\")) // \u590d\u6742\u67e5\u8be2\u4f7f\u7528\u5f3a\u5927\u6a21\u578b.\n}\n\neventChan, err := runner.Run(ctx, userID, sessionID, message, opts...)\n\n// \u4e3a\u7279\u5b9a\u4efb\u52a1\u4f7f\u7528\u4e13\u95e8\u7684\u6a21\u578b.\neventChan, err := runner.Run(ctx, userID, sessionID, visionMessage,\n    agent.WithModelName(\"vision\"),\n)\n</code></pre>"},{"location":"zh/model/#_19","title":"\u914d\u7f6e\u8bf4\u660e","text":"<p>WithModels \u9009\u9879\uff1a</p> <ul> <li>\u63a5\u53d7\u4e00\u4e2a <code>map[string]model.Model</code>\uff0ckey \u4e3a\u6a21\u578b\u540d\u79f0\uff0cvalue \u4e3a\u6a21\u578b\u5b9e\u4f8b</li> <li>\u5982\u679c\u540c\u65f6\u8bbe\u7f6e\u4e86 <code>WithModel</code> \u548c <code>WithModels</code>\uff0c<code>WithModel</code> \u6307\u5b9a\u521d\u59cb\u6a21\u578b</li> <li>\u5982\u679c\u53ea\u8bbe\u7f6e\u4e86 <code>WithModels</code>\uff0c\u5c06\u4f7f\u7528 map \u4e2d\u7684\u7b2c\u4e00\u4e2a\u6a21\u578b\u4f5c\u4e3a\u521d\u59cb\u6a21\u578b\uff08\u6ce8\u610f\uff1amap \u904d\u5386\u987a\u5e8f\u4e0d\u786e\u5b9a\uff0c\u5efa\u8bae\u660e\u786e\u6307\u5b9a\u521d\u59cb\u6a21\u578b\uff09</li> <li>\u4fdd\u7559\u540d\u79f0\uff1a<code>__default__</code> \u662f\u6846\u67b6\u5185\u90e8\u4f7f\u7528\u7684\u4fdd\u7559\u540d\u79f0\uff0c\u5efa\u8bae\u4e0d\u8981\u4f7f\u7528</li> </ul> <p>SetModelByName \u65b9\u6cd5\uff1a</p> <ul> <li>\u53c2\u6570\uff1a\u6a21\u578b\u540d\u79f0\uff08\u5b57\u7b26\u4e32\uff09</li> <li>\u8fd4\u56de\uff1a\u5982\u679c\u6a21\u578b\u540d\u79f0\u4e0d\u5b58\u5728\uff0c\u8fd4\u56de\u9519\u8bef</li> <li>\u6a21\u578b\u5fc5\u987b\u662f\u901a\u8fc7 <code>WithModels</code> \u9884\u5148\u6ce8\u518c\u7684</li> </ul> <p>\u8bf7\u6c42\u7ea7\u522b\u9009\u9879\uff1a</p> <ul> <li><code>agent.RunOptions.Model</code>\uff1a\u76f4\u63a5\u6307\u5b9a\u6a21\u578b\u5b9e\u4f8b</li> <li><code>agent.RunOptions.ModelName</code>\uff1a\u6307\u5b9a\u9884\u6ce8\u518c\u7684\u6a21\u578b\u540d\u79f0</li> <li>\u4f18\u5148\u7ea7\uff1a<code>Model</code> &gt; <code>ModelName</code> &gt; Agent \u9ed8\u8ba4\u6a21\u578b</li> <li>\u5982\u679c <code>ModelName</code> \u6307\u5b9a\u7684\u6a21\u578b\u4e0d\u5b58\u5728\uff0c\u5c06\u56de\u9000\u5230 Agent \u9ed8\u8ba4\u6a21\u578b</li> </ul>"},{"location":"zh/model/#agent-vs","title":"Agent \u7ea7\u522b vs \u8bf7\u6c42\u7ea7\u522b\u5bf9\u6bd4","text":"\u7279\u6027 Agent \u7ea7\u522b\u5207\u6362 \u8bf7\u6c42\u7ea7\u522b\u5207\u6362 \u5f71\u54cd\u8303\u56f4 \u6240\u6709\u540e\u7eed\u8bf7\u6c42 \u4ec5\u5f53\u524d\u8bf7\u6c42 \u4f7f\u7528\u65b9\u5f0f <code>SetModel</code>/<code>SetModelByName</code> <code>RunOptions.Model</code>/<code>ModelName</code> \u72b6\u6001\u53d8\u5316 \u6539\u53d8 Agent \u9ed8\u8ba4\u6a21\u578b \u4e0d\u6539\u53d8 Agent \u72b6\u6001 \u9002\u7528\u573a\u666f \u5168\u5c40\u7b56\u7565\u8c03\u6574 \u7279\u5b9a\u4efb\u52a1\u4e34\u65f6\u9700\u6c42 \u5e76\u53d1\u5f71\u54cd \u5f71\u54cd\u6240\u6709\u5e76\u53d1\u8bf7\u6c42 \u4e0d\u5f71\u54cd\u5176\u4ed6\u8bf7\u6c42 \u5178\u578b\u7528\u4f8b \u7528\u6237\u7b49\u7ea7\u3001\u65f6\u95f4\u6bb5\u7b56\u7565 \u590d\u6742\u67e5\u8be2\u3001\u63a8\u7406\u4efb\u52a1"},{"location":"zh/model/#agent_1","title":"Agent \u7ea7\u522b\u5207\u6362\u65b9\u5f0f\u5bf9\u6bd4","text":"\u7279\u6027 SetModel SetModelByName \u4f7f\u7528\u65b9\u5f0f \u4f20\u5165\u6a21\u578b\u5b9e\u4f8b \u4f20\u5165\u6a21\u578b\u540d\u79f0 \u9884\u6ce8\u518c \u4e0d\u9700\u8981 \u9700\u8981\u901a\u8fc7 WithModels \u9519\u8bef\u5904\u7406 \u65e0 \u8fd4\u56de error \u9002\u7528\u573a\u666f \u7b80\u5355\u5207\u6362 \u590d\u6742\u573a\u666f\uff0c\u591a\u6a21\u578b\u7ba1\u7406 \u4ee3\u7801\u7ef4\u62a4 \u9700\u8981\u6301\u6709\u6a21\u578b\u5b9e\u4f8b \u53ea\u9700\u8981\u8bb0\u4f4f\u540d\u79f0"},{"location":"zh/model/#_20","title":"\u91cd\u8981\u8bf4\u660e","text":"<p>Agent \u7ea7\u522b\u5207\u6362\uff1a</p> <ul> <li>\u5373\u65f6\u751f\u6548\uff1a\u8c03\u7528 <code>SetModel</code> \u6216 <code>SetModelByName</code> \u540e\uff0c\u4e0b\u4e00\u6b21\u8bf7\u6c42\u7acb\u5373\u4f7f\u7528\u65b0\u6a21\u578b</li> <li>\u4f1a\u8bdd\u4fdd\u6301\uff1a\u5207\u6362\u6a21\u578b\u4e0d\u4f1a\u6e05\u9664\u4f1a\u8bdd\u5386\u53f2</li> <li>\u914d\u7f6e\u72ec\u7acb\uff1a\u6bcf\u4e2a\u6a21\u578b\u4fdd\u7559\u81ea\u5df1\u7684\u914d\u7f6e\uff08\u6e29\u5ea6\u3001\u6700\u5927 token \u7b49\uff09</li> <li>\u5e76\u53d1\u5b89\u5168\uff1a\u4e24\u79cd\u5207\u6362\u65b9\u5f0f\u90fd\u662f\u5e76\u53d1\u5b89\u5168\u7684</li> </ul> <p>\u8bf7\u6c42\u7ea7\u522b\u5207\u6362\uff1a</p> <ul> <li>\u4e34\u65f6\u8986\u76d6\uff1a\u4ec5\u5f71\u54cd\u5f53\u524d\u8bf7\u6c42\uff0c\u4e0d\u6539\u53d8 Agent \u7684\u9ed8\u8ba4\u6a21\u578b</li> <li>\u4f18\u5148\u7ea7\u9ad8\uff1a\u8bf7\u6c42\u7ea7\u522b\u7684\u6a21\u578b\u8bbe\u7f6e\u4f18\u5148\u4e8e Agent \u9ed8\u8ba4\u6a21\u578b</li> <li>\u65e0\u526f\u4f5c\u7528\uff1a\u4e0d\u5f71\u54cd\u5176\u4ed6\u5e76\u53d1\u8bf7\u6c42\u6216\u540e\u7eed\u8bf7\u6c42</li> <li>\u7075\u6d3b\u7ec4\u5408\uff1a\u53ef\u4ee5\u4e0e Agent \u7ea7\u522b\u5207\u6362\u914d\u5408\u4f7f\u7528</li> </ul>"},{"location":"zh/model/#_21","title":"\u4f7f\u7528\u793a\u4f8b","text":"<p>\u5b8c\u6574\u7684\u4ea4\u4e92\u5f0f\u793a\u4f8b\u8bf7\u53c2\u8003 examples/model/switch\uff0c\u8be5\u793a\u4f8b\u6f14\u793a\u4e86 Agent \u7ea7\u522b\u548c\u8bf7\u6c42\u7ea7\u522b\u4e24\u79cd\u5207\u6362\u65b9\u5f0f\u3002</p>"},{"location":"zh/model/#3-batch-api","title":"3. \u6279\u91cf\u5904\u7406\uff08Batch API\uff09","text":"<p>Batch API \u662f\u4e00\u79cd\u5f02\u6b65\u6279\u91cf\u5904\u7406\u6280\u672f\uff0c\u7528\u4e8e\u9ad8\u6548\u5904\u7406\u5927\u91cf\u8bf7\u6c42\u3002\u8be5\u529f\u80fd\u7279\u522b\u9002\u7528\u4e8e\u9700\u8981\u5904\u7406\u5927\u89c4\u6a21\u6570\u636e\u7684\u573a\u666f\uff0c\u80fd\u591f\u663e\u8457\u964d\u4f4e\u6210\u672c\u5e76\u63d0\u9ad8\u5904\u7406\u6548\u7387\u3002</p>"},{"location":"zh/model/#_22","title":"\u6838\u5fc3\u7279\u6027","text":"<ul> <li>\u5f02\u6b65\u5904\u7406\uff1a\u6279\u91cf\u8bf7\u6c42\u5f02\u6b65\u5904\u7406\uff0c\u65e0\u9700\u7b49\u5f85\u5373\u65f6\u54cd\u5e94</li> <li>\u6210\u672c\u4f18\u5316\uff1a\u901a\u5e38\u6bd4\u5355\u72ec\u8bf7\u6c42\u66f4\u5177\u6210\u672c\u6548\u76ca</li> <li>\u7075\u6d3b\u8f93\u5165\uff1a\u652f\u6301\u5185\u8054\u8bf7\u6c42\u548c\u6587\u4ef6\u8f93\u5165\u4e24\u79cd\u65b9\u5f0f</li> <li>\u5b8c\u6574\u7ba1\u7406\uff1a\u63d0\u4f9b\u521b\u5efa\u3001\u67e5\u8be2\u3001\u53d6\u6d88\u3001\u5217\u8868\u7b49\u5b8c\u6574\u64cd\u4f5c</li> <li>\u7ed3\u679c\u89e3\u6790\uff1a\u81ea\u52a8\u4e0b\u8f7d\u548c\u89e3\u6790\u6279\u5904\u7406\u7ed3\u679c</li> </ul>"},{"location":"zh/model/#_23","title":"\u5feb\u901f\u5f00\u59cb","text":"<p>\u521b\u5efa\u6279\u5904\u7406\u4efb\u52a1\uff1a</p> <pre><code>import (\n    openaisdk \"github.com/openai/openai-go\"\n    \"trpc.group/trpc-go/trpc-agent-go/model\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/openai\"\n)\n\n// \u521b\u5efa\u6a21\u578b\u5b9e\u4f8b\nllm := openai.New(\"gpt-4o-mini\")\n\n// \u51c6\u5907\u6279\u5904\u7406\u8bf7\u6c42\nrequests := []*openai.BatchRequestInput{\n    {\n        CustomID: \"request-1\",\n        Method:   \"POST\",\n        URL:      string(openaisdk.BatchNewParamsEndpointV1ChatCompletions),\n        Body: openai.BatchRequest{\n            Messages: []model.Message{\n                model.NewSystemMessage(\"\u4f60\u662f\u4e00\u4e2a\u6709\u7528\u7684\u52a9\u624b\u3002\"),\n                model.NewUserMessage(\"\u4f60\u597d\"),\n            },\n        },\n    },\n    {\n        CustomID: \"request-2\",\n        Method:   \"POST\",\n        URL:      string(openaisdk.BatchNewParamsEndpointV1ChatCompletions),\n        Body: openai.BatchRequest{\n            Messages: []model.Message{\n                model.NewSystemMessage(\"\u4f60\u662f\u4e00\u4e2a\u6709\u7528\u7684\u52a9\u624b\u3002\"),\n                model.NewUserMessage(\"\u4ecb\u7ecd\u4e00\u4e0b Go \u8bed\u8a00\"),\n            },\n        },\n    },\n}\n\n// \u521b\u5efa\u6279\u5904\u7406\u4efb\u52a1\nbatch, err := llm.CreateBatch(ctx, requests,\n    openai.WithBatchCreateCompletionWindow(\"24h\"),\n)\nif err != nil {\n    log.Fatal(err)\n}\n\nfmt.Printf(\"\u6279\u5904\u7406\u4efb\u52a1\u5df2\u521b\u5efa: %s\\n\", batch.ID)\n</code></pre>"},{"location":"zh/model/#_24","title":"\u6279\u5904\u7406\u64cd\u4f5c","text":"<p>\u67e5\u8be2\u6279\u5904\u7406\u72b6\u6001\uff1a</p> <pre><code>// \u83b7\u53d6\u6279\u5904\u7406\u8be6\u60c5\nbatch, err := llm.RetrieveBatch(ctx, batchID)\nif err != nil {\n    log.Fatal(err)\n}\n\nfmt.Printf(\"\u72b6\u6001: %s\\n\", batch.Status)\nfmt.Printf(\"\u603b\u8bf7\u6c42\u6570: %d\\n\", batch.RequestCounts.Total)\nfmt.Printf(\"\u5df2\u5b8c\u6210: %d\\n\", batch.RequestCounts.Completed)\nfmt.Printf(\"\u5931\u8d25: %d\\n\", batch.RequestCounts.Failed)\n</code></pre> <p>\u4e0b\u8f7d\u548c\u89e3\u6790\u7ed3\u679c\uff1a</p> <pre><code>// \u4e0b\u8f7d\u8f93\u51fa\u6587\u4ef6\nif batch.OutputFileID != \"\" {\n    text, err := llm.DownloadFileContent(ctx, batch.OutputFileID)\n    if err != nil {\n        log.Fatal(err)\n    }\n\n    // \u89e3\u6790\u6279\u5904\u7406\u8f93\u51fa\n    entries, err := llm.ParseBatchOutput(text)\n    if err != nil {\n        log.Fatal(err)\n    }\n\n    // \u5904\u7406\u6bcf\u4e2a\u7ed3\u679c\n    for _, entry := range entries {\n        fmt.Printf(\"[%s] \u72b6\u6001\u7801: %d\\n\", entry.CustomID, entry.Response.StatusCode)\n        if len(entry.Response.Body.Choices) &gt; 0 {\n            content := entry.Response.Body.Choices[0].Message.Content\n            fmt.Printf(\"\u5185\u5bb9: %s\\n\", content)\n        }\n        if entry.Error != nil {\n            fmt.Printf(\"\u9519\u8bef: %s\\n\", entry.Error.Message)\n        }\n    }\n}\n</code></pre> <p>\u53d6\u6d88\u6279\u5904\u7406\u4efb\u52a1\uff1a</p> <pre><code>// \u53d6\u6d88\u6b63\u5728\u8fdb\u884c\u7684\u6279\u5904\u7406\nbatch, err := llm.CancelBatch(ctx, batchID)\nif err != nil {\n    log.Fatal(err)\n}\n\nfmt.Printf(\"\u6279\u5904\u7406\u4efb\u52a1\u5df2\u53d6\u6d88: %s\\n\", batch.ID)\n</code></pre> <p>\u5217\u51fa\u6279\u5904\u7406\u4efb\u52a1\uff1a</p> <pre><code>// \u5217\u51fa\u6279\u5904\u7406\u4efb\u52a1\uff08\u652f\u6301\u5206\u9875\uff09\npage, err := llm.ListBatches(ctx, \"\", 10)\nif err != nil {\n    log.Fatal(err)\n}\n\nfor _, batch := range page.Data {\n    fmt.Printf(\"ID: %s, \u72b6\u6001: %s\\n\", batch.ID, batch.Status)\n}\n</code></pre>"},{"location":"zh/model/#_25","title":"\u914d\u7f6e\u9009\u9879","text":"<p>\u5168\u5c40\u914d\u7f6e\uff1a</p> <pre><code>// \u5728\u521b\u5efa\u6a21\u578b\u65f6\u914d\u7f6e\u6279\u5904\u7406\u9ed8\u8ba4\u53c2\u6570\nllm := openai.New(\"gpt-4o-mini\",\n    openai.WithBatchCompletionWindow(\"24h\"),\n    openai.WithBatchMetadata(map[string]string{\n        \"project\": \"my-project\",\n        \"env\":     \"production\",\n    }),\n    openai.WithBatchBaseURL(\"https://custom-batch-api.com\"),\n)\n</code></pre> <p>\u8bf7\u6c42\u7ea7\u914d\u7f6e\uff1a</p> <pre><code>// \u5728\u521b\u5efa\u6279\u5904\u7406\u65f6\u8986\u76d6\u9ed8\u8ba4\u914d\u7f6e\nbatch, err := llm.CreateBatch(ctx, requests,\n    openai.WithBatchCreateCompletionWindow(\"48h\"),\n    openai.WithBatchCreateMetadata(map[string]string{\n        \"priority\": \"high\",\n    }),\n)\n</code></pre>"},{"location":"zh/model/#_26","title":"\u5de5\u4f5c\u539f\u7406","text":"<p>Batch API \u7684\u6267\u884c\u6d41\u7a0b\uff1a</p> <pre><code>1. \u51c6\u5907\u6279\u5904\u7406\u8bf7\u6c42\uff08BatchRequestInput \u5217\u8868\uff09\n2. \u9a8c\u8bc1\u8bf7\u6c42\u683c\u5f0f\u548c CustomID \u552f\u4e00\u6027\n3. \u751f\u6210 JSONL \u683c\u5f0f\u7684\u8f93\u5165\u6587\u4ef6\n4. \u4e0a\u4f20\u8f93\u5165\u6587\u4ef6\u5230\u670d\u52a1\u7aef\n5. \u521b\u5efa\u6279\u5904\u7406\u4efb\u52a1\n6. \u5f02\u6b65\u5904\u7406\u8bf7\u6c42\n7. \u4e0b\u8f7d\u8f93\u51fa\u6587\u4ef6\u5e76\u89e3\u6790\u7ed3\u679c\n</code></pre> <p>\u5173\u952e\u8bbe\u8ba1\uff1a</p> <ul> <li>CustomID \u552f\u4e00\u6027\uff1a\u6bcf\u4e2a\u8bf7\u6c42\u5fc5\u987b\u6709\u552f\u4e00\u7684 CustomID \u7528\u4e8e\u5339\u914d\u8f93\u5165\u8f93\u51fa</li> <li>JSONL \u683c\u5f0f\uff1a\u6279\u5904\u7406\u4f7f\u7528 JSONL\uff08JSON Lines\uff09\u683c\u5f0f\u5b58\u50a8\u8bf7\u6c42\u548c\u54cd\u5e94</li> <li>\u5f02\u6b65\u5904\u7406\uff1a\u6279\u5904\u7406\u4efb\u52a1\u5728\u540e\u53f0\u5f02\u6b65\u6267\u884c\uff0c\u4e0d\u963b\u585e\u4e3b\u6d41\u7a0b</li> <li>\u5b8c\u6210\u7a97\u53e3\uff1a\u53ef\u914d\u7f6e\u6279\u5904\u7406\u7684\u5b8c\u6210\u65f6\u95f4\u7a97\u53e3\uff08\u5982 24h\uff09</li> </ul>"},{"location":"zh/model/#_27","title":"\u4f7f\u7528\u573a\u666f","text":"<ul> <li>\u5927\u89c4\u6a21\u6570\u636e\u5904\u7406\uff1a\u9700\u8981\u5904\u7406\u6570\u5343\u6216\u6570\u4e07\u6761\u8bf7\u6c42</li> <li>\u79bb\u7ebf\u5206\u6790\uff1a\u975e\u5b9e\u65f6\u7684\u6570\u636e\u5206\u6790\u548c\u5904\u7406\u4efb\u52a1</li> <li>\u6210\u672c\u4f18\u5316\uff1a\u6279\u91cf\u5904\u7406\u901a\u5e38\u6bd4\u5355\u72ec\u8bf7\u6c42\u66f4\u7ecf\u6d4e</li> <li>\u5b9a\u65f6\u4efb\u52a1\uff1a\u5b9a\u671f\u6267\u884c\u7684\u6279\u91cf\u5904\u7406\u4f5c\u4e1a</li> </ul>"},{"location":"zh/model/#_28","title":"\u4f7f\u7528\u793a\u4f8b","text":"<p>\u5b8c\u6574\u7684\u4ea4\u4e92\u5f0f\u793a\u4f8b\u8bf7\u53c2\u8003 examples/model/batch\u3002</p>"},{"location":"zh/model/#4-retry","title":"4. \u91cd\u8bd5\u673a\u5236\uff08Retry\uff09","text":"<p>\u91cd\u8bd5\u673a\u5236\u662f\u4e00\u79cd\u81ea\u52a8\u9519\u8bef\u6062\u590d\u6280\u672f\uff0c\u7528\u4e8e\u5728\u8bf7\u6c42\u5931\u8d25\u65f6\u81ea\u52a8\u91cd\u8bd5\u3002\u8be5\u529f\u80fd\u7531\u5e95\u5c42 OpenAI SDK \u63d0\u4f9b\uff0c\u6846\u67b6\u901a\u8fc7\u914d\u7f6e\u9009\u9879\u5c06\u91cd\u8bd5\u53c2\u6570\u4f20\u9012\u7ed9 SDK\u3002</p>"},{"location":"zh/model/#_29","title":"\u6838\u5fc3\u7279\u6027","text":"<ul> <li>\u81ea\u52a8\u91cd\u8bd5\uff1aSDK \u81ea\u52a8\u5904\u7406\u53ef\u91cd\u8bd5\u7684\u9519\u8bef</li> <li>\u667a\u80fd\u9000\u907f\uff1a\u9075\u5faa API \u7684 <code>Retry-After</code> \u5934\u6216\u4f7f\u7528\u6307\u6570\u9000\u907f</li> <li>\u53ef\u914d\u7f6e\u6027\uff1a\u652f\u6301\u81ea\u5b9a\u4e49\u6700\u5927\u91cd\u8bd5\u6b21\u6570\u548c\u8d85\u65f6\u65f6\u95f4</li> <li>\u96f6\u7ef4\u62a4\uff1a\u65e0\u9700\u81ea\u5b9a\u4e49\u91cd\u8bd5\u903b\u8f91\uff0c\u7531\u6210\u719f\u7684 SDK \u5904\u7406</li> </ul>"},{"location":"zh/model/#_30","title":"\u5feb\u901f\u5f00\u59cb","text":"<p>\u57fa\u7840\u914d\u7f6e\uff1a</p> <pre><code>import (\n    \"time\"\n\n    openaiopt \"github.com/openai/openai-go/option\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/openai\"\n)\n\n// \u521b\u5efa\u5e26\u91cd\u8bd5\u914d\u7f6e\u7684\u6a21\u578b\u5b9e\u4f8b\nllm := openai.New(\"gpt-4o-mini\",\n    openai.WithOpenAIOptions(\n        openaiopt.WithMaxRetries(3),\n        openaiopt.WithRequestTimeout(30*time.Second),\n    ),\n)\n</code></pre>"},{"location":"zh/model/#_31","title":"\u53ef\u91cd\u8bd5\u7684\u9519\u8bef","text":"<p>OpenAI SDK \u81ea\u52a8\u91cd\u8bd5\u4ee5\u4e0b\u9519\u8bef\uff1a</p> <ul> <li>408 Request Timeout\uff1a\u8bf7\u6c42\u8d85\u65f6</li> <li>409 Conflict\uff1a\u51b2\u7a81\u9519\u8bef</li> <li>429 Too Many Requests\uff1a\u901f\u7387\u9650\u5236</li> <li>500+ Server Errors\uff1a\u670d\u52a1\u5668\u5185\u90e8\u9519\u8bef\uff085xx\uff09</li> <li>\u7f51\u7edc\u8fde\u63a5\u9519\u8bef\uff1a\u65e0\u54cd\u5e94\u6216\u8fde\u63a5\u5931\u8d25</li> </ul> <p>\u6ce8\u610f\uff1aSDK \u9ed8\u8ba4\u6700\u5927\u91cd\u8bd5\u6b21\u6570\u4e3a 2 \u6b21\u3002</p>"},{"location":"zh/model/#_32","title":"\u91cd\u8bd5\u7b56\u7565","text":"<p>\u6807\u51c6\u91cd\u8bd5\uff1a</p> <pre><code>// \u9002\u7528\u4e8e\u5927\u591a\u6570\u573a\u666f\u7684\u6807\u51c6\u914d\u7f6e\nllm := openai.New(\"gpt-4o-mini\",\n    openai.WithOpenAIOptions(\n        openaiopt.WithMaxRetries(3),\n        openaiopt.WithRequestTimeout(30*time.Second),\n    ),\n)\n</code></pre> <p>\u901f\u7387\u9650\u5236\u4f18\u5316\uff1a</p> <pre><code>// \u9488\u5bf9\u901f\u7387\u9650\u5236\u573a\u666f\u7684\u4f18\u5316\u914d\u7f6e\nllm := openai.New(\"gpt-4o-mini\",\n    openai.WithOpenAIOptions(\n        openaiopt.WithMaxRetries(5),  // \u66f4\u591a\u91cd\u8bd5\u6b21\u6570\n        openaiopt.WithRequestTimeout(60*time.Second),  // \u66f4\u957f\u8d85\u65f6\n    ),\n)\n</code></pre> <p>\u5feb\u901f\u5931\u8d25\uff1a</p> <pre><code>// \u9700\u8981\u5feb\u901f\u5931\u8d25\u7684\u573a\u666f\nllm := openai.New(\"gpt-4o-mini\",\n    openai.WithOpenAIOptions(\n        openaiopt.WithMaxRetries(1),  // \u6700\u5c11\u91cd\u8bd5\n        openaiopt.WithRequestTimeout(10*time.Second),  // \u77ed\u8d85\u65f6\n    ),\n)\n</code></pre>"},{"location":"zh/model/#_33","title":"\u5de5\u4f5c\u539f\u7406","text":"<p>\u91cd\u8bd5\u673a\u5236\u7684\u6267\u884c\u6d41\u7a0b\uff1a</p> <pre><code>1. \u53d1\u9001\u8bf7\u6c42\u5230 LLM API\n2. \u5982\u679c\u8bf7\u6c42\u5931\u8d25\u4e14\u9519\u8bef\u53ef\u91cd\u8bd5\uff1a\n   a. \u68c0\u67e5\u662f\u5426\u8fbe\u5230\u6700\u5927\u91cd\u8bd5\u6b21\u6570\n   b. \u6839\u636e Retry-After \u5934\u6216\u6307\u6570\u9000\u907f\u8ba1\u7b97\u7b49\u5f85\u65f6\u95f4\n   c. \u7b49\u5f85\u540e\u91cd\u65b0\u53d1\u9001\u8bf7\u6c42\n3. \u5982\u679c\u8bf7\u6c42\u6210\u529f\u6216\u4e0d\u53ef\u91cd\u8bd5\uff0c\u8fd4\u56de\u7ed3\u679c\n</code></pre> <p>\u5173\u952e\u8bbe\u8ba1\uff1a</p> <ul> <li>SDK \u7ea7\u5b9e\u73b0\uff1a\u91cd\u8bd5\u903b\u8f91\u5b8c\u5168\u7531 OpenAI SDK \u5904\u7406</li> <li>\u914d\u7f6e\u4f20\u9012\uff1a\u6846\u67b6\u901a\u8fc7 <code>WithOpenAIOptions</code> \u4f20\u9012\u914d\u7f6e</li> <li>\u667a\u80fd\u9000\u907f\uff1a\u4f18\u5148\u4f7f\u7528 API \u8fd4\u56de\u7684 <code>Retry-After</code> \u5934</li> <li>\u900f\u660e\u5904\u7406\uff1a\u5bf9\u5e94\u7528\u5c42\u900f\u660e\uff0c\u65e0\u9700\u989d\u5916\u4ee3\u7801</li> </ul>"},{"location":"zh/model/#_34","title":"\u4f7f\u7528\u573a\u666f","text":"<ul> <li>\u751f\u4ea7\u73af\u5883\uff1a\u63d0\u9ad8\u670d\u52a1\u53ef\u9760\u6027\u548c\u5bb9\u9519\u80fd\u529b</li> <li>\u901f\u7387\u9650\u5236\uff1a\u81ea\u52a8\u5904\u7406 429 \u9519\u8bef</li> <li>\u7f51\u7edc\u4e0d\u7a33\u5b9a\uff1a\u5e94\u5bf9\u4e34\u65f6\u7f51\u7edc\u6545\u969c</li> <li>\u670d\u52a1\u5668\u9519\u8bef\uff1a\u5904\u7406\u4e34\u65f6\u7684\u670d\u52a1\u7aef\u95ee\u9898</li> </ul>"},{"location":"zh/model/#_35","title":"\u91cd\u8981\u8bf4\u660e","text":"<ul> <li>\u65e0\u6846\u67b6\u91cd\u8bd5\uff1a\u6846\u67b6\u672c\u8eab\u4e0d\u5b9e\u73b0\u91cd\u8bd5\u903b\u8f91</li> <li>\u5ba2\u6237\u7aef\u7ea7\u91cd\u8bd5\uff1a\u6240\u6709\u91cd\u8bd5\u7531 OpenAI \u5ba2\u6237\u7aef\u5904\u7406</li> <li>\u914d\u7f6e\u900f\u4f20\uff1a\u4f7f\u7528 <code>WithOpenAIOptions</code> \u914d\u7f6e\u91cd\u8bd5\u884c\u4e3a</li> <li>\u81ea\u52a8\u5904\u7406\uff1a\u901f\u7387\u9650\u5236\uff08429\uff09\u81ea\u52a8\u5904\u7406\uff0c\u65e0\u9700\u989d\u5916\u4ee3\u7801</li> </ul>"},{"location":"zh/model/#_36","title":"\u4f7f\u7528\u793a\u4f8b","text":"<p>\u5b8c\u6574\u7684\u4ea4\u4e92\u5f0f\u793a\u4f8b\u8bf7\u53c2\u8003 examples/model/retry\u3002</p>"},{"location":"zh/model/#5-http-header","title":"5. \u81ea\u5b9a\u4e49 HTTP Header","text":"<p>\u5728\u7f51\u5173\u3001\u4e13\u6709\u5e73\u53f0\u6216\u4ee3\u7406\u73af\u5883\u4e2d\uff0c\u8bf7\u6c42\u6a21\u578b API \u5f80\u5f80\u9700\u8981\u989d\u5916\u7684 HTTP Header\uff08\u4f8b\u5982\u7ec4\u7ec7/\u79df\u6237\u6807\u8bc6\u3001\u7070\u5ea6\u8def\u7531\u3001\u81ea\u5b9a\u4e49\u9274\u6743\u7b49\uff09\u3002Model \u6a21\u5757 \u63d0\u4f9b\u4e24\u79cd\u53ef\u9760\u65b9\u5f0f\u4e3a\u201c\u6240\u6709\u6a21\u578b\u8bf7\u6c42\u201d\u6dfb\u52a0 Header\uff0c\u9002\u7528\u4e8e\u666e\u901a\u8bf7\u6c42\u3001\u6d41\u5f0f\u3001 \u6587\u4ef6\u4e0a\u4f20\u3001\u6279\u5904\u7406\u7b49\u5168\u94fe\u8def\u3002</p> <p>\u63a8\u8350\u987a\u5e8f\uff1a</p> <ul> <li>\u901a\u8fc7 <code>openai.WithHeaders</code> \u5feb\u901f\u8ffd\u52a0\u9759\u6001 Header\uff08\u7b80\u4fbf\uff09</li> <li>\u901a\u8fc7 OpenAI RequestOption \u8bbe\u7f6e\u5168\u5c40 Header\uff08\u7075\u6d3b\u3001\u53ef\u7ec4\u5408\u4e2d\u95f4\u4ef6\uff09</li> <li>\u901a\u8fc7\u81ea\u5b9a\u4e49 <code>http.RoundTripper</code> \u6ce8\u5165\uff08\u8fdb\u9636\u3001\u6a2a\u5207\u80fd\u529b\u66f4\u5f3a\uff09</li> </ul> <p>\u4e0a\u8ff0\u4e09\u79cd\u65b9\u5f0f\u540c\u6837\u5f71\u54cd\u6d41\u5f0f\u8bf7\u6c42\uff0c\u56e0\u4e3a\u5e95\u5c42\u4f7f\u7528\u7684\u662f\u540c\u4e00\u4e2a\u5ba2\u6237\u7aef\u3002</p>"},{"location":"zh/model/#1-openaiwithheaders-header","title":"1. \u4f7f\u7528 openai.WithHeaders \u8ffd\u52a0 Header","text":"<pre><code>import \"trpc.group/trpc-go/trpc-agent-go/model/openai\"\n\nllm := openai.New(\"deepseek-chat\",\n    openai.WithHeaders(map[string]string{\n        \"X-Custom-Header\": \"custom-value\",\n        \"X-Request-ID\":    \"req-123\",\n    }),\n)\n</code></pre>"},{"location":"zh/model/#2-openai-requestoption-header","title":"2. \u4f7f\u7528 OpenAI RequestOption \u8bbe\u7f6e\u5168\u5c40 Header","text":"<p>\u901a\u8fc7 <code>WithOpenAIOptions</code> \u914d\u5408 <code>openaiopt.WithHeader</code> \u6216 <code>openaiopt.WithMiddleware</code>\uff0c\u53ef\u4e3a\u5e95\u5c42 OpenAI \u5ba2\u6237\u7aef\u53d1\u8d77\u7684\u201c\u6bcf\u4e2a\u8bf7\u6c42\u201d \u6ce8\u5165 Header\u3002</p> <pre><code>import (\n    openaiopt \"github.com/openai/openai-go/option\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/openai\"\n)\n\nllm := openai.New(\"deepseek-chat\",\n    // \u82e5\u4f60\u7684\u5e73\u53f0\u8981\u6c42\u989d\u5916\u5934\u90e8\n    openai.WithOpenAIOptions(\n        openaiopt.WithHeader(\"X-Custom-Header\", \"custom-value\"),\n        openaiopt.WithHeader(\"X-Request-ID\", \"req-123\"),\n        // \u4e5f\u53ef\u8bbe\u7f6e User-Agent \u6216\u5382\u5546\u7279\u5b9a\u5934\n        openaiopt.WithHeader(\"User-Agent\", \"trpc-agent-go/1.0\"),\n    ),\n)\n</code></pre> <p>\u82e5\u9700\u8981\u6309\u6761\u4ef6\u8bbe\u7f6e\uff08\u4f8b\u5982\u4ec5\u5bf9\u67d0\u4e9b\u8def\u5f84\u6216\u4f9d\u8d56\u8c03\u7528\u4e0a\u4e0b\u6587\u503c\uff09\uff0c\u53ef\u4f7f\u7528\u4e2d\u95f4\u4ef6\uff1a</p> <pre><code>llm := openai.New(\"deepseek-chat\",\n    openai.WithOpenAIOptions(\n        openaiopt.WithMiddleware(\n            func(r *http.Request, next openaiopt.MiddlewareNext) (*http.Response, error) {\n                // \u4f8b\uff1a\u6309\u4e0a\u4e0b\u6587\u503c\u8bbe\u7f6e\u201c\u6bcf\u6b21\u8bf7\u6c42\u201d\u7684\u5934\u90e8\n                if v := r.Context().Value(\"x-request-id\"); v != nil {\n                    if s, ok := v.(string); ok &amp;&amp; s != \"\" {\n                        r.Header.Set(\"X-Request-ID\", s)\n                    }\n                }\n                // \u6216\u4ec5\u5bf9\u5bf9\u8bdd\u8865\u5168\u63a5\u53e3\u751f\u6548\n                if strings.Contains(r.URL.Path, \"/chat/completions\") {\n                    r.Header.Set(\"X-Feature-Flag\", \"on\")\n                }\n                return next(r)\n            },\n        ),\n    ),\n)\n</code></pre> <p>\u9274\u6743\u5dee\u5f02\u6ce8\u610f\u4e8b\u9879\uff1a</p> <ul> <li>OpenAI \u98ce\u683c\uff1a\u4fdd\u7559 <code>openai.WithAPIKey(\"sk-...\")</code>\uff0c\u5e95\u5c42\u4f1a\u8bbe\u7f6e   <code>Authorization: Bearer ...</code>\u3002</li> <li>Azure/\u90e8\u5206 OpenAI \u517c\u5bb9\uff1a\u82e5\u8981\u6c42 <code>api-key</code> \u5934\u90e8\uff0c\u5219\u4e0d\u8981\u8c03\u7528   <code>WithAPIKey</code>\uff0c\u6539\u4e3a\u4f7f\u7528   <code>openaiopt.WithHeader(\"api-key\", \"&lt;key&gt;\")</code>\u3002</li> </ul>"},{"location":"zh/model/#3-httproundtripper","title":"3. \u4f7f\u7528\u81ea\u5b9a\u4e49 http.RoundTripper\uff08\u8fdb\u9636\uff09","text":"<p>\u5728 HTTP \u4f20\u8f93\u5c42\u7edf\u4e00\u6ce8\u5165 Header\uff0c\u9002\u5408\u540c\u65f6\u9700\u8981\u4ee3\u7406\u3001TLS\u3001\u81ea\u5b9a\u4e49\u76d1\u63a7\u7b49 \u80fd\u529b\u7684\u573a\u666f\u3002</p> <pre><code>type headerRoundTripper struct{ base http.RoundTripper }\n\nfunc (rt headerRoundTripper) RoundTrip(req *http.Request) (*http.Response, error) {\n    // \u6dfb\u52a0\u6216\u8986\u76d6\u5934\u90e8\n    req.Header.Set(\"X-Custom-Header\", \"custom-value\")\n    req.Header.Set(\"X-Trace-ID\", \"trace-xyz\")\n    return rt.base.RoundTrip(req)\n}\n\nllm := openai.New(\"deepseek-chat\",\n    openai.WithHTTPClientOptions(\n        openai.WithHTTPClientTransport(headerRoundTripper{base: http.DefaultTransport}),\n    ),\n)\n</code></pre> <p>\u5173\u4e8e\u201c\u6bcf\u6b21\u8bf7\u6c42\u201d\u7684\u5934\u90e8\uff1a</p> <ul> <li>Agent/Runner \u4f1a\u628a <code>ctx</code> \u900f\u4f20\u81f3\u6a21\u578b\u8c03\u7528\uff1b\u4e2d\u95f4\u4ef6\u53ef\u4ece   <code>req.Context()</code> \u8bfb\u53d6\u503c\uff0c\u4ece\u800c\u4e3a\u201c\u672c\u6b21\u8c03\u7528\u201d\u6ce8\u5165\u5934\u90e8\u3002</li> <li>\u5bf9\u201c\u5bf9\u8bdd\u8865\u5168\u201d\u800c\u8a00\uff0c\u76ee\u524d\u672a\u66b4\u9732\u5355\u6b21\u8c03\u7528\u7ea7\u522b\u7684 BaseURL \u8986\u76d6\uff1b\u5982\u9700\u5207   \u6362\uff0c\u8bf7\u65b0\u5efa\u4e00\u4e2a\u4f7f\u7528\u4e0d\u540c BaseURL \u7684\u6a21\u578b\uff0c\u6216\u5728\u4e2d\u95f4\u4ef6\u4e2d\u4fee\u6539 <code>r.URL</code>\u3002</li> </ul>"},{"location":"zh/model/#6-token-token-tailoring","title":"6. Token \u88c1\u526a\uff08Token Tailoring\uff09","text":"<p>Token Tailoring \u662f\u4e00\u79cd\u667a\u80fd\u7684\u6d88\u606f\u7ba1\u7406\u6280\u672f\uff0c\u7528\u4e8e\u5728\u6d88\u606f\u8d85\u51fa\u6a21\u578b\u4e0a\u4e0b\u6587\u7a97\u53e3\u9650\u5236\u65f6\u81ea\u52a8\u88c1\u526a\u6d88\u606f\uff0c\u786e\u4fdd\u8bf7\u6c42\u80fd\u591f\u6210\u529f\u53d1\u9001\u5230 LLM API\u3002\u8be5\u529f\u80fd\u7279\u522b\u9002\u7528\u4e8e\u957f\u5bf9\u8bdd\u573a\u666f\uff0c\u80fd\u591f\u5728\u4fdd\u7559\u5173\u952e\u4e0a\u4e0b\u6587\u7684\u540c\u65f6\uff0c\u5c06\u6d88\u606f\u5217\u8868\u63a7\u5236\u5728\u6a21\u578b\u7684 token \u9650\u5236\u5185\u3002</p> <p>\u81ea\u52a8\u6a21\u5f0f\uff08\u63a8\u8350\uff09\uff1a</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/model/openai\"\n)\n\n// \u53ea\u9700\u542f\u7528 token tailoring\uff0c\u5176\u4ed6\u53c2\u6570\u81ea\u52a8\u914d\u7f6e\nmodel := openai.New(\"deepseek-chat\",\n    openai.WithEnableTokenTailoring(true),\n)\n</code></pre> <p>\u9ad8\u7ea7\u6a21\u5f0f\uff1a</p> <pre><code>// \u81ea\u5b9a\u4e49 token \u9650\u5236\u548c\u7b56\u7565\nmodel := openai.New(\"deepseek-chat\",\n    openai.WithEnableTokenTailoring(true),               // \u5fc5\u9700\uff1a\u542f\u7528 token tailoring\n    openai.WithMaxInputTokens(10000),                    // \u81ea\u5b9a\u4e49 token \u9650\u5236\n    openai.WithTokenCounter(customCounter),              // \u53ef\u9009\uff1a\u81ea\u5b9a\u4e49\u8ba1\u6570\u5668\n    openai.WithTailoringStrategy(customStrategy),        // \u53ef\u9009\uff1a\u81ea\u5b9a\u4e49\u7b56\u7565\n)\n</code></pre> <p>Token \u8ba1\u7b97\u516c\u5f0f\uff1a</p> <p>\u6846\u67b6\u4f1a\u6839\u636e\u6a21\u578b\u7684\u4e0a\u4e0b\u6587\u7a97\u53e3\u81ea\u52a8\u8ba1\u7b97 \"maxInputTokens\"\uff1a</p> <pre><code>safetyMargin = contextWindow \u00d7 10%\ncalculatedMax = contextWindow - 2048\uff08\u8f93\u51fa\u9884\u7559\uff09- 512\uff08\u534f\u8bae\u5f00\u9500\uff09- safetyMargin\nratioLimit = contextWindow \u00d7 100%\uff08\u6700\u5927\u8f93\u5165\u6bd4\u4f8b\uff09\nmaxInputTokens = max(min(calculatedMax, ratioLimit), 1024\uff08\u6700\u5c0f\u503c\uff09)\n</code></pre> <p>\u4f8b\u5982 \"gpt-4o\"\uff08contextWindow = 128000\uff09\uff1a</p> <pre><code>safetyMargin = 128000 \u00d7 0.10 = 12800 tokens\ncalculatedMax = 128000 - 2048 - 512 - 12800 = 112640 tokens\nratioLimit = 128000 \u00d7 1.0 = 128000 tokens\nmaxInputTokens = 112640 tokens\uff08\u7ea6\u5360 context window \u7684 88%\uff09\n</code></pre> <p>\u9ed8\u8ba4\u9884\u7b97\u53c2\u6570\uff1a</p> <p>\u6846\u67b6\u4f7f\u7528\u4ee5\u4e0b\u9ed8\u8ba4\u503c\u8fdb\u884c token \u5206\u914d\uff08\u5efa\u8bae\u4fdd\u7559\u9ed8\u8ba4\u503c\uff09\uff1a</p> <ul> <li>\u534f\u8bae\u5f00\u9500\uff08ProtocolOverheadTokens\uff09: 512 tokens - \u7528\u4e8e\u8bf7\u6c42/\u54cd\u5e94\u683c\u5f0f\u5316</li> <li>\u8f93\u51fa\u9884\u7559\uff08ReserveOutputTokens\uff09: 2048 tokens - \u4e3a\u8f93\u51fa\u751f\u6210\u9884\u7559</li> <li>\u8f93\u5165\u6700\u5c0f\u503c\uff08InputTokensFloor\uff09: 1024 tokens - \u786e\u4fdd\u6a21\u578b\u6b63\u5e38\u5904\u7406</li> <li>\u8f93\u51fa\u6700\u5c0f\u503c\uff08OutputTokensFloor\uff09: 256 tokens - \u786e\u4fdd\u6709\u610f\u4e49\u7684\u54cd\u5e94</li> <li>\u5b89\u5168\u8fb9\u9645\u6bd4\u4f8b\uff08SafetyMarginRatio\uff09: 10% - token \u8ba1\u6570\u4e0d\u51c6\u786e\u7684\u7f13\u51b2</li> <li>\u6700\u5927\u8f93\u5165\u6bd4\u4f8b\uff08MaxInputTokensRatio\uff09: 100% - \u4e0a\u4e0b\u6587\u7a97\u53e3\u7684\u6700\u5927\u8f93\u5165\u6bd4\u4f8b</li> </ul> <p>\u88c1\u526a\u7b56\u7565\uff1a</p> <p>\u6846\u67b6\u63d0\u4f9b\u4e86\u9ed8\u8ba4\u7684\u88c1\u526a\u7b56\u7565\uff0c\u6309\u4f18\u5148\u7ea7\u4fdd\u7559\u4ee5\u4e0b\u6d88\u606f\uff1a</p> <ol> <li>\u7cfb\u7edf\u6d88\u606f\uff1a\u6700\u9ad8\u4f18\u5148\u7ea7\uff0c\u59cb\u7ec8\u4fdd\u7559</li> <li>\u6700\u65b0\u7528\u6237\u6d88\u606f\uff1a\u786e\u4fdd\u5f53\u524d\u5bf9\u8bdd\u8f6e\u6b21\u5b8c\u6574</li> <li>\u5de5\u5177\u8c03\u7528\u76f8\u5173\u6d88\u606f\uff1a\u4fdd\u6301\u5de5\u5177\u8c03\u7528\u7684\u4e0a\u4e0b\u6587\u5b8c\u6574\u6027</li> <li>\u5386\u53f2\u6d88\u606f\uff1a\u6839\u636e\u5269\u4f59\u7a7a\u95f4\u4fdd\u7559\u5c3d\u53ef\u80fd\u591a\u7684\u5386\u53f2\u5bf9\u8bdd</li> </ol> <p>\u81ea\u5b9a\u4e49\u88c1\u526a\u7b56\u7565\uff1a</p> <p>\u53ef\u4ee5\u901a\u8fc7\u5b9e\u73b0 <code>TailoringStrategy</code> \u63a5\u53e3\u6765\u81ea\u5b9a\u4e49\u88c1\u526a\u903b\u8f91\uff1a</p> <pre><code>type CustomStrategy struct{}\n\nfunc (s *CustomStrategy) Tailor(\n    ctx context.Context,\n    messages []model.Message,\n    maxTokens int,\n    counter tokencounter.Counter,\n) ([]model.Message, error) {\n    // \u5b9e\u73b0\u81ea\u5b9a\u4e49\u88c1\u526a\u903b\u8f91\n    // \u4f8b\u5982\uff1a\u53ea\u4fdd\u7559\u6700\u8fd1 N \u8f6e\u5bf9\u8bdd\n    return messages, nil\n}\n\nmodel := openai.New(\"deepseek-chat\",\n    openai.WithEnableTokenTailoring(true),\n    openai.WithTailoringStrategy(&amp;CustomStrategy{}),\n)\n</code></pre> <p>\u8fdb\u9636\u914d\u7f6e\uff08\u81ea\u5b9a\u4e49\u9884\u7b97\u53c2\u6570\uff09\uff1a</p> <p>\u5982\u679c\u9ed8\u8ba4\u7684 token \u5206\u914d\u7b56\u7565\u4e0d\u6ee1\u8db3\u60a8\u7684\u9700\u6c42\uff0c\u53ef\u4ee5\u901a\u8fc7 <code>WithTokenTailoringConfig</code> \u81ea\u5b9a\u4e49\u9884\u7b97\u53c2\u6570\u3002\u6ce8\u610f\uff1a\u9664\u975e\u6709\u7279\u6b8a\u9700\u6c42\uff0c\u5426\u5219\u5efa\u8bae\u4fdd\u7559\u9ed8\u8ba4\u503c\u3002</p> <pre><code>model := openai.New(\"deepseek-chat\",\n    openai.WithEnableTokenTailoring(true),\n    openai.WithTokenTailoringConfig(&amp;model.TokenTailoringConfig{\n        ProtocolOverheadTokens: 1024,   // \u81ea\u5b9a\u4e49\u534f\u8bae\u5f00\u9500\n        ReserveOutputTokens:    4096,   // \u81ea\u5b9a\u4e49\u8f93\u51fa\u9884\u7559\n        InputTokensFloor:       2048,   // \u81ea\u5b9a\u4e49\u8f93\u5165\u6700\u5c0f\u503c\n        OutputTokensFloor:      512,    // \u81ea\u5b9a\u4e49\u8f93\u51fa\u6700\u5c0f\u503c\n        SafetyMarginRatio:      0.15,   // \u81ea\u5b9a\u4e49\u5b89\u5168\u8fb9\u9645\uff0815%\uff09\n        MaxInputTokensRatio:    0.90,   // \u81ea\u5b9a\u4e49\u6700\u5927\u8f93\u5165\u6bd4\u4f8b\uff0890%\uff09\n    }),\n)\n</code></pre> <p>\u5bf9\u4e8e Anthropic \u6a21\u578b\uff0c\u53ef\u4ee5\u4f7f\u7528\u76f8\u540c\u7684\u914d\u7f6e\uff1a</p> <pre><code>model := anthropic.New(\"claude-sonnet-4-0\",\n    anthropic.WithEnableTokenTailoring(true),\n    anthropic.WithTokenTailoringConfig(&amp;model.TokenTailoringConfig{\n        SafetyMarginRatio: 0.15,  // \u63d0\u9ad8\u5b89\u5168\u8fb9\u9645\u5230 15%\n    }),\n)\n</code></pre>"},{"location":"zh/model/#7-variant","title":"7. Variant \u4f18\u5316\uff1a\u5e73\u53f0\u7279\u6709\u884c\u4e3a\u9002\u914d","text":"<p>Variant \u673a\u5236\u662f Model \u6a21\u5757\u7684\u91cd\u8981\u4f18\u5316\uff0c\u7528\u4e8e\u5904\u7406\u4e0d\u540c OpenAI \u517c\u5bb9\u5e73\u53f0\u7684\u7279\u6709\u884c\u4e3a\u5dee\u5f02\u3002\u901a\u8fc7\u6307\u5b9a\u4e0d\u540c\u7684 Variant\uff0c\u6846\u67b6\u80fd\u591f\u81ea\u52a8\u9002\u914d\u5404\u5e73\u53f0\u7684 API \u5dee\u5f02\uff0c\u7279\u522b\u662f\u6587\u4ef6\u4e0a\u4f20\u3001\u5220\u9664\u548c\u5904\u7406\u903b\u8f91\u3002</p>"},{"location":"zh/model/#71-variant","title":"7.1. \u652f\u6301\u7684 Variant \u7c7b\u578b","text":"<p>\u6846\u67b6\u76ee\u524d\u652f\u6301\u4ee5\u4e0b Variant\uff1a</p> <p>1. VariantOpenAI\uff08\u9ed8\u8ba4\uff09</p> <ul> <li>\u6807\u51c6 OpenAI API \u517c\u5bb9\u884c\u4e3a</li> <li>\u6587\u4ef6\u4e0a\u4f20\u8def\u5f84\uff1a<code>/openapi/v1/files</code></li> <li>\u6587\u4ef6\u7528\u9014\uff1a<code>user_data</code></li> <li>\u5220\u9664\u6587\u4ef6\u7684 Http \u8bf7\u6c42\u65b9\u6cd5\uff1a<code>DELETE</code></li> </ul> <p>2. VariantHunyuan\uff08\u6df7\u5143\uff09</p> <ul> <li>\u817e\u8baf\u6df7\u5143\u5e73\u53f0\u7279\u6709\u9002\u914d</li> <li>\u6587\u4ef6\u4e0a\u4f20\u8def\u5f84\uff1a<code>/openapi/v1/files/uploads</code></li> <li>\u6587\u4ef6\u7528\u9014\uff1a<code>file-extract</code></li> <li>\u5220\u9664\u6587\u4ef6\u7684 Http \u8bf7\u6c42\u65b9\u6cd5\uff1a<code>POST</code></li> </ul> <p>3. VariantDeepSeek</p> <ul> <li>DeepSeek \u5e73\u53f0\u9002\u914d</li> <li>\u9ed8\u8ba4 BaseURL\uff1a<code>https://api.deepseek.com</code></li> <li>API Key \u73af\u5883\u53d8\u91cf\u540d\uff1a<code>DEEPSEEK_API_KEY</code></li> <li>\u5176\u4ed6\u884c\u4e3a\u4e0e\u6807\u51c6 OpenAI \u4e00\u81f4</li> </ul> <p>4. VariantQwen\uff08\u5343\u95ee\uff09</p> <ul> <li>\u901a\u4e49\u5343\u95ee\u5e73\u53f0\u9002\u914d</li> <li>\u9ed8\u8ba4 BaseURL\uff1a<code>https://dashscope.aliyuncs.com/compatible-mode/v1</code></li> <li>API Key \u73af\u5883\u53d8\u91cf\u540d\uff1a<code>DASHSCOPE_API_KEY</code></li> <li>\u5176\u4ed6\u884c\u4e3a\u4e0e\u6807\u51c6 OpenAI \u4e00\u81f4</li> </ul>"},{"location":"zh/model/#72","title":"7.2. \u4f7f\u7528\u65b9\u5f0f","text":"<p>\u4f7f\u7528\u793a\u4f8b\uff1a</p> <pre><code>import \"trpc.group/trpc-go/trpc-agent-go/model/openai\"\n\n// \u4f7f\u7528\u6df7\u5143\u5e73\u53f0\nmodel := openai.New(\"hunyuan-model\",\n    openai.WithBaseURL(\"https://your-hunyuan-api.com\"),\n    openai.WithAPIKey(\"your-api-key\"),\n    openai.WithVariant(openai.VariantHunyuan), // \u5173\u952e\uff1a\u6307\u5b9a\u6df7\u5143\n)\n\n// \u4f7f\u7528 DeepSeek \u5e73\u53f0\nmodel := openai.New(\"deepseek-chat\",\n    openai.WithBaseURL(\"https://api.deepseek.com/v1\"),\n    openai.WithAPIKey(\"your-api-key\"),\n    openai.WithVariant(openai.VariantDeepSeek), // \u6307\u5b9a DeepSeek\n)\n</code></pre>"},{"location":"zh/model/#73-variant","title":"7.3. Variant \u7684\u884c\u4e3a\u5dee\u5f02\u793a\u4f8b","text":"<p>\u6d88\u606f\u5185\u5bb9\u5904\u7406\u5dee\u5f02\uff1a</p> <pre><code>import \"trpc.group/trpc-go/trpc-agent-go/model\"\n\n// \u5bf9\u4e8e\u6df7\u5143\u5e73\u53f0\uff0c\u6587\u4ef6 ID \u4f1a\u653e\u5728 extraFields \u4e2d\u800c\u975e content parts\nmessage := model.Message{\n    Role: model.RoleUser,\n    ContentParts: []model.ContentPart{\n        {\n            Type: model.ContentTypeFile,\n            File: &amp;model.File{\n                FileID: \"file_123\",\n            },\n        },\n    },\n}\n</code></pre> <p>\u73af\u5883\u53d8\u91cf\u81ea\u52a8\u914d\u7f6e\uff1a</p> <p>\u5bf9\u4e8e\u67d0\u4e9b Variant\uff0c\u6846\u67b6\u652f\u6301\u81ea\u52a8\u4ece\u73af\u5883\u53d8\u91cf\u8bfb\u53d6\u914d\u7f6e\uff1a</p> <pre><code># DeepSeek \u81ea\u52a8\u914d\u7f6e\nexport DEEPSEEK_API_KEY=\"your-api-key\"\n# \u65e0\u9700\u663e\u5f0f\u8c03\u7528 WithAPIKey\uff0c\u6846\u67b6\u4f1a\u81ea\u52a8\u8bfb\u53d6\n</code></pre> <pre><code>import \"trpc.group/trpc-go/trpc-agent-go/model\"\n\n// DeepSeek \u81ea\u52a8\u914d\u7f6e\u793a\u4f8b\nmodel := openai.New(\"deepseek-chat\",\n    openai.WithVariant(openai.VariantDeepSeek), // \u81ea\u52a8\u8bfb\u53d6 DEEPSEEK_API_KEY\n)\n</code></pre>"},{"location":"zh/model/#8-showtoolcalldelta","title":"8. \u6d41\u5f0f\u5de5\u5177\u8c03\u7528\u589e\u91cf\uff1aShowToolCallDelta","text":"<p>\u9ed8\u8ba4\u60c5\u51b5\u4e0b\uff0cOpenAI \u9002\u914d\u5c42\u4f1a\u9690\u85cf\u6d41\u5f0f\u54cd\u5e94\u4e2d\u7684\u539f\u59cb <code>tool_calls</code> \u5206\u7247\uff1a</p> <ul> <li>\u542b\u6709 <code>tool_calls</code> \u4f46\u6ca1\u6709\u53ef\u89c1\u6587\u672c\u5185\u5bb9\u7684 chunk \u4f1a\u5728\u9002\u914d\u5c42\u88ab\u8fc7\u6ee4\uff1b</li> <li>\u5de5\u5177\u8c03\u7528\u4f1a\u5728\u5185\u90e8\u7d2f\u79ef\uff0c\u6700\u7ec8\u53ea\u5728\u4e00\u6b21\u6027\u6c47\u603b\u7684\u54cd\u5e94\u4e2d\uff0c\u901a\u8fc7   <code>Response.Choices[0].Message.ToolCalls</code> \u5bf9\u5916\u66b4\u9732\uff1b</li> <li>\u8fd9\u79cd\u884c\u4e3a\u9002\u5408\u53ea\u5173\u5fc3\u52a9\u624b\u6587\u672c\u7684\u666e\u901a\u804a\u5929\u754c\u9762\uff0c\u907f\u514d\u5728\u6d41\u4e2d\u51fa\u73b0\u534a\u622a   JSON \u7247\u6bb5\u3002</li> </ul> <p>\u5bf9\u4e8e\u66f4\u9ad8\u7ea7\u7684\u573a\u666f\uff08\u4f8b\u5982\uff1a\u6a21\u578b\u5c06\u6587\u6863\u6b63\u6587\u5199\u5165\u5de5\u5177\u5165\u53c2\u7684 JSON \u5b57\u6bb5\uff0c \u524d\u7aef\u5e0c\u671b\u201c\u8fb9\u751f\u6210\u8fb9\u9884\u89c8\u201d\u6b63\u6587\uff09\uff0c\u53ef\u4ee5\u901a\u8fc7 <code>WithShowToolCallDelta</code> \u6253\u5f00\u539f\u59cb\u5de5\u5177\u8c03\u7528\u589e\u91cf\uff1a</p> <pre><code>llm := openai.New(\n    \"gpt-4.1\",\n    openai.WithShowToolCallDelta(true), // \u8f6c\u53d1 tool_call \u589e\u91cf\u5206\u7247\n)\n</code></pre> <p>\u5f53\u542f\u7528 <code>WithShowToolCallDelta(true)</code> \u65f6\uff1a</p> <ul> <li>\u542b\u6709 <code>tool_calls</code> \u7684\u6d41\u5f0f chunk \u4e0d\u518d\u88ab\u9002\u914d\u5c42\u538b\u5236\uff1b</li> <li>\u6bcf\u4e2a chunk \u4f1a\u88ab\u8f6c\u6362\u4e3a\u90e8\u5206\u54cd\u5e94 <code>model.Response</code>\uff0c\u5176\u4e2d\uff1a<ul> <li><code>Response.IsPartial == true</code></li> <li><code>Response.Choices[0].Delta.ToolCalls</code> \u4e2d\u5305\u542b\u6765\u81ea\u63d0\u4f9b\u65b9\u7684\u539f\u59cb   <code>tool_calls</code> \u589e\u91cf\uff0c\u5e76\u6620\u5c04\u4e3a <code>model.ToolCall</code>\uff1a<ul> <li><code>Type</code> \u6765\u81ea\u5e95\u5c42\u7684 <code>type</code> \u5b57\u6bb5\uff08\u4f8b\u5982 <code>\"function\"</code>\uff09\uff1b</li> <li><code>Function.Name</code>\u3001<code>Function.Arguments</code> \u4e0e\u539f\u59cb\u5de5\u5177\u540d\u548c   JSON \u5b57\u7b26\u4e32\u53c2\u6570\u4fdd\u6301\u4e00\u81f4\uff1b</li> <li><code>ID</code>\u3001<code>Index</code> \u4fdd\u7559\u5de5\u5177\u8c03\u7528\u7684\u552f\u4e00\u6807\u8bc6\uff0c\u65b9\u4fbf\u8c03\u7528\u65b9\u6309 ID \u5408\u5e76\u5206\u7247\uff1b</li> </ul> </li> </ul> </li> <li>\u6700\u7ec8\u6c47\u603b\u54cd\u5e94\u4ecd\u7136\u4f1a\u628a\u5408\u5e76\u540e\u7684\u5de5\u5177\u8c03\u7528\u653e\u5728   <code>Response.Choices[0].Message.ToolCalls</code> \u4e2d\uff0c\u539f\u6709\u5de5\u5177\u6267\u884c\u94fe\u8def   \uff08\u4f8b\u5982 <code>FunctionCallResponseProcessor</code>\uff09\u53ef\u4ee5\u65e0\u7f1d\u590d\u7528\u3002</li> </ul> <p>\u5178\u578b\u7684\u4e1a\u52a1\u63a5\u5165\u6a21\u5f0f\uff1a</p> <ol> <li>\u5728\u6bcf\u4e2a\u90e8\u5206\u54cd\u5e94\u4e2d\u8bfb\u53d6    <code>Response.Choices[0].Delta.ToolCalls[*].Function.Arguments</code>\uff1b</li> <li>\u6309\u5de5\u5177\u8c03\u7528 <code>ID</code> \u5206\u7ec4\u5e76\u8ffd\u52a0 <code>Arguments</code> \u5b57\u7b26\u4e32\u5206\u7247\uff1b</li> <li>\u5f53\u7d2f\u79ef\u5b57\u7b26\u4e32\u6784\u6210\u5408\u6cd5 JSON \u540e\uff0c\u5c06\u5176\u53cd\u5e8f\u5217\u5316\u4e3a\u4e1a\u52a1\u7ed3\u6784\u4f53    \uff08\u4f8b\u5982 <code>{ \"content\": \"...\" }</code>\uff09\uff0c\u7528\u4e8e\u524d\u7aef\u6e10\u8fdb\u5f0f\u5c55\u793a\u3002</li> </ol> <p>\u5982\u679c\u4e0d\u9700\u8981\u5728\u6d41\u5f0f\u9636\u6bb5\u89e3\u6790\u5de5\u5177\u5165\u53c2\uff0c\u53ea\u5173\u5fc3\u6700\u7ec8\u8c03\u7528\u7ed3\u679c\uff0c\u5efa\u8bae\u4fdd\u6301 <code>WithShowToolCallDelta</code> \u7684\u9ed8\u8ba4\u5173\u95ed\u72b6\u6001\uff0c\u4ee5\u907f\u514d\u5904\u7406\u90e8\u5206 JSON \u7247\u6bb5\uff0c \u5e76\u4fdd\u7559\u9ed8\u8ba4\u7684\u201c\u4ec5\u6d41\u5f0f\u8f93\u51fa\u52a9\u624b\u6587\u672c\u201d\u7684\u7b80\u6d01\u884c\u4e3a\u3002</p>"},{"location":"zh/model/#anthropic-model","title":"Anthropic Model","text":"<p>Anthropic Model \u7528\u4e8e\u5bf9\u63a5 Claude \u6a21\u578b\u53ca\u5176\u517c\u5bb9\u5e73\u53f0\uff0c\u652f\u6301\u6d41\u5f0f\u8f93\u51fa\u3001\u601d\u8003\u6a21\u5f0f\u4e0e\u5de5\u5177\u8c03\u7528\uff0c\u5e76\u63d0\u4f9b\u4e30\u5bcc\u7684\u56de\u8c03\u673a\u5236\uff0c\u540c\u65f6\u53ef\u7075\u6d3b\u8bbe\u7f6e\u81ea\u5b9a\u4e49 HTTP Header.</p>"},{"location":"zh/model/#_37","title":"\u914d\u7f6e\u65b9\u5f0f","text":""},{"location":"zh/model/#_38","title":"\u73af\u5883\u53d8\u91cf\u65b9\u5f0f","text":"<pre><code>export ANTHROPIC_API_KEY=\"your-api-key\"\nexport ANTHROPIC_BASE_URL=\"https://api.anthropic.com\" # \u53ef\u9009\u914d\u7f6e\uff0c\u9ed8\u8ba4\u4e3a\u6b64 BASE URL\n</code></pre>"},{"location":"zh/model/#_39","title":"\u4ee3\u7801\u65b9\u5f0f","text":"<pre><code>import \"trpc.group/trpc-go/trpc-agent-go/model/anthropic\"\n\nm := anthropic.New(\n    \"claude-sonnet-4-0\",\n    anthropic.WithAPIKey(\"your-api-key\"),\n    anthropic.WithBaseURL(\"https://api.anthropic.com\"), // \u53ef\u9009\u914d\u7f6e\uff0c\u9ed8\u8ba4\u4e3a\u6b64 BASE URL\n)\n</code></pre>"},{"location":"zh/model/#model_3","title":"\u76f4\u63a5\u4f7f\u7528 Model","text":"<pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/model\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/anthropic\"\n)\n\nfunc main() {\n    // \u521b\u5efa\u6a21\u578b\u5b9e\u4f8b\n    llm := anthropic.New(\"claude-sonnet-4-0\")\n    // \u6784\u5efa\u8bf7\u6c42\n    temperature := 0.7\n    maxTokens := 1000\n    request := &amp;model.Request{\n        Messages: []model.Message{\n            model.NewSystemMessage(\"\u4f60\u662f\u4e00\u4e2a\u4e13\u4e1a\u7684AI\u52a9\u624b\u3002\"),\n            model.NewUserMessage(\"\u4ecb\u7ecd\u4e00\u4e0bGo\u8bed\u8a00\u7684\u5e76\u53d1\u7279\u6027\u3002\"),\n        },\n        GenerationConfig: model.GenerationConfig{\n            Temperature: &amp;temperature,\n            MaxTokens:   &amp;maxTokens,\n            Stream:      false,\n        },\n    }\n    // \u8c03\u7528\u6a21\u578b\n    ctx := context.Background()\n    responseChan, err := llm.GenerateContent(ctx, request)\n    if err != nil {\n        fmt.Printf(\"\u7cfb\u7edf\u9519\u8bef: %v\\n\", err)\n        return\n    }\n    // \u5904\u7406\u54cd\u5e94\n    for response := range responseChan {\n        if response.Error != nil {\n            fmt.Printf(\"API\u9519\u8bef: %s\\n\", response.Error.Message)\n            return\n        }\n        if len(response.Choices) &gt; 0 {\n            fmt.Printf(\"\u56de\u590d: %s\\n\", response.Choices[0].Message.Content)\n        }\n        if response.Done {\n            break\n        }\n    }\n}\n</code></pre>"},{"location":"zh/model/#_40","title":"\u6d41\u5f0f\u8f93\u51fa","text":"<pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/model\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/anthropic\"\n)\n\nfunc main() {\n    // \u521b\u5efa\u6a21\u578b\u5b9e\u4f8b\n    llm := anthropic.New(\"claude-sonnet-4-0\")\n    // \u6d41\u5f0f\u8bf7\u6c42\u914d\u7f6e\n    temperature := 0.7\n    maxTokens := 1000\n    request := &amp;model.Request{\n        Messages: []model.Message{\n            model.NewSystemMessage(\"\u4f60\u662f\u4e00\u4e2a\u521b\u610f\u6545\u4e8b\u8bb2\u8ff0\u8005\u3002\"),\n            model.NewUserMessage(\"\u5199\u4e00\u4e2a\u5173\u4e8e\u673a\u5668\u4eba\u5b66\u4e60\u7ed8\u753b\u7684\u77ed\u6545\u4e8b\u3002\"),\n        },\n        GenerationConfig: model.GenerationConfig{\n            Temperature: &amp;temperature,\n            MaxTokens:   &amp;maxTokens,\n            Stream:      true,\n        },\n    }\n    // \u8c03\u7528\u6a21\u578b\n    ctx := context.Background()\n    // \u5904\u7406\u6d41\u5f0f\u54cd\u5e94\n    responseChan, err := llm.GenerateContent(ctx, request)\n    if err != nil {\n        fmt.Printf(\"\u7cfb\u7edf\u9519\u8bef: %v\\n\", err)\n        return\n    }\n    for response := range responseChan {\n        if response.Error != nil {\n            fmt.Printf(\"\u9519\u8bef: %s\", response.Error.Message)\n            return\n        }\n        if len(response.Choices) &gt; 0 &amp;&amp; response.Choices[0].Delta.Content != \"\" {\n            fmt.Print(response.Choices[0].Delta.Content)\n        }\n        if response.Done {\n            break\n        }\n    }\n}\n</code></pre>"},{"location":"zh/model/#_41","title":"\u9ad8\u7ea7\u53c2\u6570\u914d\u7f6e","text":"<pre><code>// \u4f7f\u7528\u9ad8\u7ea7\u751f\u6210\u53c2\u6570\ntemperature := 0.3\nmaxTokens := 2000\ntopP := 0.9\nthinking := true\nthinkingTokens := 2048\n\nrequest := &amp;model.Request{\n    Messages: []model.Message{\n        model.NewSystemMessage(\"\u4f60\u662f\u4e00\u4e2a\u4e13\u4e1a\u7684\u6280\u672f\u6587\u6863\u64b0\u5199\u8005\u3002\"),\n        model.NewUserMessage(\"\u89e3\u91ca\u5fae\u670d\u52a1\u67b6\u6784\u7684\u4f18\u7f3a\u70b9\u3002\"),\n    },\n    GenerationConfig: model.GenerationConfig{\n        Temperature:     &amp;temperature,\n        MaxTokens:       &amp;maxTokens,\n        TopP:            &amp;topP,\n        ThinkingEnabled: &amp;thinking,\n        ThinkingTokens:  &amp;thinkingTokens,\n        Stream:          true,\n    },\n}\n</code></pre>"},{"location":"zh/model/#_42","title":"\u9ad8\u7ea7\u529f\u80fd","text":""},{"location":"zh/model/#1_1","title":"1. \u56de\u8c03\u51fd\u6570","text":"<pre><code>import (\n    anthropicsdk \"github.com/anthropics/anthropic-sdk-go\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/anthropic\"\n)\n\nmodel := anthropic.New(\n    \"claude-sonnet-4-0\",\n    anthropic.WithChatRequestCallback(func(ctx context.Context, req *anthropicsdk.MessageNewParams) {\n        // Log request before sending.\n        log.Printf(\"sending request: model=%s, messages=%d.\", req.Model, len(req.Messages))\n    }),\n    anthropic.WithChatResponseCallback(func(ctx context.Context, req *anthropicsdk.MessageNewParams, resp *anthropicsdk.Message) {\n        // Log non-streaming response details.\n        log.Printf(\"received response: id=%s, input_tokens=%d, output_tokens=%d.\", resp.ID, resp.Usage.InputTokens, resp.Usage.OutputTokens)\n    }),\n    anthropic.WithChatChunkCallback(func(ctx context.Context, req *anthropicsdk.MessageNewParams, chunk *anthropicsdk.MessageStreamEventUnion) {\n        // Log streaming event type.\n        log.Printf(\"stream event: %T.\", chunk.AsAny())\n    }),\n    anthropic.WithChatStreamCompleteCallback(func(ctx context.Context, req *anthropicsdk.MessageNewParams, acc *anthropicsdk.Message, streamErr error) {\n        // Log stream completion or error.\n        if streamErr != nil {\n            log.Printf(\"stream failed: %v.\", streamErr)\n            return\n        }\n        log.Printf(\"stream completed: finish_reason=%s, input_tokens=%d, output_tokens=%d.\", acc.StopReason, acc.Usage.InputTokens, acc.Usage.OutputTokens)\n    }),\n)\n</code></pre>"},{"location":"zh/model/#2-model-switching_1","title":"2. \u6a21\u578b\u5207\u6362\uff08Model Switching\uff09","text":"<p>\u6a21\u578b\u5207\u6362\u5141\u8bb8\u5728\u8fd0\u884c\u65f6\u52a8\u6001\u66f4\u6362 Agent \u4f7f\u7528\u7684 LLM \u6a21\u578b\u3002\u6846\u67b6\u63d0\u4f9b\u4e24\u79cd\u65b9\u5f0f\uff1aAgent \u7ea7\u522b\u5207\u6362\uff08\u5f71\u54cd\u6240\u6709\u540e\u7eed\u8bf7\u6c42\uff09\u548c\u8bf7\u6c42\u7ea7\u522b\u5207\u6362\uff08\u4ec5\u5f71\u54cd\u5355\u6b21\u8bf7\u6c42\uff09\u3002</p>"},{"location":"zh/model/#agent_2","title":"Agent \u7ea7\u522b\u5207\u6362","text":"<p>Agent \u7ea7\u522b\u5207\u6362\u4f1a\u6539\u53d8 Agent \u7684\u9ed8\u8ba4\u6a21\u578b\uff0c\u5f71\u54cd\u6240\u6709\u540e\u7eed\u8bf7\u6c42\u3002</p>"},{"location":"zh/model/#_43","title":"\u65b9\u5f0f\u4e00\uff1a\u76f4\u63a5\u8bbe\u7f6e\u6a21\u578b\u5b9e\u4f8b","text":"<p>\u901a\u8fc7 <code>SetModel</code> \u65b9\u6cd5\u76f4\u63a5\u4f20\u5165\u6a21\u578b\u5b9e\u4f8b\uff1a</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/agent/llmagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/anthropic\"\n)\n\n// \u521b\u5efa Agent.\nagent := llmagent.New(\"my-agent\",\n    llmagent.WithModel(anthropic.New(\"claude-3-5-haiku-20241022\")),\n)\n\n// \u5207\u6362\u5230\u5176\u4ed6\u6a21\u578b.\nagent.SetModel(anthropic.New(\"claude-3-5-sonnet-20241022\"))\n</code></pre> <p>\u4f7f\u7528\u573a\u666f\uff1a</p> <pre><code>// \u6839\u636e\u4efb\u52a1\u590d\u6742\u5ea6\u9009\u62e9\u6a21\u578b.\nif isComplexTask {\n    agent.SetModel(anthropic.New(\"claude-3-5-sonnet-20241022\"))  // \u4f7f\u7528\u5f3a\u5927\u6a21\u578b.\n} else {\n    agent.SetModel(anthropic.New(\"claude-3-5-haiku-20241022\"))  // \u4f7f\u7528\u5feb\u901f\u6a21\u578b.\n}\n</code></pre>"},{"location":"zh/model/#_44","title":"\u65b9\u5f0f\u4e8c\uff1a\u6309\u540d\u79f0\u5207\u6362\u6a21\u578b","text":"<p>\u901a\u8fc7 <code>WithModels</code> \u9884\u6ce8\u518c\u591a\u4e2a\u6a21\u578b\uff0c\u7136\u540e\u4f7f\u7528 <code>SetModelByName</code> \u6309\u540d\u79f0\u5207\u6362\uff1a</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/agent/llmagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/model\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/anthropic\"\n)\n\n// \u521b\u5efa\u591a\u4e2a\u6a21\u578b\u5b9e\u4f8b.\nsonnet := anthropic.New(\"claude-3-5-sonnet-20241022\")\nhaiku := anthropic.New(\"claude-3-5-haiku-20241022\")\n\n// \u521b\u5efa Agent \u65f6\u6ce8\u518c\u6240\u6709\u6a21\u578b.\nagent := llmagent.New(\"my-agent\",\n    llmagent.WithModels(map[string]model.Model{\n        \"smart\": sonnet,\n        \"fast\":  haiku,\n    }),\n    llmagent.WithModel(haiku), // \u6307\u5b9a\u521d\u59cb\u6a21\u578b.\n    llmagent.WithInstruction(\"\u4f60\u662f\u4e00\u4e2a\u667a\u80fd\u52a9\u624b\u3002\"),\n)\n\n// \u8fd0\u884c\u65f6\u6309\u540d\u79f0\u5207\u6362\u6a21\u578b.\nerr := agent.SetModelByName(\"smart\")\nif err != nil {\n    log.Fatal(err)\n}\n\n// \u5207\u6362\u5230\u5176\u4ed6\u6a21\u578b.\nerr = agent.SetModelByName(\"fast\")\nif err != nil {\n    log.Fatal(err)\n}\n</code></pre> <p>\u4f7f\u7528\u573a\u666f\uff1a</p> <pre><code>// \u6839\u636e\u7528\u6237\u7b49\u7ea7\u9009\u62e9\u6a21\u578b.\nmodelName := \"fast\" // \u9ed8\u8ba4\u4f7f\u7528\u5feb\u901f\u6a21\u578b.\nif user.IsPremium() {\n    modelName = \"smart\" // \u4ed8\u8d39\u7528\u6237\u4f7f\u7528\u9ad8\u7ea7\u6a21\u578b.\n}\nif err := agent.SetModelByName(modelName); err != nil {\n    log.Printf(\"\u5207\u6362\u6a21\u578b\u5931\u8d25: %v\", err)\n}\n\n// \u6839\u636e\u65f6\u95f4\u6bb5\u9009\u62e9\u6a21\u578b\uff08\u6210\u672c\u4f18\u5316\uff09.\nhour := time.Now().Hour()\nif hour &gt;= 22 || hour &lt; 8 {\n    // \u591c\u95f4\u4f7f\u7528\u5feb\u901f\u6a21\u578b.\n    agent.SetModelByName(\"fast\")\n} else {\n    // \u767d\u5929\u4f7f\u7528\u667a\u80fd\u6a21\u578b.\n    agent.SetModelByName(\"smart\")\n}\n</code></pre>"},{"location":"zh/model/#_45","title":"\u8bf7\u6c42\u7ea7\u522b\u5207\u6362","text":"<p>\u8bf7\u6c42\u7ea7\u522b\u5207\u6362\u5141\u8bb8\u4e3a\u5355\u6b21\u8bf7\u6c42\u4e34\u65f6\u6307\u5b9a\u6a21\u578b\uff0c\u4e0d\u5f71\u54cd Agent \u7684\u9ed8\u8ba4\u6a21\u578b\u548c\u5176\u4ed6\u8bf7\u6c42\u3002\u8fd9\u5bf9\u4e8e\u9700\u8981\u9488\u5bf9\u7279\u5b9a\u4efb\u52a1\u4f7f\u7528\u4e0d\u540c\u6a21\u578b\u7684\u573a\u666f\u975e\u5e38\u6709\u7528\u3002</p>"},{"location":"zh/model/#withmodel_1","title":"\u65b9\u5f0f\u4e00\uff1a\u4f7f\u7528 WithModel \u9009\u9879","text":"<p>\u901a\u8fc7 <code>agent.WithModel</code> \u4e3a\u5355\u6b21\u8bf7\u6c42\u6307\u5b9a\u6a21\u578b\u5b9e\u4f8b\uff1a</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/agent\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/anthropic\"\n)\n\n// \u4e3a\u8fd9\u6b21\u8bf7\u6c42\u4f7f\u7528\u7279\u5b9a\u6a21\u578b.\neventChan, err := runner.Run(ctx, userID, sessionID, message,\n    agent.WithModel(anthropic.New(\"claude-3-5-sonnet-20241022\")),\n)\n</code></pre>"},{"location":"zh/model/#withmodelname_1","title":"\u65b9\u5f0f\u4e8c\uff1a\u4f7f\u7528 WithModelName \u9009\u9879\uff08\u63a8\u8350\uff09","text":"<p>\u901a\u8fc7 <code>agent.WithModelName</code> \u4e3a\u5355\u6b21\u8bf7\u6c42\u6307\u5b9a\u9884\u6ce8\u518c\u7684\u6a21\u578b\u540d\u79f0\uff1a</p> <pre><code>// \u521b\u5efa Agent \u65f6\u9884\u6ce8\u518c\u591a\u4e2a\u6a21\u578b.\nagent := llmagent.New(\"my-agent\",\n    llmagent.WithModels(map[string]model.Model{\n        \"smart\": anthropic.New(\"claude-3-5-sonnet-20241022\"),\n        \"fast\":  anthropic.New(\"claude-3-5-haiku-20241022\"),\n    }),\n    llmagent.WithModel(anthropic.New(\"claude-3-5-haiku-20241022\")), // \u9ed8\u8ba4\u6a21\u578b.\n)\n\nrunner := runner.NewRunner(\"app\", agent)\n\n// \u4e3a\u8fd9\u6b21\u8bf7\u6c42\u4e34\u65f6\u4f7f\u7528 \"smart\" \u6a21\u578b.\neventChan, err := runner.Run(ctx, userID, sessionID, message,\n    agent.WithModelName(\"smart\"),\n)\n\n// \u4e0b\u4e00\u6b21\u8bf7\u6c42\u4ecd\u7136\u4f7f\u7528\u9ed8\u8ba4\u6a21\u578b \"claude-3-5-haiku-20241022\".\neventChan2, err := runner.Run(ctx, userID, sessionID, message2)\n</code></pre> <p>\u4f7f\u7528\u573a\u666f\uff1a</p> <pre><code>// \u6839\u636e\u6d88\u606f\u590d\u6742\u5ea6\u52a8\u6001\u9009\u62e9\u6a21\u578b.\nvar opts []agent.RunOption\nif isComplexQuery(message) {\n    opts = append(opts, agent.WithModelName(\"smart\")) // \u590d\u6742\u67e5\u8be2\u4f7f\u7528\u5f3a\u5927\u6a21\u578b.\n}\n\neventChan, err := runner.Run(ctx, userID, sessionID, message, opts...)\n\n// \u4e3a\u7279\u5b9a\u4efb\u52a1\u4f7f\u7528\u4e13\u95e8\u7684\u6a21\u578b.\neventChan, err := runner.Run(ctx, userID, sessionID, visionMessage,\n    agent.WithModelName(\"vision\"),\n)\n</code></pre>"},{"location":"zh/model/#_46","title":"\u914d\u7f6e\u8bf4\u660e","text":"<p>WithModels \u9009\u9879\uff1a</p> <ul> <li>\u63a5\u53d7\u4e00\u4e2a <code>map[string]model.Model</code>\uff0ckey \u4e3a\u6a21\u578b\u540d\u79f0\uff0cvalue \u4e3a\u6a21\u578b\u5b9e\u4f8b</li> <li>\u5982\u679c\u540c\u65f6\u8bbe\u7f6e\u4e86 <code>WithModel</code> \u548c <code>WithModels</code>\uff0c<code>WithModel</code> \u6307\u5b9a\u521d\u59cb\u6a21\u578b</li> <li>\u5982\u679c\u53ea\u8bbe\u7f6e\u4e86 <code>WithModels</code>\uff0c\u5c06\u4f7f\u7528 map \u4e2d\u7684\u7b2c\u4e00\u4e2a\u6a21\u578b\u4f5c\u4e3a\u521d\u59cb\u6a21\u578b\uff08\u6ce8\u610f\uff1amap \u904d\u5386\u987a\u5e8f\u4e0d\u786e\u5b9a\uff0c\u5efa\u8bae\u660e\u786e\u6307\u5b9a\u521d\u59cb\u6a21\u578b\uff09</li> <li>\u4fdd\u7559\u540d\u79f0\uff1a<code>__default__</code> \u662f\u6846\u67b6\u5185\u90e8\u4f7f\u7528\u7684\u4fdd\u7559\u540d\u79f0\uff0c\u5efa\u8bae\u4e0d\u8981\u4f7f\u7528</li> </ul> <p>SetModelByName \u65b9\u6cd5\uff1a</p> <ul> <li>\u53c2\u6570\uff1a\u6a21\u578b\u540d\u79f0\uff08\u5b57\u7b26\u4e32\uff09</li> <li>\u8fd4\u56de\uff1a\u5982\u679c\u6a21\u578b\u540d\u79f0\u4e0d\u5b58\u5728\uff0c\u8fd4\u56de\u9519\u8bef</li> <li>\u6a21\u578b\u5fc5\u987b\u662f\u901a\u8fc7 <code>WithModels</code> \u9884\u5148\u6ce8\u518c\u7684</li> </ul> <p>\u8bf7\u6c42\u7ea7\u522b\u9009\u9879\uff1a</p> <ul> <li><code>agent.RunOptions.Model</code>\uff1a\u76f4\u63a5\u6307\u5b9a\u6a21\u578b\u5b9e\u4f8b</li> <li><code>agent.RunOptions.ModelName</code>\uff1a\u6307\u5b9a\u9884\u6ce8\u518c\u7684\u6a21\u578b\u540d\u79f0</li> <li>\u4f18\u5148\u7ea7\uff1a<code>Model</code> &gt; <code>ModelName</code> &gt; Agent \u9ed8\u8ba4\u6a21\u578b</li> <li>\u5982\u679c <code>ModelName</code> \u6307\u5b9a\u7684\u6a21\u578b\u4e0d\u5b58\u5728\uff0c\u5c06\u56de\u9000\u5230 Agent \u9ed8\u8ba4\u6a21\u578b</li> </ul>"},{"location":"zh/model/#agent-vs_1","title":"Agent \u7ea7\u522b vs \u8bf7\u6c42\u7ea7\u522b\u5bf9\u6bd4","text":"\u7279\u6027 Agent \u7ea7\u522b\u5207\u6362 \u8bf7\u6c42\u7ea7\u522b\u5207\u6362 \u5f71\u54cd\u8303\u56f4 \u6240\u6709\u540e\u7eed\u8bf7\u6c42 \u4ec5\u5f53\u524d\u8bf7\u6c42 \u4f7f\u7528\u65b9\u5f0f <code>SetModel</code>/<code>SetModelByName</code> <code>RunOptions.Model</code>/<code>ModelName</code> \u72b6\u6001\u53d8\u5316 \u6539\u53d8 Agent \u9ed8\u8ba4\u6a21\u578b \u4e0d\u6539\u53d8 Agent \u72b6\u6001 \u9002\u7528\u573a\u666f \u5168\u5c40\u7b56\u7565\u8c03\u6574 \u7279\u5b9a\u4efb\u52a1\u4e34\u65f6\u9700\u6c42 \u5e76\u53d1\u5f71\u54cd \u5f71\u54cd\u6240\u6709\u5e76\u53d1\u8bf7\u6c42 \u4e0d\u5f71\u54cd\u5176\u4ed6\u8bf7\u6c42 \u5178\u578b\u7528\u4f8b \u7528\u6237\u7b49\u7ea7\u3001\u65f6\u95f4\u6bb5\u7b56\u7565 \u590d\u6742\u67e5\u8be2\u3001\u63a8\u7406\u4efb\u52a1"},{"location":"zh/model/#agent_3","title":"Agent \u7ea7\u522b\u5207\u6362\u65b9\u5f0f\u5bf9\u6bd4","text":"\u7279\u6027 SetModel SetModelByName \u4f7f\u7528\u65b9\u5f0f \u4f20\u5165\u6a21\u578b\u5b9e\u4f8b \u4f20\u5165\u6a21\u578b\u540d\u79f0 \u9884\u6ce8\u518c \u4e0d\u9700\u8981 \u9700\u8981\u901a\u8fc7 WithModels \u9519\u8bef\u5904\u7406 \u65e0 \u8fd4\u56de error \u9002\u7528\u573a\u666f \u7b80\u5355\u5207\u6362 \u590d\u6742\u573a\u666f\uff0c\u591a\u6a21\u578b\u7ba1\u7406 \u4ee3\u7801\u7ef4\u62a4 \u9700\u8981\u6301\u6709\u6a21\u578b\u5b9e\u4f8b \u53ea\u9700\u8981\u8bb0\u4f4f\u540d\u79f0"},{"location":"zh/model/#_47","title":"\u91cd\u8981\u8bf4\u660e","text":"<p>Agent \u7ea7\u522b\u5207\u6362\uff1a</p> <ul> <li>\u5373\u65f6\u751f\u6548\uff1a\u8c03\u7528 <code>SetModel</code> \u6216 <code>SetModelByName</code> \u540e\uff0c\u4e0b\u4e00\u6b21\u8bf7\u6c42\u7acb\u5373\u4f7f\u7528\u65b0\u6a21\u578b</li> <li>\u4f1a\u8bdd\u4fdd\u6301\uff1a\u5207\u6362\u6a21\u578b\u4e0d\u4f1a\u6e05\u9664\u4f1a\u8bdd\u5386\u53f2</li> <li>\u914d\u7f6e\u72ec\u7acb\uff1a\u6bcf\u4e2a\u6a21\u578b\u4fdd\u7559\u81ea\u5df1\u7684\u914d\u7f6e\uff08\u6e29\u5ea6\u3001\u6700\u5927 token \u7b49\uff09</li> <li>\u5e76\u53d1\u5b89\u5168\uff1a\u4e24\u79cd\u5207\u6362\u65b9\u5f0f\u90fd\u662f\u5e76\u53d1\u5b89\u5168\u7684</li> </ul> <p>\u8bf7\u6c42\u7ea7\u522b\u5207\u6362\uff1a</p> <ul> <li>\u4e34\u65f6\u8986\u76d6\uff1a\u4ec5\u5f71\u54cd\u5f53\u524d\u8bf7\u6c42\uff0c\u4e0d\u6539\u53d8 Agent \u7684\u9ed8\u8ba4\u6a21\u578b</li> <li>\u4f18\u5148\u7ea7\u9ad8\uff1a\u8bf7\u6c42\u7ea7\u522b\u7684\u6a21\u578b\u8bbe\u7f6e\u4f18\u5148\u4e8e Agent \u9ed8\u8ba4\u6a21\u578b</li> <li>\u65e0\u526f\u4f5c\u7528\uff1a\u4e0d\u5f71\u54cd\u5176\u4ed6\u5e76\u53d1\u8bf7\u6c42\u6216\u540e\u7eed\u8bf7\u6c42</li> <li>\u7075\u6d3b\u7ec4\u5408\uff1a\u53ef\u4ee5\u4e0e Agent \u7ea7\u522b\u5207\u6362\u914d\u5408\u4f7f\u7528</li> </ul>"},{"location":"zh/model/#_48","title":"\u4f7f\u7528\u793a\u4f8b","text":"<p>\u5b8c\u6574\u7684\u4ea4\u4e92\u5f0f\u793a\u4f8b\u8bf7\u53c2\u8003 examples/model/switch\uff0c\u8be5\u793a\u4f8b\u6f14\u793a\u4e86 Agent \u7ea7\u522b\u548c\u8bf7\u6c42\u7ea7\u522b\u4e24\u79cd\u5207\u6362\u65b9\u5f0f\u3002</p>"},{"location":"zh/model/#3-http-header","title":"3. \u81ea\u5b9a\u4e49 HTTP Header","text":"<p>\u5728\u7f51\u5173\u3001\u4e13\u6709\u5e73\u53f0\u6216\u4ee3\u7406\u73af\u5883\u4e2d\uff0c\u8bf7\u6c42\u6a21\u578b API \u5f80\u5f80\u9700\u8981\u989d\u5916\u7684 HTTP Header\uff08\u4f8b\u5982\u7ec4\u7ec7/\u79df\u6237\u6807\u8bc6\u3001\u7070\u5ea6\u8def\u7531\u3001\u81ea\u5b9a\u4e49\u9274\u6743\u7b49\uff09\u3002Model \u6a21\u5757\u63d0\u4f9b\u4e24\u79cd\u53ef\u9760\u65b9\u5f0f\u4e3a\u201c\u6240\u6709\u6a21\u578b\u8bf7\u6c42\u201d\u6dfb\u52a0 Header\uff0c\u9002\u7528\u4e8e\u666e\u901a\u8bf7\u6c42\u3001\u6d41\u5f0f\u3001\u6587\u4ef6\u4e0a\u4f20\u3001\u6279\u5904\u7406\u7b49\u5168\u94fe\u8def\u3002</p> <p>\u63a8\u8350\u987a\u5e8f\uff1a</p> <ul> <li>\u901a\u8fc7 <code>anthropic.WithHeaders</code> \u5feb\u901f\u8ffd\u52a0\u9759\u6001 Header\uff08\u7b80\u4fbf\uff09</li> <li>\u901a\u8fc7 Anthropic RequestOption \u8bbe\u7f6e\u5168\u5c40 Header\uff08\u7075\u6d3b\u3001\u53ef\u7ec4\u5408\u4e2d\u95f4\u4ef6\uff09</li> <li>\u901a\u8fc7\u81ea\u5b9a\u4e49 <code>http.RoundTripper</code> \u6ce8\u5165\uff08\u8fdb\u9636\u3001\u6a2a\u5207\u80fd\u529b\u66f4\u5f3a\uff09</li> </ul> <p>\u4e0a\u8ff0\u4e09\u79cd\u65b9\u5f0f\u540c\u6837\u5f71\u54cd\u6d41\u5f0f\u8bf7\u6c42\uff0c\u56e0\u4e3a\u5e95\u5c42\u4f7f\u7528\u7684\u662f\u540c\u4e00\u4e2a\u5ba2\u6237\u7aef\uff0c</p>"},{"location":"zh/model/#1-anthropicwithheaders-header","title":"1. \u4f7f\u7528 anthropic.WithHeaders \u8ffd\u52a0 Header","text":"<pre><code>import \"trpc.group/trpc-go/trpc-agent-go/model/anthropic\"\n\nllm := anthropic.New(\"claude-sonnet-4-0\",\n    anthropic.WithHeaders(map[string]string{\n        \"X-Custom-Header\": \"custom-value\",\n        \"X-Request-ID\":    \"req-123\",\n    }),\n)\n</code></pre>"},{"location":"zh/model/#2-anthropic-requestoption-header","title":"2. \u4f7f\u7528 Anthropic RequestOption \u8bbe\u7f6e\u5168\u5c40 Header","text":"<p>\u901a\u8fc7 <code>WithAnthropicClientOptions</code> \u914d\u5408 <code>anthropicopt.WithHeader</code> \u6216 <code>anthropicopt.WithMiddleware</code>\uff0c\u53ef\u4e3a\u5e95\u5c42 Anthropic \u5ba2\u6237\u7aef\u53d1\u8d77\u7684\u6bcf\u4e2a\u8bf7\u6c42\u6ce8\u5165 Header\u3002</p> <pre><code>import (\n    anthropicopt \"github.com/anthropics/anthropic-sdk-go/option\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/anthropic\"\n)\n\nllm := anthropic.New(\"claude-sonnet-4-0\",\n    // \u82e5\u4f60\u7684\u5e73\u53f0\u8981\u6c42\u989d\u5916\u5934\u90e8\n    anthropic.WithAnthropicClientOptions(\n        anthropicopt.WithHeader(\"X-Custom-Header\", \"custom-value\"),\n        anthropicopt.WithHeader(\"X-Request-ID\", \"req-123\"),\n        // \u4e5f\u53ef\u8bbe\u7f6e User-Agent \u6216\u5382\u5546\u7279\u5b9a\u5934\n        anthropicopt.WithHeader(\"User-Agent\", \"trpc-agent-go/1.0\"),\n    ),\n)\n</code></pre> <p>\u82e5\u9700\u8981\u6309\u6761\u4ef6\u8bbe\u7f6e\uff08\u4f8b\u5982\u4ec5\u5bf9\u67d0\u4e9b\u8def\u5f84\u6216\u4f9d\u8d56\u8c03\u7528\u4e0a\u4e0b\u6587\u503c\uff09\uff0c\u53ef\u4f7f\u7528\u4e2d\u95f4\u4ef6\uff1a</p> <pre><code>import (\n    anthropicopt \"github.com/anthropics/anthropic-sdk-go/option\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/anthropic\"\n)\n\nllm := anthropic.New(\"claude-sonnet-4-0\",\n    anthropic.WithAnthropicClientOptions(\n        anthropicopt.WithMiddleware(\n            func(r *http.Request, next anthropicopt.MiddlewareNext) (*http.Response, error) {\n                // \u4f8b\uff1a\u6309\u4e0a\u4e0b\u6587\u503c\u8bbe\u7f6e\"\u6bcf\u6b21\u8bf7\u6c42\"\u7684\u5934\u90e8\n                if v := r.Context().Value(\"x-request-id\"); v != nil {\n                    if s, ok := v.(string); ok &amp;&amp; s != \"\" {\n                        r.Header.Set(\"X-Request-ID\", s)\n                    }\n                }\n                // \u6216\u4ec5\u5bf9\u5bf9\u8bdd\u8865\u5168\u63a5\u53e3\u751f\u6548\n                if strings.Contains(r.URL.Path, \"v1/messages\") {\n                    r.Header.Set(\"X-Feature-Flag\", \"on\")\n                }\n                return next(r)\n            },\n        ),\n    ),\n)\n</code></pre>"},{"location":"zh/model/#3-httproundtripper_1","title":"3. \u4f7f\u7528\u81ea\u5b9a\u4e49 http.RoundTripper","text":"<p>\u5728 HTTP \u4f20\u8f93\u5c42\u7edf\u4e00\u6ce8\u5165 Header\uff0c\u9002\u5408\u540c\u65f6\u9700\u8981\u4ee3\u7406\u3001TLS\u3001\u81ea\u5b9a\u4e49\u76d1\u63a7\u7b49\u80fd\u529b\u7684\u573a\u666f\u3002</p> <pre><code>import (\n    anthropicopt \"github.com/anthropics/anthropic-sdk-go/option\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/anthropic\"\n)\n\ntype headerRoundTripper struct{ base http.RoundTripper }\n\nfunc (rt headerRoundTripper) RoundTrip(req *http.Request) (*http.Response, error) {\n    // \u6dfb\u52a0\u6216\u8986\u76d6\u5934\u90e8\n    req.Header.Set(\"X-Custom-Header\", \"custom-value\")\n    req.Header.Set(\"X-Trace-ID\", \"trace-xyz\")\n    return rt.base.RoundTrip(req)\n}\n\nllm := anthropic.New(\"claude-sonnet-4-0\",\n    anthropic.WithHTTPClientOptions(\n        anthropic.WithHTTPClientTransport(headerRoundTripper{base: http.DefaultTransport}),\n    ),\n)\n</code></pre> <p>\u5173\u4e8e\u201c\u6bcf\u6b21\u8bf7\u6c42\u201d\u7684\u5934\u90e8\uff1a</p> <ul> <li>Agent/Runner \u4f1a\u628a <code>ctx</code> \u900f\u4f20\u81f3\u6a21\u578b\u8c03\u7528\uff1b\u4e2d\u95f4\u4ef6\u53ef\u4ece <code>req.Context()</code> \u8bfb\u53d6\u503c\uff0c\u4ece\u800c\u4e3a\u201c\u672c\u6b21\u8c03\u7528\u201d\u6ce8\u5165\u5934\u90e8\u3002</li> <li>\u5bf9\u201c\u5bf9\u8bdd\u8865\u5168\u201d\u800c\u8a00\uff0c\u76ee\u524d\u672a\u66b4\u9732\u5355\u6b21\u8c03\u7528\u7ea7\u522b\u7684 BaseURL \u8986\u76d6\uff1b\u5982\u9700\u5207\u6362\uff0c\u8bf7\u65b0\u5efa\u4e00\u4e2a\u4f7f\u7528\u4e0d\u540c BaseURL \u7684\u6a21\u578b\uff0c\u6216\u5728\u4e2d\u95f4\u4ef6\u4e2d\u4fee\u6539 <code>r.URL</code>\u3002</li> </ul>"},{"location":"zh/model/#4-token-token-tailoring","title":"4. Token \u88c1\u526a\uff08Token Tailoring\uff09","text":"<p>Anthropic \u6a21\u578b\u540c\u6837\u652f\u6301 Token \u88c1\u526a\u529f\u80fd\uff0c\u7528\u4e8e\u5728\u6d88\u606f\u8d85\u51fa\u6a21\u578b\u4e0a\u4e0b\u6587\u7a97\u53e3\u9650\u5236\u65f6\u81ea\u52a8\u88c1\u526a\u6d88\u606f\uff0c\u786e\u4fdd\u8bf7\u6c42\u80fd\u591f\u6210\u529f\u53d1\u9001\u5230 LLM API\u3002</p> <p>\u81ea\u52a8\u6a21\u5f0f\uff08\u63a8\u8350\uff09\uff1a</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/model/anthropic\"\n)\n\n// \u53ea\u9700\u542f\u7528 token tailoring\uff0c\u5176\u4ed6\u53c2\u6570\u81ea\u52a8\u914d\u7f6e\nmodel := anthropic.New(\"claude-3-5-sonnet\",\n    anthropic.WithEnableTokenTailoring(true),\n)\n</code></pre> <p>\u9ad8\u7ea7\u6a21\u5f0f\uff1a</p> <pre><code>// \u81ea\u5b9a\u4e49 token \u9650\u5236\u548c\u7b56\u7565\nmodel := anthropic.New(\"claude-3-5-sonnet\",\n    anthropic.WithEnableTokenTailoring(true),               // \u5fc5\u9700\uff1a\u542f\u7528 token tailoring\n    anthropic.WithMaxInputTokens(10000),                    // \u81ea\u5b9a\u4e49 token \u9650\u5236\n    anthropic.WithTokenCounter(customCounter),              // \u53ef\u9009\uff1a\u81ea\u5b9a\u4e49\u8ba1\u6570\u5668\n    anthropic.WithTailoringStrategy(customStrategy),        // \u53ef\u9009\uff1a\u81ea\u5b9a\u4e49\u7b56\u7565\n)\n</code></pre> <p>\u5173\u4e8e Token \u8ba1\u7b97\u516c\u5f0f\u3001\u88c1\u526a\u7b56\u7565\u548c\u81ea\u5b9a\u4e49\u7b56\u7565\u7684\u8be6\u7ec6\u8bf4\u660e\uff0c\u8bf7\u53c2\u8003 OpenAI Model \u7684 Token \u88c1\u526a\u90e8\u5206\u3002</p>"},{"location":"zh/model/#provider","title":"Provider","text":"<p>\u968f\u7740\u591a\u4e2a\u5927\u6a21\u578b\u4f9b\u5e94\u5546\u7684\u51fa\u73b0\uff0c\u4e00\u4e9b\u4f9b\u5e94\u5546\u5b9a\u4e49\u4e86\u5404\u81ea\u7684 API \u89c4\u8303\u3002\u76ee\u524d\uff0c\u6846\u67b6\u5df2\u63a5\u5165 OpenAI \u548c Anthropic \u7684 API\uff0c\u5e76\u4ee5 Model \u7684\u5f62\u5f0f\u63d0\u4f9b\uff0c\u7528\u6237\u53ef\u4ee5\u901a\u8fc7 <code>openai.New</code> \u548c <code>anthropic.New</code> \u6765\u4f7f\u7528\u4e0d\u540c\u4f9b\u5e94\u5546\u7684\u6a21\u578b\u3002</p> <p>\u7136\u800c\uff0c\u4e0d\u540c\u4f9b\u5e94\u5546\u5728\u5b9e\u4f8b\u5316\u65b9\u5f0f\u548c\u914d\u7f6e\u9879\u4e0a\u5b58\u5728\u5dee\u5f02\uff0c\u5f00\u53d1\u8005\u5728\u5207\u6362\u4f9b\u5e94\u5546\u65f6\u5f80\u5f80\u9700\u8981\u4fee\u6539\u5927\u91cf\u4ee3\u7801\uff0c\u589e\u52a0\u4e86\u5207\u6362\u6210\u672c\u3002</p> <p>\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e00\u95ee\u9898\uff0cProvider \u63d0\u4f9b\u4e86\u4e00\u4e2a\u7edf\u4e00\u7684\u6a21\u578b\u5b9e\u4f8b\u5316\u5165\u53e3\u3002\u5f00\u53d1\u8005\u53ea\u9700\u6307\u5b9a\u4f9b\u5e94\u5546\u548c\u6a21\u578b\u540d\u79f0\uff0c\u5176\u4ed6\u914d\u7f6e\u9879\u901a\u8fc7\u7edf\u4e00\u7684 <code>Option</code> \u7ba1\u7406\uff0c\u4ece\u800c\u7b80\u5316\u4e86\u4f9b\u5e94\u5546\u5207\u6362\u7684\u590d\u6742\u5ea6\u3002</p> <p>Provider \u652f\u6301\u4ee5\u4e0b <code>Option</code>\uff1a</p> Option \u8bf4\u660e <code>WithAPIKey</code> / <code>WithBaseURL</code> \u8bbe\u7f6e\u6a21\u578b\u7684 API Key \u548c Base URL <code>WithHTTPClientName</code> / <code>WithHTTPClientTransport</code> \u914d\u7f6e HTTP \u5ba2\u6237\u7aef\u5c5e\u6027 <code>WithHeaders</code> \u8ffd\u52a0 HTTP Header <code>WithChannelBufferSize</code> \u8c03\u6574\u54cd\u5e94 channel \u7f13\u51b2\u533a\u5bb9\u91cf <code>WithCallbacks</code> \u914d\u7f6e OpenAI / Anthropic \u7684\u8bf7\u6c42\u3001\u54cd\u5e94\u3001\u6d41\u5f0f\u56de\u8c03 <code>WithExtraFields</code> \u914d\u7f6e\u8bf7\u6c42\u4f53\u81ea\u5b9a\u4e49\u5b57\u6bb5 <code>WithEnableTokenTailoring</code> / <code>WithMaxInputTokens</code><code>WithTokenCounter</code> / <code>WithTailoringStrategy</code> Token \u88c1\u526a\u76f8\u5173\u53c2\u6570 <code>WithTokenTailoringConfig</code> \u9ad8\u7ea7\u914d\u7f6e\uff1a\u81ea\u5b9a\u4e49 token \u88c1\u526a\u9884\u7b97\u53c2\u6570 <code>WithOpenAIOption</code> / <code>WithAnthropicOption</code> \u900f\u4f20\u4f9b\u5e94\u5546\u539f\u751f Option"},{"location":"zh/model/#_49","title":"\u4f7f\u7528\u793a\u4f8b","text":"<pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/agent/llmagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/provider\"\n)\n\nproviderName := \"openai\"        // provider \u652f\u6301 openai \u548c anthropic.\nmodelName := \"deepseek-chat\"\n\nmodelInstance, err := provider.Model(\n    providerName,\n    modelName,\n    provider.WithAPIKey(c.apiKey),\n    provider.WithBaseURL(c.baseURL),\n    provider.WithChannelBufferSize(c.channelBufferSize),\n    provider.WithEnableTokenTailoring(c.tokenTailoring),\n    provider.WithMaxInputTokens(c.maxInputTokens),\n    provider.WithHeaders(map[string]string{\n        \"X-Custom-Header\": \"custom-value\",\n        \"X-Request-ID\":    \"req-123\",\n    }),\n)\n\nagent := llmagent.New(\"chat-assistant\", llmagent.WithModel(modelInstance))\n</code></pre> <p>\u9ad8\u7ea7\u914d\u7f6e\uff1a\u4f7f\u7528 TokenTailoringConfig\uff1a</p> <p>\u5bf9\u4e8e\u9700\u8981\u7cbe\u7ec6\u8c03\u6574 token \u5206\u914d\u7b56\u7565\u7684\u9ad8\u7ea7\u7528\u6237\uff0c\u53ef\u4ee5\u4f7f\u7528 <code>WithTokenTailoringConfig</code>\uff1a</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/model\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/provider\"\n)\n\n// \u4e3a\u6240\u6709 provider \u81ea\u5b9a\u4e49 token \u88c1\u526a\u9884\u7b97\u53c2\u6570\nconfig := &amp;model.TokenTailoringConfig{\n    ProtocolOverheadTokens: 1024,\n    ReserveOutputTokens:    4096,\n    SafetyMarginRatio:      0.15,\n}\n\nmodelInstance, err := provider.Model(\n    \"openai\",\n    \"deepseek-chat\",\n    provider.WithAPIKey(c.apiKey),\n    provider.WithEnableTokenTailoring(true),\n    provider.WithTokenTailoringConfig(config),\n)\n</code></pre> <p>\u5b8c\u6574\u4ee3\u7801\u53ef\u53c2\u89c1 examples/provider\u3002</p>"},{"location":"zh/model/#provider_1","title":"\u6ce8\u518c\u81ea\u5b9a\u4e49 Provider","text":"<p>\u6846\u67b6\u652f\u6301\u901a\u8fc7\u6ce8\u518c\u81ea\u5b9a\u4e49 Provider \u6765\u63a5\u5165\u5176\u4ed6\u5927\u6a21\u578b\u4f9b\u5e94\u5546\u6216\u81ea\u5b9a\u4e49\u5b9e\u73b0\u7684\u6a21\u578b\u3002</p> <p>\u901a\u8fc7 <code>provider.Register</code> \u53ef\u4ee5\u5b9a\u4e49\u6839\u636e Options \u521b\u5efa\u81ea\u5b9a\u4e49\u6a21\u578b\u5b9e\u4f8b\u7684\u65b9\u6cd5\u3002</p> <pre><code>import \"trpc.group/trpc-go/trpc-agent-go/model/provider\"\n\nprovider.Register(\"custom-provider\", func(opts *provider.Options) (model.Model, error) {\n    return newCustomModel(opts.ModelName, WithAPIKey(opts.APIKey)), nil\n})\n\ncustomModel, err := provider.Model(\"custom-provider\", \"custom-model\")\n</code></pre>"},{"location":"zh/multiagent/","title":"\u591a Agent \u7cfb\u7edf (Multi-Agent System)","text":"<p>\u591a Agent \u7cfb\u7edf\u662f trpc-agent-go \u6846\u67b6\u7684\u6838\u5fc3\u529f\u80fd\u4e4b\u4e00\uff0c\u5141\u8bb8\u60a8\u521b\u5efa\u7531\u591a\u4e2a\u4e13\u95e8\u5316 Agent \u7ec4\u6210\u7684\u590d\u6742\u7cfb\u7edf\u3002\u8fd9\u4e9b Agent \u53ef\u4ee5\u4ee5\u4e0d\u540c\u7684\u65b9\u5f0f\u534f\u4f5c\uff0c\u5b9e\u73b0\u4ece\u7b80\u5355\u5230\u590d\u6742\u7684\u5404\u79cd\u5e94\u7528\u573a\u666f\u3002</p>"},{"location":"zh/multiagent/#_1","title":"\u6982\u8ff0","text":"<p>\u591a Agent \u7cfb\u7edf\u57fa\u4e8e SubAgent \u6982\u5ff5\u6784\u5efa\uff0c\u901a\u8fc7 <code>WithSubAgents</code> option \u5b9e\u73b0\u5404\u79cd\u534f\u4f5c\u6a21\u5f0f\uff1a</p>"},{"location":"zh/multiagent/#_2","title":"\u57fa\u7840\u6982\u5ff5","text":"<ul> <li>SubAgent - \u901a\u8fc7 <code>WithSubAgents</code> option \u914d\u7f6e\u7684\u4e13\u95e8\u5316 Agent\uff0c\u662f\u6784\u5efa\u590d\u6742\u534f\u4f5c\u6a21\u5f0f\u7684\u57fa\u7840</li> </ul>"},{"location":"zh/multiagent/#_3","title":"\u6838\u5fc3\u534f\u4f5c\u6a21\u5f0f","text":"<ol> <li>\u94fe\u5f0f Agent (ChainAgent) - \u4f7f\u7528 SubAgent \u6309\u987a\u5e8f\u6267\u884c\uff0c\u5f62\u6210\u5904\u7406\u6d41\u6c34\u7ebf</li> <li>\u5e76\u884c Agent (ParallelAgent) - \u4f7f\u7528 SubAgent \u540c\u65f6\u5904\u7406\u540c\u4e00\u8f93\u5165\u7684\u4e0d\u540c\u65b9\u9762</li> <li>\u5faa\u73af Agent (CycleAgent) - \u4f7f\u7528 SubAgent \u5728\u5faa\u73af\u4e2d\u8fed\u4ee3\uff0c\u76f4\u5230\u6ee1\u8db3\u7279\u5b9a\u6761\u4ef6</li> </ol>"},{"location":"zh/multiagent/#_4","title":"\u8f85\u52a9\u529f\u80fd","text":"<ul> <li>Agent \u5de5\u5177 (AgentTool) - \u5c06 Agent \u5305\u88c5\u6210\u5de5\u5177\uff0c\u4f9b\u5176\u4ed6 Agent \u8c03\u7528</li> <li>Agent \u59d4\u6258 (Agent Transfer) - \u901a\u8fc7 <code>transfer_to_agent</code> \u5de5\u5177\u5b9e\u73b0 Agent \u95f4\u7684\u4efb\u52a1\u59d4\u6258</li> </ul>"},{"location":"zh/multiagent/#subagent","title":"SubAgent \u57fa\u7840","text":"<p>SubAgent \u662f\u591a Agent \u7cfb\u7edf\u7684\u6838\u5fc3\u6982\u5ff5\uff0c\u901a\u8fc7 <code>WithSubAgents</code> option \u5b9e\u73b0\u3002\u5b83\u5141\u8bb8\u60a8\u5c06\u591a\u4e2a\u4e13\u95e8\u5316\u7684 Agent \u7ec4\u5408\u5728\u4e00\u8d77\uff0c\u6784\u5efa\u590d\u6742\u7684\u534f\u4f5c\u6a21\u5f0f\u3002</p>"},{"location":"zh/multiagent/#subagent_1","title":"SubAgent \u7684\u4f5c\u7528","text":"<ul> <li>\u4e13\u4e1a\u5316\u5206\u5de5\uff1a\u6bcf\u4e2a SubAgent \u4e13\u6ce8\u4e8e\u7279\u5b9a\u9886\u57df\u6216\u4efb\u52a1\u7c7b\u578b</li> <li>\u6a21\u5757\u5316\u8bbe\u8ba1\uff1a\u5c06\u590d\u6742\u7cfb\u7edf\u5206\u89e3\u4e3a\u53ef\u7ba1\u7406\u7684\u7ec4\u4ef6</li> <li>\u7075\u6d3b\u7ec4\u5408\uff1a\u53ef\u4ee5\u6839\u636e\u9700\u8981\u7ec4\u5408\u4e0d\u540c\u7684 SubAgent</li> <li>\u7edf\u4e00\u63a5\u53e3\uff1a\u6240\u6709\u534f\u4f5c\u6a21\u5f0f\u90fd\u57fa\u4e8e\u76f8\u540c\u7684 <code>WithSubAgents</code> \u673a\u5236</li> </ul>"},{"location":"zh/multiagent/#_5","title":"\u57fa\u672c\u7528\u6cd5","text":"<pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/agent\"\n    \"trpc.group/trpc-go/trpc-agent-go/agent/llmagent\"\n)\n\n// \u521b\u5efa SubAgent\nmathAgent := llmagent.New(\n    \"math-agent\",\n    llmagent.WithModel(modelInstance),\n    llmagent.WithDescription(\"\u5904\u7406\u6570\u5b66\u8ba1\u7b97\u548c\u6570\u503c\u95ee\u9898\"),\n    llmagent.WithInstruction(\"\u4f60\u662f\u6570\u5b66\u4e13\u5bb6\uff0c\u4e13\u6ce8\u4e8e\u6570\u5b66\u8fd0\u7b97\u548c\u6570\u503c\u63a8\u7406...\"),\n)\n\nweatherAgent := llmagent.New(\n    \"weather-agent\",\n    llmagent.WithModel(modelInstance),\n    llmagent.WithDescription(\"\u63d0\u4f9b\u5929\u6c14\u4fe1\u606f\u548c\u5efa\u8bae\"),\n    llmagent.WithInstruction(\"\u4f60\u662f\u5929\u6c14\u4e13\u5bb6\uff0c\u63d0\u4f9b\u5929\u6c14\u5206\u6790\u548c\u6d3b\u52a8\u5efa\u8bae...\"),\n)\n\n// \u4f7f\u7528 WithSubAgents option \u914d\u7f6e SubAgent\nmainAgent := llmagent.New(\n    \"coordinator-agent\",\n    llmagent.WithModel(modelInstance),\n    llmagent.WithDescription(\"\u534f\u8c03\u8005 Agent\uff0c\u8d1f\u8d23\u4efb\u52a1\u59d4\u6258\"),\n    llmagent.WithInstruction(\"\u4f60\u662f\u534f\u8c03\u8005\uff0c\u5206\u6790\u7528\u6237\u8bf7\u6c42\u5e76\u59d4\u6258\u7ed9\u5408\u9002\u7684\u4e13\u5bb6...\"),\n    llmagent.WithSubAgents([]agent.Agent{mathAgent, weatherAgent}),\n)\n</code></pre>"},{"location":"zh/multiagent/#_6","title":"\u6838\u5fc3\u534f\u4f5c\u6a21\u5f0f","text":"<p>\u6240\u6709\u534f\u4f5c\u6a21\u5f0f\u90fd\u57fa\u4e8e SubAgent \u6982\u5ff5\uff0c\u901a\u8fc7\u4e0d\u540c\u7684\u6267\u884c\u7b56\u7565\u5b9e\u73b0\uff1a</p>"},{"location":"zh/multiagent/#agent-chainagent","title":"\u94fe\u5f0f Agent (ChainAgent)","text":"<p>\u94fe\u5f0f Agent \u4f7f\u7528 SubAgent \u6309\u987a\u5e8f\u8fde\u63a5\uff0c\u5f62\u6210\u5904\u7406\u6d41\u6c34\u7ebf\u3002\u6bcf\u4e2a SubAgent \u4e13\u6ce8\u4e8e\u7279\u5b9a\u4efb\u52a1\uff0c\u5e76\u5c06\u7ed3\u679c\u4f20\u9012\u7ed9\u4e0b\u4e00\u4e2a SubAgent\u3002</p>"},{"location":"zh/multiagent/#_7","title":"\u4f7f\u7528\u573a\u666f","text":"<ul> <li>\u5185\u5bb9\u521b\u4f5c\u6d41\u7a0b\uff1a\u89c4\u5212 \u2192 \u7814\u7a76 \u2192 \u5199\u4f5c</li> <li>\u95ee\u9898\u89e3\u51b3\u6d41\u7a0b\uff1a\u5206\u6790 \u2192 \u8bbe\u8ba1 \u2192 \u5b9e\u73b0</li> <li>\u6570\u636e\u5904\u7406\u6d41\u7a0b\uff1a\u6536\u96c6 \u2192 \u6e05\u6d17 \u2192 \u5206\u6790</li> </ul>"},{"location":"zh/multiagent/#_8","title":"\u57fa\u672c\u7528\u6cd5","text":"<pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/agent\"\n    \"trpc.group/trpc-go/trpc-agent-go/agent/chainagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/agent/llmagent\"\n)\n\n// \u521b\u5efa SubAgent\nplanningAgent := llmagent.New(\"planning-agent\", ...)\nresearchAgent := llmagent.New(\"research-agent\", ...)\nwritingAgent := llmagent.New(\"writing-agent\", ...)\n\n// \u521b\u5efa\u94fe\u5f0f Agent\uff0c\u4f7f\u7528 WithSubAgents \u914d\u7f6e SubAgent\nchainAgent := chainagent.New(\n    \"multi-agent-chain\",\n    chainagent.WithSubAgents([]agent.Agent{\n        planningAgent, \n        researchAgent, \n        writingAgent,\n    }),\n)\n</code></pre>"},{"location":"zh/multiagent/#_9","title":"\u793a\u4f8b\u4f1a\u8bdd","text":"<pre><code>\ud83d\udd17 \u591a Agent \u94fe\u5f0f\u6f14\u793a\n\u94fe\u5f0f\u6d41\u7a0b\uff1a\u89c4\u5212 \u2192 \u7814\u7a76 \u2192 \u5199\u4f5c\n==================================================\n\n\ud83d\udc64 \u7528\u6237\uff1a\u89e3\u91ca\u53ef\u518d\u751f\u80fd\u6e90\u7684\u597d\u5904\n\n\ud83d\udccb \u89c4\u5212 Agent\uff1a\u6211\u5c06\u521b\u5efa\u4e00\u4e2a\u7ed3\u6784\u5316\u7684\u5206\u6790\u8ba1\u5212...\n\n\ud83d\udd0d \u7814\u7a76 Agent\uff1a\n\ud83d\udd27 \u4f7f\u7528\u5de5\u5177\uff1a\n   \u2022 web_search (ID: call_123)\n\ud83d\udd04 \u6267\u884c\u4e2d...\n\u2705 \u5de5\u5177\u7ed3\u679c\uff1a\u6700\u65b0\u7684\u53ef\u518d\u751f\u80fd\u6e90\u6570\u636e...\n\n\u270d\ufe0f \u5199\u4f5c Agent\uff1a\u57fa\u4e8e\u89c4\u5212\u548c\u7814\u7a76\uff1a\n[\u7ed3\u6784\u5316\u7684\u7efc\u5408\u56de\u7b54]\n</code></pre>"},{"location":"zh/multiagent/#agent-parallelagent","title":"\u5e76\u884c Agent (ParallelAgent)","text":"<p>\u5e76\u884c Agent \u4f7f\u7528 SubAgent \u540c\u65f6\u5904\u7406\u540c\u4e00\u8f93\u5165\u7684\u4e0d\u540c\u65b9\u9762\uff0c\u63d0\u4f9b\u591a\u89d2\u5ea6\u7684\u5206\u6790\u3002</p>"},{"location":"zh/multiagent/#_10","title":"\u4f7f\u7528\u573a\u666f","text":"<ul> <li>\u5546\u4e1a\u51b3\u7b56\u5206\u6790\uff1a\u5e02\u573a\u5206\u6790\u3001\u6280\u672f\u8bc4\u4f30\u3001\u98ce\u9669\u8bc4\u4f30\u3001\u673a\u4f1a\u5206\u6790</li> <li>\u591a\u7ef4\u5ea6\u8bc4\u4f30\uff1a\u4e0d\u540c\u4e13\u5bb6\u540c\u65f6\u8bc4\u4f30\u540c\u4e00\u95ee\u9898</li> <li>\u5feb\u901f\u5e76\u884c\u5904\u7406\uff1a\u9700\u8981\u540c\u65f6\u83b7\u5f97\u591a\u4e2a\u89c6\u89d2\u7684\u573a\u666f</li> </ul>"},{"location":"zh/multiagent/#_11","title":"\u57fa\u672c\u7528\u6cd5","text":"<pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/agent/parallelagent\"\n)\n\n// \u521b\u5efa SubAgent\nmarketAgent := llmagent.New(\"market-analysis\", ...)\ntechnicalAgent := llmagent.New(\"technical-assessment\", ...)\nriskAgent := llmagent.New(\"risk-evaluation\", ...)\nopportunityAgent := llmagent.New(\"opportunity-analysis\", ...)\n\n// \u521b\u5efa\u5e76\u884c Agent\uff0c\u4f7f\u7528 WithSubAgents \u914d\u7f6e SubAgent\nparallelAgent := parallelagent.New(\n    \"parallel-demo\",\n    parallelagent.WithSubAgents([]agent.Agent{\n        marketAgent,\n        technicalAgent, \n        riskAgent,\n        opportunityAgent,\n    }),\n)\n</code></pre>"},{"location":"zh/multiagent/#_12","title":"\u793a\u4f8b\u4f1a\u8bdd","text":"<pre><code>\u26a1 \u5e76\u884c\u591a Agent \u6f14\u793a\nAgent\uff1a\u5e02\u573a \ud83d\udcca | \u6280\u672f \u2699\ufe0f | \u98ce\u9669 \u26a0\ufe0f | \u673a\u4f1a \ud83d\ude80\n==================================================\n\n\ud83d\udcac \u7528\u6237\uff1a\u6211\u4eec\u5e94\u8be5\u4e3a\u4f9b\u5e94\u94fe\u8ddf\u8e2a\u5b9e\u65bd\u533a\u5757\u94fe\u5417\uff1f\n\n\ud83d\ude80 \u5f00\u59cb\u5e76\u884c\u5206\u6790\uff1a\"\u6211\u4eec\u5e94\u8be5\u4e3a\u4f9b\u5e94\u94fe\u8ddf\u8e2a\u5b9e\u65bd\u533a\u5757\u94fe\u5417\uff1f\"\n\ud83d\udcca Agent \u6b63\u5728\u5206\u6790\u4e0d\u540c\u89d2\u5ea6...\n\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\n\ud83d\udcca [market-analysis] \u5f00\u59cb\u5206\u6790...\n\u2699\ufe0f [technical-assessment] \u5f00\u59cb\u5206\u6790...\n\u26a0\ufe0f [risk-evaluation] \u5f00\u59cb\u5206\u6790...\n\ud83d\ude80 [opportunity-analysis] \u5f00\u59cb\u5206\u6790...\n\n\ud83d\udcca [market-analysis]: \u533a\u5757\u94fe\u4f9b\u5e94\u94fe\u5e02\u573a\u6b63\u5728\u7ecf\u5386\u5f3a\u52b2\u589e\u957f\uff0c\u5e74\u590d\u5408\u589e\u957f\u7387\u4e3a67%...\n\n\u2699\ufe0f [technical-assessment]: \u5b9e\u65bd\u9700\u8981\u5206\u5e03\u5f0f\u8d26\u672c\u57fa\u7840\u8bbe\u65bd\u548c\u5171\u8bc6\u673a\u5236...\n\n\u26a0\ufe0f [risk-evaluation]: \u4e3b\u8981\u98ce\u9669\u5305\u62ec40%\u76ee\u6807\u5e02\u573a\u7684\u76d1\u7ba1\u4e0d\u786e\u5b9a\u6027...\n\n\ud83d\ude80 [opportunity-analysis]: \u6218\u7565\u4f18\u52bf\u5305\u62ec\u589e\u5f3a\u900f\u660e\u5ea6\uff0c\u53ef\u5e26\u676515-20%\u7684\u6210\u672c\u964d\u4f4e...\n\n\ud83c\udfaf \u6240\u6709\u5e76\u884c\u5206\u6790\u6210\u529f\u5b8c\u6210\uff01\n\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\n\u2705 \u591a\u89d2\u5ea6\u5206\u6790\u57284.1\u79d2\u5185\u5b8c\u6210\n</code></pre>"},{"location":"zh/multiagent/#agent-cycleagent","title":"\u5faa\u73af Agent (CycleAgent)","text":"<p>\u5faa\u73af Agent \u4f7f\u7528 SubAgent \u5728\u8fed\u4ee3\u5faa\u73af\u4e2d\u8fd0\u884c\uff0c\u76f4\u5230\u6ee1\u8db3\u7279\u5b9a\u6761\u4ef6\uff08\u5982\u8d28\u91cf\u9608\u503c\u6216\u6700\u5927\u8fed\u4ee3\u6b21\u6570\uff09\u3002</p>"},{"location":"zh/multiagent/#_13","title":"\u4f7f\u7528\u573a\u666f","text":"<ul> <li>\u5185\u5bb9\u4f18\u5316\uff1a\u751f\u6210 \u2192 \u8bc4\u4f30 \u2192 \u6539\u8fdb \u2192 \u91cd\u590d</li> <li>\u95ee\u9898\u89e3\u51b3\uff1a\u63d0\u51fa \u2192 \u8bc4\u4f30 \u2192 \u589e\u5f3a \u2192 \u91cd\u590d</li> <li>\u8d28\u91cf\u4fdd\u8bc1\uff1a\u8349\u7a3f \u2192 \u5ba1\u67e5 \u2192 \u4fee\u8ba2 \u2192 \u91cd\u590d</li> </ul>"},{"location":"zh/multiagent/#_14","title":"\u57fa\u672c\u7528\u6cd5","text":"<pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/agent/cycleagent\"\n)\n\n// \u521b\u5efa SubAgent\ngenerateAgent := llmagent.New(\"generate-agent\", ...)\ncriticAgent := llmagent.New(\"critic-agent\", ...)\n\n// \u521b\u5efa\u5faa\u73af Agent\uff0c\u4f7f\u7528 WithSubAgents \u914d\u7f6e SubAgent\ncycleAgent := cycleagent.New(\n    \"cycle-demo\",\n    cycleagent.WithSubAgents([]agent.Agent{\n        generateAgent,\n        criticAgent,\n    }),\n    cycleagent.WithMaxIterations(3),\n    cycleagent.WithEscalationFunc(qualityEscalationFunc),\n)\n</code></pre>"},{"location":"zh/multiagent/#_15","title":"\u793a\u4f8b\u4f1a\u8bdd","text":"<pre><code>\ud83d\udd04 \u591a Agent \u5faa\u73af\u6f14\u793a\n\u6700\u5927\u8fed\u4ee3\u6b21\u6570\uff1a3\n\u5faa\u73af\uff1a\u751f\u6210 \u2192 \u8bc4\u4f30 \u2192 \u6539\u8fdb \u2192 \u91cd\u590d\n==================================================\n\n\ud83d\udc64 \u7528\u6237\uff1a\u5199\u4e00\u4e2a\u77ed\u7b11\u8bdd\n\n\ud83e\udd16 \u5faa\u73af\u54cd\u5e94\uff1a\n\n\ud83e\udd16 \u751f\u6210 Agent\uff1a\u4e3a\u4ec0\u4e48\u9ab7\u9ac5\u4e0d\u4e92\u76f8\u6253\u67b6\uff1f\n\u56e0\u4e3a\u5b83\u4eec\u6ca1\u6709\u80c6\u91cf\uff01\n\n\ud83d\udc40 \u8bc4\u4f30 Agent\uff1a\n\ud83d\udd27 \u4f7f\u7528\u5de5\u5177\uff1a\n   \u2022 record_score (ID: call_123)\n\ud83d\udd04 \u6267\u884c\u4e2d...\n\u2705 \u8d28\u91cf\u8bc4\u5206\uff1a75/100\n\u26a0\ufe0f \u9700\u8981\u6539\u8fdb - \u7ee7\u7eed\u8fed\u4ee3\n\n\ud83d\udd04 **\u7b2c2\u6b21\u8fed\u4ee3**\n\n\ud83e\udd16 \u751f\u6210 Agent\uff1a\u8fd9\u662f\u4e00\u4e2a\u6539\u8fdb\u7248\u672c\uff0c\u6709\u65b0\u7684\u8f6c\u6298\uff1a\n**\u4e3a\u4ec0\u4e48\u9ab7\u9ac5\u4ece\u4e0d\u8d62\u5f97\u4e89\u8bba\uff1f**\n\u56e0\u4e3a\u5b83\u4eec\u603b\u662f\u5728\u4e2d\u9014\u5931\u53bb\u810a\u6881\uff01\n\n\ud83d\udc40 \u8bc4\u4f30 Agent\uff1a\n\ud83d\udd27 \u4f7f\u7528\u5de5\u5177\uff1a\n   \u2022 record_score (ID: call_456)\n\ud83d\udd04 \u6267\u884c\u4e2d...\n\u2705 \u8d28\u91cf\u8bc4\u5206\uff1a85/100\n\ud83c\udf89 \u8d28\u91cf\u9608\u503c\u8fbe\u5230 - \u5faa\u73af\u5b8c\u6210\n\n\ud83c\udfc1 \u5faa\u73af\u57282\u6b21\u8fed\u4ee3\u540e\u5b8c\u6210\n</code></pre>"},{"location":"zh/multiagent/#_16","title":"\u8f85\u52a9\u529f\u80fd","text":""},{"location":"zh/multiagent/#agent-agenttool","title":"Agent \u5de5\u5177 (AgentTool)","text":"<p>Agent \u5de5\u5177\u662f\u6784\u5efa\u590d\u6742\u591a Agent \u7cfb\u7edf\u7684\u91cd\u8981\u57fa\u7840\u529f\u80fd\uff0c\u5b83\u5141\u8bb8\u60a8\u5c06\u4efb\u4f55 Agent \u5305\u88c5\u6210\u53ef\u8c03\u7528\u7684\u5de5\u5177\uff0c\u4f9b\u5176\u4ed6 Agent \u6216\u5e94\u7528\u7a0b\u5e8f\u4f7f\u7528\u3002</p>"},{"location":"zh/multiagent/#_17","title":"\u4f7f\u7528\u573a\u666f","text":"<ul> <li>\u4e13\u4e1a\u5316\u59d4\u6258\uff1a\u4e0d\u540c Agent \u5904\u7406\u7279\u5b9a\u7c7b\u578b\u7684\u4efb\u52a1</li> <li>\u5de5\u5177\u96c6\u6210\uff1aAgent \u53ef\u4ee5\u4f5c\u4e3a\u5de5\u5177\u96c6\u6210\u5230\u66f4\u5927\u7684\u7cfb\u7edf\u4e2d</li> <li>\u6a21\u5757\u5316\u8bbe\u8ba1\uff1a\u53ef\u91cd\u7528\u7684 Agent \u7ec4\u4ef6\u53ef\u4ee5\u7ec4\u5408\u5728\u4e00\u8d77</li> <li>\u590d\u6742\u5de5\u4f5c\u6d41\uff1a\u6d89\u53ca\u591a\u4e2a\u4e13\u95e8\u5316 Agent \u7684\u590d\u6742\u5de5\u4f5c\u6d41</li> </ul>"},{"location":"zh/multiagent/#_18","title":"\u57fa\u672c\u7528\u6cd5","text":"<pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/agent/llmagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/tool\"\n    agenttool \"trpc.group/trpc-go/trpc-agent-go/tool/agent\"\n    \"trpc.group/trpc-go/trpc-agent-go/tool/function\"\n)\n\n// \u521b\u5efa\u4e13\u95e8\u7684 Agent\nmathAgent := llmagent.New(\n    \"math-specialist\",\n    llmagent.WithModel(modelInstance),\n    llmagent.WithDescription(\"\u4e13\u95e8\u5904\u7406\u6570\u5b66\u8fd0\u7b97\u7684 Agent\"),\n    llmagent.WithInstruction(\"\u4f60\u662f\u4e00\u4e2a\u6570\u5b66\u4e13\u5bb6\uff0c\u4e13\u6ce8\u4e8e\u6570\u5b66\u8fd0\u7b97\u3001\u8ba1\u7b97\u548c\u6570\u503c\u63a8\u7406...\"),\n    llmagent.WithTools([]tool.Tool{calculatorTool}),\n)\n\n// \u5c06 Agent \u5305\u88c5\u6210\u5de5\u5177\nagentTool := agenttool.NewTool(\n    mathAgent,\n    // \u9ed8\u8ba4 skip summarization=false\uff0c\u5f53\u8bbe\u7f6e\u4e3a true \u65f6\u4f1a\u5728 tool.response \u540e\u76f4\u63a5\u7ed3\u675f\u672c\u8f6e\n    agenttool.WithSkipSummarization(false),\n    // \u5f00\u542f\u8f6c\u53d1\uff1a\u628a\u5b50 Agent \u7684\u6d41\u5f0f\u4e8b\u4ef6\u5185\u8054\u5230\u7236\u6d41\u7a0b\n    agenttool.WithStreamInner(true),\n)\n\n// \u5728\u4e3b Agent \u4e2d\u4f7f\u7528 Agent \u5de5\u5177\nmainAgent := llmagent.New(\n    \"chat-assistant\",\n    llmagent.WithTools([]tool.Tool{timeTool, agentTool}),\n)\n</code></pre>"},{"location":"zh/multiagent/#agent","title":"Agent\u5de5\u5177\u67b6\u6784","text":"<pre><code>\u804a\u5929\u52a9\u624b (\u4e3b Agent)\n\u251c\u2500\u2500 \u65f6\u95f4\u5de5\u5177 (\u51fd\u6570)\n\u2514\u2500\u2500 \u6570\u5b66\u4e13\u5bb6 Agent \u5de5\u5177 (Agent)\n    \u2514\u2500\u2500 \u6570\u5b66\u4e13\u5bb6 Agent (\u4e13\u95e8\u5316 Agent)\n        \u2514\u2500\u2500 \u8ba1\u7b97\u5668\u5de5\u5177 (\u51fd\u6570)\n</code></pre>"},{"location":"zh/multiagent/#_19","title":"\u793a\u4f8b\u4f1a\u8bdd","text":"<pre><code>\ud83d\ude80 Agent \u5de5\u5177\u793a\u4f8b\n\u6a21\u578b\uff1adeepseek-chat\n\u53ef\u7528\u5de5\u5177\uff1acurrent_time, math-specialist\n==================================================\n\n\ud83d\udc64 \u7528\u6237\uff1a\u8ba1\u7b97 923476 * 273472354\n\n\ud83e\udd16 \u52a9\u624b\uff1a\u6211\u5c06\u4f7f\u7528\u6570\u5b66\u4e13\u5bb6 Agent \u6765\u8ba1\u7b97\u8fd9\u4e2a\u7ed3\u679c\u3002\n\n\ud83d\udd27 \u5de5\u5177\u8c03\u7528\u5df2\u542f\u52a8\uff1a\n   \u2022 math-specialist (ID: call_0_e53a77e9-c994-4421-bfc3-f63fe85678a1)\n     \u53c2\u6570\uff1a{\"request\":\"\u8ba1\u7b97 923476 \u4e58\u4ee5 273472354\"}\n\n\ud83d\udd04 \u6267\u884c\u5de5\u5177\u4e2d...\n\u2705 \u5de5\u5177\u54cd\u5e94 (ID: call_0_e53a77e9-c994-4421-bfc3-f63fe85678a1)\uff1a\n\"\u8ba1\u7b97 923,476 \u4e58\u4ee5 273,472,354 \u7684\u7ed3\u679c\u662f\uff1a\n\n\\[\n923,\\!476 \\times 273,\\!472,\\!354 = 252,\\!545,\\!155,\\!582,\\!504\n\\]\"\n\n\u2705 \u5de5\u5177\u6267\u884c\u5b8c\u6210\u3002\n</code></pre>"},{"location":"zh/multiagent/#streaminner","title":"\u6d41\u5f0f\u5185\u90e8\u8f6c\u53d1\uff08StreamInner\uff09","text":"<p>\u5f53\u4e3a Agent \u5de5\u5177\u542f\u7528 <code>WithStreamInner(true)</code> \u65f6\uff1a</p> <ul> <li>\u5b50 Agent \u7684\u4e8b\u4ef6\u4f1a\u4ee5\u6d41\u5f0f\u5f62\u5f0f\u8f6c\u53d1\u5230\u7236\u6d41\u7a0b\uff08<code>event.Event</code>\uff09\uff0c\u53ef\u76f4\u63a5\u663e\u793a <code>choice.Delta.Content</code></li> <li>\u4e3a\u907f\u514d\u91cd\u590d\u6253\u5370\uff0c\u5b50 Agent \u6700\u7ec8\u7684\u6574\u6bb5\u6587\u672c\u9ed8\u8ba4\u4e0d\u4f1a\u4f5c\u4e3a\u8f6c\u53d1\u4e8b\u4ef6\u518d\u6b21\u8f93\u51fa\uff1b\u4f46\u4f1a\u88ab\u805a\u5408\u5199\u5165\u6700\u7ec8\u7684 <code>tool.response</code>\uff0c\u7528\u4e8e\u6ee1\u8db3\u6a21\u578b\u201c\u5de5\u5177\u6d88\u606f\u8ddf\u968f\u201d\u7684\u8981\u6c42</li> <li>\u5efa\u8bae\u5728 UI \u5c42\uff1a<ul> <li>\u5c55\u793a\u5b50 Agent \u8f6c\u53d1\u7684\u589e\u91cf\u5185\u5bb9</li> <li>\u5982\u975e\u8c03\u8bd5\uff0c\u4e0d\u518d\u989d\u5916\u6253\u5370\u6700\u7ec8\u805a\u5408\u7684\u5de5\u5177\u54cd\u5e94\u5185\u5bb9</li> </ul> </li> </ul> <p>\u793a\u4f8b\uff1a\u5728\u4e8b\u4ef6\u5faa\u73af\u4e2d\u533a\u5206\u5916\u5c42\u52a9\u624b/\u5b50 Agent/\u5de5\u5177\u54cd\u5e94</p> <pre><code>// \u5b50 Agent \u8f6c\u53d1\u7684\u589e\u91cf\uff08\u4f5c\u8005\u4e0d\u662f\u7236 Agent\uff09\nif ev.Author != parentName &amp;&amp; ev.Response != nil &amp;&amp; len(ev.Response.Choices) &gt; 0 {\n    if delta := ev.Response.Choices[0].Delta.Content; delta != \"\" {\n        fmt.Print(delta)\n    }\n    return\n}\n\n// \u5de5\u5177\u54cd\u5e94\uff08\u5305\u542b\u805a\u5408\u5185\u5bb9\uff09\uff0c\u9ed8\u8ba4\u4e0d\u6253\u5370\uff0c\u907f\u514d\u91cd\u590d\nif ev.Response != nil &amp;&amp; ev.Object == model.ObjectTypeToolResponse {\n    // ...\u6309\u9700\u5c55\u793a\u6216\u5ffd\u7565\n    return\n}\n</code></pre>"},{"location":"zh/multiagent/#_20","title":"\u9009\u9879\u5bf9\u7167","text":"<ul> <li><code>WithSkipSummarization(false)</code>\uff1a\u9ed8\u8ba4\uff0c\u5de5\u5177\u8fd4\u56de\u540e\u5141\u8bb8\u5916\u5c42\u6a21\u578b\u518d\u603b\u7ed3\u4e00\u6b21</li> <li><code>WithSkipSummarization(true)</code>\uff1a\u5de5\u5177\u8fd4\u56de\u540e\u8df3\u8fc7\u5916\u5c42\u6a21\u578b\u7684\u603b\u7ed3\u8c03\u7528</li> <li><code>WithStreamInner(true)</code>\uff1a\u542f\u7528\u5b50 Agent \u4e8b\u4ef6\u8f6c\u53d1\uff08\u7236/\u5b50 Agent \u5efa\u8bae\u90fd <code>Stream: true</code>\uff09</li> <li><code>WithStreamInner(false)</code>\uff1a\u6309\u666e\u901a\u53ef\u8c03\u7528\u5de5\u5177\u5904\u7406\uff0c\u4e0d\u8f6c\u53d1\u5185\u90e8\u6d41</li> </ul>"},{"location":"zh/multiagent/#agent-agent-transfer","title":"Agent \u59d4\u6258 (Agent Transfer)","text":"<p>Agent \u59d4\u6258\u901a\u8fc7 <code>transfer_to_agent</code> \u5de5\u5177\u5b9e\u73b0 Agent \u95f4\u7684\u4efb\u52a1\u59d4\u6258\uff0c\u5141\u8bb8\u4e3b Agent \u6839\u636e\u4efb\u52a1\u7c7b\u578b\u81ea\u52a8\u9009\u62e9\u5408\u9002\u7684 SubAgent\u3002</p>"},{"location":"zh/multiagent/#_21","title":"\u4f7f\u7528\u573a\u666f","text":"<ul> <li>\u4efb\u52a1\u5206\u7c7b\uff1a\u6839\u636e\u7528\u6237\u8bf7\u6c42\u81ea\u52a8\u9009\u62e9\u5408\u9002\u7684 SubAgent</li> <li>\u667a\u80fd\u8def\u7531\uff1a\u5c06\u590d\u6742\u4efb\u52a1\u8def\u7531\u5230\u6700\u5408\u9002\u7684\u5904\u7406\u8005</li> <li>\u4e13\u4e1a\u5316\u5904\u7406\uff1a\u6bcf\u4e2a SubAgent \u4e13\u6ce8\u4e8e\u7279\u5b9a\u9886\u57df</li> <li>\u65e0\u7f1d\u5207\u6362\uff1a\u5728 SubAgent \u4e4b\u95f4\u65e0\u7f1d\u5207\u6362\uff0c\u4fdd\u6301\u5bf9\u8bdd\u8fde\u7eed\u6027</li> </ul>"},{"location":"zh/multiagent/#_22","title":"\u57fa\u672c\u7528\u6cd5","text":"<pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/agent\"\n    \"trpc.group/trpc-go/trpc-agent-go/agent/llmagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/tool\"\n    \"trpc.group/trpc-go/trpc-agent-go/tool/function\"\n)\n\n// \u521b\u5efa SubAgent\nmathAgent := llmagent.New(\n    \"math-agent\",\n    llmagent.WithModel(modelInstance),\n    llmagent.WithDescription(\"\u5904\u7406\u6570\u5b66\u8ba1\u7b97\u548c\u6570\u503c\u95ee\u9898\"),\n    llmagent.WithInstruction(\"\u4f60\u662f\u6570\u5b66\u4e13\u5bb6\uff0c\u4e13\u6ce8\u4e8e\u6570\u5b66\u8fd0\u7b97\u548c\u6570\u503c\u63a8\u7406...\"),\n    llmagent.WithTools([]tool.Tool{calculatorTool}),\n)\n\nweatherAgent := llmagent.New(\n    \"weather-agent\",\n    llmagent.WithModel(modelInstance),\n    llmagent.WithDescription(\"\u63d0\u4f9b\u5929\u6c14\u4fe1\u606f\u548c\u5efa\u8bae\"),\n    llmagent.WithInstruction(\"\u4f60\u662f\u5929\u6c14\u4e13\u5bb6\uff0c\u63d0\u4f9b\u5929\u6c14\u5206\u6790\u548c\u6d3b\u52a8\u5efa\u8bae...\"),\n    llmagent.WithTools([]tool.Tool{weatherTool}),\n)\n\n// \u521b\u5efa\u534f\u8c03\u8005 Agent\uff0c\u4f7f\u7528 WithSubAgents \u914d\u7f6e SubAgent\ncoordinatorAgent := llmagent.New(\n    \"coordinator-agent\",\n    llmagent.WithModel(modelInstance),\n    llmagent.WithDescription(\"\u534f\u8c03\u8005 Agent\uff0c\u8d1f\u8d23\u4efb\u52a1\u59d4\u6258\"),\n    llmagent.WithInstruction(\"\u4f60\u662f\u534f\u8c03\u8005\uff0c\u5206\u6790\u7528\u6237\u8bf7\u6c42\u5e76\u59d4\u6258\u7ed9\u5408\u9002\u7684\u4e13\u5bb6...\"),\n    llmagent.WithSubAgents([]agent.Agent{mathAgent, weatherAgent}),\n)\n</code></pre>"},{"location":"zh/multiagent/#subagent-a2a","title":"\u52a8\u6001 SubAgent \u53d1\u73b0\uff08\u7ed3\u5408 A2A\uff09","text":"<p>\u5728\u771f\u5b9e\u7cfb\u7edf\u4e2d\uff0cSubAgent \u5f80\u5f80\u662f\u901a\u8fc7 A2A \u534f\u8bae\u66b4\u9732\u7684\u8fdc\u7a0b Agent\uff0c \u5b83\u4eec\u7684\u5217\u8868\u4f1a\u968f\u7740\u65f6\u95f4\u53d8\u5316\uff08\u4f8b\u5982\u4ece\u6ce8\u518c\u4e2d\u5fc3\u52a8\u6001\u4e0a\u4e0b\u7ebf\uff09\u3002</p> <p>\u4e3a\u652f\u6301\u8fd9\u4e00\u573a\u666f\uff0c<code>LLMAgent</code> \u5b9e\u73b0\u4e86 <code>agent.SubAgentSetter</code> \u63a5\u53e3\uff0c\u53ef\u4ee5\u5728\u8fd0\u884c\u65f6\u5237\u65b0 SubAgent \u5217\u8868\uff0c\u800c\u65e0\u9700\u91cd\u5efa\u534f\u8c03\u8005\uff1a</p> <pre><code>import (\n    \"fmt\"\n    \"context\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/agent\"\n    \"trpc.group/trpc-go/trpc-agent-go/agent/a2aagent\"\n)\n\nfunc refreshSubAgents(ctx context.Context, ag agent.Agent) error {\n    cfg, ok := ag.(agent.SubAgentSetter)\n    if !ok {\n        return fmt.Errorf(\"agent does not support dynamic SubAgents\")\n    }\n\n    // 1. \u4ece\u6ce8\u518c\u4e2d\u5fc3\u6216\u914d\u7f6e\u6e90\u53d1\u73b0\u8fdc\u7a0b Agent\u3002\n    urls := []string{\n        \"http://localhost:8087/\",\n        \"http://localhost:8088/\",\n    }\n\n    // 2. \u4e3a\u6bcf\u4e2a\u8fdc\u7a0b Agent \u6784\u5efa A2AAgent \u4ee3\u7406\u3002\n    subAgents := make([]agent.Agent, 0, len(urls))\n    for _, url := range urls {\n        a2, err := a2aagent.New(a2aagent.WithAgentCardURL(url))\n        if err != nil {\n            // \u751f\u4ea7\u73af\u5883\u4e2d\u5efa\u8bae\u8bb0\u5f55\u65e5\u5fd7\u5e76\u8df3\u8fc7\u5931\u8d25\u9879\u3002\n            continue\n        }\n        subAgents = append(subAgents, a2)\n    }\n\n    // 3. \u539f\u5b50\u6027\u5730\u66ff\u6362\u534f\u8c03\u8005\u4e0a\u7684 SubAgents\u3002\n    cfg.SetSubAgents(subAgents)\n    return nil\n}\n</code></pre> <p>\u8fd9\u79cd\u6a21\u5f0f\u53ef\u4ee5\u8ba9\u4f60\uff1a</p> <ul> <li>\u4e0e\u4efb\u610f\u6ce8\u518c\u4e2d\u5fc3\u96c6\u6210\uff08\u670d\u52a1\u53d1\u73b0\u3001\u6570\u636e\u5e93\u3001\u914d\u7f6e\u6587\u4ef6\u7b49\uff09</li> <li>\u52a8\u6001\u589e\u52a0\u6216\u79fb\u9664\u8fdc\u7a0b SubAgent</li> <li>\u4fdd\u6301 <code>Runner</code> \u548c\u4f1a\u8bdd\u7ba1\u7406\u903b\u8f91\u4e0d\u53d8\uff0c\u56e0\u4e3a\u534f\u8c03\u8005\u59cb\u7ec8\u662f\u540c\u4e00   \u4e2a Agent \u5b9e\u4f8b</li> </ul>"},{"location":"zh/multiagent/#agent_1","title":"Agent\u59d4\u6258\u67b6\u6784","text":"<pre><code>\u534f\u8c03\u8005 Agent (\u4e3b\u5165\u53e3)\n\u251c\u2500\u2500 \u5206\u6790\u7528\u6237\u8bf7\u6c42\n\u251c\u2500\u2500 \u9009\u62e9\u5408\u9002\u7684 SubAgent\n\u2514\u2500\u2500 \u4f7f\u7528 transfer_to_agent \u5de5\u5177\u59d4\u6258\u4efb\u52a1\n    \u251c\u2500\u2500 \u6570\u5b66 SubAgent (\u6570\u5b66\u8ba1\u7b97)\n    \u251c\u2500\u2500 \u5929\u6c14 SubAgent (\u5929\u6c14\u4fe1\u606f)\n    \u2514\u2500\u2500 \u7814\u7a76 SubAgent (\u4fe1\u606f\u641c\u7d22)\n</code></pre>"},{"location":"zh/multiagent/#_23","title":"\u793a\u4f8b\u4f1a\u8bdd","text":"<pre><code>\ud83d\udd04 Agent \u59d4\u6258\u6f14\u793a\n\u53ef\u7528 SubAgent\uff1amath-agent, weather-agent, research-agent\n==================================================\n\n\ud83d\udc64 \u7528\u6237\uff1a\u8ba1\u7b97\u590d\u5229\uff0c\u672c\u91d15000\u7f8e\u5143\uff0c\u5e74\u5229\u73876%\uff0c\u671f\u96508\u5e74\n\n\ud83c\udfaf \u534f\u8c03\u8005\uff1a\u6211\u5c06\u628a\u8fd9\u4e2a\u4efb\u52a1\u59d4\u6258\u7ed9\u6211\u4eec\u7684\u6570\u5b66\u4e13\u5bb6\u8fdb\u884c\u51c6\u786e\u8ba1\u7b97\u3002\n\ud83d\udd04 \u542f\u52a8\u59d4\u6258...\n\ud83d\udd04 \u59d4\u6258\u4e8b\u4ef6\uff1a\u5c06\u63a7\u5236\u6743\u8f6c\u79fb\u7ed9 Agent\uff1amath-agent\n\n\ud83e\uddee \u6570\u5b66\u4e13\u5bb6\uff1a\u6211\u5c06\u5e2e\u52a9\u60a8\u9010\u6b65\u8ba1\u7b97\u590d\u5229\u3002\n\ud83d\udd27 \ud83e\uddee \u6267\u884c\u5de5\u5177\uff1a\n   \u2022 calculate ({\"operation\":\"power\",\"a\":1.06,\"b\":8})\n   \u2705 \u5de5\u5177\u5b8c\u6210\n\ud83d\udd27 \ud83e\uddee \u6267\u884c\u5de5\u5177\uff1a\n   \u2022 calculate ({\"operation\":\"multiply\",\"a\":5000,\"b\":1.593})\n   \u2705 \u5de5\u5177\u5b8c\u6210\n\n\u590d\u5229\u8ba1\u7b97\u7ed3\u679c\uff1a\n- \u672c\u91d1\uff1a$5,000\n- \u5e74\u5229\u7387\uff1a6%\n- \u671f\u9650\uff1a8\u5e74\n- \u7ed3\u679c\uff1a$7,969.24\uff08\u5229\u606f\u7ea6$2,969.24\uff09\n</code></pre>"},{"location":"zh/multiagent/#_24","title":"\u73af\u5883\u53d8\u91cf\u914d\u7f6e","text":"<p>\u6240\u6709\u591a Agent \u793a\u4f8b\u90fd\u9700\u8981\u4ee5\u4e0b\u73af\u5883\u53d8\u91cf\uff1a</p> \u53d8\u91cf\u540d \u5fc5\u9700 \u9ed8\u8ba4\u503c \u8bf4\u660e <code>OPENAI_API_KEY</code> \u662f - OpenAI API \u5bc6\u94a5 <code>OPENAI_BASE_URL</code> \u5426 <code>https://api.openai.com/v1</code> OpenAI API \u57fa\u7840URL"},{"location":"zh/multiagent/#_25","title":"\u8fd0\u884c\u793a\u4f8b","text":"<p>\u6240\u6709\u793a\u4f8b\u4ee3\u7801\u4f4d\u4e8e examples</p>"},{"location":"zh/multiagent/#_26","title":"\u6838\u5fc3\u534f\u4f5c\u6a21\u5f0f\u793a\u4f8b","text":""},{"location":"zh/multiagent/#agent_2","title":"\u94fe\u5f0f Agent \u793a\u4f8b","text":"<pre><code>cd examples/multiagent/chain\nexport OPENAI_API_KEY=\"your-api-key\"\ngo run main.go -model deepseek-chat\n</code></pre>"},{"location":"zh/multiagent/#agent_3","title":"\u5e76\u884c Agent \u793a\u4f8b","text":"<pre><code>cd examples/multiagent/parallel\nexport OPENAI_API_KEY=\"your-api-key\"\ngo run main.go -model deepseek-chat\n</code></pre>"},{"location":"zh/multiagent/#agent_4","title":"\u5faa\u73af Agent \u793a\u4f8b","text":"<pre><code>cd examples/multiagent/cycle\nexport OPENAI_API_KEY=\"your-api-key\"\ngo run main.go -model deepseek-chat -max-iterations 5\n</code></pre>"},{"location":"zh/multiagent/#_27","title":"\u8f85\u52a9\u529f\u80fd\u793a\u4f8b","text":""},{"location":"zh/multiagent/#agent_5","title":"Agent \u5de5\u5177\u793a\u4f8b","text":"<pre><code>cd examples/agenttool\nexport OPENAI_API_KEY=\"your-api-key\"\ngo run main.go -model deepseek-chat\n</code></pre>"},{"location":"zh/multiagent/#agent_6","title":"Agent \u59d4\u6258\u793a\u4f8b","text":"<pre><code>cd examples/transfer\nexport OPENAI_API_KEY=\"your-api-key\"\ngo run main.go -model deepseek-chat\n</code></pre>"},{"location":"zh/multiagent/#_28","title":"\u81ea\u5b9a\u4e49\u548c\u6269\u5c55","text":""},{"location":"zh/multiagent/#agent_7","title":"\u6dfb\u52a0\u65b0\u7684 Agent","text":"<pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/agent\"\n    \"trpc.group/trpc-go/trpc-agent-go/agent/chainagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/agent/llmagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/tool\"\n)\n\n// \u521b\u5efa\u81ea\u5b9a\u4e49 Agent\ncustomAgent := llmagent.New(\n    \"custom-agent\",\n    llmagent.WithModel(modelInstance),\n    llmagent.WithDescription(\"\u81ea\u5b9a\u4e49 Agent \u63cf\u8ff0\"),\n    llmagent.WithInstruction(\"\u81ea\u5b9a\u4e49\u6307\u4ee4\"),\n    llmagent.WithTools([]tool.Tool{customTool}),\n)\n\n// \u96c6\u6210\u5230\u591a Agent \u7cfb\u7edf\u4e2d\nchainAgent := chainagent.New(\n    \"custom-chain\",\n    chainagent.WithSubAgents([]agent.Agent{\n        existingAgent,\n        customAgent,  // \u6dfb\u52a0\u81ea\u5b9a\u4e49 Agent\n    }),\n)\n</code></pre>"},{"location":"zh/multiagent/#_29","title":"\u914d\u7f6e\u5de5\u5177","text":"<pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/agent/llmagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/tool\"\n    \"trpc.group/trpc-go/trpc-agent-go/tool/function\"\n)\n\n// \u521b\u5efa\u81ea\u5b9a\u4e49\u5de5\u5177\ncustomTool := function.NewFunctionTool(\n    customFunction,\n    function.WithName(\"custom_tool\"),\n    function.WithDescription(\"\u81ea\u5b9a\u4e49\u5de5\u5177\u63cf\u8ff0\"),\n)\n\n// \u4e3a Agent \u5206\u914d\u5de5\u5177\nagent := llmagent.New(\n    \"tool-agent\",\n    llmagent.WithTools([]tool.Tool{customTool}),\n)\n</code></pre>"},{"location":"zh/multiagent/#_30","title":"\u8c03\u6574\u53c2\u6570","text":"<pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/agent/llmagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/model\"\n)\n\n// \u914d\u7f6e\u751f\u6210\u53c2\u6570\ngenConfig := model.GenerationConfig{\n    MaxTokens:   intPtr(500),\n    Temperature: floatPtr(0.7),\n    Stream:      true,\n}\n\n// \u5e94\u7528\u5230 Agent\nagent := llmagent.New(\n    \"configured-agent\",\n    llmagent.WithGenerationConfig(genConfig),\n)\n</code></pre>"},{"location":"zh/observability/","title":"Observability \u529f\u80fd","text":""},{"location":"zh/observability/#_1","title":"\u6982\u8ff0","text":"<p>tRPC-Agent-Go \u6846\u67b6\u5185\u7f6e\u4e86\u5168\u9762\u7684\u53ef\u89c2\u6d4b\uff08Observability\uff09\u529f\u80fd\uff0c\u57fa\u4e8e OpenTelemetry \u6807\u51c6\u534f\u8bae\uff0c\u4e3a Agent \u5e94\u7528\u63d0\u4f9b\u4e86\u5f3a\u5927\u7684\u53ef\u89c2\u6d4b\u6027\u80fd\u529b\u3002 \u901a\u8fc7\u53ef\u89c2\u6d4b\u529f\u80fd\uff0c\u5f00\u53d1\u8005\u53ef\u4ee5\u5b9e\u73b0\u5bf9 Agent \u8fd0\u884c\u72b6\u6001\u7684\u5168\u65b9\u4f4d\u76d1\u63a7\uff0c\u5305\u62ec\u94fe\u8def\u8ffd\u8e2a\u3001\u6027\u80fd\u6307\u6807\u6536\u96c6\u548c\u65e5\u5fd7\u8bb0\u5f55\u7b49\u3002</p>"},{"location":"zh/observability/#_2","title":"\ud83c\udfaf \u6838\u5fc3\u7279\u6027","text":"<ul> <li>\u94fe\u8def\u8ffd\u8e2a\uff08Tracing\uff09\uff1a\u5b8c\u6574\u8bb0\u5f55 Agent \u6267\u884c\u8fc7\u7a0b\u4e2d\u7684\u8c03\u7528\u94fe\u8def</li> <li>\u6027\u80fd\u6307\u6807\uff08Metrics\uff09\uff1a\u6536\u96c6 Agent \u8fd0\u884c\u65f6\u7684\u5173\u952e\u6027\u80fd\u6570\u636e</li> <li>\u65e5\u5fd7\u805a\u5408\uff08Logging\uff09\uff1a\u7edf\u4e00\u7684\u65e5\u5fd7\u6536\u96c6\u548c\u7ba1\u7406</li> <li>\u591a\u5e73\u53f0\u652f\u6301\uff1a\u652f\u6301 Jaeger\u3001Prometheus\u3001Galileo\u3001\u667a\u7814\u76d1\u63a7\u5b9d \u7b49\u4e3b\u6d41\u76d1\u63a7\u5e73\u53f0</li> <li>\u7075\u6d3b\u914d\u7f6e\uff1a\u652f\u6301\u591a\u79cd\u914d\u7f6e\u65b9\u5f0f\u548c\u81ea\u5b9a\u4e49\u6269\u5c55</li> </ul>"},{"location":"zh/observability/#_3","title":"\u4e0e\u4e0d\u540c\u7684\u76d1\u63a7\u5e73\u53f0\u96c6\u6210","text":""},{"location":"zh/observability/#langfuse","title":"Langfuse \u96c6\u6210","text":"<p>Langfuse \u662f\u4e13\u4e3a LLM \u5e94\u7528\u8bbe\u8ba1\u7684\u53ef\u89c2\u6d4b\u5e73\u53f0\uff0c\u652f\u6301\u901a\u8fc7 OpenTelemetry \u534f\u8bae\u91c7\u96c6\u94fe\u8def\u8ffd\u8e2a\u6570\u636e\u3002tRPC-Agent-Go \u53ef\u901a\u8fc7 OpenTelemetry \u534f\u8bae\u5c06 Trace \u6570\u636e\u5bfc\u51fa\u5230 Langfuse\u3002</p>"},{"location":"zh/observability/#1-langfuse","title":"1. \u90e8\u7f72 Langfuse","text":"<p>\u53ef\u53c2\u8003 Langfuse \u5b98\u65b9\u81ea\u6258\u7ba1\u6307\u5357 \u8fdb\u884c\u672c\u5730\u6216\u4e91\u7aef\u90e8\u7f72\u3002\u5feb\u901f\u4f53\u9a8c\u53ef\u53c2\u8003 Docker Compose \u90e8\u7f72\u6587\u6863\u3002</p>"},{"location":"zh/observability/#2-go","title":"2. Go \u7f16\u5199\u63a5\u5165\u4ee3\u7801","text":"<pre><code>export LANGFUSE_PUBLIC_KEY=\"your-public-key\"\nexport LANGFUSE_SECRET_KEY=\"your-secret-key\"\nexport LANGFUSE_HOST=\"your-langfuse-host\"\nexport LANGFUSE_INSECURE=\"true\" # \u7528\u4e8e\u4e0d\u5b89\u5168\u8fde\u63a5\uff08\u4ec5\u9650\u5f00\u53d1\u73af\u5883\uff09\n</code></pre> <pre><code>import (\n    \"context\"\n    \"log\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/telemetry/langfuse\"\n)\n\nfunc main() {\n    // Start trace with Langfuse integration using environment variables\n    clean, err := langfuse.Start(context.Background())\n    if err != nil {\n        log.Fatalf(\"Failed to start trace telemetry: %v\", err)\n    }\n    defer func() {\n        if err := clean(context.Background()); err != nil {\n            log.Printf(\"Failed to clean up trace telemetry: %v\", err)\n        }\n    }()\n</code></pre> <p>\u5b8c\u6574\u793a\u4f8b\u53ef\u53c2\u8003 examples/telemetry/langfuse\u3002</p> <p>\u8fd0\u884c\u793a\u4f8b\uff1a</p> <pre><code>go run .\n</code></pre> <p>\u4f60\u53ef\u4ee5\u5728 Langfuse \u63a7\u5236\u53f0\u67e5\u770b\u94fe\u8def\u8ffd\u8e2a\u6570\u636e\u3002</p>"},{"location":"zh/observability/#_4","title":"\u63a5\u5165\u4ee3\u7801\u8bf4\u660e","text":"<p>Langfuse \u652f\u6301\u901a\u8fc7 <code>/api/public/otel</code> (OTLP) \u63a5\u53e3\u63a5\u6536 Trace \u6570\u636e\uff0c\u4ec5\u652f\u6301 HTTP/protobuf\uff0c\u4e0d\u652f\u6301 gRPC\u3002 \u4e0a\u8ff0\u4ee3\u7801\u901a\u8fc7\u8bbe\u7f6e <code>OTEL_EXPORTER_OTLP_HEADERS</code> \u548c <code>OTEL_EXPORTER_OTLP_TRACES_ENDPOINT</code> \u6765\u63a5\u5165 langfuse\u3002</p> <pre><code># \u6b27\u76df\u6570\u636e\u533a\nOTEL_EXPORTER_OTLP_ENDPOINT=\"https://cloud.langfuse.com/api/public/otel\"\n# \u7f8e\u56fd\u6570\u636e\u533a\n# OTEL_EXPORTER_OTLP_ENDPOINT=\"https://us.cloud.langfuse.com/api/public/otel\"\n# \u672c\u5730\u90e8\u7f72 (&gt;= v3.22.0)\n# OTEL_EXPORTER_OTLP_ENDPOINT=\"http://localhost:3000/api/public/otel\"\n\n# \u8bbe\u7f6e Basic Auth \u8ba4\u8bc1\nOTEL_EXPORTER_OTLP_HEADERS=\"Authorization=Basic ${AUTH_STRING}\"\n</code></pre> <p>\u5176\u4e2d <code>AUTH_STRING</code> \u4e3a base64 \u7f16\u7801\u7684 <code>public_key:secret_key</code>\uff0c\u53ef\u7528\u5982\u4e0b\u547d\u4ee4\u751f\u6210\uff1a</p> <pre><code>echo -n \"pk-lf-xxxx:sk-lf-xxxx\" | base64\n# GNU \u7cfb\u7edf\u53ef\u52a0 -w 0 \u9632\u6b62\u6362\u884c\n</code></pre> <p>\u5982\u9700\u5355\u72ec\u6307\u5b9a trace \u6570\u636e\u7684 endpoint\uff0c\u53ef\u8bbe\u7f6e\uff1a</p> <pre><code>OTEL_EXPORTER_OTLP_TRACES_ENDPOINT=\"http://localhost:3000/api/public/otel/v1/traces\"\n</code></pre>"},{"location":"zh/observability/#jaegerprometheus","title":"Jaeger\u3001Prometheus \u7b49\u5f00\u6e90\u76d1\u63a7\u5e73\u53f0","text":"<p>\u53ef\u4ee5\u53c2\u8003 examples/telemetry \u7684\u4ee3\u7801\u793a\u4f8b\u3002</p> <pre><code>package main\n\nimport (\n    \"context\"\n    \"log\"\n\n    ametric \"trpc.group/trpc-go/trpc-agent-go/telemetry/metric\"\n    atrace \"trpc.group/trpc-go/trpc-agent-go/telemetry/trace\"\n)\n\nfunc main() {\n    // \u542f\u52a8\u6307\u6807\u6536\u96c6\n    mp, err := ametric.NewMeterProvider(\n        context.Background(),\n        ametric.WithEndpoint(\"localhost:4318\"),\n        ametric.WithProtocol(\"http\"),\n    )\n    if err != nil {\n        log.Fatalf(\"Failed to create meter provider: %v\", err)\n    }\n    defer mp.Shutdown(context.Background())\n    ametric.InitMeterProvider(mp)\n\n    // \u542f\u52a8\u94fe\u8def\u8ffd\u8e2a\n    traceClean, err := atrace.Start(\n        context.Background(),\n        atrace.WithEndpoint(\"localhost:4317\"), // trace \u5bfc\u51fa\u5730\u5740\n    )\n    if err != nil {\n        log.Fatalf(\"Failed to start trace telemetry: %v\", err)\n    }\n    defer traceClean()\n\n    // \u4f60\u7684 Agent \u5e94\u7528\u4ee3\u7801\n    // ...\n    // \u53ef\u4ee5\u6dfb\u52a0\u81ea\u5b9a\u4e49 trace \u548c metrics\n}\n</code></pre>"},{"location":"zh/observability/#jaeger-trace","title":"Jaeger trace \u793a\u4f8b","text":""},{"location":"zh/observability/#prometheus","title":"Prometheus \u76d1\u63a7\u6307\u6807\u793a\u4f8b","text":""},{"location":"zh/observability/#_5","title":"\u5b9e\u9645\u5e94\u7528\u793a\u4f8b","text":""},{"location":"zh/observability/#_6","title":"\u57fa\u672c\u7684\u6307\u6807\u548c\u8ffd\u8e2a","text":"<pre><code>package main\n\nimport (\n    \"context\"\n    \"fmt\"\n    \"time\"\n\n    ametric \"trpc.group/trpc-go/trpc-agent-go/telemetry/metric\"\n    atrace \"trpc.group/trpc-go/trpc-agent-go/telemetry/trace\"\n    \"trpc.group/trpc-go/trpc-agent-go/log\"\n\n    \"go.opentelemetry.io/otel/attribute\"\n    \"go.opentelemetry.io/otel/metric\"\n    \"go.opentelemetry.io/otel/trace\"\n)\n\nfunc main() {\n    // \u542f\u52a8\u6307\u6807\u6536\u96c6\n    mp, err := ametric.NewMeterProvider(\n        context.Background(),\n        ametric.WithEndpoint(\"localhost:4318\"),\n        ametric.WithProtocol(\"http\"),\n    )\n    if err != nil {\n        log.Fatalf(\"Failed to create meter provider: %v\", err)\n    }\n    defer mp.Shutdown(context.Background())\n    ametric.InitMeterProvider(mp)\n    meter := mp.Meter(\"trpc_agent_go.app\")\n\n    if err := processAgentRequest(context.Background(), meter); err != nil {\n        log.Errorf(\"processAgentRequest failed: %v\", err)\n    }\n}\nfunc processAgentRequest(ctx context.Context, meter metric.Meter) error {\n    // \u521b\u5efa\u8ffd\u8e2a span\n    ctx, span := atrace.Tracer.Start(\n        ctx,\n        \"process-agent-request\",\n        trace.WithAttributes(\n            attribute.String(\"agent.type\", \"chat\"),\n            attribute.String(\"user.id\", \"user123\"),\n        ),\n    )\n    defer span.End()\n\n    // \u521b\u5efa\u6307\u6807\u8ba1\u6570\u5668\n    requestCounter, err := meter.Int64Counter(\n        \"agent.requests.total\",\n        metric.WithDescription(\"Total number of agent requests\"),\n    )\n    if err != nil {\n        return err\n    }\n\n    // \u8bb0\u5f55\u8bf7\u6c42\n    requestCounter.Add(ctx, 1, metric.WithAttributes(\n        attribute.String(\"agent.type\", \"chat\"),\n        attribute.String(\"status\", \"success\"),\n    ))\n\n    // \u6a21\u62df\u5904\u7406\u8fc7\u7a0b\n    time.Sleep(100 * time.Millisecond)\n\n    return nil\n}\n</code></pre>"},{"location":"zh/observability/#agent","title":"Agent \u6267\u884c\u8ffd\u8e2a","text":"<p>\u6846\u67b6\u4f1a\u81ea\u52a8\u4e3a Agent \u7684\u5173\u952e\u7ec4\u4ef6\u6dfb\u52a0\u76d1\u63a7\u57cb\u70b9\uff1a</p> <pre><code>// Agent \u6267\u884c\u4f1a\u81ea\u52a8\u751f\u6210\u4ee5\u4e0b\u76d1\u63a7\u6570\u636e\uff1a\n// \n// Traces:\n// - agent.execution: Agent \u6574\u4f53\u6267\u884c\u8fc7\u7a0b\n// - tool.invocation: Tool \u8c03\u7528\u8fc7\u7a0b  \n// - model.api_call: \u6a21\u578b API \u8c03\u7528\u8fc7\u7a0b\n</code></pre>"},{"location":"zh/observability/#_7","title":"\u76d1\u63a7\u6570\u636e\u5206\u6790","text":""},{"location":"zh/observability/#_8","title":"\u94fe\u8def\u8ffd\u8e2a\u5206\u6790","text":"<p>\u5178\u578b\u7684 Agent \u6267\u884c\u94fe\u8def\u7ed3\u6784\uff1a</p> <pre><code>Agent Request\n\u251c\u2500\u2500 Planning Phase\n\u2502   \u251c\u2500\u2500 Model API Call (DeepSeek)\n\u2502   \u2514\u2500\u2500 Response Processing\n\u251c\u2500\u2500 Tool Execution Phase  \n\u2502   \u251c\u2500\u2500 Tool: web_search\n\u2502   \u251c\u2500\u2500 Tool: knowledge_base\n\u2502   \u2514\u2500\u2500 Result Processing\n\u2514\u2500\u2500 Response Generation Phase\n    \u251c\u2500\u2500 Model API Call (DeepSeek)\n    \u2514\u2500\u2500 Final Response Formatting\n</code></pre> <p>\u901a\u8fc7\u94fe\u8def\u8ffd\u8e2a\u53ef\u4ee5\u5206\u6790\uff1a</p> <ul> <li>\u6027\u80fd\u74f6\u9888\uff1a\u8bc6\u522b\u8017\u65f6\u6700\u957f\u7684\u64cd\u4f5c</li> <li>\u9519\u8bef\u5b9a\u4f4d\uff1a\u5feb\u901f\u627e\u5230\u5931\u8d25\u7684\u5177\u4f53\u73af\u8282</li> <li>\u4f9d\u8d56\u5173\u7cfb\uff1a\u4e86\u89e3\u7ec4\u4ef6\u95f4\u7684\u8c03\u7528\u5173\u7cfb</li> <li>\u5e76\u53d1\u5206\u6790\uff1a\u89c2\u5bdf\u5e76\u53d1\u6267\u884c\u7684\u6548\u679c</li> </ul>"},{"location":"zh/observability/#_9","title":"\u8fdb\u9636\u529f\u80fd","text":""},{"location":"zh/observability/#exporter","title":"\u81ea\u5b9a\u4e49 Exporter","text":"<p>\u5982\u679c\u9700\u8981\u5c06\u53ef\u89c2\u6d4b\u6570\u636e\u53d1\u9001\u5230\u81ea\u5b9a\u4e49\u7684\u76d1\u63a7\u7cfb\u7edf\uff1a</p> <pre><code>import (\n    \"go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracehttp\"\n    \"go.opentelemetry.io/otel/sdk/trace\"\n)\n\nfunc setupCustomExporter() error {\n    exporter, err := otlptracehttp.New(\n        context.Background(),\n        otlptracehttp.WithEndpoint(\"https://your-custom-endpoint.com\"),\n        otlptracehttp.WithHeaders(map[string]string{\n            \"Authorization\": \"Bearer your-token\",\n        }),\n    )\n    if err != nil {\n        return err\n    }\n\n    tp := trace.NewTracerProvider(\n        trace.WithBatcher(exporter),\n    )\n\n    // \u8bbe\u7f6e\u4e3a\u5168\u5c40 TracerProvider\n    otel.SetTracerProvider(tp)\n\n    return nil\n}\n</code></pre>"},{"location":"zh/observability/#_10","title":"\u53c2\u8003\u8d44\u6e90","text":"<ul> <li>OpenTelemetry \u5b98\u65b9\u6587\u6863</li> <li>tRPC-Agent-Go Telemetry \u793a\u4f8b</li> </ul> <p>\u901a\u8fc7\u5408\u7406\u4f7f\u7528\u53ef\u89c2\u6d4b\u529f\u80fd\uff0c\u4f60\u53ef\u4ee5\u5efa\u7acb\u5b8c\u5584\u7684 Agent \u5e94\u7528\u76d1\u63a7\u4f53\u7cfb\uff0c\u53ca\u65f6\u53d1\u73b0\u548c\u89e3\u51b3\u95ee\u9898\uff0c\u6301\u7eed\u4f18\u5316\u7cfb\u7edf\u6027\u80fd\u3002</p>"},{"location":"zh/planner/","title":"Planner \u4f7f\u7528\u6587\u6863","text":"<p>Planner \u662f\u7528\u4e8e\u5b9e\u73b0 Agent \u89c4\u5212\u80fd\u529b\u7684\u7ec4\u4ef6\u3002\u5b83\u5141\u8bb8 Agent \u5728\u6267\u884c\u4efb\u52a1\u524d\u5236\u5b9a\u8ba1\u5212\uff0c\u4ece\u800c\u63d0\u9ad8\u6267\u884c\u6548\u7387\u548c\u51c6\u786e\u6027\u3002</p> <p>\u6846\u67b6\u63d0\u4f9b\u4e86\u4e24\u79cd Planner \u5b9e\u73b0\uff0c\u5206\u522b\u9002\u7528\u4e8e\u4e0d\u540c\u7c7b\u578b\u7684\u6a21\u578b\uff1a</p> <ul> <li>BuiltinPlanner\uff1a\u9002\u7528\u4e8e\u652f\u6301\u539f\u751f\u601d\u8003\u529f\u80fd\u7684\u6a21\u578b</li> <li>ReActPlanner\uff1a\u9002\u7528\u4e8e\u4e0d\u652f\u6301\u539f\u751f\u601d\u8003\u7684\u6a21\u578b\uff0c\u901a\u8fc7\u6807\u7b7e\u5316\u6307\u4ee4\u5f15\u5bfc\u6a21\u578b\u6309\u56fa\u5b9a\u683c\u5f0f\u8f93\u51fa\uff0c\u63d0\u4f9b\u7ed3\u6784\u5316\u7684\u601d\u8003\u8fc7\u7a0b</li> </ul>"},{"location":"zh/planner/#planner_1","title":"Planner \u63a5\u53e3","text":"<p>Planner \u63a5\u53e3\u5b9a\u4e49\u4e86\u6240\u6709\u89c4\u5212\u5668\u5fc5\u987b\u5b9e\u73b0\u7684\u65b9\u6cd5\uff1a</p> <pre><code>type Planner interface {\n    // BuildPlanningInstruction \u5e94\u7528\u5fc5\u8981\u7684\u914d\u7f6e\u5230 LLM \u8bf7\u6c42\uff0c\u5e76\u6784\u5efa\u8981\u9644\u52a0\u7684\u7cfb\u7edf\u6307\u4ee4\u7528\u4e8e\u89c4\u5212\n    // \u5982\u679c\u4e0d\u9700\u8981\u6307\u4ee4\u5219\u8fd4\u56de\u7a7a\u5b57\u7b26\u4e32\n    BuildPlanningInstruction(\n        ctx context.Context,\n        invocation *agent.Invocation,\n        llmRequest *model.Request,\n    ) string\n\n    // ProcessPlanningResponse \u5904\u7406 LLM \u7684\u89c4\u5212\u54cd\u5e94\n    ProcessPlanningResponse(\n        ctx context.Context,\n        invocation *agent.Invocation,\n        response *model.Response,\n    ) *model.Response\n}\n</code></pre> <p>Planner \u7684\u5de5\u4f5c\u6d41\u7a0b\uff1a</p> <ol> <li>\u8bf7\u6c42\u5904\u7406\u9636\u6bb5\uff1aPlanner \u5728 LLM \u8bf7\u6c42\u53d1\u9001\u524d\u901a\u8fc7 <code>BuildPlanningInstruction</code> \u6dfb\u52a0\u89c4\u5212\u6307\u4ee4\u6216\u914d\u7f6e</li> <li>\u54cd\u5e94\u5904\u7406\u9636\u6bb5\uff1aPlanner \u5904\u7406 LLM \u54cd\u5e94\uff0c\u901a\u8fc7 <code>ProcessPlanningResponse</code> \u5904\u7406\u5185\u5bb9</li> </ol>"},{"location":"zh/planner/#planner_2","title":"\u4e0d\u4f7f\u7528 Planner \u7684\u601d\u7ef4\u542f\u7528\u4e0e\u6293\u53d6","text":"<p>\u5373\u4f7f\u4e0d\u4f7f\u7528 Planner\uff0c\u4e5f\u53ef\u4ee5\u542f\u7528\u5e76\u8bfb\u53d6\u6a21\u578b\u7684\u5185\u90e8\u63a8\u7406\uff08thinking\uff09\u3002\u901a\u8fc7 GenerationConfig \u8bf7\u6c42\u601d\u7ef4\u8f93\u51fa\uff0c\u5e76\u5728\u54cd\u5e94\u4e2d\u4ece ReasoningContent \u6293\u53d6\u63a8\u7406\u5185\u5bb9\u3002</p>"},{"location":"zh/planner/#generationconfig","title":"\u901a\u8fc7 GenerationConfig \u542f\u7528","text":"<pre><code>genConfig := model.GenerationConfig{\n    Stream:      true,  // \u6d41\u5f0f\u6216\u975e\u6d41\u5f0f\n    MaxTokens:   2000,\n    Temperature: 0.7,\n}\n\n// \u542f\u7528\u601d\u7ef4\uff08\u82e5\u63d0\u4f9b\u65b9/\u6a21\u578b\u652f\u6301\uff09\nthinkingEnabled := true\nthinkingTokens := 2048\ngenConfig.ThinkingEnabled = &amp;thinkingEnabled\ngenConfig.ThinkingTokens  = &amp;thinkingTokens\n</code></pre> <p>\u5728\u6784\u5efa Agent \u65f6\u6302\u8f7d\u8be5 genConfig\u3002</p>"},{"location":"zh/planner/#_1","title":"\u4ece\u54cd\u5e94\u4e2d\u6293\u53d6\u63a8\u7406","text":"<ul> <li>\u6d41\u5f0f\uff1a\u8bfb\u53d6 <code>choice.Delta.ReasoningContent</code>\uff08\u63a8\u7406\uff09\u4e0e <code>choice.Delta.Content</code>\uff08\u53ef\u89c1\u6587\u672c\uff09</li> <li>\u975e\u6d41\u5f0f\uff1a\u8bfb\u53d6 <code>choice.Message.ReasoningContent</code> \u4e0e <code>choice.Message.Content</code></li> </ul> <pre><code>eventChan, err := runner.Run(ctx, userID, sessionID, model.NewUserMessage(\"\u95ee\u9898\"))\nif err != nil { /* \u5904\u7406\u9519\u8bef */ }\n\nfor e := range eventChan {\n    if e.Error != nil {\n        fmt.Printf(\"\u9519\u8bef: %s\\n\", e.Error.Message)\n        continue\n    }\n    if len(e.Response.Choices) == 0 {\n        continue\n    }\n    ch := e.Response.Choices[0]\n\n    // \u82e5\u5b58\u5728\u63a8\u7406\uff0c\u4ee5\u6de1\u8272\u6253\u5370\n    if genConfig.Stream {\n        if rc := ch.Delta.ReasoningContent; rc != \"\" {\n            fmt.Printf(\"\\x1b[2m%s\\x1b[0m\", rc)\n        }\n        if content := ch.Delta.Content; content != \"\" {\n            fmt.Print(content)\n        }\n    } else {\n        if rc := ch.Message.ReasoningContent; rc != \"\" {\n            fmt.Printf(\"\\x1b[2m%s\\x1b[0m\\n\", rc)\n        }\n        if content := ch.Message.Content; content != \"\" {\n            fmt.Println(content)\n        }\n    }\n\n    if e.IsFinalResponse() {\n        fmt.Println()\n        break\n    }\n}\n</code></pre> <p>\u6ce8\u610f\uff1a - \u63a8\u7406\u5185\u5bb9\u7684\u53ef\u89c1\u6027\u53d6\u51b3\u4e8e\u6a21\u578b\u4e0e\u670d\u52a1\u63d0\u4f9b\u65b9\uff1b\u542f\u7528\u76f8\u5173\u53c2\u6570\u4ec5\u4ee3\u8868\u671f\u671b\uff0c\u5e76\u4e0d\u4fdd\u8bc1\u4e00\u5b9a\u8fd4\u56de\u3002 - \u5728\u6d41\u5f0f\u6a21\u5f0f\u4e0b\uff0c\u53ef\u5728\u63a8\u7406\u4e0e\u6b63\u5e38\u5185\u5bb9\u4e4b\u95f4\u9002\u5f53\u63d2\u5165\u7a7a\u884c\uff0c\u4ee5\u63d0\u5347\u9605\u8bfb\u4f53\u9a8c\u3002 - \u4f1a\u8bdd\u5386\u53f2\u53ef\u80fd\u4f1a\u5c06\u5206\u6bb5\u63a8\u7406\u6c47\u603b\u5230\u6700\u7ec8\u6d88\u606f\uff0c\u4fbf\u4e8e\u540e\u7eed\u67e5\u770b\u4e0e\u56de\u6eaf\u3002</p>"},{"location":"zh/planner/#builtinplanner","title":"BuiltinPlanner","text":"<p>BuiltinPlanner \u9002\u7528\u4e8e\u652f\u6301\u539f\u751f\u601d\u8003\u529f\u80fd\u7684\u6a21\u578b\u3002\u5b83\u4e0d\u751f\u6210\u663e\u5f0f\u7684\u89c4\u5212\u6307\u4ee4\uff0c\u800c\u662f\u901a\u8fc7\u914d\u7f6e\u6a21\u578b\u4f7f\u7528\u5176\u5185\u90e8\u7684\u601d\u8003\u673a\u5236\u6765\u5b9e\u73b0\u89c4\u5212\u529f\u80fd\u3002</p> <p>\u6a21\u578b\u914d\u7f6e\u5982\u4e0b\uff1a</p> <pre><code>type Options struct {\n    // ReasoningEffort \u9650\u5236\u63a8\u7406\u6a21\u578b\u7684\u63a8\u7406\u7a0b\u5ea6\n    // \u652f\u6301\u7684\u503c\uff1a\"low\", \"medium\", \"high\"\n    // \u4ec5\u5bf9 OpenAI o-series \u6a21\u578b\u6709\u6548\n    ReasoningEffort *string\n    // ThinkingEnabled \u4e3a\u652f\u6301\u601d\u8003\u7684\u6a21\u578b\u542f\u7528\u601d\u8003\u6a21\u5f0f\n    // \u4ec5\u5bf9\u901a\u8fc7 OpenAI API \u7684 Claude \u548c Gemini \u6a21\u578b\u6709\u6548\n    ThinkingEnabled *bool\n    // ThinkingTokens \u63a7\u5236\u601d\u8003\u7684\u957f\u5ea6\n    // \u4ec5\u5bf9\u901a\u8fc7 OpenAI API \u7684 Claude \u548c Gemini \u6a21\u578b\u6709\u6548\n    ThinkingTokens *int\n}\n</code></pre> <p>\u5728\u5b9e\u73b0\u4e0a\uff0cBuiltinPlanner \u901a\u8fc7\u4ee5\u4e0b\u65b9\u5f0f\u5de5\u4f5c\uff1a</p> <ul> <li><code>BuildPlanningInstruction</code>\uff1a\u5c06\u601d\u8003\u53c2\u6570\u914d\u7f6e\u5230 LLM \u8bf7\u6c42\u4e2d\uff1b\u7531\u4e8e\u6a21\u578b\u652f\u6301\u539f\u751f\u601d\u8003\uff0c\u4e0d\u9700\u8981\u89c4\u5212\u6807\u7b7e\uff0c\u56e0\u6b64\u76f4\u63a5\u8fd4\u56de\u7a7a\u5b57\u7b26\u4e32</li> <li><code>ProcessPlanningResponse</code>\uff1a\u7531\u4e8e\u6a21\u578b\u5728\u54cd\u5e94\u4e2d\u5df2\u7ecf\u5305\u542b\u4e86\u89c4\u5212\u8fc7\u7a0b\uff0c\u56e0\u6b64\u76f4\u63a5\u8fd4\u56de nil</li> </ul> <p>\u793a\u4f8b\u5982\u4e0b\uff1a</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/agent/llmagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/openai\"\n    \"trpc.group/trpc-go/trpc-agent-go/planner/builtin\"\n)\n\n// \u521b\u5efa\u6a21\u578b\u5b9e\u4f8b\nmodelInstance := openai.New(\"gpt-4o-mini\")\n\n// \u521b\u5efa BuiltinPlanner\nreasoningEffort := \"high\"\nplanner := builtin.New(builtin.Options{\n    ReasoningEffort: &amp;reasoningEffort,\n})\n\n// \u521b\u5efa LLMAgent \u5e76\u914d\u7f6e Planner\nllmAgent := llmagent.New(\n    \"demo-agent\",\n    llmagent.WithModel(modelInstance),\n    llmagent.WithDescription(\"A helpful AI assistant with built-in planning\"),\n    llmagent.WithInstruction(\"Be helpful and think through problems carefully\"),\n    llmagent.WithPlanner(planner), // \u914d\u7f6e Planner\n)\n</code></pre>"},{"location":"zh/planner/#reactplanner","title":"ReActPlanner","text":"<p>ReActPlanner \u9002\u7528\u4e8e\u4e0d\u652f\u6301\u539f\u751f\u601d\u8003\u7684\u6a21\u578b\u3002\u5b83\u901a\u8fc7\u5f15\u5bfc LLM \u9075\u5faa\u7279\u5b9a\u7684\u683c\u5f0f\uff0c\u4f7f\u7528\u7279\u5b9a\u6807\u7b7e\u6765\u7ec4\u7ec7\u89c4\u5212\u3001\u63a8\u7406\u3001\u884c\u52a8\u548c\u6700\u7ec8\u7b54\u6848\uff0c\u4ece\u800c\u5b9e\u73b0\u7ed3\u6784\u5316\u7684\u601d\u8003\u8fc7\u7a0b\u3002</p> <p>ReActPlanner \u4f7f\u7528\u4ee5\u4e0b\u7279\u5b9a\u6807\u7b7e\u6765\u7ec4\u7ec7\u54cd\u5e94\u5185\u5bb9\uff1a</p> <ol> <li>\u89c4\u5212\u9636\u6bb5\uff08<code>/*PLANNING*/</code>\uff09\uff1a\u521b\u5efa\u660e\u786e\u7684\u8ba1\u5212\u6765\u56de\u7b54\u7528\u6237\u95ee\u9898</li> <li>\u63a8\u7406\u9636\u6bb5\uff08<code>/*REASONING*/</code>\uff09\uff1a\u5728\u5de5\u5177\u6267\u884c\u4e4b\u95f4\u63d0\u4f9b\u63a8\u7406</li> <li>\u884c\u52a8\u9636\u6bb5\uff08<code>/*ACTION*/</code>\uff09\uff1a\u6839\u636e\u8ba1\u5212\u6267\u884c\u5de5\u5177</li> <li>\u91cd\u65b0\u89c4\u5212\uff08<code>/*REPLANNING*/</code>\uff09\uff1a\u6839\u636e\u7ed3\u679c\u9700\u8981\u65f6\u4fee\u8ba2\u8ba1\u5212</li> <li>\u6700\u7ec8\u7b54\u6848\uff08<code>/*FINAL_ANSWER*/</code>\uff09\uff1a\u63d0\u4f9b\u7efc\u5408\u7b54\u6848</li> </ol> <p>\u5728\u5b9e\u73b0\u4e0a\uff0cReActPlanner \u901a\u8fc7\u4ee5\u4e0b\u65b9\u5f0f\u5de5\u4f5c\uff1a</p> <ul> <li><code>BuildPlanningInstruction</code>\uff1a\u8fd4\u56de\u5305\u542b\u9ad8\u5c42\u6b21\u6307\u5bfc\u3001\u89c4\u5212\u8981\u6c42\u3001\u63a8\u7406\u8981\u6c42\u7b49\u7684\u7efc\u5408\u6307\u4ee4\uff0c\u5f15\u5bfc\u6a21\u578b\u6309\u6807\u7b7e\u683c\u5f0f\u8f93\u51fa</li> <li><code>ProcessPlanningResponse</code>\uff1a\u8fc7\u6ee4\u7a7a\u540d\u79f0\u7684\u5de5\u5177\u8c03\u7528\uff0c\u5982\u679c\u5185\u5bb9\u5305\u542b <code>/*FINAL_ANSWER*/</code> \u6807\u7b7e\u5219\u53ea\u4fdd\u7559\u6700\u7ec8\u7b54\u6848\u90e8\u5206\uff0c\u5426\u5219\u8fd4\u56de\u539f\u5185\u5bb9\uff0c\u5c06\u89c4\u5212\u5185\u5bb9\u4e0e\u6700\u7ec8\u7b54\u6848\u5206\u79bb</li> </ul> <p>\u4f7f\u7528\u793a\u4f8b\uff1a</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/agent/llmagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/openai\"\n    \"trpc.group/trpc-go/trpc-agent-go/planner/react\"\n    \"trpc.group/trpc-go/trpc-agent-go/tool/function\"\n)\n\n// \u521b\u5efa\u6a21\u578b\u5b9e\u4f8b\nmodelInstance := openai.New(\"gpt-4o-mini\")\n\n// \u521b\u5efa\u5de5\u5177\nsearchTool := function.NewFunctionTool(\n    searchFunction,\n    function.WithName(\"search\"),\n    function.WithDescription(\"Search for information on a given topic\"),\n)\n\n// \u521b\u5efa ReActPlanner\nplanner := react.New()\n\n// \u521b\u5efa LLMAgent \u5e76\u914d\u7f6e Planner\nllmAgent := llmagent.New(\n    \"react-agent\",\n    llmagent.WithModel(modelInstance),\n    llmagent.WithDescription(\"An AI assistant that uses structured planning\"),\n    llmagent.WithInstruction(\"Follow a structured approach to solve problems\"),\n    llmagent.WithPlanner(planner), // \u914d\u7f6e Planner\n    llmagent.WithTools([]tool.Tool{searchTool}), // \u914d\u7f6e\u5de5\u5177\n)\n</code></pre> <p>\u5b8c\u6574\u4ee3\u7801\u793a\u4f8b\u53ef\u53c2\u8003 examples/react</p>"},{"location":"zh/planner/#planner_3","title":"\u81ea\u5b9a\u4e49 Planner","text":"<p>\u9664\u4e86\u6846\u67b6\u63d0\u4f9b\u7684\u4e24\u79cd Planner \u5b9e\u73b0\uff0c\u4f60\u8fd8\u53ef\u4ee5\u901a\u8fc7\u5b9e\u73b0 <code>Planner</code> \u63a5\u53e3\u6765\u521b\u5efa\u81ea\u5b9a\u4e49\u7684 Planner\uff0c\u4ee5\u6ee1\u8db3\u7279\u5b9a\u9700\u6c42\uff1a</p> <pre><code>type customPlanner struct {\n    // \u81ea\u5b9a\u4e49\u914d\u7f6e\n}\n\nfunc (p *customPlanner) BuildPlanningInstruction(\n    ctx context.Context,\n    invocation *agent.Invocation,\n    llmRequest *model.Request,\n) string {\n    // \u8fd4\u56de\u81ea\u5b9a\u4e49\u7684\u89c4\u5212\u6307\u4ee4\n    return \"\u4f60\u7684\u81ea\u5b9a\u4e49\u89c4\u5212\u6307\u4ee4\"\n}\n\nfunc (p *customPlanner) ProcessPlanningResponse(\n    ctx context.Context,\n    invocation *agent.Invocation,\n    response *model.Response,\n) *model.Response {\n    // \u5904\u7406\u54cd\u5e94\n    return response\n}\n\n// \u521b\u5efa LLMAgent \u5e76\u914d\u7f6e\u81ea\u5b9a\u4e49 Planner\nllmAgent := llmagent.New(\n    \"react-agent\",\n    llmagent.WithModel(modelInstance),\n    llmagent.WithDescription(\"An AI assistant that uses structured planning\"),\n    llmagent.WithInstruction(\"Follow a structured approach to solve problems\"),\n    llmagent.WithPlanner(&amp;customPlanner{}),      // \u914d\u7f6e Planner\n    llmagent.WithTools([]tool.Tool{searchTool}), // \u914d\u7f6e\u5de5\u5177\n)\n</code></pre>"},{"location":"zh/runner/","title":"Runner \u7ec4\u4ef6\u4f7f\u7528\u624b\u518c","text":""},{"location":"zh/runner/#_1","title":"\u6982\u8ff0","text":"<p>Runner \u63d0\u4f9b\u4e86\u8fd0\u884c Agent \u7684\u63a5\u53e3\uff0c\u8d1f\u8d23\u4f1a\u8bdd\u7ba1\u7406\u548c\u4e8b\u4ef6\u6d41\u5904\u7406\u3002Runner \u7684\u6838\u5fc3\u804c\u8d23\u662f\uff1a\u83b7\u53d6\u6216\u521b\u5efa\u4f1a\u8bdd\u3001\u751f\u6210 Invocation ID\u3001\u8c03\u7528 Agent.Run \u65b9\u6cd5\u3001\u5904\u7406\u8fd4\u56de\u7684\u4e8b\u4ef6\u6d41\u5e76\u5c06\u975e partial \u54cd\u5e94\u4e8b\u4ef6\u8ffd\u52a0\u5230\u4f1a\u8bdd\u4e2d\u3002</p>"},{"location":"zh/runner/#_2","title":"\ud83c\udfaf \u6838\u5fc3\u7279\u6027","text":"<ul> <li>\ud83d\udcbe \u4f1a\u8bdd\u7ba1\u7406\uff1a\u901a\u8fc7 sessionService \u83b7\u53d6/\u521b\u5efa\u4f1a\u8bdd\uff0c\u9ed8\u8ba4\u4f7f\u7528 inmemory.NewSessionService()</li> <li>\ud83d\udd04 \u4e8b\u4ef6\u5904\u7406\uff1a\u63a5\u6536 Agent \u4e8b\u4ef6\u6d41\uff0c\u5c06\u975e partial \u54cd\u5e94\u4e8b\u4ef6\u8ffd\u52a0\u5230\u4f1a\u8bdd\u4e2d</li> <li>\ud83c\udd94 ID \u751f\u6210\uff1a\u81ea\u52a8\u751f\u6210 Invocation ID \u548c\u4e8b\u4ef6 ID</li> <li>\ud83d\udcca \u53ef\u89c2\u6d4b\u96c6\u6210\uff1a\u96c6\u6210 telemetry/trace\uff0c\u81ea\u52a8\u8bb0\u5f55 span</li> <li>\u2705 \u5b8c\u6210\u4e8b\u4ef6\uff1a\u5728 Agent \u4e8b\u4ef6\u6d41\u7ed3\u675f\u540e\u751f\u6210 runner-completion \u4e8b\u4ef6</li> </ul>"},{"location":"zh/runner/#_3","title":"\u67b6\u6784\u8bbe\u8ba1","text":"<pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502       Runner        \u2502  - \u4f1a\u8bdd\u7ba1\u7406\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  - \u4e8b\u4ef6\u6d41\u5904\u7406\n          \u2502\n          \u2502 r.agent.Run(ctx, invocation)\n          \u2502\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502       Agent         \u2502  - \u63a5\u6536 Invocation\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  - \u8fd4\u56de &lt;-chan *event.Event\n          \u2502\n          \u2502 \u5177\u4f53\u5b9e\u73b0\u7531 Agent \u51b3\u5b9a\n          \u2502\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502     Agent \u5b9e\u73b0      \u2502  \u5982 LLMAgent, ChainAgent \u7b49\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre>"},{"location":"zh/runner/#_4","title":"\ud83d\ude80 \u5feb\u901f\u5f00\u59cb","text":""},{"location":"zh/runner/#_5","title":"\ud83d\udccb \u73af\u5883\u8981\u6c42","text":"<ul> <li>Go 1.21 \u6216\u66f4\u9ad8\u7248\u672c</li> <li>\u6709\u6548\u7684 LLM API \u5bc6\u94a5\uff08OpenAI \u517c\u5bb9\u63a5\u53e3\uff09</li> <li>Redis\uff08\u53ef\u9009\uff0c\u7528\u4e8e\u5206\u5e03\u5f0f\u4f1a\u8bdd\u7ba1\u7406\uff09</li> </ul>"},{"location":"zh/runner/#_6","title":"\ud83d\udca1 \u6700\u7b80\u793a\u4f8b","text":"<pre><code>package main\n\nimport (\n    \"context\"\n    \"fmt\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/agent\"\n    \"trpc.group/trpc-go/trpc-agent-go/agent/llmagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/model\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/openai\"\n    \"trpc.group/trpc-go/trpc-agent-go/runner\"\n)\n\nfunc main() {\n    // 1. \u521b\u5efa\u6a21\u578b\n    llmModel := openai.New(\"DeepSeek-V3-Online-64K\")\n\n    // 2. \u521b\u5efa Agent\n    a := llmagent.New(\"assistant\",\n        llmagent.WithModel(llmModel),\n        llmagent.WithInstruction(\"\u4f60\u662f\u4e00\u4e2a\u6709\u5e2e\u52a9\u7684AI\u52a9\u624b\"),\n        llmagent.WithGenerationConfig(model.GenerationConfig{Stream: true}), // \u542f\u7528\u6d41\u5f0f\u8f93\u51fa\n    )\n\n    // 3. \u521b\u5efa Runner\n    r := runner.NewRunner(\"my-app\", a)\n    defer r.Close()  // \u786e\u4fdd\u8d44\u6e90\u88ab\u6e05\u7406 (trpc-agent-go &gt;= v0.5.0)\n\n    // 4. \u8fd0\u884c\u5bf9\u8bdd\n    ctx := context.Background()\n    userMessage := model.NewUserMessage(\"\u4f60\u597d\uff01\")\n\n    eventChan, err := r.Run(ctx, \"user1\", \"session1\", userMessage, agent.WithRequestID(\"request-ID\"))\n    if err != nil {\n        panic(err)\n    }\n\n    // 5. \u5904\u7406\u54cd\u5e94\n    for event := range eventChan {\n        if event.Error != nil {\n            fmt.Printf(\"\u9519\u8bef: %s\\n\", event.Error.Message)\n            continue\n        }\n\n        if len(event.Response.Choices) &gt; 0 {\n            fmt.Print(event.Response.Choices[0].Delta.Content)\n        }\n        // Recommended: stop when Runner emits its completion event.\n        if event.IsRunnerCompletion() {\n            break\n        }\n    }\n}\n</code></pre>"},{"location":"zh/runner/#_7","title":"\ud83d\ude80 \u8fd0\u884c\u793a\u4f8b","text":"<pre><code># \u8fdb\u5165\u793a\u4f8b\u76ee\u5f55\ncd examples/runner\n\n# \u8bbe\u7f6eAPI\u5bc6\u94a5\nexport OPENAI_API_KEY=\"your-api-key\"\n\n# \u57fa\u7840\u8fd0\u884c\ngo run main.go\n\n# \u4f7f\u7528Redis\u4f1a\u8bdd\ndocker run -d -p 6379:6379 redis:alpine\ngo run main.go -session redis\n\n# \u81ea\u5b9a\u4e49\u6a21\u578b\ngo run main.go -model \"gpt-4o-mini\"\n</code></pre>"},{"location":"zh/runner/#_8","title":"\ud83d\udcac \u4ea4\u4e92\u5f0f\u529f\u80fd","text":"<p>\u8fd0\u884c\u793a\u4f8b\u540e\uff0c\u652f\u6301\u4ee5\u4e0b\u7279\u6b8a\u547d\u4ee4\uff1a</p> <ul> <li><code>/history</code> - \u8bf7\u6c42 AI \u663e\u793a\u5bf9\u8bdd\u5386\u53f2</li> <li><code>/new</code> - \u5f00\u59cb\u65b0\u7684\u4f1a\u8bdd\uff08\u91cd\u7f6e\u5bf9\u8bdd\u4e0a\u4e0b\u6587\uff09</li> <li><code>/exit</code> - \u7ed3\u675f\u5bf9\u8bdd</li> </ul> <p>\u5f53 AI \u4f7f\u7528\u5de5\u5177\u65f6\uff0c\u4f1a\u663e\u793a\u8be6\u7ec6\u7684\u8c03\u7528\u8fc7\u7a0b\uff1a</p> <pre><code>\ud83d\udd27 \u5de5\u5177\u8c03\u7528:\n   \u2022 calculator (ID: call_abc123)\n     \u53c2\u6570: {\"operation\":\"multiply\",\"a\":25,\"b\":4}\n\n\ud83d\udd04 \u6267\u884c\u4e2d...\n\u2705 \u5de5\u5177\u54cd\u5e94 (ID: call_abc123): {\"operation\":\"multiply\",\"a\":25,\"b\":4,\"result\":100}\n\n\ud83e\udd16 \u52a9\u624b: \u6211\u4e3a\u60a8\u8ba1\u7b97\u4e86 25 \u00d7 4 = 100\u3002\n</code></pre>"},{"location":"zh/runner/#api","title":"\ud83d\udd27 \u6838\u5fc3 API","text":""},{"location":"zh/runner/#runner_1","title":"Runner \u521b\u5efa","text":"<pre><code>// \u57fa\u7840\u521b\u5efa\nr := runner.NewRunner(appName, agent, options...)\n\n// \u5e38\u7528\u9009\u9879\nr := runner.NewRunner(\"my-app\", agent,\n    runner.WithSessionService(sessionService),  // \u4f1a\u8bdd\u670d\u52a1\n)\n</code></pre>"},{"location":"zh/runner/#_9","title":"\u8fd0\u884c\u5bf9\u8bdd","text":"<pre><code>// \u6267\u884c\u5355\u6b21\u5bf9\u8bdd\neventChan, err := r.Run(ctx, userID, sessionID, message, options...)\n</code></pre>"},{"location":"zh/runner/#_10","title":"\u4e2d\u65ad\u6062\u590d\uff08\u5de5\u5177\u4f18\u5148\u7ee7\u7eed\u6267\u884c\uff09","text":"<p>\u5728\u771f\u5b9e\u4e1a\u52a1\u91cc\uff0c\u7528\u6237\u53ef\u80fd\u5728 Agent \u8fd8\u5904\u4e8e\u201c\u5de5\u5177\u8c03\u7528\u9636\u6bb5\u201d\u65f6\u4e2d\u65ad\uff1a</p> <ul> <li>\u4f1a\u8bdd\u91cc\u7684\u6700\u540e\u4e00\u6761\u6d88\u606f\u662f\u5e26 <code>tool_calls</code> \u7684 assistant \u6d88\u606f\uff1b</li> <li>\u4f46\u5bf9\u5e94\u7684\u5de5\u5177\u7ed3\u679c\uff08tool result\uff09\u8fd8\u6ca1\u6765\u5f97\u53ca\u5199\u56de Session\u3002</li> </ul> <p>\u4e4b\u540e\u5982\u679c\u4f60\u60f3\u5728\u540c\u4e00\u4e2a <code>sessionID</code> \u4e0a\u201c\u7ee7\u7eed\u4e0a\u6b21\u7684\u4efb\u52a1\u201d\uff0c\u53ef\u4ee5\u5f00\u542f <code>WithResume(true)</code>\uff0c\u8ba9 Runner \u5148\u628a\u4e0a\u6b21\u672a\u5b8c\u6210\u7684\u5de5\u5177\u8c03\u7528\u6267\u884c\u5b8c\uff0c\u518d\u8fdb\u5165 \u4e0b\u4e00\u8f6e LLM \u8c03\u7528\uff1a</p> <pre><code>eventChan, err := r.Run(\n    ctx,\n    userID,\n    sessionID,\n    model.Message{},          // \u6ca1\u6709\u65b0\u7684\u7528\u6237\u8f93\u5165\n    agent.WithResume(true),   // \u5f00\u542f\u6062\u590d\u6a21\u5f0f\n)\n</code></pre> <p>\u5f00\u542f <code>WithResume(true)</code> \u65f6\uff0cRunner \u4f1a\uff1a</p> <ul> <li>\u8bfb\u53d6\u5f53\u524d Session \u4e2d\u6700\u65b0\u7684\u4e00\u6761\u4e8b\u4ef6\uff1b</li> <li>\u5982\u679c\u6700\u540e\u4e00\u6761\u662f\u300c\u5e26 <code>tool_calls</code> \u7684 assistant \u56de\u590d\u300d\uff0c\u4e14\u4e4b\u540e\u6ca1\u6709\u5bf9\u5e94\u7684   \u5de5\u5177\u7ed3\u679c\u4e8b\u4ef6\uff1a<ul> <li>\u4f7f\u7528\u5f53\u524d Agent \u6ce8\u518c\u7684\u5de5\u5177\u96c6\u5408\u548c\u56de\u8c03\uff0c\u6267\u884c\u8fd9\u4e9b\u201c\u672a\u5b8c\u6210\u7684\u5de5\u5177\u8c03\u7528\u201d\uff1b</li> <li>\u628a\u5de5\u5177\u6267\u884c\u7ed3\u679c\u5199\u5165 Session\uff08\u4f5c\u4e3a tool \u6d88\u606f\u4e8b\u4ef6\uff09\uff1b</li> </ul> </li> <li>\u5de5\u5177\u6267\u884c\u7ed3\u675f\u540e\uff0c\u518d\u6309\u6b63\u5e38\u6d41\u7a0b\u53d1\u8d77\u65b0\u4e00\u8f6e LLM \u8c03\u7528\uff0c\u6b64\u65f6\u6a21\u578b\u80fd\u770b\u5230   \u201c\u4e0a\u4e00\u6b21\u7684 tool_calls + \u5bf9\u5e94\u7684\u5de5\u5177\u7ed3\u679c\u201d\uff0c\u4e0d\u4f1a\u91cd\u590d\u8981\u6c42\u8c03\u7528\u540c\u4e00\u5de5\u5177\u3002</li> </ul> <p>\u5982\u679c\u6700\u540e\u4e00\u6761\u4e8b\u4ef6\u662f user / tool \u6d88\u606f\uff0c\u6216\u8005\u662f\u666e\u901a\u7684 assistant \u6587\u672c\u56de\u590d\uff0c \u5219 <code>WithResume(true)</code> \u4e0d\u4f1a\u505a\u4efb\u4f55\u989d\u5916\u5904\u7406\uff0c\u884c\u4e3a\u7b49\u540c\u4e8e\u666e\u901a\u7684 <code>Run</code> \u8c03\u7528\u3002</p>"},{"location":"zh/runner/#auto-seed-session","title":"\u4f20\u5165\u5bf9\u8bdd\u5386\u53f2\uff08auto-seed + \u590d\u7528 Session\uff09","text":"<p>\u5982\u679c\u4e0a\u6e38\u670d\u52a1\u5df2\u7ecf\u7ef4\u62a4\u4e86\u4f1a\u8bdd\u5386\u53f2\uff0c\u5e76\u5e0c\u671b\u8ba9 Agent \u770b\u89c1\u8fd9\u4e9b\u4e0a\u4e0b\u6587\uff0c\u53ef\u4ee5\u76f4\u63a5\u4f20\u5165\u6574\u6bb5 <code>[]model.Message</code>\u3002Runner \u4f1a\u5728 Session \u4e3a\u7a7a\u65f6\u81ea\u52a8\u5c06\u5176\u5199\u5165 Session\uff0c\u5e76\u5728\u968f\u540e\u7684\u8f6e\u6b21\u5c06 \u65b0\u4e8b\u4ef6\uff08\u5de5\u5177\u8c03\u7528\u3001\u540e\u7eed\u56de\u590d\u7b49\uff09\u7ee7\u7eed\u5199\u5165\u3002</p> <p>\u65b9\u5f0f A\uff1a\u4f7f\u7528\u4fbf\u6377\u51fd\u6570 <code>runner.RunWithMessages</code></p> <pre><code>msgs := []model.Message{\n    model.NewSystemMessage(\"\u4f60\u662f\u4e00\u4e2a\u6709\u5e2e\u52a9\u7684\u52a9\u624b\"),\n    model.NewUserMessage(\"\u7b2c\u4e00\u6761\u7528\u6237\u8f93\u5165\"),\n    model.NewAssistantMessage(\"\u4e0a\u4e00\u8f6e\u52a9\u624b\u56de\u590d\"),\n    model.NewUserMessage(\"\u65b0\u7684\u95ee\u9898\u662f\u4ec0\u4e48\uff1f\"),\n}\n\nch, err := runner.RunWithMessages(ctx, r, userID, sessionID, msgs, agent.WithRequestID(\"request-ID\"))\n</code></pre> <p>\u793a\u4f8b\uff1a<code>examples/runwithmessages</code>\uff08\u4f7f\u7528 <code>RunWithMessages</code>\uff1bRunner \u4f1a auto-seed \u5e76\u590d\u7528 Session\uff09</p> <p>\u65b9\u5f0f B\uff1a\u901a\u8fc7 RunOption \u663e\u5f0f\u4f20\u5165\uff08\u4e0e Python ADK \u4e00\u81f4\u7684\u7406\u5ff5\uff09</p> <pre><code>msgs := []model.Message{ /* \u540c\u4e0a */ }\nch, err := r.Run(ctx, userID, sessionID, model.Message{}, agent.WithMessages(msgs))\n</code></pre> <p>\u6ce8\u610f\uff1a\u5f53\u663e\u5f0f\u4f20\u5165 <code>[]model.Message</code> \u65f6\uff0cRunner \u4f1a\u5728 Session \u4e3a\u7a7a\u65f6\u81ea\u52a8\u628a\u8fd9\u6bb5\u5386\u53f2\u5199\u5165 Session\u3002\u5185\u5bb9\u5904\u7406\u5668\u4e0d\u4f1a\u8bfb\u53d6\u8fd9\u4e2a\u9009\u9879\uff0c\u5b83\u53ea\u4f1a\u4ece Session \u4e8b\u4ef6\u4e2d\u6d3e\u751f\u6d88\u606f\uff08\u6216\u5728 Session \u6ca1\u6709\u4e8b\u4ef6\u65f6\u56de\u9000\u5230\u5355\u6761 <code>invocation.Message</code>\uff09\u3002<code>RunWithMessages</code> \u4ecd\u4f1a\u628a\u6700\u65b0\u7684\u7528\u6237\u6d88\u606f\u5199\u5165 <code>invocation.Message</code>\u3002</p>"},{"location":"zh/runner/#_11","title":"\u2705 \u56fe\u5f0f\u6d41\u7a0b\u7684\u201c\u4f18\u96c5\u7ed3\u675f\u201d\u4e0e\u6700\u7ec8\u7ed3\u679c\u8bfb\u53d6","text":"<p>\u5f88\u591a\u540c\u5b66\u5728\u4f7f\u7528 GraphAgent\uff08\u56fe\u5f0f\u667a\u80fd\u4f53\uff09\u65f6\uff0c\u4f1a\u8bef\u628a <code>Response.IsFinalResponse()</code> \u5f53\u4f5c\u201c\u6d41\u7a0b\u5b8c\u6210\u201d\u7684\u4fe1\u53f7\u3002\u8bf7\u6ce8\u610f\uff1a<code>IsFinalResponse()</code> \u53ea\u662f\u201c\u5927\u6a21\u578b\u672c\u8f6e\u56de\u590d\u5df2\u7ed3\u675f\u201d\uff0c\u4f46\u56fe\u4e0a\u540e\u7eed\u8282\u70b9\uff08\u4f8b\u5982 <code>output</code> \u6c47\u603b\u8282\u70b9\uff09\u4ecd\u53ef\u80fd\u5728\u7ee7\u7eed\u6267\u884c\u3002</p> <p>\u6700\u7a33\u59a5\u3001\u7edf\u4e00\u7684\u505a\u6cd5\u662f\uff1a\u4ee5 Runner \u7684\u201c\u5b8c\u6210\u4e8b\u4ef6\u201d\u4f5c\u4e3a\u8fd0\u884c\u7ed3\u675f\u7684\u552f\u4e00\u5224\u636e\uff1a</p> <pre><code>for e := range eventChan {\n    // ... \u5904\u7406\u6d41\u5f0f\u5206\u7247\u3001\u5de5\u5177\u53ef\u89c6\u5316\u7b49\n    if e.IsRunnerCompletion() { // Runner \u7684\u7ec8\u6b62\u4e8b\u4ef6\n        break\n    }\n}\n</code></pre> <p>\u6b64\u5916\uff0cRunner \u4f1a\u628a\u56fe\u5728\u5b8c\u6210\u65f6\u7684\u6700\u7ec8\u5feb\u7167\u4f20\u9012\u5230\u8fd9\u6761\u201c\u6700\u540e\u4e8b\u4ef6\u201d\u91cc\uff0c\u56e0\u6b64\u4f60\u53ef\u4ee5\u76f4\u63a5\u4ece\u8be5\u4e8b\u4ef6\u7684 <code>StateDelta</code> \u91cc\u8bfb\u53d6\u56fe\u7684\u6700\u7ec8\u8f93\u51fa\uff08\u4f8b\u5982 <code>graph.StateKeyLastResponse</code> \u5bf9\u5e94\u7684\u6587\u672c\uff09\uff1a</p> <pre><code>import (\n    \"encoding/json\"\n    \"fmt\"\n    \"trpc.group/trpc-go/trpc-agent-go/graph\"\n)\n\nfor e := range eventChan {\n    if e.IsRunnerCompletion() {\n        if b, ok := e.StateDelta[graph.StateKeyLastResponse]; ok {\n            var final string\n            _ = json.Unmarshal(b, &amp;final)\n            fmt.Println(\"\\nFINAL:\", final)\n        }\n        break\n    }\n}\n</code></pre> <p>\u8fd9\u6837\u5e94\u7528\u5c42\u53ef\u4ee5\u59cb\u7ec8\u201c\u770b\u6700\u540e\u4e00\u6761\u4e8b\u4ef6\u201d\u6765\u5224\u65ad\u6d41\u7a0b\u7ed3\u675f\u5e76\u8bfb\u53d6\u6700\u7ec8\u7ed3\u679c\uff0c\u907f\u514d\u56e0\u4e3a\u63d0\u524d\u9000\u51fa\u800c\u9519\u8fc7 <code>output</code> \u7b49\u540e\u7eed\u8282\u70b9\u3002</p>"},{"location":"zh/runner/#_12","title":"\ud83d\udcbe \u4f1a\u8bdd\u7ba1\u7406","text":""},{"location":"zh/runner/#_13","title":"\u5185\u5b58\u4f1a\u8bdd\uff08\u9ed8\u8ba4\uff09","text":"<pre><code>import \"trpc.group/trpc-go/trpc-agent-go/session/inmemory\"\n\nsessionService := inmemory.NewSessionService()\nr := runner.NewRunner(\"app\", agent,\n    runner.WithSessionService(sessionService))\n</code></pre>"},{"location":"zh/runner/#redis","title":"Redis \u4f1a\u8bdd\uff08\u5206\u5e03\u5f0f\uff09","text":"<pre><code>import \"trpc.group/trpc-go/trpc-agent-go/session/redis\"\n\n// \u521b\u5efa Redis \u4f1a\u8bdd\u670d\u52a1\nsessionService, err := redis.NewService(\n    redis.WithRedisClientURL(\"redis://localhost:6379\"))\n\nr := runner.NewRunner(\"app\", agent,\n    runner.WithSessionService(sessionService))\n</code></pre>"},{"location":"zh/runner/#_14","title":"\u4f1a\u8bdd\u914d\u7f6e","text":"<pre><code>// Redis \u652f\u6301\u7684\u914d\u7f6e\u9009\u9879\nsessionService, err := redis.NewService(\n    redis.WithRedisClientURL(\"redis://localhost:6379\"),\n    redis.WithSessionEventLimit(1000),         // \u9650\u5236\u4f1a\u8bdd\u4e8b\u4ef6\u6570\u91cf\n    // redis.WithRedisInstance(\"redis-instance\"), // \u6216\u4f7f\u7528\u5b9e\u4f8b\u540d\n)\n</code></pre>"},{"location":"zh/runner/#agent","title":"\ud83e\udd16 Agent \u914d\u7f6e","text":"<p>Runner \u7684\u6838\u5fc3\u804c\u8d23\u662f\u7ba1\u7406 Agent \u7684\u6267\u884c\u6d41\u7a0b\u3002\u521b\u5efa\u597d\u7684 Agent \u9700\u8981\u901a\u8fc7 Runner \u6267\u884c\u3002</p>"},{"location":"zh/runner/#agent_1","title":"\u57fa\u7840 Agent \u521b\u5efa","text":"<pre><code>// \u521b\u5efa\u57fa\u7840 Agent\uff08\u8be6\u7ec6\u914d\u7f6e\u53c2\u89c1 agent.md\uff09\nagent := llmagent.New(\"assistant\",\n    llmagent.WithModel(model),\n    llmagent.WithInstruction(\"\u4f60\u662f\u4e00\u4e2a\u6709\u5e2e\u52a9\u7684AI\u52a9\u624b\"))\n\n// \u4f7f\u7528 Runner \u6267\u884c Agent\nr := runner.NewRunner(\"my-app\", agent)\n</code></pre>"},{"location":"zh/runner/#agent_2","title":"\u5728\u8bf7\u6c42\u7ea7\u522b\u5207\u6362 Agent","text":"<p>Runner \u652f\u6301\u5728\u6784\u9020\u65f6\u6ce8\u518c\u591a\u4e2a\u53ef\u9009 Agent\uff0c\u5e76\u5728\u5355\u6b21 Run \u65f6\u5207\u6362\u3002</p> <pre><code>reader := llmagent.New(\"agent1\", llmagent.WithModel(model))\nwriter := llmagent.New(\"agent2\", llmagent.WithModel(model))\n\nr := runner.NewRunner(\"appName\", reader, // \u4f7f\u7528 reader agent \u4f5c\u4e3a\u9ed8\u8ba4 agent\n    runner.WithAgent(\"writer\", writer),  // \u6309\u540d\u79f0\u6ce8\u518c\u53ef\u9009 Agent\n)\n\n// \u4f7f\u7528 reader agent \u4f5c\u4e3a\u9ed8\u8ba4 agent\nch, err := r.Run(ctx, userID, sessionID, msg)\n\n// \u901a\u8fc7 Agent Name \u6307\u5b9a\u4f7f\u7528 writer agent\nch, err := r.Run(ctx, userID, sessionID, msg, agent.WithAgentByName(\"writer\"))\n\n// \u76f4\u63a5\u4f20\u5165\u5b9e\u4f8b\uff0c\u65e0\u9700\u9884\u6ce8\u518c\u3002\ncustom := llmagent.New(\"custom\", llmagent.WithModel(model))\nch, err := r.Run(ctx, userID, sessionID, msg, agent.WithAgent(custom))\n</code></pre> <ul> <li><code>runner.NewRunner(\"appName\", agent)</code>\uff1a\u5728\u521b\u5efa runner \u65f6\u8bbe\u7f6e\u9ed8\u8ba4 Agent\uff1b</li> <li><code>runner.WithAgent(\"agentName\", agent)</code>: \u5728\u521b\u5efa Runner \u65f6\u9884\u6ce8\u518c\u4e00\u4e2a Agent\uff0c\u4f9b\u540e\u7eed\u8bf7\u6c42\u6309\u540d\u79f0\u5207\u6362\uff1b</li> <li><code>agent.WithAgentByName(\"agentName\")</code>: \u5728\u5355\u6b21\u8bf7\u6c42\u91cc\u901a\u8fc7\u540d\u79f0\u9009\u7528\u5df2\u6ce8\u518c\u7684 Agent\uff1b</li> <li><code>agent.WithAgent(agent)</code>: \u5728\u5355\u6b21\u8bf7\u6c42\u91cc\u76f4\u63a5\u4f20\u5165\u4e00\u4e2a Agent \u5b9e\u4f8b\u4e34\u65f6\u8986\u76d6\uff0c\u65e0\u9700\u9884\u6ce8\u518c\u3002</li> </ul> <p>Agent \u751f\u6548\u4f18\u5148\u7ea7\uff1a<code>agent.WithAgent</code> &gt; <code>agent.WithAgentByName</code> &gt; <code>runner.NewRunner</code> \u8bbe\u7f6e\u7684\u9ed8\u8ba4 Agent\u3002</p>"},{"location":"zh/runner/#_15","title":"\u751f\u6210\u914d\u7f6e","text":"<p>Runner \u4f1a\u5c06\u751f\u6210\u914d\u7f6e\u4f20\u9012\u7ed9 Agent\uff1a</p> <pre><code>// \u8f85\u52a9\u51fd\u6570\nfunc intPtr(i int) *int           { return &amp;i }\nfunc floatPtr(f float64) *float64 { return &amp;f }\n\ngenConfig := model.GenerationConfig{\n    MaxTokens:   intPtr(2000),\n    Temperature: floatPtr(0.7),\n    Stream:      true,  // \u542f\u7528\u6d41\u5f0f\u8f93\u51fa\n}\n\nagent := llmagent.New(\"assistant\",\n    llmagent.WithModel(model),\n    llmagent.WithGenerationConfig(genConfig))\n</code></pre>"},{"location":"zh/runner/#_16","title":"\u5de5\u5177\u96c6\u6210","text":"<p>\u5de5\u5177\u914d\u7f6e\u5728 Agent \u4e2d\u5b8c\u6210\uff0cRunner \u8d1f\u8d23\u8fd0\u884c\u5305\u542b\u5de5\u5177\u7684 Agent\uff1a</p> <pre><code>// \u521b\u5efa\u5de5\u5177\uff08\u8be6\u7ec6\u914d\u7f6e\u53c2\u89c1 tool.md\uff09\ntools := []tool.Tool{\n    function.NewFunctionTool(myFunction, function.WithName(\"my_tool\")),\n    // \u66f4\u591a\u5de5\u5177...\n}\n\n// \u5c06\u5de5\u5177\u6dfb\u52a0\u5230 Agent\nagent := llmagent.New(\"assistant\",\n    llmagent.WithModel(model),\n    llmagent.WithTools(tools))\n\n// Runner \u8fd0\u884c\u914d\u7f6e\u4e86\u5de5\u5177\u7684 Agent\nr := runner.NewRunner(\"my-app\", agent)\n</code></pre> <p>\u5de5\u5177\u8c03\u7528\u6d41\u7a0b\uff1aRunner \u672c\u8eab\u4e0d\u76f4\u63a5\u5904\u7406\u5de5\u5177\u8c03\u7528\uff0c\u5177\u4f53\u6d41\u7a0b\u5982\u4e0b\uff1a</p> <ol> <li>\u4f20\u9012\u5de5\u5177\uff1aRunner \u901a\u8fc7 Invocation \u5c06\u4e0a\u4e0b\u6587\u4f20\u9012\u7ed9 Agent</li> <li>Agent \u5904\u7406\uff1aAgent.Run \u65b9\u6cd5\u8d1f\u8d23\u5177\u4f53\u7684\u5de5\u5177\u8c03\u7528\u903b\u8f91</li> <li>\u4e8b\u4ef6\u8f6c\u53d1\uff1aRunner \u63a5\u6536 Agent \u8fd4\u56de\u7684\u4e8b\u4ef6\u6d41\u5e76\u8f6c\u53d1</li> <li>\u4f1a\u8bdd\u8bb0\u5f55\uff1a\u5c06\u975e partial \u54cd\u5e94\u4e8b\u4ef6\u8ffd\u52a0\u5230\u4f1a\u8bdd\u4e2d</li> </ol>"},{"location":"zh/runner/#agent_3","title":"\u591a Agent \u652f\u6301","text":"<p>Runner \u53ef\u4ee5\u6267\u884c\u590d\u6742\u7684\u591a Agent \u7ed3\u6784\uff08\u8be6\u7ec6\u914d\u7f6e\u53c2\u89c1 multiagent.md\uff09\uff1a</p> <pre><code>import \"trpc.group/trpc-go/trpc-agent-go/agent/chainagent\"\n\n// \u521b\u5efa\u591a Agent \u7ec4\u5408\nmultiAgent := chainagent.New(\"pipeline\",\n    chainagent.WithSubAgents([]agent.Agent{agent1, agent2}))\n\n// \u4f7f\u7528\u540c\u4e00\u4e2a Runner \u6267\u884c\nr := runner.NewRunner(\"multi-app\", multiAgent)\n</code></pre>"},{"location":"zh/runner/#_17","title":"\ud83d\udcca \u4e8b\u4ef6\u5904\u7406","text":""},{"location":"zh/runner/#_18","title":"\u4e8b\u4ef6\u7c7b\u578b","text":"<pre><code>import \"trpc.group/trpc-go/trpc-agent-go/event\"\n\nfor event := range eventChan {\n    // \u9519\u8bef\u4e8b\u4ef6\n    if event.Error != nil {\n        fmt.Printf(\"\u9519\u8bef: %s\\n\", event.Error.Message)\n        continue\n    }\n\n    // \u6d41\u5f0f\u5185\u5bb9\n    if len(event.Response.Choices) &gt; 0 {\n        choice := event.Response.Choices[0]\n        fmt.Print(choice.Delta.Content)\n    }\n\n    // \u5de5\u5177\u8c03\u7528\n    if len(event.Response.Choices) &gt; 0 &amp;&amp; len(event.Response.Choices[0].Message.ToolCalls) &gt; 0 {\n        for _, toolCall := range event.Response.Choices[0].Message.ToolCalls {\n            fmt.Printf(\"\u8c03\u7528\u5de5\u5177: %s\\n\", toolCall.Function.Name)\n        }\n    }\n\n    // \u5b8c\u6210\u4e8b\u4ef6\n    if event.Done {\n        break\n    }\n}\n</code></pre>"},{"location":"zh/runner/#_19","title":"\u5b8c\u6574\u4e8b\u4ef6\u5904\u7406\u793a\u4f8b","text":"<pre><code>import (\n    \"fmt\"\n    \"strings\"\n)\n\nfunc processEvents(eventChan &lt;-chan *event.Event) error {\n    var fullResponse strings.Builder\n\n    for event := range eventChan {\n        // \u5904\u7406\u9519\u8bef\n        if event.Error != nil {\n            return fmt.Errorf(\"\u4e8b\u4ef6\u9519\u8bef: %w\", event.Error)\n        }\n\n        // \u5904\u7406\u5de5\u5177\u8c03\u7528\n        if len(event.Response.Choices) &gt; 0 &amp;&amp; len(event.Response.Choices[0].Message.ToolCalls) &gt; 0 {\n            fmt.Println(\"\ud83d\udd27 \u5de5\u5177\u8c03\u7528:\")\n            for _, toolCall := range event.Response.Choices[0].Message.ToolCalls {\n                fmt.Printf(\"  \u2022 %s (ID: %s)\\n\",\n                    toolCall.Function.Name, toolCall.ID)\n                fmt.Printf(\"    \u53c2\u6570: %s\\n\",\n                    string(toolCall.Function.Arguments))\n            }\n        }\n\n        // \u5904\u7406\u5de5\u5177\u54cd\u5e94\n        if event.Response != nil {\n            for _, choice := range event.Response.Choices {\n                if choice.Message.Role == model.RoleTool {\n                    fmt.Printf(\"\u2705 \u5de5\u5177\u54cd\u5e94 (ID: %s): %s\\n\",\n                        choice.Message.ToolID, choice.Message.Content)\n                }\n            }\n        }\n\n        // \u5904\u7406\u6d41\u5f0f\u5185\u5bb9\n        if len(event.Response.Choices) &gt; 0 {\n            content := event.Response.Choices[0].Delta.Content\n            if content != \"\" {\n                fmt.Print(content)\n                fullResponse.WriteString(content)\n            }\n        }\n\n        if event.Done {\n            fmt.Println() // \u6362\u884c\n            break\n        }\n    }\n\n    return nil\n}\n</code></pre>"},{"location":"zh/runner/#_20","title":"\ud83d\udd2e \u6267\u884c\u4e0a\u4e0b\u6587\u7ba1\u7406","text":"<p>Runner \u521b\u5efa\u5e76\u7ba1\u7406 Invocation \u7ed3\u6784\uff1a</p> <pre><code>// Runner \u521b\u5efa\u7684 Invocation \u5305\u542b\u4ee5\u4e0b\u5b57\u6bb5\uff1a\ninvocation := agent.NewInvocation(\n    agent.WithInvocationAgent(r.agent),        // Agent \u5b9e\u4f8b\n    agent.WithInvocationSession(Session),      // \u4f1a\u8bdd\u5bf9\u8c61\n    agent.WithInvocationEndInvocation(false),  // \u7ed3\u675f\u6807\u5fd7\n    agent.WithInvocationMessage(message),      // \u7528\u6237\u6d88\u606f\n    agent.WithInvocationRunOptions(ro),        // \u8fd0\u884c\u9009\u9879\n)\n// \u6ce8\uff1aInvocation \u8fd8\u5305\u542b\u5176\u4ed6\u5b57\u6bb5\u5982 AgentName\u3001Branch\u3001Model\u3001\n// TransferInfo\u3001AgentCallbacks\u3001ModelCallbacks\u3001ToolCallbacks \u7b49\uff0c\n// \u4f46\u8fd9\u4e9b\u5b57\u6bb5\u7531 Agent \u5185\u90e8\u4f7f\u7528\u548c\u7ba1\u7406\n</code></pre>"},{"location":"zh/runner/#_21","title":"\u2705 \u4f7f\u7528\u6ce8\u610f\u4e8b\u9879","text":""},{"location":"zh/runner/#_22","title":"\u9519\u8bef\u5904\u7406","text":"<pre><code>// \u5904\u7406 Runner.Run \u7684\u9519\u8bef\neventChan, err := r.Run(ctx, userID, sessionID, message)\nif err != nil {\n    log.Printf(\"Runner \u6267\u884c\u5931\u8d25: %v\", err)\n    return err\n}\n\n// \u5904\u7406\u4e8b\u4ef6\u6d41\u4e2d\u7684\u9519\u8bef\nfor event := range eventChan {\n    if event.Error != nil {\n        log.Printf(\"\u4e8b\u4ef6\u9519\u8bef: %s\", event.Error.Message)\n        continue\n    }\n    // \u5904\u7406\u6b63\u5e38\u4e8b\u4ef6\n}\n</code></pre>"},{"location":"zh/runner/#_23","title":"\u5b89\u5168\u4e2d\u65ad\u6267\u884c","text":"<ul> <li>\u53d6\u6d88\u4e0a\u4e0b\u6587\uff1a\u7528 <code>context.WithCancel</code> \u5305\u88f9 <code>runner.Run</code> \u7684 ctx\uff0c   \u5f53\u8f6e\u6b21\u6216 token \u8d85\u9650\u65f6\u8c03\u7528 <code>cancel()</code>\u3002<code>llmflow</code> \u5c06   <code>context.Canceled</code> \u89c6\u4e3a\u6b63\u5e38\u9000\u51fa\uff0c\u4f1a\u5173\u95ed agent \u4e8b\u4ef6\u901a\u9053\uff0c   runner \u7684\u6d88\u8d39\u5faa\u73af\u4e5f\u4f1a\u6b63\u5e38\u7ed3\u675f\uff0c\u907f\u514d\u963b\u585e\u3002</li> </ul> <pre><code>ctx, cancel := context.WithCancel(context.Background())\ndefer cancel()\n\neventCh, err := r.Run(ctx, userID, sessionID, message)\nif err != nil {\n    return err\n}\n\nturns := 0\nfor evt := range eventCh {\n    if evt.Error != nil {\n        log.Printf(\"\u4e8b\u4ef6\u9519\u8bef: %s\", evt.Error.Message)\n        continue\n    }\n    // ... \u5904\u7406\u4e8b\u4ef6 ...\n    if evt.IsFinalResponse() {\n        break\n    }\n    turns++\n    if turns &gt;= maxTurns {\n        cancel() // \u505c\u6b62\u540e\u7eed\u6a21\u578b\u6216\u5de5\u5177\u8c03\u7528\n    }\n}\n</code></pre> <ul> <li>\u53d1\u9001\u505c\u6b62\u4e8b\u4ef6\uff1a\u5728\u81ea\u5b9a\u4e49\u5904\u7406\u5668\u6216\u5de5\u5177\u5185\u90e8\u8fd4\u56de <code>agent.NewStopError(\"\u539f\u56e0\")</code>\u3002<code>llmflow</code> \u4f1a\u628a\u5b83\u8f6c\u6362\u4e3a <code>stop_agent_error</code> \u4e8b\u4ef6\u5e76\u505c\u6b62\u6d41\u7a0b\u3002   \u4ecd\u5efa\u8bae\u914d\u5408 ctx cancel \u8fdb\u884c\u786c\u622a\u6b62\u3002\u8be6\u89c1 \u56de\u8c03\u4e2d\u7684\u505c\u6b62\u7528\u6cd5\u3002</li> </ul> <ul> <li>\u907f\u514d\u76f4\u63a5 break \u4e8b\u4ef6\u5faa\u73af\uff1a\u76f4\u63a5\u5728 runner \u7684\u4e8b\u4ef6\u6d88\u8d39\u5faa\u73af\u91cc break \u4f1a\u8ba9 agent goroutine \u7ee7\u7eed\u8fd0\u884c\u5e76\u53ef\u80fd\u5728\u5199\u901a\u9053\u65f6\u963b\u585e\u3002   \u4f18\u5148\u4f7f\u7528\u4e0a\u4e0b\u6587\u53d6\u6d88\u6216 <code>StopError</code>\u3002</li> </ul>"},{"location":"zh/runner/#_24","title":"\u8d44\u6e90\u7ba1\u7406","text":""},{"location":"zh/runner/#runner_2","title":"\ud83d\udd12 \u5173\u95ed Runner\uff08\u91cd\u8981\uff09","text":"<p>Runner \u5728\u4e0d\u4f7f\u7528\u65f6\u5fc5\u987b\u8c03\u7528 <code>Close()</code> \u65b9\u6cd5\uff0c\u5426\u5219\u4f1a\u5bfc\u81f4 goroutine \u6cc4\u6f0f\uff08\u8981\u6c42 <code>trpc-agent-go &gt;= v0.5.0</code>\uff09\u3002</p> <p>Runner \u53ea\u5173\u95ed\u5b83\u81ea\u5df1\u521b\u5efa\u7684\u8d44\u6e90</p> <p>\u5f53 Runner \u521b\u5efa\u65f6\u5982\u679c\u672a\u63d0\u4f9b Session Service\uff0c\u4f1a\u81ea\u52a8\u521b\u5efa\u9ed8\u8ba4\u7684 inmemory Session Service\u3002\u8be5 Service \u5185\u90e8\u4f1a\u542f\u52a8\u540e\u53f0 goroutines\uff08\u7528\u4e8e\u5f02\u6b65\u5904\u7406 summary\u3001\u57fa\u4e8e TTL \u7684\u4f1a\u8bdd\u6e05\u7406\u7b49\u4efb\u52a1\uff09\u3002Runner \u53ea\u7ba1\u7406\u8fd9\u4e2a\u81ea\u5df1\u521b\u5efa\u7684 inmemory Session Service \u7684\u751f\u547d\u5468\u671f\u3002 \u5982\u679c\u4f60\u901a\u8fc7 <code>WithSessionService()</code> \u63d0\u4f9b\u4e86\u81ea\u5df1\u7684 Session Service\uff0c\u4f60\u9700\u8981\u81ea\u5df1\u7ba1\u7406\u5b83\u7684\u751f\u547d\u5468\u671f\u2014\u2014Runner \u4e0d\u4f1a\u5173\u95ed\u5b83\u3002</p> <p>\u5982\u679c\u4e0d\u8c03\u7528\u62e5\u6709 inmemory Session Service \u7684 Runner \u7684 <code>Close()</code>\uff0c\u8fd9\u4e9b\u540e\u53f0 goroutines \u5c06\u6c38\u8fdc\u8fd0\u884c\uff0c\u9020\u6210\u8d44\u6e90\u6cc4\u6f0f\u3002</p> <p>\u63a8\u8350\u505a\u6cd5\uff1a</p> <pre><code>// \u2705 \u63a8\u8350\uff1a\u4f7f\u7528 defer \u786e\u4fdd\u8d44\u6e90\u88ab\u6e05\u7406\nr := runner.NewRunner(\"my-app\", agent)\ndefer r.Close()  // \u786e\u4fdd\u5728\u51fd\u6570\u9000\u51fa\u65f6\u5173\u95ed (trpc-agent-go &gt;= v0.5.0)\n\n// \u4f7f\u7528 runner\neventChan, err := r.Run(ctx, userID, sessionID, message)\nif err != nil {\n    return err\n}\n\nfor event := range eventChan {\n    // \u5904\u7406\u4e8b\u4ef6\n    if event.IsRunnerCompletion() {\n        break\n    }\n}\n</code></pre> <p>\u5f53\u4f60\u63d0\u4f9b\u81ea\u5df1\u7684 Session Service \u65f6\uff1a</p> <pre><code>// \u4f60\u521b\u5efa\u5e76\u7ba1\u7406 session service \u7684\u751f\u547d\u5468\u671f\nsessionService := redis.NewService(redis.WithRedisClientURL(\"redis://localhost:6379\"))\ndefer sessionService.Close()  // \u4f60\u8d1f\u8d23\u5173\u95ed\u5b83\n\n// Runner \u4f7f\u7528\u4f46\u4e0d\u62e5\u6709\u8fd9\u4e2a session service\nr := runner.NewRunner(\"my-app\", agent,\n    runner.WithSessionService(sessionService))\ndefer r.Close()  // \u8fd9\u4e0d\u4f1a\u5173\u95ed sessionService\uff08\u56e0\u4e3a\u662f\u4f60\u63d0\u4f9b\u7684\uff09 (trpc-agent-go &gt;= v0.5.0)\n\n// ... \u4f7f\u7528 runner\n</code></pre> <p>\u957f\u671f\u8fd0\u884c\u7684\u670d\u52a1\uff1a</p> <pre><code>type Service struct {\n    runner runner.Runner\n    sessionService session.Service  // \u5982\u679c\u4f60\u81ea\u5df1\u7ba1\u7406\u5b83\n}\n\nfunc NewService() *Service {\n    r := runner.NewRunner(\"my-app\", agent)\n    return &amp;Service{runner: r}\n}\n\nfunc (s *Service) Start() error {\n    // \u542f\u52a8\u670d\u52a1\u903b\u8f91\n    return nil\n}\n\n// \u5728\u670d\u52a1\u5173\u95ed\u65f6\u8c03\u7528 Close\nfunc (s *Service) Stop() error {\n    // \u5173\u95ed runner\uff08\u5b83\u4f1a\u5173\u95ed\u81ea\u5df1\u62e5\u6709\u7684 inmemory session service\uff09\n    // \u8981\u6c42 trpc-agent-go &gt;= v0.5.0\n    if err := s.runner.Close(); err != nil {\n        return err\n    }\n\n    // \u5982\u679c\u4f60\u63d0\u4f9b\u4e86\u81ea\u5df1\u7684 session service\uff0c\u5728\u8fd9\u91cc\u5173\u95ed\u5b83\n    if s.sessionService != nil {\n        return s.sessionService.Close()\n    }\n\n    return nil\n}\n</code></pre> <p>\u6ce8\u610f\u4e8b\u9879\uff1a</p> <ul> <li>\u2705 <code>Close()</code> \u662f\u5e42\u7b49\u7684\uff0c\u591a\u6b21\u8c03\u7528\u662f\u5b89\u5168\u7684</li> <li>\u2705 Runner \u53ea\u5173\u95ed\u5b83\u9ed8\u8ba4\u521b\u5efa\u7684 inmemory Session Service</li> <li>\u2705 \u5982\u679c\u4f60\u901a\u8fc7 <code>WithSessionService()</code> \u63d0\u4f9b\u4e86\u81ea\u5df1\u7684 Session Service\uff0cRunner \u4e0d\u4f1a\u5173\u95ed\u5b83\uff08\u4f60\u9700\u8981\u81ea\u5df1\u7ba1\u7406\uff09</li> <li>\u274c \u5982\u679c Runner \u62e5\u6709 inmemory Session Service \u4f46\u4e0d\u8c03\u7528 <code>Close()</code>\uff0c\u4f1a\u5bfc\u81f4 goroutine \u6cc4\u6f0f</li> </ul>"},{"location":"zh/runner/#context","title":"Context \u751f\u547d\u5468\u671f\u63a7\u5236","text":"<pre><code>// \u4f7f\u7528 context \u63a7\u5236\u5355\u6b21\u8fd0\u884c\u7684\u751f\u547d\u5468\u671f\nctx, cancel := context.WithCancel(context.Background())\ndefer cancel()\n\n// \u786e\u4fdd\u6d88\u8d39\u5b8c\u6240\u6709\u4e8b\u4ef6\neventChan, err := r.Run(ctx, userID, sessionID, message)\nif err != nil {\n    return err\n}\n\nfor event := range eventChan {\n    // \u5904\u7406\u4e8b\u4ef6\n    if event.Done {\n        break\n    }\n}\n</code></pre>"},{"location":"zh/runner/#_25","title":"\u72b6\u6001\u68c0\u67e5","text":"<pre><code>import (\n    \"context\"\n    \"fmt\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/model\"\n    \"trpc.group/trpc-go/trpc-agent-go/runner\"\n)\n\n// \u68c0\u67e5 Runner \u662f\u5426\u80fd\u6b63\u5e38\u5de5\u4f5c\nfunc checkRunner(r runner.Runner, ctx context.Context) error {\n    testMessage := model.NewUserMessage(\"\u6d4b\u8bd5\")\n    eventChan, err := r.Run(ctx, \"test-user\", \"test-session\", testMessage)\n    if err != nil {\n        return fmt.Errorf(\"Runner.Run \u5931\u8d25: %v\", err)\n    }\n\n    // \u68c0\u67e5\u4e8b\u4ef6\u6d41\n    for event := range eventChan {\n        if event.Error != nil {\n            return fmt.Errorf(\"\u6536\u5230\u9519\u8bef\u4e8b\u4ef6: %s\", event.Error.Message)\n        }\n        if event.Done {\n            break\n        }\n    }\n\n    return nil\n}\n</code></pre>"},{"location":"zh/runner/#_26","title":"\ud83d\udcdd \u603b\u7ed3","text":"<p>Runner \u7ec4\u4ef6\u662f tRPC-Agent-Go \u6846\u67b6\u7684\u6838\u5fc3\uff0c\u63d0\u4f9b\u4e86\u5b8c\u6574\u7684\u5bf9\u8bdd\u7ba1\u7406\u548c Agent \u7f16\u6392\u80fd\u529b\u3002\u901a\u8fc7\u5408\u7406\u4f7f\u7528\u4f1a\u8bdd\u7ba1\u7406\u3001\u5de5\u5177\u96c6\u6210\u548c\u4e8b\u4ef6\u5904\u7406\uff0c\u53ef\u4ee5\u6784\u5efa\u5f3a\u5927\u7684\u667a\u80fd\u5bf9\u8bdd\u5e94\u7528\u3002</p>"},{"location":"zh/session/","title":"Session \u4f1a\u8bdd\u7ba1\u7406","text":""},{"location":"zh/session/#_1","title":"\u6982\u8ff0","text":"<p>tRPC-Agent-Go \u6846\u67b6\u63d0\u4f9b\u4e86\u5f3a\u5927\u7684\u4f1a\u8bdd\uff08Session\uff09\u7ba1\u7406\u529f\u80fd\uff0c\u7528\u4e8e\u7ef4\u62a4 Agent \u4e0e\u7528\u6237\u4ea4\u4e92\u8fc7\u7a0b\u4e2d\u7684\u5bf9\u8bdd\u5386\u53f2\u548c\u4e0a\u4e0b\u6587\u4fe1\u606f\u3002\u901a\u8fc7\u81ea\u52a8\u6301\u4e45\u5316\u5bf9\u8bdd\u8bb0\u5f55\u3001\u667a\u80fd\u6458\u8981\u538b\u7f29\u548c\u7075\u6d3b\u7684\u5b58\u50a8\u540e\u7aef\uff0c\u4f1a\u8bdd\u7ba1\u7406\u4e3a\u6784\u5efa\u6709\u72b6\u6001\u7684\u667a\u80fd Agent \u63d0\u4f9b\u4e86\u5b8c\u6574\u7684\u57fa\u7840\u8bbe\u65bd\u3002</p>"},{"location":"zh/session/#_2","title":"\u5b9a\u4f4d","text":"<p>Session \u7528\u4e8e\u7ba1\u7406\u5f53\u524d\u4f1a\u8bdd\u7684\u4e0a\u4e0b\u6587\uff0c\u9694\u79bb\u7ef4\u5ea6\u4e3a <code>&lt;appName, userID, SessionID&gt;</code>\uff0c\u4fdd\u5b58\u8fd9\u4e00\u6bb5\u5bf9\u8bdd\u91cc\u7684\u7528\u6237\u6d88\u606f\u3001Agent \u56de\u590d\u3001\u5de5\u5177\u8c03\u7528\u7ed3\u679c\u4ee5\u53ca\u57fa\u4e8e\u8fd9\u4e9b\u5185\u5bb9\u751f\u6210\u7684\u7b80\u8981\u6458\u8981\uff0c\u7528\u4e8e\u652f\u6491\u591a\u8f6e\u95ee\u7b54\u573a\u666f\u3002</p> <p>\u5728\u540c\u4e00\u6761\u5bf9\u8bdd\u4e2d\uff0c\u5b83\u8ba9\u591a\u8f6e\u95ee\u7b54\u4e4b\u95f4\u80fd\u591f\u81ea\u7136\u627f\u63a5\uff0c\u907f\u514d\u7528\u6237\u5728\u6bcf\u4e00\u8f6e\u90fd\u91cd\u65b0\u63cf\u8ff0\u540c\u4e00\u4e2a\u95ee\u9898\u6216\u63d0\u4f9b\u76f8\u540c\u53c2\u6570\u3002</p>"},{"location":"zh/session/#_3","title":"\ud83c\udfaf \u6838\u5fc3\u7279\u6027","text":"<ul> <li>\u4e0a\u4e0b\u6587\u7ba1\u7406\uff1a\u81ea\u52a8\u52a0\u8f7d\u5386\u53f2\u5bf9\u8bdd\uff0c\u5b9e\u73b0\u771f\u6b63\u7684\u591a\u8f6e\u5bf9\u8bdd</li> <li>\u4f1a\u8bdd\u6458\u8981\uff1a\u4f7f\u7528 LLM \u81ea\u52a8\u538b\u7f29\u957f\u5bf9\u8bdd\u5386\u53f2\uff0c\u5728\u4fdd\u7559\u5173\u952e\u4e0a\u4e0b\u6587\u7684\u540c\u65f6\u663e\u8457\u964d\u4f4e token \u6d88\u8017</li> <li>\u4e8b\u4ef6\u9650\u5236\uff1a\u63a7\u5236\u6bcf\u4e2a\u4f1a\u8bdd\u5b58\u50a8\u7684\u6700\u5927\u4e8b\u4ef6\u6570\u91cf\uff0c\u9632\u6b62\u5185\u5b58\u6ea2\u51fa</li> <li>TTL \u7ba1\u7406\uff1a\u652f\u6301\u4f1a\u8bdd\u6570\u636e\u7684\u81ea\u52a8\u8fc7\u671f\u6e05\u7406</li> <li>\u591a\u5b58\u50a8\u540e\u7aef\uff1a\u652f\u6301\u5185\u5b58\u3001Redis\u3001PostgreSQL\u3001MySQL \u5b58\u50a8</li> <li>\u5e76\u53d1\u5b89\u5168\uff1a\u5185\u7f6e\u8bfb\u5199\u9501\u4fdd\u8bc1\u5e76\u53d1\u8bbf\u95ee\u5b89\u5168</li> <li>\u81ea\u52a8\u7ba1\u7406\uff1a\u96c6\u6210 Runner \u540e\u81ea\u52a8\u5904\u7406\u4f1a\u8bdd\u521b\u5efa\u3001\u52a0\u8f7d\u548c\u66f4\u65b0</li> <li>\u8f6f\u5220\u9664\u652f\u6301\uff1aPostgreSQL/MySQL \u652f\u6301\u8f6f\u5220\u9664\uff0c\u6570\u636e\u53ef\u6062\u590d</li> </ul>"},{"location":"zh/session/#_4","title":"\u5feb\u901f\u5f00\u59cb","text":""},{"location":"zh/session/#runner","title":"\u96c6\u6210\u5230 Runner","text":"<p>tRPC-Agent-Go \u7684\u4f1a\u8bdd\u7ba1\u7406\u901a\u8fc7 <code>runner.WithSessionService</code> \u96c6\u6210\u5230 Runner \u4e2d\uff0cRunner \u4f1a\u81ea\u52a8\u5904\u7406\u4f1a\u8bdd\u7684\u521b\u5efa\u3001\u52a0\u8f7d\u3001\u66f4\u65b0\u548c\u6301\u4e45\u5316\u3002</p> <p>\u652f\u6301\u7684\u5b58\u50a8\u540e\u7aef\uff1a \u5185\u5b58\uff08Memory\uff09\u3001Redis\u3001PostgreSQL\u3001MySQL</p> <p>\u9ed8\u8ba4\u884c\u4e3a\uff1a \u5982\u679c\u4e0d\u914d\u7f6e <code>runner.WithSessionService</code>\uff0cRunner \u4f1a\u9ed8\u8ba4\u4f7f\u7528\u5185\u5b58\u5b58\u50a8\uff08Memory\uff09\uff0c\u6570\u636e\u5728\u8fdb\u7a0b\u91cd\u542f\u540e\u4f1a\u4e22\u5931\u3002</p>"},{"location":"zh/session/#_5","title":"\u57fa\u7840\u793a\u4f8b","text":"<pre><code>package main\n\nimport (\n    \"context\"\n    \"fmt\"\n    \"time\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/agent/llmagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/model\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/openai\"\n    \"trpc.group/trpc-go/trpc-agent-go/runner\"\n    \"trpc.group/trpc-go/trpc-agent-go/session/inmemory\"\n    \"trpc.group/trpc-go/trpc-agent-go/session/summary\" // \u53ef\u9009\uff1a\u542f\u7528\u6458\u8981\u529f\u80fd\u65f6\u9700\u8981\n)\n\nfunc main() {\n    // 1. \u521b\u5efa LLM \u6a21\u578b\n    llm := openai.New(\"gpt-4\", openai.WithAPIKey(\"your-api-key\"))\n\n    // 2. \uff08\u53ef\u9009\uff09\u521b\u5efa\u6458\u8981\u5668 - \u81ea\u52a8\u538b\u7f29\u957f\u5bf9\u8bdd\u5386\u53f2\n    summarizer := summary.NewSummarizer(\n        llm, // \u4f7f\u7528\u76f8\u540c\u7684 LLM \u6a21\u578b\u751f\u6210\u6458\u8981\n        summary.WithChecksAny( // \u4efb\u4e00\u6761\u4ef6\u6ee1\u8db3\u5373\u89e6\u53d1\u6458\u8981\n            summary.CheckEventThreshold(20),           // \u8d85\u8fc7 20 \u4e2a\u4e8b\u4ef6\u540e\u89e6\u53d1\n            summary.CheckTokenThreshold(4000),         // \u8d85\u8fc7 4000 \u4e2a token \u540e\u89e6\u53d1\n            summary.CheckTimeThreshold(5*time.Minute), // 5 \u5206\u949f\u65e0\u6d3b\u52a8\u540e\u89e6\u53d1\n        ),\n        summary.WithMaxSummaryWords(200), // \u9650\u5236\u6458\u8981\u5728 200 \u5b57\u4ee5\u5185\n    )\n\n    // 3. \u521b\u5efa Session Service\uff08\u53ef\u9009\uff0c\u4e0d\u914d\u7f6e\u5219\u4f7f\u7528\u9ed8\u8ba4\u5185\u5b58\u5b58\u50a8\uff09\n    sessionService := inmemory.NewSessionService(\n        inmemory.WithSummarizer(summarizer), // \u53ef\u9009\uff1a\u6ce8\u5165\u6458\u8981\u5668\n        inmemory.WithAsyncSummaryNum(2),     // \u53ef\u9009\uff1a2 \u4e2a\u5f02\u6b65 worker\n        inmemory.WithSummaryQueueSize(100),  // \u53ef\u9009\uff1a\u961f\u5217\u5927\u5c0f 100\n    )\n\n    // 4. \u521b\u5efa Agent\n    agent := llmagent.New(\n        \"my-agent\",\n        llmagent.WithModel(llm),\n        llmagent.WithInstruction(\"\u4f60\u662f\u4e00\u4e2a\u667a\u80fd\u52a9\u624b\"),\n        llmagent.WithAddSessionSummary(true), // \u53ef\u9009\uff1a\u542f\u7528\u6458\u8981\u6ce8\u5165\u5230\u4e0a\u4e0b\u6587\n        // \u6ce8\u610f\uff1aWithAddSessionSummary(true) \u65f6\u4f1a\u5ffd\u7565 WithMaxHistoryRuns \u914d\u7f6e\n        // \u6458\u8981\u4f1a\u5305\u542b\u6240\u6709\u5386\u53f2\uff0c\u589e\u91cf\u4e8b\u4ef6\u4f1a\u5b8c\u6574\u4fdd\u7559\n    )\n\n    // 5. \u521b\u5efa Runner \u5e76\u6ce8\u5165 Session Service\n    r := runner.NewRunner(\n        \"my-agent\",\n        agent,\n        runner.WithSessionService(sessionService),\n    )\n\n    // 6. \u7b2c\u4e00\u6b21\u5bf9\u8bdd\n    ctx := context.Background()\n    userMsg1 := model.NewUserMessage(\"\u6211\u53eb\u5f20\u4e09\")\n    eventChan, err := r.Run(ctx, \"user123\", \"session-001\", userMsg1)\n    if err != nil {\n        fmt.Printf(\"Error: %v\\n\", err)\n        return\n    }\n    fmt.Print(\"AI: \")\n    for event := range eventChan {\n        if event == nil || event.Response == nil {\n            continue\n        }\n        if event.Response.Error != nil {\n            fmt.Printf(\"\\nError: %s (type: %s)\\n\", event.Response.Error.Message, event.Response.Error.Type)\n            continue\n        }\n        if len(event.Response.Choices) &gt; 0 {\n            choice := event.Response.Choices[0]\n            // \u6d41\u5f0f\u8f93\u51fa\uff0c\u4f18\u5148\u4f7f\u7528 Delta.Content\uff0c\u5426\u5219\u4f7f\u7528 Message.Content\n            if choice.Delta.Content != \"\" {\n                fmt.Print(choice.Delta.Content)\n            } else if choice.Message.Content != \"\" {\n                fmt.Print(choice.Message.Content)\n            }\n        }\n        if event.IsFinalResponse() {\n            break\n        }\n    }\n    fmt.Println()\n\n    // 7. \u7b2c\u4e8c\u6b21\u5bf9\u8bdd - \u81ea\u52a8\u52a0\u8f7d\u5386\u53f2\uff0cAI \u80fd\u8bb0\u4f4f\u7528\u6237\u540d\u5b57\n    userMsg2 := model.NewUserMessage(\"\u6211\u53eb\u4ec0\u4e48\u540d\u5b57\uff1f\")\n    eventChan, err = r.Run(ctx, \"user123\", \"session-001\", userMsg2)\n    if err != nil {\n        fmt.Printf(\"Error: %v\\n\", err)\n        return\n    }\n    fmt.Print(\"AI: \")\n    for event := range eventChan {\n        if event == nil || event.Response == nil {\n            continue\n        }\n        if event.Response.Error != nil {\n            fmt.Printf(\"\\nError: %s (type: %s)\\n\", event.Response.Error.Message, event.Response.Error.Type)\n            continue\n        }\n        if len(event.Response.Choices) &gt; 0 {\n            choice := event.Response.Choices[0]\n            // \u6d41\u5f0f\u8f93\u51fa\uff0c\u4f18\u5148\u4f7f\u7528 Delta.Content\uff0c\u5426\u5219\u4f7f\u7528 Message.Content\n            if choice.Delta.Content != \"\" {\n                fmt.Print(choice.Delta.Content)\n            } else if choice.Message.Content != \"\" {\n                fmt.Print(choice.Message.Content)\n            }\n        }\n        if event.IsFinalResponse() {\n            break\n        }\n    }\n    fmt.Println() // \u8f93\u51fa\uff1a\u4f60\u53eb\u5f20\u4e09\n}\n</code></pre>"},{"location":"zh/session/#runner_1","title":"Runner \u81ea\u52a8\u63d0\u4f9b\u7684\u80fd\u529b","text":"<p>\u96c6\u6210 Session Service \u540e\uff0cRunner \u4f1a\u81ea\u52a8\u63d0\u4f9b\u4ee5\u4e0b\u80fd\u529b\uff0c\u65e0\u9700\u624b\u52a8\u8c03\u7528\u4efb\u4f55 Session API\uff1a</p> <ol> <li>\u81ea\u52a8\u4f1a\u8bdd\u521b\u5efa\uff1a\u9996\u6b21\u5bf9\u8bdd\u65f6\u81ea\u52a8\u521b\u5efa\u4f1a\u8bdd\uff08\u5982\u679c SessionID \u4e3a\u7a7a\u5219\u751f\u6210 UUID\uff09</li> <li>\u81ea\u52a8\u4f1a\u8bdd\u52a0\u8f7d\uff1a\u6bcf\u6b21\u5bf9\u8bdd\u5f00\u59cb\u65f6\u81ea\u52a8\u52a0\u8f7d\u5386\u53f2\u4e0a\u4e0b\u6587</li> <li>\u81ea\u52a8\u4f1a\u8bdd\u66f4\u65b0\uff1a\u5bf9\u8bdd\u7ed3\u675f\u540e\u81ea\u52a8\u4fdd\u5b58\u65b0\u7684\u4e8b\u4ef6</li> <li>\u4e0a\u4e0b\u6587\u8fde\u7eed\u6027\uff1a\u81ea\u52a8\u5c06\u5386\u53f2\u5bf9\u8bdd\u6ce8\u5165\u5230 LLM \u8f93\u5165\uff0c\u5b9e\u73b0\u591a\u8f6e\u5bf9\u8bdd</li> <li>\u81ea\u52a8\u6458\u8981\u751f\u6210\uff08\u53ef\u9009\uff09\uff1a\u6ee1\u8db3\u89e6\u53d1\u6761\u4ef6\u65f6\u540e\u53f0\u5f02\u6b65\u751f\u6210\u6458\u8981\uff0c\u65e0\u9700\u624b\u52a8\u5e72\u9884</li> </ol>"},{"location":"zh/session/#_6","title":"\u6838\u5fc3\u80fd\u529b\u8be6\u89e3","text":""},{"location":"zh/session/#1","title":"1\ufe0f\u20e3 \u4e0a\u4e0b\u6587\u7ba1\u7406","text":"<p>\u4f1a\u8bdd\u7ba1\u7406\u7684\u6838\u5fc3\u529f\u80fd\u662f\u7ef4\u62a4\u5bf9\u8bdd\u4e0a\u4e0b\u6587\uff0c\u786e\u4fdd Agent \u80fd\u591f\u8bb0\u4f4f\u5386\u53f2\u4ea4\u4e92\u5e76\u57fa\u4e8e\u5386\u53f2\u8fdb\u884c\u667a\u80fd\u54cd\u5e94\u3002</p> <p>\u5de5\u4f5c\u539f\u7406\uff1a</p> <ul> <li>\u81ea\u52a8\u4fdd\u5b58\u6bcf\u8f6e\u5bf9\u8bdd\u7684\u7528\u6237\u8f93\u5165\u548c AI \u54cd\u5e94</li> <li>\u5728\u65b0\u5bf9\u8bdd\u5f00\u59cb\u65f6\u81ea\u52a8\u52a0\u8f7d\u5386\u53f2\u4e8b\u4ef6</li> <li>Runner \u81ea\u52a8\u5c06\u5386\u53f2\u4e0a\u4e0b\u6587\u6ce8\u5165\u5230 LLM \u8f93\u5165\u4e2d</li> </ul> <p>\u9ed8\u8ba4\u884c\u4e3a\uff1a \u901a\u8fc7 Runner \u96c6\u6210\u540e\uff0c\u4e0a\u4e0b\u6587\u7ba1\u7406\u5b8c\u5168\u81ea\u52a8\u5316\uff0c\u65e0\u9700\u624b\u52a8\u5e72\u9884\u3002</p>"},{"location":"zh/session/#2-summary","title":"2\ufe0f\u20e3 \u4f1a\u8bdd\u6458\u8981\uff08Summary\uff09","text":"<p>\u968f\u7740\u5bf9\u8bdd\u6301\u7eed\u589e\u957f\uff0c\u7ef4\u62a4\u5b8c\u6574\u7684\u4e8b\u4ef6\u5386\u53f2\u53ef\u80fd\u4f1a\u5360\u7528\u5927\u91cf\u5185\u5b58\uff0c\u5e76\u53ef\u80fd\u8d85\u51fa LLM \u7684\u4e0a\u4e0b\u6587\u7a97\u53e3\u9650\u5236\u3002\u4f1a\u8bdd\u6458\u8981\u529f\u80fd\u4f7f\u7528 LLM \u81ea\u52a8\u5c06\u5386\u53f2\u5bf9\u8bdd\u538b\u7f29\u4e3a\u7b80\u6d01\u7684\u6458\u8981\uff0c\u5728\u4fdd\u7559\u91cd\u8981\u4e0a\u4e0b\u6587\u7684\u540c\u65f6\u663e\u8457\u964d\u4f4e\u5185\u5b58\u5360\u7528\u548c token \u6d88\u8017\u3002</p> <p>\u6838\u5fc3\u7279\u6027\uff1a</p> <ul> <li>\u81ea\u52a8\u89e6\u53d1\uff1a\u6839\u636e\u4e8b\u4ef6\u6570\u91cf\u3001token \u6570\u91cf\u6216\u65f6\u95f4\u9608\u503c\u81ea\u52a8\u751f\u6210\u6458\u8981</li> <li>\u589e\u91cf\u5904\u7406\uff1a\u53ea\u5904\u7406\u81ea\u4e0a\u6b21\u6458\u8981\u4ee5\u6765\u7684\u65b0\u4e8b\u4ef6\uff0c\u907f\u514d\u91cd\u590d\u8ba1\u7b97</li> <li>LLM \u9a71\u52a8\uff1a\u4f7f\u7528\u914d\u7f6e\u7684 LLM \u6a21\u578b\u751f\u6210\u9ad8\u8d28\u91cf\u3001\u4e0a\u4e0b\u6587\u611f\u77e5\u7684\u6458\u8981</li> <li>\u975e\u7834\u574f\u6027\uff1a\u539f\u59cb\u4e8b\u4ef6\u5b8c\u6574\u4fdd\u7559\uff0c\u6458\u8981\u5355\u72ec\u5b58\u50a8</li> <li>\u5f02\u6b65\u5904\u7406\uff1a\u540e\u53f0\u5f02\u6b65\u6267\u884c\uff0c\u4e0d\u963b\u585e\u5bf9\u8bdd\u6d41\u7a0b</li> <li>\u7075\u6d3b\u914d\u7f6e\uff1a\u652f\u6301\u81ea\u5b9a\u4e49\u89e6\u53d1\u6761\u4ef6\u3001\u63d0\u793a\u8bcd\u548c\u5b57\u6570\u9650\u5236</li> </ul> <p>\u5feb\u901f\u914d\u7f6e\uff1a</p> <pre><code>import (\n    \"time\"\n    \"trpc.group/trpc-go/trpc-agent-go/session/summary\"\n    \"trpc.group/trpc-go/trpc-agent-go/session/inmemory\"\n)\n\n// 1. \u521b\u5efa\u6458\u8981\u5668\nsummarizer := summary.NewSummarizer(\n    summaryModel,\n    summary.WithChecksAny(                         // \u4efb\u4e00\u6761\u4ef6\u6ee1\u8db3\u5373\u89e6\u53d1\n        summary.CheckEventThreshold(20),           // \u8d85\u8fc7 20 \u4e2a\u4e8b\u4ef6\u540e\u89e6\u53d1\n        summary.CheckTokenThreshold(4000),         // \u8d85\u8fc7 4000 \u4e2a token \u540e\u89e6\u53d1\n        summary.CheckTimeThreshold(5*time.Minute), // 5 \u5206\u949f\u65e0\u6d3b\u52a8\u540e\u89e6\u53d1\n    ),\n    summary.WithMaxSummaryWords(200),              // \u9650\u5236\u6458\u8981\u5728 200 \u5b57\u4ee5\u5185\n)\n\n// 2. \u914d\u7f6e\u4f1a\u8bdd\u670d\u52a1\nsessionService := inmemory.NewSessionService(\n    inmemory.WithSummarizer(summarizer),\n    inmemory.WithAsyncSummaryNum(2),               // 2 \u4e2a\u5f02\u6b65 worker\n    inmemory.WithSummaryQueueSize(100),            // \u961f\u5217\u5927\u5c0f 100\n)\n\n// 3. \u542f\u7528\u6458\u8981\u6ce8\u5165\u5230 Agent\nllmAgent := llmagent.New(\n    \"my-agent\",\n    llmagent.WithModel(llm),\n    llmagent.WithAddSessionSummary(true),          // \u542f\u7528\u6458\u8981\u6ce8\u5165\n)\n\n// 4. \u521b\u5efa Runner\nr := runner.NewRunner(\"my-agent\", llmAgent,\n    runner.WithSessionService(sessionService))\n</code></pre>"},{"location":"zh/session/#hook","title":"\u6458\u8981\u524d\u540e\u7f6e Hook","text":"<p>\u53ef\u4ee5\u901a\u8fc7 Hook \u8c03\u6574\u6458\u8981\u8f93\u5165\u6216\u8f93\u51fa\uff1a</p> <pre><code>summarizer := summary.NewSummarizer(\n    summaryModel,\n    summary.WithPreSummaryHook(func(ctx *summary.PreSummaryHookContext) error {\n        // \u53ef\u5728\u6458\u8981\u524d\u4fee\u6539 ctx.Text \u6216 ctx.Events\n        return nil\n    }),\n    summary.WithPostSummaryHook(func(ctx *summary.PostSummaryHookContext) error {\n        // \u53ef\u5728\u6458\u8981\u8fd4\u56de\u524d\u4fee\u6539 ctx.Summary\n        return nil\n    }),\n    summary.WithSummaryHookAbortOnError(true), // Hook \u62a5\u9519\u65f6\u4e2d\u65ad\uff08\u53ef\u9009\uff09\u3002\n)\n</code></pre> <p>\u8bf4\u660e\uff1a</p> <ul> <li>Pre-hook \u4e3b\u8981\u4fee\u6539 <code>ctx.Text</code>\uff0c\u4e5f\u53ef\u8c03\u6574 <code>ctx.Events</code>\uff1bPost-hook \u53ef\u4fee\u6539 <code>ctx.Summary</code>\u3002</li> <li>\u9ed8\u8ba4\u5ffd\u7565 Hook \u9519\u8bef\uff0c\u9700\u4e2d\u65ad\u65f6\u4f7f\u7528 <code>WithSummaryHookAbortOnError(true)</code>\u3002</li> </ul> <p>\u4e0a\u4e0b\u6587\u6ce8\u5165\u673a\u5236\uff1a</p> <p>\u542f\u7528\u6458\u8981\u540e\uff0c\u6846\u67b6\u4f1a\u5c06\u6458\u8981\u4f5c\u4e3a\u72ec\u7acb\u7684\u7cfb\u7edf\u6d88\u606f\u63d2\u5165\u5230\u7b2c\u4e00\u4e2a\u73b0\u6709\u7cfb\u7edf\u6d88\u606f\u4e4b\u540e\uff0c\u540c\u65f6\u5305\u542b\u6458\u8981\u65f6\u95f4\u70b9\u4e4b\u540e\u7684\u6240\u6709\u589e\u91cf\u4e8b\u4ef6\uff0c\u4fdd\u8bc1\u5b8c\u6574\u4e0a\u4e0b\u6587\uff1a</p> <pre><code>When AddSessionSummary = true:\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 Existing System Message (optional)      \u2502 \u2190 \u5982\u679c\u5b58\u5728\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Session Summary (system message)        \u2502 \u2190 \u63d2\u5165\u5230\u7b2c\u4e00\u4e2a\u7cfb\u7edf\u6d88\u606f\u4e4b\u540e\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Event 1 (after summary)                 \u2502 \u2510\n\u2502 Event 2                                 \u2502 \u2502\n\u2502 Event 3                                 \u2502 \u2502 \u6458\u8981\u540e\u7684\u6240\u6709\u589e\u91cf\u4e8b\u4ef6\n\u2502 ...                                     \u2502 \u2502 \uff08\u5b8c\u6574\u4fdd\u7559\uff09\n\u2502 Event N (current message)               \u2502 \u2518\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n\nWhen AddSessionSummary = false:\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 System Prompt                           \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Event N-k+1                             \u2502 \u2510\n\u2502 Event N-k+2                             \u2502 \u2502 \u6700\u8fd1 k \u8f6e\u5bf9\u8bdd\n\u2502 ...                                     \u2502 \u2502 \uff08\u5f53 MaxHistoryRuns=k \u65f6\uff09\n\u2502 Event N (current message)               \u2502 \u2518\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre> <p>\u91cd\u8981\u63d0\u793a\uff1a \u542f\u7528 <code>WithAddSessionSummary(true)</code> \u65f6\uff0c<code>WithMaxHistoryRuns</code> \u53c2\u6570\u5c06\u88ab\u5ffd\u7565\uff0c\u6458\u8981\u540e\u7684\u6240\u6709\u4e8b\u4ef6\u90fd\u4f1a\u5b8c\u6574\u4fdd\u7559\u3002</p> <p>\u8be6\u7ec6\u914d\u7f6e\u548c\u9ad8\u7ea7\u7528\u6cd5\u8bf7\u53c2\u89c1 \u4f1a\u8bdd\u6458\u8981 \u7ae0\u8282\u3002</p>"},{"location":"zh/session/#3-eventlimit","title":"3\ufe0f\u20e3 \u4e8b\u4ef6\u9650\u5236\uff08EventLimit\uff09","text":"<p>\u63a7\u5236\u6bcf\u4e2a\u4f1a\u8bdd\u5b58\u50a8\u7684\u6700\u5927\u4e8b\u4ef6\u6570\u91cf\uff0c\u9632\u6b62\u957f\u65f6\u95f4\u5bf9\u8bdd\u5bfc\u81f4\u5185\u5b58\u6ea2\u51fa\u3002</p> <p>\u5de5\u4f5c\u673a\u5236\uff1a</p> <ul> <li>\u8d85\u8fc7\u9650\u5236\u65f6\u81ea\u52a8\u6dd8\u6c70\u6700\u8001\u7684\u4e8b\u4ef6\uff08FIFO\uff09</li> <li>\u53ea\u5f71\u54cd\u5b58\u50a8\uff0c\u4e0d\u5f71\u54cd\u4e1a\u52a1\u903b\u8f91</li> <li>\u9002\u7528\u4e8e\u6240\u6709\u5b58\u50a8\u540e\u7aef</li> </ul> <p>\u914d\u7f6e\u793a\u4f8b\uff1a</p> <pre><code>// \u9650\u5236\u6bcf\u4e2a\u4f1a\u8bdd\u6700\u591a\u4fdd\u5b58 500 \u4e2a\u4e8b\u4ef6\nsessionService := inmemory.NewSessionService(\n    inmemory.WithSessionEventLimit(500),\n)\n</code></pre> <p>\u63a8\u8350\u914d\u7f6e\uff1a</p> \u573a\u666f \u63a8\u8350\u503c \u8bf4\u660e \u77ed\u671f\u5bf9\u8bdd 100-200 \u5ba2\u670d\u54a8\u8be2\u3001\u5355\u6b21\u4efb\u52a1 \u4e2d\u671f\u4f1a\u8bdd 500-1000 \u65e5\u5e38\u52a9\u624b\u3001\u591a\u8f6e\u534f\u4f5c \u957f\u671f\u4f1a\u8bdd 1000-2000 \u4e2a\u4eba\u52a9\u7406\u3001\u6301\u7eed\u9879\u76ee\uff08\u9700\u914d\u5408\u6458\u8981\uff09 \u8c03\u8bd5/\u6d4b\u8bd5 50-100 \u5feb\u901f\u9a8c\u8bc1\uff0c\u51cf\u5c11\u5e72\u6270"},{"location":"zh/session/#4-ttl","title":"4\ufe0f\u20e3 TTL \u7ba1\u7406\uff08\u81ea\u52a8\u8fc7\u671f\uff09","text":"<p>\u652f\u6301\u4e3a\u4f1a\u8bdd\u6570\u636e\u8bbe\u7f6e\u751f\u5b58\u65f6\u95f4\uff08Time To Live\uff09\uff0c\u81ea\u52a8\u6e05\u7406\u8fc7\u671f\u6570\u636e\u3002</p> <p>\u652f\u6301\u7684 TTL \u7c7b\u578b\uff1a</p> <ul> <li>SessionTTL\uff1a\u4f1a\u8bdd\u72b6\u6001\u548c\u4e8b\u4ef6\u7684\u8fc7\u671f\u65f6\u95f4</li> <li>AppStateTTL\uff1a\u5e94\u7528\u7ea7\u72b6\u6001\u7684\u8fc7\u671f\u65f6\u95f4</li> <li>UserStateTTL\uff1a\u7528\u6237\u7ea7\u72b6\u6001\u7684\u8fc7\u671f\u65f6\u95f4</li> </ul> <p>\u914d\u7f6e\u793a\u4f8b\uff1a</p> <pre><code>sessionService := inmemory.NewSessionService(\n    inmemory.WithSessionTTL(30*time.Minute),     // \u4f1a\u8bdd 30 \u5206\u949f\u65e0\u6d3b\u52a8\u540e\u8fc7\u671f\n    inmemory.WithAppStateTTL(24*time.Hour),      // \u5e94\u7528\u72b6\u6001 24 \u5c0f\u65f6\u540e\u8fc7\u671f\n    inmemory.WithUserStateTTL(7*24*time.Hour),   // \u7528\u6237\u72b6\u6001 7 \u5929\u540e\u8fc7\u671f\n)\n</code></pre> <p>\u8fc7\u671f\u884c\u4e3a\uff1a</p> \u5b58\u50a8\u7c7b\u578b \u8fc7\u671f\u673a\u5236 \u81ea\u52a8\u6e05\u7406 \u5185\u5b58\u5b58\u50a8 \u5b9a\u671f\u626b\u63cf + \u8bbf\u95ee\u65f6\u68c0\u67e5 \u662f Redis \u5b58\u50a8 Redis \u539f\u751f TTL \u662f PostgreSQL \u5b9a\u671f\u626b\u63cf\uff08\u8f6f\u5220\u9664\u6216\u786c\u5220\u9664\uff09 \u662f MySQL \u5b9a\u671f\u626b\u63cf\uff08\u8f6f\u5220\u9664\u6216\u786c\u5220\u9664\uff09 \u662f"},{"location":"zh/session/#_7","title":"\u5b58\u50a8\u540e\u7aef\u5bf9\u6bd4","text":"<p>tRPC-Agent-Go \u63d0\u4f9b\u56db\u79cd\u4f1a\u8bdd\u5b58\u50a8\u540e\u7aef\uff0c\u6ee1\u8db3\u4e0d\u540c\u573a\u666f\u9700\u6c42\uff1a</p> \u5b58\u50a8\u7c7b\u578b \u9002\u7528\u573a\u666f \u4f18\u52bf \u52a3\u52bf \u5185\u5b58\u5b58\u50a8 \u5f00\u53d1\u6d4b\u8bd5\u3001\u5c0f\u89c4\u6a21 \u7b80\u5355\u5feb\u901f\u3001\u65e0\u9700\u5916\u90e8\u4f9d\u8d56 \u6570\u636e\u4e0d\u6301\u4e45\u3001\u4e0d\u652f\u6301\u5206\u5e03\u5f0f Redis \u5b58\u50a8 \u751f\u4ea7\u73af\u5883\u3001\u5206\u5e03\u5f0f \u9ad8\u6027\u80fd\u3001\u652f\u6301\u5206\u5e03\u5f0f\u3001\u81ea\u52a8\u8fc7\u671f \u9700\u8981 Redis \u670d\u52a1 PostgreSQL \u751f\u4ea7\u73af\u5883\u3001\u590d\u6742\u67e5\u8be2 \u5173\u7cfb\u578b\u6570\u636e\u5e93\u3001\u652f\u6301\u590d\u6742\u67e5\u8be2\u3001JSONB \u76f8\u5bf9\u8f83\u91cd\u3001\u9700\u8981\u6570\u636e\u5e93 MySQL \u751f\u4ea7\u73af\u5883\u3001\u590d\u6742\u67e5\u8be2 \u5e7f\u6cdb\u4f7f\u7528\u3001\u652f\u6301\u590d\u6742\u67e5\u8be2\u3001JSON \u76f8\u5bf9\u8f83\u91cd\u3001\u9700\u8981\u6570\u636e\u5e93"},{"location":"zh/session/#memory","title":"\u5185\u5b58\u5b58\u50a8\uff08Memory\uff09","text":"<p>\u9002\u7528\u4e8e\u5f00\u53d1\u73af\u5883\u548c\u5c0f\u89c4\u6a21\u5e94\u7528\uff0c\u65e0\u9700\u5916\u90e8\u4f9d\u8d56\uff0c\u5f00\u7bb1\u5373\u7528\u3002</p>"},{"location":"zh/session/#_8","title":"\u914d\u7f6e\u9009\u9879","text":"<ul> <li><code>WithSessionEventLimit(limit int)</code>\uff1a\u8bbe\u7f6e\u6bcf\u4e2a\u4f1a\u8bdd\u5b58\u50a8\u7684\u6700\u5927\u4e8b\u4ef6\u6570\u91cf\u3002\u9ed8\u8ba4\u503c\u4e3a 1000\uff0c\u8d85\u8fc7\u9650\u5236\u65f6\u6dd8\u6c70\u8001\u7684\u4e8b\u4ef6\u3002</li> <li><code>WithSessionTTL(ttl time.Duration)</code>\uff1a\u8bbe\u7f6e\u4f1a\u8bdd\u72b6\u6001\u548c\u4e8b\u4ef6\u5217\u8868\u7684 TTL\u3002\u9ed8\u8ba4\u503c\u4e3a 0\uff08\u4e0d\u8fc7\u671f\uff09\u3002</li> <li><code>WithAppStateTTL(ttl time.Duration)</code>\uff1a\u8bbe\u7f6e\u5e94\u7528\u7ea7\u72b6\u6001\u7684 TTL\u3002\u9ed8\u8ba4\u503c\u4e3a 0\uff08\u4e0d\u8fc7\u671f\uff09\u3002</li> <li><code>WithUserStateTTL(ttl time.Duration)</code>\uff1a\u8bbe\u7f6e\u7528\u6237\u7ea7\u72b6\u6001\u7684 TTL\u3002\u9ed8\u8ba4\u503c\u4e3a 0\uff08\u4e0d\u8fc7\u671f\uff09\u3002</li> <li><code>WithCleanupInterval(interval time.Duration)</code>\uff1a\u8bbe\u7f6e\u8fc7\u671f\u6570\u636e\u81ea\u52a8\u6e05\u7406\u7684\u95f4\u9694\u3002\u9ed8\u8ba4\u503c\u4e3a 0\uff08\u81ea\u52a8\u786e\u5b9a\uff09\uff0c\u5982\u679c\u914d\u7f6e\u4e86\u4efb\u4f55 TTL\uff0c\u9ed8\u8ba4\u6e05\u7406\u95f4\u9694\u4e3a 5 \u5206\u949f\u3002</li> <li><code>WithSummarizer(s summary.SessionSummarizer)</code>\uff1a\u6ce8\u5165\u4f1a\u8bdd\u6458\u8981\u5668\u3002</li> <li><code>WithAsyncSummaryNum(num int)</code>\uff1a\u8bbe\u7f6e\u6458\u8981\u5904\u7406 worker \u6570\u91cf\u3002\u9ed8\u8ba4\u503c\u4e3a 3\u3002</li> <li><code>WithSummaryQueueSize(size int)</code>\uff1a\u8bbe\u7f6e\u6458\u8981\u4efb\u52a1\u961f\u5217\u5927\u5c0f\u3002\u9ed8\u8ba4\u503c\u4e3a 100\u3002</li> <li><code>WithSummaryJobTimeout(timeout time.Duration)</code>\uff1a\u8bbe\u7f6e\u5355\u4e2a\u6458\u8981\u4efb\u52a1\u8d85\u65f6\u65f6\u95f4\u3002\u9ed8\u8ba4\u503c\u4e3a 30 \u79d2\u3002</li> </ul>"},{"location":"zh/session/#_9","title":"\u57fa\u7840\u914d\u7f6e\u793a\u4f8b","text":"<pre><code>import \"trpc.group/trpc-go/trpc-agent-go/session/inmemory\"\n\n// \u9ed8\u8ba4\u914d\u7f6e\uff08\u5f00\u53d1\u73af\u5883\uff09\nsessionService := inmemory.NewSessionService()\n// \u6548\u679c\uff1a\n// - \u6bcf\u4e2a\u4f1a\u8bdd\u6700\u591a 1000 \u4e2a\u4e8b\u4ef6\n// - \u6240\u6709\u6570\u636e\u6c38\u4e0d\u8fc7\u671f\n// - \u4e0d\u6267\u884c\u81ea\u52a8\u6e05\u7406\n\n// \u751f\u4ea7\u73af\u5883\u914d\u7f6e\nsessionService := inmemory.NewSessionService(\n    inmemory.WithSessionEventLimit(500),\n    inmemory.WithSessionTTL(30*time.Minute),\n    inmemory.WithAppStateTTL(24*time.Hour),\n    inmemory.WithUserStateTTL(7*24*time.Hour),\n    inmemory.WithCleanupInterval(10*time.Minute),\n)\n// \u6548\u679c\uff1a\n// - \u6bcf\u4e2a\u4f1a\u8bdd\u6700\u591a 500 \u4e2a\u4e8b\u4ef6\n// - \u4f1a\u8bdd 30 \u5206\u949f\u65e0\u6d3b\u52a8\u540e\u8fc7\u671f\n// - \u5e94\u7528\u72b6\u6001 24 \u5c0f\u65f6\u8fc7\u671f\n// - \u7528\u6237\u72b6\u6001 7 \u5929\u8fc7\u671f\n// - \u6bcf 10 \u5206\u949f\u6e05\u7406\u4e00\u6b21\u8fc7\u671f\u6570\u636e\n</code></pre>"},{"location":"zh/session/#_10","title":"\u914d\u5408\u6458\u8981\u4f7f\u7528","text":"<pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/session/inmemory\"\n    \"trpc.group/trpc-go/trpc-agent-go/session/summary\"\n)\n\n// \u521b\u5efa\u6458\u8981\u5668\nsummarizer := summary.NewSummarizer(\n    summaryModel,\n    summary.WithEventThreshold(20),\n    summary.WithMaxSummaryWords(200),\n)\n\n// \u521b\u5efa\u4f1a\u8bdd\u670d\u52a1\u5e76\u6ce8\u5165\u6458\u8981\u5668\nsessionService := inmemory.NewSessionService(\n    inmemory.WithSessionEventLimit(1000),\n    inmemory.WithSummarizer(summarizer),\n    inmemory.WithAsyncSummaryNum(2),\n    inmemory.WithSummaryQueueSize(100),\n    inmemory.WithSummaryJobTimeout(30*time.Second),\n)\n</code></pre>"},{"location":"zh/session/#redis","title":"Redis \u5b58\u50a8","text":"<p>\u9002\u7528\u4e8e\u751f\u4ea7\u73af\u5883\u548c\u5206\u5e03\u5f0f\u5e94\u7528\uff0c\u63d0\u4f9b\u9ad8\u6027\u80fd\u548c\u81ea\u52a8\u8fc7\u671f\u80fd\u529b\u3002</p>"},{"location":"zh/session/#_11","title":"\u914d\u7f6e\u9009\u9879","text":"<ul> <li><code>WithRedisClientURL(url string)</code>\uff1a\u901a\u8fc7 URL \u521b\u5efa Redis \u5ba2\u6237\u7aef\u3002\u683c\u5f0f\uff1a<code>redis://[username:password@]host:port[/database]</code>\u3002</li> <li><code>WithRedisInstance(instanceName string)</code>\uff1a\u4f7f\u7528\u9884\u914d\u7f6e\u7684 Redis \u5b9e\u4f8b\u3002\u6ce8\u610f\uff1a<code>WithRedisClientURL</code> \u7684\u4f18\u5148\u7ea7\u9ad8\u4e8e <code>WithRedisInstance</code>\u3002</li> <li><code>WithSessionEventLimit(limit int)</code>\uff1a\u8bbe\u7f6e\u6bcf\u4e2a\u4f1a\u8bdd\u5b58\u50a8\u7684\u6700\u5927\u4e8b\u4ef6\u6570\u91cf\u3002\u9ed8\u8ba4\u503c\u4e3a 1000\u3002</li> <li><code>WithSessionTTL(ttl time.Duration)</code>\uff1a\u8bbe\u7f6e\u4f1a\u8bdd\u72b6\u6001\u548c\u4e8b\u4ef6\u7684 TTL\u3002\u9ed8\u8ba4\u503c\u4e3a 0\uff08\u4e0d\u8fc7\u671f\uff09\u3002</li> <li><code>WithAppStateTTL(ttl time.Duration)</code>\uff1a\u8bbe\u7f6e\u5e94\u7528\u7ea7\u72b6\u6001\u7684 TTL\u3002\u9ed8\u8ba4\u503c\u4e3a 0\uff08\u4e0d\u8fc7\u671f\uff09\u3002</li> <li><code>WithUserStateTTL(ttl time.Duration)</code>\uff1a\u8bbe\u7f6e\u7528\u6237\u7ea7\u72b6\u6001\u7684 TTL\u3002\u9ed8\u8ba4\u503c\u4e3a 0\uff08\u4e0d\u8fc7\u671f\uff09\u3002</li> <li><code>WithEnableAsyncPersist(enable bool)</code>\uff1a\u542f\u7528\u5f02\u6b65\u6301\u4e45\u5316\u3002\u9ed8\u8ba4\u503c\u4e3a <code>false</code>\u3002</li> <li><code>WithAsyncPersisterNum(num int)</code>\uff1a\u5f02\u6b65\u6301\u4e45\u5316 worker \u6570\u91cf\u3002\u9ed8\u8ba4\u503c\u4e3a 10\u3002</li> <li><code>WithSummarizer(s summary.SessionSummarizer)</code>\uff1a\u6ce8\u5165\u4f1a\u8bdd\u6458\u8981\u5668\u3002</li> <li><code>WithAsyncSummaryNum(num int)</code>\uff1a\u8bbe\u7f6e\u6458\u8981\u5904\u7406 worker \u6570\u91cf\u3002\u9ed8\u8ba4\u503c\u4e3a 3\u3002</li> <li><code>WithSummaryQueueSize(size int)</code>\uff1a\u8bbe\u7f6e\u6458\u8981\u4efb\u52a1\u961f\u5217\u5927\u5c0f\u3002\u9ed8\u8ba4\u503c\u4e3a 100\u3002</li> <li><code>WithSummaryJobTimeout(timeout time.Duration)</code>\uff1a\u8bbe\u7f6e\u5355\u4e2a\u6458\u8981\u4efb\u52a1\u8d85\u65f6\u65f6\u95f4\u3002\u9ed8\u8ba4\u503c\u4e3a 30 \u79d2\u3002</li> <li><code>WithExtraOptions(extraOptions ...interface{})</code>\uff1a\u4e3a Redis \u5ba2\u6237\u7aef\u8bbe\u7f6e\u989d\u5916\u9009\u9879\u3002</li> </ul>"},{"location":"zh/session/#_12","title":"\u57fa\u7840\u914d\u7f6e\u793a\u4f8b","text":"<pre><code>import \"trpc.group/trpc-go/trpc-agent-go/session/redis\"\n\n// \u4f7f\u7528 URL \u521b\u5efa\uff08\u63a8\u8350\uff09\nsessionService, err := redis.NewService(\n    redis.WithRedisClientURL(\"redis://username:password@127.0.0.1:6379/0\"),\n    redis.WithSessionEventLimit(500),\n)\n\n// \u751f\u4ea7\u73af\u5883\u5b8c\u6574\u914d\u7f6e\nsessionService, err := redis.NewService(\n    redis.WithRedisClientURL(\"redis://localhost:6379/0\"),\n    redis.WithSessionEventLimit(1000),\n    redis.WithSessionTTL(30*time.Minute),\n    redis.WithAppStateTTL(24*time.Hour),\n    redis.WithUserStateTTL(7*24*time.Hour),\n)\n// \u6548\u679c\uff1a\n// - \u8fde\u63a5\u5230\u672c\u5730 Redis 0 \u53f7\u6570\u636e\u5e93\n// - \u6bcf\u4e2a\u4f1a\u8bdd\u6700\u591a 1000 \u4e2a\u4e8b\u4ef6\n// - \u4f1a\u8bdd 30 \u5206\u949f\u65e0\u6d3b\u52a8\u540e\u81ea\u52a8\u8fc7\u671f\uff08Redis TTL\uff09\n// - \u5e94\u7528\u72b6\u6001 24 \u5c0f\u65f6\u540e\u8fc7\u671f\n// - \u7528\u6237\u72b6\u6001 7 \u5929\u540e\u8fc7\u671f\n// - \u5229\u7528 Redis \u539f\u751f TTL \u673a\u5236\uff0c\u65e0\u9700\u624b\u52a8\u6e05\u7406\n</code></pre>"},{"location":"zh/session/#_13","title":"\u914d\u7f6e\u590d\u7528","text":"<p>\u5982\u679c\u591a\u4e2a\u7ec4\u4ef6\u9700\u8981\u4f7f\u7528\u540c\u4e00 Redis \u5b9e\u4f8b\uff0c\u53ef\u4ee5\u6ce8\u518c\u540e\u590d\u7528\uff1a</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/storage\"\n    \"trpc.group/trpc-go/trpc-agent-go/session/redis\"\n)\n\n// \u6ce8\u518c Redis \u5b9e\u4f8b\nredisURL := \"redis://127.0.0.1:6379\"\nstorage.RegisterRedisInstance(\"my-redis-instance\",\n    storage.WithClientBuilderURL(redisURL))\n\n// \u5728\u4f1a\u8bdd\u670d\u52a1\u4e2d\u4f7f\u7528\nsessionService, err := redis.NewService(\n    redis.WithRedisInstance(\"my-redis-instance\"),\n    redis.WithSessionEventLimit(500),\n)\n</code></pre>"},{"location":"zh/session/#_14","title":"\u914d\u5408\u6458\u8981\u4f7f\u7528","text":"<pre><code>sessionService, err := redis.NewService(\n    redis.WithRedisClientURL(\"redis://localhost:6379\"),\n    redis.WithSessionEventLimit(1000),\n    redis.WithSessionTTL(30*time.Minute),\n\n    // \u6458\u8981\u914d\u7f6e\n    redis.WithSummarizer(summarizer),\n    redis.WithAsyncSummaryNum(4),\n    redis.WithSummaryQueueSize(200),\n)\n</code></pre>"},{"location":"zh/session/#_15","title":"\u5b58\u50a8\u7ed3\u6784","text":"<pre><code># \u5e94\u7528\u6570\u636e\nappdata:{appName} -&gt; Hash {key: value}\n\n# \u7528\u6237\u6570\u636e\nuserdata:{appName}:{userID} -&gt; Hash {key: value}\n\n# \u4f1a\u8bdd\u6570\u636e\nsession:{appName}:{userID} -&gt; Hash {sessionID: SessionData(JSON)}\n\n# \u4e8b\u4ef6\u8bb0\u5f55\nevents:{appName}:{userID}:{sessionID} -&gt; SortedSet {score: timestamp, value: Event(JSON)}\n\n# \u6458\u8981\u6570\u636e\uff08\u53ef\u9009\uff09\nsummary:{appName}:{userID}:{sessionID}:{filterKey} -&gt; String (JSON)\n</code></pre>"},{"location":"zh/session/#postgresql","title":"PostgreSQL \u5b58\u50a8","text":"<p>\u9002\u7528\u4e8e\u751f\u4ea7\u73af\u5883\u548c\u9700\u8981\u590d\u6742\u67e5\u8be2\u7684\u5e94\u7528\uff0c\u63d0\u4f9b\u5173\u7cfb\u578b\u6570\u636e\u5e93\u7684\u5b8c\u6574\u80fd\u529b\u3002</p>"},{"location":"zh/session/#_16","title":"\u914d\u7f6e\u9009\u9879","text":"<p>\u8fde\u63a5\u914d\u7f6e\uff1a</p> <p>\u65b9\u5f0f\u4e00\uff1a</p> <ul> <li><code>WithPostgresClientDSN(dsn string)</code>\uff1aPostgreSQL DSN\u3002 \u793a\u4f8b\uff1a<code>postgres://user:password@localhost:5432/dbname</code></li> </ul> <p>\u65b9\u5f0f\u4e8c\uff1a</p> <ul> <li><code>WithHost(host string)</code>\uff1aPostgreSQL \u670d\u52a1\u5668\u5730\u5740\u3002\u9ed8\u8ba4\u503c\u4e3a <code>localhost</code>\u3002</li> <li><code>WithPort(port int)</code>\uff1aPostgreSQL \u670d\u52a1\u5668\u7aef\u53e3\u3002\u9ed8\u8ba4\u503c\u4e3a <code>5432</code>\u3002</li> <li><code>WithUser(user string)</code>\uff1a\u6570\u636e\u5e93\u7528\u6237\u540d\u3002\u9ed8\u8ba4\u503c\u4e3a <code>postgres</code>\u3002</li> <li><code>WithPassword(password string)</code>\uff1a\u6570\u636e\u5e93\u5bc6\u7801\u3002\u9ed8\u8ba4\u503c\u4e3a\u7a7a\u5b57\u7b26\u4e32\u3002</li> <li><code>WithDatabase(database string)</code>\uff1a\u6570\u636e\u5e93\u540d\u79f0\u3002\u9ed8\u8ba4\u503c\u4e3a <code>postgres</code>\u3002</li> <li><code>WithSSLMode(sslMode string)</code>\uff1aSSL \u6a21\u5f0f\u3002\u9ed8\u8ba4\u503c\u4e3a <code>disable</code>\u3002\u53ef\u9009\u503c\uff1a<code>disable</code>\u3001<code>require</code>\u3001<code>verify-ca</code>\u3001<code>verify-full</code>\u3002</li> </ul> <p>\u65b9\u5f0f\u4e09\uff1a</p> <ul> <li><code>WithPostgresInstance(name string)</code>\uff1a\u4f7f\u7528\u9884\u914d\u7f6e\u7684 PostgreSQL \u5b9e\u4f8b\u3002</li> </ul> <p>\u4f18\u5148\u7ea7\uff1a\u65b9\u5f0f\u4e00 &gt; \u65b9\u5f0f\u4e8c &gt; \u65b9\u5f0f\u4e09</p> <p>\u4f1a\u8bdd\u914d\u7f6e\uff1a</p> <ul> <li><code>WithSessionEventLimit(limit int)</code>\uff1a\u6bcf\u4e2a\u4f1a\u8bdd\u6700\u5927\u4e8b\u4ef6\u6570\u91cf\u3002\u9ed8\u8ba4\u503c\u4e3a 1000\u3002</li> <li><code>WithSessionTTL(ttl time.Duration)</code>\uff1a\u4f1a\u8bdd TTL\u3002\u9ed8\u8ba4\u503c\u4e3a 0\uff08\u4e0d\u8fc7\u671f\uff09\u3002</li> <li><code>WithAppStateTTL(ttl time.Duration)</code>\uff1a\u5e94\u7528\u72b6\u6001 TTL\u3002\u9ed8\u8ba4\u503c\u4e3a 0\uff08\u4e0d\u8fc7\u671f\uff09\u3002</li> <li><code>WithUserStateTTL(ttl time.Duration)</code>\uff1a\u7528\u6237\u72b6\u6001 TTL\u3002\u9ed8\u8ba4\u503c\u4e3a 0\uff08\u4e0d\u8fc7\u671f\uff09\u3002</li> <li><code>WithCleanupInterval(interval time.Duration)</code>\uff1aTTL \u6e05\u7406\u95f4\u9694\u3002\u9ed8\u8ba4\u503c\u4e3a 5 \u5206\u949f\u3002</li> <li><code>WithSoftDelete(enable bool)</code>\uff1a\u542f\u7528\u6216\u7981\u7528\u8f6f\u5220\u9664\u3002\u9ed8\u8ba4\u503c\u4e3a <code>true</code>\u3002</li> </ul> <p>\u5f02\u6b65\u6301\u4e45\u5316\u914d\u7f6e\uff1a</p> <ul> <li><code>WithEnableAsyncPersist(enable bool)</code>\uff1a\u542f\u7528\u5f02\u6b65\u6301\u4e45\u5316\u3002\u9ed8\u8ba4\u503c\u4e3a <code>false</code>\u3002</li> <li><code>WithAsyncPersisterNum(num int)</code>\uff1a\u5f02\u6b65\u6301\u4e45\u5316 worker \u6570\u91cf\u3002\u9ed8\u8ba4\u503c\u4e3a 10\u3002</li> </ul> <p>\u6458\u8981\u914d\u7f6e\uff1a</p> <ul> <li><code>WithSummarizer(s summary.SessionSummarizer)</code>\uff1a\u6ce8\u5165\u4f1a\u8bdd\u6458\u8981\u5668\u3002</li> <li><code>WithAsyncSummaryNum(num int)</code>\uff1a\u6458\u8981\u5904\u7406 worker \u6570\u91cf\u3002\u9ed8\u8ba4\u503c\u4e3a 3\u3002</li> <li><code>WithSummaryQueueSize(size int)</code>\uff1a\u6458\u8981\u4efb\u52a1\u961f\u5217\u5927\u5c0f\u3002\u9ed8\u8ba4\u503c\u4e3a 100\u3002</li> <li><code>WithSummaryJobTimeout(timeout time.Duration)</code>\uff1a\u8bbe\u7f6e\u5355\u4e2a\u6458\u8981\u4efb\u52a1\u8d85\u65f6\u65f6\u95f4\u3002\u9ed8\u8ba4\u503c\u4e3a 30 \u79d2\u3002</li> </ul> <p>Schema \u548c\u8868\u914d\u7f6e\uff1a</p> <ul> <li><code>WithSchema(schema string)</code>\uff1a\u6307\u5b9a schema \u540d\u79f0\u3002</li> <li><code>WithTablePrefix(prefix string)</code>\uff1a\u8868\u540d\u524d\u7f00\u3002</li> <li><code>WithSkipDBInit(skip bool)</code>\uff1a\u8df3\u8fc7\u81ea\u52a8\u5efa\u8868\u3002</li> </ul>"},{"location":"zh/session/#_17","title":"\u57fa\u7840\u914d\u7f6e\u793a\u4f8b","text":"<pre><code>import \"trpc.group/trpc-go/trpc-agent-go/session/postgres\"\n\n// \u9ed8\u8ba4\u914d\u7f6e\uff08\u6700\u7b80\uff09\nsessionService, err := postgres.NewService(\n    postgres.WithPostgresClientDSN(\"postgres://user:password@localhost:5432/mydb?sslmode=disable\"),\n)\n\n\n// \u751f\u4ea7\u73af\u5883\u5b8c\u6574\u914d\u7f6e\nsessionService, err := postgres.NewService(\n    postgres.WithPostgresClientDSN(\"postgres://user:password@localhost:5432/trpc_sessions?sslmode=require\"),\n\n    // \u4f1a\u8bdd\u914d\u7f6e\n    postgres.WithSessionEventLimit(1000),\n    postgres.WithSessionTTL(30*time.Minute),\n    postgres.WithAppStateTTL(24*time.Hour),\n    postgres.WithUserStateTTL(7*24*time.Hour),\n\n    // TTL \u6e05\u7406\u914d\u7f6e\n    postgres.WithCleanupInterval(10*time.Minute),\n    postgres.WithSoftDelete(true),  // \u8f6f\u5220\u9664\u6a21\u5f0f\n\n    // \u5f02\u6b65\u6301\u4e45\u5316\u914d\u7f6e\n    postgres.WithAsyncPersisterNum(4),\n)\n// \u6548\u679c\uff1a\n// - \u4f7f\u7528 SSL \u52a0\u5bc6\u8fde\u63a5\n// - \u4f1a\u8bdd 30 \u5206\u949f\u65e0\u6d3b\u52a8\u540e\u8fc7\u671f\n// - \u6bcf 10 \u5206\u949f\u6e05\u7406\u8fc7\u671f\u6570\u636e\uff08\u8f6f\u5220\u9664\uff09\n// - 4 \u4e2a\u5f02\u6b65 worker \u5904\u7406\u5199\u5165\n</code></pre>"},{"location":"zh/session/#_18","title":"\u914d\u7f6e\u590d\u7528","text":"<pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/storage/postgres\"\n    sessionpg \"trpc.group/trpc-go/trpc-agent-go/session/postgres\"\n)\n\n// \u6ce8\u518c PostgreSQL \u5b9e\u4f8b\npostgres.RegisterPostgresInstance(\"my-postgres-instance\",\n    postgres.WithClientConnString(\"postgres://user:password@localhost:5432/trpc_sessions?sslmode=disable\"),\n)\n\n// \u5728\u4f1a\u8bdd\u670d\u52a1\u4e2d\u4f7f\u7528\nsessionService, err := sessionpg.NewService(\n    sessionpg.WithPostgresInstance(\"my-postgres-instance\"),\n    sessionpg.WithSessionEventLimit(500),\n)\n</code></pre>"},{"location":"zh/session/#schema","title":"Schema \u4e0e\u8868\u524d\u7f00","text":"<p>PostgreSQL \u652f\u6301 schema \u548c\u8868\u524d\u7f00\u914d\u7f6e\uff0c\u9002\u7528\u4e8e\u591a\u79df\u6237\u548c\u591a\u73af\u5883\u573a\u666f\uff1a</p> <pre><code>// \u4f7f\u7528 schema\nsessionService, err := postgres.NewService(\n    postgres.WithHost(\"localhost\"),\n    postgres.WithDatabase(\"mydb\"),\n    postgres.WithSchema(\"my_schema\"),  // \u8868\u540d\uff1amy_schema.session_states\n)\n\n// \u4f7f\u7528\u8868\u524d\u7f00\nsessionService, err := postgres.NewService(\n    postgres.WithHost(\"localhost\"),\n    postgres.WithTablePrefix(\"app1_\"),  // \u8868\u540d\uff1aapp1_session_states\n)\n\n// \u7ed3\u5408\u4f7f\u7528\nsessionService, err := postgres.NewService(\n    postgres.WithHost(\"localhost\"),\n    postgres.WithSchema(\"tenant_a\"),\n    postgres.WithTablePrefix(\"app1_\"),  // \u8868\u540d\uff1atenant_a.app1_session_states\n)\n</code></pre> <p>\u8868\u547d\u540d\u89c4\u5219\uff1a</p> Schema Prefix \u6700\u7ec8\u8868\u540d \uff08\u65e0\uff09 \uff08\u65e0\uff09 <code>session_states</code> \uff08\u65e0\uff09 <code>app1_</code> <code>app1_session_states</code> <code>my_schema</code> \uff08\u65e0\uff09 <code>my_schema.session_states</code> <code>my_schema</code> <code>app1_</code> <code>my_schema.app1_session_states</code>"},{"location":"zh/session/#ttl","title":"\u8f6f\u5220\u9664\u4e0e TTL \u6e05\u7406","text":"<p>\u8f6f\u5220\u9664\u914d\u7f6e\uff1a</p> <pre><code>// \u542f\u7528\u8f6f\u5220\u9664\uff08\u9ed8\u8ba4\uff09\nsessionService, err := postgres.NewService(\n    postgres.WithHost(\"localhost\"),\n    postgres.WithSoftDelete(true),\n)\n\n// \u7981\u7528\u8f6f\u5220\u9664\uff08\u7269\u7406\u5220\u9664\uff09\nsessionService, err := postgres.NewService(\n    postgres.WithHost(\"localhost\"),\n    postgres.WithSoftDelete(false),\n)\n</code></pre> <p>\u5220\u9664\u884c\u4e3a\u5bf9\u6bd4\uff1a</p> \u914d\u7f6e \u5220\u9664\u64cd\u4f5c \u67e5\u8be2\u884c\u4e3a \u6570\u636e\u6062\u590d <code>softDelete=true</code> <code>UPDATE SET deleted_at = NOW()</code> \u67e5\u8be2\u9644\u5e26 <code>WHERE deleted_at IS NULL</code>\uff0c\u4ec5\u8fd4\u56de\u672a\u8f6f\u5220\u9664\u6570\u636e \u53ef\u6062\u590d <code>softDelete=false</code> <code>DELETE FROM ...</code> \u67e5\u8be2\u6240\u6709\u8bb0\u5f55 \u4e0d\u53ef\u6062\u590d <p>TTL \u81ea\u52a8\u6e05\u7406\uff1a</p> <pre><code>sessionService, err := postgres.NewService(\n    postgres.WithHost(\"localhost\"),\n    postgres.WithSessionTTL(30*time.Minute),      // \u4f1a\u8bdd 30 \u5206\u949f\u540e\u8fc7\u671f\n    postgres.WithAppStateTTL(24*time.Hour),       // \u5e94\u7528\u72b6\u6001 24 \u5c0f\u65f6\u540e\u8fc7\u671f\n    postgres.WithUserStateTTL(7*24*time.Hour),    // \u7528\u6237\u72b6\u6001 7 \u5929\u540e\u8fc7\u671f\n    postgres.WithCleanupInterval(10*time.Minute), // \u6bcf 10 \u5206\u949f\u6e05\u7406\u4e00\u6b21\n    postgres.WithSoftDelete(true),                // \u8f6f\u5220\u9664\u6a21\u5f0f\n)\n// \u6e05\u7406\u884c\u4e3a\uff1a\n// - softDelete=true\uff1a\u8fc7\u671f\u6570\u636e\u6807\u8bb0\u4e3a deleted_at = NOW()\n// - softDelete=false\uff1a\u8fc7\u671f\u6570\u636e\u88ab\u7269\u7406\u5220\u9664\n// - \u67e5\u8be2\u65f6\u59cb\u7ec8\u9644\u52a0 `WHERE deleted_at IS NULL`\uff0c\u4ec5\u8fd4\u56de\u672a\u8f6f\u5220\u9664\u6570\u636e\n</code></pre>"},{"location":"zh/session/#_19","title":"\u914d\u5408\u6458\u8981\u4f7f\u7528","text":"<pre><code>sessionService, err := postgres.NewService(\n    postgres.WithHost(\"localhost\"),\n    postgres.WithPassword(\"your-password\"),\n    postgres.WithSessionEventLimit(1000),\n    postgres.WithSessionTTL(30*time.Minute),\n\n    // \u6458\u8981\u914d\u7f6e\n    postgres.WithSummarizer(summarizer),\n    postgres.WithAsyncSummaryNum(2),\n    postgres.WithSummaryQueueSize(100),\n)\n</code></pre>"},{"location":"zh/session/#_20","title":"\u5b58\u50a8\u7ed3\u6784","text":"<p>PostgreSQL \u4f7f\u7528\u5173\u7cfb\u578b\u8868\u7ed3\u6784\uff0cJSON \u6570\u636e\u4f7f\u7528 JSONB \u7c7b\u578b\u5b58\u50a8\uff1a</p> <pre><code>-- \u4f1a\u8bdd\u72b6\u6001\u8868\nCREATE TABLE session_states (\n    id BIGSERIAL PRIMARY KEY,\n    app_name VARCHAR(255) NOT NULL,\n    user_id VARCHAR(255) NOT NULL,\n    session_id VARCHAR(255) NOT NULL,\n    state JSONB,\n    created_at TIMESTAMP NOT NULL,\n    updated_at TIMESTAMP NOT NULL,\n    expires_at TIMESTAMP,\n    deleted_at TIMESTAMP\n);\n\n-- \u90e8\u5206\u552f\u4e00\u7d22\u5f15\uff08\u53ea\u5bf9\u672a\u5220\u9664\u8bb0\u5f55\u751f\u6548\uff09\nCREATE UNIQUE INDEX idx_session_states_unique_active\nON session_states(app_name, user_id, session_id)\nWHERE deleted_at IS NULL;\n\n-- \u4f1a\u8bdd\u4e8b\u4ef6\u8868\nCREATE TABLE session_events (\n    id BIGSERIAL PRIMARY KEY,\n    app_name VARCHAR(255) NOT NULL,\n    user_id VARCHAR(255) NOT NULL,\n    session_id VARCHAR(255) NOT NULL,\n    event JSONB NOT NULL,\n    created_at TIMESTAMP NOT NULL,\n    updated_at TIMESTAMP NOT NULL,\n    expires_at TIMESTAMP,\n    deleted_at TIMESTAMP\n);\n\n-- \u8f68\u8ff9\u4e8b\u4ef6\u8868\nCREATE TABLE session_track_events (\n    id BIGSERIAL PRIMARY KEY,\n    app_name VARCHAR(255) NOT NULL,\n    user_id VARCHAR(255) NOT NULL,\n    session_id VARCHAR(255) NOT NULL,\n    track VARCHAR(255) NOT NULL,\n    event JSONB NOT NULL,\n    created_at TIMESTAMP NOT NULL,\n    updated_at TIMESTAMP NOT NULL,\n    expires_at TIMESTAMP,\n    deleted_at TIMESTAMP\n);\n\n-- \u4f1a\u8bdd\u6458\u8981\u8868\nCREATE TABLE session_summaries (\n    id BIGSERIAL PRIMARY KEY,\n    app_name VARCHAR(255) NOT NULL,\n    user_id VARCHAR(255) NOT NULL,\n    session_id VARCHAR(255) NOT NULL,\n    filter_key VARCHAR(255) NOT NULL,\n    summary JSONB NOT NULL,\n    updated_at TIMESTAMP NOT NULL,\n    expires_at TIMESTAMP,\n    deleted_at TIMESTAMP,\n    UNIQUE(app_name, user_id, session_id, filter_key)\n);\n\n-- \u5e94\u7528\u72b6\u6001\u8868\nCREATE TABLE app_states (\n    id BIGSERIAL PRIMARY KEY,\n    app_name VARCHAR(255) NOT NULL,\n    key VARCHAR(255) NOT NULL,\n    value TEXT DEFAULT NULL,\n    created_at TIMESTAMP NOT NULL,\n    updated_at TIMESTAMP NOT NULL,\n    expires_at TIMESTAMP,\n    deleted_at TIMESTAMP,\n    UNIQUE(app_name, key)\n);\n\n-- \u7528\u6237\u72b6\u6001\u8868\nCREATE TABLE user_states (\n    id BIGSERIAL PRIMARY KEY,\n    app_name VARCHAR(255) NOT NULL,\n    user_id VARCHAR(255) NOT NULL,\n    key VARCHAR(255) NOT NULL,\n    value TEXT DEFAULT NULL,\n    created_at TIMESTAMP NOT NULL,\n    updated_at TIMESTAMP NOT NULL,\n    expires_at TIMESTAMP,\n    deleted_at TIMESTAMP,\n    UNIQUE(app_name, user_id, key)\n);\n</code></pre>"},{"location":"zh/session/#mysql","title":"MySQL \u5b58\u50a8","text":"<p>\u9002\u7528\u4e8e\u751f\u4ea7\u73af\u5883\u548c\u9700\u8981\u590d\u6742\u67e5\u8be2\u7684\u5e94\u7528\uff0cMySQL \u662f\u5e7f\u6cdb\u4f7f\u7528\u7684\u5173\u7cfb\u578b\u6570\u636e\u5e93\u3002</p>"},{"location":"zh/session/#_21","title":"\u914d\u7f6e\u9009\u9879","text":"<p>\u8fde\u63a5\u914d\u7f6e\uff1a</p> <ul> <li><code>WithMySQLClientDSN(dsn string)</code>\uff1aMySQL \u8fde\u63a5\u914d\u7f6e</li> <li><code>WithInstanceName(name string)</code>\uff1a\u4f7f\u7528\u9884\u914d\u7f6e\u7684 MySQL \u5b9e\u4f8b\u3002</li> </ul> <p>\u4f1a\u8bdd\u914d\u7f6e\uff1a</p> <ul> <li><code>WithSessionEventLimit(limit int)</code>\uff1a\u6bcf\u4e2a\u4f1a\u8bdd\u6700\u5927\u4e8b\u4ef6\u6570\u91cf\u3002\u9ed8\u8ba4\u503c\u4e3a 1000\u3002</li> <li><code>WithSessionTTL(ttl time.Duration)</code>\uff1a\u4f1a\u8bdd TTL\u3002\u9ed8\u8ba4\u503c\u4e3a 0\uff08\u4e0d\u8fc7\u671f\uff09\u3002</li> <li><code>WithAppStateTTL(ttl time.Duration)</code>\uff1a\u5e94\u7528\u72b6\u6001 TTL\u3002\u9ed8\u8ba4\u503c\u4e3a 0\uff08\u4e0d\u8fc7\u671f\uff09\u3002</li> <li><code>WithUserStateTTL(ttl time.Duration)</code>\uff1a\u7528\u6237\u72b6\u6001 TTL\u3002\u9ed8\u8ba4\u503c\u4e3a 0\uff08\u4e0d\u8fc7\u671f\uff09\u3002</li> <li><code>WithCleanupInterval(interval time.Duration)</code>\uff1aTTL \u6e05\u7406\u95f4\u9694\u3002\u9ed8\u8ba4\u503c\u4e3a 5 \u5206\u949f\u3002</li> <li><code>WithSoftDelete(enable bool)</code>\uff1a\u542f\u7528\u6216\u7981\u7528\u8f6f\u5220\u9664\u3002\u9ed8\u8ba4\u503c\u4e3a <code>true</code>\u3002</li> </ul> <p>\u5f02\u6b65\u6301\u4e45\u5316\u914d\u7f6e\uff1a</p> <ul> <li><code>WithEnableAsyncPersist(enable bool)</code>\uff1a\u542f\u7528\u5f02\u6b65\u6301\u4e45\u5316\u3002\u9ed8\u8ba4\u503c\u4e3a <code>false</code>\u3002</li> <li><code>WithAsyncPersisterNum(num int)</code>\uff1a\u5f02\u6b65\u6301\u4e45\u5316 worker \u6570\u91cf\u3002\u9ed8\u8ba4\u503c\u4e3a 10\u3002</li> </ul> <p>\u6458\u8981\u914d\u7f6e\uff1a</p> <ul> <li><code>WithSummarizer(s summary.SessionSummarizer)</code>\uff1a\u6ce8\u5165\u4f1a\u8bdd\u6458\u8981\u5668\u3002</li> <li><code>WithAsyncSummaryNum(num int)</code>\uff1a\u6458\u8981\u5904\u7406 worker \u6570\u91cf\u3002\u9ed8\u8ba4\u503c\u4e3a 3\u3002</li> <li><code>WithSummaryQueueSize(size int)</code>\uff1a\u6458\u8981\u4efb\u52a1\u961f\u5217\u5927\u5c0f\u3002\u9ed8\u8ba4\u503c\u4e3a 100\u3002</li> <li><code>WithSummaryJobTimeout(timeout time.Duration)</code>\uff1a\u8bbe\u7f6e\u5355\u4e2a\u6458\u8981\u4efb\u52a1\u8d85\u65f6\u65f6\u95f4\u3002\u9ed8\u8ba4\u503c\u4e3a 30 \u79d2\u3002</li> </ul> <p>\u8868\u914d\u7f6e\uff1a</p> <ul> <li><code>WithTablePrefix(prefix string)</code>\uff1a\u8868\u540d\u524d\u7f00\u3002</li> <li><code>WithSkipDBInit(skip bool)</code>\uff1a\u8df3\u8fc7\u81ea\u52a8\u5efa\u8868\u3002</li> </ul>"},{"location":"zh/session/#_22","title":"\u57fa\u7840\u914d\u7f6e\u793a\u4f8b","text":"<pre><code>import \"trpc.group/trpc-go/trpc-agent-go/session/mysql\"\n\n// \u9ed8\u8ba4\u914d\u7f6e\uff08\u6700\u7b80\uff09\nsessionService, err := mysql.NewService(\n    mysql.WithMySQLClientDSN(\"user:password@tcp(localhost:3306)/db?charset=utf8mb4&amp;parseTime=True&amp;loc=Local\"),\n)\n// \u6548\u679c\uff1a\n// - \u8fde\u63a5 localhost:3306\uff0c\u6570\u636e\u5e93 trpc_sessions\n// - \u6bcf\u4e2a\u4f1a\u8bdd\u6700\u591a 1000 \u4e2a\u4e8b\u4ef6\n// - \u6570\u636e\u6c38\u4e0d\u8fc7\u671f\n// - 2 \u4e2a\u5f02\u6b65\u6301\u4e45\u5316 worker\n\n// \u751f\u4ea7\u73af\u5883\u5b8c\u6574\u914d\u7f6e\nsessionService, err := mysql.NewService(\n    // \u8fde\u63a5\u914d\u7f6e\n    mysql.WithMySQLClientDSN(\"user:password@tcp(localhost:3306)/db?charset=utf8mb4&amp;parseTime=True&amp;loc=Local\"),\n\n    // \u4f1a\u8bdd\u914d\u7f6e\n    mysql.WithSessionEventLimit(1000),\n    mysql.WithSessionTTL(30*time.Minute),\n    mysql.WithAppStateTTL(24*time.Hour),\n    mysql.WithUserStateTTL(7*24*time.Hour),\n\n    // TTL \u6e05\u7406\u914d\u7f6e\n    mysql.WithCleanupInterval(10*time.Minute),\n    mysql.WithSoftDelete(true),  // \u8f6f\u5220\u9664\u6a21\u5f0f\n\n    // \u5f02\u6b65\u6301\u4e45\u5316\u914d\u7f6e\n    mysql.WithAsyncPersisterNum(4),\n)\n// \u6548\u679c\uff1a\n// - \u4f1a\u8bdd 30 \u5206\u949f\u65e0\u6d3b\u52a8\u540e\u8fc7\u671f\n// - \u6bcf 10 \u5206\u949f\u6e05\u7406\u8fc7\u671f\u6570\u636e\uff08\u8f6f\u5220\u9664\uff09\n// - 4 \u4e2a\u5f02\u6b65 worker \u5904\u7406\u5199\u5165\n</code></pre>"},{"location":"zh/session/#_23","title":"\u914d\u7f6e\u590d\u7528","text":"<pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/storage/mysql\"\n    sessionmysql \"trpc.group/trpc-go/trpc-agent-go/session/mysql\"\n)\n\n// \u6ce8\u518c MySQL \u5b9e\u4f8b\nmysql.RegisterMySQLInstance(\"my-mysql-instance\",\n    mysql.WithClientBuilderDSN(\"root:password@tcp(localhost:3306)/trpc_sessions?parseTime=true&amp;charset=utf8mb4\"),\n)\n\n// \u5728\u4f1a\u8bdd\u670d\u52a1\u4e2d\u4f7f\u7528\nsessionService, err := sessionmysql.NewService(\n    sessionmysql.WithMySQLInstance(\"my-mysql-instance\"),\n    sessionmysql.WithSessionEventLimit(500),\n)\n</code></pre>"},{"location":"zh/session/#_24","title":"\u8868\u524d\u7f00","text":"<p>MySQL \u652f\u6301\u8868\u524d\u7f00\u914d\u7f6e\uff0c\u9002\u7528\u4e8e\u591a\u5e94\u7528\u5171\u4eab\u6570\u636e\u5e93\u7684\u573a\u666f\uff1a</p> <pre><code>// \u4f7f\u7528\u8868\u524d\u7f00\nsessionService, err := mysql.NewService(\n    mysql.WithMySQLClientDSN(\"user:password@tcp(localhost:3306)/db?charset=utf8mb4&amp;parseTime=True&amp;loc=Local\"),\n    mysql.WithTablePrefix(\"app1_\"),  // \u8868\u540d\uff1aapp1_session_states\n)\n</code></pre>"},{"location":"zh/session/#ttl_1","title":"\u8f6f\u5220\u9664\u4e0e TTL \u6e05\u7406","text":"<p>\u8f6f\u5220\u9664\u914d\u7f6e\uff1a</p> <pre><code>// \u542f\u7528\u8f6f\u5220\u9664\uff08\u9ed8\u8ba4\uff09\nsessionService, err := mysql.NewService(\n    mysql.WithMySQLClientDSN(\"user:password@tcp(localhost:3306)/db?charset=utf8mb4&amp;parseTime=True&amp;loc=Local\"),\n    mysql.WithSoftDelete(true),\n)\n\n// \u7981\u7528\u8f6f\u5220\u9664\uff08\u7269\u7406\u5220\u9664\uff09\nsessionService, err := mysql.NewService(\n    mysql.WithMySQLClientDSN(\"user:password@tcp(localhost:3306)/db?charset=utf8mb4&amp;parseTime=True&amp;loc=Local\"),\n    mysql.WithSoftDelete(false),\n)\n</code></pre> <p>\u5220\u9664\u884c\u4e3a\u5bf9\u6bd4\uff1a</p> \u914d\u7f6e \u5220\u9664\u64cd\u4f5c \u67e5\u8be2\u884c\u4e3a \u6570\u636e\u6062\u590d <code>softDelete=true</code> <code>UPDATE SET deleted_at = NOW()</code> \u67e5\u8be2\u9644\u5e26 <code>WHERE deleted_at IS NULL</code>\uff0c\u4ec5\u8fd4\u56de\u672a\u8f6f\u5220\u9664\u6570\u636e \u53ef\u6062\u590d <code>softDelete=false</code> <code>DELETE FROM ...</code> \u67e5\u8be2\u6240\u6709\u8bb0\u5f55 \u4e0d\u53ef\u6062\u590d <p>TTL \u81ea\u52a8\u6e05\u7406\uff1a</p> <pre><code>sessionService, err := mysql.NewService(\n    mysql.WithMySQLClientDSN(\"user:password@tcp(localhost:3306)/db?charset=utf8mb4&amp;parseTime=True&amp;loc=Local\"),\n    mysql.WithSessionTTL(30*time.Minute),      // \u4f1a\u8bdd 30 \u5206\u949f\u540e\u8fc7\u671f\n    mysql.WithAppStateTTL(24*time.Hour),       // \u5e94\u7528\u72b6\u6001 24 \u5c0f\u65f6\u540e\u8fc7\u671f\n    mysql.WithUserStateTTL(7*24*time.Hour),    // \u7528\u6237\u72b6\u6001 7 \u5929\u540e\u8fc7\u671f\n    mysql.WithCleanupInterval(10*time.Minute), // \u6bcf 10 \u5206\u949f\u6e05\u7406\u4e00\u6b21\n    mysql.WithSoftDelete(true),                // \u8f6f\u5220\u9664\u6a21\u5f0f\n)\n// \u6e05\u7406\u884c\u4e3a\uff1a\n// - softDelete=true\uff1a\u8fc7\u671f\u6570\u636e\u6807\u8bb0\u4e3a deleted_at = NOW()\n// - softDelete=false\uff1a\u8fc7\u671f\u6570\u636e\u88ab\u7269\u7406\u5220\u9664\n// - \u67e5\u8be2\u65f6\u59cb\u7ec8\u9644\u52a0 `WHERE deleted_at IS NULL`\uff0c\u4ec5\u8fd4\u56de\u672a\u8f6f\u5220\u9664\u6570\u636e\n</code></pre>"},{"location":"zh/session/#_25","title":"\u914d\u5408\u6458\u8981\u4f7f\u7528","text":"<pre><code>sessionService, err := mysql.NewService(\n    mysql.WithMySQLClientDSN(\"user:password@tcp(localhost:3306)/db?charset=utf8mb4&amp;parseTime=True&amp;loc=Local\"),\n    mysql.WithSessionEventLimit(1000),\n    mysql.WithSessionTTL(30*time.Minute),\n\n    // \u6458\u8981\u914d\u7f6e\n    mysql.WithSummarizer(summarizer),\n    mysql.WithAsyncSummaryNum(2),\n    mysql.WithSummaryQueueSize(100),\n)\n</code></pre>"},{"location":"zh/session/#_26","title":"\u5b58\u50a8\u7ed3\u6784","text":"<p>MySQL \u4f7f\u7528\u5173\u7cfb\u578b\u8868\u7ed3\u6784\uff0cJSON \u6570\u636e\u4f7f\u7528 JSON \u7c7b\u578b\u5b58\u50a8\uff1a</p> <pre><code>-- \u4f1a\u8bdd\u72b6\u6001\u8868\nCREATE TABLE session_states (\n    id BIGINT AUTO_INCREMENT PRIMARY KEY,\n    app_name VARCHAR(255) NOT NULL,\n    user_id VARCHAR(255) NOT NULL,\n    session_id VARCHAR(255) NOT NULL,\n    state JSON,\n    created_at TIMESTAMP(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),\n    updated_at TIMESTAMP(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6),\n    expires_at TIMESTAMP(6) NULL,\n    deleted_at TIMESTAMP(6) NULL,\n    UNIQUE KEY idx_session_states_unique (app_name, user_id, session_id, deleted_at)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n\n-- \u4f1a\u8bdd\u4e8b\u4ef6\u8868\nCREATE TABLE session_events (\n    id BIGINT AUTO_INCREMENT PRIMARY KEY,\n    app_name VARCHAR(255) NOT NULL,\n    user_id VARCHAR(255) NOT NULL,\n    session_id VARCHAR(255) NOT NULL,\n    event JSON NOT NULL,\n    created_at TIMESTAMP(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),\n    updated_at TIMESTAMP(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6),\n    expires_at TIMESTAMP(6) NULL,\n    deleted_at TIMESTAMP(6) NULL,\n    KEY idx_session_events (app_name, user_id, session_id, deleted_at, created_at)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n\n-- \u4f1a\u8bdd Track \u4e8b\u4ef6\u8868\uff08\u6309 track \u7ef4\u5ea6\u8bb0\u5f55\u4e8b\u4ef6\uff09\nCREATE TABLE session_track_events (\n    id BIGINT AUTO_INCREMENT PRIMARY KEY,\n    app_name VARCHAR(255) NOT NULL,\n    user_id VARCHAR(255) NOT NULL,\n    session_id VARCHAR(255) NOT NULL,\n    track VARCHAR(255) NOT NULL,\n    event JSON NOT NULL,\n    created_at TIMESTAMP(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),\n    updated_at TIMESTAMP(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6),\n    expires_at TIMESTAMP(6) NULL,\n    deleted_at TIMESTAMP(6) NULL,\n    KEY idx_session_track_events (app_name, user_id, session_id, track, deleted_at, created_at)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n\n-- \u4f1a\u8bdd\u6458\u8981\u8868\nCREATE TABLE session_summaries (\n    id BIGINT AUTO_INCREMENT PRIMARY KEY,\n    app_name VARCHAR(255) NOT NULL,\n    user_id VARCHAR(255) NOT NULL,\n    session_id VARCHAR(255) NOT NULL,\n    filter_key VARCHAR(255) NOT NULL,\n    summary JSON NOT NULL,\n    updated_at TIMESTAMP(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6),\n    expires_at TIMESTAMP(6) NULL,\n    deleted_at TIMESTAMP(6) NULL,\n    UNIQUE KEY idx_session_summaries_unique (app_name, user_id, session_id, filter_key, deleted_at)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n\n-- \u5e94\u7528\u72b6\u6001\u8868\nCREATE TABLE app_states (\n    id BIGINT AUTO_INCREMENT PRIMARY KEY,\n    app_name VARCHAR(255) NOT NULL,\n    `key` VARCHAR(255) NOT NULL,\n    value TEXT DEFAULT NULL,\n    created_at TIMESTAMP(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),\n    updated_at TIMESTAMP(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6),\n    expires_at TIMESTAMP(6) NULL,\n    deleted_at TIMESTAMP(6) NULL,\n    UNIQUE KEY idx_app_states_unique (app_name, `key`, deleted_at)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n\n-- \u7528\u6237\u72b6\u6001\u8868\nCREATE TABLE user_states (\n    id BIGINT AUTO_INCREMENT PRIMARY KEY,\n    app_name VARCHAR(255) NOT NULL,\n    user_id VARCHAR(255) NOT NULL,\n    `key` VARCHAR(255) NOT NULL,\n    value TEXT DEFAULT NULL,\n    created_at TIMESTAMP(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),\n    updated_at TIMESTAMP(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6),\n    expires_at TIMESTAMP(6) NULL,\n    deleted_at TIMESTAMP(6) NULL,\n    UNIQUE KEY idx_user_states_unique (app_name, user_id, `key`, deleted_at)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n</code></pre> <p>MySQL \u4e0e PostgreSQL \u7684\u5173\u952e\u5dee\u5f02\uff1a</p> <ul> <li>MySQL \u4e0d\u652f\u6301 <code>WHERE deleted_at IS NULL</code> \u7684 partial index\uff0c\u9700\u8981\u5c06 <code>deleted_at</code> \u5305\u542b\u5728\u552f\u4e00\u7d22\u5f15\u4e2d</li> <li>MySQL \u4f7f\u7528 <code>JSON</code> \u7c7b\u578b\u800c\u975e <code>JSONB</code>\uff08\u529f\u80fd\u7c7b\u4f3c\uff0c\u4f46\u5b58\u50a8\u683c\u5f0f\u4e0d\u540c\uff09</li> <li>MySQL \u4f7f\u7528 <code>ON DUPLICATE KEY UPDATE</code> \u8bed\u6cd5\u5b9e\u73b0 UPSERT</li> </ul>"},{"location":"zh/session/#_27","title":"\u9ad8\u7ea7\u7528\u6cd5","text":""},{"location":"zh/session/#hook-appendget","title":"Hook \u80fd\u529b\uff08Append/Get\uff09","text":"<ul> <li>AppendEventHook\uff1a\u4e8b\u4ef6\u5199\u5165\u524d\u7684\u62e6\u622a/\u4fee\u6539/\u7ec8\u6b62\u3002\u53ef\u7528\u4e8e\u5185\u5bb9\u5b89\u5168\u3001\u5ba1\u8ba1\u6253\u6807\uff08\u5982\u5199\u5165 <code>violation=&lt;word&gt;</code>\uff09\uff0c\u6216\u76f4\u63a5\u963b\u65ad\u5b58\u50a8\u3002\u5173\u4e8e filterKey \u7684\u8d4b\u503c\u8bf7\u89c1\u4e0b\u6587\u201c\u4f1a\u8bdd\u6458\u8981 / FilterKey \u4e0e AppendEventHook\u201d\u3002</li> <li>GetSessionHook\uff1a\u4f1a\u8bdd\u8bfb\u53d6\u540e\u7684\u62e6\u622a/\u4fee\u6539/\u8fc7\u6ee4\u3002\u53ef\u7528\u6765\u5254\u9664\u5e26\u7279\u5b9a\u6807\u7b7e\u7684\u4e8b\u4ef6\uff0c\u6216\u52a8\u6001\u8865\u5145\u8fd4\u56de\u7684 Session \u72b6\u6001\u3002</li> <li>\u8d23\u4efb\u94fe\u6267\u884c\uff1aHook \u901a\u8fc7 <code>next()</code> \u5f62\u6210\u94fe\u5f0f\u8c03\u7528\uff0c\u53ef\u63d0\u524d\u8fd4\u56de\u4ee5\u77ed\u8def\u540e\u7eed\u903b\u8f91\uff0c\u9519\u8bef\u4f1a\u5411\u4e0a\u4f20\u9012\u3002</li> <li>\u8de8\u540e\u7aef\u4e00\u81f4\uff1a\u5185\u5b58\u3001Redis\u3001MySQL\u3001PostgreSQL \u5b9e\u73b0\u5df2\u7edf\u4e00\u63a5\u5165 Hook\uff0c\u6784\u9020\u670d\u52a1\u65f6\u6ce8\u5165 Hook \u5207\u7247\u5373\u53ef\u3002</li> <li>\u793a\u4f8b\uff1a\u89c1 <code>examples/session/hook</code>\uff08\u4ee3\u7801\uff09</li> </ul>"},{"location":"zh/session/#session-service-api","title":"\u76f4\u63a5\u4f7f\u7528 Session Service API","text":"<p>\u5728\u5927\u591a\u6570\u60c5\u51b5\u4e0b\uff0c\u60a8\u5e94\u8be5\u901a\u8fc7 Runner \u4f7f\u7528\u4f1a\u8bdd\u7ba1\u7406\uff0cRunner \u4f1a\u81ea\u52a8\u5904\u7406\u6240\u6709\u7ec6\u8282\u3002\u4f46\u5728\u67d0\u4e9b\u7279\u6b8a\u573a\u666f\u4e0b\uff08\u5982\u4f1a\u8bdd\u7ba1\u7406\u540e\u53f0\u3001\u6570\u636e\u8fc1\u79fb\u3001\u7edf\u8ba1\u5206\u6790\u7b49\uff09\uff0c\u60a8\u53ef\u80fd\u9700\u8981\u76f4\u63a5\u64cd\u4f5c Session Service\u3002</p> <p>\u6ce8\u610f\uff1a \u4ee5\u4e0b API \u4ec5\u7528\u4e8e\u7279\u6b8a\u573a\u666f\uff0c\u65e5\u5e38\u4f7f\u7528 Runner \u5373\u53ef\u3002</p>"},{"location":"zh/session/#_28","title":"\u67e5\u8be2\u4f1a\u8bdd\u5217\u8868","text":"<pre><code>// \u5217\u51fa\u67d0\u4e2a\u7528\u6237\u7684\u6240\u6709\u4f1a\u8bdd\nsessions, err := sessionService.ListSessions(ctx, session.UserKey{\n    AppName: \"my-agent\",\n    UserID:  \"user123\",\n})\n\nfor _, sess := range sessions {\n    fmt.Printf(\"SessionID: %s, Events: %d\\n\", sess.ID, len(sess.Events))\n}\n</code></pre>"},{"location":"zh/session/#_29","title":"\u624b\u52a8\u5220\u9664\u4f1a\u8bdd","text":"<pre><code>// \u5220\u9664\u6307\u5b9a\u4f1a\u8bdd\nerr := sessionService.DeleteSession(ctx, session.Key{\n    AppName:   \"my-agent\",\n    UserID:    \"user123\",\n    SessionID: \"session-id-123\",\n})\n</code></pre>"},{"location":"zh/session/#_30","title":"\u624b\u52a8\u83b7\u53d6\u4f1a\u8bdd\u8be6\u60c5","text":"<pre><code>// \u83b7\u53d6\u5b8c\u6574\u4f1a\u8bdd\nsess, err := sessionService.GetSession(ctx, session.Key{\n    AppName:   \"my-agent\",\n    UserID:    \"user123\",\n    SessionID: \"session-id-123\",\n})\n\n// \u83b7\u53d6\u6700\u8fd1 10 \u4e2a\u4e8b\u4ef6\u7684\u4f1a\u8bdd\nsess, err := sessionService.GetSession(ctx, key,\n    session.WithEventNum(10))\n\n// \u83b7\u53d6\u6307\u5b9a\u65f6\u95f4\u540e\u7684\u4e8b\u4ef6\nsess, err := sessionService.GetSession(ctx, key,\n    session.WithEventTime(time.Now().Add(-1*time.Hour)))\n</code></pre>"},{"location":"zh/session/#_31","title":"\u4f1a\u8bdd\u6458\u8981","text":""},{"location":"zh/session/#_32","title":"\u6982\u8ff0","text":"<p>\u968f\u7740\u5bf9\u8bdd\u7684\u6301\u7eed\u589e\u957f\uff0c\u7ef4\u62a4\u5b8c\u6574\u7684\u4e8b\u4ef6\u5386\u53f2\u53ef\u80fd\u4f1a\u5360\u7528\u5927\u91cf\u5185\u5b58\uff0c\u5e76\u53ef\u80fd\u8d85\u51fa LLM \u7684\u4e0a\u4e0b\u6587\u7a97\u53e3\u9650\u5236\u3002\u4f1a\u8bdd\u6458\u8981\u529f\u80fd\u4f7f\u7528 LLM \u81ea\u52a8\u5c06\u5386\u53f2\u5bf9\u8bdd\u538b\u7f29\u4e3a\u7b80\u6d01\u7684\u6458\u8981\uff0c\u5728\u4fdd\u7559\u91cd\u8981\u4e0a\u4e0b\u6587\u7684\u540c\u65f6\u663e\u8457\u964d\u4f4e\u5185\u5b58\u5360\u7528\u548c token \u6d88\u8017\u3002</p> <p>\u6838\u5fc3\u7279\u6027\uff1a</p> <ul> <li>\u81ea\u52a8\u89e6\u53d1\uff1a\u6839\u636e\u4e8b\u4ef6\u6570\u91cf\u3001token \u6570\u91cf\u6216\u65f6\u95f4\u9608\u503c\u81ea\u52a8\u751f\u6210\u6458\u8981</li> <li>\u589e\u91cf\u5904\u7406\uff1a\u53ea\u5904\u7406\u81ea\u4e0a\u6b21\u6458\u8981\u4ee5\u6765\u7684\u65b0\u4e8b\u4ef6\uff0c\u907f\u514d\u91cd\u590d\u8ba1\u7b97</li> <li>LLM \u9a71\u52a8\uff1a\u4f7f\u7528\u4efb\u4f55\u914d\u7f6e\u7684 LLM \u6a21\u578b\u751f\u6210\u9ad8\u8d28\u91cf\u3001\u4e0a\u4e0b\u6587\u611f\u77e5\u7684\u6458\u8981</li> <li>\u975e\u7834\u574f\u6027\uff1a\u539f\u59cb\u4e8b\u4ef6\u5b8c\u6574\u4fdd\u7559\uff0c\u6458\u8981\u5355\u72ec\u5b58\u50a8</li> <li>\u5f02\u6b65\u5904\u7406\uff1a\u540e\u53f0\u5f02\u6b65\u6267\u884c\uff0c\u4e0d\u963b\u585e\u5bf9\u8bdd\u6d41\u7a0b</li> <li>\u7075\u6d3b\u914d\u7f6e\uff1a\u652f\u6301\u81ea\u5b9a\u4e49\u89e6\u53d1\u6761\u4ef6\u3001\u63d0\u793a\u8bcd\u548c\u5b57\u6570\u9650\u5236</li> </ul>"},{"location":"zh/session/#_33","title":"\u57fa\u7840\u914d\u7f6e","text":""},{"location":"zh/session/#1_1","title":"\u6b65\u9aa4 1\uff1a\u521b\u5efa\u6458\u8981\u5668","text":"<p>\u4f7f\u7528 LLM \u6a21\u578b\u521b\u5efa\u6458\u8981\u5668\u5e76\u914d\u7f6e\u89e6\u53d1\u6761\u4ef6\uff1a</p> <pre><code>import (\n    \"time\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/session/summary\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/openai\"\n)\n\n// \u521b\u5efa\u7528\u4e8e\u6458\u8981\u7684 LLM \u6a21\u578b\nsummaryModel := openai.New(\"gpt-4\", openai.WithAPIKey(\"your-api-key\"))\n\n// \u521b\u5efa\u6458\u8981\u5668\u5e76\u914d\u7f6e\u89e6\u53d1\u6761\u4ef6\nsummarizer := summary.NewSummarizer(\n    summaryModel,\n    summary.WithChecksAny(                     // \u4efb\u4e00\u6761\u4ef6\u6ee1\u8db3\u5373\u89e6\u53d1\n        summary.CheckEventThreshold(20),       // \u81ea\u4e0a\u6b21\u6458\u8981\u540e\u65b0\u589e 20 \u4e2a\u4e8b\u4ef6\u540e\u89e6\u53d1\n        summary.CheckTokenThreshold(4000),     // \u81ea\u4e0a\u6b21\u6458\u8981\u540e\u65b0\u589e 4000 \u4e2a token \u540e\u89e6\u53d1\n        summary.CheckTimeThreshold(5*time.Minute), // 5 \u5206\u949f\u65e0\u6d3b\u52a8\u540e\u89e6\u53d1\n    ),\n    summary.WithMaxSummaryWords(200),          // \u9650\u5236\u6458\u8981\u5728 200 \u5b57\u4ee5\u5185\n)\n</code></pre>"},{"location":"zh/session/#2","title":"\u6b65\u9aa4 2\uff1a\u914d\u7f6e\u4f1a\u8bdd\u670d\u52a1","text":"<p>\u5c06\u6458\u8981\u5668\u96c6\u6210\u5230\u4f1a\u8bdd\u670d\u52a1\uff08\u5185\u5b58\u6216 Redis\uff09\uff1a</p> <pre><code>import (\n    \"time\"\n    \"trpc.group/trpc-go/trpc-agent-go/session/inmemory\"\n    \"trpc.group/trpc-go/trpc-agent-go/session/redis\"\n)\n\n// \u5185\u5b58\u5b58\u50a8\uff08\u5f00\u53d1/\u6d4b\u8bd5\uff09\nsessionService := inmemory.NewSessionService(\n    inmemory.WithSummarizer(summarizer),\n    inmemory.WithAsyncSummaryNum(2),                // 2 \u4e2a\u5f02\u6b65 worker\n    inmemory.WithSummaryQueueSize(100),             // \u961f\u5217\u5927\u5c0f 100\n    inmemory.WithSummaryJobTimeout(30*time.Second), // \u5355\u4e2a\u4efb\u52a1\u8d85\u65f6 30 \u79d2\n)\n\n// Redis \u5b58\u50a8\uff08\u751f\u4ea7\u73af\u5883\uff09\nsessionService, err := redis.NewService(\n    redis.WithRedisClientURL(\"redis://localhost:6379\"),\n    redis.WithSummarizer(summarizer),\n    redis.WithAsyncSummaryNum(4),           // 4 \u4e2a\u5f02\u6b65 worker\n    redis.WithSummaryQueueSize(200),        // \u961f\u5217\u5927\u5c0f 200\n)\n\n// PostgreSQL \u5b58\u50a8\nsessionService, err := postgres.NewService(\n    postgres.WithHost(\"localhost\"),\n    postgres.WithPassword(\"your-password\"),\n    postgres.WithSummarizer(summarizer),\n    postgres.WithAsyncSummaryNum(2),       // 2 \u4e2a\u5f02\u6b65 worker\n    postgres.WithSummaryQueueSize(100),    // \u961f\u5217\u5927\u5c0f 100\n)\n\n// MySQL \u5b58\u50a8\nsessionService, err := mysql.NewService(\n    mysql.WithMySQLClientDSN(\"user:password@tcp(localhost:3306)/db?charset=utf8mb4&amp;parseTime=True&amp;loc=Local\"),\n    mysql.WithSummarizer(summarizer),\n    mysql.WithAsyncSummaryNum(2),           // 2\u4e2a\u5f02\u6b65 worker\n    mysql.WithSummaryQueueSize(100),        // \u961f\u5217\u5927\u5c0f 100\n)\n</code></pre>"},{"location":"zh/session/#3-agent-runner","title":"\u6b65\u9aa4 3\uff1a\u914d\u7f6e Agent \u548c Runner","text":"<p>\u521b\u5efa Agent \u5e76\u914d\u7f6e\u6458\u8981\u6ce8\u5165\u884c\u4e3a\uff1a</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/agent/llmagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/runner\"\n)\n\n// \u521b\u5efa Agent\uff08\u914d\u7f6e\u6458\u8981\u6ce8\u5165\u884c\u4e3a\uff09\nllmAgent := llmagent.New(\n    \"my-agent\",\n    llmagent.WithModel(summaryModel),\n    llmagent.WithAddSessionSummary(true),   // \u542f\u7528\u6458\u8981\u6ce8\u5165\n    llmagent.WithMaxHistoryRuns(10),        // \u5f53AddSessionSummary=false\u65f6\u9650\u5236\u5386\u53f2\u8f6e\u6b21\n)\n\n// \u521b\u5efa Runner\nr := runner.NewRunner(\n    \"my-agent\",\n    llmAgent,\n    runner.WithSessionService(sessionService),\n)\n\n// \u8fd0\u884c\u5bf9\u8bdd - \u6458\u8981\u5c06\u81ea\u52a8\u7ba1\u7406\neventChan, err := r.Run(ctx, userID, sessionID, userMessage)\n</code></pre> <p>\u5b8c\u6210\u4ee5\u4e0a\u914d\u7f6e\u540e\uff0c\u6458\u8981\u529f\u80fd\u5373\u53ef\u81ea\u52a8\u8fd0\u884c\u3002</p>"},{"location":"zh/session/#_34","title":"\u6458\u8981\u89e6\u53d1\u673a\u5236","text":""},{"location":"zh/session/#_35","title":"\u81ea\u52a8\u89e6\u53d1\uff08\u63a8\u8350\uff09","text":"<p>Runner \u81ea\u52a8\u89e6\u53d1\uff1a \u5728\u6bcf\u6b21\u5bf9\u8bdd\u5b8c\u6210\u540e\uff0cRunner \u4f1a\u81ea\u52a8\u68c0\u67e5\u89e6\u53d1\u6761\u4ef6\uff0c\u6ee1\u8db3\u6761\u4ef6\u65f6\u5728\u540e\u53f0\u5f02\u6b65\u751f\u6210\u6458\u8981\uff0c\u65e0\u9700\u624b\u52a8\u5e72\u9884\u3002</p> <p>\u89e6\u53d1\u65f6\u673a\uff1a</p> <ul> <li>\u4e8b\u4ef6\u6570\u91cf\u8d85\u8fc7\u9608\u503c\uff08<code>WithEventThreshold</code>\uff09</li> <li>Token \u6570\u91cf\u8d85\u8fc7\u9608\u503c\uff08<code>WithTokenThreshold</code>\uff09</li> <li>\u8ddd\u4e0a\u6b21\u4e8b\u4ef6\u8d85\u8fc7\u6307\u5b9a\u65f6\u95f4\uff08<code>WithTimeThreshold</code>\uff09</li> <li>\u6ee1\u8db3\u81ea\u5b9a\u4e49\u7ec4\u5408\u6761\u4ef6\uff08<code>WithChecksAny</code> / <code>WithChecksAll</code>\uff09</li> </ul>"},{"location":"zh/session/#_36","title":"\u624b\u52a8\u89e6\u53d1","text":"<p>\u67d0\u4e9b\u573a\u666f\u4e0b\uff0c\u4f60\u53ef\u80fd\u9700\u8981\u624b\u52a8\u89e6\u53d1\u6458\u8981\uff1a</p> <pre><code>// \u5f02\u6b65\u6458\u8981\uff08\u63a8\u8350\uff09- \u540e\u53f0\u5904\u7406\uff0c\u4e0d\u963b\u585e\nerr := sessionService.EnqueueSummaryJob(\n    ctx,\n    sess,\n    session.SummaryFilterKeyAllContents, // \u5bf9\u5b8c\u6574\u4f1a\u8bdd\u751f\u6210\u6458\u8981\n    false,                               // force=false\uff0c\u9075\u5b88\u89e6\u53d1\u6761\u4ef6\n)\n\n// \u540c\u6b65\u6458\u8981 - \u7acb\u5373\u5904\u7406\uff0c\u4f1a\u963b\u585e\u5f53\u524d\u64cd\u4f5c\nerr := sessionService.CreateSessionSummary(\n    ctx,\n    sess,\n    session.SummaryFilterKeyAllContents,\n    false, // force=false\uff0c\u9075\u5b88\u89e6\u53d1\u6761\u4ef6\n)\n\n// \u5f02\u6b65\u5f3a\u5236\u6458\u8981 - \u5ffd\u7565\u89e6\u53d1\u6761\u4ef6\uff0c\u5f3a\u5236\u751f\u6210\nerr := sessionService.EnqueueSummaryJob(\n    ctx,\n    sess,\n    session.SummaryFilterKeyAllContents,\n    true, // force=true\uff0c\u7ed5\u8fc7\u6240\u6709\u89e6\u53d1\u6761\u4ef6\u68c0\u67e5\n)\n\n// \u540c\u6b65\u5f3a\u5236\u6458\u8981 - \u7acb\u5373\u5f3a\u5236\u751f\u6210\nerr := sessionService.CreateSessionSummary(\n    ctx,\n    sess,\n    session.SummaryFilterKeyAllContents,\n    true, // force=true\uff0c\u7ed5\u8fc7\u6240\u6709\u89e6\u53d1\u6761\u4ef6\u68c0\u67e5\n)\n</code></pre> <p>API \u8bf4\u660e\uff1a</p> <ul> <li> <p><code>EnqueueSummaryJob</code>\uff1a\u5f02\u6b65\u6458\u8981\uff08\u63a8\u8350\uff09</p> <ul> <li>\u540e\u53f0\u5904\u7406\uff0c\u4e0d\u963b\u585e\u5f53\u524d\u64cd\u4f5c</li> <li>\u5931\u8d25\u65f6\u81ea\u52a8\u56de\u9000\u5230\u540c\u6b65\u5904\u7406</li> <li>\u9002\u5408\u751f\u4ea7\u73af\u5883</li> </ul> </li> </ul> <ul> <li><code>CreateSessionSummary</code>\uff1a\u540c\u6b65\u6458\u8981<ul> <li>\u7acb\u5373\u5904\u7406\uff0c\u4f1a\u963b\u585e\u5f53\u524d\u64cd\u4f5c</li> <li>\u76f4\u63a5\u8fd4\u56de\u5904\u7406\u7ed3\u679c</li> <li>\u9002\u5408\u8c03\u8bd5\u6216\u9700\u8981\u7acb\u5373\u83b7\u53d6\u7ed3\u679c\u7684\u573a\u666f</li> </ul> </li> </ul> <p>\u53c2\u6570\u8bf4\u660e\uff1a</p> <ul> <li>filterKey\uff1a<code>session.SummaryFilterKeyAllContents</code> \u8868\u793a\u5bf9\u5b8c\u6574\u4f1a\u8bdd\u751f\u6210\u6458\u8981</li> <li>force \u53c2\u6570\uff1a<ul> <li><code>false</code>\uff1a\u9075\u5b88\u914d\u7f6e\u7684\u89e6\u53d1\u6761\u4ef6\uff08\u4e8b\u4ef6\u6570\u3001token \u6570\u3001\u65f6\u95f4\u9608\u503c\u7b49\uff09\uff0c\u53ea\u6709\u6ee1\u8db3\u6761\u4ef6\u624d\u751f\u6210\u6458\u8981</li> <li><code>true</code>\uff1a\u5f3a\u5236\u751f\u6210\u6458\u8981\uff0c\u5b8c\u5168\u5ffd\u7565\u6240\u6709\u89e6\u53d1\u6761\u4ef6\u68c0\u67e5\uff0c\u65e0\u8bba\u4f1a\u8bdd\u72b6\u6001\u5982\u4f55\u90fd\u4f1a\u6267\u884c</li> </ul> </li> </ul> <p>\u4f7f\u7528\u573a\u666f\uff1a</p> \u573a\u666f API force \u8bf4\u660e \u6b63\u5e38\u81ea\u52a8\u6458\u8981 \u7531 Runner \u81ea\u52a8\u8c03\u7528 <code>false</code> \u6ee1\u8db3\u89e6\u53d1\u6761\u4ef6\u65f6\u81ea\u52a8\u751f\u6210 \u4f1a\u8bdd\u7ed3\u675f <code>EnqueueSummaryJob</code> <code>true</code> \u5f3a\u5236\u751f\u6210\u6700\u7ec8\u5b8c\u6574\u6458\u8981 \u7528\u6237\u8bf7\u6c42\u67e5\u770b <code>CreateSessionSummary</code> <code>true</code> \u7acb\u5373\u751f\u6210\u5e76\u8fd4\u56de \u5b9a\u65f6\u6279\u91cf\u5904\u7406 <code>EnqueueSummaryJob</code> <code>false</code> \u6279\u91cf\u68c0\u67e5\u5e76\u5904\u7406\u7b26\u5408\u6761\u4ef6\u7684\u4f1a\u8bdd \u8c03\u8bd5\u6d4b\u8bd5 <code>CreateSessionSummary</code> <code>true</code> \u7acb\u5373\u6267\u884c\uff0c\u65b9\u4fbf\u9a8c\u8bc1"},{"location":"zh/session/#_37","title":"\u4e0a\u4e0b\u6587\u6ce8\u5165\u673a\u5236","text":"<p>\u6846\u67b6\u63d0\u4f9b\u4e24\u79cd\u6a21\u5f0f\u6765\u7ba1\u7406\u53d1\u9001\u7ed9 LLM \u7684\u5bf9\u8bdd\u4e0a\u4e0b\u6587\uff1a</p>"},{"location":"zh/session/#1_2","title":"\u6a21\u5f0f 1\uff1a\u542f\u7528\u6458\u8981\u6ce8\u5165\uff08\u63a8\u8350\uff09","text":"<pre><code>llmagent.WithAddSessionSummary(true)\n</code></pre> <p>\u5de5\u4f5c\u65b9\u5f0f\uff1a</p> <ul> <li>\u4f1a\u8bdd\u6458\u8981\u4f5c\u4e3a\u72ec\u7acb\u7684\u7cfb\u7edf\u6d88\u606f\u63d2\u5165\u5230\u7b2c\u4e00\u4e2a\u73b0\u6709\u7cfb\u7edf\u6d88\u606f\u4e4b\u540e\uff08\u5982\u679c\u6ca1\u6709\u7cfb\u7edf\u6d88\u606f\u5219\u524d\u7f6e\u6dfb\u52a0\uff09</li> <li>\u5305\u542b\u6458\u8981\u65f6\u95f4\u70b9\u4e4b\u540e\u7684\u6240\u6709\u589e\u91cf\u4e8b\u4ef6\uff08\u4e0d\u622a\u65ad\uff09</li> <li>\u4fdd\u8bc1\u5b8c\u6574\u4e0a\u4e0b\u6587\uff1a\u6d53\u7f29\u5386\u53f2 + \u5b8c\u6574\u65b0\u5bf9\u8bdd</li> <li><code>WithMaxHistoryRuns</code> \u53c2\u6570\u88ab\u5ffd\u7565</li> </ul> <p>\u4e0a\u4e0b\u6587\u7ed3\u6784\uff1a</p> <pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 System Prompt                           \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Session Summary (system message)        \u2502 \u2190 Compressed history\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Event 1 (after summary)                 \u2502 \u2510\n\u2502 Event 2                                 \u2502 \u2502\n\u2502 Event 3                                 \u2502 \u2502 New events after summary\n\u2502 ...                                     \u2502 \u2502 (fully retained)\n\u2502 Event N (current message)               \u2502 \u2518\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre> <p>\u9002\u7528\u573a\u666f\uff1a \u957f\u671f\u8fd0\u884c\u7684\u4f1a\u8bdd\uff0c\u9700\u8981\u4fdd\u6301\u5b8c\u6574\u5386\u53f2\u4e0a\u4e0b\u6587\u540c\u65f6\u63a7\u5236 token \u6d88\u8017\u3002</p>"},{"location":"zh/session/#2_1","title":"\u6a21\u5f0f 2\uff1a\u4e0d\u4f7f\u7528\u6458\u8981","text":"<pre><code>llmagent.WithAddSessionSummary(false)\nllmagent.WithMaxHistoryRuns(10)  // \u9650\u5236\u5386\u53f2\u8f6e\u6b21\n</code></pre> <p>\u5de5\u4f5c\u65b9\u5f0f\uff1a</p> <ul> <li>\u4e0d\u6dfb\u52a0\u6458\u8981\u6d88\u606f</li> <li>\u53ea\u5305\u542b\u6700\u8fd1 <code>MaxHistoryRuns</code> \u8f6e\u5bf9\u8bdd</li> <li><code>MaxHistoryRuns=0</code> \u65f6\u4e0d\u9650\u5236\uff0c\u5305\u542b\u6240\u6709\u5386\u53f2</li> </ul> <p>\u4e0a\u4e0b\u6587\u7ed3\u6784\uff1a</p> <pre><code>\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 System Prompt                           \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502 Event N-k+1                             \u2502 \u2510\n\u2502 Event N-k+2                             \u2502 \u2502 Last k runs\n\u2502 ...                                     \u2502 \u2502 (MaxHistoryRuns=k)\n\u2502 Event N (current message)               \u2502 \u2518\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n</code></pre> <p>\u9002\u7528\u573a\u666f\uff1a \u77ed\u4f1a\u8bdd\u3001\u6d4b\u8bd5\u73af\u5883\uff0c\u6216\u9700\u8981\u7cbe\u786e\u63a7\u5236\u4e0a\u4e0b\u6587\u7a97\u53e3\u5927\u5c0f\u3002</p>"},{"location":"zh/session/#_38","title":"\u6a21\u5f0f\u9009\u62e9\u5efa\u8bae","text":"\u573a\u666f \u63a8\u8350\u914d\u7f6e \u8bf4\u660e \u957f\u671f\u4f1a\u8bdd\uff08\u5ba2\u670d\u3001\u52a9\u624b\uff09 <code>AddSessionSummary=true</code> \u4fdd\u6301\u5b8c\u6574\u4e0a\u4e0b\u6587\uff0c\u4f18\u5316 token \u77ed\u671f\u4f1a\u8bdd\uff08\u5355\u6b21\u54a8\u8be2\uff09 <code>AddSessionSummary=false</code><code>MaxHistoryRuns=10</code> \u7b80\u5355\u76f4\u63a5\uff0c\u65e0\u9700\u6458\u8981\u5f00\u9500 \u8c03\u8bd5\u6d4b\u8bd5 <code>AddSessionSummary=false</code><code>MaxHistoryRuns=5</code> \u5feb\u901f\u9a8c\u8bc1\uff0c\u51cf\u5c11\u5e72\u6270 \u9ad8\u5e76\u53d1\u573a\u666f <code>AddSessionSummary=true</code>\u589e\u52a0 worker \u6570\u91cf \u5f02\u6b65\u5904\u7406\uff0c\u4e0d\u5f71\u54cd\u54cd\u5e94\u901f\u5ea6"},{"location":"zh/session/#_39","title":"\u9ad8\u7ea7\u914d\u7f6e","text":""},{"location":"zh/session/#_40","title":"\u6458\u8981\u5668\u9009\u9879","text":"<p>\u4f7f\u7528\u4ee5\u4e0b\u9009\u9879\u914d\u7f6e\u6458\u8981\u5668\u884c\u4e3a\uff1a</p> <p>\u89e6\u53d1\u6761\u4ef6\uff1a</p> <ul> <li><code>WithEventThreshold(eventCount int)</code>\uff1a\u5f53\u81ea\u4e0a\u6b21\u6458\u8981\u540e\u7684\u4e8b\u4ef6\u6570\u91cf\u8d85\u8fc7\u9608\u503c\u65f6\u89e6\u53d1\u6458\u8981\u3002\u793a\u4f8b\uff1a<code>WithEventThreshold(20)</code> \u5728\u81ea\u4e0a\u6b21\u6458\u8981\u540e\u65b0\u589e 20 \u4e2a\u4e8b\u4ef6\u540e\u89e6\u53d1\u3002</li> <li><code>WithTokenThreshold(tokenCount int)</code>\uff1a\u5f53\u81ea\u4e0a\u6b21\u6458\u8981\u540e\u7684 token \u6570\u91cf\u8d85\u8fc7\u9608\u503c\u65f6\u89e6\u53d1\u6458\u8981\u3002\u793a\u4f8b\uff1a<code>WithTokenThreshold(4000)</code> \u5728\u81ea\u4e0a\u6b21\u6458\u8981\u540e\u65b0\u589e 4000 \u4e2a token \u540e\u89e6\u53d1\u3002</li> <li><code>WithTimeThreshold(interval time.Duration)</code>\uff1a\u5f53\u81ea\u4e0a\u6b21\u4e8b\u4ef6\u540e\u7ecf\u8fc7\u7684\u65f6\u95f4\u8d85\u8fc7\u95f4\u9694\u65f6\u89e6\u53d1\u6458\u8981\u3002\u793a\u4f8b\uff1a<code>WithTimeThreshold(5*time.Minute)</code> \u5728 5 \u5206\u949f\u65e0\u6d3b\u52a8\u540e\u89e6\u53d1\u3002</li> </ul> <p>\u7ec4\u5408\u6761\u4ef6\uff1a</p> <ul> <li><code>WithChecksAll(checks ...Checker)</code>\uff1a\u8981\u6c42\u6240\u6709\u6761\u4ef6\u90fd\u6ee1\u8db3\uff08AND \u903b\u8f91\uff09\u3002\u4f7f\u7528 <code>Check*</code> \u51fd\u6570\uff08\u4e0d\u662f <code>With*</code>\uff09\u3002\u793a\u4f8b\uff1a   <pre><code>summary.WithChecksAll(\n    summary.CheckEventThreshold(10),\n    summary.CheckTokenThreshold(2000),\n)\n</code></pre></li> <li><code>WithChecksAny(checks ...Checker)</code>\uff1a\u4efb\u4f55\u6761\u4ef6\u6ee1\u8db3\u5373\u89e6\u53d1\uff08OR \u903b\u8f91\uff09\u3002\u4f7f\u7528 <code>Check*</code> \u51fd\u6570\uff08\u4e0d\u662f <code>With*</code>\uff09\u3002\u793a\u4f8b\uff1a   <pre><code>summary.WithChecksAny(\n    summary.CheckEventThreshold(50),\n    summary.CheckTimeThreshold(10*time.Minute),\n)\n</code></pre></li> </ul> <p>\u6ce8\u610f\uff1a\u5728 <code>WithChecksAll</code> \u548c <code>WithChecksAny</code> \u4e2d\u4f7f\u7528 <code>Check*</code> \u51fd\u6570\uff08\u5982 <code>CheckEventThreshold</code>\uff09\u3002\u5c06 <code>With*</code> \u51fd\u6570\uff08\u5982 <code>WithEventThreshold</code>\uff09\u4f5c\u4e3a <code>NewSummarizer</code> \u7684\u76f4\u63a5\u9009\u9879\u4f7f\u7528\u3002<code>Check*</code> \u51fd\u6570\u521b\u5efa\u68c0\u67e5\u5668\u5b9e\u4f8b\uff0c\u800c <code>With*</code> \u51fd\u6570\u662f\u9009\u9879\u8bbe\u7f6e\u5668\u3002</p> <p>\u6458\u8981\u751f\u6210\uff1a</p> <ul> <li><code>WithMaxSummaryWords(maxWords int)</code>\uff1a\u9650\u5236\u6458\u8981\u7684\u6700\u5927\u5b57\u6570\u3002\u8be5\u9650\u5236\u4f1a\u5305\u542b\u5728\u63d0\u793a\u8bcd\u4e2d\u4ee5\u6307\u5bfc\u6a21\u578b\u751f\u6210\u3002\u793a\u4f8b\uff1a<code>WithMaxSummaryWords(150)</code> \u8bf7\u6c42\u5728 150 \u5b57\u4ee5\u5185\u7684\u6458\u8981\u3002</li> <li><code>WithPrompt(prompt string)</code>\uff1a\u63d0\u4f9b\u81ea\u5b9a\u4e49\u6458\u8981\u63d0\u793a\u8bcd\u3002\u63d0\u793a\u8bcd\u5fc5\u987b\u5305\u542b\u5360\u4f4d\u7b26 <code>{conversation_text}</code>\uff0c\u5b83\u4f1a\u88ab\u5bf9\u8bdd\u5185\u5bb9\u66ff\u6362\u3002\u53ef\u9009\u5305\u542b <code>{max_summary_words}</code> \u7528\u4e8e\u5b57\u6570\u9650\u5236\u6307\u4ee4\u3002</li> <li><code>WithSkipRecent(skipFunc SkipRecentFunc)</code>\uff1a\u901a\u8fc7\u81ea\u5b9a\u4e49\u51fd\u6570\u5728\u6458\u8981\u65f6\u8df3\u8fc7\u6700\u8fd1\u4e8b\u4ef6\u3002\u51fd\u6570\u63a5\u6536\u6240\u6709\u4e8b\u4ef6\u5e76\u8fd4\u56de\u5e94\u8df3\u8fc7\u7684\u5c3e\u90e8\u4e8b\u4ef6\u6570\u91cf\uff0c\u8fd4\u56de 0 \u8868\u793a\u4e0d\u8df3\u8fc7\u3002\u9002\u5408\u907f\u514d\u603b\u7ed3\u6700\u8fd1\u3001\u53ef\u80fd\u4e0d\u5b8c\u6574\u7684\u5bf9\u8bdd\uff0c\u6216\u5b9e\u73b0\u57fa\u4e8e\u65f6\u95f4/\u5185\u5bb9\u7684\u8df3\u8fc7\u7b56\u7565\u3002</li> </ul> <p>\u81ea\u5b9a\u4e49\u63d0\u793a\u8bcd\u793a\u4f8b\uff1a</p> <pre><code>customPrompt := `\u5206\u6790\u4ee5\u4e0b\u5bf9\u8bdd\u5e76\u63d0\u4f9b\u7b80\u6d01\u7684\u6458\u8981\uff0c\u91cd\u70b9\u5173\u6ce8\u5173\u952e\u51b3\u7b56\u3001\u884c\u52a8\u9879\u548c\u91cd\u8981\u4e0a\u4e0b\u6587\u3002\n\u8bf7\u63a7\u5236\u5728 {max_summary_words} \u5b57\u4ee5\u5185\u3002\n\n&lt;conversation&gt;\n{conversation_text}\n&lt;/conversation&gt;\n\n\u6458\u8981\uff1a`\n\nsummarizer := summary.NewSummarizer(\n    summaryModel,\n    summary.WithPrompt(customPrompt), // \u81ea\u5b9a\u4e49 Prompt\n    summary.WithMaxSummaryWords(100), // \u6ce8\u5165 Prompt \u91cc\u9762\u7684 {max_summary_words}\n    summary.WithEventThreshold(15),\n)\n\n// \u8df3\u8fc7\u56fa\u5b9a\u6570\u91cf\uff08\u517c\u5bb9\u65e7\u7528\u6cd5\uff09\nsummarizer := summary.NewSummarizer(\n    summaryModel,\n    summary.WithSkipRecent(func(_ []event.Event) int { return 2 }), // \u8df3\u8fc7\u6700\u540e 2 \u6761\n    summary.WithEventThreshold(10),\n)\n\n// \u8df3\u8fc7\u6700\u8fd1 5 \u5206\u949f\u5185\u7684\u6d88\u606f\uff08\u65f6\u95f4\u7a97\u53e3\uff09\nsummarizer := summary.NewSummarizer(\n    summaryModel,\n    summary.WithSkipRecent(func(events []event.Event) int {\n        cutoff := time.Now().Add(-5 * time.Minute)\n        skip := 0\n        for i := len(events) - 1; i &gt;= 0; i-- {\n            if events[i].Timestamp.After(cutoff) {\n                skip++\n            } else {\n                break\n            }\n        }\n        return skip\n    }),\n    summary.WithEventThreshold(10),\n)\n\n// \u4ec5\u8df3\u8fc7\u672b\u5c3e\u7684\u5de5\u5177\u8c03\u7528\u6d88\u606f\nsummarizer := summary.NewSummarizer(\n    summaryModel,\n    summary.WithSkipRecent(func(events []event.Event) int {\n        skip := 0\n        for i := len(events) - 1; i &gt;= 0; i-- {\n            if events[i].Response != nil &amp;&amp; len(events[i].Response.Choices) &gt; 0 &amp;&amp;\n                events[i].Response.Choices[0].Message.Role == model.RoleTool {\n                skip++\n            } else {\n                break\n            }\n        }\n        return skip\n    }),\n    summary.WithEventThreshold(10),\n)\n</code></pre>"},{"location":"zh/session/#_41","title":"\u4f1a\u8bdd\u670d\u52a1\u9009\u9879","text":"<p>\u5728\u4f1a\u8bdd\u670d\u52a1\u4e2d\u914d\u7f6e\u5f02\u6b65\u6458\u8981\u5904\u7406\uff1a</p> <ul> <li><code>WithSummarizer(s summary.SessionSummarizer)</code>\uff1a\u5c06\u6458\u8981\u5668\u6ce8\u5165\u5230\u4f1a\u8bdd\u670d\u52a1\u4e2d\u3002</li> <li><code>WithAsyncSummaryNum(num int)</code>\uff1a\u8bbe\u7f6e\u7528\u4e8e\u6458\u8981\u5904\u7406\u7684\u5f02\u6b65 worker goroutine \u6570\u91cf\u3002\u9ed8\u8ba4\u4e3a 2\u3002\u66f4\u591a worker \u5141\u8bb8\u66f4\u9ad8\u5e76\u53d1\u4f46\u6d88\u8017\u66f4\u591a\u8d44\u6e90\u3002</li> <li><code>WithSummaryQueueSize(size int)</code>\uff1a\u8bbe\u7f6e\u6458\u8981\u4efb\u52a1\u961f\u5217\u7684\u5927\u5c0f\u3002\u9ed8\u8ba4\u4e3a 100\u3002\u66f4\u5927\u7684\u961f\u5217\u5141\u8bb8\u66f4\u591a\u5f85\u5904\u7406\u4efb\u52a1\u4f46\u6d88\u8017\u66f4\u591a\u5185\u5b58\u3002</li> <li><code>WithSummaryJobTimeout(timeout time.Duration)</code>\uff1a\u8bbe\u7f6e\u5904\u7406\u5355\u4e2a\u6458\u8981\u4efb\u52a1\u7684\u8d85\u65f6\u65f6\u95f4\u3002\u9ed8\u8ba4\u4e3a 30 \u79d2\u3002</li> </ul>"},{"location":"zh/session/#_42","title":"\u624b\u52a8\u89e6\u53d1\u6458\u8981","text":"<p>\u53ef\u4ee5\u4f7f\u7528\u4f1a\u8bdd\u670d\u52a1 API \u624b\u52a8\u89e6\u53d1\u6458\u8981\uff1a</p> <pre><code>// \u540c\u6b65\u6458\u8981\nerr := sessionService.CreateSessionSummary(\n    ctx,\n    sess,\n    session.SummaryFilterKeyAllContents, // \u5b8c\u6574\u4f1a\u8bdd\u6458\u8981\u3002\n    false,                                // force=false\uff0c\u9075\u5b88\u89e6\u53d1\u6761\u4ef6\u3002\n)\n\n// \u5f02\u6b65\u6458\u8981\uff08\u63a8\u8350\uff09\nerr := sessionService.EnqueueSummaryJob(\n    ctx,\n    sess,\n    session.SummaryFilterKeyAllContents,\n    false, // force=false\u3002\n)\n\n// \u5f3a\u5236\u6458\u8981\uff0c\u4e0d\u8003\u8651\u89e6\u53d1\u6761\u4ef6\nerr := sessionService.EnqueueSummaryJob(\n    ctx,\n    sess,\n    session.SummaryFilterKeyAllContents,\n    true, // force=true\uff0c\u7ed5\u8fc7\u89e6\u53d1\u6761\u4ef6\u3002\n)\n</code></pre>"},{"location":"zh/session/#_43","title":"\u83b7\u53d6\u6458\u8981","text":"<p>\u4ece\u4f1a\u8bdd\u4e2d\u83b7\u53d6\u6700\u65b0\u7684\u6458\u8981\u6587\u672c\uff1a</p> <pre><code>// \u83b7\u53d6\u5168\u91cf\u4f1a\u8bdd\u6458\u8981\uff08\u9ed8\u8ba4\u884c\u4e3a\uff09\nsummaryText, found := sessionService.GetSessionSummaryText(ctx, sess)\nif found {\n    fmt.Printf(\"\u6458\u8981\uff1a%s\\n\", summaryText)\n}\n\n// \u83b7\u53d6\u7279\u5b9a filter key \u7684\u6458\u8981\nuserSummary, found := sessionService.GetSessionSummaryText(\n    ctx, sess, session.WithSummaryFilterKey(\"user-messages\"),\n)\nif found {\n    fmt.Printf(\"\u7528\u6237\u6d88\u606f\u6458\u8981\uff1a%s\\n\", userSummary)\n}\n</code></pre> <p>Filter Key \u652f\u6301\uff1a</p> <p><code>GetSessionSummaryText</code> \u65b9\u6cd5\u652f\u6301\u53ef\u9009\u7684 <code>WithSummaryFilterKey</code> \u9009\u9879\uff0c\u7528\u4e8e\u83b7\u53d6\u7279\u5b9a\u4e8b\u4ef6\u8fc7\u6ee4\u5668\u7684\u6458\u8981\uff1a</p> <ul> <li>\u4e0d\u63d0\u4f9b\u9009\u9879\u65f6\uff0c\u8fd4\u56de\u5168\u91cf\u4f1a\u8bdd\u6458\u8981\uff08<code>SummaryFilterKeyAllContents</code>\uff09</li> <li>\u63d0\u4f9b\u7279\u5b9a filter key \u4f46\u672a\u627e\u5230\u65f6\uff0c\u56de\u9000\u5230\u5168\u91cf\u4f1a\u8bdd\u6458\u8981</li> <li>\u5982\u679c\u90fd\u4e0d\u5b58\u5728\uff0c\u515c\u5e95\u8fd4\u56de\u4efb\u610f\u53ef\u7528\u7684\u6458\u8981</li> </ul>"},{"location":"zh/session/#_44","title":"\u5de5\u4f5c\u539f\u7406","text":"<ol> <li> <p>\u589e\u91cf\u5904\u7406\uff1a\u6458\u8981\u5668\u8ddf\u8e2a\u6bcf\u4e2a\u4f1a\u8bdd\u7684\u4e0a\u6b21\u6458\u8981\u65f6\u95f4\u3002\u5728\u540e\u7eed\u8fd0\u884c\u4e2d\uff0c\u5b83\u53ea\u5904\u7406\u4e0a\u6b21\u6458\u8981\u540e\u53d1\u751f\u7684\u4e8b\u4ef6\u3002</p> </li> <li> <p>\u589e\u91cf\u6458\u8981\uff1a\u65b0\u4e8b\u4ef6\u4e0e\u5148\u524d\u7684\u6458\u8981\uff08\u4f5c\u4e3a\u7cfb\u7edf\u4e8b\u4ef6\u524d\u7f6e\uff09\u7ec4\u5408\uff0c\u751f\u6210\u4e00\u4e2a\u65e2\u5305\u542b\u65e7\u4e0a\u4e0b\u6587\u53c8\u5305\u542b\u65b0\u4fe1\u606f\u7684\u66f4\u65b0\u6458\u8981\u3002</p> </li> <li> <p>\u89e6\u53d1\u6761\u4ef6\u8bc4\u4f30\uff1a\u5728\u751f\u6210\u6458\u8981\u4e4b\u524d\uff0c\u6458\u8981\u5668\u4f1a\u8bc4\u4f30\u914d\u7f6e\u7684\u89e6\u53d1\u6761\u4ef6\uff08\u57fa\u4e8e\u81ea\u4e0a\u6b21\u6458\u8981\u540e\u7684\u589e\u91cf\u4e8b\u4ef6\u8ba1\u6570\u3001token \u8ba1\u6570\u3001\u65f6\u95f4\u9608\u503c\uff09\u3002\u5982\u679c\u6761\u4ef6\u672a\u6ee1\u8db3\u4e14 <code>force=false</code>\uff0c\u5219\u8df3\u8fc7\u6458\u8981\u3002</p> </li> <li> <p>\u5f02\u6b65 Worker\uff1a\u6458\u8981\u4efb\u52a1\u4f7f\u7528\u57fa\u4e8e\u54c8\u5e0c\u7684\u5206\u53d1\u7b56\u7565\u5206\u914d\u5230\u591a\u4e2a worker goroutine\u3002\u8fd9\u786e\u4fdd\u540c\u4e00\u4f1a\u8bdd\u7684\u4efb\u52a1\u6309\u987a\u5e8f\u5904\u7406\uff0c\u800c\u4e0d\u540c\u4f1a\u8bdd\u53ef\u4ee5\u5e76\u884c\u5904\u7406\u3002</p> </li> <li> <p>\u56de\u9000\u673a\u5236\uff1a\u5982\u679c\u5f02\u6b65\u5165\u961f\u5931\u8d25\uff08\u961f\u5217\u5df2\u6ee1\u3001\u4e0a\u4e0b\u6587\u53d6\u6d88\u6216 worker \u672a\u521d\u59cb\u5316\uff09\uff0c\u7cfb\u7edf\u4f1a\u81ea\u52a8\u56de\u9000\u5230\u540c\u6b65\u5904\u7406\u3002</p> </li> </ol>"},{"location":"zh/session/#_45","title":"\u6700\u4f73\u5b9e\u8df5","text":"<ol> <li> <p>\u9009\u62e9\u5408\u9002\u7684\u9608\u503c\uff1a\u6839\u636e LLM \u7684\u4e0a\u4e0b\u6587\u7a97\u53e3\u548c\u5bf9\u8bdd\u6a21\u5f0f\u8bbe\u7f6e\u4e8b\u4ef6/token \u9608\u503c\u3002\u5bf9\u4e8e GPT-4\uff088K \u4e0a\u4e0b\u6587\uff09\uff0c\u8003\u8651\u4f7f\u7528 <code>WithTokenThreshold(4000)</code> \u4e3a\u54cd\u5e94\u7559\u51fa\u7a7a\u95f4\u3002</p> </li> <li> <p>\u4f7f\u7528\u5f02\u6b65\u5904\u7406\uff1a\u5728\u751f\u4ea7\u73af\u5883\u4e2d\u59cb\u7ec8\u4f7f\u7528 <code>EnqueueSummaryJob</code> \u800c\u4e0d\u662f <code>CreateSessionSummary</code>\uff0c\u4ee5\u907f\u514d\u963b\u585e\u5bf9\u8bdd\u6d41\u7a0b\u3002</p> </li> <li> <p>\u76d1\u63a7\u961f\u5217\u5927\u5c0f\uff1a\u5982\u679c\u9891\u7e41\u770b\u5230\"queue is full\"\u8b66\u544a\uff0c\u8bf7\u589e\u52a0 <code>WithSummaryQueueSize</code> \u6216 <code>WithAsyncSummaryNum</code>\u3002</p> </li> <li> <p>\u81ea\u5b9a\u4e49\u63d0\u793a\u8bcd\uff1a\u6839\u636e\u5e94\u7528\u9700\u6c42\u5b9a\u5236\u6458\u8981\u63d0\u793a\u8bcd\u3002\u4f8b\u5982\uff0c\u5982\u679c\u4f60\u6b63\u5728\u6784\u5efa\u5ba2\u6237\u652f\u6301 Agent\uff0c\u5e94\u5173\u6ce8\u5173\u952e\u95ee\u9898\u548c\u89e3\u51b3\u65b9\u6848\u3002</p> </li> <li> <p>\u5e73\u8861\u5b57\u6570\u9650\u5236\uff1a\u8bbe\u7f6e <code>WithMaxSummaryWords</code> \u4ee5\u5728\u4fdd\u7559\u4e0a\u4e0b\u6587\u548c\u51cf\u5c11 token \u4f7f\u7528\u4e4b\u95f4\u53d6\u5f97\u5e73\u8861\u3002\u5178\u578b\u503c\u8303\u56f4\u4e3a 100-300 \u5b57\u3002</p> </li> <li> <p>\u6d4b\u8bd5\u89e6\u53d1\u6761\u4ef6\uff1a\u5c1d\u8bd5\u4e0d\u540c\u7684 <code>WithChecksAny</code> \u548c <code>WithChecksAll</code> \u7ec4\u5408\uff0c\u627e\u5230\u6458\u8981\u9891\u7387\u548c\u6210\u672c\u4e4b\u95f4\u7684\u6700\u4f73\u5e73\u8861\u3002</p> </li> </ol>"},{"location":"zh/session/#_46","title":"\u6309\u4e8b\u4ef6\u7c7b\u578b\u751f\u6210\u6458\u8981","text":"<p>\u5728\u5b9e\u9645\u5e94\u7528\u4e2d\uff0c\u4f60\u53ef\u80fd\u5e0c\u671b\u4e3a\u4e0d\u540c\u7c7b\u578b\u7684\u4e8b\u4ef6\u751f\u6210\u72ec\u7acb\u7684\u6458\u8981\u3002\u4f8b\u5982\uff1a</p> <ul> <li>\u7528\u6237\u6d88\u606f\u6458\u8981\uff1a\u603b\u7ed3\u7528\u6237\u7684\u9700\u6c42\u548c\u95ee\u9898</li> <li>\u5de5\u5177\u8c03\u7528\u6458\u8981\uff1a\u8bb0\u5f55\u4f7f\u7528\u4e86\u54ea\u4e9b\u5de5\u5177\u548c\u7ed3\u679c</li> <li>\u7cfb\u7edf\u4e8b\u4ef6\u6458\u8981\uff1a\u8ddf\u8e2a\u7cfb\u7edf\u72b6\u6001\u53d8\u5316</li> </ul> <p>\u8981\u5b9e\u73b0\u8fd9\u4e2a\u529f\u80fd\uff0c\u9700\u8981\u4e3a\u4e8b\u4ef6\u8bbe\u7f6e <code>FilterKey</code> \u5b57\u6bb5\u6765\u6807\u8bc6\u4e8b\u4ef6\u7c7b\u578b\u3002</p>"},{"location":"zh/session/#appendeventhook-filterkey","title":"\u4f7f\u7528 AppendEventHook \u8bbe\u7f6e FilterKey","text":"<p>\u63a8\u8350\u4f7f\u7528 <code>AppendEventHook</code> \u5728\u4e8b\u4ef6\u5199\u5165\u524d\u81ea\u52a8\u8bbe\u7f6e <code>FilterKey</code>\uff1a</p> <pre><code>sessionService := inmemory.NewSessionService(\n    inmemory.WithAppendEventHook(func(ctx *session.AppendEventContext, next func() error) error {\n        // \u6839\u636e\u4e8b\u4ef6\u4f5c\u8005\u81ea\u52a8\u5206\u7c7b\n        prefix := \"my-app/\"  // \u5fc5\u987b\u6dfb\u52a0 appName \u524d\u7f00\n        switch ctx.Event.Author {\n        case \"user\":\n            ctx.Event.FilterKey = prefix + \"user-messages\"\n        case \"tool\":\n            ctx.Event.FilterKey = prefix + \"tool-calls\"\n        default:\n            ctx.Event.FilterKey = prefix + \"misc\"\n        }\n        return next()\n    }),\n)\n</code></pre> <p>\u8bbe\u7f6e\u597d FilterKey \u540e\uff0c\u5c31\u53ef\u4ee5\u4e3a\u4e0d\u540c\u7c7b\u578b\u7684\u4e8b\u4ef6\u751f\u6210\u72ec\u7acb\u6458\u8981\uff1a</p> <pre><code>// \u4e3a\u7528\u6237\u6d88\u606f\u751f\u6210\u6458\u8981\nerr := sessionService.CreateSessionSummary(ctx, sess, \"my-app/user-messages\", false)\n\n// \u4e3a\u5de5\u5177\u8c03\u7528\u751f\u6210\u6458\u8981\nerr := sessionService.CreateSessionSummary(ctx, sess, \"my-app/tool-calls\", false)\n\n// \u83b7\u53d6\u7279\u5b9a\u7c7b\u578b\u7684\u6458\u8981\nuserSummary, found := sessionService.GetSessionSummaryText(\n    ctx, sess, session.WithSummaryFilterKey(\"my-app/user-messages\"))\n</code></pre>"},{"location":"zh/session/#filterkey","title":"FilterKey \u524d\u7f00\u89c4\u8303","text":"<p>\u26a0\ufe0f \u91cd\u8981\uff1aFilterKey \u5fc5\u987b\u6dfb\u52a0 <code>appName + \"/\"</code> \u524d\u7f00\u3002</p> <p>\u539f\u56e0\uff1a Runner \u5728\u8fc7\u6ee4\u4e8b\u4ef6\u65f6\u4f7f\u7528 <code>appName + \"/\"</code> \u4f5c\u4e3a\u8fc7\u6ee4\u524d\u7f00\uff0c\u5982\u679c FilterKey \u6ca1\u6709\u8fd9\u4e2a\u524d\u7f00\uff0c\u4e8b\u4ef6\u4f1a\u88ab\u8fc7\u6ee4\u6389\uff0c\u5bfc\u81f4\uff1a</p> <ul> <li>LLM \u770b\u4e0d\u5230\u5386\u53f2\u5bf9\u8bdd\uff0c\u53ef\u80fd\u91cd\u590d\u89e6\u53d1\u5de5\u5177\u8c03\u7528</li> <li>\u6458\u8981\u5185\u5bb9\u4e0d\u5b8c\u6574\uff0c\u4e22\u5931\u91cd\u8981\u4e0a\u4e0b\u6587</li> </ul> <p>\u793a\u4f8b\uff1a</p> <pre><code>// \u2705 \u6b63\u786e\uff1a\u5e26 appName \u524d\u7f00\nevt.FilterKey = \"my-app/user-messages\"\n\n// \u274c \u9519\u8bef\uff1a\u6ca1\u6709\u524d\u7f00\uff0c\u4e8b\u4ef6\u4f1a\u88ab\u8fc7\u6ee4\nevt.FilterKey = \"user-messages\"\n</code></pre> <p>\u6280\u672f\u7ec6\u8282\uff1a \u6846\u67b6\u4f7f\u7528\u524d\u7f00\u5339\u914d\u673a\u5236\uff08<code>strings.HasPrefix</code>\uff09\u6765\u5224\u65ad\u4e8b\u4ef6\u662f\u5426\u5e94\u8be5\u88ab\u5305\u542b\u5728\u4e0a\u4e0b\u6587\u4e2d\u3002\u8be6\u89c1 <code>ContentRequestProcessor</code> \u7684\u8fc7\u6ee4\u903b\u8f91\u3002</p>"},{"location":"zh/session/#_47","title":"\u5b8c\u6574\u793a\u4f8b","text":"<p>\u53c2\u8003\u4ee5\u4e0b\u793a\u4f8b\u67e5\u770b\u5b8c\u6574\u7684 FilterKey \u4f7f\u7528\u573a\u666f\uff1a</p> <ul> <li>examples/session/hook - Hook \u57fa\u7840\u7528\u6cd5</li> <li>examples/summary/filterkey - \u6309 FilterKey \u751f\u6210\u6458\u8981</li> </ul>"},{"location":"zh/session/#_48","title":"\u6027\u80fd\u8003\u8651","text":"<ul> <li>LLM \u6210\u672c\uff1a\u6bcf\u6b21\u6458\u8981\u751f\u6210\u90fd\u4f1a\u8c03\u7528 LLM\u3002\u76d1\u63a7\u89e6\u53d1\u6761\u4ef6\u4ee5\u5e73\u8861\u6210\u672c\u548c\u4e0a\u4e0b\u6587\u4fdd\u7559\u3002</li> <li>\u5185\u5b58\u4f7f\u7528\uff1a\u6458\u8981\u4e0e\u4e8b\u4ef6\u4e00\u8d77\u5b58\u50a8\u3002\u914d\u7f6e\u9002\u5f53\u7684 TTL \u4ee5\u7ba1\u7406\u957f\u65f6\u95f4\u8fd0\u884c\u4f1a\u8bdd\u4e2d\u7684\u5185\u5b58\u3002</li> <li>\u5f02\u6b65 Worker\uff1a\u66f4\u591a worker \u4f1a\u63d0\u9ad8\u541e\u5410\u91cf\u4f46\u6d88\u8017\u66f4\u591a\u8d44\u6e90\u3002\u4ece 2-4 \u4e2a worker \u5f00\u59cb\uff0c\u6839\u636e\u8d1f\u8f7d\u8fdb\u884c\u6269\u5c55\u3002</li> <li>\u961f\u5217\u5bb9\u91cf\uff1a\u6839\u636e\u9884\u671f\u7684\u5e76\u53d1\u91cf\u548c\u6458\u8981\u751f\u6210\u65f6\u95f4\u8c03\u6574\u961f\u5217\u5927\u5c0f\u3002</li> </ul>"},{"location":"zh/session/#_49","title":"\u5b8c\u6574\u793a\u4f8b","text":"<p>\u4ee5\u4e0b\u662f\u6f14\u793a\u6240\u6709\u7ec4\u4ef6\u5982\u4f55\u534f\u540c\u5de5\u4f5c\u7684\u5b8c\u6574\u793a\u4f8b\uff1a</p> <pre><code>package main\n\nimport (\n    \"context\"\n    \"time\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/agent/llmagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/model\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/openai\"\n    \"trpc.group/trpc-go/trpc-agent-go/runner\"\n    \"trpc.group/trpc-go/trpc-agent-go/session/inmemory\"\n    \"trpc.group/trpc-go/trpc-agent-go/session/summary\"\n)\n\nfunc main() {\n    ctx := context.Background()\n\n    // \u521b\u5efa\u7528\u4e8e\u804a\u5929\u548c\u6458\u8981\u7684 LLM \u6a21\u578b\n    llm := openai.New(\"gpt-4\", openai.WithAPIKey(\"your-api-key\"))\n\n    // \u521b\u5efa\u5e26\u7075\u6d3b\u89e6\u53d1\u6761\u4ef6\u7684\u6458\u8981\u5668\n    summarizer := summary.NewSummarizer(\n        llm,\n        summary.WithMaxSummaryWords(200),\n        summary.WithChecksAny(\n            summary.CheckEventThreshold(20),\n            summary.CheckTokenThreshold(4000),\n            summary.CheckTimeThreshold(5*time.Minute),\n        ),\n    )\n\n    // \u521b\u5efa\u5e26\u6458\u8981\u5668\u7684\u4f1a\u8bdd\u670d\u52a1\n    sessionService := inmemory.NewSessionService(\n        inmemory.WithSummarizer(summarizer),\n        inmemory.WithAsyncSummaryNum(2),\n        inmemory.WithSummaryQueueSize(100),\n        inmemory.WithSummaryJobTimeout(30*time.Second),\n    )\n\n    // \u521b\u5efa\u542f\u7528\u6458\u8981\u6ce8\u5165\u7684 agent\n    agent := llmagent.New(\n        \"my-agent\",\n        llmagent.WithModel(llm),\n        llmagent.WithAddSessionSummary(true),\n        llmagent.WithMaxHistoryRuns(10),        // \u5f53AddSessionSummary=false\u65f6\u9650\u5236\u5386\u53f2\u8f6e\u6b21\n    )\n\n    // \u521b\u5efa runner\n    r := runner.NewRunner(\"my-app\", agent,\n        runner.WithSessionService(sessionService))\n\n    // \u8fd0\u884c\u5bf9\u8bdd - \u6458\u8981\u4f1a\u81ea\u52a8\u7ba1\u7406\n    userMsg := model.NewUserMessage(\"\u8ddf\u6211\u8bb2\u8bb2 AI\")\n    eventChan, _ := r.Run(ctx, \"user123\", \"session456\", userMsg)\n\n    // \u6d88\u8d39\u4e8b\u4ef6\n    for event := range eventChan {\n        // \u5904\u7406\u4e8b\u4ef6...\n    }\n}\n</code></pre>"},{"location":"zh/session/#_50","title":"\u53c2\u8003\u8d44\u6e90","text":"<ul> <li>\u4f1a\u8bdd\u793a\u4f8b</li> <li>\u6458\u8981\u793a\u4f8b</li> </ul> <p>\u901a\u8fc7\u5408\u7406\u4f7f\u7528\u4f1a\u8bdd\u7ba1\u7406\u529f\u80fd\uff0c\u7ed3\u5408\u4f1a\u8bdd\u6458\u8981\u673a\u5236\uff0c\u4f60\u53ef\u4ee5\u6784\u5efa\u6709\u72b6\u6001\u7684\u667a\u80fd Agent\uff0c\u5728\u4fdd\u6301\u5bf9\u8bdd\u4e0a\u4e0b\u6587\u7684\u540c\u65f6\u9ad8\u6548\u7ba1\u7406\u5185\u5b58\uff0c\u4e3a\u7528\u6237\u63d0\u4f9b\u8fde\u7eed\u3001\u4e2a\u6027\u5316\u7684\u4ea4\u4e92\u4f53\u9a8c\uff0c\u540c\u65f6\u786e\u4fdd\u7cfb\u7edf\u957f\u671f\u8fd0\u884c\u7684\u53ef\u6301\u7eed\u6027\u3002</p>"},{"location":"zh/skill/","title":"Skill\uff08Agent Skills\uff09","text":"<p>Agent Skills \u628a\u53ef\u590d\u7528\u7684\u4efb\u52a1\u5c01\u88c5\u4e3a\u201c\u6280\u80fd\u76ee\u5f55\u201d\uff0c\u7528 <code>SKILL.md</code> \u63cf\u8ff0\u76ee\u6807\u4e0e\u6d41\u7a0b\uff0c\u5e76\u914d\u5957\u811a\u672c\u4e0e\u6587\u6863\u3002\u5728\u5bf9\u8bdd\u4e2d\uff0cAgent \u53ea\u6ce8\u5165 \u201c\u4f4e\u6210\u672c\u7684\u6982\u89c8\u201d\uff0c\u5728\u786e\u6709\u9700\u8981\u65f6\u518d\u6309\u9700\u8f7d\u5165\u6b63\u6587\u4e0e\u6587\u6863\uff0c\u5e76\u5728 \u9694\u79bb\u5de5\u4f5c\u533a\u4e2d\u5b89\u5168\u6267\u884c\u811a\u672c\uff0c\u4ece\u800c\u964d\u4f4e\u4e0a\u4e0b\u6587\u5360\u7528\u4e0e\u6cc4\u6f0f\u98ce\u9669\u3002</p> <p>\u53c2\u8003\u80cc\u666f\uff1a - Anthropic \u5de5\u7a0b\u535a\u5ba2\uff1a   https://www.anthropic.com/engineering/equipping-agents-for-the-real-world-with-agent-skills - \u5f00\u6e90 Skills \u793a\u4f8b\u5e93\uff08\u7ed3\u6784\u4e0e\u7ea6\u5b9a\u53ef\u501f\u9274\uff09\uff1a   https://github.com/anthropics/skills</p>"},{"location":"zh/skill/#_1","title":"\u6982\u89c8","text":""},{"location":"zh/skill/#_2","title":"\ud83c\udfaf \u80fd\u529b\u4e00\u89c8","text":"<ul> <li>\ud83d\udd0e \u81ea\u52a8\u6ce8\u5165\u6280\u80fd\u201c\u6982\u89c8\u201d\uff08\u540d\u79f0\u4e0e\u63cf\u8ff0\uff09\uff0c\u5f15\u5bfc\u6a21\u578b\u9009\u62e9</li> <li>\ud83d\udce5 <code>skill_load</code> \u6309\u9700\u6ce8\u5165 <code>SKILL.md</code> \u6b63\u6587\u4e0e\u9009\u5b9a\u6587\u6863</li> <li>\ud83d\udcda <code>skill_select_docs</code> \u589e/\u6539/\u6e05\u9664\u6587\u6863\u9009\u62e9</li> <li>\ud83e\uddfe <code>skill_list_docs</code> \u5217\u51fa\u53ef\u7528\u6587\u6863</li> <li>\ud83c\udfc3 <code>skill_run</code> \u5728\u5de5\u4f5c\u533a\u6267\u884c\u547d\u4ee4\uff0c\u8fd4\u56de stdout/stderr \u4e0e\u8f93\u51fa\u6587\u4ef6</li> <li>\ud83d\uddc2\ufe0f \u6309\u901a\u914d\u7b26\u6536\u96c6\u8f93\u51fa\u6587\u4ef6\u5e76\u56de\u4f20\u5185\u5bb9\u4e0e MIME \u7c7b\u578b</li> <li>\ud83e\udde9 \u53ef\u9009\u62e9\u672c\u5730\u6216\u5bb9\u5668\u5de5\u4f5c\u533a\u6267\u884c\u5668\uff08\u9ed8\u8ba4\u672c\u5730\uff09</li> <li>\ud83e\uddf1 \u652f\u6301\u58f0\u660e\u5f0f <code>inputs</code>/<code>outputs</code>\uff1a\u6620\u5c04\u8f93\u5165\u3001   \u4ee5\u6e05\u5355\u65b9\u5f0f\u6536\u96c6/\u5185\u8054/\u4fdd\u5b58\u8f93\u51fa</li> </ul>"},{"location":"zh/skill/#_3","title":"\u6838\u5fc3\u6982\u5ff5\uff1a\u4e09\u5c42\u4fe1\u606f\u6a21\u578b","text":"<p>1) \u521d\u59cb\u201c\u6982\u89c8\u201d\u5c42\uff08\u6781\u4f4e\u6210\u672c\uff09    - \u4ec5\u6ce8\u5165 <code>SKILL.md</code> \u7684 <code>name</code> \u4e0e <code>description</code> \u5230\u7cfb\u7edf\u6d88\u606f\u3002    - \u8ba9\u6a21\u578b\u77e5\u9053\u201c\u6709\u54ea\u4e9b\u6280\u80fd\u3001\u5404\u505a\u4ec0\u4e48\u201d\uff0c\u4f46\u4e0d\u5360\u7528\u6b63\u6587\u7bc7\u5e45\u3002</p> <p>2) \u6b63\u6587\u5c42\uff08\u6309\u9700\u6ce8\u5165\uff09    - \u5f53\u4efb\u52a1\u786e\u5b9e\u9700\u8981\u67d0\u6280\u80fd\u65f6\uff0c\u6a21\u578b\u8c03\u7528 <code>skill_load</code>\uff0c\u6846\u67b6\u628a\u8be5      \u6280\u80fd\u7684 <code>SKILL.md</code> \u6b63\u6587\u6574\u4f53\u6ce8\u5165\u5230\u7cfb\u7edf\u6d88\u606f\u4e2d\uff0c\u4f9b\u6a21\u578b\u7cbe\u51c6\u53c2\u8003\u3002</p> <p>3) \u6587\u6863/\u811a\u672c\u5c42\uff08\u7cbe\u786e\u9009\u62e9 + \u9694\u79bb\u6267\u884c\uff09    - \u5173\u8054\u6587\u6863\u6309\u9700\u9009\u62e9\uff08<code>docs</code> \u6216 <code>include_all_docs</code>\uff09\uff0c\u4ec5\u628a\u6587\u672c      \u5185\u5bb9\u6ce8\u5165\uff1b\u811a\u672c\u4e0d\u4f1a\u88ab\u5185\u8054\u5230\u63d0\u793a\u8bcd\uff0c\u800c\u662f\u5728\u5de5\u4f5c\u533a\u4e2d\u6267\u884c\uff0c\u5e76      \u56de\u4f20\u7ed3\u679c\u4e0e\u8f93\u51fa\u6587\u4ef6\u3002</p>"},{"location":"zh/skill/#_4","title":"\u76ee\u5f55\u7ed3\u6784","text":"<pre><code>skills/\n  demo-skill/\n    SKILL.md        # YAML \u5934\u4fe1\u606f(name/description) + Markdown \u6b63\u6587\n    USAGE.md        # \u53ef\u9009\u6587\u6863\uff08\u4efb\u610f .md/.txt\uff09\n    scripts/build.sh\n    ...\n</code></pre> <p>\u4ed3\u5e93\u4e0e\u89e3\u6790\uff1a skill/repository.go</p>"},{"location":"zh/skill/#0-1","title":"\u5feb\u901f\u5f00\u59cb\uff08\u4ece 0 \u5230 1\uff09","text":""},{"location":"zh/skill/#1","title":"1) \u73af\u5883\u51c6\u5907","text":"<ul> <li>Go 1.21+</li> <li>\u4e00\u4e2a\u6a21\u578b\u670d\u52a1\u7684 API Key\uff08OpenAI \u517c\u5bb9\uff09</li> <li>\u53ef\u9009\uff1aDocker\uff08\u4f7f\u7528\u5bb9\u5668\u6267\u884c\u5668\u65f6\uff09</li> </ul> <p>\u5e38\u7528\u73af\u5883\u53d8\u91cf\uff1a</p> <pre><code>export OPENAI_API_KEY=\"your-api-key\"\n# \u53ef\u9009\uff1a\u6307\u5b9a\u6280\u80fd\u6839\u76ee\u5f55\uff08\u5bb9\u5668\u6267\u884c\u5668\u4f1a\u53ea\u8bfb\u6302\u8f7d\uff09\nexport SKILLS_ROOT=/path/to/skills\n</code></pre>"},{"location":"zh/skill/#2-skills","title":"2) \u542f\u7528 Skills","text":"<p>\u5728 <code>LLMAgent</code> \u91cc\u63d0\u4f9b\u6280\u80fd\u4ed3\u5e93\u4e0e\u6267\u884c\u5668\u3002\u672a\u663e\u5f0f\u6307\u5b9a\u65f6\uff0c\u9ed8\u8ba4\u4f7f\u7528 \u672c\u5730\u6267\u884c\u5668\uff08\u66f4\u6613\u4e8e\u672c\u673a\u5f00\u53d1\uff09\u3002</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/agent/llmagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/codeexecutor/local\"\n    \"trpc.group/trpc-go/trpc-agent-go/skill\"\n)\n\nrepo, _ := skill.NewFSRepository(\"./skills\")\nexec := local.New()\n\nagent := llmagent.New(\n    \"skills-assistant\",\n    llmagent.WithSkills(repo),\n    llmagent.WithCodeExecutor(exec),\n)\n</code></pre> <p>\u8981\u70b9\uff1a - \u8bf7\u6c42\u5904\u7406\u5668\u6ce8\u5165\u6982\u89c8\u4e0e\u6309\u9700\u5185\u5bb9\uff1a   [internal/flow/processor/skills.go]   (https://github.com/trpc-group/trpc-agent-go/blob/main/internal/flow/processor/skills.go) - \u5de5\u5177\u81ea\u52a8\u6ce8\u518c\uff1a\u5f00\u542f <code>WithSkills</code> \u540e\uff0c<code>skill_load</code>\u3001   <code>skill_select_docs</code>\u3001<code>skill_list_docs</code> \u4e0e <code>skill_run</code>   \u4f1a\u81ea\u52a8\u51fa\u73b0\u5728\u5de5\u5177\u5217\u8868\u4e2d\uff0c\u65e0\u9700\u624b\u52a8\u6dfb\u52a0\u3002 - \u81ea\u52a8\u63d0\u793a\u6ce8\u5165\uff1a\u6846\u67b6\u4f1a\u5728\u7cfb\u7edf\u6d88\u606f\u4e2d\u52a0\u5165\u7b80\u6d01\u7684\u201c\u5de5\u5177\u4f7f\u7528\u6307\u5f15\u201d\uff0c   \u5f15\u5bfc\u6a21\u578b\u5728\u5408\u9002\u65f6\u673a\u5148 <code>skill_load</code>\uff0c\u9700\u8981\u65f6\u7528 <code>skill_select_docs</code>   \u9009\u62e9\u6587\u6863\uff0c\u518d <code>skill_run</code>\uff08\u53c2\u89c1\u6e90\u7801   \u7684\u6307\u5f15\u6587\u6848\u62fc\u63a5\u903b\u8f91\uff09\u3002   - \u52a0\u8f7d\u5668\uff1a tool/skill/load.go   - \u8fd0\u884c\u5668\uff1a tool/skill/run.go</p>"},{"location":"zh/skill/#3","title":"3) \u8fd0\u884c\u793a\u4f8b","text":"<p>\u4ea4\u4e92\u5f0f\u6280\u80fd\u5bf9\u8bdd\u793a\u4f8b\uff1a examples/skillrun/main.go</p> <pre><code>cd examples/skillrun\nexport OPENAI_API_KEY=\"your-api-key\"\n# \u672c\u5730\u6267\u884c\u5668\ngo run . -executor local\n# \u6216\u5bb9\u5668\u6267\u884c\u5668\uff08\u9700 Docker\uff09\ngo run . -executor container\n</code></pre> <p>\u793a\u4f8b\u6280\u80fd\uff08\u8282\u9009\uff09\uff1a [examples/skillrun/skills/python_math/SKILL.md] (https://github.com/trpc-group/trpc-agent-go/blob/main/examples/skillrun/skills/python_math/SKILL.md)</p> <p>\u81ea\u7136\u8bed\u8a00\u4ea4\u4e92\u5efa\u8bae\uff1a - \u76f4\u63a5\u8bf4\u660e\u4f60\u8981\u505a\u4ec0\u4e48\uff1b\u6a21\u578b\u4f1a\u6839\u636e\u6982\u89c8\u5224\u65ad\u662f\u5426\u9700\u8981\u67d0\u4e2a\u6280\u80fd\u3002 - \u5f53\u9700\u8981\u65f6\uff0c\u6a21\u578b\u4f1a\u5148\u8c03\u7528 <code>skill_load</code> \u6ce8\u5165\u6b63\u6587/\u6587\u6863\uff0c\u518d\u8c03\u7528   <code>skill_run</code> \u6267\u884c\u547d\u4ee4\u5e76\u56de\u4f20\u8f93\u51fa\u6587\u4ef6\u3002</p>"},{"location":"zh/skill/#skillmd","title":"<code>SKILL.md</code> \u7ed3\u6784\u4e0e\u793a\u4f8b","text":"<p><code>SKILL.md</code> \u91c7\u7528 YAML \u5934\u4fe1\u606f + Markdown \u6b63\u6587\uff1a</p> <pre><code>---\nname: python-math\ndescription: Small Python utilities for math and text files.\n---\n\nOverview\n\nRun short Python scripts inside the skill workspace...\n\nExamples\n\n1) Print the first N Fibonacci numbers\n\n   Command:\n   python3 scripts/fib.py 10 &gt; out/fib.txt\n\nOutput Files\n\n- out/fib.txt\n</code></pre> <p>\u5efa\u8bae\uff1a - \u5934\u4fe1\u606f\u7684 <code>name</code>/<code>description</code> \u8981\u7b80\u6d01\uff0c\u4fbf\u4e8e\u201c\u6982\u89c8\u6ce8\u5165\u201d - \u6b63\u6587\u7ed9\u51fa\u201c\u4f7f\u7528\u65f6\u673a\u201d\u201c\u6b65\u9aa4/\u547d\u4ee4\u201d\u201c\u8f93\u51fa\u6587\u4ef6\u4f4d\u7f6e\u201d\u7b49 - \u628a\u811a\u672c\u653e\u5165 <code>scripts/</code>\uff0c\u547d\u4ee4\u4e2d\u5f15\u7528\u811a\u672c\u8def\u5f84\u800c\u975e\u5185\u8054\u6e90\u7801</p> <p>\u66f4\u591a\u53ef\u53c2\u8003 Anthropic \u7684\u5f00\u6e90\u5e93\uff1a https://github.com/anthropics/skills</p>"},{"location":"zh/skill/#_5","title":"\u5de5\u5177\u7528\u6cd5\u8be6\u89e3","text":""},{"location":"zh/skill/#skill_load","title":"<code>skill_load</code>\uff08\u52a0\u8f7d\u5185\u5bb9\uff09","text":"<p>\u58f0\u660e\uff1a tool/skill/load.go</p> <p>\u8f93\u5165\uff1a - <code>skill</code>\uff08\u5fc5\u586b\uff09\uff1a\u6280\u80fd\u540d - <code>docs</code>\uff08\u53ef\u9009\uff09\uff1a\u8981\u5305\u542b\u7684\u6587\u6863\u6587\u4ef6\u540d\u6570\u7ec4 - <code>include_all_docs</code>\uff08\u53ef\u9009\uff09\uff1a\u4e3a true \u65f6\u5305\u542b\u6240\u6709\u6587\u6863</p> <p>\u884c\u4e3a\uff1a - \u5199\u5165\u4e34\u65f6\u4f1a\u8bdd\u952e\uff08\u672c\u8f6e\u6709\u6548\uff09\uff1a   - <code>temp:skill:loaded:&lt;name&gt;</code> = \"1\"   - <code>temp:skill:docs:&lt;name&gt;</code> = \"*\" \u6216 JSON \u5b57\u7b26\u4e32\u6570\u7ec4 - \u8bf7\u6c42\u5904\u7406\u5668\u8bfb\u53d6\u8fd9\u4e9b\u952e\uff0c\u628a <code>SKILL.md</code> \u6b63\u6587\u4e0e\u6587\u6863\u6ce8\u5165\u5230\u7cfb\u7edf\u6d88\u606f</p> <p>\u8bf4\u660e\uff1a\u53ef\u591a\u6b21\u8c03\u7528\u4ee5\u65b0\u589e\u6216\u66ff\u6362\u6587\u6863\u3002</p>"},{"location":"zh/skill/#skill_select_docs","title":"<code>skill_select_docs</code>\uff08\u9009\u62e9\u6587\u6863\uff09","text":"<p>\u58f0\u660e\uff1a tool/skill/select_docs.go</p> <p>\u8f93\u5165\uff1a - <code>skill</code>\uff08\u5fc5\u586b\uff09 - <code>docs</code>\uff08\u53ef\u9009\u6570\u7ec4\uff09 - <code>include_all_docs</code>\uff08\u53ef\u9009\u5e03\u5c14\uff09 - <code>mode</code>\uff08\u53ef\u9009\u5b57\u7b26\u4e32\uff09\uff1a<code>add</code> | <code>replace</code> | <code>clear</code></p> <p>\u884c\u4e3a\uff1a - \u66f4\u65b0 <code>temp:skill:docs:&lt;name&gt;</code>\uff1a<code>*</code> \u8868\u793a\u5168\u9009\uff1b\u6570\u7ec4\u8868\u793a\u663e\u5f0f\u5217\u8868</p>"},{"location":"zh/skill/#skill_list_docs","title":"<code>skill_list_docs</code>\uff08\u5217\u51fa\u6587\u6863\uff09","text":"<p>\u58f0\u660e\uff1a tool/skill/list_docs.go</p> <p>\u8f93\u5165\uff1a - <code>skill</code>\uff08\u5fc5\u586b\uff09</p> <p>\u8f93\u51fa\uff1a - \u53ef\u7528\u6587\u6863\u6587\u4ef6\u540d\u6570\u7ec4</p> <p>\u63d0\u793a\uff1a\u8fd9\u4e9b\u4f1a\u8bdd\u952e\u7531\u6846\u67b6\u81ea\u52a8\u7ba1\u7406\uff1b\u7528\u6237\u901a\u5e38\u65e0\u9700\u76f4\u63a5\u64cd\u4f5c\uff0c\u4ec5\u9700\u7528 \u81ea\u7136\u8bed\u8a00\u9a71\u52a8\u5bf9\u8bdd\u5373\u53ef\u3002</p>"},{"location":"zh/skill/#skill_run","title":"<code>skill_run</code>\uff08\u6267\u884c\u547d\u4ee4\uff09","text":"<p>\u58f0\u660e\uff1a tool/skill/run.go</p> <p>\u8f93\u5165\uff1a - <code>skill</code>\uff08\u5fc5\u586b\uff09\uff1a\u6280\u80fd\u540d - <code>command</code>\uff08\u5fc5\u586b\uff09\uff1aShell \u547d\u4ee4\uff08\u901a\u8fc7 <code>bash -lc</code> \u6267\u884c\uff09 - <code>cwd</code>\uff08\u53ef\u9009\uff09\uff1a\u76f8\u5bf9\u6280\u80fd\u6839\u76ee\u5f55\u7684\u5de5\u4f5c\u8def\u5f84 - <code>env</code>\uff08\u53ef\u9009\uff09\uff1a\u73af\u5883\u53d8\u91cf\u6620\u5c04 - <code>output_files</code>\uff08\u53ef\u9009\uff0c\u4f20\u7edf\u6536\u96c6\u65b9\u5f0f\uff09\uff1a\u901a\u914d\u7b26\u5217\u8868   \uff08\u5982 <code>out/*.txt</code>\uff09\u3002\u901a\u914d\u7b26\u4ee5\u5de5\u4f5c\u533a\u6839\u76ee\u5f55\u4e3a\u51c6\uff0c\u4e5f\u652f\u6301   <code>$OUTPUT_DIR/*.txt</code> \u8fd9\u7c7b\u5199\u6cd5\uff0c\u4f1a\u81ea\u52a8\u5f52\u4e00\u5316\u4e3a <code>out/*.txt</code>\u3002 - <code>inputs</code>\uff08\u53ef\u9009\uff0c\u58f0\u660e\u5f0f\u8f93\u5165\uff09\uff1a\u628a\u5916\u90e8\u8d44\u6e90\u6620\u5c04\u8fdb\u5de5\u4f5c\u533a\uff0c   \u7ed3\u6784\u4e3a\u5bf9\u8c61\u6570\u7ec4\uff0c\u6bcf\u9879\u652f\u6301\uff1a</p> <p>- <code>from</code>\uff1a\u6765\u6e90\uff0c\u652f\u6301\u56db\u7c7b\u65b9\u6848\uff08scheme\uff09\uff1a     - <code>artifact://name[@version]</code> \u4ece\u5236\u54c1\u670d\u52a1\u62c9\u53d6\u6587\u4ef6     - <code>host://abs/path</code> \u4ece\u5bbf\u4e3b\u673a\u7edd\u5bf9\u8def\u5f84\u590d\u5236/\u94fe\u63a5     - <code>workspace://rel/path</code> \u4ece\u5f53\u524d\u5de5\u4f5c\u533a\u76f8\u5bf9\u8def\u5f84\u590d\u5236/\u94fe\u63a5     - <code>skill://&lt;name&gt;/rel/path</code> \u4ece\u5df2\u7f13\u5b58\u7684\u6280\u80fd\u76ee\u5f55\u590d\u5236/\u94fe\u63a5   - <code>to</code>\uff1a\u76ee\u7684\u8def\u5f84\uff08\u76f8\u5bf9\u5de5\u4f5c\u533a\uff09\u3002\u672a\u6307\u5b9a\u65f6\u9ed8\u8ba4\u5199\u5230     <code>WORK_DIR/inputs/&lt;basename&gt;</code>\u3002   - <code>mode</code>\uff1a<code>copy</code>\uff08\u9ed8\u8ba4\uff09\u6216 <code>link</code>\uff08\u5728\u53ef\u884c\u65f6\u5efa\u7acb\u7b26\u53f7\u94fe\u63a5\uff09\u3002</p> <ul> <li><code>outputs</code>\uff08\u53ef\u9009\uff0c\u58f0\u660e\u5f0f\u8f93\u51fa\uff09\uff1a\u4f7f\u7528\u6e05\u5355\uff08manifest\uff09\u6536\u96c6\u8f93\u51fa\u3002   \u5b57\u6bb5\uff1a<ul> <li><code>globs</code>\uff1a\u901a\u914d\u7b26\u6570\u7ec4\uff08\u76f8\u5bf9\u5de5\u4f5c\u533a\uff0c\u652f\u6301 <code>**</code>\uff0c\u4e5f\u652f\u6301   <code>$OUTPUT_DIR/**</code> \u8fd9\u7c7b\u5199\u6cd5\u5e76\u5f52\u4e00\u5316\u4e3a <code>out/**</code>\uff09\u3002</li> <li><code>inline</code>\uff1a\u662f\u5426\u628a\u6587\u4ef6\u5185\u5bb9\u5185\u8054\u8fd4\u56de\u3002</li> <li><code>save</code>\uff1a\u662f\u5426\u4fdd\u5b58\u4e3a\u5236\u54c1\uff08\u4e0e\u5236\u54c1\u670d\u52a1\u534f\u4f5c\uff09\u3002</li> <li><code>name_template</code>\uff1a\u4fdd\u5b58\u4e3a\u5236\u54c1\u65f6\u7684\u6587\u4ef6\u540d\u524d\u7f00\uff08\u5982 <code>pref/</code>\uff09\u3002</li> <li><code>max_files</code>\uff08\u9ed8\u8ba4 100\uff09\u3001<code>max_file_bytes</code>\uff08\u9ed8\u8ba4 4 MiB/\u6587\u4ef6\uff09\u3001   <code>max_total_bytes</code>\uff08\u9ed8\u8ba4 64 MiB\uff09\uff1a\u4e0a\u9650\u63a7\u5236\u3002</li> </ul> </li> </ul> <ul> <li><code>timeout</code>\uff08\u53ef\u9009\uff09\uff1a\u8d85\u65f6\u79d2\u6570\uff08\u6267\u884c\u5668\u6709\u9ed8\u8ba4\u503c\uff09</li> <li><code>save_as_artifacts</code>\uff08\u53ef\u9009\uff0c\u4f20\u7edf\u6536\u96c6\u8def\u5f84\uff09\uff1a\u628a\u901a\u8fc7   <code>output_files</code> \u6536\u96c6\u5230\u7684\u6587\u4ef6\u4fdd\u5b58\u4e3a\u5236\u54c1\uff0c\u5e76\u5728\u7ed3\u679c\u4e2d\u8fd4\u56de   <code>artifact_files</code>\u3002</li> <li><code>omit_inline_content</code>\uff08\u53ef\u9009\uff09\uff1a\u4e0e <code>save_as_artifacts</code> \u914d\u5408\uff0c   \u4e3a true \u65f6\u4e0d\u8fd4\u56de\u6587\u4ef6\u5185\u5bb9\uff0c\u4ec5\u4fdd\u7559\u6587\u4ef6\u540d/MIME \u4fe1\u606f\u3002</li> <li><code>artifact_prefix</code>\uff08\u53ef\u9009\uff09\uff1a\u4e0e <code>save_as_artifacts</code> \u914d\u5408\u7684\u524d\u7f00\u3002</li> </ul> <p>\u8f93\u51fa\uff1a - <code>stdout</code>\u3001<code>stderr</code>\u3001<code>exit_code</code>\u3001<code>timed_out</code>\u3001<code>duration_ms</code> - <code>output_files</code>\uff1a\u6587\u4ef6\u5217\u8868\uff08<code>name</code>\u3001<code>content</code>\u3001<code>mime_type</code>\uff09 - <code>artifact_files</code>\uff1a\u5236\u54c1\u5f15\u7528\uff08<code>name</code>\u3001<code>version</code>\uff09\u3002\u4e24\u79cd\u9014\u5f84\uff1a   - \u4f20\u7edf\u8def\u5f84\uff1a\u8bbe\u7f6e\u4e86 <code>save_as_artifacts</code> \u65f6\u7531\u5de5\u5177\u4fdd\u5b58\u5e76\u8fd4\u56de   - \u6e05\u5355\u8def\u5f84\uff1a<code>outputs.save=true</code> \u65f6\u7531\u6267\u884c\u5668\u4fdd\u5b58\u5e76\u9644\u52a0\u5230\u7ed3\u679c</p> <p>\u5178\u578b\u6d41\u7a0b\uff1a 1) \u6a21\u578b\u5148\u8c03\u7528 <code>skill_load</code> \u6ce8\u5165\u6b63\u6587/\u6587\u6863 2) \u968f\u540e\u8c03\u7528 <code>skill_run</code> \u6267\u884c\u547d\u4ee4\u5e76\u6536\u96c6\u8f93\u51fa\u6587\u4ef6\uff1a    - \u4f20\u7edf\uff1a\u7528 <code>output_files</code> \u6307\u5b9a\u901a\u914d\u7b26    - \u58f0\u660e\u5f0f\uff1a\u7528 <code>outputs</code> \u7edf\u4e00\u63a7\u5236\u6536\u96c6/\u5185\u8054/\u4fdd\u5b58    - \u5982\u9700\u628a\u4e0a\u6e38\u6587\u4ef6\u5e26\u5165\uff0c\u53ef\u7528 <code>inputs</code> \u5148\u884c\u6620\u5c04</p> <p>\u8fd0\u884c\u73af\u5883\u4e0e\u5de5\u4f5c\u76ee\u5f55\uff1a - \u672a\u63d0\u4f9b <code>cwd</code> \u65f6\uff0c\u9ed8\u8ba4\u5728\u6280\u80fd\u6839\u76ee\u5f55\u8fd0\u884c\uff1a<code>/skills/&lt;name&gt;</code> - \u76f8\u5bf9 <code>cwd</code> \u4f1a\u88ab\u89e3\u6790\u4e3a\u6280\u80fd\u6839\u76ee\u5f55\u4e0b\u7684\u5b50\u8def\u5f84 - \u8fd0\u884c\u65f6\u6ce8\u5165\u73af\u5883\u53d8\u91cf\uff1a   - <code>WORKSPACE_DIR</code>\u3001<code>SKILLS_DIR</code>\u3001<code>WORK_DIR</code>\u3001<code>OUTPUT_DIR</code>\u3001     <code>RUN_DIR</code>\uff08\u7531\u6267\u884c\u5668\u6ce8\u5165\uff09   - <code>SKILL_NAME</code>\uff08\u7531\u5de5\u5177\u6ce8\u5165\uff09 - \u4fbf\u6377\u7b26\u53f7\u94fe\u63a5\uff1a\u5728\u6280\u80fd\u6839\u76ee\u5f55\u4e0b\u81ea\u52a8\u521b\u5efa <code>out/</code>\u3001<code>work/</code>\u3001   <code>inputs/</code> \u94fe\u63a5\u5230\u5de5\u4f5c\u533a\u5bf9\u5e94\u76ee\u5f55\uff0c\u65b9\u4fbf\u6309\u6587\u6863\u4e2d\u7684\u76f8\u5bf9\u8def\u5f84\u4f7f\u7528\u3002</p>"},{"location":"zh/skill/#_6","title":"\u6267\u884c\u5668","text":"<p>\u63a5\u53e3\uff1a codeexecutor/codeexecutor.go</p> <p>\u5b9e\u73b0\uff1a - \u672c\u5730\uff1a [codeexecutor/local/workspace_runtime.go]   (https://github.com/trpc-group/trpc-agent-go/blob/main/codeexecutor/local/workspace_runtime.go) - \u5bb9\u5668\uff08Docker\uff09\uff1a   [codeexecutor/container/workspace_runtime.go]   (https://github.com/trpc-group/trpc-agent-go/blob/main/codeexecutor/container/workspace_runtime.go)</p> <p>\u5bb9\u5668\u6a21\u5f0f\u8bf4\u660e\uff1a - \u8fd0\u884c\u76ee\u5f55\u6302\u8f7d\u4e3a\u53ef\u5199\uff1b<code>$SKILLS_ROOT</code>\uff08\u82e5\u5b58\u5728\uff09\u53ea\u8bfb\u6302\u8f7d - \u9ed8\u8ba4\u7981\u7528\u7f51\u7edc\uff08\u53c2\u89c1\u5bb9\u5668 HostConfig\uff09\uff0c\u66f4\u5b89\u5168\u53ef\u91cd\u590d</p> <p>\u5b89\u5168\u4e0e\u8d44\u6e90\uff1a - \u672c\u5730/\u5bb9\u5668\u5747\u9650\u5236\u8bfb\u53d6\u4e0e\u5199\u5165\u5728\u5de5\u4f5c\u533a\u5185 - \u53ef\u901a\u8fc7\u8d85\u65f6\u3001\u811a\u672c\u6743\u9650\uff08\u5982\u53ea\u8bfb\u6302\u8f7d\u6280\u80fd\u6811\uff09\u964d\u4f4e\u98ce\u9669 - \u8f93\u51fa\u6587\u4ef6\u8bfb\u53d6\u5927\u5c0f\u6709\u9650\u5236\uff0c\u907f\u514d\u8fc7\u5927\u6587\u4ef6\u5f71\u54cd</p>"},{"location":"zh/skill/#_7","title":"\u4e8b\u4ef6\u4e0e\u8ffd\u8e2a","text":"<p>\u4e8b\u4ef6\uff1a\u5de5\u5177\u54cd\u5e94\u4ee5 <code>tool.response</code> \u5f62\u5f0f\u4ea7\u51fa\uff0c\u53ef\u643a\u5e26\u72b6\u6001\u589e\u91cf\uff08\u89c1 <code>skill_load</code>\uff09\u3002\u5408\u5e76\u591a\u5de5\u5177\u7ed3\u679c\u4e0e\u5e76\u884c\u6267\u884c\u903b\u8f91\u53c2\u89c1\uff1a [internal/flow/processor/functioncall.go] (https://github.com/trpc-group/trpc-agent-go/blob/main/internal/flow/processor/functioncall.go)</p> <p>\u8ffd\u8e2a\uff08\u5e38\u89c1 span \u540d\uff09\uff1a - <code>workspace.create</code>\u3001<code>workspace.stage.*</code>\u3001<code>workspace.run</code> - <code>workspace.collect</code>\u3001<code>workspace.cleanup</code>\u3001<code>workspace.inline</code></p>"},{"location":"zh/skill/#_8","title":"\u539f\u7406\u4e0e\u8bbe\u8ba1\uff08\u7b80\u8ff0\uff09","text":"<ul> <li>\u52a8\u673a\uff1a\u5728\u771f\u5b9e\u4efb\u52a1\u4e2d\uff0c\u6280\u80fd\u8bf4\u660e\u4e0e\u811a\u672c\u5f80\u5f80\u5185\u5bb9\u8f83\u591a\uff0c\u5168\u90e8\u5185\u8054\u5230   \u63d0\u793a\u8bcd\u65e2\u6602\u8d35\u53c8\u6613\u6cc4\u6f0f\u3002\u4e09\u5c42\u4fe1\u606f\u6a21\u578b\u8ba9\u201c\u77e5\u9053\u6709\u4f55\u80fd\u529b\u201d\u4e0e\u201c\u5728   \u9700\u8981\u65f6\u83b7\u5f97\u7ec6\u8282/\u6267\u884c\u811a\u672c\u201d\u89e3\u8026\uff0c\u4ece\u800c\u51cf\u5c11\u4e0a\u4e0b\u6587\u5f00\u9500\u5e76\u63d0\u5347\u5b89\u5168\u3002</li> <li>\u6ce8\u5165\u4e0e\u72b6\u6001\uff1a\u901a\u8fc7\u4e8b\u4ef6\u4e2d\u7684 <code>StateDelta</code> \u5c06\u52a0\u8f7d\u9009\u62e9\u4ee5\u952e\u503c\u5f62\u5f0f   \u5199\u5165\u4e34\u65f6\u4f1a\u8bdd\uff0c\u4e0b\u4e00\u8f6e\u8bf7\u6c42\u5904\u7406\u5668\u636e\u6b64\u62fc\u63a5\u7cfb\u7edf\u6d88\u606f\uff0c\u5f62\u6210\u201c\u6982\u89c8 \u2192   \u6b63\u6587/\u6587\u6863\u201d\u7684\u6e10\u8fdb\u5f0f\u4e0a\u4e0b\u6587\u3002</li> <li>\u6267\u884c\u9694\u79bb\uff1a\u811a\u672c\u4ee5\u5de5\u4f5c\u533a\u4e3a\u8fb9\u754c\uff0c\u8f93\u51fa\u6587\u4ef6\u7531\u901a\u914d\u7b26\u7cbe\u786e\u6536\u96c6\uff0c\u907f\u514d   \u5c06\u811a\u672c\u6e90\u7801\u6216\u975e\u5fc5\u8981\u6587\u4ef6\u5e26\u5165\u6a21\u578b\u4e0a\u4e0b\u6587\u3002</li> </ul>"},{"location":"zh/skill/#_9","title":"\u6545\u969c\u6392\u67e5","text":"<ul> <li>\u201cunknown skill\u201d\uff1a\u786e\u8ba4\u6280\u80fd\u540d\u4e0e\u4ed3\u5e93\u8def\u5f84\uff1b\u8c03\u7528 <code>skill_load</code> \u524d   \u5148\u68c0\u67e5\u201c\u6982\u89c8\u6ce8\u5165\u201d\u662f\u5426\u5305\u542b\u8be5\u6280\u80fd</li> <li>\u201cexecutor is not configured\u201d\uff1a\u4e3a <code>LLMAgent</code> \u914d\u7f6e   <code>WithCodeExecutor</code>\uff0c\u6216\u4f7f\u7528\u9ed8\u8ba4\u672c\u5730\u6267\u884c\u5668</li> <li>\u8d85\u65f6/\u975e\u96f6\u9000\u51fa\u7801\uff1a\u68c0\u67e5\u547d\u4ee4\u3001\u4f9d\u8d56\u4e0e <code>timeout</code> \u53c2\u6570\uff1b\u5bb9\u5668\u6a21\u5f0f\u4e0b   \u7f51\u7edc\u9ed8\u8ba4\u5173\u95ed\uff0c\u907f\u514d\u4f9d\u8d56\u7f51\u7edc\u7684\u811a\u672c</li> <li>\u8f93\u51fa\u6587\u4ef6\u672a\u8fd4\u56de\uff1a\u68c0\u67e5 <code>output_files</code> \u901a\u914d\u7b26\u662f\u5426\u6307\u5411\u6b63\u786e\u4f4d\u7f6e</li> </ul>"},{"location":"zh/skill/#_10","title":"\u53c2\u8003\u4e0e\u793a\u4f8b","text":"<ul> <li>\u80cc\u666f\uff1a<ul> <li>\u5de5\u7a0b\u535a\u5ba2\uff1a   https://www.anthropic.com/engineering/equipping-agents-for-the-real-world-with-agent-skills</li> <li>\u5f00\u6e90\u5e93\uff1a https://github.com/anthropics/skills</li> </ul> </li> <li>\u672c\u4ed3\u5e93\uff1a<ul> <li>\u4ea4\u4e92\u793a\u4f8b\uff1a [examples/skillrun/main.go]   (https://github.com/trpc-group/trpc-agent-go/blob/main/examples/skillrun/main.go)</li> <li>\u793a\u4f8b\u6280\u80fd\uff1a [examples/skillrun/skills/python_math/SKILL.md]   (https://github.com/trpc-group/trpc-agent-go/blob/main/examples/skillrun/skills/python_math/SKILL.md)</li> </ul> </li> </ul>"},{"location":"zh/tool/","title":"Tool \u5de5\u5177\u4f7f\u7528\u6587\u6863","text":"<p>Tool \u5de5\u5177\u7cfb\u7edf\u662f tRPC-Agent-Go \u6846\u67b6\u7684\u6838\u5fc3\u7ec4\u4ef6\uff0c\u4e3a Agent \u63d0\u4f9b\u4e86\u4e0e\u5916\u90e8\u670d\u52a1\u548c\u529f\u80fd\u4ea4\u4e92\u7684\u80fd\u529b\u3002\u6846\u67b6\u652f\u6301\u591a\u79cd\u5de5\u5177\u7c7b\u578b\uff0c\u5305\u62ec\u51fd\u6570\u5de5\u5177\u548c\u57fa\u4e8e MCP\uff08Model Context Protocol\uff09\u6807\u51c6\u7684\u5916\u90e8\u5de5\u5177\u96c6\u6210\u3002</p>"},{"location":"zh/tool/#_1","title":"\u6982\u8ff0","text":""},{"location":"zh/tool/#_2","title":"\ud83c\udfaf \u6838\u5fc3\u7279\u6027","text":"<ul> <li>\ud83d\udd27 \u591a\u7c7b\u578b\u5de5\u5177\uff1a\u652f\u6301\u51fd\u6570\u5de5\u5177\uff08Function Tools\uff09\u548c MCP \u6807\u51c6\u5de5\u5177</li> <li>\ud83c\udf0a \u6d41\u5f0f\u54cd\u5e94\uff1a\u652f\u6301\u5b9e\u65f6\u6d41\u5f0f\u54cd\u5e94\u548c\u666e\u901a\u54cd\u5e94\u4e24\u79cd\u6a21\u5f0f</li> <li>\u26a1 \u5e76\u884c\u6267\u884c\uff1a\u5de5\u5177\u8c03\u7528\u652f\u6301\u5e76\u884c\u6267\u884c\u4ee5\u63d0\u5347\u6027\u80fd</li> <li>\ud83d\udd04 MCP \u534f\u8bae\uff1a\u5b8c\u6574\u652f\u6301 STDIO\u3001SSE\u3001Streamable HTTP \u4e09\u79cd\u4f20\u8f93\u65b9\u5f0f</li> <li>\ud83d\udee0\ufe0f \u914d\u7f6e\u652f\u6301\uff1a\u63d0\u4f9b\u914d\u7f6e\u9009\u9879\u548c\u8fc7\u6ee4\u5668\u652f\u6301</li> </ul>"},{"location":"zh/tool/#_3","title":"\u6838\u5fc3\u6982\u5ff5","text":""},{"location":"zh/tool/#tool_1","title":"\ud83d\udd27 Tool\uff08\u5de5\u5177\uff09","text":"<p>Tool \u662f\u5355\u4e2a\u529f\u80fd\u7684\u62bd\u8c61\uff0c\u5b9e\u73b0 <code>tool.Tool</code> \u63a5\u53e3\u3002\u6bcf\u4e2a Tool \u63d0\u4f9b\u7279\u5b9a\u7684\u80fd\u529b\uff0c\u5982\u6570\u5b66\u8ba1\u7b97\u3001\u641c\u7d22\u3001\u65f6\u95f4\u67e5\u8be2\u7b49\u3002</p> <pre><code>type Tool interface {\n    Declaration() *Declaration  // \u8fd4\u56de\u5de5\u5177\u5143\u6570\u636e\n}\n\ntype CallableTool interface {\n    Call(ctx context.Context, jsonArgs []byte) (any, error)\n    Tool\n}\n</code></pre>"},{"location":"zh/tool/#toolset","title":"\ud83d\udce6 ToolSet\uff08\u5de5\u5177\u96c6\uff09","text":"<p>ToolSet \u662f\u4e00\u7ec4\u76f8\u5173\u5de5\u5177\u7684\u96c6\u5408\uff0c\u5b9e\u73b0 <code>tool.ToolSet</code> \u63a5\u53e3\u3002ToolSet \u8d1f\u8d23\u7ba1\u7406\u5de5\u5177\u7684\u751f\u547d\u5468\u671f\u3001\u8fde\u63a5\u548c\u8d44\u6e90\u6e05\u7406\u3002</p> <pre><code>type ToolSet interface {\n    // \u8fd4\u56de\u5f53\u524d\u5de5\u5177\u96c6\u5185\u7684\u5de5\u5177\n    Tools(context.Context) []tool.Tool\n\n    // \u91ca\u653e\u5de5\u5177\u96c6\u6301\u6709\u7684\u8d44\u6e90\n    Close() error\n\n    // \u8fd4\u56de\u8be5\u5de5\u5177\u96c6\u7684\u540d\u79f0\uff0c\u7528\u4e8e\u6807\u8bc6\u4e0e\u51b2\u7a81\u5904\u7406\n    Name() string\n}\n</code></pre> <p>Tool \u4e0e ToolSet \u7684\u5173\u7cfb\uff1a</p> <ul> <li>\u4e00\u4e2a \"Tool\" = \u4e00\u4e2a\u5177\u4f53\u529f\u80fd\uff08\u5982\u8ba1\u7b97\u5668\uff09</li> <li>\u4e00\u4e2a \"ToolSet\" = \u4e00\u7ec4\u76f8\u5173\u7684 Tool\uff08\u5982 MCP \u670d\u52a1\u5668\u63d0\u4f9b\u7684\u6240\u6709\u5de5\u5177\uff09</li> <li>Agent \u53ef\u4ee5\u540c\u65f6\u4f7f\u7528\u591a\u4e2a Tool \u548c\u591a\u4e2a ToolSet</li> </ul>"},{"location":"zh/tool/#_4","title":"\ud83c\udf0a \u6d41\u5f0f\u5de5\u5177\u652f\u6301","text":"<p>\u6846\u67b6\u652f\u6301\u6d41\u5f0f\u5de5\u5177\uff0c\u63d0\u4f9b\u5b9e\u65f6\u54cd\u5e94\u80fd\u529b\uff1a</p> <pre><code>// \u6d41\u5f0f\u5de5\u5177\u63a5\u53e3\ntype StreamableTool interface {\n    StreamableCall(ctx context.Context, jsonArgs []byte) (*StreamReader, error)\n    Tool\n}\n\n// \u6d41\u5f0f\u6570\u636e\u5355\u5143\ntype StreamChunk struct {\n    Content  any      `json:\"content\"`\n    Metadata Metadata `json:\"metadata,omitempty\"`\n}\n</code></pre> <p>\u6d41\u5f0f\u5de5\u5177\u7279\u70b9\uff1a</p> <ul> <li>\ud83d\ude80 \u5b9e\u65f6\u54cd\u5e94\uff1a\u6570\u636e\u9010\u6b65\u8fd4\u56de\uff0c\u65e0\u9700\u7b49\u5f85\u5b8c\u6574\u7ed3\u679c</li> <li>\ud83d\udcca \u5927\u6570\u636e\u5904\u7406\uff1a\u9002\u7528\u4e8e\u65e5\u5fd7\u67e5\u8be2\u3001\u6570\u636e\u5206\u6790\u7b49\u573a\u666f</li> <li>\u26a1 \u7528\u6237\u4f53\u9a8c\uff1a\u63d0\u4f9b\u5373\u65f6\u53cd\u9988\u548c\u8fdb\u5ea6\u663e\u793a</li> </ul>"},{"location":"zh/tool/#_5","title":"\u5de5\u5177\u7c7b\u578b\u8bf4\u660e","text":"\u5de5\u5177\u7c7b\u578b \u5b9a\u4e49 \u96c6\u6210\u65b9\u5f0f Function Tools \u76f4\u63a5\u8c03\u7528 Go \u51fd\u6570\u5b9e\u73b0\u7684\u5de5\u5177 <code>Tool</code> \u63a5\u53e3\uff0c\u8fdb\u7a0b\u5185\u8c03\u7528 Agent Tool (AgentTool) \u5c06\u4efb\u610f Agent \u5305\u88c5\u4e3a\u53ef\u8c03\u7528\u5de5\u5177 <code>Tool</code> \u63a5\u53e3\uff0c\u652f\u6301\u6d41\u5f0f\u5185\u90e8\u8f6c\u53d1 DuckDuckGo Tool \u57fa\u4e8e DuckDuckGo API \u7684\u641c\u7d22\u5de5\u5177 <code>Tool</code> \u63a5\u53e3\uff0cHTTP API MCP ToolSet \u57fa\u4e8e MCP \u534f\u8bae\u7684\u5916\u90e8\u5de5\u5177\u96c6 <code>ToolSet</code> \u63a5\u53e3\uff0c\u652f\u6301\u591a\u79cd\u4f20\u8f93\u65b9\u5f0f <p>\ud83d\udcd6 \u76f8\u5173\u6587\u6863\uff1aAgent \u95f4\u534f\u4f5c\u76f8\u5173\u7684 Agent Tool \u548c Transfer Tool \u8bf7\u53c2\u8003 \u591a Agent \u7cfb\u7edf\u6587\u6863\u3002</p>"},{"location":"zh/tool/#function-tools","title":"Function Tools \u51fd\u6570\u5de5\u5177","text":"<p>Function Tools \u901a\u8fc7 Go \u51fd\u6570\u76f4\u63a5\u5b9e\u73b0\u5de5\u5177\u903b\u8f91\uff0c\u662f\u6700\u7b80\u5355\u76f4\u63a5\u7684\u5de5\u5177\u7c7b\u578b\u3002</p>"},{"location":"zh/tool/#_6","title":"\u57fa\u672c\u7528\u6cd5","text":"<pre><code>import \"trpc.group/trpc-go/trpc-agent-go/tool/function\"\n\n// 1. \u5b9a\u4e49\u5de5\u5177\u51fd\u6570\nfunc calculator(ctx context.Context, req struct {\n    Operation string  `json:\"operation\"`\n    A         float64 `json:\"a\"`\n    B         float64 `json:\"b\"`\n}) (map[string]interface{}, error) {\n    switch req.Operation {\n    case \"add\":\n        return map[string]interface{}{\"result\": req.A + req.B}, nil\n    case \"multiply\":\n        return map[string]interface{}{\"result\": req.A * req.B}, nil\n    default:\n        return nil, fmt.Errorf(\"unsupported operation: %s\", req.Operation)\n    }\n}\n\n// 2. \u521b\u5efa\u5de5\u5177\ncalculatorTool := function.NewFunctionTool(\n    calculator,\n    function.WithName(\"calculator\"),\n    function.WithDescription(\"\u6267\u884c\u6570\u5b66\u8fd0\u7b97\"),\n)\n\n// 3. \u96c6\u6210\u5230 Agent\nagent := llmagent.New(\"math-assistant\",\n    llmagent.WithModel(model),\n    llmagent.WithTools([]tool.Tool{calculatorTool}))\n</code></pre>"},{"location":"zh/tool/#_7","title":"\u6d41\u5f0f\u5de5\u5177\u793a\u4f8b","text":"<pre><code>// 1. \u5b9a\u4e49\u8f93\u5165\u8f93\u51fa\u7ed3\u6784\ntype weatherInput struct {\n    Location string `json:\"location\"`\n}\n\ntype weatherOutput struct {\n    Weather string `json:\"weather\"`\n}\n\n// 2. \u5b9e\u73b0\u6d41\u5f0f\u5de5\u5177\u51fd\u6570\nfunc getStreamableWeather(input weatherInput) *tool.StreamReader {\n    stream := tool.NewStream(10)\n    go func() {\n        defer stream.Writer.Close()\n\n        // \u6a21\u62df\u9010\u6b65\u8fd4\u56de\u5929\u6c14\u6570\u636e\n        result := \"Sunny, 25\u00b0C in \" + input.Location\n        for i := 0; i &lt; len(result); i++ {\n            chunk := tool.StreamChunk{\n                Content: weatherOutput{\n                    Weather: result[i : i+1],\n                },\n                Metadata: tool.Metadata{CreatedAt: time.Now()},\n            }\n\n            if closed := stream.Writer.Send(chunk, nil); closed {\n                break\n            }\n            time.Sleep(10 * time.Millisecond) // \u6a21\u62df\u5ef6\u8fdf\n        }\n    }()\n\n    return stream.Reader\n}\n\n// 3. \u521b\u5efa\u6d41\u5f0f\u5de5\u5177\nweatherStreamTool := function.NewStreamableFunctionTool[weatherInput, weatherOutput](\n    getStreamableWeather,\n    function.WithName(\"get_weather_stream\"),\n    function.WithDescription(\"\u6d41\u5f0f\u83b7\u53d6\u5929\u6c14\u4fe1\u606f\"),\n)\n\n// 4. \u4f7f\u7528\u6d41\u5f0f\u5de5\u5177\nreader, err := weatherStreamTool.StreamableCall(ctx, jsonArgs)\nif err != nil {\n    return err\n}\n\n// \u63a5\u6536\u6d41\u5f0f\u6570\u636e\nfor {\n    chunk, err := reader.Recv()\n    if err == io.EOF {\n        break // \u6d41\u7ed3\u675f\n    }\n    if err != nil {\n        return err\n    }\n\n    // \u5904\u7406\u6bcf\u4e2a\u6570\u636e\u5757\n    fmt.Printf(\"\u6536\u5230\u6570\u636e: %v\\n\", chunk.Content)\n}\nreader.Close()\n</code></pre>"},{"location":"zh/tool/#_8","title":"\u5185\u7f6e\u5de5\u5177\u7c7b\u578b","text":""},{"location":"zh/tool/#duckduckgo","title":"DuckDuckGo \u641c\u7d22\u5de5\u5177","text":"<p>DuckDuckGo \u5de5\u5177\u57fa\u4e8e DuckDuckGo Instant Answer API\uff0c\u63d0\u4f9b\u4e8b\u5b9e\u6027\u3001\u767e\u79d1\u7c7b\u4fe1\u606f\u641c\u7d22\u529f\u80fd\u3002</p>"},{"location":"zh/tool/#_9","title":"\u57fa\u7840\u7528\u6cd5","text":"<pre><code>import \"trpc.group/trpc-go/trpc-agent-go/tool/duckduckgo\"\n\n// \u521b\u5efa DuckDuckGo \u641c\u7d22\u5de5\u5177\nsearchTool := duckduckgo.NewTool()\n\n// \u96c6\u6210\u5230 Agent\nsearchAgent := llmagent.New(\"search-assistant\",\n    llmagent.WithModel(model),\n    llmagent.WithTools([]tool.Tool{searchTool}))\n</code></pre>"},{"location":"zh/tool/#_10","title":"\u9ad8\u7ea7\u914d\u7f6e","text":"<pre><code>import (\n    \"net/http\"\n    \"time\"\n    \"trpc.group/trpc-go/trpc-agent-go/tool/duckduckgo\"\n)\n\n// \u81ea\u5b9a\u4e49\u914d\u7f6e\nsearchTool := duckduckgo.NewTool(\n    duckduckgo.WithBaseURL(\"https://api.duckduckgo.com\"),\n    duckduckgo.WithUserAgent(\"my-app/1.0\"),\n    duckduckgo.WithHTTPClient(&amp;http.Client{\n        Timeout: 15 * time.Second,\n    }),\n)\n</code></pre>"},{"location":"zh/tool/#mcp-tools","title":"MCP Tools \u534f\u8bae\u5de5\u5177","text":"<p>MCP\uff08Model Context Protocol\uff09\u662f\u4e00\u4e2a\u5f00\u653e\u534f\u8bae\uff0c\u6807\u51c6\u5316\u4e86\u5e94\u7528\u7a0b\u5e8f\u5411 LLM \u63d0\u4f9b\u4e0a\u4e0b\u6587\u7684\u65b9\u5f0f\u3002MCP \u5de5\u5177\u57fa\u4e8e JSON-RPC 2.0 \u534f\u8bae\uff0c\u4e3a Agent \u63d0\u4f9b\u4e86\u4e0e\u5916\u90e8\u670d\u52a1\u7684\u6807\u51c6\u5316\u96c6\u6210\u80fd\u529b\u3002</p> <p>MCP ToolSet \u7279\u70b9\uff1a</p> <ul> <li>\ud83d\udd17 \u7edf\u4e00\u63a5\u53e3\uff1a\u6240\u6709 MCP \u5de5\u5177\u90fd\u901a\u8fc7 <code>mcp.NewMCPToolSet()</code> \u521b\u5efa</li> <li>\ud83d\ude80 \u591a\u79cd\u4f20\u8f93\uff1a\u652f\u6301 STDIO\u3001SSE\u3001Streamable HTTP \u4e09\u79cd\u4f20\u8f93\u65b9\u5f0f</li> <li>\ud83d\udd27 \u5de5\u5177\u8fc7\u6ee4\uff1a\u652f\u6301\u5305\u542b/\u6392\u9664\u7279\u5b9a\u5de5\u5177</li> <li>\u2705 \u663e\u5f0f\u521d\u59cb\u5316\uff1a\u901a\u8fc7 <code>(*mcp.ToolSet).Init(ctx)</code>\uff0c\u53ef\u4ee5\u5728\u5e94\u7528\u542f\u52a8\u9636\u6bb5\u63d0\u524d\u53d1\u73b0 MCP \u8fde\u63a5/\u5de5\u5177\u52a0\u8f7d\u9519\u8bef\u5e76\u5feb\u901f\u5931\u8d25</li> </ul>"},{"location":"zh/tool/#_11","title":"\u57fa\u672c\u7528\u6cd5","text":"<pre><code>import \"trpc.group/trpc-go/trpc-agent-go/tool/mcp\"\n\n// \u521b\u5efa MCP \u5de5\u5177\u96c6\uff08\u4ee5 STDIO \u4e3a\u4f8b\uff09\nmcpToolSet := mcp.NewMCPToolSet(\n    mcp.ConnectionConfig{\n        Transport: \"stdio\",           // \u4f20\u8f93\u65b9\u5f0f\n        Command:   \"go\",              // \u6267\u884c\u547d\u4ee4\n        Args:      []string{\"run\", \"./stdio_server/main.go\"},\n        Timeout:   10 * time.Second,\n    },\n    mcp.WithToolFilterFunc(tool.NewIncludeToolNamesFilter(\"echo\", \"add\")), // \u53ef\u9009\uff1a\u5de5\u5177\u8fc7\u6ee4\n)\n\n// \uff08\u53ef\u9009\u4f46\u63a8\u8350\uff09\u663e\u5f0f\u521d\u59cb\u5316 MCP\uff1a\u5efa\u7acb\u8fde\u63a5 + \u521d\u59cb\u5316\u4f1a\u8bdd + \u5217\u5de5\u5177\nif err := mcpToolSet.Init(ctx); err != nil {\n    log.Fatalf(\"\u521d\u59cb\u5316 MCP \u5de5\u5177\u96c6\u5931\u8d25: %v\", err)\n}\n\n// \u96c6\u6210\u5230 Agent\nagent := llmagent.New(\"mcp-assistant\",\n    llmagent.WithModel(model),\n    llmagent.WithToolSets([]tool.ToolSet{mcpToolSet}))\n</code></pre>"},{"location":"zh/tool/#_12","title":"\u4f20\u8f93\u65b9\u5f0f\u914d\u7f6e","text":"<p>MCP ToolSet \u901a\u8fc7 <code>Transport</code> \u5b57\u6bb5\u652f\u6301\u4e09\u79cd\u4f20\u8f93\u65b9\u5f0f\uff1a</p>"},{"location":"zh/tool/#1-stdio","title":"1. STDIO \u4f20\u8f93","text":"<p>\u901a\u8fc7\u6807\u51c6\u8f93\u5165\u8f93\u51fa\u4e0e\u5916\u90e8\u8fdb\u7a0b\u901a\u4fe1\uff0c\u9002\u7528\u4e8e\u672c\u5730\u811a\u672c\u548c\u547d\u4ee4\u884c\u5de5\u5177\u3002</p> <pre><code>mcpToolSet := mcp.NewMCPToolSet(\n    mcp.ConnectionConfig{\n        Transport: \"stdio\",\n        Command:   \"python\",\n        Args:      []string{\"-m\", \"my_mcp_server\"},\n        Timeout:   10 * time.Second,\n    },\n)\nif err := mcpToolSet.Init(ctx); err != nil {\n    return fmt.Errorf(\"\u521d\u59cb\u5316 STDIO MCP \u5de5\u5177\u96c6\u5931\u8d25: %w\", err)\n}\n</code></pre>"},{"location":"zh/tool/#2-sse","title":"2. SSE \u4f20\u8f93","text":"<p>\u4f7f\u7528 Server-Sent Events \u8fdb\u884c\u901a\u4fe1\uff0c\u652f\u6301\u5b9e\u65f6\u6570\u636e\u63a8\u9001\u548c\u6d41\u5f0f\u54cd\u5e94\u3002</p> <pre><code>mcpToolSet := mcp.NewMCPToolSet(\n    mcp.ConnectionConfig{\n        Transport: \"sse\",\n        ServerURL: \"http://localhost:8080/sse\",\n        Timeout:   10 * time.Second,\n        Headers: map[string]string{\n            \"Authorization\": \"Bearer your-token\",\n        },\n    },\n)\nif err := mcpToolSet.Init(ctx); err != nil {\n    return fmt.Errorf(\"\u521d\u59cb\u5316 SSE MCP \u5de5\u5177\u96c6\u5931\u8d25: %w\", err)\n}\n</code></pre>"},{"location":"zh/tool/#3-streamable-http","title":"3. Streamable HTTP \u4f20\u8f93","text":"<p>\u4f7f\u7528\u6807\u51c6 HTTP \u534f\u8bae\u8fdb\u884c\u901a\u4fe1\uff0c\u652f\u6301\u666e\u901a HTTP \u548c\u6d41\u5f0f\u54cd\u5e94\u3002</p> <pre><code>mcpToolSet := mcp.NewMCPToolSet(\n    mcp.ConnectionConfig{\n        Transport: \"streamable_http\",  // \u6ce8\u610f\uff1a\u4f7f\u7528\u5b8c\u6574\u540d\u79f0\n        ServerURL: \"http://localhost:3000/mcp\",\n        Timeout:   10 * time.Second,\n    },\n)\nif err := mcpToolSet.Init(ctx); err != nil {\n    return fmt.Errorf(\"\u521d\u59cb\u5316 Streamable MCP \u5de5\u5177\u96c6\u5931\u8d25: %w\", err)\n}\n</code></pre>"},{"location":"zh/tool/#_13","title":"\u4f1a\u8bdd\u91cd\u8fde\u652f\u6301","text":"<p>MCP ToolSet \u652f\u6301\u81ea\u52a8\u4f1a\u8bdd\u91cd\u8fde\uff0c\u5f53\u670d\u52a1\u5668\u91cd\u542f\u6216\u4f1a\u8bdd\u8fc7\u671f\u65f6\u81ea\u52a8\u6062\u590d\u8fde\u63a5\u3002</p> <pre><code>// SSE/Streamable HTTP \u4f20\u8f93\u652f\u6301\u4f1a\u8bdd\u91cd\u8fde\nsseToolSet := mcp.NewMCPToolSet(\n    mcp.ConnectionConfig{\n        Transport: \"sse\",\n        ServerURL: \"http://localhost:8080/sse\",\n        Timeout:   10 * time.Second,\n    },\n    mcp.WithSessionReconnect(3), // \u542f\u7528\u4f1a\u8bdd\u91cd\u8fde\uff0c\u6700\u591a\u5c1d\u8bd53\u6b21\n)\n</code></pre> <p>\u91cd\u8fde\u7279\u6027\uff1a</p> <ul> <li>\ud83d\udd04 \u81ea\u52a8\u91cd\u8fde\uff1a\u68c0\u6d4b\u5230\u8fde\u63a5\u65ad\u5f00\u6216\u4f1a\u8bdd\u8fc7\u671f\u65f6\u81ea\u52a8\u91cd\u5efa\u4f1a\u8bdd</li> <li>\ud83c\udfaf \u72ec\u7acb\u91cd\u8bd5\uff1a\u6bcf\u6b21\u5de5\u5177\u8c03\u7528\u72ec\u7acb\u8ba1\u6570\uff0c\u4e0d\u4f1a\u56e0\u65e9\u671f\u5931\u8d25\u5f71\u54cd\u540e\u7eed\u8c03\u7528</li> <li>\ud83d\udee1\ufe0f \u4fdd\u5b88\u7b56\u7565\uff1a\u4ec5\u9488\u5bf9\u660e\u786e\u7684\u8fde\u63a5/\u4f1a\u8bdd\u9519\u8bef\u89e6\u53d1\u91cd\u8fde\uff0c\u907f\u514d\u914d\u7f6e\u9519\u8bef\u5bfc\u81f4\u7684\u65e0\u9650\u5faa\u73af</li> </ul>"},{"location":"zh/tool/#mcp-llmagent","title":"MCP \u5de5\u5177\u7684\u52a8\u6001\u53d1\u73b0\u4e0e\u66f4\u65b0\uff08LLMAgent \u914d\u7f6e\u9879\uff09","text":"<p>\u5bf9\u4e8e MCP \u5de5\u5177\u96c6\uff0c\u670d\u52a1\u5668\u7aef\u7684\u5de5\u5177\u5217\u8868\u662f\u53ef\u4ee5\u53d8\u5316\u7684\uff08\u4f8b\u5982\u5728\u8fd0\u884c \u8fc7\u7a0b\u4e2d\u65b0\u589e\u4e86\u4e00\u4e2a MCP \u5de5\u5177\uff09\u3002\u5982\u679c\u5e0c\u671b LLMAgent \u5728\u6bcf\u6b21\u8c03\u7528 \u65f6\u81ea\u52a8\u770b\u5230\u6700\u65b0\u7684\u5de5\u5177\u5217\u8868\uff0c\u53ef\u4ee5\u5728\u4f7f\u7528 <code>WithToolSets</code> \u7684\u540c\u65f6\uff0c \u5f00\u542f <code>llmagent.WithRefreshToolSetsOnRun(true)</code>\u3002</p>"},{"location":"zh/tool/#llmagent","title":"LLMAgent \u914d\u7f6e\u793a\u4f8b","text":"<pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/agent/llmagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/openai\"\n    \"trpc.group/trpc-go/trpc-agent-go/tool\"\n    \"trpc.group/trpc-go/trpc-agent-go/tool/mcp\"\n)\n\n// 1. \u521b\u5efa MCP \u5de5\u5177\u96c6\uff08\u53ef\u4ee5\u662f STDIO\u3001SSE \u6216 Streamable HTTP\uff09\nmcpToolSet := mcp.NewMCPToolSet(connectionConfig)\n\n// 2. \u521b\u5efa LLMAgent\uff0c\u5e76\u5f00\u542f ToolSets \u7684\u81ea\u52a8\u5237\u65b0\nagent := llmagent.New(\n    \"mcp-assistant\",\n    llmagent.WithModel(openai.New(\"gpt-4o-mini\")),\n    llmagent.WithToolSets([]tool.ToolSet{mcpToolSet}),\n    llmagent.WithRefreshToolSetsOnRun(true),\n)\n</code></pre> <p>\u5f53\u542f\u7528 <code>WithRefreshToolSetsOnRun(true)</code> \u65f6\uff1a</p> <ul> <li>LLMAgent \u5728\u6784\u9020\u5de5\u5177\u5217\u8868\u65f6\uff0c\u4f1a\u518d\u6b21\u8c03\u7528   <code>ToolSet.Tools(context.Background())</code>\uff1b</li> <li>\u5982\u679c MCP \u670d\u52a1\u5668\u65b0\u589e\u6216\u5220\u9664\u4e86\u5de5\u5177\uff0c\u8be5 Agent \u4e0b\u4e00\u6b21\u6267\u884c \u65f6\uff0c   \u4f1a\u81ea\u52a8\u4f7f\u7528\u66f4\u65b0\u540e\u7684\u5de5\u5177\u5217\u8868\u3002</li> </ul> <p>\u8fd9\u4e2a\u914d\u7f6e\u9879\u7684\u4fa7\u91cd\u70b9\u662f\u52a8\u6001\u53d1\u73b0\u5de5\u5177\u3002\u5982\u679c\u4f60\u8fd8\u9700\u8981\u57fa\u4e8e <code>context.Context</code> \u7684\u6bcf\u6b21\u8bf7\u6c42\u52a8\u6001 HTTP \u8bf7\u6c42\u5934\uff08\u4f8b\u5982\u4ece\u4e0a\u4e0b\u6587 \u4e2d\u63d0\u53d6\u8ba4\u8bc1\u4fe1\u606f\uff09\uff0c\u4ecd\u7136\u53ef\u4ee5\u53c2\u8003 <code>examples/mcptool/http_headers</code> \u793a\u4f8b\uff0c\u624b\u52a8\u8c03\u7528 <code>toolSet.Tools(ctx)</code>\uff0c\u7136\u540e\u914d\u5408 <code>WithTools</code> \u4f7f\u7528\u3002</p>"},{"location":"zh/tool/#agent-agenttool","title":"Agent \u5de5\u5177 (AgentTool)","text":"<p>AgentTool \u5141\u8bb8\u628a\u4e00\u4e2a\u73b0\u6709\u7684 Agent \u4ee5\u5de5\u5177\u7684\u5f62\u5f0f\u66b4\u9732\u7ed9\u4e0a\u5c42 Agent \u4f7f\u7528\u3002\u76f8\u6bd4\u666e\u901a\u51fd\u6570\u5de5\u5177\uff0cAgentTool \u7684\u4f18\u52bf\u5728\u4e8e\uff1a</p> <ul> <li>\u2705 \u590d\u7528\uff1a\u5c06\u590d\u6742 Agent \u80fd\u529b\u4f5c\u4e3a\u6807\u51c6\u5de5\u5177\u590d\u7528</li> <li>\ud83c\udf0a \u6d41\u5f0f\uff1a\u53ef\u9009\u62e9\u5c06\u5b50 Agent \u7684\u6d41\u5f0f\u4e8b\u4ef6\u201c\u5185\u8054\u201d\u8f6c\u53d1\u5230\u7236\u6d41\u7a0b</li> <li>\ud83e\udded \u63a7\u5236\uff1a\u901a\u8fc7\u9009\u9879\u63a7\u5236\u662f\u5426\u8df3\u8fc7\u5de5\u5177\u540e\u7684\u603b\u7ed3\u8865\u5168\u3001\u662f\u5426\u8fdb\u884c\u5185\u90e8\u8f6c\u53d1</li> </ul>"},{"location":"zh/tool/#_14","title":"\u57fa\u672c\u7528\u6cd5","text":"<pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/agent/llmagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/model\"\n    \"trpc.group/trpc-go/trpc-agent-go/tool\"\n    agenttool \"trpc.group/trpc-go/trpc-agent-go/tool/agent\"\n)\n\n// 1) \u5b9a\u4e49\u4e00\u4e2a\u53ef\u590d\u7528\u7684\u5b50 Agent\uff08\u53ef\u914d\u7f6e\u4e3a\u6d41\u5f0f\uff09\nmathAgent := llmagent.New(\n    \"math-specialist\",\n    llmagent.WithModel(modelInstance),\n    llmagent.WithInstruction(\"\u4f60\u662f\u6570\u5b66\u4e13\u5bb6...\"),\n    llmagent.WithGenerationConfig(model.GenerationConfig{Stream: true}),\n)\n\n// 2) \u5305\u88c5\u4e3a Agent \u5de5\u5177\nmathTool := agenttool.NewTool(\n    mathAgent,\n    agenttool.WithSkipSummarization(false), // \u53ef\u9009\uff0c\u9ed8\u8ba4 false\uff0c\u5f53\u8bbe\u7f6e\u4e3a true \u65f6\u4f1a\u8df3\u8fc7\u5916\u5c42\u6a21\u578b\u603b\u7ed3\uff0c\u5728 tool.response \u540e\u76f4\u63a5\u7ed3\u675f\u672c\u8f6e\n    agenttool.WithStreamInner(true),        // \u5f00\u542f\uff1a\u628a\u5b50 Agent \u7684\u6d41\u5f0f\u4e8b\u4ef6\u8f6c\u53d1\u7ed9\u7236\u6d41\u7a0b\n)\n\n// 3) \u5728\u7236 Agent \u4e2d\u4f7f\u7528\u8be5\u5de5\u5177\nparent := llmagent.New(\n    \"assistant\",\n    llmagent.WithModel(modelInstance),\n    llmagent.WithGenerationConfig(model.GenerationConfig{Stream: true}),\n    llmagent.WithTools([]tool.Tool{mathTool}),\n)\n</code></pre>"},{"location":"zh/tool/#_15","title":"\u6d41\u5f0f\u5185\u90e8\u8f6c\u53d1\u8be6\u89e3","text":"<p>\u5f53 <code>WithStreamInner(true)</code> \u65f6\uff0cAgentTool \u4f1a\u628a\u5b50 Agent \u5728\u8fd0\u884c\u65f6\u4ea7\u751f\u7684\u4e8b\u4ef6\u76f4\u63a5\u8f6c\u53d1\u5230\u7236\u6d41\u7a0b\u7684\u4e8b\u4ef6\u6d41\u4e2d\uff1a</p> <ul> <li>\u8f6c\u53d1\u7684\u4e8b\u4ef6\u672c\u8d28\u662f\u5b50 Agent \u91cc\u7684 <code>event.Event</code>\uff0c\u5305\u542b\u589e\u91cf\u5185\u5bb9\uff08<code>choice.Delta.Content</code>\uff09</li> <li>\u4e3a\u907f\u514d\u91cd\u590d\uff0c\u5b50 Agent \u5728\u7ed3\u675f\u65f6\u4ea7\u751f\u7684\u201c\u5b8c\u6574\u5927\u6bb5\u5185\u5bb9\u201d\u4e0d\u4f1a\u518d\u6b21\u4f5c\u4e3a\u8f6c\u53d1\u4e8b\u4ef6\u6253\u5370\uff1b\u4f46\u4f1a\u88ab\u805a\u5408\u5230\u6700\u7ec8 <code>tool.response</code> \u7684\u5185\u5bb9\u91cc\uff0c\u4f9b\u4e0b\u4e00\u6b21 LLM \u8c03\u7528\u4f5c\u4e3a\u5de5\u5177\u6d88\u606f\u4f7f\u7528</li> <li>UI \u5c42\u5efa\u8bae\uff1a\u5c55\u793a\u201c\u8f6c\u53d1\u7684\u5b50 Agent \u589e\u91cf\u5185\u5bb9\u201d\uff0c\u4f46\u9ed8\u8ba4\u4e0d\u91cd\u590d\u6253\u5370\u6700\u7ec8\u805a\u5408\u7684 <code>tool.response</code> \u5185\u5bb9\uff08\u9664\u975e\u7528\u4e8e\u8c03\u8bd5\uff09</li> </ul> <p>\u793a\u4f8b\uff1a\u4ec5\u5728\u9700\u8981\u65f6\u663e\u793a\u5de5\u5177\u7247\u6bb5\uff0c\u907f\u514d\u91cd\u590d\u8f93\u51fa</p> <pre><code>if ev.Response != nil &amp;&amp; ev.Object == model.ObjectTypeToolResponse {\n    // \u5de5\u5177\u54cd\u5e94\uff08\u5305\u542b\u805a\u5408\u540e\u7684\u5185\u5bb9\uff09\uff0c\u9ed8\u8ba4\u4e0d\u6253\u5370\uff0c\u907f\u514d\u548c\u5b50 Agent \u8f6c\u53d1\u7684\u5185\u5bb9\u91cd\u590d\n    // ...\u4ec5\u5728\u8c03\u8bd5\u6216\u9700\u8981\u5c55\u793a\u5de5\u5177\u7ec6\u8282\u65f6\u518d\u6253\u5370\n}\n\n// \u5b50 Agent \u8f6c\u53d1\u7684\u6d41\u5f0f\u589e\u91cf\uff08\u4f5c\u8005\u4e0d\u662f\u7236 Agent\uff09\nif ev.Author != parentName &amp;&amp; len(ev.Choices) &gt; 0 {\n    if delta := ev.Choices[0].Delta.Content; delta != \"\" {\n        fmt.Print(delta)\n    }\n}\n</code></pre>"},{"location":"zh/tool/#_16","title":"\u9009\u9879\u8bf4\u660e","text":"<ul> <li> <p>WithSkipSummarization(bool)\uff1a</p> <ul> <li>false\uff08\u9ed8\u8ba4\uff09\uff1a\u5141\u8bb8\u5728\u5de5\u5177\u7ed3\u679c\u540e\u7ee7\u7eed\u4e00\u6b21 LLM \u8c03\u7528\u8fdb\u884c\u603b\u7ed3/\u56de\u7b54</li> <li>true\uff1a\u5916\u5c42 Flow \u5728 <code>tool.response</code> \u540e\u76f4\u63a5\u7ed3\u675f\u672c\u8f6e\uff08\u4e0d\u518d\u989d\u5916\u603b\u7ed3\uff09</li> </ul> </li> </ul> <ul> <li> <p>WithStreamInner(bool)\uff1a</p> <ul> <li>true\uff1a\u628a\u5b50 Agent \u7684\u4e8b\u4ef6\u76f4\u63a5\u8f6c\u53d1\u5230\u7236\u6d41\u7a0b\uff08\u5f3a\u70c8\u5efa\u8bae\u7236/\u5b50 Agent \u90fd\u5f00\u542f <code>GenerationConfig{Stream: true}</code>\uff09</li> <li>false\uff1a\u6309\u201c\u4ec5\u53ef\u8c03\u7528\u5de5\u5177\u201d\u5904\u7406\uff0c\u4e0d\u505a\u5185\u90e8\u4e8b\u4ef6\u8f6c\u53d1</li> </ul> </li> </ul> <ul> <li>WithHistoryScope(HistoryScope)\uff1a<ul> <li><code>HistoryScopeIsolated</code>\uff08\u9ed8\u8ba4\uff09\uff1a\u4fdd\u6301\u5b50\u8c03\u7528\u5b8c\u5168\u9694\u79bb\uff0c\u53ea\u8bfb\u53d6\u672c\u6b21\u5de5\u5177\u53c2\u6570\uff08\u4e0d\u7ee7\u627f\u7236\u5386\u53f2\uff09\u3002</li> <li><code>HistoryScopeParentBranch</code>\uff1a\u901a\u8fc7\u5206\u5c42\u8fc7\u6ee4\u952e <code>\u7236\u952e/\u5b50\u540d-UUID\uff08Universally Unique Identifier\uff0c\u901a\u7528\u552f\u4e00\u8bc6\u522b\u7801\uff09</code> \u7ee7\u627f\u7236\u4f1a\u8bdd\u5386\u53f2\uff1b\u5185\u5bb9\u5904\u7406\u5668\u4f1a\u57fa\u4e8e\u524d\u7f00\u5339\u914d\u7eb3\u5165\u7236\u4e8b\u4ef6\uff0c\u540c\u65f6\u5b50\u4e8b\u4ef6\u4ecd\u5199\u5165\u72ec\u7acb\u5b50\u5206\u652f\u3002\u5178\u578b\u573a\u666f\uff1a\u57fa\u4e8e\u4e0a\u4e00\u8f6e\u4ea7\u51fa\u8fdb\u884c\u201c\u7f16\u8f91/\u4f18\u5316/\u7eed\u5199\u201d\u3002</li> </ul> </li> </ul> <p>\u793a\u4f8b\uff1a</p> <pre><code>child := agenttool.NewTool(\n    childAgent,\n    agenttool.WithSkipSummarization(false),\n    agenttool.WithStreamInner(true),\n    agenttool.WithHistoryScope(agenttool.HistoryScopeParentBranch),\n)\n</code></pre>"},{"location":"zh/tool/#_17","title":"\u6ce8\u610f\u4e8b\u9879","text":"<ul> <li>\u4e8b\u4ef6\u5b8c\u6210\u4fe1\u53f7\uff1a\u5de5\u5177\u54cd\u5e94\u4e8b\u4ef6\u4f1a\u88ab\u6807\u8bb0 <code>RequiresCompletion=true</code>\uff0cRunner \u4f1a\u81ea\u52a8\u53d1\u9001\u5b8c\u6210\u4fe1\u53f7\uff0c\u65e0\u9700\u624b\u5de5\u5904\u7406</li> <li>\u5185\u5bb9\u53bb\u91cd\uff1a\u5982\u679c\u5df2\u8f6c\u53d1\u5b50 Agent \u7684\u589e\u91cf\u5185\u5bb9\uff0c\u9ed8\u8ba4\u4e0d\u8981\u518d\u628a\u6700\u7ec8 <code>tool.response</code> \u7684\u805a\u5408\u5185\u5bb9\u6253\u5370\u51fa\u6765</li> <li>\u6a21\u578b\u517c\u5bb9\u6027\uff1a\u4e00\u4e9b\u6a21\u578b\u8981\u6c42\u5de5\u5177\u8c03\u7528\u540e\u5fc5\u987b\u8ddf\u968f\u5de5\u5177\u6d88\u606f\uff0cAgentTool \u5df2\u81ea\u52a8\u586b\u5145\u805a\u5408\u540e\u7684\u5de5\u5177\u5185\u5bb9\u6ee1\u8db3\u6b64\u8981\u6c42</li> </ul>"},{"location":"zh/tool/#_18","title":"\u5de5\u5177\u96c6\u6210\u4e0e\u4f7f\u7528","text":""},{"location":"zh/tool/#agent","title":"\u521b\u5efa Agent \u4e0e\u5de5\u5177\u96c6\u6210","text":"<pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/agent/llmagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/tool\"\n    \"trpc.group/trpc-go/trpc-agent-go/tool/function\"\n    \"trpc.group/trpc-go/trpc-agent-go/tool/duckduckgo\"\n    \"trpc.group/trpc-go/trpc-agent-go/tool/mcp\"\n)\n\n// \u521b\u5efa\u51fd\u6570\u5de5\u5177\ncalculatorTool := function.NewFunctionTool(calculator,\n    function.WithName(\"calculator\"),\n    function.WithDescription(\"\u6267\u884c\u57fa\u7840\u6570\u5b66\u8fd0\u7b97\"))\n\ntimeTool := function.NewFunctionTool(getCurrentTime,\n    function.WithName(\"current_time\"),\n    function.WithDescription(\"\u83b7\u53d6\u5f53\u524d\u65f6\u95f4\"))\n\n// \u521b\u5efa\u5185\u7f6e\u5de5\u5177\nsearchTool := duckduckgo.NewTool()\n\n// \u521b\u5efa MCP \u5de5\u5177\u96c6\uff08\u4e0d\u540c\u4f20\u8f93\u65b9\u5f0f\u7684\u793a\u4f8b\uff09\nstdioToolSet := mcp.NewMCPToolSet(\n    mcp.ConnectionConfig{\n        Transport: \"stdio\",\n        Command:   \"python\",\n        Args:      []string{\"-m\", \"my_mcp_server\"},\n        Timeout:   10 * time.Second,\n    },\n)\n\nsseToolSet := mcp.NewMCPToolSet(\n    mcp.ConnectionConfig{\n        Transport: \"sse\",\n        ServerURL: \"http://localhost:8080/sse\",\n        Timeout:   10 * time.Second,\n    },\n)\n\nstreamableToolSet := mcp.NewMCPToolSet(\n    mcp.ConnectionConfig{\n        Transport: \"streamable_http\",\n        ServerURL: \"http://localhost:3000/mcp\",\n        Timeout:   10 * time.Second,\n    },\n)\n\n// \u521b\u5efa Agent \u5e76\u96c6\u6210\u6240\u6709\u5de5\u5177\nagent := llmagent.New(\"ai-assistant\",\n    llmagent.WithModel(model),\n    llmagent.WithInstruction(\"\u4f60\u662f\u4e00\u4e2a\u6709\u5e2e\u52a9\u7684AI\u52a9\u624b\uff0c\u53ef\u4ee5\u4f7f\u7528\u591a\u79cd\u5de5\u5177\u534f\u52a9\u7528\u6237\"),\n    // \u6dfb\u52a0\u5355\u4e2a\u5de5\u5177\uff08Tool \u63a5\u53e3\uff09\n    llmagent.WithTools([]tool.Tool{\n        calculatorTool, timeTool, searchTool,\n    }),\n    // \u6dfb\u52a0\u5de5\u5177\u96c6\uff08ToolSet \u63a5\u53e3\uff09\n    llmagent.WithToolSets([]tool.ToolSet{\n        stdioToolSet, sseToolSet, streamableToolSet,\n    }),\n)\n</code></pre>"},{"location":"zh/tool/#mcp","title":"MCP \u5de5\u5177\u8fc7\u6ee4\u5668","text":"<p>MCP \u5de5\u5177\u96c6\u652f\u6301\u5728\u521b\u5efa\u65f6\u8fc7\u6ee4\u5de5\u5177\u3002\u63a8\u8350\u4f7f\u7528\u7edf\u4e00\u7684 <code>tool.FilterFunc</code> \u63a5\u53e3\uff1a</p> <pre><code>import (\n    \"trpc.group/trpc-go/trpc-agent-go/tool\"\n    \"trpc.group/trpc-go/trpc-agent-go/tool/mcp\"\n)\n\n// \u2705 \u63a8\u8350\uff1a\u4f7f\u7528\u7edf\u4e00\u7684\u8fc7\u6ee4\u63a5\u53e3\nincludeFilter := tool.NewIncludeToolNamesFilter(\"get_weather\", \"get_news\", \"calculator\")\nexcludeFilter := tool.NewExcludeToolNamesFilter(\"deprecated_tool\", \"slow_tool\")\n\n// \u5e94\u7528\u8fc7\u6ee4\u5668\ntoolSet := mcp.NewMCPToolSet(\n    connectionConfig,\n    mcp.WithToolFilterFunc(includeFilter),\n)\n</code></pre>"},{"location":"zh/tool/#_19","title":"\u8fd0\u884c\u65f6\u5de5\u5177\u8fc7\u6ee4","text":"<ul> <li>\u65b9\u5f0f\u4e00\uff1a\u8fd0\u884c\u65f6\u5de5\u5177\u8fc7\u6ee4\u5141\u8bb8\u5728\u6bcf\u6b21 <code>runner.Run</code> \u8c03\u7528\u65f6\u52a8\u6001\u63a7\u5236\u5de5\u5177\u53ef\u7528\u6027\uff0c\u65e0\u9700\u4fee\u6539 Agent \u914d\u7f6e\u3002\u8fd9\u662f\u4e00\u4e2a\"\u8f6f\u7ea6\u675f\"\u673a\u5236\uff0c\u7528\u4e8e\u4f18\u5316 token \u6d88\u8017\u548c\u5b9e\u73b0\u57fa\u4e8e\u89d2\u8272\u7684\u5de5\u5177\u8bbf\u95ee\u63a7\u5236\u3002\u9488\u5bf9\u6240\u6709agent\u751f\u6548</li> <li>\u65b9\u5f0f\u4e8c\uff1a\u901a\u8fc7<code>llmagent.WithToolFilter</code>\u914d\u7f6e\u8fd0\u884c\u65f6\u8fc7\u6ee4function, \u53ea\u5bf9\u5f53\u524dagent\u751f\u6548</li> </ul> <p>\u6838\u5fc3\u7279\u6027\uff1a</p> <ul> <li>\ud83c\udfaf Per-Run \u63a7\u5236\uff1a\u6bcf\u6b21\u8c03\u7528\u72ec\u7acb\u914d\u7f6e\uff0c\u4e0d\u5f71\u54cd Agent \u5b9a\u4e49</li> <li>\ud83d\udcb0 \u6210\u672c\u4f18\u5316\uff1a\u51cf\u5c11\u53d1\u9001\u7ed9 LLM \u7684\u5de5\u5177\u63cf\u8ff0\uff0c\u964d\u4f4e token \u6d88\u8017</li> <li>\ud83d\udee1\ufe0f \u667a\u80fd\u4fdd\u62a4\uff1a\u6846\u67b6\u5de5\u5177\uff08<code>transfer_to_agent</code>\u3001<code>knowledge_search</code>\uff09\u81ea\u52a8\u4fdd\u7559\uff0c\u6c38\u4e0d\u88ab\u8fc7\u6ee4</li> <li>\ud83d\udd27 \u7075\u6d3b\u5b9a\u5236\uff1a\u652f\u6301\u5185\u7f6e\u8fc7\u6ee4\u5668\u548c\u81ea\u5b9a\u4e49 FilterFunc</li> </ul>"},{"location":"zh/tool/#_20","title":"\u57fa\u672c\u7528\u6cd5","text":"<p>1. \u6392\u9664\u7279\u5b9a\u5de5\u5177\uff08Exclude Filter\uff09</p> <p>\u4f7f\u7528\u9ed1\u540d\u5355\u65b9\u5f0f\u6392\u9664\u4e0d\u9700\u8981\u7684\u5de5\u5177\uff1a</p> <pre><code>import \"trpc.group/trpc-go/trpc-agent-go/tool\"\n\n// \u6392\u9664 text_tool\uff0c\u5176\u4ed6\u5de5\u5177\u90fd\u53ef\u7528\nfilter := tool.NewExcludeToolNamesFilter(\"text_tool\", \"dangerous_tool\")\neventChan, err := runner.Run(ctx, userID, sessionID, message,\n    agent.WithToolFilter(filter),\n)\n</code></pre> <p>2. \u53ea\u5141\u8bb8\u7279\u5b9a\u5de5\u5177\uff08Include Filter\uff09</p> <p>\u4f7f\u7528\u767d\u540d\u5355\u65b9\u5f0f\u53ea\u5141\u8bb8\u6307\u5b9a\u7684\u5de5\u5177\uff1a</p> <pre><code>// \u65b9\u5f0f\u4e00\uff1a\n// \u53ea\u5141\u8bb8\u4f7f\u7528\u8ba1\u7b97\u5668\u548c\u65f6\u95f4\u5de5\u5177\nfilter := tool.NewIncludeToolNamesFilter(\"calculator\", \"time_tool\")\neventChan, err := runner.Run(ctx, userID, sessionID, message,\n    agent.WithToolFilter(filter),\n)\n\n// \u65b9\u5f0f\u4e8c\uff1a\nagent := llmagent.New(\"ai-assistant\",\n    llmagent.WithModel(model),\n    llmagent.WithInstruction(\"\u4f60\u662f\u4e00\u4e2a\u6709\u5e2e\u52a9\u7684AI\u52a9\u624b\uff0c\u53ef\u4ee5\u4f7f\u7528\u591a\u79cd\u5de5\u5177\u534f\u52a9\u7528\u6237\"),\n    // \u6dfb\u52a0\u5355\u4e2a\u5de5\u5177\uff08Tool \u63a5\u53e3\uff09\n    llmagent.WithTools([]tool.Tool{\n        calculatorTool, timeTool, searchTool,\n    }),\n    // \u6dfb\u52a0\u5de5\u5177\u96c6\uff08ToolSet \u63a5\u53e3\uff09\n    llmagent.WithToolSets([]tool.ToolSet{\n        stdioToolSet, sseToolSet, streamableToolSet,\n    }),\n    llmagent.WithToolFilter(filter),\n)\n</code></pre> <p>3. \u81ea\u5b9a\u4e49\u8fc7\u6ee4\u903b\u8f91\uff08Custom FilterFunc\uff09</p> <p>\u5b9e\u73b0\u81ea\u5b9a\u4e49\u8fc7\u6ee4\u51fd\u6570\u4ee5\u652f\u6301\u590d\u6742\u7684\u8fc7\u6ee4\u903b\u8f91\uff1a</p> <pre><code>// \u65b9\u5f0f\u4e00\uff1a\n// \u81ea\u5b9a\u4e49\u8fc7\u6ee4\u51fd\u6570\uff1a\u53ea\u5141\u8bb8\u540d\u79f0\u4ee5 \"safe_\" \u5f00\u5934\u7684\u5de5\u5177\nfilter := func(ctx context.Context, t tool.Tool) bool {\n    declaration := t.Declaration()\n    if declaration == nil {\n        return false\n    }\n    return strings.HasPrefix(declaration.Name, \"safe_\")\n}\n\neventChan, err := runner.Run(ctx, userID, sessionID, message,\n    agent.WithToolFilter(filter),\n)\n\n// \u65b9\u5f0f\u4e8c\uff1a\nagent := llmagent.New(\"ai-assistant\",\n    llmagent.WithModel(model),\n    llmagent.WithInstruction(\"\u4f60\u662f\u4e00\u4e2a\u6709\u5e2e\u52a9\u7684AI\u52a9\u624b\uff0c\u53ef\u4ee5\u4f7f\u7528\u591a\u79cd\u5de5\u5177\u534f\u52a9\u7528\u6237\"),\n    // \u6dfb\u52a0\u5355\u4e2a\u5de5\u5177\uff08Tool \u63a5\u53e3\uff09\n    llmagent.WithTools([]tool.Tool{\n        calculatorTool, timeTool, searchTool,\n    }),\n    // \u6dfb\u52a0\u5de5\u5177\u96c6\uff08ToolSet \u63a5\u53e3\uff09\n    llmagent.WithToolSets([]tool.ToolSet{\n        stdioToolSet, sseToolSet, streamableToolSet,\n    }),\n    llmagent.WithToolFilter(filter),\n)\n</code></pre> <p>4. Agent \u7c92\u5ea6\u8fc7\u6ee4\uff08Per-Agent Filtering\uff09</p> <p>\u901a\u8fc7 <code>agent.InvocationFromContext</code> \u5b9e\u73b0\u4e0d\u540c Agent \u4f7f\u7528\u4e0d\u540c\u5de5\u5177\uff1a</p> <pre><code>// \u4e3a\u4e0d\u540c Agent \u5b9a\u4e49\u5141\u8bb8\u7684\u5de5\u5177\nagentAllowedTools := map[string]map[string]bool{\n    \"math-agent\": {\n        \"calculator\": true,\n    },\n    \"time-agent\": {\n        \"time_tool\": true,\n    },\n}\n\n// \u81ea\u5b9a\u4e49\u8fc7\u6ee4\u51fd\u6570\uff1a\u6839\u636e\u5f53\u524d Agent \u540d\u79f0\u8fc7\u6ee4\nfilter := func(ctx context.Context, t tool.Tool) bool {\n    declaration := t.Declaration()\n    if declaration == nil {\n        return false\n    }\n    toolName := declaration.Name\n\n    // \u4ece context \u83b7\u53d6\u5f53\u524d Agent \u4fe1\u606f\n    inv, ok := agent.InvocationFromContext(ctx)\n    if !ok || inv == nil {\n        return true // fallback: \u5141\u8bb8\u6240\u6709\u5de5\u5177\n    }\n\n    agentName := inv.AgentName\n\n    // \u68c0\u67e5\u8be5\u5de5\u5177\u662f\u5426\u5728\u5f53\u524d Agent \u7684\u5141\u8bb8\u5217\u8868\u4e2d\n    allowedTools, exists := agentAllowedTools[agentName]\n    if !exists {\n        return true // fallback: \u5141\u8bb8\u6240\u6709\u5de5\u5177\n    }\n\n    return allowedTools[toolName]\n}\n\neventChan, err := runner.Run(ctx, userID, sessionID, message,\n    agent.WithToolFilter(filter),\n)\n</code></pre> <p>\u5b8c\u6574\u793a\u4f8b\uff1a \u53c2\u89c1 <code>examples/toolfilter/</code> \u76ee\u5f55</p>"},{"location":"zh/tool/#_21","title":"\u667a\u80fd\u8fc7\u6ee4\u673a\u5236","text":"<p>\u6846\u67b6\u4f1a\u81ea\u52a8\u533a\u5206\u7528\u6237\u5de5\u5177\u548c\u6846\u67b6\u5de5\u5177\uff0c\u53ea\u8fc7\u6ee4\u7528\u6237\u5de5\u5177\uff1a</p> \u5de5\u5177\u5206\u7c7b \u5305\u542b\u7684\u5de5\u5177 \u662f\u5426\u88ab\u8fc7\u6ee4 \u7528\u6237\u5de5\u5177 \u901a\u8fc7 <code>WithTools</code> \u6ce8\u518c\u7684\u5de5\u5177\u901a\u8fc7 <code>WithToolSets</code> \u6ce8\u518c\u7684\u5de5\u5177 \u2705 \u53d7\u8fc7\u6ee4\u63a7\u5236 \u6846\u67b6\u5de5\u5177 <code>transfer_to_agent</code>\uff08\u591a Agent \u534f\u8c03\uff09<code>knowledge_search</code>\uff08\u77e5\u8bc6\u5e93\u68c0\u7d22\uff09<code>agentic_knowledge_search</code> \u274c \u6c38\u4e0d\u8fc7\u6ee4\uff0c\u81ea\u52a8\u4fdd\u7559 <p>\u793a\u4f8b\uff1a</p> <pre><code>// Agent \u6ce8\u518c\u4e86\u591a\u4e2a\u5de5\u5177\nagent := llmagent.New(\"assistant\",\n    llmagent.WithTools([]tool.Tool{\n        calculatorTool,  // \u7528\u6237\u5de5\u5177\n        textTool,        // \u7528\u6237\u5de5\u5177\n    }),\n    llmagent.WithSubAgents([]agent.Agent{subAgent1, subAgent2}), // \u81ea\u52a8\u6dfb\u52a0 transfer_to_agent\n    llmagent.WithKnowledge(kb),                                   // \u81ea\u52a8\u6dfb\u52a0 knowledge_search\n)\n\n// \u8fd0\u884c\u65f6\u8fc7\u6ee4\uff1a\u53ea\u5141\u8bb8 calculator\nfilter := tool.NewIncludeToolNamesFilter(\"calculator\")\nrunner.Run(ctx, userID, sessionID, message,\n    agent.WithToolFilter(filter),\n)\n\n// \u5b9e\u9645\u53d1\u9001\u7ed9 LLM \u7684\u5de5\u5177\uff1a\n// \u2705 calculator        - \u7528\u6237\u5de5\u5177\uff0c\u5728\u5141\u8bb8\u5217\u8868\u4e2d\n// \u274c textTool          - \u7528\u6237\u5de5\u5177\uff0c\u88ab\u8fc7\u6ee4\n// \u2705 transfer_to_agent - \u6846\u67b6\u5de5\u5177\uff0c\u81ea\u52a8\u4fdd\u7559\n// \u2705 knowledge_search  - \u6846\u67b6\u5de5\u5177\uff0c\u81ea\u52a8\u4fdd\u7559\n</code></pre>"},{"location":"zh/tool/#_22","title":"\u6ce8\u610f\u4e8b\u9879","text":"<p>\u26a0\ufe0f \u5b89\u5168\u63d0\u793a\uff1a \u8fd0\u884c\u65f6\u5de5\u5177\u8fc7\u6ee4\u662f\"\u8f6f\u7ea6\u675f\"\uff0c\u4e3b\u8981\u7528\u4e8e\u4f18\u5316\u548c\u7528\u6237\u4f53\u9a8c\u3002\u5de5\u5177\u5185\u90e8\u4ecd\u9700\u5b9e\u73b0\u81ea\u5df1\u7684\u9274\u6743\u903b\u8f91\uff1a</p> <pre><code>func sensitiveOperation(ctx context.Context, req Request) (Result, error) {\n    // \u2705 \u5fc5\u987b\uff1a\u5de5\u5177\u5185\u90e8\u9274\u6743\n    if !hasPermission(ctx, req.UserID, \"sensitive_operation\") {\n        return nil, fmt.Errorf(\"permission denied\")\n    }\n\n    // \u6267\u884c\u64cd\u4f5c\n    return performOperation(req)\n}\n</code></pre> <p>\u539f\u56e0\uff1a LLM \u53ef\u80fd\u4ece\u4e0a\u4e0b\u6587\u6216\u8bb0\u5fc6\u4e2d\u77e5\u9053\u5de5\u5177\u7684\u5b58\u5728\u548c\u7528\u6cd5\uff0c\u5e76\u5c1d\u8bd5\u8c03\u7528\u3002\u5de5\u5177\u8fc7\u6ee4\u51cf\u5c11\u4e86\u8fd9\u79cd\u53ef\u80fd\u6027\uff0c\u4f46\u4e0d\u80fd\u5b8c\u5168\u9632\u6b62\u3002</p>"},{"location":"zh/tool/#_23","title":"\u5e76\u884c\u5de5\u5177\u6267\u884c","text":"<pre><code>// \u542f\u7528\u5e76\u884c\u5de5\u5177\u6267\u884c\uff08\u53ef\u9009\uff0c\u7528\u4e8e\u6027\u80fd\u4f18\u5316\uff09\nagent := llmagent.New(\"ai-assistant\",\n    llmagent.WithModel(model),\n    llmagent.WithTools(tools),\n    llmagent.WithToolSets(toolSets),\n    llmagent.WithEnableParallelTools(true), // \u542f\u7528\u5e76\u884c\u6267\u884c\n)\n</code></pre> <p>Graph \u5de5\u4f5c\u6d41\u4e0b\u4e5f\u53ef\u4ee5\u5728\u5de5\u5177\u8282\u70b9\u5f00\u542f\u5e76\u884c\uff1a</p> <pre><code>stateGraph.AddToolsNode(\"tools\", tools, graph.WithEnableParallelTools(true))\n</code></pre> <p>\u5e76\u884c\u6267\u884c\u6548\u679c\uff1a</p> <pre><code># \u5e76\u884c\u6267\u884c\uff08\u542f\u7528\u65f6\uff09\nTool 1: get_weather     [====] 50ms\nTool 2: get_population  [====] 50ms\nTool 3: get_time       [====] 50ms\n\u603b\u65f6\u95f4: ~50ms\uff08\u540c\u65f6\u6267\u884c\uff09\n\n# \u4e32\u884c\u6267\u884c\uff08\u9ed8\u8ba4\uff09\nTool 1: get_weather     [====] 50ms\nTool 2: get_population       [====] 50ms\nTool 3: get_time                  [====] 50ms\n\u603b\u65f6\u95f4: ~150ms\uff08\u4f9d\u6b21\u6267\u884c\uff09\n</code></pre>"},{"location":"zh/tool/#toolset_1","title":"\u8fd0\u884c\u65f6 ToolSet \u52a8\u6001\u7ba1\u7406","text":"<p><code>WithToolSets</code> \u662f\u4e00\u79cd\u9759\u6001\u914d\u7f6e\u65b9\u5f0f\uff1a\u5728\u521b\u5efa Agent \u65f6\u4e00\u6b21\u6027\u6ce8\u5165 ToolSet\u3002\u5f88\u591a\u5b9e\u9645\u573a\u666f\u4e0b\uff0c\u4f60\u5e0c\u671b\u5728\u8fd0\u884c\u65f6\u52a8\u6001\u589e\u5220 ToolSet\uff0c\u800c\u4e0d\u5fc5\u91cd\u5efa Agent\u3002</p> <p>LLMAgent \u63d0\u4f9b\u4e86\u4e09\u4e2a\u4e0e ToolSet \u76f8\u5173\u7684\u8fd0\u884c\u65f6\u65b9\u6cd5\uff1a</p> <ul> <li><code>AddToolSet(toolSet tool.ToolSet)</code> \u2014\u2014 \u6309 <code>ToolSet.Name()</code> \u6dfb\u52a0\u6216\u66ff\u6362\u540c\u540d ToolSet</li> <li><code>RemoveToolSet(name string) bool</code> \u2014\u2014 \u6309\u540d\u79f0\u79fb\u9664\u6240\u6709\u540c\u540d ToolSet\uff0c\u8fd4\u56de\u662f\u5426\u786e\u5b9e\u5220\u9664</li> <li><code>SetToolSets(toolSets []tool.ToolSet)</code> \u2014\u2014 \u4ee5\u7ed9\u5b9a\u5207\u7247\u6574\u4f53\u66ff\u6362\u5f53\u524d\u6240\u6709 ToolSet</li> </ul> <p>\u8fd9\u4e9b\u65b9\u6cd5\u662f\u5e76\u53d1\u5b89\u5168\u7684\uff0c\u5e76\u4f1a\u81ea\u52a8\u91cd\u65b0\u8ba1\u7b97\uff1a</p> <ul> <li>\u805a\u5408\u540e\u7684\u5de5\u5177\u5217\u8868\uff08\u663e\u5f0f <code>WithTools</code> \u5de5\u5177 + ToolSet \u5de5\u5177 + \u77e5\u8bc6\u68c0\u7d22\u5de5\u5177 + Skills \u5de5\u5177\uff09</li> <li>\u201c\u7528\u6237\u5de5\u5177\u201d\u8ddf\u8e2a\u4fe1\u606f\uff08\u7528\u4e8e\u524d\u6587\u4ecb\u7ecd\u7684\u667a\u80fd\u8fc7\u6ee4\u673a\u5236\uff09</li> </ul> <p>\u5178\u578b\u4f7f\u7528\u65b9\u5f0f\uff1a</p> <pre><code>// 1. \u521d\u59cb\u53ea\u6302\u57fa\u7840\u5de5\u5177\nagent := llmagent.New(\"dynamic-assistant\",\n    llmagent.WithModel(model),\n    llmagent.WithTools([]tool.Tool{calculatorTool}),\n)\n\n// 2. \u8fd0\u884c\u65f6\u6302\u8f7d\u4e00\u4e2a MCP ToolSet\nmcpToolSet := mcp.NewMCPToolSet(connectionConfig)\nif err := mcpToolSet.Init(ctx); err != nil {\n    return fmt.Errorf(\"\u521d\u59cb\u5316 MCP ToolSet \u5931\u8d25: %w\", err)\n}\nagent.AddToolSet(mcpToolSet)\n\n// 3. \u4ece\u914d\u7f6e\u4e2d\u5fc3\u4e0b\u53d1\u4e00\u6574\u5957 ToolSet\uff08\u58f0\u660e\u5f0f\u63a7\u5236\uff09\ntoolSetsFromConfig := []tool.ToolSet{mcpToolSet, fileToolSet}\nagent.SetToolSets(toolSetsFromConfig)\n\n// 4. \u6309\u540d\u79f0\u4e0b\u7ebf\u67d0\u4e2a ToolSet\uff08\u4f8b\u5982\u56de\u6eda\u67d0\u4e2a\u96c6\u6210\uff09\nremoved := agent.RemoveToolSet(mcpToolSet.Name())\nif !removed {\n    log.Printf(\"\u672a\u627e\u5230 ToolSet %q\", mcpToolSet.Name())\n}\n</code></pre> <p>\u8fd0\u884c\u65f6 ToolSet \u66f4\u65b0\u4f1a\u81ea\u52a8\u4e0e\u524d\u6587\u7684\u5de5\u5177\u8fc7\u6ee4\u673a\u5236\u534f\u540c\u5de5\u4f5c\uff1a</p> <ul> <li>\u901a\u8fc7 <code>WithTools</code> \u548c\u6240\u6709 ToolSet\uff08\u5305\u62ec\u52a8\u6001\u6dfb\u52a0\u7684 ToolSet\uff09\u6ce8\u518c\u7684\u5de5\u5177\u90fd\u89c6\u4e3a\u7528\u6237\u5de5\u5177\uff0c\u4f1a\u53d7\u5230 <code>WithToolFilter</code> \u4ee5\u53ca\u6bcf\u6b21\u8c03\u7528\u7684\u8fd0\u884c\u65f6\u8fc7\u6ee4\u63a7\u5236\u3002</li> <li>\u6846\u67b6\u5de5\u5177\uff08<code>transfer_to_agent</code>\u3001<code>knowledge_search</code>\u3001<code>agentic_knowledge_search</code>\uff09\u4ecd\u7136\u6c38\u8fdc\u4e0d\u88ab\u8fc7\u6ee4\uff0c\u59cb\u7ec8\u5bf9 Agent \u53ef\u7528\u3002</li> </ul>"},{"location":"zh/tool/#_24","title":"\u5feb\u901f\u5f00\u59cb","text":""},{"location":"zh/tool/#_25","title":"\u73af\u5883\u51c6\u5907","text":"<pre><code># \u8bbe\u7f6e API \u5bc6\u94a5\nexport OPENAI_API_KEY=\"your-api-key\"\n</code></pre>"},{"location":"zh/tool/#_26","title":"\u7b80\u5355\u793a\u4f8b","text":"<pre><code>package main\n\nimport (\n    \"context\"\n    \"fmt\"\n\n    \"trpc.group/trpc-go/trpc-agent-go/runner\"\n    \"trpc.group/trpc-go/trpc-agent-go/agent/llmagent\"\n    \"trpc.group/trpc-go/trpc-agent-go/model/openai\"\n    \"trpc.group/trpc-go/trpc-agent-go/model\"\n    \"trpc.group/trpc-go/trpc-agent-go/tool/function\"\n)\n\nfunc main() {\n    // 1. \u521b\u5efa\u7b80\u5355\u5de5\u5177\n    calculatorTool := function.NewFunctionTool(\n        func(ctx context.Context, req struct {\n            Operation string  `json:\"operation\"`\n            A         float64 `json:\"a\"`\n            B         float64 `json:\"b\"`\n        }) (map[string]interface{}, error) {\n            var result float64\n            switch req.Operation {\n            case \"add\":\n                result = req.A + req.B\n            case \"multiply\":\n                result = req.A * req.B\n            default:\n                return nil, fmt.Errorf(\"unsupported operation\")\n            }\n            return map[string]interface{}{\"result\": result}, nil\n        },\n        function.WithName(\"calculator\"),\n        function.WithDescription(\"\u7b80\u5355\u8ba1\u7b97\u5668\"),\n    )\n\n    // 2. \u521b\u5efa\u6a21\u578b\u548c Agent\n    llmModel := openai.New(\"DeepSeek-V3-Online-64K\")\n    agent := llmagent.New(\"calculator-assistant\",\n        llmagent.WithModel(llmModel),\n        llmagent.WithInstruction(\"\u4f60\u662f\u4e00\u4e2a\u6570\u5b66\u52a9\u624b\"),\n        llmagent.WithTools([]tool.Tool{calculatorTool}),\n        llmagent.WithGenerationConfig(model.GenerationConfig{Stream: true}), // \u542f\u7528\u6d41\u5f0f\u8f93\u51fa\n    )\n\n    // 3. \u521b\u5efa Runner \u5e76\u6267\u884c\n    r := runner.NewRunner(\"math-app\", agent)\n\n    ctx := context.Background()\n    userMessage := model.NewUserMessage(\"\u8bf7\u8ba1\u7b97 25 \u4e58\u4ee5 4\")\n\n    eventChan, err := r.Run(ctx, \"user1\", \"session1\", userMessage)\n    if err != nil {\n        panic(err)\n    }\n\n    // 4. \u5904\u7406\u54cd\u5e94\n    for event := range eventChan {\n        if event.Error != nil {\n            fmt.Printf(\"\u9519\u8bef: %s\\n\", event.Error.Message)\n            continue\n        }\n\n        // \u663e\u793a\u5de5\u5177\u8c03\u7528\n        if len(event.Response.Choices) &gt; 0 &amp;&amp; len(event.Response.Choices[0].Message.ToolCalls) &gt; 0 {\n            for _, toolCall := range event.Response.Choices[0].Message.ToolCalls {\n                fmt.Printf(\"\ud83d\udd27 \u8c03\u7528\u5de5\u5177: %s\\n\", toolCall.Function.Name)\n                fmt.Printf(\"   \u53c2\u6570: %s\\n\", string(toolCall.Function.Arguments))\n            }\n        }\n\n        // \u663e\u793a\u6d41\u5f0f\u5185\u5bb9\n        if len(event.Response.Choices) &gt; 0 {\n            fmt.Print(event.Response.Choices[0].Delta.Content)\n        }\n\n        if event.Done {\n            break\n        }\n    }\n}\n</code></pre>"},{"location":"zh/tool/#_27","title":"\u8fd0\u884c\u793a\u4f8b","text":"<pre><code># \u8fdb\u5165\u5de5\u5177\u793a\u4f8b\u76ee\u5f55\ncd examples/tool\ngo run .\n\n# \u8fdb\u5165 MCP \u5de5\u5177\u793a\u4f8b\u76ee\u5f55\ncd examples/mcp_tool\n\n# \u542f\u52a8\u5916\u90e8\u670d\u52a1\u5668\ncd streamalbe_server &amp;&amp; go run main.go &amp;\n\n# \u8fd0\u884c\u4e3b\u7a0b\u5e8f\ngo run main.go -model=\"deepseek-chat\"\n</code></pre>"},{"location":"zh/tool/#_28","title":"\u603b\u7ed3","text":"<p>Tool \u5de5\u5177\u7cfb\u7edf\u4e3a tRPC-Agent-Go \u63d0\u4f9b\u4e86\u4e30\u5bcc\u7684\u6269\u5c55\u80fd\u529b\uff0c\u652f\u6301\u51fd\u6570\u5de5\u5177\u3001DuckDuckGo \u641c\u7d22\u5de5\u5177\u548c MCP \u534f\u8bae\u5de5\u5177\u3002</p>"}]}