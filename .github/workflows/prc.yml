name: Pull Request Check
on:
  pull_request:
  push:
  workflow_dispatch:
permissions:
  contents: read
  pull-requests: read # Use with `only-new-issues` option.
jobs:
  build:
    name: build
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - uses: actions/setup-go@v5
      with:
        go-version: '1.21'
    - name: Build
      run: go build -v ./...
  discover-go-modules:
    name: discover go modules
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
    - uses: actions/checkout@v3
    - id: set-matrix
      shell: bash
      run: |
        set -euo pipefail
        mapfile -t modules < <(find . -name go.mod \
          -not -path "./.resource/*" \
          -not -path "./docs/*" \
          -not -path "./examples/*" | sort)
        if [ "${#modules[@]}" -eq 0 ]; then
          echo "matrix={\"module\":[]}" >> "$GITHUB_OUTPUT"
          exit 0
        fi
        matrix=$(printf '%s\n' "${modules[@]}" | sed 's|^\./||' | jq -R -s -c 'split("\n") | map(select(length>0))')
        echo "matrix={\"module\":${matrix}}" >> "$GITHUB_OUTPUT"
  test-go-modules:
    name: go test (${{ matrix.module }})
    runs-on: ubuntu-latest
    needs: discover-go-modules
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.discover-go-modules.outputs.matrix) }}
    steps:
    - uses: actions/checkout@v3
    - uses: actions/setup-go@v5
      with:
        go-version: '1.21'
    - name: Prepare module metadata
      id: module-info
      shell: bash
      run: |
        set -euo pipefail
        module='${{ matrix.module }}'
        if [ -z "${module}" ]; then
          echo "empty module path" >&2
          exit 1
        fi
        rel="${module#./}"
        if [ "${rel}" = "go.mod" ]; then
          readable="root"
        else
          readable="${rel%/go.mod}"
        fi
        safe="${readable//\//_}"
        safe="${safe//./_}"
        if [ -z "${safe}" ]; then
          safe="root"
        fi
        echo "safe_name=${safe}" >> "$GITHUB_OUTPUT"
    - name: Test module
      shell: bash
      run: bash .github/scripts/run-go-tests.sh --module "${{ matrix.module }}"
    - name: Prepare coverage artifact
      shell: bash
      run: mv coverage.out "coverage-${{ steps.module-info.outputs.safe_name }}.out"
    - name: Upload coverage artifact
      uses: actions/upload-artifact@v4
      with:
        name: coverage-${{ steps.module-info.outputs.safe_name }}
        path: coverage-${{ steps.module-info.outputs.safe_name }}.out
        if-no-files-found: error
  coverage:
    name: coverage
    runs-on: ubuntu-latest
    needs: test-go-modules
    steps:
    - uses: actions/checkout@v3
    - name: Download coverage artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: coverage-*
        merge-multiple: true
        path: coverage-artifacts
    - name: Combine coverage reports
      shell: bash
      run: |
        set -euo pipefail
        mapfile -t files < <(find coverage-artifacts -maxdepth 1 -type f -name 'coverage-*.out' | sort)
        if [ "${#files[@]}" -eq 0 ]; then
          echo "no coverage files found" >&2
          exit 1
        fi
        cp "${files[0]}" coverage.out
        for file in "${files[@]:1}"; do
          tail -n +2 "${file}" >> coverage.out
        done
    - name: Upload merged coverage artifact
      uses: actions/upload-artifact@v4
      with:
        name: coverage-merged
        path: coverage.out
    - name: Upload coverage reports to Codecov
      uses: codecov/codecov-action@v5
      with:
        files: coverage.out
        flags: unittests
        token: ${{ secrets.CODECOV_TOKEN }}
  golangci:
    name: lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/setup-go@v5
        with:
          go-version: '1.21'
      - uses: actions/checkout@v3
      - name: golangci-lint
        uses: golangci/golangci-lint-action@v3
        with:
          version: latest 
          only-new-issues: true
          args: --timeout=10m
  typos:
    name: typos
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: typos 
      uses: crate-ci/typos@master
  go-apidiff:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0 
    - uses: actions/setup-go@v5
      with:
        go-version: '1.21'
    - uses: joelanford/go-apidiff@main 
  docs-build:
    name: docs-build
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: docs
    steps:
    - uses: actions/checkout@v3
    - uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    - name: Install MkDocs dependencies
      run: pip install -r mkdocs/assets/requirements.txt
    - name: Build documentation
      run: mkdocs build --strict
