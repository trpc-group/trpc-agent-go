//
// Package evaluator provides evaluator interfaces and types for evaluation.
//

package evaluator

import (
	"context"

	"trpc.group/trpc-go/trpc-agent-go/evaluation/evalset"
	"trpc.group/trpc-go/trpc-agent-go/evaluation/metric"
	"trpc.group/trpc-go/trpc-agent-go/evaluation/status"
)

// Evaluator defines the interface for evaluating invocations.
// This is compatible with trpc-agent-go/evaluation/evaluator.Evaluator.
type Evaluator interface {
	// Name returns the name of the evaluator.
	Name() string
	// Description provides the description of the evaluator.
	Description() string
	// Evaluate evaluates the actual invocations against the expected invocations
	// and returns a result.
	Evaluate(
		ctx context.Context,
		actuals, expecteds []*evalset.Invocation,
		evalMetric *metric.EvalMetric,
	) (*EvaluateResult, error)
}

// MultiRunEvaluator extends Evaluator to support Pass@k style evaluation.
// It evaluates multiple runs against a baseline.
type MultiRunEvaluator interface {
	Evaluator
	// EvaluateMultiRun evaluates multiple runs against a baseline.
	// baselineRuns: results from baseline mode (e.g., full events).
	// testRuns: results from test mode (e.g., summary + delta events).
	EvaluateMultiRun(
		ctx context.Context,
		baselineRuns, testRuns [][]*evalset.Invocation,
		evalMetric *metric.EvalMetric,
	) (*EvaluateResult, error)
}

// EvaluateResult represents the aggregated outcome of running an evaluator.
type EvaluateResult struct {
	// OverallScore is the overall score for this evaluation.
	OverallScore float64 `json:"overallScore,omitempty"`
	// OverallStatus represents pass/fail/not-evaluated for the evaluation run.
	OverallStatus status.EvalStatus `json:"overallStatus,omitempty"`
	// PerInvocationResults contains results for each invocation.
	PerInvocationResults []*PerInvocationResult `json:"perInvocationResults,omitempty"`
	// Details contains additional evaluator-specific information.
	Details map[string]any `json:"details,omitempty"`
}

// PerInvocationResult represents the evaluation result for a single invocation.
type PerInvocationResult struct {
	// ActualInvocation is the invocation generated by the agent.
	ActualInvocation *evalset.Invocation `json:"actualInvocation,omitempty"`
	// ExpectedInvocation is the expected invocation.
	ExpectedInvocation *evalset.Invocation `json:"expectedInvocation,omitempty"`
	// Score is the evaluator's score for this invocation.
	Score float64 `json:"score,omitempty"`
	// Status indicates the evaluation status of the invocation.
	Status status.EvalStatus `json:"status,omitempty"`
	// Details contains additional evaluator-specific information.
	Details map[string]any `json:"details,omitempty"`
}
